<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
/******************************************
PROYECTO: PBE Control
ARCHIVO: 7ctabhorarioclase.html
VERSI√ìN: 01.24 CODEWORKSHOP
FECHA: 16/01/2026 15:32 (UTC-5)
******************************************/
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: APERTURA [INICIO] -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horario de Clases</title>
<!-- MOD-002: FIN -->

<!-- MOD-003: ESTILOS CSS [INICIO] -->
<style>
.hc-grid-container {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  position: relative;
  min-height: 400px;
}

.hc-grid {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.hc-grid thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.hc-grid th {
  padding: 12px 8px;
  text-align: center;
  font-weight: 600;
  border: 1px solid rgba(255,255,255,.2);
}

.hc-grid .hc-col-hora {
  width: 80px;
  background: #f8f9fa;
  font-weight: 600;
  color: #495057;
}

.hc-grid .hc-col-dia {
  width: calc((100% - 80px) / 7);
  min-width: 100px;
}

.hc-grid td {
  padding: 4px;
  border: 1px solid #dee2e6;
  height: 45px;
  vertical-align: middle;
}

.hc-celda-clase {
  min-height: 35px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
  font-size: 12px;
}

.hc-celda-clase:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
}

.hc-celda-clase.ocupada {
  color: white;
  padding: 6px 8px;
}

.hc-celda-clase.conflicto {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%) !important;
  font-size: 11px;
  font-weight: 700;
}

.hc-form-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.hc-form-overlay.active {
  display: flex;
}

.hc-form-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 10px 40px rgba(0,0,0,.2);
}

.hc-form-content h3 {
  margin: 0 0 20px;
  color: #667eea;
  font-size: 20px;
}

.hc-form-group {
  margin-bottom: 16px;
}

.hc-form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #333;
  font-size: 13px;
}

.hc-form-group input,
.hc-form-group select {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  transition: border 0.3s;
  box-sizing: border-box;
}

.hc-form-group input:focus,
.hc-form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
}

.hc-form-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  justify-content: flex-end;
}

.hc-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.hc-btn-primary {
  background: #667eea;
  color: white;
}

.hc-btn-primary:hover {
  background: #5568d3;
}

.hc-btn-secondary {
  background: #6c757d;
  color: white;
}

.hc-btn-secondary:hover {
  background: #5a6268;
}

.hc-btn-danger {
  background: #dc3545;
  color: white;
}

.hc-btn-danger:hover {
  background: #c82333;
}

.hc-modal-seleccion {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.hc-modal-seleccion.active {
  display: flex;
}

.hc-modal-seleccion-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 40px rgba(0,0,0,.2);
}

.hc-modal-seleccion-content h3 {
  margin: 0 0 16px;
  color: #667eea;
  font-size: 18px;
}

.hc-modal-seleccion-content p {
  margin: 0 0 16px;
  color: #666;
  font-size: 14px;
}

.hc-clase-option {
  padding: 16px;
  margin-bottom: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.hc-clase-option:hover {
  border-color: #667eea;
  background: #f8f9ff;
  transform: translateX(4px);
}

.hc-clase-option-curso {
  font-weight: 700;
  font-size: 16px;
  color: #333;
  margin-bottom: 4px;
}

.hc-clase-option-horario {
  font-size: 13px;
  color: #666;
}

.hc-modal-seleccion-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 16px;
}

.hc-loading {
  text-align: center;
  padding: 40px;
  color: #667eea;
}

.hc-spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(102,126,234,.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: hc-spin .8s linear infinite;
}

@keyframes hc-spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .hc-grid {
    font-size: 11px;
  }
  
  .hc-grid .hc-col-hora {
    width: 60px;
  }
  
  .hc-celda-clase {
    font-size: 10px;
    padding: 4px;
  }
  
  .hc-form-content {
    width: 95%;
    padding: 20px;
  }
}
</style>
<!-- MOD-003: FIN -->

<!-- MOD-004: ESTRUCTURA HTML [INICIO] -->
<div class="hc-grid-container">
  <div class="hc-loading" id="loadingHC">
    <div class="hc-spinner"></div>
    <p>Cargando horario...</p>
  </div>
  <div id="hcGridContainer"></div>
</div>

<div id="formClase" class="hc-form-overlay">
  <div class="hc-form-content">
    <h3 id="formTitle">Agregar Clase</h3>
    
    <form id="claseForm" onsubmit="return window.hcHandleSubmitClase(event)">
      <input type="hidden" id="claseRowNumber">
      <input type="hidden" id="claseModoEdicion" value="false">
      <input type="hidden" id="claseDia">
      <input type="hidden" id="claseHoraSlot">
      
      <div class="hc-form-group">
        <label>Curso:</label>
        <select id="claseCurso" required>
          <option value="">Seleccionar...</option>
        </select>
      </div>
      
      <div class="hc-form-group">
        <label>Hora Inicio:</label>
        <input type="time" id="claseHoraIni" required>
      </div>
      
      <div class="hc-form-group">
        <label>Hora Fin:</label>
        <input type="time" id="claseHoraFin" required>
      </div>
      
      <div class="hc-form-actions">
        <button type="button" class="hc-btn hc-btn-secondary" onclick="window.hcCancelarFormClase()">Cancelar</button>
        <button type="button" class="hc-btn hc-btn-danger" id="btnEliminar" style="display:none" onclick="window.hcConfirmarEliminarClase()">Eliminar</button>
        <button type="submit" class="hc-btn hc-btn-primary" id="btnSubmit">Guardar</button>
      </div>
    </form>
  </div>
</div>

<div id="modalSeleccion" class="hc-modal-seleccion">
  <div class="hc-modal-seleccion-content">
    <h3>Seleccionar Clase</h3>
    <p>Hay m√∫ltiples clases en este horario. Selecciona una:</p>
    <div id="modalSeleccionOpciones"></div>
    <div class="hc-modal-seleccion-actions">
      <button class="hc-btn hc-btn-secondary" onclick="window.hcCerrarModalSeleccion()">Cancelar</button>
    </div>
  </div>
</div>
<!-- MOD-004: FIN -->

<!-- MOD-005: JAVASCRIPT - INICIO [INICIO] -->
<script>
(function () {
'use strict';
<!-- MOD-005: FIN -->

<!-- MOD-006: VERIFICACI√ìN Y CONSTANTES [INICIO] -->
if (window.HorarioClaseModule) {
  console.log('üïê HorarioClaseModule ya existe, ignorando carga');
  return;
}

console.log('üïê HorarioClaseModule V01.23 CODEWORKSHOP iniciando...');

let clasesData = [];
let cursosData = [];
let horarioMatrix = {};
const HORA_INICIO = 7;
const HORA_FIN = 22;
const DIAS = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
const DIAS_CORTOS = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
let _initDone = false;
let _retryCount = 0;
const MAX_RETRIES = 5;
<!-- MOD-006: FIN -->

<!-- MOD-007: FUNCI√ìN INICIALIZACI√ìN [INICIO] -->
function init() {
  console.log('üïê HorarioClaseModule.init() llamado (intento ' + (_retryCount + 1) + ')');
  
  if (_initDone) {
    console.log('üïê Ya inicializado, ignorando');
    return;
  }
  
  if (!window.currentUser || !currentUser.codeAlum) {
    console.warn('üïê currentUser no disponible, reintentando...');
    
    if (_retryCount < MAX_RETRIES) {
      _retryCount++;
      setTimeout(init, 200);
    } else {
      console.error('üïê currentUser no disponible despu√©s de ' + MAX_RETRIES + ' intentos');
      ocultarLoading();
    }
    return;
  }
  
  _initDone = true;
  console.log('üïê Inicializado para:', currentUser.codeAlum);
  
  cargarCursos();
  cargarHorarioClases();
}
<!-- MOD-007: FIN -->

<!-- MOD-008: FUNCI√ìN CARGA DE CURSOS [INICIO] -->
function cargarCursos() {
  console.log('üïê Cargando cursos...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üïê Cursos response:', r);
      
      if (r && r.success) {
        cursosData = r.data || [];
        console.log('üïê Cursos cargados:', cursosData.length);
        poblarDropdownCursos();
      } else {
        console.error('üïê Error en cursos:', r);
      }
    })
    .withFailureHandler(e => {
      console.error('üïê Error al cargar cursos:', e);
    })
    .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
}

function poblarDropdownCursos() {
  const select = document.getElementById('claseCurso');
  if (!select) return;
  
  const primerOption = select.options[0].outerHTML;
  select.innerHTML = primerOption;

  cursosData.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.Curso;
    opt.textContent = c.Curso + ' - ' + c.Completo;
    opt.dataset.color = c.Color || '#667eea';
    select.appendChild(opt);
  });
  
  console.log('üïê Dropdown poblado con', cursosData.length, 'cursos');
}
<!-- MOD-008: FIN -->

<!-- MOD-009: FUNCI√ìN CARGA DE HORARIO [INICIO] -->
function cargarHorarioClases() {
  console.log('üïê Cargando horario clases...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üïê HorarioClases response:', r);
      
      if (r && r.success) {
        clasesData = r.data || [];
        console.log('üïê Clases cargadas:', clasesData.length);
        
        if (clasesData.length > 0) {
          console.log('üïê Ejemplo de clase:', clasesData[0]);
        }
        
        construirMatriz();
        renderGrid();
        ocultarLoading();
      } else {
        console.error('üïê Error en response:', r);
        renderGrid();
        ocultarLoading();
      }
    })
    .withFailureHandler(e => {
      console.error('üïê Error de conexi√≥n:', e);
      renderGrid();
      ocultarLoading();
    })
    .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
}
<!-- MOD-009: FIN -->

<!-- MOD-010: FUNCI√ìN CONSTRUCCI√ìN DE MATRIZ [INICIO] -->
function construirMatriz() {
  console.log('üïê Construyendo matriz con', clasesData.length, 'clases');
  
  horarioMatrix = {};
  DIAS.forEach(d => horarioMatrix[d] = {});
  
  clasesData.forEach((c, idx) => {
    console.log('üïê Procesando clase ' + (idx + 1) + ':', {
      Curso: c.Curso,
      Detalle: c.Detalle,
      HoraIni: c.HoraIni,
      HoraFin: c.HoraFin
    });
    
    const dia = extraerDia(c.Detalle);
    console.log('üïê D√≠a extra√≠do:', dia, 'de Detalle:', c.Detalle);
    
    if (!dia) {
      console.warn('üïê No se pudo extraer d√≠a de:', c.Detalle);
      return;
    }
    
    const horas = calcularHoras(c.HoraIni, c.HoraFin);
    console.log('üïê Horas calculadas:', horas.length, 'slots');
    
    horas.forEach(h => {
      horarioMatrix[dia][h.hora] = horarioMatrix[dia][h.hora] || [];
      horarioMatrix[dia][h.hora].push({ clase: c, ...h });
    });
  });
  
  let conflictos = 0;
  DIAS.forEach(d => {
    Object.keys(horarioMatrix[d]).forEach(h => {
      if (horarioMatrix[d][h].length > 1) {
        conflictos++;
        const cursos = horarioMatrix[d][h].map(x => x.clase.Curso).join(', ');
        console.log('üïê ‚ö†Ô∏è Conflicto en', d, h + ':', cursos);
      }
    });
  });
  
  if (conflictos > 0) {
    console.log('üïê Total de conflictos detectados:', conflictos);
  }
  
  console.log('üïê Matriz construida:', horarioMatrix);
}
<!-- MOD-010: FIN -->

<!-- MOD-011: FUNCIONES HELPER DE PROCESAMIENTO [INICIO] -->
function extraerDia(t) {
  if (!t) return null;
  const s = String(t).toLowerCase().trim();
  const diaEncontrado = DIAS.find(d => {
    const dLower = d.toLowerCase();
    return s.includes(dLower) || dLower.includes(s);
  });
  return diaEncontrado || null;
}

function calcularHoras(i, f) {
  const horaIniStr = normalizarHora(i);
  const horaFinStr = normalizarHora(f);
  
  if (!horaIniStr || !horaFinStr) {
    console.error('üïê Horas inv√°lidas despu√©s de normalizar');
    return [];
  }
  
  const [hi, mi] = horaIniStr.split(':').map(Number);
  const [hf, mf] = horaFinStr.split(':').map(Number);
  
  const res = [];
  
  for (let h = hi; h <= hf; h++) {
    if (h > HORA_FIN) break;
    if (h === hf && mf === 0) continue;
    
    res.push({
      hora: String(h).padStart(2, '0') + ':00',
      prefijo: (h === hi && mi >= 30) ? '/' : '',
      sufijo: (h === hf && mf > 0 && mf < 60) ? '/' : ''
    });
  }
  
  return res;
}

function normalizarHora(valor) {
  if (!valor) return null;
  
  if (typeof valor === 'string') {
    const match = valor.match(/(\d{1,2}):(\d{2})/);
    if (match) {
      const h = match[1].padStart(2, '0');
      const m = match[2];
      return h + ':' + m;
    }
  }
  
  if (typeof valor === 'object' && valor !== null) {
    if ('hour' in valor && 'minute' in valor) {
      const h = String(valor.hour).padStart(2, '0');
      const m = String(valor.minute).padStart(2, '0');
      return h + ':' + m;
    }
  }
  
  return null;
}

function colorCurso(curso) {
  const c = cursosData.find(x => x.Curso === curso);
  return c ? c.Color : '#667eea';
}
<!-- MOD-011: FIN -->

<!-- MOD-012: FUNCI√ìN RENDERIZADO DE GRID [INICIO] -->
function renderGrid() {
  console.log('üïê Renderizando grid...');
  
  const c = document.getElementById('hcGridContainer');
  if (!c) {
    console.error('üïê No se encontr√≥ hcGridContainer');
    return;
  }

  let html = '<table class="hc-grid"><thead><tr><th class="hc-col-hora">Hora</th>';
  DIAS_CORTOS.forEach(d => html += `<th class="hc-col-dia">${d}</th>`);
  html += '</tr></thead><tbody>';

  let celdasOcupadas = 0;
  let celdasVacias = 0;
  let celdasConflicto = 0;

  for (let h = HORA_INICIO; h <= HORA_FIN; h++) {
    const k = String(h).padStart(2, '0') + ':00';
    const horaFormato = formatearHora12(h);
    
    html += `<tr><td class="hc-col-hora">${horaFormato}</td>`;
    
    DIAS.forEach(d => {
      const s = horarioMatrix[d][k];
      
      if (s && s.length > 0) {
        if (s.length > 1) {
          celdasConflicto++;
          
          const nombres = s.map(x => {
            const curso = x.clase.Curso;
            return curso.length > 4 ? curso.substring(0, 4) : curso;
          }).join('/');
          
          html += `<td><div class="hc-celda-clase ocupada conflicto" 
            onclick="window.hcMostrarSeleccionClase('${d}','${k}')">
            ${nombres}
          </div></td>`;
        } else {
          celdasOcupadas++;
          const x = s[0];
          const color = colorCurso(x.clase.Curso);
          const texto = x.prefijo + x.clase.Curso + x.sufijo;
          
          html += `<td><div class="hc-celda-clase ocupada" 
            style="background:${color}" 
            onclick="window.hcEditarClase('${d}','${k}')">
            ${texto}
          </div></td>`;
        }
      } else {
        celdasVacias++;
        html += `<td><div class="hc-celda-clase" 
          onclick="window.hcClickCelda('${d}','${k}')">
        </div></td>`;
      }
    });
    
    html += '</tr>';
  }

  html += '</tbody></table>';
  c.innerHTML = html;
  
  console.log('üïê Grid renderizado:', { celdasOcupadas, celdasVacias, celdasConflicto });
}

function ocultarLoading() {
  const l = document.getElementById('loadingHC');
  if (l) l.style.display = 'none';
}
<!-- MOD-012: FIN --> -->

<!-- MOD-013: FUNCI√ìN MODAL SELECCI√ìN [INICIO] -->
function mostrarSeleccionClase(dia, hora) {
  console.log('üïê Mostrando selecci√≥n de clase:', { dia, hora });
  
  const clases = horarioMatrix[dia][hora];
  
  if (!clases || clases.length === 0) {
    alert('No hay clases en esta celda');
    return;
  }
  
  const modal = document.getElementById('modalSeleccion');
  const opciones = document.getElementById('modalSeleccionOpciones');
  
  opciones.innerHTML = '';
  
  clases.forEach((c, idx) => {
    const clase = c.clase;
    const div = document.createElement('div');
    div.className = 'hc-clase-option';
    div.onclick = function() {
      cerrarModalSeleccion();
      editarClaseDirecta(clase);
    };
    
    div.innerHTML = `
      <div class="hc-clase-option-curso">${clase.Curso}</div>
      <div class="hc-clase-option-horario">${clase.HoraIni} - ${clase.HoraFin}</div>
    `;
    
    opciones.appendChild(div);
  });
  
  modal.classList.add('active');
}

function cerrarModalSeleccion() {
  const modal = document.getElementById('modalSeleccion');
  modal.classList.remove('active');
}

function editarClaseDirecta(clase) {
  console.log('üïê Editando clase directa:', clase);
  
  const dia = extraerDia(clase.Detalle);
  const diaCorto = DIAS_CORTOS[DIAS.indexOf(dia)];
  
  document.getElementById('formTitle').textContent = 'Editar Clase - ' + diaCorto;
  document.getElementById('claseRowNumber').value = clase._rowNumber || '';
  document.getElementById('claseModoEdicion').value = 'true';
  document.getElementById('claseDia').value = dia;
  document.getElementById('claseHoraSlot').value = '';
  document.getElementById('claseCurso').value = clase.Curso;
  
  document.getElementById('claseHoraIni').value = normalizarHora(clase.HoraIni) || '';
  document.getElementById('claseHoraFin').value = normalizarHora(clase.HoraFin) || '';
  
  document.getElementById('btnSubmit').textContent = 'Actualizar';
  document.getElementById('btnEliminar').style.display = 'block';

  document.getElementById('formClase').classList.add('active');
}
<!-- MOD-013: FIN -->

<!-- MOD-014: FUNCI√ìN VALIDACI√ìN SOLAPAMIENTO [INICIO] -->
function verificarSolapamiento(dia, horaIni, horaFin, rowNumberActual) {
  console.log('üïê Verificando solapamiento:', { dia, horaIni, horaFin });
  
  const [hi, mi] = horaIni.split(':').map(Number);
  const [hf, mf] = horaFin.split(':').map(Number);
  
  const horasOcupadas = calcularHoras(horaIni, horaFin);
  const solapamientos = [];
  
  horasOcupadas.forEach(h => {
    const clasesEnHora = horarioMatrix[dia][h.hora] || [];
    
    clasesEnHora.forEach(c => {
      if (rowNumberActual && c.clase._rowNumber === rowNumberActual) {
        return;
      }
      
      solapamientos.push(c.clase.Curso);
    });
  });
  
  const solapamientosUnicos = [...new Set(solapamientos)];
  
  return solapamientosUnicos;
}
<!-- MOD-014: FIN -->

<!-- MOD-015: FUNCIONES FORMULARIO - AGREGAR [INICIO] -->
function clickCelda(dia, hora) {
  console.log('üïê Click en celda:', { dia, hora });
  abrirFormularioAgregar(dia, hora);
}

function abrirFormularioAgregar(dia, hora) {
  resetFormClase();

  const diaCorto = DIAS_CORTOS[DIAS.indexOf(dia)];
  const horaFormato = formatearHora12Desde24(hora);

  document.getElementById('formTitle').textContent = 'Agregar Clase - ' + diaCorto + ' ' + horaFormato;
  document.getElementById('claseModoEdicion').value = 'false';
  document.getElementById('claseDia').value = dia;
  document.getElementById('claseHoraSlot').value = hora;
  document.getElementById('btnSubmit').textContent = 'Guardar';
  document.getElementById('btnEliminar').style.display = 'none';

  document.getElementById('claseHoraIni').value = hora;
  
  const [h] = hora.split(':').map(Number);
  const horaFinSugerida = String(Math.min(h + 1, HORA_FIN + 1)).padStart(2, '0') + ':00';
  document.getElementById('claseHoraFin').value = horaFinSugerida;

  document.getElementById('formClase').classList.add('active');
  
  const select = document.getElementById('claseCurso');
  if (select) select.focus();
}
<!-- MOD-015: FIN -->

<!-- MOD-016: FUNCIONES FORMULARIO - EDITAR [INICIO] -->
function editarClase(dia, hora) {
  console.log('üïê Editar clase:', { dia, hora });
  
  const clases = horarioMatrix[dia][hora];

  if (!clases || clases.length === 0) {
    if (window.showAlert) {
      showAlert('error', 'No hay clase en esta celda');
    } else {
      alert('No hay clase en esta celda');
    }
    return;
  }

  const clase = clases[0].clase;
  editarClaseDirecta(clase);
}
<!-- MOD-016: FIN -->

<!-- MOD-017: FUNCIONES FORMULARIO - SUBMIT [INICIO] -->
function handleSubmitClase(event) {
  event.preventDefault();

  const curso = document.getElementById('claseCurso').value.trim();
  const horaIni = document.getElementById('claseHoraIni').value.trim();
  const horaFin = document.getElementById('claseHoraFin').value.trim();
  const dia = document.getElementById('claseDia').value;
  const esEdicion = document.getElementById('claseModoEdicion').value === 'true';
  const rowNumber = document.getElementById('claseRowNumber').value;

  if (!curso || !horaIni || !horaFin) {
    if (window.showAlert) {
      showAlert('error', 'Completa todos los campos');
    } else {
      alert('Completa todos los campos');
    }
    return false;
  }

  if (horaIni >= horaFin) {
    if (window.showAlert) {
      showAlert('error', 'La hora de fin debe ser mayor a la de inicio');
    } else {
      alert('La hora de fin debe ser mayor a la de inicio');
    }
    return false;
  }

  const solapamientos = verificarSolapamiento(dia, horaIni, horaFin, rowNumber ? parseInt(rowNumber) : null);
  
  if (solapamientos.length > 0) {
    const mensaje = `‚ö†Ô∏è Ya existe ${solapamientos.join(', ')} en este horario.\n\n¬øCrear solapamiento de todos modos?`;
    
    if (!confirm(mensaje)) {
      return false;
    }
  }

  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = true;
  btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';

  const params = {
    codeAlum: currentUser.codeAlum,
    curso: curso,
    horaIni: horaIni,
    horaFin: horaFin,
    detalle: dia
  };

  if (esEdicion) {
    if (rowNumber) {
      params.rowNumber = parseInt(rowNumber);
    }

    google.script.run
      .withSuccessHandler(r => handleClaseGuardada(r, true))
      .withFailureHandler(e => handleClaseError(e, true))
      .studentActualizarHorarioClase(params);
  } else {
    google.script.run
      .withSuccessHandler(r => handleClaseGuardada(r, false))
      .withFailureHandler(e => handleClaseError(e, false))
      .studentAgregarHorarioClase(params);
  }

  return false;
}

function handleClaseGuardada(response, esEdicion) {
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';

  if (response && response.success) {
    const msg = esEdicion ? '‚úî Clase actualizada' : '‚úî Clase agregada';
    if (window.showAlert) {
      showAlert('success', msg);
    } else {
      alert(msg);
    }
    cancelarFormClase();
    cargarHorarioClases();
  } else {
    const error = response ? response.error : 'Error desconocido';
    if (window.showAlert) {
      showAlert('error', error);
    } else {
      alert('Error: ' + error);
    }
  }
}

function handleClaseError(error, esEdicion) {
  console.error('üïê Error:', error);
  
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  if (window.showAlert) {
    showAlert('error', 'Error de conexi√≥n. Intenta nuevamente');
  } else {
    alert('Error de conexi√≥n. Intenta nuevamente');
  }
}
<!-- MOD-017: FIN -->

<!-- MOD-018: FUNCIONES FORMULARIO - ELIMINAR [INICIO] -->
function confirmarEliminarClase() {
  const rowNumber = document.getElementById('claseRowNumber').value;

  if (!rowNumber) {
    if (window.showAlert) {
      showAlert('error', 'No se puede eliminar esta clase');
    } else {
      alert('No se puede eliminar esta clase');
    }
    return;
  }

  if (confirm('¬øEliminar esta clase del horario?\n\nEsta acci√≥n no se puede deshacer.')) {
    eliminarClase(parseInt(rowNumber));
  }
}

function eliminarClase(rowNumber) {
  google.script.run
    .withSuccessHandler(handleClaseEliminada)
    .withFailureHandler(e => {
      console.error('üïê Error al eliminar:', e);
      if (window.showAlert) {
        showAlert('error', 'Error al eliminar');
      } else {
        alert('Error al eliminar');
      }
    })
    .studentEliminarHorarioClase({ rowNumber: rowNumber });
}

function handleClaseEliminada(response) {
  if (response && response.success) {
    if (window.showAlert) {
      showAlert('success', '‚úî Clase eliminada');
    } else {
      alert('Clase eliminada');
    }
    cancelarFormClase();
    cargarHorarioClases();
  } else {
    const error = response ? response.error : 'Error desconocido';
    if (window.showAlert) {
      showAlert('error', error);
    } else {
      alert('Error: ' + error);
    }
  }
}
<!-- MOD-018: FIN -->

<!-- MOD-019: FUNCIONES FORMULARIO - HELPERS [INICIO] -->
function resetFormClase() {
  const form = document.getElementById('claseForm');
  if (form) form.reset();
  
  document.getElementById('claseRowNumber').value = '';
  document.getElementById('claseModoEdicion').value = 'false';
  document.getElementById('claseDia').value = '';
  document.getElementById('claseHoraSlot').value = '';
}

function cancelarFormClase() {
  const formDiv = document.getElementById('formClase');
  if (formDiv) formDiv.classList.remove('active');
  resetFormClase();
}
<!-- MOD-019: FIN -->

<!-- MOD-020: FUNCIONES FORMATEO [INICIO] -->
function formatearHora12(h) {
  if (h === 12) return '12 PM';
  if (h > 12) return (h - 12) + ' PM';
  if (h === 0) return '12 AM';
  return h + ' AM';
}

function formatearHora12Desde24(hora24Str) {
  const [h] = hora24Str.split(':').map(Number);
  return formatearHora12(h);
}
<!-- MOD-020: FIN -->

<!-- MOD-021: EXPOSICI√ìN GLOBAL Y ARRANQUE [INICIO] -->
window.hcClickCelda = clickCelda;
window.hcAbrirFormularioAgregar = abrirFormularioAgregar;
window.hcEditarClase = editarClase;
window.hcMostrarSeleccionClase = mostrarSeleccionClase;
window.hcCerrarModalSeleccion = cerrarModalSeleccion;
window.hcHandleSubmitClase = handleSubmitClase;
window.hcConfirmarEliminarClase = confirmarEliminarClase;
window.hcCancelarFormClase = cancelarFormClase;

setTimeout(function() {
  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    console.log('üïê currentUser detectado, inicializando...');
    init();
  } else {
    console.log('üïê currentUser no disponible, iniciando retry...');
    init();
  }
}, 150);

window.HorarioClaseModule = {
  init: init,
  clickCelda: clickCelda,
  abrirFormularioAgregar: abrirFormularioAgregar,
  editarClase: editarClase,
  mostrarSeleccionClase: mostrarSeleccionClase,
  guardarClase: handleSubmitClase,
  eliminarClase: confirmarEliminarClase,
  cancelar: cancelarFormClase
};

console.log('%cüïê HorarioClaseModule V01.23 CODEWORKSHOP cargado',
  'font-size:11px;color:#667eea;font-weight:bold');

})();
</script>
<!-- MOD-021: FIN --> -->


<!-- MOD-022: CIERRE [INICIO] -->
  </body>
</html>
<!-- MOD-022: FIN -->


<!-- MOD-023: DOCUMENTACI√ìN Y NOTAS [INICIO] -->
<!--
DESCRIPCI√ìN GENERAL:
Sistema de Horario de Clases fijas semanales.
Grid visual 7 d√≠as √ó 16 horas (7 AM - 10 PM).

CAMBIOS V01.23 CODEWORKSHOP:
‚úÖ Aplicaci√≥n completa del est√°ndar CodeWorkshop v2.1
‚úÖ Correcci√≥n de comentarios: uso de // en lugar de comentarios HTML
‚úÖ Enumeraci√≥n secuencial correcta de m√≥dulos
‚úÖ Eliminaci√≥n de comentarios redundantes
‚úÖ Cierre correcto de cada m√≥dulo
‚úÖ Uso apropiado de /* */ solo cuando es necesario


CARACTER√çSTICAS:
- Grid 15 filas (7 AM - 10 PM) √ó 7 d√≠as
- Click en celda ‚Üí Formulario agregar/editar
- Click en conflicto ‚Üí Men√∫ selecci√≥n de clase
- Visualizaci√≥n con color del curso
- Validaci√≥n de solapamientos antes de guardar
- Regla medias horas: "/" indica inicio/fin con minutos
- Celda conflicto muestra ambos cursos "QUIM/BIOL"
- Modal de selecci√≥n con botones claros
- Trunca nombres largos con "..." si no caben

DESCRIPCI√ìN T√âCNICA:
Sistema de Horario de Clases con grid visual 7x16, 
formularios modales, manejo de conflictos y 
validaci√≥n de solapamientos.

DEPENDENCIAS:
- MOD-007: Requiere window.currentUser.codeAlum
- MOD-008: Requiere studentObtenerCursos() backend
- MOD-009: Requiere studentObtenerHorarioClases() backend
- MOD-017: Requiere studentAgregarHorarioClase() y 
           studentActualizarHorarioClase() backend
- MOD-018: Requiere studentEliminarHorarioClase() backend
- Opcional: window.showAlert() para notificaciones

ESTRUCTURA DE DATOS:
HorarioClases {
  FechaReg, CodeAlum, Curso, HoraIni, HoraFin, Detalle
}

Cursos {
  Curso, Completo, Color
}

ADVERTENCIAS CR√çTICAS:
- MOD-006: DIAS es constante, no usar .push()
- MOD-010: extraerDia() requiere Detalle con nombre de d√≠a
- MOD-011: calcularHoras() no valida fuera rango 7-22
- MOD-012: renderGrid() sobrescribe innerHTML completo
- MOD-014: verificarSolapamiento() no valida d√≠a inv√°lido
- MOD-017: handleSubmitClase() permite solapamientos 
           con confirmaci√≥n del usuario

AISLAMIENTO:
- Prefijo CSS: .hc-
- IDs √∫nicos: hcGridContainer, loadingHC, 
              formClase, modalSeleccion
- Sin conflicto con HorarioSemanal (prefijo .hs-)
- IIFE con 'use strict' para encapsulamiento

PR√ìXIMAS MEJORAS SUGERIDAS:
- Drag & drop para mover clases
- Vista de impresi√≥n optimizada
- Exportaci√≥n a PDF/imagen
- Responsive mejorado para m√≥viles peque√±os
- Atajos de teclado (Esc para cerrar modales)
- Modo oscuro
- Sincronizaci√≥n en tiempo real
-->
<!-- MOD-023: FIN -->
