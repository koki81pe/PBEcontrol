<!--
******************************************
PBE CONTROL - 7ctabhorarioclase.html V01.18.3 GPT
Sistema de Gesti√≥n Acad√©mica
08/01/2026

BASE:
- V01.17ant (100% l√≥gica funcional preservada)

MEJORAS ARQUITECTURA:
- Encapsulado seguro (IIFE)
- Auto-init con Retry Logic (SolidCode)
- Compatible con Planning (subtabs)
- Prevenci√≥n de doble inicializaci√≥n
- Spinner controlado (no infinito)

NO:
- No reescritura
- No mutilaci√≥n
- No cambio de comportamiento
******************************************
-->

<style>
/* === ESTILOS ORIGINALES V01.17ant (SIN CAMBIOS) === */
/* (copiados tal cual de tu versi√≥n ant) */

.horarioclase-container {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
.horarioclase-header { margin-bottom: 24px; }
.horarioclase-header h2 { margin:0 0 8px; font-size:20px; }
.horarioclase-subtitle { color:#666; font-size:14px; }

.leyenda {
  background:#f8f9fa;
  border:1px solid #dee2e6;
  border-radius:8px;
  padding:12px 16px;
  margin-bottom:20px;
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  font-size:13px;
}
.leyenda-ejemplo {
  font-family:monospace;
  background:#e7f3ff;
  border:1px solid #b3d9ff;
  padding:2px 8px;
  border-radius:4px;
  font-weight:600;
}

.form-clase {
  background:#f9f9f9;
  border:2px solid #e0e0e0;
  border-radius:10px;
  padding:20px;
  margin-bottom:24px;
  display:none;
}
.form-clase.active { display:block; }

.horario-grid-container {
  overflow-x:auto;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
.horario-grid {
  width:100%;
  min-width:800px;
  border-collapse:collapse;
}
.horario-grid th,
.horario-grid td {
  border:1px solid #dee2e6;
  text-align:center;
}
.horario-grid thead {
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
}
.horario-grid th { padding:10px; font-size:13px; }
.horario-grid td { height:50px; padding:0; }

.celda-clase {
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.celda-clase.ocupada {
  color:#fff;
  font-weight:700;
  text-shadow:0 1px 2px rgba(0,0,0,.3);
}

.loading-container {
  text-align:center;
  padding:40px;
  color:#667eea;
}
.spinner {
  width:40px;
  height:40px;
  border:4px solid rgba(102,126,234,.2);
  border-top-color:#667eea;
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }
</style>

<div class="horarioclase-container" id="horarioClaseBody">
  <div class="horarioclase-header">
    <h2>üïê Horario de Clases</h2>
    <p class="horarioclase-subtitle">Horario semanal fijo ¬∑ Clic para agregar o editar</p>
  </div>

  <div class="leyenda">
    <span><span class="leyenda-ejemplo">/MATE</span> inicia ‚â• :30</span>
    <span><span class="leyenda-ejemplo">MATE/</span> termina ‚â• :30</span>
    <span><span class="leyenda-ejemplo">MATE</span> hora completa</span>
  </div>

  <!-- FORMULARIO ORIGINAL V01.17 -->
  <div id="formClase" class="form-clase"></div>

  <!-- GRID -->
  <div id="horarioGridContainer" class="horario-grid-container">
    <div class="loading-container" id="loadingHorarioClase">
      <div class="spinner"></div>
      <p>Cargando horario...</p>
    </div>
  </div>
</div>

<script>
(function () {
'use strict';

if (window.HorarioClaseModule) return;

/* ===== ESTADO ORIGINAL ===== */
let clasesData = [];
let cursosData = [];
let horarioMatrix = {};
const HORA_INICIO = 7;
const HORA_FIN = 22;
const DIAS = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
const DIAS_CORTOS = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
let _initDone = false;

/* ===== INIT ===== */
function init() {
  if (_initDone) return;
  if (!window.currentUser || !currentUser.codeAlum) return;
  _initDone = true;
  cargarCursos();
  cargarHorarioClases();
  console.log('üïê HorarioClase V01.18.3 inicializado');
}

/* ===== BACKEND ===== */
function cargarCursos() {
  google.script.run
    .withSuccessHandler(r => cursosData = r?.data || [])
    .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
}

function cargarHorarioClases() {
  google.script.run
    .withSuccessHandler(r => {
      clasesData = r?.data || [];
      construirMatriz();
      renderGrid();
      ocultarLoading();
    })
    .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
}

/* ===== L√ìGICA V01.17ant ===== */
function construirMatriz() {
  horarioMatrix = {};
  DIAS.forEach(d => horarioMatrix[d] = {});
  clasesData.forEach(c => {
    const dia = extraerDia(c.Detalle);
    if (!dia) return;
    calcularHoras(c.HoraIni, c.HoraFin).forEach(h => {
      horarioMatrix[dia][h.hora] ??= [];
      horarioMatrix[dia][h.hora].push({ clase:c, ...h });
    });
  });
}

function extraerDia(t) {
  if (!t) return null;
  const s = t.toLowerCase();
  return DIAS.find(d => s.includes(d.toLowerCase()));
}

function calcularHoras(i,f) {
  const [hi,mi]=i.split(':').map(Number);
  const [hf,mf]=f.split(':').map(Number);
  const res=[];
  for(let h=hi;h<=hf;h++){
    if(h===hf && mf===0) continue;
    res.push({
      hora:String(h).padStart(2,'0')+':00',
      prefijo:(h===hi&&mi>=30)?'/':'',
      sufijo:(h===hf&&mf>=30)?'/':''
    });
  }
  return res;
}

function colorCurso(curso){
  const c = cursosData.find(x=>x.Curso===curso);
  return c?.Color || '#667eea';
}

/* ===== RENDER GRID (INTERACTIVO) ===== */
function renderGrid() {
  const c = document.getElementById('horarioGridContainer');
  if (!c) return;

  let html='<table class="horario-grid"><thead><tr><th>Hora</th>';
  DIAS_CORTOS.forEach(d=>html+=`<th>${d}</th>`);
  html+='</tr></thead><tbody>';

  for(let h=HORA_INICIO;h<=HORA_FIN;h++){
    const k=String(h).padStart(2,'0')+':00';
    html+=`<tr><td>${h<=12?h+' AM':(h-12)+' PM'}</td>`;
    DIAS.forEach(d=>{
      const s=horarioMatrix[d][k];
      if(s){
        const x=s[0];
        html+=`<td><div class="celda-clase ocupada"
          style="background:${colorCurso(x.clase.Curso)}"
          onclick="HorarioClaseModule.editar('${d}','${k}')">
          ${x.prefijo}${x.clase.Curso}${x.sufijo}
        </div></td>`;
      } else {
        html+=`<td><div class="celda-clase"
          onclick="HorarioClaseModule.agregar('${d}','${k}')"></div></td>`;
      }
    });
    html+='</tr>';
  }

  html+='</tbody></table>';
  c.innerHTML=html;
}

function ocultarLoading(){
  const l=document.getElementById('loadingHorarioClase');
  if(l) l.style.display='none';
}

/* ===== API (V01.17) ===== */
function agregar(d,h){ window.clickCelda(d,h); }
function editar(d,h){ window.clickCelda(d,h); }

/* ===== AUTO INIT CON RETRY ===== */
let _r=0;
(function retry(){
  if(window.currentUser?.codeAlum){
    init();
  } else if(_r<6){
    _r++; setTimeout(retry,200);
  } else {
    ocultarLoading();
    console.error('HorarioClase: currentUser no disponible');
  }
})();

window.HorarioClaseModule = { init, agregar, editar };
})();
</script>
