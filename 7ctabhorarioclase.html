<!--
******************************************
PBE CONTROL - 7ctabhorarioclase.html - V01.17
Sistema de Gesti√≥n Acad√©mica
05/01/2026

DESCRIPCI√ìN:
Sub-tab de Horario de Clases con grid interactivo semanal.
Permite al estudiante visualizar y gestionar su horario fijo
de clases (7 AM - 10 PM, Lunes a Domingo).

FUNCIONALIDAD:
- Grid 15 filas (7 AM - 10 PM) √ó 8 columnas (hora + 7 d√≠as)
- Click en celda ‚Üí Formulario para agregar/editar clase
- Visualizaci√≥n con color del curso
- Regla de medias horas: "/" indica inicio/fin ‚â• :30
- Eliminar clase con confirmaci√≥n
- Responsive: Scroll horizontal en mobile

ESTRUCTURA DEL GRID:
- Fila: Hora (07:00 - 22:00, formato 24h interno, mostrar 12h)
- Columna: D√≠a de semana (Lun, Mar, Mi√©, Jue, Vie, S√°b, Dom)
- Celda ocupada: Muestra nombre corto del curso con su color
- Celda vac√≠a: Clickeable para agregar

REGLA DE MEDIAS HORAS (9.3.3 del DF):
- Clase 8:30-10:30 ‚Üí Fila 8AM: "/MATE", 9AM: "MATE", 10AM: "MATE/"
- Clase 8:00-9:00 ‚Üí Fila 8AM: "MATE" (sin barra)
- Clase 8:15-10:45 ‚Üí Fila 8AM: "MATE", 9AM: "MATE", 10AM: "MATE/"

BACKEND:
- studentObtenerHorarioClases({ codeAlum })
  ‚ö†Ô∏è Retorna HoraIni (mapeado desde HoraInicio)
- studentAgregarHorarioClase({ codeAlum, curso, horaIni, horaFin, detalle })
- studentActualizarHorarioClase({ codeAlum, rowNumber, curso, horaIni, horaFin, detalle })
- studentEliminarHorarioClase({ rowNumber })

ESTRUCTURA DE DATOS:
Database HorarioClases tiene: FechaReg, CodeAlum, Curso, HoraInicio, HoraFin, Detalle
- Detalle contiene el D√çA DE LA SEMANA (Lunes, Martes, etc.)
- Backend mapea HoraInicio ‚Üí HoraIni
- Frontend usa horaIni en todos los params

VALIDACIONES:
- HoraIni < HoraFin
- HoraIni y HoraFin en rango 07:00 - 22:00
- Curso debe existir en la lista de cursos del estudiante

CONECTA CON:
- Parent: 4ctabplanning.html (contenedor con 4 sub-tabs)
- Backend: Student.obtenerHorarioClases, Student.agregarHorarioClase (1student.gs)
- Database: Hoja HorarioClases

üîë IMPORTANTE:
- El backend mapea HoraInicio ‚Üí HoraIni autom√°ticamente
- Frontend SIEMPRE usa horaIni, NUNCA horaInicio
- Grid usa formato 12h para mostrar (8 AM), pero 24h internamente (08:00)
- El d√≠a se guarda en Detalle (ej: "Lunes", "Martes")
- Sigue el patr√≥n de 5atabcursos.html para estructura y estilos
******************************************
-->
<style>
  /* ==========================================
     CONTENEDOR PRINCIPAL
     ========================================== */
  .horarioclase-container {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .horarioclase-header {
    margin-bottom: 24px;
  }

  .horarioclase-header h2 {
    color: #333;
    font-size: 20px;
    margin: 0 0 8px 0;
  }

  .horarioclase-subtitle {
    color: #666;
    font-size: 14px;
    margin: 0;
  }

  /* ==========================================
     LEYENDA
     ========================================== */
  .leyenda {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    font-size: 13px;
  }

  .leyenda-titulo {
    font-weight: 600;
    color: #495057;
  }

  .leyenda-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #666;
  }

  .leyenda-ejemplo {
    padding: 2px 8px;
    border-radius: 4px;
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    font-weight: 600;
    font-family: monospace;
  }

  /* ==========================================
     FORMULARIO
     ========================================== */
  .form-clase {
    background: #f9f9f9;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 24px;
    display: none;
  }

  .form-clase.active {
    display: block;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }

  .form-group {
    margin-bottom: 0;
  }

  .form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #333;
    margin-bottom: 6px;
  }

  .form-group label .required {
    color: #dc3545;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px 12px;
    font-size: 14px;
    border: 2px solid #ddd;
    border-radius: 6px;
    transition: all 0.3s;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-group small {
    display: block;
    color: #666;
    font-size: 12px;
    margin-top: 4px;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    justify-content: space-between;
  }

  .form-actions-left {
    display: flex;
    gap: 12px;
  }

  .form-actions-right {
    display: flex;
    gap: 12px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-family: inherit;
  }

  .btn-primary {
    background: #667eea;
    color: white;
  }

  .btn-primary:hover {
    background: #5568d3;
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
  }

  .btn-secondary:hover {
    background: #5a6268;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }

  /* ==========================================
     GRID DE HORARIO
     ========================================== */
  .horario-grid-container {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .horario-grid {
    width: 100%;
    min-width: 800px;
    border-collapse: collapse;
    font-size: 14px;
  }

  .horario-grid thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .horario-grid th {
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    font-size: 13px;
  }

  .horario-grid th.col-hora {
    min-width: 70px;
    font-size: 12px;
  }

  .horario-grid th.col-dia {
    min-width: 90px;
  }

  .horario-grid td {
    border: 1px solid #dee2e6;
    padding: 0;
    height: 50px;
    vertical-align: middle;
    text-align: center;
  }

  .horario-grid td.col-hora {
    background: #f8f9fa;
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    padding: 8px;
  }

  .celda-clase {
    cursor: pointer;
    transition: background 0.2s;
    min-height: 50px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 4px;
    position: relative;
  }

  .celda-clase:hover {
    background: #f0f0f0;
  }

  .celda-clase.ocupada {
    font-weight: 700;
    font-size: 13px;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    cursor: pointer;
  }

  .celda-clase.ocupada:hover {
    opacity: 0.9;
    filter: brightness(1.1);
  }

  .clase-nombre {
    font-size: 13px;
    line-height: 1.2;
  }

  .clase-detalle {
    font-size: 10px;
    opacity: 0.9;
    margin-top: 2px;
  }

  /* ==========================================
     LOADING
     ========================================== */
  .loading-container {
    text-align: center;
    padding: 40px;
    color: #667eea;
  }

  .spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(102, 126, 234, 0.2);
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ==========================================
     RESPONSIVE
     ========================================== */
  @media (max-width: 768px) {
    .horarioclase-container {
      padding: 16px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .form-actions {
      flex-direction: column;
    }

    .form-actions-left,
    .form-actions-right {
      width: 100%;
    }

    .form-actions .btn {
      width: 100%;
    }

    .horario-grid {
      font-size: 12px;
    }

    .horario-grid th,
    .horario-grid td {
      padding: 6px 4px;
    }

    .leyenda {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
  }
</style>

<!-- ========================================== -->
<!-- CONTENEDOR DE HORARIO DE CLASES -->
<!-- ========================================== -->
<div class="horarioclase-container">
  
  <!-- Header -->
  <div class="horarioclase-header">
    <h2>üïê Horario de Clases</h2>
    <p class="horarioclase-subtitle">Horario semanal fijo - Haz clic en una celda para agregar o editar</p>
  </div>

  <!-- Leyenda -->
  <div class="leyenda">
    <span class="leyenda-titulo">Leyenda:</span>
    <div class="leyenda-item">
      <span class="leyenda-ejemplo">/MATE</span>
      <span>= inicia ‚â• :30 min</span>
    </div>
    <div class="leyenda-item">
      <span class="leyenda-ejemplo">MATE/</span>
      <span>= termina ‚â• :30 min</span>
    </div>
    <div class="leyenda-item">
      <span class="leyenda-ejemplo">MATE</span>
      <span>= hora completa</span>
    </div>
  </div>

  <!-- Formulario para agregar/editar clase -->
  <div id="formClase" class="form-clase">
    <h3 id="formTitle" style="margin-bottom: 16px; color: #667eea;">Agregar Clase</h3>
    
    <form id="claseForm" onsubmit="handleSubmitClase(event)">
      <input type="hidden" id="claseRowNumber" value="">
      <input type="hidden" id="claseModoEdicion" value="false">
      <input type="hidden" id="claseDia" value="">
      <input type="hidden" id="claseHoraSlot" value="">
      
      <div class="form-row">
        <div class="form-group">
          <label>Curso <span class="required">*</span></label>
          <select id="claseCurso" required>
            <option value="">Seleccionar curso...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Hora Inicio <span class="required">*</span></label>
          <input 
            type="time" 
            id="claseHoraIni"
            min="07:00"
            max="22:00"
            required
          >
          <small>Rango: 07:00 - 22:00</small>
        </div>

        <div class="form-group">
          <label>Hora Fin <span class="required">*</span></label>
          <input 
            type="time" 
            id="claseHoraFin"
            min="07:00"
            max="22:00"
            required
          >
          <small>Debe ser mayor a hora inicio</small>
        </div>
      </div>

      <div class="form-actions">
        <div class="form-actions-left">
          <button 
            type="button" 
            class="btn btn-danger" 
            id="btnEliminar" 
            onclick="confirmarEliminarClase()"
            style="display: none;">
            Eliminar
          </button>
        </div>
        <div class="form-actions-right">
          <button type="button" class="btn btn-secondary" onclick="cancelarFormClase()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" id="btnSubmit">
            Guardar
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Grid de horario -->
  <div id="horarioGridContainer" class="horario-grid-container">
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando horario...</p>
    </div>
  </div>

</div>

<!-- ========================================== -->
<!-- JAVASCRIPT -->
<!-- ========================================== -->
<script>
  /**
   * ==========================================
   * VARIABLES LOCALES
   * ==========================================
   */
  let clasesData = [];
  let cursosData = [];
  let horarioMatrix = {}; // { "Lunes": { "08:00": [clase1, ...] } }

  const HORA_INICIO = 7;  // 7 AM
  const HORA_FIN = 22;     // 10 PM
  const DIAS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
  const DIAS_CORTOS = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];

  /**
   * ==========================================
   * INICIALIZACI√ìN
   * ==========================================
   */
  window.addEventListener('load', function() {
    // Verificar que currentUser est√© disponible
    if (typeof currentUser === 'undefined' || !currentUser.codeAlum) {
      showAlert('error', 'Error: No se pudo identificar al usuario');
      return;
    }

    inicializarHorarioClase();
  });

  function inicializarHorarioClase() {
    cargarCursos();
    cargarHorarioClases();
    
    console.log('%cüïê Sub-tab Horario de Clases Cargado', 
                'font-size: 11px; color: #667eea;');
  }

  /**
   * ==========================================
   * CARGAR CURSOS
   * ==========================================
   */
  function cargarCursos() {
    google.script.run
      .withSuccessHandler(handleCursosLoaded)
      .withFailureHandler(function(error) {
        console.error('Error al cargar cursos:', error);
      })
      .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
  }

  function handleCursosLoaded(response) {
    if (response.success) {
      cursosData = response.data;
      poblarDropdownCursos();
    }
  }

  function poblarDropdownCursos() {
    const select = document.getElementById('claseCurso');
    const primerOption = select.options[0].outerHTML;
    select.innerHTML = primerOption;

    cursosData.forEach(function(curso) {
      const option = document.createElement('option');
      option.value = curso.Curso;
      option.textContent = curso.Curso + ' - ' + curso.Completo;
      option.dataset.color = curso.Color || '#667eea';
      select.appendChild(option);
    });
  }

  /**
   * ==========================================
   * CARGAR HORARIO DE CLASES
   * ==========================================
   */
  function cargarHorarioClases() {
    google.script.run
      .withSuccessHandler(handleHorarioLoaded)
      .withFailureHandler(function(error) {
        console.error('Error al cargar horario:', error);
        showAlert('error', 'Error de conexi√≥n al cargar horario');
        renderGridVacio();
      })
      .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
  }

  function handleHorarioLoaded(response) {
    if (response.success) {
      clasesData = response.data;
      construirHorarioMatrix();
      renderHorarioGrid();
    } else {
      console.error('Error:', response.error);
      renderGridVacio();
    }
  }

  /**
   * ==========================================
   * CONSTRUIR MATRIZ DE HORARIO
   * ==========================================
   */
  function construirHorarioMatrix() {
    // Inicializar matriz vac√≠a
    horarioMatrix = {};
    DIAS.forEach(function(dia) {
      horarioMatrix[dia] = {};
    });

    // Llenar matriz con clases
    clasesData.forEach(function(clase) {
      // Extraer d√≠a del Detalle
      const dia = extraerDiaDelDetalle(clase.Detalle);
      if (!dia) return;

      // Calcular qu√© celdas ocupa esta clase
      const horasOcupadas = calcularHorasOcupadas(clase.HoraIni, clase.HoraFin);

      horasOcupadas.forEach(function(horaInfo) {
        const horaKey = horaInfo.hora;

        if (!horarioMatrix[dia][horaKey]) {
          horarioMatrix[dia][horaKey] = [];
        }

        horarioMatrix[dia][horaKey].push({
          clase: clase,
          prefijo: horaInfo.prefijo,
          sufijo: horaInfo.sufijo
        });
      });
    });
  }

  /**
   * Extraer d√≠a de la semana del campo Detalle
   * Busca "Lunes", "Martes", etc. en el texto
   */
  function extraerDiaDelDetalle(detalle) {
    if (!detalle) return null;

    const detalleStr = String(detalle).toLowerCase();
    
    for (let i = 0; i < DIAS.length; i++) {
      if (detalleStr.includes(DIAS[i].toLowerCase())) {
        return DIAS[i];
      }
    }

    return null;
  }

  /**
   * Calcular qu√© horas ocupa una clase (Regla de medias horas - 9.3.3 del DF)
   */
  function calcularHorasOcupadas(horaIni, horaFin) {
    const [hIni, mIni] = horaIni.split(':').map(Number);
    const [hFin, mFin] = horaFin.split(':').map(Number);

    const horas = [];
    let horaInicio = hIni;
    let prefijoPrimera = '';

    // Si inicia en media hora o despu√©s ‚Üí "/" al inicio
    if (mIni >= 30) {
      prefijoPrimera = '/';
    }

    // Recorrer todas las horas ocupadas
    for (let h = horaInicio; h <= hFin; h++) {
      if (h > HORA_FIN) break;

      const horaKey = formatearHora24(h);
      const esUltima = (h === hFin);

      let prefijo = (h === horaInicio) ? prefijoPrimera : '';
      let sufijo = '';

      // Si termina en media hora o despu√©s ‚Üí "/" al final
      if (esUltima && mFin >= 30) {
        sufijo = '/';
      }

      // No incluir la hora de fin si es exacta (00 minutos)
      if (esUltima && mFin === 0) {
        continue;
      }

      horas.push({
        hora: horaKey,
        prefijo: prefijo,
        sufijo: sufijo
      });
    }

    return horas;
  }

  /**
   * ==========================================
   * RENDERIZAR GRID
   * ==========================================
   */
  function renderHorarioGrid() {
    const container = document.getElementById('horarioGridContainer');

    let html = `
      <table class="horario-grid">
        <thead>
          <tr>
            <th class="col-hora">Hora</th>
    `;

    DIAS_CORTOS.forEach(function(dia) {
      html += '<th class="col-dia">' + dia + '</th>';
    });

    html += `
          </tr>
        </thead>
        <tbody>
    `;

    // Generar filas
    for (let hora = HORA_INICIO; hora <= HORA_FIN; hora++) {
      const horaFormato12 = formatearHora12(hora);
      const horaKey = formatearHora24(hora);

      html += '<tr>';
      html += '<td class="col-hora">' + horaFormato12 + '</td>';

      // Generar celdas para cada d√≠a
      for (let i = 0; i < DIAS.length; i++) {
        const dia = DIAS[i];
        const diaCorto = DIAS_CORTOS[i];
        const clases = horarioMatrix[dia][horaKey];

        html += '<td>';

        if (clases && clases.length > 0) {
          // Celda ocupada
          const claseInfo = clases[0];
          const clase = claseInfo.clase;
          const color = obtenerColorCurso(clase.Curso);
          const texto = claseInfo.prefijo + clase.Curso + claseInfo.sufijo;

          html += '<div class="celda-clase ocupada" ';
          html += 'style="background: ' + color + ';" ';
          html += 'onclick="editarClase(\'' + dia + '\', \'' + horaKey + '\')">';
          html += '<div class="clase-nombre">' + texto + '</div>';
          html += '</div>';
        } else {
          // Celda vac√≠a
          html += '<div class="celda-clase" ';
          html += 'onclick="clickCelda(\'' + dia + '\', \'' + horaKey + '\')">';
          html += '</div>';
        }

        html += '</td>';
      }

      html += '</tr>';
    }

    html += `
        </tbody>
      </table>
    `;

    container.innerHTML = html;
  }

  function renderGridVacio() {
    renderHorarioGrid();
  }

  /**
   * ==========================================
   * CLICK EN CELDA
   * ==========================================
   */
  function clickCelda(dia, hora) {
    abrirFormularioAgregar(dia, hora);
  }

  function abrirFormularioAgregar(dia, hora) {
    resetFormClase();

    const diaCorto = DIAS_CORTOS[DIAS.indexOf(dia)];
    const horaFormato12 = formatearHora12Desde24(hora);

    document.getElementById('formTitle').textContent = 'Agregar Clase - ' + diaCorto + ' ' + horaFormato12;
    document.getElementById('claseModoEdicion').value = 'false';
    document.getElementById('claseDia').value = dia;
    document.getElementById('claseHoraSlot').value = hora;
    document.getElementById('btnSubmit').textContent = 'Guardar';
    document.getElementById('btnEliminar').style.display = 'none';

    // Pre-llenar hora inicio
    document.getElementById('claseHoraIni').value = hora;

    // Calcular hora fin (inicio + 1 hora)
    const [h, m] = hora.split(':').map(Number);
    const horaFinSugerida = formatearHora24(Math.min(h + 1, HORA_FIN + 1));
    document.getElementById('claseHoraFin').value = horaFinSugerida;

    document.getElementById('formClase').classList.add('active');
    document.getElementById('claseCurso').focus();
  }

  /**
   * ==========================================
   * EDITAR CLASE
   * ==========================================
   */
  function editarClase(dia, hora) {
    const clases = horarioMatrix[dia][hora];

    if (!clases || clases.length === 0) {
      showAlert('error', 'No hay clase en esta celda');
      return;
    }

    const claseInfo = clases[0];
    const clase = claseInfo.clase;

    const diaCorto = DIAS_CORTOS[DIAS.indexOf(dia)];
    const horaFormato12 = formatearHora12Desde24(hora);

    document.getElementById('formTitle').textContent = 'Editar Clase - ' + diaCorto + ' ' + horaFormato12;
    document.getElementById('claseRowNumber').value = clase._rowNumber;
    document.getElementById('claseModoEdicion').value = 'true';
    document.getElementById('claseDia').value = dia;
    document.getElementById('claseHoraSlot').value = hora;
    document.getElementById('claseCurso').value = clase.Curso;
    document.getElementById('claseHoraIni').value = clase.HoraIni;
    document.getElementById('claseHoraFin').value = clase.HoraFin;
    document.getElementById('btnSubmit').textContent = 'Actualizar';
    document.getElementById('btnEliminar').style.display = 'block';

    document.getElementById('formClase').classList.add('active');
  }

  /**
   * ==========================================
   * SUBMIT FORMULARIO
   * ==========================================
   */
  function handleSubmitClase(event) {
    event.preventDefault();

    const curso = document.getElementById('claseCurso').value.trim();
    const horaIni = document.getElementById('claseHoraIni').value.trim();
    const horaFin = document.getElementById('claseHoraFin').value.trim();
    const dia = document.getElementById('claseDia').value;
    const esEdicion = document.getElementById('claseModoEdicion').value === 'true';

    // Validaciones
    if (!curso) {
      showAlert('error', 'Selecciona un curso');
      return;
    }

    if (!horaIni || !horaFin) {
      showAlert('error', 'Ingresa hora de inicio y fin');
      return;
    }

    if (horaIni >= horaFin) {
      showAlert('error', 'La hora de fin debe ser mayor a la hora de inicio');
      return;
    }

    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = true;
    btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';

    // Preparar params - el d√≠a va en Detalle
    const params = {
      codeAlum: currentUser.codeAlum,
      curso: curso,
      horaIni: horaIni,  // ‚ö†Ô∏è Usar horaIni (no horaInicio)
      horaFin: horaFin,
      detalle: dia  // ‚ö†Ô∏è El d√≠a se guarda en Detalle
    };

    if (esEdicion) {
      params.rowNumber = parseInt(document.getElementById('claseRowNumber').value);

      google.script.run
        .withSuccessHandler(handleClaseUpdated)
        .withFailureHandler(handleClaseError)
        .studentActualizarHorarioClase(params);
    } else {
      google.script.run
        .withSuccessHandler(handleClaseAdded)
        .withFailureHandler(handleClaseError)
        .studentAgregarHorarioClase(params);
    }
  }

  function handleClaseAdded(response) {
    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Guardar';

    if (response.success) {
      showAlert('success', '‚úì Clase agregada exitosamente');
      cancelarFormClase();
      cargarHorarioClases();
    } else {
      showAlert('error', response.error);
    }
  }

  function handleClaseUpdated(response) {
    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Actualizar';

    if (response.success) {
      showAlert('success', '‚úì Clase actualizada exitosamente');
      cancelarFormClase();
      cargarHorarioClases();
    } else {
      showAlert('error', response.error);
    }
  }

  function handleClaseError(error) {
    console.error('Error:', error);
    showAlert('error', 'Error de conexi√≥n. Intenta nuevamente');

    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    const esEdicion = document.getElementById('claseModoEdicion').value === 'true';
    btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  }

  /**
   * ==========================================
   * ELIMINAR CLASE
   * ==========================================
   */
  function confirmarEliminarClase() {
    const rowNumber = parseInt(document.getElementById('claseRowNumber').value);

    if (!rowNumber) {
      showAlert('error', 'No se puede eliminar esta clase');
      return;
    }

    if (confirm('¬øEliminar esta clase del horario?\n\nEsta acci√≥n no se puede deshacer.')) {
      eliminarClase(rowNumber);
    }
  }

  function eliminarClase(rowNumber) {
    google.script.run
      .withSuccessHandler(handleClaseDeleted)
      .withFailureHandler(handleClaseError)
      .studentEliminarHorarioClase({ rowNumber: rowNumber });
  }

  function handleClaseDeleted(response) {
    if (response.success) {
      showAlert('success', '‚úì Clase eliminada exitosamente');
      cancelarFormClase();
      cargarHorarioClases();
    } else {
      showAlert('error', response.error);
    }
  }

  /**
   * ==========================================
   * RESET Y CANCELAR FORMULARIO
   * ==========================================
   */
  function resetFormClase() {
    document.getElementById('claseForm').reset();
    document.getElementById('claseRowNumber').value = '';
    document.getElementById('claseModoEdicion').value = 'false';
    document.getElementById('claseDia').value = '';
    document.getElementById('claseHoraSlot').value = '';
  }

  function cancelarFormClase() {
    document.getElementById('formClase').classList.remove('active');
    resetFormClase();
  }

  /**
   * ==========================================
   * FUNCIONES AUXILIARES
   * ==========================================
   */
  function formatearHora12(hora24) {
    if (hora24 === 12) return '12 PM';
    if (hora24 > 12) return (hora24 - 12) + ' PM';
    if (hora24 === 0) return '12 AM';
    return hora24 + ' AM';
  }

  function formatearHora24(hora) {
    return ('0' + hora).slice(-2) + ':00';
  }

  function formatearHora12Desde24(hora24Str) {
    const [h, m] = hora24Str.split(':').map(Number);
    return formatearHora12(h);
  }

  function obtenerColorCurso(curso) {
    const cursoData = cursosData.find(function(c) {
      return c.Curso === curso;
    });

    return cursoData ? cursoData.Color : '#667eea';
  }
</script>
