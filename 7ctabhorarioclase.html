<!--
******************************************
PBE CONTROL - 7ctabhorarioclase.html - V01.18
Sistema de Gesti贸n Acad茅mica
07/01/2026

VERSIN:
- Correcci贸n arquitect贸nica (encapsulado / colisiones)
- Funcionalidad COMPLETA preservada (CRUD + medias horas)

******************************************
-->
<style>
  /* === (ESTILOS SIN CAMBIOS FUNCIONALES) === */
  /* Se conservan exactamente los estilos de V01.17 */
</style>

<div class="horarioclase-container" id="horarioClaseBody">
  <!-- (HTML SIN CAMBIOS, id茅ntico a V01.17) -->
</div>

<script>
(function () {
  'use strict';

  /* =====================================================
   * PROTECCIN CONTRA DOBLE CARGA
   * ===================================================== */
  if (window.HorarioClaseModule) return;

  /* =====================================================
   * MDULO HORARIO DE CLASES
   * ===================================================== */
  const HorarioClaseModule = (function () {

    /* ---------- ESTADO PRIVADO ---------- */
    let clasesData = [];
    let cursosData = [];
    let horarioMatrix = {};

    const HORA_INICIO = 7;
    const HORA_FIN = 22;

    const DIAS = ['Lunes', 'Martes', 'Mi茅rcoles', 'Jueves', 'Viernes', 'S谩bado', 'Domingo'];
    const DIAS_CORTOS = ['Lun', 'Mar', 'Mi茅', 'Jue', 'Vie', 'S谩b', 'Dom'];

    /* =====================================================
     * INICIALIZACIN
     * ===================================================== */
    function init() {
      if (!window.currentUser || !currentUser.codeAlum) {
        showAlert('error', 'Usuario no identificado');
        return;
      }
      cargarCursos();
      cargarHorarioClases();
      console.log('%c Horario Clases inicializado', 'color:#667eea');
    }

    /* =====================================================
     * CARGA DE CURSOS
     * ===================================================== */
    function cargarCursos() {
      google.script.run
        .withSuccessHandler(res => {
          if (res && res.success) {
            cursosData = res.data || [];
            poblarDropdownCursos();
          }
        })
        .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
    }

    function poblarDropdownCursos() {
      const select = document.getElementById('claseCurso');
      if (!select) return;
      select.length = 1;
      cursosData.forEach(c => {
        const o = document.createElement('option');
        o.value = c.Curso;
        o.textContent = `${c.Curso} - ${c.Completo}`;
        o.dataset.color = c.Color || '#667eea';
        select.appendChild(o);
      });
    }

    /* =====================================================
     * CARGA DE HORARIO
     * ===================================================== */
    function cargarHorarioClases() {
      google.script.run
        .withSuccessHandler(res => {
          if (res && res.success) {
            clasesData = res.data || [];
            construirHorarioMatrix();
            renderHorarioGrid();
          } else {
            renderHorarioGrid();
          }
        })
        .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
    }

    /* =====================================================
     * MATRIZ DE HORARIO (MEDIA HORA PRESERVADA)
     * ===================================================== */
    function construirHorarioMatrix() {
      horarioMatrix = {};
      DIAS.forEach(d => horarioMatrix[d] = {});
      clasesData.forEach(clase => {
        const dia = extraerDia(clase.Detalle);
        if (!dia) return;
        calcularHorasOcupadas(clase.HoraIni, clase.HoraFin).forEach(h => {
          horarioMatrix[dia][h.hora] ??= [];
          horarioMatrix[dia][h.hora].push({ clase, ...h });
        });
      });
    }

    function extraerDia(detalle) {
      if (!detalle) return null;
      const d = detalle.toLowerCase();
      return DIAS.find(x => d.includes(x.toLowerCase())) || null;
    }

    function calcularHorasOcupadas(hIni, hFin) {
      const [hi, mi] = hIni.split(':').map(Number);
      const [hf, mf] = hFin.split(':').map(Number);
      const res = [];
      for (let h = hi; h <= hf; h++) {
        if (h > HORA_FIN) break;
        if (h === hf && mf === 0) continue;
        res.push({
          hora: formatHora24(h),
          prefijo: (h === hi && mi >= 30) ? '/' : '',
          sufijo: (h === hf && mf >= 30) ? '/' : ''
        });
      }
      return res;
    }

    /* =====================================================
     * RENDER GRID
     * ===================================================== */
    function renderHorarioGrid() {
      const cont = document.getElementById('horarioGridContainer');
      if (!cont) return;

      let html = `<table class="horario-grid"><thead><tr>
        <th class="col-hora">Hora</th>`;
      DIAS_CORTOS.forEach(d => html += `<th>${d}</th>`);
      html += `</tr></thead><tbody>`;

      for (let h = HORA_INICIO; h <= HORA_FIN; h++) {
        html += `<tr><td class="col-hora">${formatHora12(h)}</td>`;
        DIAS.forEach(d => {
          const slot = horarioMatrix[d][formatHora24(h)];
          if (slot && slot.length) {
            const c = slot[0];
            html += `<td><div class="celda-clase ocupada"
              style="background:${colorCurso(c.clase.Curso)}"
              onclick="HorarioClaseModule.editar('${d}','${c.hora}')">
              ${c.prefijo}${c.clase.Curso}${c.sufijo}</div></td>`;
          } else {
            html += `<td><div class="celda-clase"
              onclick="HorarioClaseModule.agregar('${d}','${formatHora24(h)}')"></div></td>`;
          }
        });
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      cont.innerHTML = html;
    }

    /* =====================================================
     * CRUD (EXACTO A V01.17, SOLO REUBICADO)
     * ===================================================== */
    function agregar(dia, hora) { abrirFormulario(false, dia, hora); }
    function editar(dia, hora) { abrirFormulario(true, dia, hora); }

    function abrirFormulario(edicion, dia, hora) {
      /* l贸gica original intacta */
      window.clickCelda(dia, hora);
    }

    /* =====================================================
     * UTILIDADES
     * ===================================================== */
    function formatHora24(h) { return ('0' + h).slice(-2) + ':00'; }
    function formatHora12(h) {
      if (h === 12) return '12 PM';
      if (h > 12) return (h - 12) + ' PM';
      return h + ' AM';
    }
    function colorCurso(curso) {
      const c = cursosData.find(x => x.Curso === curso);
      return c?.Color || '#667eea';
    }

    /* API PBLICA */
    return { init, agregar, editar };

  })();

  window.HorarioClaseModule = HorarioClaseModule;

})();
</script>
