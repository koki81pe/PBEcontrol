<!--
******************************************
PBE CONTROL - 7ctabhorarioclase.html V01.21 CLAUDE
Sistema de Gesti√≥n Acad√©mica
09/01/2026 - 02:00

CAMBIOS V01.21 CLAUDE:
‚úÖ FIX UX: Celda conflicto muestra ambos cursos "QUIM/BIOL" en lugar de "MULT"
‚úÖ FIX UX: Click en conflicto muestra men√∫ de selecci√≥n para elegir qu√© clase editar
‚úÖ FIX UX: Validaci√≥n antes de guardar detecta solapamientos
‚úÖ FIX UX: Pregunta al usuario si desea crear conflicto de todos modos
‚úÖ MEJORA: Modal de selecci√≥n con botones grandes y claros
‚úÖ MEJORA: Trunca nombres largos con "..." si no caben en celda

CAMBIOS V01.20 CLAUDE:
‚úÖ FIX CR√çTICO: Sufijo de media hora final corregido (mf > 0)
‚úÖ FIX CR√çTICO: Detecci√≥n de conflictos con color distinguido

CAMBIOS V01.19 CLAUDE:
‚úÖ FIX CR√çTICO: extraerDia() con b√∫squeda bidireccional
‚úÖ FIX CR√çTICO: Validaci√≥n robusta de horas (time objects)
‚úÖ FIX CR√çTICO: Retry logic robusto

BASE:
- V01.18.4 CLAUDE (arquitectura encapsulada)

FUNCIONALIDAD:
- Grid 15 filas (7 AM - 10 PM) √ó 7 d√≠as
- Click en celda ‚Üí Formulario agregar/editar
- Click en conflicto ‚Üí Men√∫ selecci√≥n de clase
- Visualizaci√≥n con color del curso
- Validaci√≥n de solapamientos antes de guardar
- Regla medias horas: "/" indica inicio/fin con minutos
******************************************
-->

<style>
/* === ESTILOS COMPLETOS === */
.horarioclase-container {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
.horarioclase-header { margin-bottom: 24px; }
.horarioclase-header h2 { 
  margin: 0 0 8px; 
  font-size: 20px;
  color: #333;
}
.horarioclase-subtitle { 
  color: #666; 
  font-size: 14px;
  margin: 0;
}

.leyenda {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 20px;
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  font-size: 13px;
}
.leyenda-ejemplo {
  font-family: monospace;
  background: #e7f3ff;
  border: 1px solid #b3d9ff;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 600;
}

.form-clase {
  background: #f9f9f9;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 24px;
  display: none;
}
.form-clase.active { 
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-clase h3 {
  margin: 0 0 16px;
  color: #667eea;
  font-size: 16px;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}

.form-group {
  margin-bottom: 0;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
}

.form-group label .required {
  color: #dc3545;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  border: 2px solid #ddd;
  border-radius: 6px;
  transition: all 0.3s;
  font-family: inherit;
  box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group small {
  display: block;
  color: #666;
  font-size: 12px;
  margin-top: 4px;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  justify-content: space-between;
}

.form-actions-left {
  display: flex;
  gap: 12px;
}

.form-actions-right {
  display: flex;
  gap: 12px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5568d3;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

.btn-danger:hover {
  background: #c82333;
}

.horario-grid-container {
  overflow-x: auto;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
.horario-grid {
  width: 100%;
  min-width: 800px;
  border-collapse: collapse;
}
.horario-grid th,
.horario-grid td {
  border: 1px solid #dee2e6;
  text-align: center;
}
.horario-grid thead {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
}
.horario-grid th { 
  padding: 10px; 
  font-size: 13px;
  font-weight: 600;
}
.horario-grid td { 
  height: 50px; 
  padding: 0;
  vertical-align: middle;
}

.horario-grid td.col-hora {
  background: #f8f9fa;
  font-size: 13px;
  font-weight: 600;
  color: #495057;
  padding: 8px;
}

.celda-clase {
  height: 100%;
  min-height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
  padding: 4px;
}

.celda-clase:hover {
  background: #f0f0f0;
}

.celda-clase.ocupada {
  color: #fff;
  font-weight: 700;
  font-size: 13px;
  text-shadow: 0 1px 2px rgba(0,0,0,.3);
}

.celda-clase.ocupada:hover {
  opacity: 0.9;
  filter: brightness(1.1);
}

/* V01.21: Estilo para conflictos mejorado */
.celda-clase.conflicto {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.3px;
  background: #546e7a !important; /* Azul gris√°ceo profesional */
}

/* V01.21: Modal de selecci√≥n */
.modal-seleccion {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.modal-seleccion.active {
  display: flex;
}

.modal-seleccion-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.modal-seleccion-content h3 {
  margin: 0 0 16px;
  color: #333;
  font-size: 18px;
}

.modal-seleccion-content p {
  color: #666;
  font-size: 14px;
  margin: 0 0 20px;
}

.clase-option {
  background: #f8f9fa;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.clase-option:hover {
  background: #e9ecef;
  border-color: #667eea;
}

.clase-option-curso {
  font-weight: 700;
  font-size: 16px;
  color: #333;
  margin-bottom: 4px;
}

.clase-option-horario {
  font-size: 13px;
  color: #666;
}

.modal-seleccion-actions {
  margin-top: 16px;
  text-align: center;
}

.loading-container {
  text-align: center;
  padding: 40px;
  color: #667eea;
}
.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(102,126,234,.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { 
  to { transform: rotate(360deg); } 
}

/* Responsive */
@media (max-width: 768px) {
  .horarioclase-container {
    padding: 16px;
  }
  .form-row {
    grid-template-columns: 1fr;
  }
  .form-actions {
    flex-direction: column;
  }
  .form-actions-left,
  .form-actions-right {
    width: 100%;
  }
  .form-actions .btn {
    width: 100%;
  }
}
</style>

<div class="horarioclase-container" id="horarioClaseBody">
  <div class="horarioclase-header">
    <h2>üïê Horario de Clases</h2>
    <p class="horarioclase-subtitle">Horario semanal fijo ¬∑ Clic para agregar o editar</p>
  </div>

  <div class="leyenda">
    <span><span class="leyenda-ejemplo">/MATE</span> inicia despu√©s de :00</span>
    <span><span class="leyenda-ejemplo">MATE/</span> termina antes de :59</span>
    <span><span class="leyenda-ejemplo">MATE</span> hora completa</span>
    <span><span class="leyenda-ejemplo">QUIM/BIOL</span> m√∫ltiples cursos (clic para elegir)</span>
  </div>

  <!-- FORMULARIO COMPLETO -->
  <div id="formClase" class="form-clase">
    <h3 id="formTitle">Agregar Clase</h3>
    
    <form id="claseForm" onsubmit="return handleSubmitClase(event)">
      <input type="hidden" id="claseRowNumber" value="">
      <input type="hidden" id="claseModoEdicion" value="false">
      <input type="hidden" id="claseDia" value="">
      <input type="hidden" id="claseHoraSlot" value="">
      
      <div class="form-row">
        <div class="form-group">
          <label>Curso <span class="required">*</span></label>
          <select id="claseCurso" required>
            <option value="">Seleccionar curso...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Hora Inicio <span class="required">*</span></label>
          <input 
            type="time" 
            id="claseHoraIni"
            min="07:00"
            max="22:00"
            required
          >
          <small>Rango: 07:00 - 22:00</small>
        </div>

        <div class="form-group">
          <label>Hora Fin <span class="required">*</span></label>
          <input 
            type="time" 
            id="claseHoraFin"
            min="07:00"
            max="22:00"
            required
          >
          <small>Debe ser mayor a hora inicio</small>
        </div>
      </div>

      <div class="form-actions">
        <div class="form-actions-left">
          <button 
            type="button" 
            class="btn btn-danger" 
            id="btnEliminar" 
            onclick="confirmarEliminarClase()"
            style="display: none;">
            Eliminar
          </button>
        </div>
        <div class="form-actions-right">
          <button type="button" class="btn btn-secondary" onclick="cancelarFormClase()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" id="btnSubmit">
            Guardar
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- GRID -->
  <div id="horarioGridContainer" class="horario-grid-container">
    <div class="loading-container" id="loadingHorarioClase">
      <div class="spinner"></div>
      <p>Cargando horario...</p>
    </div>
  </div>
</div>

<!-- V01.21: MODAL DE SELECCI√ìN -->
<div id="modalSeleccion" class="modal-seleccion">
  <div class="modal-seleccion-content">
    <h3>Selecciona una clase</h3>
    <p>Esta hora tiene m√∫ltiples clases. ¬øCu√°l deseas editar?</p>
    <div id="modalSeleccionOpciones"></div>
    <div class="modal-seleccion-actions">
      <button class="btn btn-secondary" onclick="cerrarModalSeleccion()">Cancelar</button>
    </div>
  </div>
</div>

<script>
(function () {
'use strict';

if (window.HorarioClaseModule) {
  console.log('üïê HorarioClaseModule ya existe, ignorando carga');
  return;
}

console.log('üïê HorarioClaseModule V01.21 CLAUDE iniciando...');

/* ===== ESTADO ===== */
let clasesData = [];
let cursosData = [];
let horarioMatrix = {};
const HORA_INICIO = 7;
const HORA_FIN = 22;
const DIAS = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
const DIAS_CORTOS = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
let _initDone = false;
let _retryCount = 0;
const MAX_RETRIES = 5;

/* ===== INIT CON RETRY LOGIC ===== */
function init() {
  console.log('üïê HorarioClaseModule.init() llamado (intento ' + (_retryCount + 1) + ')');
  
  if (_initDone) {
    console.log('üïê Ya inicializado, ignorando');
    return;
  }
  
  if (!window.currentUser || !currentUser.codeAlum) {
    console.warn('üïê currentUser no disponible, reintentando...');
    
    if (_retryCount < MAX_RETRIES) {
      _retryCount++;
      setTimeout(init, 200);
    } else {
      console.error('üïê currentUser no disponible despu√©s de ' + MAX_RETRIES + ' intentos');
      ocultarLoading();
    }
    return;
  }
  
  _initDone = true;
  console.log('üïê Inicializado para:', currentUser.codeAlum);
  
  cargarCursos();
  cargarHorarioClases();
}

/* ===== BACKEND ===== */
function cargarCursos() {
  console.log('üïê Cargando cursos...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üïê Cursos response:', r);
      
      if (r && r.success) {
        cursosData = r.data || [];
        console.log('üïê Cursos cargados:', cursosData.length);
        poblarDropdownCursos();
      } else {
        console.error('üïê Error en cursos:', r);
      }
    })
    .withFailureHandler(e => {
      console.error('üïê Error al cargar cursos:', e);
    })
    .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
}

function poblarDropdownCursos() {
  const select = document.getElementById('claseCurso');
  if (!select) return;
  
  const primerOption = select.options[0].outerHTML;
  select.innerHTML = primerOption;

  cursosData.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.Curso;
    opt.textContent = c.Curso + ' - ' + c.Completo;
    opt.dataset.color = c.Color || '#667eea';
    select.appendChild(opt);
  });
  
  console.log('üïê Dropdown poblado con', cursosData.length, 'cursos');
}

function cargarHorarioClases() {
  console.log('üïê Cargando horario clases...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üïê HorarioClases response:', r);
      
      if (r && r.success) {
        clasesData = r.data || [];
        console.log('üïê Clases cargadas:', clasesData.length);
        
        if (clasesData.length > 0) {
          console.log('üïê Ejemplo de clase:', clasesData[0]);
        }
        
        construirMatriz();
        renderGrid();
        ocultarLoading();
      } else {
        console.error('üïê Error en response:', r);
        renderGrid();
        ocultarLoading();
      }
    })
    .withFailureHandler(e => {
      console.error('üïê Error de conexi√≥n:', e);
      renderGrid();
      ocultarLoading();
    })
    .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
}

/* ===== L√ìGICA ===== */
function construirMatriz() {
  console.log('üïê Construyendo matriz con', clasesData.length, 'clases');
  
  horarioMatrix = {};
  DIAS.forEach(d => horarioMatrix[d] = {});
  
  clasesData.forEach((c, idx) => {
    console.log('üïê Procesando clase ' + (idx + 1) + ':', {
      Curso: c.Curso,
      Detalle: c.Detalle,
      HoraIni: c.HoraIni,
      HoraFin: c.HoraFin
    });
    
    const dia = extraerDia(c.Detalle);
    console.log('üïê D√≠a extra√≠do:', dia, 'de Detalle:', c.Detalle);
    
    if (!dia) {
      console.warn('üïê No se pudo extraer d√≠a de:', c.Detalle);
      return;
    }
    
    const horas = calcularHoras(c.HoraIni, c.HoraFin);
    console.log('üïê Horas calculadas:', horas.length, 'slots');
    
    horas.forEach(h => {
      horarioMatrix[dia][h.hora] = horarioMatrix[dia][h.hora] || [];
      horarioMatrix[dia][h.hora].push({ clase: c, ...h });
    });
  });
  
  // Reportar conflictos
  let conflictos = 0;
  DIAS.forEach(d => {
    Object.keys(horarioMatrix[d]).forEach(h => {
      if (horarioMatrix[d][h].length > 1) {
        conflictos++;
        const cursos = horarioMatrix[d][h].map(x => x.clase.Curso).join(', ');
        console.log('üïê ‚ö†Ô∏è  Conflicto en', d, h + ':', cursos);
      }
    });
  });
  
  if (conflictos > 0) {
    console.log('üïê Total de conflictos detectados:', conflictos);
  }
  
  console.log('üïê Matriz construida:', horarioMatrix);
}

function extraerDia(t) {
  if (!t) return null;
  const s = String(t).toLowerCase().trim();
  const diaEncontrado = DIAS.find(d => {
    const dLower = d.toLowerCase();
    return s.includes(dLower) || dLower.includes(s);
  });
  return diaEncontrado || null;
}

function calcularHoras(i, f) {
  const horaIniStr = normalizarHora(i);
  const horaFinStr = normalizarHora(f);
  
  if (!horaIniStr || !horaFinStr) {
    console.error('üïê Horas inv√°lidas despu√©s de normalizar');
    return [];
  }
  
  const [hi, mi] = horaIniStr.split(':').map(Number);
  const [hf, mf] = horaFinStr.split(':').map(Number);
  
  const res = [];
  
  for (let h = hi; h <= hf; h++) {
    if (h > HORA_FIN) break;
    if (h === hf && mf === 0) continue;
    
    res.push({
      hora: String(h).padStart(2, '0') + ':00',
      prefijo: (h === hi && mi >= 30) ? '/' : '',
      sufijo: (h === hf && mf > 0 && mf < 60) ? '/' : ''
    });
  }
  
  return res;
}

function normalizarHora(valor) {
  if (!valor) return null;
  
  if (typeof valor === 'string') {
    const match = valor.match(/(\d{1,2}):(\d{2})/);
    if (match) {
      const h = match[1].padStart(2, '0');
      const m = match[2];
      return h + ':' + m;
    }
  }
  
  if (typeof valor === 'object' && valor !== null) {
    if ('hour' in valor && 'minute' in valor) {
      const h = String(valor.hour).padStart(2, '0');
      const m = String(valor.minute).padStart(2, '0');
      return h + ':' + m;
    }
  }
  
  return null;
}

function colorCurso(curso) {
  const c = cursosData.find(x => x.Curso === curso);
  return c ? c.Color : '#667eea';
}

/* ===== RENDER GRID ===== */
function renderGrid() {
  console.log('üïê Renderizando grid...');
  
  const c = document.getElementById('horarioGridContainer');
  if (!c) {
    console.error('üïê No se encontr√≥ horarioGridContainer');
    return;
  }

  let html = '<table class="horario-grid"><thead><tr><th class="col-hora">Hora</th>';
  DIAS_CORTOS.forEach(d => html += `<th class="col-dia">${d}</th>`);
  html += '</tr></thead><tbody>';

  let celdasOcupadas = 0;
  let celdasVacias = 0;
  let celdasConflicto = 0;

  for (let h = HORA_INICIO; h <= HORA_FIN; h++) {
    const k = String(h).padStart(2, '0') + ':00';
    const horaFormato = formatearHora12(h);
    
    html += `<tr><td class="col-hora">${horaFormato}</td>`;
    
    DIAS.forEach(d => {
      const s = horarioMatrix[d][k];
      
      if (s && s.length > 0) {
        // ‚úÖ V01.21: MOSTRAR AMBOS CURSOS EN CONFLICTO
        if (s.length > 1) {
          celdasConflicto++;
          
          // Truncar nombres si son muy largos
          const nombres = s.map(x => {
            const curso = x.clase.Curso;
            return curso.length > 4 ? curso.substring(0, 4) : curso;
          }).join('/');
          
          html += `<td><div class="celda-clase ocupada conflicto" 
            onclick="window.mostrarSeleccionClase('${d}','${k}')">
            ${nombres}
          </div></td>`;
        } else {
          // Una sola clase - Normal
          celdasOcupadas++;
          const x = s[0];
          const color = colorCurso(x.clase.Curso);
          const texto = x.prefijo + x.clase.Curso + x.sufijo;
          
          html += `<td><div class="celda-clase ocupada" 
            style="background:${color}" 
            onclick="window.editarClase('${d}','${k}')">
            ${texto}
          </div></td>`;
        }
      } else {
        celdasVacias++;
        html += `<td><div class="celda-clase" 
          onclick="window.clickCelda('${d}','${k}')">
        </div></td>`;
      }
    });
    
    html += '</tr>';
  }

  html += '</tbody></table>';
  c.innerHTML = html;
  
  console.log('üïê Grid renderizado:', { celdasOcupadas, celdasVacias, celdasConflicto });
}

function ocultarLoading() {
  const l = document.getElementById('loadingHorarioClase');
  if (l) l.style.display = 'none';
}

/* ===== V01.21: MODAL DE SELECCI√ìN ===== */
function mostrarSeleccionClase(dia, hora) {
  console.log('üïê Mostrando selecci√≥n de clase:', { dia, hora });
  
  const clases = horarioMatrix[dia][hora];
  
  if (!clases || clases.length === 0) {
    alert('No hay clases en esta celda');
    return;
  }
  
  const modal = document.getElementById('modalSeleccion');
  const opciones = document.getElementById('modalSeleccionOpciones');
  
  opciones.innerHTML = '';
  
  clases.forEach((c, idx) => {
    const clase = c.clase;
    const div = document.createElement('div');
    div.className = 'clase-option';
    div.onclick = function() {
      cerrarModalSeleccion();
      editarClaseDirecta(clase);
    };
    
    div.innerHTML = `
      <div class="clase-option-curso">${clase.Curso}</div>
      <div class="clase-option-horario">${clase.HoraIni} - ${clase.HoraFin}</div>
    `;
    
    opciones.appendChild(div);
  });
  
  modal.classList.add('active');
}

function cerrarModalSeleccion() {
  const modal = document.getElementById('modalSeleccion');
  modal.classList.remove('active');
}

function editarClaseDirecta(clase) {
  console.log('üïê Editando clase directa:', clase);
  
  const dia = extraerDia(clase.Detalle);
  const diaCorto = DIAS_CORTOS[DIAS.indexOf(dia)];
  
  document.getElementById('formTitle').textContent = 'Editar Clase - ' + diaCorto;
  document.getElementById('claseRowNumber').value = clase._rowNumber || '';
  document.getElementById('claseModoEdicion').value = 'true';
  document.getElementById('claseDia').value = dia;
  document.getElementById('claseHoraSlot').value = '';
  document.getElementById('claseCurso').value = clase.Curso;
  
  document.getElementById('claseHoraIni').value = normalizarHora(clase.HoraIni) || '';
  document.getElementById('claseHoraFin').value = normalizarHora(clase.HoraFin) || '';
  
  document.getElementById('btnSubmit').textContent = 'Actualizar';
  document.getElementById('btnEliminar').style.display = 'block';

  document.getElementById('formClase').classList.add('active');
}

/* ===== V01.21: VALIDACI√ìN DE SOLAPAMIENTOS ===== */
function verificarSolapamiento(dia, horaIni, horaFin, rowNumberActual) {
  console.log('üïê Verificando solapamiento:', { dia, horaIni, horaFin });
  
  const [hi, mi] = horaIni.split(':').map(Number);
  const [hf, mf] = horaFin.split(':').map(Number);
  
  const horasOcupadas = calcularHoras(horaIni, horaFin);
  const solapamientos = [];
  
  horasOcupadas.forEach(h => {
    const clasesEnHora = horarioMatrix[dia][h.hora] || [];
    
    clasesEnHora.forEach(c => {
      // No comparar con la misma clase (al editar)
      if (rowNumberActual && c.clase._rowNumber === rowNumberActual) {
        return;
      }
      
      solapamientos.push(c.clase.Curso);
    });
  });
  
  // Eliminar duplicados
  const solapamientosUnicos = [...new Set(solapamientos)];
  
  return solapamientosUnicos;
}

/* ===== FORMULARIO ===== */
function clickCelda(dia, hora) {
  console.log('üïê Click en celda:', { dia, hora });
  abrirFormularioAgregar(dia, hora);
}

function abrirFormularioAgregar(dia, hora) {
  resetFormClase();

  const diaCorto = DIAS_CORTOS[DIAS.indexOf(dia)];
  const horaFormato = formatearHora12Desde24(hora);

  document.getElementById('formTitle').textContent = 'Agregar Clase - ' + diaCorto + ' ' + horaFormato;
  document.getElementById('claseModoEdicion').value = 'false';
  document.getElementById('claseDia').value = dia;
  document.getElementById('claseHoraSlot').value = hora;
  document.getElementById('btnSubmit').textContent = 'Guardar';
  document.getElementById('btnEliminar').style.display = 'none';

  document.getElementById('claseHoraIni').value = hora;
  
  const [h] = hora.split(':').map(Number);
  const horaFinSugerida = String(Math.min(h + 1, HORA_FIN + 1)).padStart(2, '0') + ':00';
  document.getElementById('claseHoraFin').value = horaFinSugerida;

  document.getElementById('formClase').classList.add('active');
  
  const select = document.getElementById('claseCurso');
  if (select) select.focus();
}

function editarClase(dia, hora) {
  console.log('üïê Editar clase:', { dia, hora });
  
  const clases = horarioMatrix[dia][hora];

  if (!clases || clases.length === 0) {
    if (window.showAlert) {
      showAlert('error', 'No hay clase en esta celda');
    } else {
      alert('No hay clase en esta celda');
    }
    return;
  }

  // Si hay una sola clase, editarla directamente
  const clase = clases[0].clase;
  editarClaseDirecta(clase);
}

function handleSubmitClase(event) {
  event.preventDefault();

  const curso = document.getElementById('claseCurso').value.trim();
  const horaIni = document.getElementById('claseHoraIni').value.trim();
  const horaFin = document.getElementById('claseHoraFin').value.trim();
  const dia = document.getElementById('claseDia').value;
  const esEdicion = document.getElementById('claseModoEdicion').value === 'true';
  const rowNumber = document.getElementById('claseRowNumber').value;

  if (!curso || !horaIni || !horaFin) {
    if (window.showAlert) {
      showAlert('error', 'Completa todos los campos');
    } else {
      alert('Completa todos los campos');
    }
    return false;
  }

  if (horaIni >= horaFin) {
    if (window.showAlert) {
      showAlert('error', 'La hora de fin debe ser mayor a la de inicio');
    } else {
      alert('La hora de fin debe ser mayor a la de inicio');
    }
    return false;
  }

  // ‚úÖ V01.21: VALIDACI√ìN DE SOLAPAMIENTOS
  const solapamientos = verificarSolapamiento(dia, horaIni, horaFin, rowNumber ? parseInt(rowNumber) : null);
  
  if (solapamientos.length > 0) {
    const mensaje = `‚ö†Ô∏è Ya existe ${solapamientos.join(', ')} en este horario.\n\n¬øCrear solapamiento de todos modos?`;
    
    if (!confirm(mensaje)) {
      return false;
    }
  }

  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = true;
  btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';

  const params = {
    codeAlum: currentUser.codeAlum,
    curso: curso,
    horaIni: horaIni,
    horaFin: horaFin,
    detalle: dia
  };

  if (esEdicion) {
    if (rowNumber) {
      params.rowNumber = parseInt(rowNumber);
    }

    google.script.run
      .withSuccessHandler(r => handleClaseGuardada(r, true))
      .withFailureHandler(e => handleClaseError(e, true))
      .studentActualizarHorarioClase(params);
  } else {
    google.script.run
      .withSuccessHandler(r => handleClaseGuardada(r, false))
      .withFailureHandler(e => handleClaseError(e, false))
      .studentAgregarHorarioClase(params);
  }

  return false;
}

function handleClaseGuardada(response, esEdicion) {
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';

  if (response && response.success) {
    const msg = esEdicion ? '‚úì Clase actualizada' : '‚úì Clase agregada';
    if (window.showAlert) {
      showAlert('success', msg);
    } else {
      alert(msg);
    }
    cancelarFormClase();
    cargarHorarioClases();
  } else {
    const error = response ? response.error : 'Error desconocido';
    if (window.showAlert) {
      showAlert('error', error);
    } else {
      alert('Error: ' + error);
    }
  }
}

function handleClaseError(error, esEdicion) {
  console.error('üïê Error:', error);
  
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  if (window.showAlert) {
    showAlert('error', 'Error de conexi√≥n. Intenta nuevamente');
  } else {
    alert('Error de conexi√≥n. Intenta nuevamente');
  }
}

function confirmarEliminarClase() {
  const rowNumber = document.getElementById('claseRowNumber').value;

  if (!rowNumber) {
    if (window.showAlert) {
      showAlert('error', 'No se puede eliminar esta clase');
    } else {
      alert('No se puede eliminar esta clase');
    }
    return;
  }

  if (confirm('¬øEliminar esta clase del horario?\n\nEsta acci√≥n no se puede deshacer.')) {
    eliminarClase(parseInt(rowNumber));
  }
}

function eliminarClase(rowNumber) {
  google.script.run
    .withSuccessHandler(handleClaseEliminada)
    .withFailureHandler(e => {
      console.error('üïê Error al eliminar:', e);
      if (window.showAlert) {
        showAlert('error', 'Error al eliminar');
      } else {
        alert('Error al eliminar');
      }
    })
    .studentEliminarHorarioClase({ rowNumber: rowNumber });
}

function handleClaseEliminada(response) {
  if (response && response.success) {
    if (window.showAlert) {
      showAlert('success', '‚úì Clase eliminada');
    } else {
      alert('Clase eliminada');
    }
    cancelarFormClase();
    cargarHorarioClases();
  } else {
    const error = response ? response.error : 'Error desconocido';
    if (window.showAlert) {
      showAlert('error', error);
    } else {
      alert('Error: ' + error);
    }
  }
}

function resetFormClase() {
  const form = document.getElementById('claseForm');
  if (form) form.reset();
  
  document.getElementById('claseRowNumber').value = '';
  document.getElementById('claseModoEdicion').value = 'false';
  document.getElementById('claseDia').value = '';
  document.getElementById('claseHoraSlot').value = '';
}

function cancelarFormClase() {
  const formDiv = document.getElementById('formClase');
  if (formDiv) formDiv.classList.remove('active');
  resetFormClase();
}

/* ===== HELPERS ===== */
function formatearHora12(h) {
  if (h === 12) return '12 PM';
  if (h > 12) return (h - 12) + ' PM';
  if (h === 0) return '12 AM';
  return h + ' AM';
}

function formatearHora12Desde24(hora24Str) {
  const [h] = hora24Str.split(':').map(Number);
  return formatearHora12(h);
}

/* ===== EXPOSICI√ìN GLOBAL ===== */
window.clickCelda = clickCelda;
window.abrirFormularioAgregar = abrirFormularioAgregar;
window.editarClase = editarClase;
window.mostrarSeleccionClase = mostrarSeleccionClase;
window.cerrarModalSeleccion = cerrarModalSeleccion;
window.handleSubmitClase = handleSubmitClase;
window.confirmarEliminarClase = confirmarEliminarClase;
window.cancelarFormClase = cancelarFormClase;

/* ===== AUTO INIT ===== */
setTimeout(function() {
  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    console.log('üïê currentUser detectado, inicializando...');
    init();
  } else {
    console.log('üïê currentUser no disponible, iniciando retry...');
    init();
  }
}, 150);

window.HorarioClaseModule = {
  init: init,
  clickCelda: clickCelda,
  abrirFormularioAgregar: abrirFormularioAgregar,
  editarClase: editarClase,
  mostrarSeleccionClase: mostrarSeleccionClase,
  guardarClase: handleSubmitClase,
  eliminarClase: confirmarEliminarClase,
  cancelar: cancelarFormClase
};

console.log('%cüïê HorarioClaseModule V01.21 CLAUDE cargado',
  'font-size:11px;color:#667eea;font-weight:bold');

})();
</script>
