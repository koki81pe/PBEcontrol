<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
/******************************************
PROYECTO: PBE Control
ARCHIVO: 7ctabhorariosem.html
VERSI√ìN: 01.27 CLAUDE
FECHA: 10/01/2026 07:30 (UTC-5)
******************************************/
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: TEXTO LIBRE [INICIO] -->
<!--Sin conflicto con HorarioClase-->
<!-- MOD-002: FIN -->

<!-- MOD-003: ESTILOS CSS [INICIO] -->
<style>
.hs-container {
  display: grid;
  grid-template-columns: 150px 1fr;
  gap: 20px;
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  min-height: 600px;
}

.hs-sidebar {
  border-right: 2px solid #e0e0e0;
  padding-right: 16px;
}

.hs-sidebar h3 {
  font-size: 14px;
  color: #667eea;
  margin: 0 0 16px;
  font-weight: 700;
}

.hs-semana-item {
  padding: 10px 12px;
  margin-bottom: 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 13px;
  font-weight: 600;
  color: #495057;
  background: #f8f9fa;
  border: 2px solid transparent;
}

.hs-semana-item:hover {
  background: #e9ecef;
  border-color: #667eea;
}

.hs-semana-item.active {
  background: #667eea;
  color: white;
}

.hs-btn-agregar-semana {
  width: 100%;
  padding: 10px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 12px;
}

.hs-btn-agregar-semana:hover {
  background: #218838;
}

.hs-main {
  position: relative;
}

.hs-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 16px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 8px;
  color: white;
}

.hs-nav-semana {
  display: flex;
  align-items: center;
  gap: 16px;
}

.hs-nav-btn {
  padding: 8px 16px;
  background: rgba(255,255,255,0.2);
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 6px;
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.hs-nav-btn:hover {
  background: rgba(255,255,255,0.3);
  border-color: rgba(255,255,255,0.5);
}

.hs-semana-info {
  font-size: 16px;
  font-weight: 700;
}

.hs-actions {
  display: flex;
  gap: 8px;
}

.hs-btn-action {
  padding: 8px 16px;
  background: rgba(255,255,255,0.2);
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 6px;
  color: white;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.hs-btn-action:hover {
  background: rgba(255,255,255,0.3);
  border-color: rgba(255,255,255,0.5);
}

.hs-grid-container {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  position: relative;
  min-height: 400px;
}

.hs-grid {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.hs-grid thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.hs-grid th {
  padding: 12px 8px;
  text-align: center;
  font-weight: 600;
  border: 1px solid rgba(255,255,255,.2);
}

.hs-grid .hs-col-hora {
  width: 80px;
  background: #f8f9fa;
  font-weight: 600;
  color: #495057;
}

.hs-grid .hs-col-dia {
  width: calc((100% - 80px) / 7);
  min-width: 100px;
}

.hs-grid td {
  padding: 4px;
  border: 1px solid #dee2e6;
  height: 45px;
  vertical-align: middle;
}

.hs-celda {
  min-height: 35px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
  font-size: 12px;
}

.hs-celda:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
}

.hs-celda.ocupada {
  color: white;
  padding: 6px 8px;
}

.hs-celda.clase-fija {
  opacity: 0.6;
  font-style: italic;
}

.hs-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.hs-modal.active {
  display: flex;
}

.hs-modal-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 10px 40px rgba(0,0,0,.2);
}

.hs-modal-content h3 {
  margin: 0 0 20px;
  color: #667eea;
  font-size: 20px;
}

.hs-form-group {
  margin-bottom: 16px;
}

.hs-form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #333;
  font-size: 13px;
}

.hs-form-group input,
.hs-form-group select {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  transition: border 0.3s;
  box-sizing: border-box;
}

.hs-form-group input:focus,
.hs-form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
}

.hs-modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  justify-content: flex-end;
}

.hs-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.hs-btn-primary {
  background: #667eea;
  color: white;
}

.hs-btn-primary:hover {
  background: #5568d3;
}

.hs-btn-secondary {
  background: #6c757d;
  color: white;
}

.hs-btn-secondary:hover {
  background: #5a6268;
}

.hs-btn-danger {
  background: #dc3545;
  color: white;
}

.hs-btn-danger:hover {
  background: #c82333;
}

.hs-loading {
  text-align: center;
  padding: 40px;
  color: #667eea;
}

.hs-spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(102,126,234,.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: hs-spin .8s linear infinite;
}

@keyframes hs-spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .hs-container {
    grid-template-columns: 1fr;
  }
  
  .hs-sidebar {
    border-right: none;
    border-bottom: 2px solid #e0e0e0;
    padding-right: 0;
    padding-bottom: 16px;
  }
  
  .hs-toolbar {
    flex-direction: column;
    gap: 12px;
  }
  
  .hs-grid {
    font-size: 11px;
  }
  
  .hs-grid .hs-col-hora {
    width: 60px;
  }
  
  .hs-celda {
    font-size: 10px;
    padding: 4px;
  }
}

/* === NOTIFICACIONES === */
.hs-notificacion {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  padding: 16px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 10002;
  min-width: 300px;
  animation: hs-slideIn 0.3s ease-out;
}

@keyframes hs-slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.hs-notificacion.success {
  border-left: 4px solid #28a745;
}

.hs-notificacion.error {
  border-left: 4px solid #dc3545;
}

.hs-notificacion.info {
  border-left: 4px solid #17a2b8;
}

.hs-notificacion-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.hs-notificacion.success .hs-notificacion-icon {
  color: #28a745;
}

.hs-notificacion.error .hs-notificacion-icon {
  color: #dc3545;
}

.hs-notificacion.info .hs-notificacion-icon {
  color: #17a2b8;
}

.hs-notificacion-texto {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
  color: #333;
}

.hs-notificacion-cerrar {
  background: none;
  border: none;
  font-size: 20px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.hs-notificacion-cerrar:hover {
  color: #666;
}

</style>
<!-- MOD-003: FIN -->

<!-- MOD-004: ESTRUCTURA HTML [INICIO] -->
<div class="hs-container">
  <div class="hs-sidebar">
    <h3>üìÖ Semanas</h3>
    <div id="hsSemanasList"></div>
    <button class="hs-btn-agregar-semana" onclick="window.agregarNuevaSemana()">
      ‚ûï Agregar Semana
    </button>
  </div>
  
  <div class="hs-main">
    <div class="hs-toolbar">
      <div class="hs-nav-semana">
        <button class="hs-nav-btn" onclick="window.navegarSemana(-1)">‚óÄ Ant</button>
        <div class="hs-semana-info" id="hsSemanaInfo">Semana 1</div>
        <button class="hs-nav-btn" onclick="window.navegarSemana(1)">Sig ‚ñ∂</button>
      </div>
      
      <div class="hs-actions">
        <button class="hs-btn-action" onclick="window.abrirConfigSemana()">
          üîß Configurar
        </button>
        <button class="hs-btn-action" onclick="window.copiarSemanaAnterior()">
          üìã Copiar Sem. ant.
        </button>
        <button class="hs-btn-action" onclick="window.limpiarSemana()">
          üóëÔ∏è Limpiar
        </button>
      </div>
    </div>
    
    <div class="hs-grid-container">
      <div class="hs-loading" id="loadingHS">
        <div class="hs-spinner"></div>
        <p>Cargando horario...</p>
      </div>
      <div id="hsGridContainer"></div>
    </div>
  </div>
</div>

<div id="modalConfigSemana" class="hs-modal">
  <div class="hs-modal-content">
    <h3>Configurar Semana 1</h3>
    
    <form id="formConfigSemana" onsubmit="return window.handleConfigSemana(event)">
      <div class="hs-form-group">
        <label>Primer d√≠a de clases (cualquier d√≠a de la semana):</label>
        <input type="date" id="configFechaInicio" required>
      </div>
      
      <div class="hs-modal-actions">
        <button type="button" class="hs-btn hs-btn-secondary" onclick="window.cerrarConfigSemana()">Cancelar</button>
        <button type="submit" class="hs-btn hs-btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<div id="modalActividad" class="hs-modal">
  <div class="hs-modal-content">
    <h3 id="actividadFormTitle">Agregar Actividad</h3>
    
    <form id="formActividad" onsubmit="return window.handleSubmitActividad(event)">
      <input type="hidden" id="actividadRowNumber">
      <input type="hidden" id="actividadModoEdicion" value="false">
      <input type="hidden" id="actividadFecha">
      <input type="hidden" id="actividadSem">
      
      <div class="hs-form-group">
        <label>Tipo de Actividad:</label>
        <select id="actividadTipo" required>
          <option value="">Seleccionar...</option>
          <option value="Estudio">Estudio</option>
          <option value="Repaso">Repaso</option>
          <option value="Tarea">Tarea</option>
          <option value="Proyecto">Proyecto</option>
          <option value="Lectura">Lectura</option>
          <option value="Personal">Personal</option>
          <option value="Otro">Otro</option>
        </select>
      </div>
      
      <div class="hs-form-group">
        <label>Nombre:</label>
        <input type="text" id="actividadNombre" required placeholder="Ej: Estudio FIS">
      </div>
      
      <div class="hs-form-group">
        <label>Hora Inicio:</label>
        <input type="time" id="actividadHoraIni" required>
      </div>
      
      <div class="hs-form-group">
        <label>Hora Fin:</label>
        <input type="time" id="actividadHoraFin" required>
      </div>
      
      <div class="hs-form-group">
        <label>Color:</label>
        <input type="color" id="actividadColor" value="#17a2b8">
      </div>
      
      <div class="hs-modal-actions">
        <button type="button" class="hs-btn hs-btn-secondary" onclick="window.cerrarModalActividad()">Cancelar</button>
        <button type="button" class="hs-btn hs-btn-danger" id="btnEliminarActividad" style="display:none" onclick="window.confirmarEliminarActividad()">Eliminar</button>
        <button type="submit" class="hs-btn hs-btn-primary" id="btnSubmitActividad">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
(function () {
'use strict';
<!-- MOD-004: FIN -->


<!-- MOD-005A: NOTIFICACIONES [INICIO] -->
function mostrarNotificacion(tipo, mensaje) {
  const notif = document.createElement('div');
  notif.className = `hs-notificacion ${tipo}`;
  
  const iconos = {
    'success': '‚úì',
    'error': '‚úó',
    'info': '‚Ñπ'
  };
  
  notif.innerHTML = `
    <div class="hs-notificacion-icon">${iconos[tipo] || '‚Ñπ'}</div>
    <div class="hs-notificacion-texto">${mensaje}</div>
    <button class="hs-notificacion-cerrar" onclick="this.parentElement.remove()">√ó</button>
  `;
  
  document.body.appendChild(notif);
  
  setTimeout(() => {
    if (notif.parentElement) {
      notif.style.animation = 'hs-slideIn 0.3s ease-out reverse';
      setTimeout(() => notif.remove(), 300);
    }
  }, 4000);
}
<!-- MOD-005A: FIN -->



<!-- MOD-005: JAVASCRIPT - INICIO [INICIO] -->
if (window.HorarioSemanalModule) {
  console.log('üìÖ HorarioSemanalModule ya existe, ignorando carga');
  return;
}

console.log('üìÖ HorarioSemanalModule V01.25 CLAUDE iniciando...');
<!-- MOD-005: FIN -->

<!-- MOD-006: VERIFICACI√ìN Y CONSTANTES [INICIO] -->
let clasesData = [];
let actividadesData = [];
let cursosData = [];
let horarioMatrix = {};
let configSemana = null;
let semanaActual = 1;
const HORA_INICIO = 7;
const HORA_FIN = 22;
const DIAS = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
const DIAS_CORTOS = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
let _initDone = false;
let _retryCount = 0;
const MAX_RETRIES = 5;
<!-- MOD-006: FIN -->

<!-- MOD-007: FUNCI√ìN INICIALIZACI√ìN [INICIO] -->
function init() {
  console.log('üìÖ HorarioSemanalModule.init() llamado (intento ' + (_retryCount + 1) + ')');
  
  if (_initDone) {
    console.log('üìÖ Ya inicializado, ignorando');
    return;
  }
  
  if (!window.currentUser || !currentUser.codeAlum) {
    console.warn('üìÖ currentUser no disponible, reintentando...');
    
    if (_retryCount < MAX_RETRIES) {
      _retryCount++;
      setTimeout(init, 200);
    } else {
      console.error('üìÖ currentUser no disponible despu√©s de ' + MAX_RETRIES + ' intentos');
      ocultarLoading();
    }
    return;
  }
  
  _initDone = true;
  console.log('üìÖ Inicializado para:', currentUser.codeAlum);
  
  cargarConfigSemana();
}
<!-- MOD-007: FIN -->

<!-- MOD-008: FUNCI√ìN CARGA CONFIG SEMANA [INICIO] -->
function cargarConfigSemana() {
  console.log('üìÖ Cargando configuraci√≥n de semana...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üìÖ Config response:', r);
      
      if (r && r.success && r.data && r.data.FechaInicio) {
        configSemana = r.data;
        console.log('üìÖ FechaInicio:', configSemana.FechaInicio);
        
        calcularSemanaActual();
        cargarCursos();
        cargarHorarioClases();
        cargarHorarioSem();
      } else {
        console.log('üìÖ Sin configuraci√≥n, mostrar modal');
        ocultarLoading();
        abrirConfigSemana();
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error al cargar config:', e);
      ocultarLoading();
    })
    .studentObtenerConfigSemana({ codeAlum: currentUser.codeAlum });
}
<!-- MOD-008: FIN -->

<!-- MOD-009: FUNCI√ìN CALCULAR SEMANA ACTUAL [INICIO] -->
function calcularSemanaActual() {
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  const fechaInicio = new Date(configSemana.FechaInicio);
  fechaInicio.setHours(0, 0, 0, 0);
  
  const diffMs = hoy - fechaInicio;
  const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  semanaActual = Math.floor(diffDias / 7) + 1;
  
  if (semanaActual < 1) semanaActual = 1;
  
  console.log('üìÖ Semana actual:', semanaActual);
  
  renderListaSemanas();
  actualizarInfoSemana();
}
<!-- MOD-009: FIN -->

<!-- MOD-010: FUNCI√ìN RENDER LISTA SEMANAS [INICIO] -->
function renderListaSemanas() {
  const lista = document.getElementById('hsSemanasList');
  if (!lista) return;
  
  let html = '';
  
  for (let i = 1; i <= semanaActual; i++) {
    const activeClass = i === semanaActual ? 'active' : '';
    html += `
      <div class="hs-semana-item ${activeClass}" onclick="window.cambiarSemana(${i})">
        Semana ${i}
      </div>
    `;
  }
  
  lista.innerHTML = html;
}
<!-- MOD-010: FIN -->

<!-- MOD-011: FUNCI√ìN ACTUALIZAR INFO SEMANA [INICIO] -->
function actualizarInfoSemana() {
  const info = document.getElementById('hsSemanaInfo');
  if (!info) return;
  
  const fechas = calcularFechasSemana(semanaActual);
  const fechaIni = formatearFechaCorta(fechas.lunes);
  const fechaFin = formatearFechaCorta(fechas.domingo);
  
  info.textContent = `Semana ${semanaActual} (${fechaIni} - ${fechaFin})`;
}
<!-- MOD-011: FIN -->

<!-- MOD-012: FUNCI√ìN CALCULAR FECHAS SEMANA [INICIO] -->
function calcularFechasSemana(numSemana) {
  const fechaInicio = new Date(configSemana.FechaInicio);
  fechaInicio.setHours(0, 0, 0, 0);
  
  const diaSemana = fechaInicio.getDay();
  const diasHastaLunes = diaSemana === 0 ? 6 : diaSemana - 1;
  
  const lunes = new Date(fechaInicio);
  lunes.setDate(lunes.getDate() - diasHastaLunes);
  lunes.setDate(lunes.getDate() + ((numSemana - 1) * 7));
  
  const domingo = new Date(lunes);
  domingo.setDate(domingo.getDate() + 6);
  
  const dias = [];
  for (let i = 0; i < 7; i++) {
    const dia = new Date(lunes);
    dia.setDate(dia.getDate() + i);
    dias.push(dia);
  }
  
  return { lunes, domingo, dias };
}
<!-- MOD-012: FIN -->

<!-- MOD-013: FUNCI√ìN CARGA DE CURSOS [INICIO] -->
function cargarCursos() {
  console.log('üìÖ Cargando cursos...');
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        cursosData = r.data || [];
        console.log('üìÖ Cursos cargados:', cursosData.length);
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error al cargar cursos:', e);
    })
    .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
}
<!-- MOD-013: FIN -->

<!-- MOD-014: FUNCI√ìN CARGA DE HORARIO CLASES [INICIO] -->
function cargarHorarioClases() {
  console.log('üìÖ Cargando horario clases...');
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        clasesData = r.data || [];
        console.log('üìÖ Clases cargadas:', clasesData.length);
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error al cargar clases:', e);
    })
    .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
}
<!-- MOD-014: FIN -->

<!-- MOD-015: FUNCI√ìN CARGA DE HORARIO SEMANAL [INICIO] -->
function cargarHorarioSem() {
  console.log('üìÖ Cargando horario semanal...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üìÖ HorarioSem response:', r);
      
      if (r && r.success) {
        actividadesData = r.data || [];
        console.log('üìÖ Actividades cargadas:', actividadesData.length);
        
        construirMatriz();
        renderGrid();
        ocultarLoading();
      } else {
        console.error('üìÖ Error en response:', r);
        construirMatriz();
        renderGrid();
        ocultarLoading();
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error de conexi√≥n:', e);
      construirMatriz();
      renderGrid();
      ocultarLoading();
    })
    .studentObtenerHorarioSem({ codeAlum: currentUser.codeAlum });
}
<!-- MOD-015: FIN -->

<!-- MOD-016: FUNCI√ìN CONSTRUCCI√ìN DE MATRIZ [INICIO] -->
function construirMatriz() {
  console.log('üìÖ Construyendo matriz...');
  
  const fechas = calcularFechasSemana(semanaActual);
  
  horarioMatrix = {};
  fechas.dias.forEach(fecha => {
    const key = formatearFechaISO(fecha);
    horarioMatrix[key] = {};
  });
  
  clasesData.forEach(c => {
    const dia = extraerDia(c.Detalle);
    if (!dia) return;
    
    const diaIndex = DIAS.indexOf(dia);
    if (diaIndex === -1) return;
    
    const fechaDia = fechas.dias[diaIndex];
    const key = formatearFechaISO(fechaDia);
    
    const horas = calcularHoras(c.HoraIni, c.HoraFin);
    horas.forEach(h => {
      horarioMatrix[key][h.hora] = horarioMatrix[key][h.hora] || [];
      horarioMatrix[key][h.hora].push({
        tipo: 'clase',
        clase: c,
        ...h
      });
    });
  });
  
  actividadesData.forEach(act => {
    const fechaAct = act.FechaHS;
    if (!fechaAct) return;
    
    const key = formatearFechaISO(new Date(fechaAct));
    
    if (!horarioMatrix[key]) return;
    
    const horas = calcularHoras(act.HoraInicio, act.HoraFin);
    horas.forEach(h => {
      horarioMatrix[key][h.hora] = horarioMatrix[key][h.hora] || [];
      horarioMatrix[key][h.hora].push({
        tipo: 'actividad',
        actividad: act,
        ...h
      });
    });
  });
  
  console.log('üìÖ Matriz construida:', horarioMatrix);
}
<!-- MOD-016: FIN -->

<!-- MOD-017: FUNCIONES HELPER DE PROCESAMIENTO [INICIO] -->
function extraerDia(t) {
  if (!t) return null;
  const s = String(t).toLowerCase().trim();
  const diaEncontrado = DIAS.find(d => {
    const dLower = d.toLowerCase();
    return s.includes(dLower) || dLower.includes(s);
  });
  return diaEncontrado || null;
}

function calcularHoras(i, f) {
  const horaIniStr = normalizarHora(i);
  const horaFinStr = normalizarHora(f);
  
  if (!horaIniStr || !horaFinStr) {
    return [];
  }
  
  const [hi, mi] = horaIniStr.split(':').map(Number);
  const [hf, mf] = horaFinStr.split(':').map(Number);
  
  const res = [];
  
  for (let h = hi; h <= hf; h++) {
    if (h > HORA_FIN) break;
    if (h === hf && mf === 0) continue;
    
    res.push({
      hora: String(h).padStart(2, '0') + ':00',
      prefijo: (h === hi && mi >= 30) ? '/' : '',
      sufijo: (h === hf && mf > 0 && mf < 60) ? '/' : ''
    });
  }
  
  return res;
}

function normalizarHora(valor) {
  if (!valor) return null;
  
  if (typeof valor === 'string') {
    const match = valor.match(/(\d{1,2}):(\d{2})/);
    if (match) {
      const h = match[1].padStart(2, '0');
      const m = match[2];
      return h + ':' + m;
    }
  }
  
  if (typeof valor === 'object' && valor !== null) {
    if ('hour' in valor && 'minute' in valor) {
      const h = String(valor.hour).padStart(2, '0');
      const m = String(valor.minute).padStart(2, '0');
      return h + ':' + m;
    }
  }
  
  return null;
}

function colorCurso(curso) {
  const c = cursosData.find(x => x.Curso === curso);
  return c ? c.Color : '#667eea';
}
<!-- MOD-017: FIN -->

<!-- MOD-018: FUNCI√ìN RENDERIZADO DE GRID [INICIO] -->
function renderGrid() {
  console.log('üìÖ Renderizando grid...');
  
  const container = document.querySelector('.hs-grid-container');
  if (!container) {
    console.error('üìÖ No se encontr√≥ hs-grid-container');
    return;
  }
  
  const loading = document.getElementById('loadingHS');
  if (loading) loading.remove();
  
  const c = document.getElementById('hsGridContainer');
  if (!c) return;
  
  const fechas = calcularFechasSemana(semanaActual);
  
  let html = '<table class="hs-grid"><thead><tr><th class="hs-col-hora">Hora</th>';
  
  fechas.dias.forEach((fecha, idx) => {
    const diaCorto = DIAS_CORTOS[idx];
    const fechaCorta = formatearFechaCorta(fecha);
    html += `<th class="hs-col-dia">${diaCorto}<br>${fechaCorta}</th>`;
  });
  
  html += '</tr></thead><tbody>';
  
  for (let h = HORA_INICIO; h <= HORA_FIN; h++) {
    const k = String(h).padStart(2, '0') + ':00';
    const horaFormato = formatearHora12(h);
    
    html += `<tr><td class="hs-col-hora">${horaFormato}</td>`;
    
    fechas.dias.forEach(fecha => {
      const key = formatearFechaISO(fecha);
      const items = horarioMatrix[key][k];
      
      if (items && items.length > 0) {
        const item = items[0];
        
        if (item.tipo === 'clase') {
          const color = colorCurso(item.clase.Curso);
          const texto = item.prefijo + item.clase.Curso + item.sufijo;
          
          html += `<td><div class="hs-celda ocupada clase-fija" style="background:${color}">
            ${texto}
          </div></td>`;
        } else {
          const act = item.actividad;
          const texto = item.prefijo + act.Actividad + item.sufijo;
          
          html += `<td><div class="hs-celda ocupada" 
            style="background:${act.Color}" 
            onclick="window.editarActividad('${key}','${k}')">
            ${texto}
          </div></td>`;
        }
      } else {
        html += `<td><div class="hs-celda" 
          onclick="window.clickCelda('${key}','${k}')">
        </div></td>`;
      }
    });
    
    html += '</tr>';
  }
  
  html += '</tbody></table>';
  c.innerHTML = html;
  
  console.log('üìÖ Grid renderizado');
}

function ocultarLoading() {
  const l = document.getElementById('loadingHS');
  if (l) l.style.display = 'none';
}
<!-- MOD-018: FIN -->

<!-- MOD-019: FUNCIONES FORMATEO [INICIO] -->
function formatearHora12(h) {
  if (h === 12) return '12 PM';
  if (h > 12) return (h - 12) + ' PM';
  if (h === 0) return '12 AM';
  return h + ' AM';
}

function formatearFechaISO(fecha) {
  const year = fecha.getFullYear();
  const month = String(fecha.getMonth() + 1).padStart(2, '0');
  const day = String(fecha.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatearFechaCorta(fecha) {
  const dia = String(fecha.getDate()).padStart(2, '0');
  const mes = String(fecha.getMonth() + 1).padStart(2, '0');
  return `${dia}/${mes}`;
}
<!-- MOD-019: FIN -->

<!-- MOD-020: FUNCIONES NAVEGACI√ìN [INICIO] -->
function cambiarSemana(numSemana) {
  semanaActual = numSemana;
  actualizarInfoSemana();
  renderListaSemanas();
  construirMatriz();
  renderGrid();
}

function navegarSemana(direccion) {
  const nuevaSemana = semanaActual + direccion;
  
  if (nuevaSemana < 1) return;
  
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  const fechaInicio = new Date(configSemana.FechaInicio);
  fechaInicio.setHours(0, 0, 0, 0);
  
  const diffMs = hoy - fechaInicio;
  const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  const semanaMaxima = Math.floor(diffDias / 7) + 1;
  
  if (nuevaSemana > semanaMaxima) return;
  
  cambiarSemana(nuevaSemana);
}

function agregarNuevaSemana() {
  // Avanzar a la siguiente semana sin restricciones
  cambiarSemana(semanaActual + 1);
}
<!-- MOD-020: FIN -->

<!-- MOD-021: FUNCIONES CONFIG SEMANA [INICIO] -->
function abrirConfigSemana() {
  const modal = document.getElementById('modalConfigSemana');
  if (!modal) return;
  
  const input = document.getElementById('configFechaInicio');
  if (input && configSemana && configSemana.FechaInicio) {
    input.value = configSemana.FechaInicio;
  }
  
  modal.classList.add('active');
}

function cerrarConfigSemana() {
  const modal = document.getElementById('modalConfigSemana');
  if (modal) modal.classList.remove('active');
}

function handleConfigSemana(event) {
  event.preventDefault();
  
  const fechaInput = document.getElementById('configFechaInicio').value;
  
  if (!fechaInput) {
    mostrarNotificacion('info', 'Ingresa una fecha');
    return false;
  }
  
  const fecha = new Date(fechaInput + 'T00:00:00');
  
  const diaSemana = fecha.getDay();
  const diasHastaLunes = diaSemana === 0 ? 6 : diaSemana - 1;
  
  const lunes = new Date(fecha);
  lunes.setDate(lunes.getDate() - diasHastaLunes);
  
  const fechaInicio = formatearFechaISO(lunes);
  
  console.log('üìÖ Guardando config:', fechaInicio);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        mostrarNotificacion('success', 'Configuraci√≥n guardada');
        cerrarConfigSemana();
        location.reload();
      } else {
        mostrarNotificacion('error', 'Error al guardar: ' + (r ? r.error : 'Desconocido'));
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexi√≥n');
    })
    .studentGuardarConfigSemana({
      codeAlum: currentUser.codeAlum,
      fechaInicio: fechaInicio
    });
  
  return false;
}
<!-- MOD-021: FIN -->

<!-- MOD-022: FUNCIONES FORMULARIO ACTIVIDAD [INICIO] -->
function clickCelda(fecha, hora) {
  console.log('üìÖ Click en celda:', { fecha, hora });
  abrirFormularioActividad(fecha, hora);
}

function abrirFormularioActividad(fecha, hora) {
  resetFormActividad();
  
  const fechaObj = new Date(fecha);
  const diaIndex = fechaObj.getDay() === 0 ? 6 : fechaObj.getDay() - 1;
  const diaCorto = DIAS_CORTOS[diaIndex];
  const fechaCorta = formatearFechaCorta(fechaObj);
  
  document.getElementById('actividadFormTitle').textContent = `Agregar Actividad - ${diaCorto} ${fechaCorta}`;
  document.getElementById('actividadModoEdicion').value = 'false';
  document.getElementById('actividadFecha').value = fecha;
  document.getElementById('actividadSem').value = semanaActual;
  document.getElementById('btnSubmitActividad').textContent = 'Guardar';
  document.getElementById('btnEliminarActividad').style.display = 'none';
  
  document.getElementById('actividadHoraIni').value = hora;
  
  const [h] = hora.split(':').map(Number);
  const horaFinSugerida = String(Math.min(h + 1, HORA_FIN + 1)).padStart(2, '0') + ':00';
  document.getElementById('actividadHoraFin').value = horaFinSugerida;
  
  document.getElementById('modalActividad').classList.add('active');
}

function editarActividad(fecha, hora) {
  const key = fecha;
  const items = horarioMatrix[key][hora];
  
  if (!items || items.length === 0) return;
  
  const item = items.find(i => i.tipo === 'actividad');
  if (!item) return;
  
  const act = item.actividad;
  
  const fechaObj = new Date(fecha);
  const diaIndex = fechaObj.getDay() === 0 ? 6 : fechaObj.getDay() - 1;
  const diaCorto = DIAS_CORTOS[diaIndex];
  const fechaCorta = formatearFechaCorta(fechaObj);
  
  document.getElementById('actividadFormTitle').textContent = `Editar Actividad - ${diaCorto} ${fechaCorta}`;
  document.getElementById('actividadRowNumber').value = act._rowNumber || '';
  document.getElementById('actividadModoEdicion').value = 'true';
  document.getElementById('actividadFecha').value = fecha;
  document.getElementById('actividadSem').value = act.Sem || semanaActual;
  document.getElementById('actividadTipo').value = act.TipoAct || '';
  document.getElementById('actividadNombre').value = act.Actividad || '';
  document.getElementById('actividadHoraIni').value = normalizarHora(act.HoraInicio) || '';
  document.getElementById('actividadHoraFin').value = normalizarHora(act.HoraFin) || '';
  document.getElementById('actividadColor').value = act.Color || '#17a2b8';
  
  document.getElementById('btnSubmitActividad').textContent = 'Actualizar';
  document.getElementById('btnEliminarActividad').style.display = 'block';
  
  document.getElementById('modalActividad').classList.add('active');
}

function resetFormActividad() {
  const form = document.getElementById('formActividad');
  if (form) form.reset();
  
  document.getElementById('actividadRowNumber').value = '';
  document.getElementById('actividadModoEdicion').value = 'false';
  document.getElementById('actividadFecha').value = '';
  document.getElementById('actividadSem').value = '';
}

function cerrarModalActividad() {
  const modal = document.getElementById('modalActividad');
  if (modal) modal.classList.remove('active');
  resetFormActividad();
}

function handleSubmitActividad(event) {
  event.preventDefault();
  
  const tipo = document.getElementById('actividadTipo').value.trim();
  const nombre = document.getElementById('actividadNombre').value.trim();
  const horaIni = document.getElementById('actividadHoraIni').value.trim();
  const horaFin = document.getElementById('actividadHoraFin').value.trim();
  const fecha = document.getElementById('actividadFecha').value;
  const sem = document.getElementById('actividadSem').value;
  const color = document.getElementById('actividadColor').value;
  const esEdicion = document.getElementById('actividadModoEdicion').value === 'true';
  const rowNumber = document.getElementById('actividadRowNumber').value;
  
  if (!tipo || !nombre || !horaIni || !horaFin) {
    mostrarNotificacion('info', 'Completa todos los campos');
    return false;
  }
  
  if (horaIni >= horaFin) {
    mostrarNotificacion('info', 'La hora de fin debe ser mayor a la de inicio');
    return false;
  }
  
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = true;
  btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';
  
  const params = {
    codeAlum: currentUser.codeAlum,
    actividad: nombre,
    horaInicio: horaIni,
    horaFin: horaFin,
    fechaHS: fecha,
    tipoAct: tipo,
    color: color,
    sem: sem
  };
  
  if (esEdicion) {
    if (rowNumber) {
      params.rowNumber = parseInt(rowNumber);
    }
    
    google.script.run
      .withSuccessHandler(r => handleActividadGuardada(r, true))
      .withFailureHandler(e => handleActividadError(e, true))
      .studentActualizarHorarioSem(params);
  } else {
    google.script.run
      .withSuccessHandler(r => handleActividadGuardada(r, false))
      .withFailureHandler(e => handleActividadError(e, false))
      .studentAgregarHorarioSem(params);
  }
  
  return false;
}

function handleActividadGuardada(response, esEdicion) {
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  if (response && response.success) {
    const msg = esEdicion ? '‚úì Actividad actualizada' : '‚úì Actividad agregada';
    mostrarNotificacion('success', msg);
    cerrarModalActividad();
    cargarHorarioSem();
  } else {
    const error = response ? response.error : 'Error desconocido';
    mostrarNotificacion('error', 'Error: ' + error);
  }
}

function handleActividadError(error, esEdicion) {
  console.error('üìÖ Error:', error);
  
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  mostrarNotificacion('error', 'Error de conexi√≥n. Intenta nuevamente');
}

function confirmarEliminarActividad() {
  const rowNumber = document.getElementById('actividadRowNumber').value;
  
  if (!rowNumber) {
    mostrarNotificacion('info', 'No se puede eliminar esta actividad');
    return;
  }
  
  if (confirm('¬øEliminar esta actividad?\n\nEsta acci√≥n no se puede deshacer.')) {
    eliminarActividad(parseInt(rowNumber));
  }
}

function eliminarActividad(rowNumber) {
  google.script.run
    .withSuccessHandler(handleActividadEliminada)
    .withFailureHandler(e => {
      console.error('üìÖ Error al eliminar:', e);
      mostrarNotificacion('error', 'Error al eliminar');
    })
    .studentEliminarHorarioSem({ rowNumber: rowNumber });
}

function handleActividadEliminada(response) {
  if (response && response.success) {
    mostrarNotificacion('success', 'Actividad eliminada');
    cerrarModalActividad();
    cargarHorarioSem();
  } else {
    const error = response ? response.error : 'Error desconocido';
    mostrarNotificacion('error', 'Error: ' + error);
  }
}
<!-- MOD-022: FIN -->

<!-- MOD-023: FUNCIONES COPIAR Y LIMPIAR [INICIO] -->
function copiarSemanaAnterior() {
  if (semanaActual <= 1) {
    mostrarNotificacion('info', 'No hay semana anterior para copiar');
    return;
  }
  
  if (!confirm(`¬øCopiar actividades de Semana ${semanaActual - 1} a Semana ${semanaActual}?`)) {
    return;
  }
  
  const fechasOrigen = calcularFechasSemana(semanaActual - 1);
  const fechasDestino = calcularFechasSemana(semanaActual);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        mostrarNotificacion('success', `${r.data} actividades copiadas`);
        cargarHorarioSem();
      } else {
        mostrarNotificacion('error', 'Error al copiar: ' + (r ? r.error : 'Desconocido'));
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexi√≥n');
    })
    .studentCopiarSemana({
      codeAlum: currentUser.codeAlum,
      fechaInicioOrigen: formatearFechaISO(fechasOrigen.lunes),
      fechaFinOrigen: formatearFechaISO(fechasOrigen.domingo),
      fechaInicioDestino: formatearFechaISO(fechasDestino.lunes)
    });
}

function limpiarSemana() {
  if (!confirm(`¬øEliminar TODAS las actividades de Semana ${semanaActual}?\n\nLas clases fijas NO se eliminar√°n.\nEsta acci√≥n no se puede deshacer.`)) {
    return;
  }
  
  const fechas = calcularFechasSemana(semanaActual);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        mostrarNotificacion('success', `${r.data} actividades eliminadas`);
        cargarHorarioSem();
      } else {
        mostrarNotificacion('error', 'Error al limpiar: ' + (r ? r.error : 'Desconocido'));
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexi√≥n');
    })
    .studentLimpiarSemana({
      codeAlum: currentUser.codeAlum,
      fechaInicio: formatearFechaISO(fechas.lunes),
      fechaFin: formatearFechaISO(fechas.domingo)
    });
}
<!-- MOD-023: FIN -->

<!-- MOD-024: C√ìDIGO DE CIERRE [INICIO] -->
window.cambiarSemana = cambiarSemana;
window.navegarSemana = navegarSemana;
window.agregarNuevaSemana = agregarNuevaSemana;
window.abrirConfigSemana = abrirConfigSemana;
window.cerrarConfigSemana = cerrarConfigSemana;
window.handleConfigSemana = handleConfigSemana;
window.clickCelda = clickCelda;
window.editarActividad = editarActividad;
window.cerrarModalActividad = cerrarModalActividad;
window.handleSubmitActividad = handleSubmitActividad;
window.confirmarEliminarActividad = confirmarEliminarActividad;
window.copiarSemanaAnterior = copiarSemanaAnterior;
window.limpiarSemana = limpiarSemana;

setTimeout(function() {
  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    console.log('üìÖ currentUser detectado, inicializando...');
    init();
  } else {
    console.log('üìÖ currentUser no disponible, iniciando retry...');
    init();
  }
}, 150);

window.HorarioSemanalModule = {
  init: init,
  cambiarSemana: cambiarSemana,
  navegarSemana: navegarSemana,
  abrirConfigSemana: abrirConfigSemana,
  copiarSemanaAnterior: copiarSemanaAnterior,
  limpiarSemana: limpiarSemana
};

console.log('%cüìÖ HorarioSemanalModule V01.25 CLAUDE cargado',
  'font-size:11px;color:#667eea;font-weight:bold');

})();
</script>
<!-- MOD-024: FIN -->

<!-- MOD-025: DOCUMENTACI√ìN Y NOTAS [INICIO] -->
<!--
DESCRIPCI√ìN:
Sistema de Horario Semanal con panel lateral de semanas, navegaci√≥n,
configuraci√≥n de Semana 1, copia de actividades y limpieza.

CAMBIOS V01.25 CLAUDE:
‚úÖ Aislamiento completo de estilos con prefijo .hs-
‚úÖ IDs √∫nicos: hsGridContainer, loadingHS, modalConfigSemana, modalActividad
‚úÖ FIX CR√çTICO: Loading se remueve antes de renderizar grid
‚úÖ Sin contaminaci√≥n con HorarioClase
‚úÖ Backend V01.18 normaliza fechas a ISO correctamente
‚úÖ Modularizaci√≥n completa seg√∫n CodeWorkshop v2.1

CARACTER√çSTICAS:
- Panel lateral con lista de semanas hasta hoy
- Bot√≥n "Agregar" para crear nueva semana
- Navegaci√≥n ‚óÄ Ant / Sig ‚ñ∂ entre semanas
- Bot√≥n "üîß Configurar" para establecer Semana 1
- Bot√≥n "üìã Copiar Sem. ant." para duplicar actividades
- Bot√≥n "üóëÔ∏è Limpiar" para borrar actividades de la semana
- Grid 7 d√≠as √ó 16 horas (7 AM - 10 PM)
- Carga autom√°tica de clases fijas desde HorarioClases
- CRUD de actividades semanales en HorarioSem

DEPENDENCIAS:
- MOD-007: Requiere window.currentUser.codeAlum
- MOD-008: Requiere studentObtenerConfigSemana() backend
- MOD-013: Requiere studentObtenerCursos() backend
- MOD-014: Requiere studentObtenerHorarioClases() backend
- MOD-015: Requiere studentObtenerHorarioSem() backend
- MOD-021: Requiere studentGuardarConfigSemana() backend
- MOD-022: Requiere studentAgregarHorarioSem() y 
  studentActualizarHorarioSem() backend
- MOD-023: Requiere studentCopiarSemana() y 
  studentLimpiarSemana() backend

ESTRUCTURA DE DATOS:
ConfigSemana {
  FechaInicio (ISO: YYYY-MM-DD)
}

HorarioSem {
  FechaReg, CodeAlum, Actividad, HoraInicio, HoraFin, 
  FechaHS, TipoAct, Color, Sem
}

HorarioClases {
  FechaReg, CodeAlum, Curso, HoraIni, HoraFin, Detalle
}

Cursos {
  Curso, Completo, Color
}

ADVERTENCIAS:
- MOD-006: DIAS es constante, no usar .push()
- MOD-009: Semana actual se calcula desde FechaInicio
- MOD-012: calcularFechasSemana() ajusta a lunes autom√°tico
- MOD-016: Matriz combina clases fijas + actividades
- MOD-017: calcularHoras() no valida fuera rango 7-22
- MOD-018: renderGrid() sobrescribe innerHTML, elimina loading
- MOD-020: navegarSemana() no permite semanas futuras
- MOD-023: limpiarSemana() NO elimina clases fijas

AISLAMIENTO:
- Todos los estilos CSS usan prefijo .hs-
- Todos los IDs √∫nicos: hsGridContainer, loadingHS, 
  modalConfigSemana, modalActividad
- No hay contaminaci√≥n con HorarioClase (prefijo .hc-)
- IIFE con 'use strict' para encapsulamiento completo

PR√ìXIMAS MEJORAS:
- Implementar drag & drop para mover actividades
- Agregar vista de impresi√≥n semanal
- Exportaci√≥n a PDF/imagen
- Filtro por tipo de actividad
- Estad√≠sticas de horas por semana
- Notificaciones de actividades pr√≥ximas
-->
<!-- MOD-025: FIN -->
