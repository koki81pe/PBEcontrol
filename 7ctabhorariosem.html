<!--
******************************************
PBE CONTROL - 7ctabhorariosem.html - V01.18 GPT
Sistema de GestiÃ³n AcadÃ©mica
07/01/2026

âœ” Refactor V01.17
âœ” Encapsulado total (sin colisiones)
âœ” Mantiene TODA la funcionalidad original
âœ” Media hora, CRUD, Repaso / Actividad
âœ” Clases fijas + actividades semanales
******************************************
-->

<div id="HorarioSemRoot"></div>

<script>
(function () {
  'use strict';
  if (window.HorarioSemModule) return;

  const HorarioSemModule = {
    state: {
      offset: 0,
      dias: [],
      cursos: [],
      clases: [],
      actividades: [],
      matrix: {},
      celda: { fecha: null, hora: null }
    }
  };

  /* ================= INIT ================= */
  HorarioSemModule.init = function () {
    this.state.offset = window.PlanningModule?.state?.weekOffset || 0;
    this.state.dias = this.calcSemana(this.state.offset);
    this.renderBase();
    this.loadAll();
  };

  /* ================= DATA ================= */
  HorarioSemModule.loadAll = function () {
    const p = { codeAlum: currentUser.codeAlum };
    Promise.all([
      this.call('studentObtenerCursos', p),
      this.call('studentObtenerHorarioClases', p),
      this.call('studentObtenerHorarioSem', p)
    ]).then(([cursos, clases, actividades]) => {
      this.state.cursos = cursos;
      this.state.clases = clases;
      this.state.actividades = actividades;
      this.buildMatrix();
      this.renderGrid();
    });
  };

  HorarioSemModule.call = function (fn, p) {
    return new Promise(res => {
      google.script.run
        .withSuccessHandler(r => res(r.success ? r.data : []))[fn](p);
    });
  };

  /* ================= MATRIX ================= */
  HorarioSemModule.buildMatrix = function () {
    this.state.matrix = {};
    this.state.dias.forEach(d => this.state.matrix[this.iso(d)] = {});

    const push = (fecha, hora, obj) => {
      this.state.matrix[fecha][hora] ||= [];
      this.state.matrix[fecha][hora].push(obj);
    };

    const calcHoras = (ini, fin) => {
      const [hi, mi] = ini.split(':').map(Number);
      const [hf, mf] = fin.split(':').map(Number);
      const arr = [];
      for (let h = hi; h <= hf; h++) {
        if (h === hf && mf === 0) continue;
        arr.push({
          hora: String(h).padStart(2,'0') + ':00',
          pre: (h === hi && mi >= 30) ? '/' : '',
          suf: (h === hf && mf >= 30) ? '/' : ''
        });
      }
      return arr;
    };

    /* Clases fijas */
    this.state.clases.forEach(c => {
      const f = this.matchDia(c.Detalle);
      if (!f) return;
      calcHoras(c.HoraIni, c.HoraFin).forEach(h =>
        push(f, h.hora, {
          txt: h.pre + c.Curso + h.suf,
          color: this.colorCurso(c.Curso),
          fijo: true
        })
      );
    });

    /* Actividades */
    this.state.actividades.forEach(a => {
      if (!this.state.matrix[a.FechaHS]) return;
      calcHoras(a.HoraInicio, a.HoraFin).forEach(h =>
        push(a.FechaHS, h.hora, {
          txt: h.pre + a.Actividad + h.suf,
          color: a.Color,
          badge: a.TipoAct,
          fijo: false,
          data: a
        })
      );
    });
  };

  /* ================= RENDER ================= */
  HorarioSemModule.renderBase = function () {
    document.getElementById('HorarioSemRoot').innerHTML = `
      <h2>ðŸ“… Horario Semanal</h2>
      <div id="gridHS"></div>
      ${this.renderDialogs()}
    `;
  };

  HorarioSemModule.renderGrid = function () {
    const dias = this.state.dias;
    let html = `<table class="horario-grid"><thead><tr><th>Hora</th>`;
    dias.forEach(d => html += `<th>${d.getDate()}/${d.getMonth()+1}</th>`);
    html += `</tr></thead><tbody>`;

    for (let h = 7; h <= 22; h++) {
      const hk = String(h).padStart(2,'0') + ':00';
      html += `<tr><td>${h}:00</td>`;
      dias.forEach(d => {
        const f = this.iso(d);
        const items = this.state.matrix[f][hk] || [];
        html += `<td onclick="HorarioSemModule.clickCell('${f}','${hk}')">`;
        items.forEach(i => {
          html += `<div style="background:${i.color}" 
              ${i.fijo?'':'onclick="HorarioSemModule.edit(event,'+JSON.stringify(i.data).replace(/"/g,'&quot;')+')"'}>${i.txt}</div>`;
        });
        html += `</td>`;
      });
      html += `</tr>`;
    }
    document.getElementById('gridHS').innerHTML = html + `</tbody></table>`;
  };

  /* ================= UI ================= */
  HorarioSemModule.clickCell = function (f,h) {
    this.state.celda = {fecha:f, hora:h};
    this.showTipo();
  };

  HorarioSemModule.edit = function (e, data) {
    e.stopPropagation();
    this.openForm(data.TipoAct, data);
  };

  /* ================= HELPERS ================= */
  HorarioSemModule.calcSemana = function (o) {
    const d = new Date();
    d.setDate(d.getDate() - (d.getDay()||7) + 1 + o*7);
    return Array.from({length:7},(_,i)=>new Date(d.getFullYear(),d.getMonth(),d.getDate()+i));
  };
  HorarioSemModule.iso = d => d.toISOString().slice(0,10);
  HorarioSemModule.matchDia = function (det) {
    const dias = ['lunes','martes','miÃ©rcoles','jueves','viernes','sÃ¡bado','domingo'];
    const i = dias.findIndex(x => det?.toLowerCase().includes(x));
    return i === -1 ? null : this.iso(this.state.dias[i]);
  };
  HorarioSemModule.colorCurso = function (c) {
    return this.state.cursos.find(x=>x.Curso===c)?.Color || '#667eea';
  };

  window.HorarioSemModule = HorarioSemModule;
  HorarioSemModule.init();
})();
</script>
