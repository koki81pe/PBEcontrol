<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 3panelstudent.html
VERSI√ìN: 01.21
FECHA: 18/01/2026 15:00 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: APERTURA HTML [INICIO] -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBE Control - Panel Estudiante</title>
<!-- MOD-002: FIN -->

<!-- MOD-003: ESTILOS [INICIO] -->
<style>
/* Reset y Base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: #f5f7fa;
  min-height: 100vh;
}

/* Navbar */
.navbar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 30px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.navbar-brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.navbar-brand h1 {
  font-size: 24px;
  font-weight: 700;
}

.navbar-user {
  display: flex;
  align-items: center;
  gap: 20px;
}

.user-name {
  font-size: 15px;
  opacity: 0.95;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-logout {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-logout:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Layout Principal con Tabs Verticales */
.main-layout {
  max-width: 1400px;
  margin: 30px auto;
  padding: 0 20px;
  display: flex;
  gap: 20px;
}

/* Tabs Verticales (Izquierda) */
.tabs-sidebar {
  width: 260px;
  flex-shrink: 0;
}

.tabs-nav {
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: sticky;
  top: 100px;
}

.tab-btn {
  padding: 20px 25px;
  font-size: 15px;
  font-weight: 600;
  color: #666;
  background: #f5f5f5;
  border: none;
  border-left: 4px solid transparent;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 10px;
}

.tab-btn:hover {
  background: #e8e8e8;
  color: #333;
}

.tab-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-left-color: #4c5fd5;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

/* Contenedor de Contenido (Derecha) */
.content-container {
  flex: 1;
  min-width: 0;
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s ease-out;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Alertas Globales */
.alert {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 24px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 9999;
  animation: slideIn 0.3s ease-out;
  max-width: 400px;
  font-size: 14px;
  font-weight: 500;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border-left: 4px solid #28a745;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border-left: 4px solid #dc3545;
}

.alert-warning {
  background: #fff3cd;
  color: #856404;
  border-left: 4px solid #ffc107;
}

.alert-info {
  background: #d1ecf1;
  color: #0c5460;
  border-left: 4px solid #17a2b8;
}

/* Loading Screen */
.loading-screen {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 20px;
}

.loading-screen.active {
  display: flex;
}

.spinner-large {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(102, 126, 234, 0.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: 16px;
  color: #667eea;
  font-weight: 600;
}

/* Responsive - Mobile */
@media (max-width: 768px) {
  .navbar {
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    position: relative;
  }

  .navbar-brand h1 {
    font-size: 20px;
  }

  .navbar-user {
    flex-direction: column;
    gap: 8px;
  }

  .main-layout {
    flex-direction: column;
    margin: 20px auto;
    padding: 0 12px;
  }

  .tabs-sidebar {
    width: 100%;
    position: relative;
  }

  .tabs-nav {
    position: relative;
    top: 0;
    flex-direction: row;
    overflow-x: auto;
    gap: 8px;
    padding-bottom: 10px;
  }

  .tab-btn {
    padding: 14px 20px;
    border-left: none;
    border-bottom: 3px solid transparent;
    min-width: max-content;
    justify-content: center;
  }

  .tab-btn.active {
    border-left: none;
    border-bottom-color: #4c5fd5;
  }

  .content-container {
    padding: 0;
  }

  .alert {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
  }
}
</style>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT GLOBAL - INICIALIZACI√ìN [INICIO] -->
<script>
// Variable Global - Usuario Actual
var currentUser = {
  codeAlum: '',
  nombre: '',
  email: ''
};

// Inicializaci√≥n Inmediata (IIFE)
(function initializeUserImmediate() {
  try {
    const userData = sessionStorage.getItem('pbe_user');
    
    if (!userData) {
      console.error('‚úó No hay datos de sesi√≥n');
      alert('No se pudo identificar al usuario. Redirigiendo al login...');
      setTimeout(function() {
        window.top.location.href = '<?!= scriptUrl ?>';
      }, 2000);
      return;
    }
    
    const user = JSON.parse(userData);
    
    if (!user.codeAlum || !user.nombre) {
      console.error('‚úó Datos de usuario incompletos:', user);
      alert('Datos de usuario incompletos. Redirigiendo al login...');
      setTimeout(function() {
        window.top.location.href = '<?!= scriptUrl ?>';
      }, 2000);
      return;
    }
    
    currentUser.codeAlum = user.codeAlum;
    currentUser.nombre = user.nombre;
    currentUser.email = user.email || '';
    
    console.log('‚úÖ Usuario inicializado correctamente:', currentUser);
    
  } catch(error) {
    console.error('‚úó Error al inicializar usuario:', error);
    alert('Error al cargar datos del usuario. Redirigiendo al login...');
    setTimeout(function() {
      window.top.location.href = '<?!= scriptUrl ?>';
    }, 2000);
  }
})();

console.log('%cüéì PBE Control - Panel Estudiante V01.21', 
            'font-size: 16px; font-weight: bold; color: #667eea;');
console.log('%c‚úì currentUser inicializado ANTES de cargar tabs', 
            'font-size: 12px; color: #28a745;');
</script>
<!-- MOD-004: FIN -->

<!-- MOD-005: CIERRE HEAD Y APERTURA BODY [INICIO] -->
</head>
<body>
<!-- MOD-005: FIN -->

<!-- MOD-006: LOADING SCREEN [INICIO] -->
<div class="loading-screen" id="loadingScreen">
  <div class="spinner-large"></div>
  <div class="loading-text">Cargando datos...</div>
</div>
<!-- MOD-006: FIN -->

<!-- MOD-007: NAVBAR [INICIO] -->
<div class="navbar">
  <div class="navbar-brand">
    <h1>PBE Control</h1>
  </div>
  <div class="navbar-user">
    <span class="user-name">
      üë§ <span id="userName">Estudiante</span>
    </span>
    <button class="btn-logout" onclick="logout()">Salir</button>
  </div>
</div>
<!-- MOD-007: FIN -->

<!-- MOD-008: LAYOUT PRINCIPAL [INICIO] -->
<div class="main-layout">
<!-- MOD-008: FIN -->

<!-- MOD-009: TABS SIDEBAR [INICIO] -->
<aside class="tabs-sidebar">
  <div class="tabs-nav">
    <button class="tab-btn active" id="btn-cursosyrep" onclick="switchTab('cursosyrep')">
      üìö Cursos y Repasos
    </button>
    <button class="tab-btn" id="btn-deberes" onclick="switchTab('deberes')">
      üìù Deberes
    </button>
    <button class="tab-btn" id="btn-planning" onclick="switchTab('planning')">
      üìÖ Planning
    </button>
  </div>
</aside>
<!-- MOD-009: FIN -->

<!-- MOD-010: CONTENEDOR TABS [INICIO] -->
<main class="content-container">
  
  <div id="tab-cursosyrep" class="tab-content active">
    <?!= include('4atabcursosyrep'); ?>
  </div>

  <div id="tab-deberes" class="tab-content">
    <?!= include('4btabdeberes'); ?>
  </div>

  <div id="tab-planning" class="tab-content">
    <?!= include('4ctabplanning'); ?>
  </div>

</main>
<!-- MOD-010: FIN -->

<!-- MOD-011: CIERRE LAYOUT [INICIO] -->
</div>
<!-- MOD-011: FIN -->

<!-- MOD-012: JAVASCRIPT - FUNCIONES GLOBALES [INICIO] -->
<script>
// Actualizar UI cuando el DOM est√© listo
window.onload = function() {
  if (currentUser.nombre) {
    document.getElementById('userName').textContent = currentUser.nombre;
  }
  
  console.log('%cVariable global currentUser:', 
              'font-size: 12px; color: #666;', currentUser);
  console.log('%cFunciones globales: showAlert, showLoading, hideLoading, switchTab', 
              'font-size: 12px; color: #666;');
};

// Navegaci√≥n entre Tabs
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(function(tab) {
    tab.classList.remove('active');
  });

  document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.classList.remove('active');
  });

  document.getElementById('tab-' + tabName).classList.add('active');
  document.getElementById('btn-' + tabName).classList.add('active');

  console.log('Tab cambiado a:', tabName);
}

// Sistema de Alertas Global
function showAlert(type, message) {
  const existingAlerts = document.querySelectorAll('.alert');
  existingAlerts.forEach(function(alert) {
    alert.remove();
  });

  const alertBox = document.createElement('div');
  alertBox.className = 'alert alert-' + type;
  alertBox.textContent = message;

  document.body.appendChild(alertBox);

  setTimeout(function() {
    alertBox.remove();
  }, 4000);
}

// Loading Screen
function showLoading() {
  document.getElementById('loadingScreen').classList.add('active');
}

function hideLoading() {
  document.getElementById('loadingScreen').classList.remove('active');
}

// Logout
function logout() {
  if (confirm('¬øDeseas cerrar sesi√≥n?')) {
    sessionStorage.clear();
    window.top.location.href = '<?!= scriptUrl ?>';
  }
}

// Utilidades Globales
function formatFecha(fecha) {
  if (!fecha) return '-';
  
  try {
    const partes = fecha.split('/');
    if (partes.length !== 3) return fecha;
    
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                   'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    const dia = parseInt(partes[0]);
    const mes = parseInt(partes[1]) - 1;
    const anio = partes[2];
    
    return dia + ' ' + meses[mes] + ' ' + anio;
  } catch(error) {
    return fecha;
  }
}

function diasRestantes(fecha) {
  if (!fecha) return null;
  
  try {
    const partes = fecha.split('/');
    const fechaObj = new Date(partes[2], partes[1] - 1, partes[0]);
    const hoy = new Date();
    
    const diff = fechaObj - hoy;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  } catch(error) {
    return null;
  }
}

function validarFecha(fecha) {
  if (!fecha) return false;
  
  const regex = /^\d{2}\/\d{2}\/\d{4}$/;
  if (!regex.test(fecha)) return false;
  
  const partes = fecha.split('/');
  const dia = parseInt(partes[0]);
  const mes = parseInt(partes[1]);
  const anio = parseInt(partes[2]);
  
  if (mes < 1 || mes > 12) return false;
  if (dia < 1 || dia > 31) return false;
  if (anio < 2000 || anio > 2100) return false;
  
  return true;
}
</script>
<!-- MOD-012: FIN -->

<!-- MOD-013: C√ìDIGO DE CIERRE [INICIO] -->
</body>
</html>
<!-- MOD-013: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCI√ìN:
Panel principal del estudiante con sistema de tabs verticales
Contenedor maestro que carga sub-m√≥dulos mediante include()

ESTRUCTURA:
1. Navbar: Logo, nombre estudiante, bot√≥n salir
2. Tabs verticales (3 botones): Cursos y Repasos, Deberes, Planning
3. Contenedores din√°micos con includes de sub-m√≥dulos

TABS INCLUIDOS:
- tab-cursosyrep ‚Üí include('4atabcursosyrep')
- tab-deberes ‚Üí include('4btabdeberes')
- tab-planning ‚Üí include('4ctabplanning')

VARIABLE GLOBAL CR√çTICA:
currentUser = { codeAlum, nombre, email }
- Se inicializa ANTES de los includes (MOD-004)
- Ejecuta IIFE inmediato para cargar datos de sessionStorage
- Disponible para todos los sub-m√≥dulos incluidos

FLUJO DE INICIALIZACI√ìN:
1. MOD-004 ejecuta IIFE que lee sessionStorage
2. Valida existencia y completitud de datos de usuario
3. Asigna datos a currentUser (scope global)
4. Los includes se inyectan y pueden usar currentUser
5. window.onload actualiza UI con nombre de usuario

FUNCIONES GLOBALES DISPONIBLES:
- switchTab(tabName): Navegaci√≥n entre tabs
- showAlert(type, message): Sistema de alertas
- showLoading() / hideLoading(): Pantalla de carga
- logout(): Cerrar sesi√≥n y limpiar sessionStorage
- formatFecha(fecha): Formatear DD/MM/AAAA a texto
- diasRestantes(fecha): Calcular d√≠as hasta fecha
- validarFecha(fecha): Validar formato DD/MM/AAAA

CONEXI√ìN CON BACKEND:
- Los sub-m√≥dulos llaman a funciones student* en 1code.gs
- Todos usan currentUser.codeAlum para identificar al estudiante
- Backend conecta con Student.* en m√≥dulos de l√≥gica

CARACTER√çSTICAS T√âCNICAS:
- Tabs verticales en desktop, horizontales en mobile
- Animaciones de transici√≥n entre tabs
- Sistema de alertas con auto-dismiss
- Loading screen global
- Responsive design completo
- Sticky navbar y tabs sidebar

DEPENDENCIAS:
- sessionStorage: Debe contener 'pbe_user' con datos del login
- 3index.html: Establece sessionStorage al autenticar
- Sub-m√≥dulos: 4atabcursosyrep.html, 4btabdeberes.html, 4ctabplanning.html
- Backend: 1code.gs con wrappers student*

FIX CR√çTICO V01.20 ‚Üí V01.21:
- currentUser se inicializa mediante IIFE en MOD-004
- IIFE se ejecuta ANTES de los includes
- Garantiza que currentUser exista cuando los tabs se carguen
- Elimina race condition donde tabs buscaban currentUser inexistente

CAMBIOS V01.20 ‚Üí V01.21:
- Remodulaci√≥n completa seg√∫n Est√°ndar CodeWorkShop v4.0
- MOD-004 contiene inicializaci√≥n cr√≠tica de currentUser
- CSS encapsulado en MOD-003
- JavaScript principal en MOD-012
- Estructura HTML modularizada
- Comentarios consolidados en MOD-099
-->
<!-- MOD-099: FIN -->
