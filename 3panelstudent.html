<!--
******************************************
PBE CONTROL - 3panelstudent.html - V01.19 CLAUDE
Sistema de Gesti√≥n Acad√©mica
05/01/2026 - Versi√≥n Corregida

CAMBIOS V01.19 CLAUDE:
- CORRECCI√ìN CR√çTICA: currentUser se inicializa ANTES de cargar tabs
- Eliminado window.onload para inicializaci√≥n (ahora usa IIFE inmediato)
- window.onload solo actualiza UI, no inicializa datos
- Esto resuelve la race condition donde los tabs buscaban currentUser antes de que existiera

CAMBIOS V01.18:
- CORRECCI√ìN CR√çTICA: Ahora lee datos reales del usuario desde sessionStorage
- Eliminados datos hardcodeados (TEST01, Jorge Perez)
- Si no hay datos en sessionStorage, muestra error y redirige al login
- Agregado logout que limpia sessionStorage

DESCRIPCI√ìN:
Panel principal del estudiante. Contenedor con 3 tabs
principales que usan include() para cargar sub-m√≥dulos.

ESTRUCTURA:
1. Navbar: Logo, nombre estudiante, bot√≥n salir
2. Tabs principales (3 botones):
   - Cursos y Repasos
   - Deberes
   - Planning
3. Contenedores din√°micos (usan include()):
   - tab-cursosyrep ‚Üí include('4atabcursosyrep')
   - tab-deberes ‚Üí include('4btabdeberes')
   - tab-planning ‚Üí include('4ctabplanning')

VARIABLE GLOBAL:
currentUser = {
  codeAlum: 'TEST05',
  nombre: 'Alumno Test Cinco',
  email: 'test5@pbe.com'
}

üîë CR√çTICO V01.19:
Esta variable se inicializa INMEDIATAMENTE mediante IIFE,
ANTES de que los tabs se carguen. As√≠ los sub-tabs la
encuentran disponible desde el inicio.

CONECTA CON:
- Contenedores: 4atabcursosyrep.html, 4btabdeberes.html, 4ctabplanning.html
- Backend: Todos los wrappers student* en 1code.gs

üîë IMPORTANTE:
- Los datos del usuario se leen desde sessionStorage
- sessionStorage se llena en 3index.html al autenticar
- currentUser es global para todos los tabs
- currentUser se inicializa ANTES de los tabs (V01.19)
******************************************
-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBE Control - Panel Estudiante</title>
  <style>
    /* ==========================================
       RESET Y BASE
       ========================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    /* ==========================================
       NAVBAR
       ========================================== */
    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .navbar-brand h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-name {
      font-size: 15px;
      opacity: 0.95;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-logout {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ==========================================
       LAYOUT PRINCIPAL CON TABS VERTICALES
       ========================================== */
    .main-layout {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
      display: flex;
      gap: 20px;
    }

    /* ==========================================
       TABS VERTICALES (IZQUIERDA)
       ========================================== */
    .tabs-sidebar {
      width: 260px;
      flex-shrink: 0;
    }

    .tabs-nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: sticky;
      top: 100px;
    }

    .tab-btn {
      padding: 20px 25px;
      font-size: 15px;
      font-weight: 600;
      color: #666;
      background: #f5f5f5;
      border: none;
      border-left: 4px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tab-btn:hover {
      background: #e8e8e8;
      color: #333;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-left-color: #4c5fd5;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    /* ==========================================
       CONTENEDOR DE CONTENIDO (DERECHA)
       ========================================== */
    .content-container {
      flex: 1;
      min-width: 0;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ==========================================
       ALERTAS GLOBALES
       ========================================== */
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      max-width: 400px;
      font-size: 14px;
      font-weight: 500;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    /* ==========================================
       LOADING SCREEN
       ========================================== */
    .loading-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .loading-screen.active {
      display: flex;
    }

    .spinner-large {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(102, 126, 234, 0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: #667eea;
      font-weight: 600;
    }

    /* ==========================================
       RESPONSIVE - MOBILE
       ========================================== */
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        position: relative;
      }

      .navbar-brand h1 {
        font-size: 20px;
      }

      .navbar-user {
        flex-direction: column;
        gap: 8px;
      }

      /* Layout mobile: tabs arriba del contenido */
      .main-layout {
        flex-direction: column;
        margin: 20px auto;
        padding: 0 12px;
      }

      .tabs-sidebar {
        width: 100%;
        position: relative;
      }

      .tabs-nav {
        position: relative;
        top: 0;
        flex-direction: row;
        overflow-x: auto;
        gap: 8px;
        padding-bottom: 10px;
      }

      .tab-btn {
        padding: 14px 20px;
        border-left: none;
        border-bottom: 3px solid transparent;
        min-width: max-content;
        justify-content: center;
      }

      .tab-btn.active {
        border-left: none;
        border-bottom-color: #4c5fd5;
      }

      .content-container {
        padding: 0;
      }

      .alert {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <!-- ========================================== -->
  <!-- LOADING SCREEN -->
  <!-- ========================================== -->
  <div class="loading-screen" id="loadingScreen">
    <div class="spinner-large"></div>
    <div class="loading-text">Cargando datos...</div>
  </div>

  <!-- ========================================== -->
  <!-- NAVBAR -->
  <!-- ========================================== -->
  <div class="navbar">
    <div class="navbar-brand">
      <h1>PBE Control</h1>
    </div>
    <div class="navbar-user">
      <span class="user-name">
        üë§ <span id="userName">Estudiante</span>
      </span>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- LAYOUT PRINCIPAL CON TABS VERTICALES -->
  <!-- ========================================== -->
  <div class="main-layout">
    
    <!-- Sidebar con Tabs Verticales -->
    <aside class="tabs-sidebar">
      <div class="tabs-nav">
        <button class="tab-btn active" id="btn-cursosyrep" onclick="switchTab('cursosyrep')">
          üìö Cursos y Repasos
        </button>
        <button class="tab-btn" id="btn-deberes" onclick="switchTab('deberes')">
          üìù Deberes
        </button>
        <button class="tab-btn" id="btn-planning" onclick="switchTab('planning')">
          üìÖ Planning
        </button>
      </div>
    </aside>

    <!-- Contenedor de Contenido -->
    <main class="content-container">
      
      <!-- Tab: Cursos y Repasos -->
      <div id="tab-cursosyrep" class="tab-content active">
        <?!= include('4atabcursosyrep'); ?>
      </div>

      <!-- Tab: Deberes -->
      <div id="tab-deberes" class="tab-content">
        <?!= include('4btabdeberes'); ?>
      </div>

      <!-- Tab: Planning -->
      <div id="tab-planning" class="tab-content">
        <?!= include('4ctabplanning'); ?>
      </div>

    </main>

  </div>

  <!-- ========================================== -->
  <!-- JAVASCRIPT GLOBAL - EJECUTA PRIMERO -->
  <!-- ========================================== -->
  <script>
    // ==========================================
    // VARIABLE GLOBAL - USUARIO ACTUAL
    // ==========================================
    /**
     * CORRECCI√ìN CR√çTICA V01.19 CLAUDE:
     * Esta variable se inicializa ANTES de cargar los tabs.
     * As√≠ los sub-tabs la encuentran disponible desde el inicio.
     * 
     * Esta variable es accesible desde TODOS los tabs
     * mediante include(). Cada sub-tab la usa para
     * filtrar datos del estudiante.
     */
    var currentUser = {
      codeAlum: '',
      nombre: '',
      email: ''
    };

    // ==========================================
    // INICIALIZACI√ìN INMEDIATA
    // ==========================================
    /**
     * CORRECCI√ìN CR√çTICA V01.19 CLAUDE:
     * NO usamos window.onload porque se ejecuta muy tarde.
     * Ejecutamos INMEDIATAMENTE para que currentUser
     * est√© listo ANTES de que los tabs se carguen.
     */
    (function initializeUserImmediate() {
      try {
        // Leer datos del usuario desde sessionStorage
        const userData = sessionStorage.getItem('pbe_user');
        
        if (!userData) {
          // No hay datos de sesi√≥n - redirigir al login
          showAlert('error', 'No se pudo identificar al usuario');
          setTimeout(function() {
            window.top.location.href = '<?!= scriptUrl ?>';
          }, 2000);
          return;
        }
        
        // Parsear datos del usuario
        const user = JSON.parse(userData);
        
        // Validar que tenga los campos necesarios
        if (!user.codeAlum || !user.nombre) {
          showAlert('error', 'Datos de usuario incompletos');
          setTimeout(function() {
            window.top.location.href = '<?!= scriptUrl ?>';
          }, 2000);
          return;
        }
        
        // ==========================================
        // ASIGNAR DATOS REALES A currentUser
        // ESTO OCURRE ANTES DE QUE LOS TABS SE CARGUEN
        // ==========================================
        currentUser.codeAlum = user.codeAlum;
        currentUser.nombre = user.nombre;
        currentUser.email = user.email || '';
        
        console.log('‚úÖ Usuario inicializado correctamente:', currentUser);
        
      } catch(error) {
        console.error('Error al inicializar usuario:', error);
        showAlert('error', 'Error al cargar datos del usuario');
        setTimeout(function() {
          window.top.location.href = '<?!= scriptUrl ?>';
        }, 2000);
      }
    })(); // ‚Üê IIFE: Se ejecuta INMEDIATAMENTE

    // ==========================================
    // ACTUALIZAR UI CUANDO EL DOM EST√â LISTO
    // ==========================================
    /**
     * CORRECCI√ìN V01.19 CLAUDE:
     * currentUser YA est√° inicializado (arriba).
     * Ahora solo actualizamos la UI cuando el DOM est√© listo.
     */
    window.onload = function() {
      // Actualizar nombre en navbar
      if (currentUser.nombre) {
        document.getElementById('userName').textContent = currentUser.nombre;
      }
      
      console.log('%cüéì PBE Control - Panel Estudiante V01.19', 
                  'font-size: 16px; font-weight: bold; color: #667eea;');
      console.log('%cVariable global currentUser:', 
                  'font-size: 12px; color: #666;', currentUser);
      console.log('%cFunciones globales: showAlert, showLoading, hideLoading, switchTab', 
                  'font-size: 12px; color: #666;');
    };

    // ==========================================
    // NAVEGACI√ìN ENTRE TABS
    // ==========================================
    /**
     * Cambiar entre tabs principales
     * 
     * @param {string} tabName - Nombre del tab (cursosyrep, deberes, planning)
     */
    function switchTab(tabName) {
      // Ocultar todos los tabs
      document.querySelectorAll('.tab-content').forEach(function(tab) {
        tab.classList.remove('active');
      });

      // Desactivar todos los botones
      document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.classList.remove('active');
      });

      // Mostrar tab seleccionado
      document.getElementById('tab-' + tabName).classList.add('active');

      // Activar bot√≥n correspondiente
      document.getElementById('btn-' + tabName).classList.add('active');

      console.log('Tab cambiado a:', tabName);
    }

    // ==========================================
    // SISTEMA DE ALERTAS GLOBAL
    // ==========================================
    /**
     * Mostrar alerta temporal
     * 
     * @param {string} type - Tipo: success, error, warning, info
     * @param {string} message - Mensaje a mostrar
     */
    function showAlert(type, message) {
      // Eliminar alertas previas
      const existingAlerts = document.querySelectorAll('.alert');
      existingAlerts.forEach(function(alert) {
        alert.remove();
      });

      // Crear nueva alerta
      const alertBox = document.createElement('div');
      alertBox.className = 'alert alert-' + type;
      alertBox.textContent = message;

      document.body.appendChild(alertBox);

      // Auto-eliminar despu√©s de 4 segundos
      setTimeout(function() {
        alertBox.remove();
      }, 4000);
    }

    // ==========================================
    // LOADING SCREEN
    // ==========================================
    /**
     * Mostrar pantalla de carga
     */
    function showLoading() {
      document.getElementById('loadingScreen').classList.add('active');
    }

    /**
     * Ocultar pantalla de carga
     */
    function hideLoading() {
      document.getElementById('loadingScreen').classList.remove('active');
    }

    // ==========================================
    // LOGOUT
    // ==========================================
    /**
     * Cerrar sesi√≥n y volver al login
     * 
     * V01.18: Ahora limpia sessionStorage correctamente
     */
    function logout() {
      if (confirm('¬øDeseas cerrar sesi√≥n?')) {
        // Limpiar sessionStorage
        sessionStorage.clear();
        
        // Redirigir al login
        window.top.location.href = '<?!= scriptUrl ?>';
      }
    }

    // ==========================================
    // UTILIDADES GLOBALES
    // ==========================================
    
    /**
     * Formatear fecha DD/MM/AAAA a texto legible
     * 
     * @param {string} fecha - Fecha en formato DD/MM/AAAA
     * @return {string} - Fecha formateada
     */
    function formatFecha(fecha) {
      if (!fecha) return '-';
      
      try {
        const partes = fecha.split('/');
        if (partes.length !== 3) return fecha;
        
        const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                       'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        const dia = parseInt(partes[0]);
        const mes = parseInt(partes[1]) - 1;
        const anio = partes[2];
        
        return dia + ' ' + meses[mes] + ' ' + anio;
      } catch(error) {
        return fecha;
      }
    }

    /**
     * Calcular d√≠as restantes hasta una fecha
     * 
     * @param {string} fecha - Fecha en formato DD/MM/AAAA
     * @return {number} - D√≠as restantes
     */
    function diasRestantes(fecha) {
      if (!fecha) return null;
      
      try {
        const partes = fecha.split('/');
        const fechaObj = new Date(partes[2], partes[1] - 1, partes[0]);
        const hoy = new Date();
        
        const diff = fechaObj - hoy;
        return Math.ceil(diff / (1000 * 60 * 60 * 24));
      } catch(error) {
        return null;
      }
    }

    /**
     * Validar formato de fecha DD/MM/AAAA
     * 
     * @param {string} fecha - Fecha a validar
     * @return {boolean} - true si es v√°lida
     */
    function validarFecha(fecha) {
      if (!fecha) return false;
      
      const regex = /^\d{2}\/\d{2}\/\d{4}$/;
      if (!regex.test(fecha)) return false;
      
      const partes = fecha.split('/');
      const dia = parseInt(partes[0]);
      const mes = parseInt(partes[1]);
      const anio = parseInt(partes[2]);
      
      if (mes < 1 || mes > 12) return false;
      if (dia < 1 || dia > 31) return false;
      if (anio < 2000 || anio > 2100) return false;
      
      return true;
    }
  </script>
</body>
</html>
