<!--
******************************************
PBE CONTROL - 7ctabcalendario.html - V01.19 CLAUDE
Sistema de Gesti√≥n Acad√©mica
07/01/2026

CAMBIOS V01.19 CLAUDE:
‚úÖ FIX CR√çTICO: Nombres de campos backend corregidos
‚úÖ FIX CR√çTICO: Retry logic para currentUser (5 intentos, 200ms)
‚úÖ FIX CR√çTICO: Validaci√≥n robusta antes de llamar backend
‚úÖ MEJORA: Logs exhaustivos con prefijo üóìÔ∏è
‚úÖ MEJORA: Error handling mejorado
‚úÖ Compatible con backend V01.25 (fechas DD/MM/AAAA)

CAMPOS CORREGIDOS:
- Evaluaciones: NomEval ‚Üí Evaluacion
- Tareas: Tarea ‚Üí TipoTarea
- Lecturas: Lectura ‚Üí T√≠tulo
- Horario Semanal: Actividad ‚Üí Actividad (OK)

CAMBIOS V01.18 GPT:
- Mantener 100% la funcionalidad de V01.17
- Eliminar variables globales
- Encapsular l√≥gica (SPA-safe)
- Consolidar m√∫ltiples fuentes de datos

OBJETIVO:
Calendario mensual que muestra:
- Evaluaciones (rojo)
- Tareas (amarillo)
- Lecturas (verde)
- Actividades del horario semanal (azul)

FUNCIONALIDAD:
- Navegaci√≥n mes a mes
- Click en d√≠a para ver detalles
- Modal con lista de actividades
- Indicadores visuales por tipo
******************************************
-->

<style>
.calendario-container{max-width:1400px;margin:0 auto;padding:20px}
.calendario-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px 20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;color:#fff}
.calendario-header h2{margin:0;font-size:24px}
.calendario-nav button{background:rgba(255,255,255,.2);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;margin-left:8px}
.calendario-nav button:hover{background:rgba(255,255,255,.3)}
.calendario-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#ddd;border-radius:8px;overflow:hidden}
.calendario-dia-header{background:#f5f5f5;padding:12px;text-align:center;font-weight:600;font-size:14px}
.calendario-celda{background:#fff;min-height:100px;padding:8px;cursor:pointer;position:relative;transition:background 0.2s}
.calendario-celda:hover{background:#f0f0f0}
.calendario-celda.fuera-mes{background:#e0e0e0;color:#999;cursor:default}
.calendario-celda.fuera-mes:hover{background:#e0e0e0}
.calendario-celda.hoy{border:3px solid #667eea;box-shadow:0 0 8px rgba(102,126,234,0.3)}
.calendario-dia-numero{font-weight:700;margin-bottom:6px;font-size:16px}
.calendario-indicadores{display:flex;gap:4px;flex-wrap:wrap}
.calendario-dot{width:8px;height:8px;border-radius:50%}
.calendario-dot.evaluacion{background:#dc3545}
.calendario-dot.tarea{background:#ffc107}
.calendario-dot.lectura{background:#28a745}
.calendario-dot.actividad{background:#17a2b8}

.calendario-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center}
.calendario-modal.active{display:flex}
.calendario-modal-content{background:#fff;border-radius:12px;width:90%;max-width:600px;max-height:80vh;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.2)}
.calendario-modal-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:16px 20px;display:flex;justify-content:space-between;align-items:center}
.calendario-modal-header h3{margin:0;font-size:20px}
.calendario-modal-header button{background:rgba(255,255,255,0.2);border:none;color:#fff;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;line-height:1}
.calendario-modal-header button:hover{background:rgba(255,255,255,0.3)}
.calendario-modal-body{padding:20px;overflow-y:auto;max-height:60vh}
.calendario-actividad-item{padding:12px;margin-bottom:10px;border-left:4px solid #ccc;background:#f8f9fa;border-radius:4px}
.calendario-actividad-item.evaluacion{border-color:#dc3545;background:#fee}
.calendario-actividad-item.tarea{border-color:#ffc107;background:#fff3cd}
.calendario-actividad-item.lectura{border-color:#28a745;background:#d4edda}
.calendario-actividad-item.actividad{border-color:#17a2b8;background:#d1ecf1}
.calendario-actividad-item strong{display:block;margin-bottom:4px;font-size:14px;text-transform:uppercase;letter-spacing:0.5px}
.calendario-actividad-item div{font-size:14px;margin-bottom:2px}

.calendario-loading{text-align:center;padding:40px;display:none}
.calendario-loading.active{display:block}
.calendario-loading .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

.calendario-error{text-align:center;padding:40px;color:#dc3545;display:none}
.calendario-error.active{display:block}
.calendario-error-icon{font-size:48px;margin-bottom:16px}
.calendario-error-text{font-size:16px;font-weight:600;margin-bottom:8px}
.calendario-error-subtext{font-size:14px;color:#999}

@media (max-width: 768px){
  .calendario-header{flex-direction:column;gap:12px}
  .calendario-nav{display:flex;gap:8px}
  .calendario-celda{min-height:80px;padding:6px}
  .calendario-dia-numero{font-size:14px}
  .calendario-modal-content{width:95%;max-width:none}
}
</style>

<div class="calendario-container">
  <div class="calendario-header">
    <h2 id="calTitulo">Calendario</h2>
    <div class="calendario-nav">
      <button onclick="CalendarioModule.nav(-1)">‚Üê Anterior</button>
      <button onclick="CalendarioModule.hoy()">Hoy</button>
      <button onclick="CalendarioModule.nav(1)">Siguiente ‚Üí</button>
    </div>
  </div>

  <div id="calLoading" class="calendario-loading">
    <div class="spinner"></div>
    <div>Cargando calendario...</div>
  </div>

  <div id="calError" class="calendario-error">
    <div class="calendario-error-icon">‚ö†Ô∏è</div>
    <div class="calendario-error-text">Error al cargar el calendario</div>
    <div class="calendario-error-subtext">Por favor, recarga la p√°gina</div>
  </div>

  <div id="calGrid" class="calendario-grid">
    <div class="calendario-dia-header">Lun</div>
    <div class="calendario-dia-header">Mar</div>
    <div class="calendario-dia-header">Mi√©</div>
    <div class="calendario-dia-header">Jue</div>
    <div class="calendario-dia-header">Vie</div>
    <div class="calendario-dia-header">S√°b</div>
    <div class="calendario-dia-header">Dom</div>
  </div>
</div>

<div id="calModal" class="calendario-modal" onclick="CalendarioModule.cerrarSiFondo(event)">
  <div class="calendario-modal-content" onclick="event.stopPropagation()">
    <div class="calendario-modal-header">
      <h3 id="modalTitulo"></h3>
      <button onclick="CalendarioModule.cerrar()">√ó</button>
    </div>
    <div id="modalBody" class="calendario-modal-body"></div>
  </div>
</div>

<script>
(function(){
'use strict';

// Prevenir doble carga
if(window.CalendarioModule && window.CalendarioModule._loaded) {
  console.log('üóìÔ∏è CalendarioModule ya cargado, ignorando');
  return;
}

console.log('üóìÔ∏è CalendarioModule V01.19 CLAUDE iniciando...');

const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

const CalendarioModule = {
  _loaded: true,
  _initDone: false,
  _retryCount: 0,
  m: new Date().getMonth(),
  y: new Date().getFullYear(),
  acts: [],

  // ==========================================
  // V01.19 CLAUDE: INIT CON RETRY LOGIC
  // ==========================================
  init() {
    console.log('üóìÔ∏è CalendarioModule.init() llamado (intento ' + (this._retryCount + 1) + ')');

    if (this._initDone) {
      console.log('üóìÔ∏è CalendarioModule ya inicializado, ignorando');
      return;
    }

    // Validaci√≥n con retry
    if (typeof currentUser === 'undefined' || !currentUser) {
      console.warn('üóìÔ∏è currentUser no disponible a√∫n, reintentando...');
      
      if (this._retryCount < 5) {
        this._retryCount++;
        setTimeout(() => this.init(), 200);
      } else {
        console.error('üóìÔ∏è currentUser no disponible despu√©s de 5 intentos');
        this.mostrarError('Usuario no disponible', 'Recarga la p√°gina');
      }
      return;
    }

    if (!currentUser.codeAlum) {
      console.error('üóìÔ∏è currentUser.codeAlum vac√≠o:', currentUser);
      this.mostrarError('C√≥digo de alumno no disponible', 'Recarga la p√°gina');
      return;
    }

    this._initDone = true;
    console.log('üóìÔ∏è CalendarioModule inicializado para:', currentUser.codeAlum);

    this.load();
  },

  nav(d) { 
    this.m += d; 
    if (this.m > 11) { this.m = 0; this.y++; } 
    if (this.m < 0) { this.m = 11; this.y--; }
    console.log('üóìÔ∏è Navegando a:', MESES[this.m], this.y);
    this.render(); 
  },

  hoy() { 
    const n = new Date(); 
    this.m = n.getMonth(); 
    this.y = n.getFullYear();
    console.log('üóìÔ∏è Volviendo a hoy:', MESES[this.m], this.y);
    this.render(); 
  },

  mostrarError(titulo, subtitulo) {
    const loading = document.getElementById('calLoading');
    const error = document.getElementById('calError');
    const grid = document.getElementById('calGrid');

    if (loading) loading.classList.remove('active');
    if (grid) grid.style.display = 'none';

    if (error) {
      error.classList.add('active');
      const t = error.querySelector('.calendario-error-text');
      const s = error.querySelector('.calendario-error-subtext');
      if (t) t.textContent = titulo || 'Error';
      if (s) s.textContent = subtitulo || 'Por favor, recarga la p√°gina';
    }
  },

  // ==========================================
  // V01.19 CLAUDE: CARGA DE DATOS
  // ==========================================
  load() {
    console.log('üóìÔ∏è Cargando datos del calendario...');
    
    const loading = document.getElementById('calLoading');
    const error = document.getElementById('calError');
    const grid = document.getElementById('calGrid');

    if (loading) loading.classList.add('active');
    if (error) error.classList.remove('active');
    if (grid) grid.style.display = 'none';

    Promise.all([
      this.call('studentObtenerEvaluaciones', 'FechaEval', 'Evaluacion', 'evaluacion', 'Evaluaci√≥n'),
      this.call('studentObtenerTareas', 'FechaEntrega', 'TipoTarea', 'tarea', 'Tarea'),
      this.call('studentObtenerLecturas', 'FechaEval', 'T√≠tulo', 'lectura', 'Lectura'),
      this.call('studentObtenerHorarioSem', 'FechaHS', 'Actividad', 'actividad', 'Actividad')
    ]).then(results => {
      this.acts = results.flat();
      console.log('üóìÔ∏è Total de actividades cargadas:', this.acts.length);
      console.log('üóìÔ∏è Desglose:', {
        evaluaciones: results[0].length,
        tareas: results[1].length,
        lecturas: results[2].length,
        actividades: results[3].length
      });

      if (loading) loading.classList.remove('active');
      if (grid) grid.style.display = 'grid';
      
      this.render();
    }).catch(err => {
      console.error('üóìÔ∏è Error en Promise.all:', err);
      this.mostrarError('Error al cargar datos', 'No se pudieron obtener las actividades');
    });
  },

  // ==========================================
  // V01.19 CLAUDE: LLAMADAS AL BACKEND
  // ==========================================
  call(fn, campoFecha, campoNombre, tipo, tipoNombre) {
    console.log('üóìÔ∏è Llamando a:', fn);
    
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(response => {
          console.log('üóìÔ∏è', fn, 'response:', response);
          
          if (!response) {
            console.error('üóìÔ∏è', fn, 'retorn√≥ NULL');
            resolve([]);
            return;
          }

          if (!response.success) {
            console.error('üóìÔ∏è', fn, 'error:', response.error);
            resolve([]);
            return;
          }

          if (!Array.isArray(response.data)) {
            console.error('üóìÔ∏è', fn, 'data no es array:', response.data);
            resolve([]);
            return;
          }

          const mapped = response.data.map(item => {
            const actividad = {
              tipo: tipo,
              tipoNombre: tipoNombre,
              fecha: item[campoFecha] || '',
              nombre: item[campoNombre] || 'Sin nombre',
              curso: item.Curso || ''
            };

            // Log de ejemplo (solo primer item)
            if (response.data.indexOf(item) === 0) {
              console.log('üóìÔ∏è', fn, 'ejemplo:', actividad);
            }

            return actividad;
          });

          console.log('üóìÔ∏è', fn, 'mapeados:', mapped.length);
          resolve(mapped);
        })
        .withFailureHandler(error => {
          console.error('üóìÔ∏è', fn, 'fall√≥:', error);
          resolve([]);
        })
        [fn]({ codeAlum: currentUser.codeAlum });
    });
  },

  // ==========================================
  // V01.19 CLAUDE: RENDERIZADO
  // ==========================================
  render() {
    console.log('üóìÔ∏è Renderizando calendario:', MESES[this.m], this.y);
    
    document.getElementById('calTitulo').textContent = `${MESES[this.m]} ${this.y}`;
    
    const grid = document.getElementById('calGrid');
    
    // Limpiar celdas anteriores (mantener headers)
    while (grid.children.length > 7) {
      grid.removeChild(grid.lastChild);
    }

    // Calcular d√≠as del mes
    const primerDia = new Date(this.y, this.m, 1);
    const start = (primerDia.getDay() || 7) - 1; // Lunes = 0
    let d = 1 - start;

    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    for (let i = 0; i < 42; i++, d++) {
      const date = new Date(this.y, this.m, d);
      const fueraMes = date.getMonth() !== this.m;
      
      const cell = document.createElement('div');
      cell.className = 'calendario-celda' + (fueraMes ? ' fuera-mes' : '');
      
      // Marcar d√≠a actual
      const cellDate = new Date(date);
      cellDate.setHours(0, 0, 0, 0);
      if (cellDate.getTime() === hoy.getTime()) {
        cell.classList.add('hoy');
      }

      cell.innerHTML = `<div class="calendario-dia-numero">${date.getDate()}</div>`;

      if (!fueraMes) {
        const fechaStr = this.formatearFecha(date);
        const actsDia = this.acts.filter(a => a.fecha === fechaStr);

        if (actsDia.length > 0) {
          const ind = document.createElement('div');
          ind.className = 'calendario-indicadores';
          
          // Tipos √∫nicos
          const tiposUnicos = [...new Set(actsDia.map(a => a.tipo))];
          tiposUnicos.forEach(t => {
            const dot = document.createElement('span');
            dot.className = 'calendario-dot ' + t;
            ind.appendChild(dot);
          });
          
          cell.appendChild(ind);
          cell.onclick = () => this.abrirModal(date, actsDia);
        }
      }
      
      grid.appendChild(cell);
    }

    console.log('üóìÔ∏è Calendario renderizado con 42 celdas');
  },

  // ==========================================
  // MODAL
  // ==========================================
  abrirModal(fecha, actividades) {
    console.log('üóìÔ∏è Abriendo modal para:', this.formatearFecha(fecha), 'con', actividades.length, 'actividades');
    
    document.getElementById('modalTitulo').textContent = 
      `${fecha.getDate()} de ${MESES[fecha.getMonth()]} ${this.y}`;
    
    const body = document.getElementById('modalBody');
    body.innerHTML = actividades.map(a => `
      <div class="calendario-actividad-item ${a.tipo}">
        <strong>${a.tipoNombre}</strong>
        <div>${a.nombre}</div>
        ${a.curso ? `<div>Curso: ${a.curso}</div>` : ''}
      </div>
    `).join('');
    
    document.getElementById('calModal').classList.add('active');
  },

  cerrar() {
    console.log('üóìÔ∏è Cerrando modal');
    document.getElementById('calModal').classList.remove('active');
  },

  cerrarSiFondo(event) {
    if (event.target.id === 'calModal') {
      this.cerrar();
    }
  },

  // ==========================================
  // HELPERS
  // ==========================================
  formatearFecha(date) {
    const dia = String(date.getDate()).padStart(2, '0');
    const mes = String(date.getMonth() + 1).padStart(2, '0');
    const anio = date.getFullYear();
    return `${dia}/${mes}/${anio}`;
  }
};

// Exponer globalmente
window.CalendarioModule = CalendarioModule;

// ==========================================
// V01.19 CLAUDE: AUTO-INIT CON RETRY
// ==========================================
setTimeout(() => {
  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    console.log('üóìÔ∏è currentUser detectado, auto-inicializando...');
    CalendarioModule.init();
  } else {
    console.log('üóìÔ∏è currentUser no disponible, iniciando retry logic...');
    CalendarioModule.init();
  }
}, 150);

console.log('%cüóìÔ∏è CalendarioModule V01.19 CLAUDE cargado', 'font-size:11px;color:#667eea;font-weight:bold');

})();
</script>
