<!--
******************************************
PBE CONTROL - 7ctabcalendario.html - V01.18 GPT
Sistema de Gestión Académica
07/01/2026

OBJETIVO V01.18
- Mantener 100% la funcionalidad de V01.17
- Eliminar variables globales
- Encapsular lógica (SPA-safe)
- Consolidar múltiples fuentes de datos
******************************************
-->

<style>
.calendario-container{max-width:1400px;margin:0 auto;padding:20px}
.calendario-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px 20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;color:#fff}
.calendario-header h2{margin:0;font-size:24px}
.calendario-nav button{background:rgba(255,255,255,.2);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer}
.calendario-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#ddd;border-radius:8px;overflow:hidden}
.calendario-dia-header{background:#f5f5f5;padding:12px;text-align:center;font-weight:600}
.calendario-celda{background:#fff;min-height:100px;padding:8px;cursor:pointer;position:relative}
.calendario-celda.fuera-mes{background:#e0e0e0;cursor:default}
.calendario-celda.hoy{border:3px solid #667eea}
.calendario-dia-numero{font-weight:700;margin-bottom:6px}
.calendario-indicadores{display:flex;gap:4px;flex-wrap:wrap}
.calendario-dot{width:8px;height:8px;border-radius:50%}
.calendario-dot.evaluacion{background:#dc3545}
.calendario-dot.tarea{background:#ffc107}
.calendario-dot.lectura{background:#28a745}
.calendario-dot.actividad{background:#17a2b8}

.calendario-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center}
.calendario-modal.active{display:flex}
.calendario-modal-content{background:#fff;border-radius:12px;width:90%;max-width:600px;max-height:80vh;overflow:hidden}
.calendario-modal-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:16px;display:flex;justify-content:space-between}
.calendario-modal-body{padding:20px;overflow-y:auto}
.calendario-actividad-item{padding:12px;margin-bottom:10px;border-left:4px solid #ccc;background:#f8f9fa}
.calendario-actividad-item.evaluacion{border-color:#dc3545}
.calendario-actividad-item.tarea{border-color:#ffc107}
.calendario-actividad-item.lectura{border-color:#28a745}
.calendario-actividad-item.actividad{border-color:#17a2b8}
.calendario-loading{text-align:center;padding:40px;display:none}
.calendario-loading.active{display:block}
</style>

<div class="calendario-container">
  <div class="calendario-header">
    <h2 id="calTitulo">Mes</h2>
    <div class="calendario-nav">
      <button onclick="CalendarioModule.nav(-1)">← Anterior</button>
      <button onclick="CalendarioModule.hoy()">Hoy</button>
      <button onclick="CalendarioModule.nav(1)">Siguiente →</button>
    </div>
  </div>

  <div id="calLoading" class="calendario-loading">Cargando calendario…</div>

  <div id="calGrid" class="calendario-grid">
    <div class="calendario-dia-header">Lun</div>
    <div class="calendario-dia-header">Mar</div>
    <div class="calendario-dia-header">Mié</div>
    <div class="calendario-dia-header">Jue</div>
    <div class="calendario-dia-header">Vie</div>
    <div class="calendario-dia-header">Sáb</div>
    <div class="calendario-dia-header">Dom</div>
  </div>
</div>

<div id="calModal" class="calendario-modal">
  <div class="calendario-modal-content">
    <div class="calendario-modal-header">
      <h3 id="modalTitulo"></h3>
      <button onclick="CalendarioModule.cerrar()">×</button>
    </div>
    <div id="modalBody" class="calendario-modal-body"></div>
  </div>
</div>

<script>
(function(){
'use strict';
if(window.CalendarioModule) return;

const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

const CalendarioModule={
  m:new Date().getMonth(),
  y:new Date().getFullYear(),
  acts:[],

  init(){
    this.load();
  },

  nav(d){ this.m+=d; if(this.m>11){this.m=0;this.y++;} if(this.m<0){this.m=11;this.y--;} this.render(); },
  hoy(){ const n=new Date(); this.m=n.getMonth(); this.y=n.getFullYear(); this.render(); },

  load(){
    document.getElementById('calLoading').classList.add('active');
    Promise.all([
      this.call('studentObtenerEvaluaciones','FechaEval','NomEval','evaluacion','Evaluación'),
      this.call('studentObtenerTareas','FechaEntrega','Tarea','tarea','Tarea'),
      this.call('studentObtenerLecturas','FechaEval','Lectura','lectura','Lectura'),
      this.call('studentObtenerHorarioSem','FechaHS','Actividad','actividad','Actividad')
    ]).then(r=>{
      this.acts=r.flat();
      this.render();
      document.getElementById('calLoading').classList.remove('active');
    });
  },

  call(fn,f,n,t,tn){
    return new Promise(res=>{
      google.script.run.withSuccessHandler(r=>{
        if(!r.success) return res([]);
        res(r.data.map(i=>({tipo:t,tipoNombre:tn,fecha:i[f],nombre:i[n],curso:i.Curso||''})));
      })[fn]({codeAlum:currentUser.codeAlum});
    });
  },

  render(){
    document.getElementById('calTitulo').textContent=`${MESES[this.m]} ${this.y}`;
    const grid=document.getElementById('calGrid');
    while(grid.children.length>7) grid.removeChild(grid.lastChild);

    const start=(new Date(this.y,this.m,1).getDay()||7)-1;
    let d=1-start;
    for(let i=0;i<42;i++,d++){
      const date=new Date(this.y,this.m,d);
      const out=date.getMonth()!==this.m;
      const cell=document.createElement('div');
      cell.className='calendario-celda'+(out?' fuera-mes':'');
      cell.innerHTML=`<div class="calendario-dia-numero">${date.getDate()}</div>`;

      if(!out){
        const f=this.f(date);
        const acts=this.acts.filter(a=>a.fecha===f);
        if(acts.length){
          const ind=document.createElement('div');
          ind.className='calendario-indicadores';
          [...new Set(acts.map(a=>a.tipo))].forEach(t=>{
            ind.innerHTML+=`<span class="calendario-dot ${t}"></span>`;
          });
          cell.appendChild(ind);
          cell.onclick=()=>this.open(date,acts);
        }
      }
      grid.appendChild(cell);
    }
  },

  open(d,acts){
    document.getElementById('modalTitulo').textContent=`${d.getDate()} de ${MESES[d.getMonth()]} ${this.y}`;
    const b=document.getElementById('modalBody');
    b.innerHTML=acts.map(a=>`
      <div class="calendario-actividad-item ${a.tipo}">
        <div><strong>${a.tipoNombre}</strong></div>
        <div>${a.nombre}</div>
        ${a.curso?`<div>Curso: ${a.curso}</div>`:''}
      </div>`).join('');
    document.getElementById('calModal').classList.add('active');
  },

  cerrar(){ document.getElementById('calModal').classList.remove('active'); },

  f(d){ return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
};

window.CalendarioModule=CalendarioModule;
CalendarioModule.init();
})();
</script>
