// ============================================
// SOLID CODE - PBECONTROL
// Generado: 25/1/2026, 11:04:59 a. m.
// Total de archivos: 24
// ============================================



// ============================================
// ARCHIVO 1/24: 1admin.gs
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/1admin.gs
// ============================================

// MOD-001: ENCABEZADO [INICIO]
/*
*****************************************
PROYECTO: PBE Control
ARCHIVO: 1admin.gs
VERSIÓN: 01.19
FECHA: 18/01/2026 14:40 (UTC-5)
*****************************************
*/
// MOD-001: FIN

// MOD-002: MÓDULO ADMIN - DECLARACIÓN [INICIO]
var Admin = (function() {
// MOD-002: FIN

// MOD-003: CREAR ALUMNO [INICIO]
/**
 * Crear un alumno nuevo
 * Valida unicidad de CodeAlum y Clave
 * Agrega a hojas Alumnos y Clientes
 */
function crearAlumno(params) {
  try {
    // Validación 1: Unicidad de CodeAlum
    var existeCode = DB.buscar('Alumnos', 'CodeAlum', params.codeAlum);
    if (existeCode.success) {
      return {
        success: false,
        error: 'CodeAlum ya existe. Usa otro código'
      };
    }
    
    // Validación 2: Unicidad de Clave
    var existeClave = DB.buscar('Alumnos', 'Clave', params.clave);
    if (existeClave.success) {
      return {
        success: false,
        error: 'Clave ya existe. Usa otra clave'
      };
    }
    
    // Crear en hoja Alumnos
    var alumno = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      Clave: params.clave,
      Apellidos: params.apellidos,
      Nombres: params.nombres,
      DNI: params.dni || '',
      FechaNac: params.fechaNac || '',
      TipoInsti: params.tipoInsti || '',
      NomInsti: params.nomInsti || '',
      Ciclo: params.ciclo || '',
      Fono: params.fono || '',
      Email: params.email || ''
    };
    
    var resultAlumno = DB.agregar('Alumnos', alumno);
    
    if (!resultAlumno.success) {
      return resultAlumno;
    }
    
    // Crear en hoja Clientes
    var cliente = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      País: params.pais || '',
      Ciudad: params.ciudad || '',
      Distrito: params.distrito || '',
      Madre: params.madre || '',
      FonoMadre: params.fonoMadre || '',
      Padre: params.padre || '',
      FonoPadre: params.fonoPadre || '',
      EmailPadres: params.emailPadres || '',
      EstadoCliente: 'Activo',
      Detalle: ''
    };
    
    var resultCliente = DB.agregar('Clientes', cliente);
    
    if (!resultCliente.success) {
      return resultCliente;
    }
    
    return {
      success: true,
      message: 'Alumno creado exitosamente: ' + params.codeAlum
    };
    
  } catch(error) {
    Logger.log('Error en Admin.crearAlumno(): ' + error.toString());
    return { 
      success: false, 
      error: 'Error al crear alumno. Intenta nuevamente' 
    };
  }
}
// MOD-003: FIN

// MOD-004: BUSCAR ALUMNO [INICIO]
/**
 * Buscar alumnos por múltiples criterios
 * Busca en: CodeAlum, Nombres, Apellidos, DNI
 * Búsqueda case-insensitive
 */
function buscarAlumno(params) {
  try {
    var sheet = SHEET.Alumnos;
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    var filtro = params.filtro ? params.filtro.toLowerCase().trim() : '';
    
    if (!filtro) {
      var todosAlumnos = [];
      for (var i = 1; i < data.length; i++) {
        var obj = {};
        for (var j = 0; j < headers.length; j++) {
          obj[headers[j]] = data[i][j];
        }
        obj._rowNumber = i + 1;
        todosAlumnos.push(obj);
      }
      return { success: true, data: todosAlumnos };
    }
    
    var results = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      var codeAlum = String(row[1]).toLowerCase().trim();
      var apellidos = String(row[3]).toLowerCase().trim();
      var nombres = String(row[4]).toLowerCase().trim();
      var dni = String(row[5]).toLowerCase().trim();
      
      if (codeAlum.indexOf(filtro) !== -1 ||
          nombres.indexOf(filtro) !== -1 ||
          apellidos.indexOf(filtro) !== -1 ||
          dni.indexOf(filtro) !== -1) {
        
        var obj = {};
        for (var j = 0; j < headers.length; j++) {
          obj[headers[j]] = row[j];
        }
        obj._rowNumber = i + 1;
        results.push(obj);
      }
    }
    
    return { success: true, data: results };
    
  } catch(error) {
    Logger.log('Error en Admin.buscarAlumno(): ' + error.toString());
    return { 
      success: false, 
      error: 'Error al buscar alumnos' 
    };
  }
}
// MOD-004: FIN

// MOD-005: ELIMINAR ALUMNO [INICIO]
/**
 * Eliminar alumno de TODAS las hojas del sistema
 * Elimina de 9 hojas diferentes
 */
function eliminarAlumno(params) {
  try {
    var codeAlum = params.codeAlum;
    
    if (!codeAlum) {
      return {
        success: false,
        error: 'Falta el código del alumno'
      };
    }
    
    var hojas = [
      'Alumnos',
      'Clientes',
      'Cursos',
      'Repasos',
      'Eval',
      'Tareas',
      'Lecturas',
      'HorarioClases',
      'HorarioSem'
    ];
    
    var eliminados = 0;
    var errores = [];
    
    hojas.forEach(function(nombreHoja) {
      var result = DB.eliminarPorAlumno(nombreHoja, codeAlum);
      
      if (result.success) {
        eliminados += result.eliminados || 0;
      } else {
        errores.push(nombreHoja + ': ' + result.error);
      }
    });
    
    if (errores.length > 0) {
      Logger.log('Errores al eliminar alumno: ' + errores.join(', '));
      return {
        success: true,
        message: 'Alumno eliminado. Registros borrados: ' + eliminados + '. Algunos errores: ' + errores.length
      };
    }
    
    return {
      success: true,
      message: 'Alumno eliminado completamente. Registros borrados: ' + eliminados
    };
    
  } catch(error) {
    Logger.log('Error en Admin.eliminarAlumno(): ' + error.toString());
    return { 
      success: false, 
      error: 'Error al eliminar alumno. Intenta nuevamente' 
    };
  }
}
// MOD-005: FIN

// MOD-006: EXPORTAR FUNCIONES PÚBLICAS [INICIO]
return {
  crearAlumno: crearAlumno,
  buscarAlumno: buscarAlumno,
  eliminarAlumno: eliminarAlumno
};
// MOD-006: FIN

// MOD-007: CIERRE MÓDULO ADMIN [INICIO]
})();
// MOD-007: FIN

// MOD-008: CÓDIGO DE CIERRE [INICIO]
Logger.log('✅ 1admin.gs v01.19 cargado');
// MOD-008: FIN

// MOD-099: NOTAS [INICIO]
/*
DESCRIPCIÓN:
Sistema de Gestión Académica - Módulo Administrador
Lógica de negocio para gestión de alumnos

FUNCIONES PÚBLICAS:
- crearAlumno: Crear alumno nuevo con validaciones de unicidad
- buscarAlumno: Buscar alumnos por múltiples criterios
- eliminarAlumno: Eliminar alumno de todas las hojas del sistema

DEPENDENCIAS:
- DB: Módulo de acceso a base de datos
- Utils: Funciones utilitarias (fechaHoy)
- SHEET: Objeto global con referencias a hojas

VALIDACIONES CRÍTICAS:
- crearAlumno valida que CodeAlum sea único
- crearAlumno valida que Clave sea única
- crearAlumno crea en 2 hojas: Alumnos y Clientes
- eliminarAlumno elimina de 9 hojas diferentes

HOJAS AFECTADAS POR ELIMINACIÓN:
Alumnos, Clientes, Cursos, Repasos, Eval, Tareas, Lecturas, HorarioClases, HorarioSem

ADVERTENCIAS:
- NUNCA acceder a SHEET directamente, SIEMPRE usar DB
- Mensajes de error corregidos en v01.18 para tests
- eliminarAlumno borra de TODAS las hojas relacionadas

CAMBIOS V01.18 → V01.19:
- Remodulación completa según Estándar CodeWorkShop v4.0
- Comentarios excesivos movidos a MOD-099
- Estructura modular clara y ordenada
*/
// MOD-099: FIN


// ============================================
// ARCHIVO 2/24: 1code.gs
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/1code.gs
// ============================================

// MOD-001: ENCABEZADO [INICIO]
/*
******************************************
PROYECTO: PBE Control
ARCHIVO: 1code.gs
VERSIÓN: 01.29
FECHA: 24/01/2026 20:30 (UTC-5)
******************************************
*/
// MOD-001: FIN

// MOD-002: ROUTER PRINCIPAL [INICIO]
function doGet(e) {
  var page = e.parameter.page;
  var scriptUrl = ScriptApp.getService().getUrl(); 
  
  if (page === 'student') {
    var template = HtmlService.createTemplateFromFile('3panelstudent');
    template.scriptUrl = scriptUrl; 
    return template.evaluate()
      .setTitle('PBE Control - Panel Estudiante')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
  }
  
  if (page === 'admin') {
    var template = HtmlService.createTemplateFromFile('3paneladmin');
    template.scriptUrl = scriptUrl;
    return template.evaluate()
      .setTitle('PBE Control - Panel Admin')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
  }
  
  var template = HtmlService.createTemplateFromFile('3index');
  template.scriptUrl = scriptUrl; 
  
  return template.evaluate()
    .setTitle('PBE Control - Acceso')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}
// MOD-002: FIN

// MOD-003: INCLUDE DINÁMICO [INICIO]
function include(filename) {
  var template = HtmlService.createTemplateFromFile(filename);
  return template.evaluate().getContent();
}
// MOD-003: FIN

// MOD-004: AUTENTICACIÓN [INICIO]
function autenticar(params) {
  try {
    var clave = params.clave;
    if (!clave) return { success: false, error: 'Ingresa tu clave de acceso' };
    
    var admin = DB.buscar('Admin', 'User', clave);
    if (admin.success) {
      return { 
        success: true, 
        user: { 
          type: 'admin',
          nombre: admin.data.Nombre,
          user: admin.data.User
        }
      };
    }
    
    var alumno = DB.buscar('Alumnos', 'Clave', clave);
    if (alumno.success) {
      return { 
        success: true, 
        user: { 
          type: 'student',
          codeAlum: alumno.data.CodeAlum,
          nombre: alumno.data.Nombres + ' ' + alumno.data.Apellidos,
          email: alumno.data.Email
        }
      };
    }
    
    return { success: false, error: 'Clave no encontrada' };
  } catch(error) {
    Logger.log('Error en autenticar(): ' + error.toString());
    return { success: false, error: 'Error de servidor' };
  }
}
// MOD-004: FIN

// MOD-005: LIMPIEZA DE DATOS [INICIO]
function cleanDataForSerialization(result) {
  if (!result || !result.success || !result.data) {
    return result;
  }
  
  if (Array.isArray(result.data)) {
    result.data = result.data.map(function(item) {
      return cleanObject(item);
    });
  } else {
    result.data = cleanObject(result.data);
  }
  
  return result;
}

function formatearFechaDD_MM_AAAA(fecha) {
  if (!fecha || !(fecha instanceof Date)) {
    return '';
  }
  
  var dia = fecha.getDate();
  var mes = fecha.getMonth() + 1;
  var anio = fecha.getFullYear();
  
  dia = dia < 10 ? '0' + dia : dia;
  mes = mes < 10 ? '0' + mes : mes;
  
  return dia + '/' + mes + '/' + anio;
}

function isTimeValue(value) {
  if (!(value instanceof Date)) {
    return false;
  }
  
  var year = value.getFullYear();
  return (year === 1899 || year === 1900);
}

function formatearTimeHH_MM(timeValue) {
  if (!(timeValue instanceof Date)) {
    return '';
  }
  
  try {
    var horas = timeValue.getHours();
    var minutos = timeValue.getMinutes();
    
    horas = horas < 10 ? '0' + horas : horas;
    minutos = minutos < 10 ? '0' + minutos : minutos;
    
    return horas + ':' + minutos;
  } catch(e) {
    Logger.log('Error formateando time: ' + e.toString());
    return '';
  }
}

function cleanObject(obj) {
  var cleaned = {};
  
  for (var key in obj) {
    if (obj.hasOwnProperty(key)) {
      var value = obj[key];
      
      if (value instanceof Date && isTimeValue(value)) {
        cleaned[key] = formatearTimeHH_MM(value);
      }
      else if (value instanceof Date) {
        cleaned[key] = formatearFechaDD_MM_AAAA(value);
      } 
      else if (value === null || value === undefined) {
        cleaned[key] = '';
      }
      else {
        cleaned[key] = value;
      }
    }
  }
  
  return cleaned;
}
// MOD-005: FIN

// MOD-006: WRAPPERS CURSOS [INICIO]
function studentObtenerCursos(params) { 
  var result = Student.obtenerCursos(params);
  return cleanDataForSerialization(result);
}

function studentAgregarCurso(params) { 
  var result = Student.agregarCurso(params);
  return cleanDataForSerialization(result);
}

function studentActualizarCurso(params) { 
  var result = Student.actualizarCurso(params);
  return cleanDataForSerialization(result);
}

function studentEliminarCurso(params) { 
  var result = Student.eliminarCurso(params);
  return cleanDataForSerialization(result);
}
// MOD-006: FIN

// MOD-007: WRAPPERS REPASOS [INICIO]
function studentObtenerRepasos(params) { 
  var result = Student.obtenerRepasos(params);
  return cleanDataForSerialization(result);
}

function studentAgregarRepaso(params) { 
  var result = Student.agregarRepaso(params);
  return cleanDataForSerialization(result);
}

function studentActualizarRepaso(params) { 
  var result = Student.actualizarRepaso(params);
  return cleanDataForSerialization(result);
}

function studentEliminarRepaso(params) { 
  var result = Student.eliminarRepaso(params);
  return cleanDataForSerialization(result);
}
// MOD-007: FIN

// MOD-008: WRAPPERS EVALUACIONES [INICIO]
function studentObtenerEvaluaciones(params) { 
  var result = Student.obtenerEvaluaciones(params);
  return cleanDataForSerialization(result);
}

function studentAgregarEvaluacion(params) { 
  var result = Student.agregarEvaluacion(params);
  return cleanDataForSerialization(result);
}

function studentActualizarEvaluacion(params) { 
  var result = Student.actualizarEvaluacion(params);
  return cleanDataForSerialization(result);
}

function studentEliminarEvaluacion(params) { 
  var result = Student.eliminarEvaluacion(params);
  return cleanDataForSerialization(result);
}
// MOD-008: FIN

// MOD-009: WRAPPERS TAREAS [INICIO]
function studentObtenerTareas(params) { 
  var result = Student.obtenerTareas(params);
  return cleanDataForSerialization(result);
}

function studentAgregarTarea(params) { 
  var result = Student.agregarTarea(params);
  return cleanDataForSerialization(result);
}

function studentActualizarTarea(params) { 
  var result = Student.actualizarTarea(params);
  return cleanDataForSerialization(result);
}

function studentEliminarTarea(params) { 
  var result = Student.eliminarTarea(params);
  return cleanDataForSerialization(result);
}
// MOD-009: FIN

// MOD-010: WRAPPERS LECTURAS [INICIO]
function studentObtenerLecturas(params) { 
  var result = Student.obtenerLecturas(params);
  return cleanDataForSerialization(result);
}

function studentAgregarLectura(params) { 
  var result = Student.agregarLectura(params);
  return cleanDataForSerialization(result);
}

function studentActualizarLectura(params) { 
  var result = Student.actualizarLectura(params);
  return cleanDataForSerialization(result);
}

function studentEliminarLectura(params) { 
  var result = Student.eliminarLectura(params);
  return cleanDataForSerialization(result);
}
// MOD-010: FIN

// MOD-011: WRAPPERS HORARIO CLASES [INICIO]
function studentObtenerHorarioClases(params) { 
  var result = Student.obtenerHorarioClases(params);
  return cleanDataForSerialization(result);
}

function studentAgregarHorarioClase(params) { 
  var result = Student.agregarHorarioClase(params);
  return cleanDataForSerialization(result);
}

function studentActualizarHorarioClase(params) { 
  var result = Student.actualizarHorarioClase(params);
  return cleanDataForSerialization(result);
}

function studentEliminarHorarioClase(params) { 
  var result = Student.eliminarHorarioClase(params);
  return cleanDataForSerialization(result);
}
// MOD-011: FIN

// MOD-012: WRAPPERS HORARIO SEMANAL [INICIO]
function studentObtenerHorarioSem(params) { 
  var result = Student.obtenerHorarioSem(params);
  return cleanDataForSerialization(result);
}

function studentAgregarHorarioSem(params) { 
  var result = Student.agregarHorarioSem(params);
  return cleanDataForSerialization(result);
}

function studentActualizarHorarioSem(params) { 
  var result = Student.actualizarHorarioSem(params);
  return cleanDataForSerialization(result);
}

function studentEliminarHorarioSem(params) { 
  var result = Student.eliminarHorarioSem(params);
  return cleanDataForSerialization(result);
}
// MOD-012: FIN

// MOD-013: WRAPPERS CONFIG SEMANAS [INICIO]
function studentObtenerConfigSemana(params) {
  var result = Student.obtenerConfigSemana(params);
  return cleanDataForSerialization(result);
}

function studentGuardarConfigSemana(params) {
  var result = Student.guardarConfigSemana(params);
  return cleanDataForSerialization(result);
}

function studentCopiarSemana(params) {
  var result = Student.copiarSemana(params);
  return cleanDataForSerialization(result);
}

function studentLimpiarSemana(params) {
  var result = Student.limpiarSemana(params);
  return cleanDataForSerialization(result);
}
// MOD-013: FIN

// MOD-014: WRAPPERS GESTIÓN SEMANAS V2 [INICIO]
function studentObtenerSemanas(codeAlum) {
  var result = Student.obtenerSemanas(codeAlum);
  return cleanDataForSerialization(result);
}

function studentCrearSemana(params) {
  var result = Student.crearSemana(params);
  return cleanDataForSerialization(result);
}

function studentEliminarSemana(params) {
  var result = Student.eliminarSemana(params);
  return cleanDataForSerialization(result);
}
// MOD-014: FIN

// MOD-015: WRAPPERS NOTAS [INICIO]
function studentObtenerNotasPorCurso(params) { 
  var result = Student.obtenerNotasPorCurso(params);
  return cleanDataForSerialization(result);
}

function studentObtenerResumenNotas(params) { 
  var result = Student.obtenerResumenNotas(params);
  return cleanDataForSerialization(result);
}
// MOD-015: FIN

// MOD-016: WRAPPERS DEBERES [INICIO]
function studentObtenerTodosDeberes(params) { 
  var result = Student.obtenerTodosDeberes(params);
  return cleanDataForSerialization(result);
}

function studentObtenerDeberesPorTipo(params) { 
  var result = Student.obtenerDeberesPorTipo(params);
  return cleanDataForSerialization(result);
}
// MOD-016: FIN

// MOD-017: WRAPPERS ADMIN [INICIO]
function adminCrearAlumno(params) { 
  return Admin.crearAlumno(params); 
}

function adminBuscarAlumno(params) { 
  return Admin.buscarAlumno(params); 
}

function adminEliminarAlumno(params) { 
  return Admin.eliminarAlumno(params); 
}
// MOD-017: FIN

// MOD-018: NOTAS [INICIO]
/*
CAMBIOS V01.28 CLAUDE+ fix mod coment:
- Se corrigió etiquetado de comentarios para identificar los MOD el 17/01/2026
✅ Agregado MOD-014: Gestión Semanas (3 wrappers)
  - studentObtenerSemanas()
  - studentCrearSemana()
  - studentEliminarSemana()
✅ Soporte completo para hoja Semanas
✅ Total: 38 wrappers Student + 3 Admin = 41 wrappers

MÓDULOS:
MOD-001: Encabezado
MOD-002: Router Principal (1 función)
MOD-003: Include dinámico (1 función)
MOD-004: Autenticación (1 función)
MOD-005: Limpieza de datos (5 funciones)
MOD-006: Wrappers Cursos (4)
MOD-007: Wrappers Repasos (4)
MOD-008: Wrappers Evaluaciones (4)
MOD-009: Wrappers Tareas (4)
MOD-010: Wrappers Lecturas (4)
MOD-011: Wrappers HorarioClases (4)
MOD-012: Wrappers HorarioSem (4)
MOD-013: Wrappers Config Semanas (4)
MOD-014: Wrappers Gestión Semanas (3) ← NUEVO V01.28
MOD-015: Wrappers Notas (2)
MOD-016: Wrappers Deberes (2)
MOD-017: Wrappers Admin (3)
MOD-018: Notas

TOTAL FUNCIONES: 49
- Router y utilidades: 8
- Wrappers Student: 38
- Wrappers Admin: 3

LIMPIEZA AUTOMÁTICA:
Todos los wrappers Student aplican cleanDataForSerialization():
1. Detecta time objects (años 1899/1900)
2. Formatea times como "HH:MM"
3. Formatea fechas como "DD/MM/AAAA"
4. Convierte null/undefined a string vacío

ADVERTENCIAS CRÍTICAS:
● MOD-005: isTimeValue() procesa times ANTES de fechas
● MOD-014: obtenerSemanas() recibe codeAlum directo, no params completo
*/
// MOD-018: FIN


// ============================================
// ARCHIVO 3/24: 1db.gs
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/1db.gs
// ============================================

// MOD-001: ENCABEZADO [INICIO]
/*
*****************************************
PROYECTO: PBE Control
ARCHIVO: 1db.gs
VERSIÓN: 01.14
FECHA: 18/01/2026 14:48 (UTC-5)
*****************************************
*/
// MOD-001: FIN

// MOD-002: CONFIGURACIÓN GLOBAL - SPREADSHEET [INICIO]
var SS = SpreadsheetApp.openById('13bAsdOddT0INxXwjPQAsvlQg3xm-KMZnpTchzbwUw6s');
// MOD-002: FIN

// MOD-003: CONFIGURACIÓN GLOBAL - HOJAS [INICIO]
var SHEET = {
  Alumnos: SS.getSheetByName('Alumnos'),
  Clientes: SS.getSheetByName('Clientes'),
  Cursos: SS.getSheetByName('Cursos'),
  Repasos: SS.getSheetByName('Repasos'),
  Eval: SS.getSheetByName('Eval'),
  Tareas: SS.getSheetByName('Tareas'),
  Lecturas: SS.getSheetByName('Lecturas'),
  HorarioClases: SS.getSheetByName('HorarioClases'),
  HorarioSem: SS.getSheetByName('HorarioSem'),
  Opciones: SS.getSheetByName('Opciones'),
  Admin: SS.getSheetByName('Admin')
};
// MOD-003: FIN

// MOD-004: MÓDULO DB - DECLARACIÓN [INICIO]
var DB = (function() {
// MOD-004: FIN

// MOD-005: BUSCAR REGISTRO [INICIO]
/**
 * Buscar un registro en una hoja específica
 * Búsqueda case-insensitive por diseño
 */
function buscar(sheetName, columnName, value) {
  try {
    var sheet = SHEET[sheetName];
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: ' + sheetName };
    }
    
    var data = sheet.getDataRange().getValues();
    if (data.length === 0) {
      return { success: false, error: 'Hoja vacía' };
    }
    
    var headers = data[0];
    var colIndex = headers.indexOf(columnName);
    
    if (colIndex === -1) {
      return { success: false, error: 'Columna no encontrada: ' + columnName };
    }
    
    var valueLower = String(value).trim().toLowerCase();
    
    for (var i = 1; i < data.length; i++) {
      var cellValue = String(data[i][colIndex]).trim().toLowerCase();
      
      if (cellValue === valueLower) {
        var obj = {};
        for (var j = 0; j < headers.length; j++) {
          obj[headers[j]] = data[i][j];
        }
        obj._rowNumber = i + 1;
        return { success: true, data: obj };
      }
    }
    
    return { success: false, error: 'No se encontró: ' + value };
    
  } catch(error) {
    Logger.log('Error en DB.buscar(): ' + error.toString());
    return { success: false, error: 'Error al buscar registro' };
  }
}
// MOD-005: FIN

// MOD-006: AGREGAR REGISTRO [INICIO]
/**
 * Agregar un nuevo registro a una hoja
 */
function agregar(sheetName, obj) {
  try {
    var sheet = SHEET[sheetName];
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: ' + sheetName };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    var newRow = [];
    for (var i = 0; i < headers.length; i++) {
      newRow.push(obj[headers[i]] || '');
    }
    
    sheet.appendRow(newRow);
    
    return { success: true, message: 'Registro agregado' };
    
  } catch(error) {
    Logger.log('Error en DB.agregar(): ' + error.toString());
    return { success: false, error: 'Error al agregar registro' };
  }
}
// MOD-006: FIN

// MOD-007: ACTUALIZAR REGISTRO [INICIO]
/**
 * Actualizar un registro existente
 * Requiere obj._rowNumber obtenido de buscar()
 */
function actualizar(sheetName, obj) {
  try {
    if (!obj._rowNumber) {
      return { success: false, error: 'Falta _rowNumber en objeto' };
    }
    
    var sheet = SHEET[sheetName];
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: ' + sheetName };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    var updatedRow = [];
    for (var i = 0; i < headers.length; i++) {
      updatedRow.push(obj[headers[i]] || '');
    }
    
    var range = sheet.getRange(obj._rowNumber, 1, 1, headers.length);
    range.setValues([updatedRow]);
    
    return { success: true, message: 'Registro actualizado' };
    
  } catch(error) {
    Logger.log('Error en DB.actualizar(): ' + error.toString());
    return { success: false, error: 'Error al actualizar registro' };
  }
}
// MOD-007: FIN

// MOD-008: ELIMINAR REGISTRO [INICIO]
/**
 * Eliminar un registro por número de fila
 */
function eliminar(sheetName, rowNumber) {
  try {
    var sheet = SHEET[sheetName];
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: ' + sheetName };
    }
    
    sheet.deleteRow(rowNumber);
    
    return { success: true, message: 'Registro eliminado' };
    
  } catch(error) {
    Logger.log('Error en DB.eliminar(): ' + error.toString());
    return { success: false, error: 'Error al eliminar registro' };
  }
}
// MOD-008: FIN

// MOD-009: OBTENER POR ALUMNO [INICIO]
/**
 * Obtener TODOS los registros de un alumno específico
 * Uso típico: Student.obtenerCursos() llama a DB.obtenerPorAlumno("Cursos", codeAlum)
 */
function obtenerPorAlumno(sheetName, codeAlum) {
  try {
    var sheet = SHEET[sheetName];
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: ' + sheetName };
    }
    
    var data = sheet.getDataRange().getValues();
    if (data.length === 0) {
      return { success: false, error: 'Hoja vacía' };
    }
    
    var headers = data[0];
    var colIndex = headers.indexOf('CodeAlum');
    
    if (colIndex === -1) {
      return { success: false, error: 'Columna CodeAlum no encontrada' };
    }
    
    var results = [];
    
    for (var i = 1; i < data.length; i++) {
      if (data[i][colIndex] === codeAlum) {
        var obj = {};
        for (var j = 0; j < headers.length; j++) {
          obj[headers[j]] = data[i][j];
        }
        obj._rowNumber = i + 1;
        results.push(obj);
      }
    }
    
    return { success: true, data: results };
    
  } catch(error) {
    Logger.log('Error en DB.obtenerPorAlumno(): ' + error.toString());
    return { success: false, error: 'Error al obtener registros del alumno' };
  }
}
// MOD-009: FIN

// MOD-010: ELIMINAR POR ALUMNO [INICIO]
/**
 * Eliminar TODOS los registros de un alumno en una hoja
 * Uso: Admin.eliminarAlumno() llama a esta función para cada hoja
 */
function eliminarPorAlumno(sheetName, codeAlum) {
  try {
    var sheet = SHEET[sheetName];
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: ' + sheetName };
    }
    
    var data = sheet.getDataRange().getValues();
    if (data.length === 0) {
      return { success: true, eliminados: 0 };
    }
    
    var headers = data[0];
    var colIndex = headers.indexOf('CodeAlum');
    
    if (colIndex === -1) {
      return { success: true, eliminados: 0 };
    }
    
    var eliminados = 0;
    
    for (var i = data.length - 1; i >= 1; i--) {
      if (data[i][colIndex] === codeAlum) {
        sheet.deleteRow(i + 1);
        eliminados++;
      }
    }
    
    return { success: true, eliminados: eliminados };
    
  } catch(error) {
    Logger.log('Error en DB.eliminarPorAlumno(): ' + error.toString());
    return { success: false, error: 'Error al eliminar registros del alumno' };
  }
}
// MOD-010: FIN

// MOD-011: EXPORTAR FUNCIONES PÚBLICAS [INICIO]
return {
  buscar: buscar,
  agregar: agregar,
  actualizar: actualizar,
  eliminar: eliminar,
  obtenerPorAlumno: obtenerPorAlumno,
  eliminarPorAlumno: eliminarPorAlumno
};
// MOD-011: FIN

// MOD-012: CIERRE MÓDULO DB [INICIO]
})();
// MOD-012: FIN

// MOD-013: CÓDIGO DE CIERRE [INICIO]
Logger.log('✅ 1db.gs v01.14 cargado');
// MOD-013: FIN

// MOD-099: NOTAS [INICIO]
/*
DESCRIPCIÓN:
Capa de acceso a datos (CRUD genérico) para Google Sheets
ÚNICA capa autorizada para leer/escribir en Google Sheets

FUNCIONES PÚBLICAS:
- buscar: Buscar registro por columna y valor (case-insensitive)
- agregar: Agregar nuevo registro a una hoja
- actualizar: Actualizar registro existente (requiere _rowNumber)
- eliminar: Eliminar registro por número de fila
- obtenerPorAlumno: Obtener todos los registros de un alumno
- eliminarPorAlumno: Eliminar todos los registros de un alumno

PRINCIPIO ARQUITECTÓNICO CRÍTICO:
DB es la ÚNICA capa que accede directamente a Google Sheets
Student y Admin NUNCA acceden a SHEET directamente

HOJAS DISPONIBLES:
Alumnos, Clientes, Cursos, Repasos, Eval, Tareas, Lecturas,
HorarioClases, HorarioSem, Opciones, Admin

CARACTERÍSTICAS:
- Todas las búsquedas son case-insensitive por diseño
- Retorna siempre formato { success, data/error }
- Funciones eliminarPorAlumno eliminan de abajo hacia arriba
- _rowNumber se incluye automáticamente en objetos retornados

DEPENDENCIAS:
- SpreadsheetApp (Google Apps Script)
- Spreadsheet ID: 13bAsdOddT0INxXwjPQAsvlQg3xm-KMZnpTchzbwUw6s

CAMBIOS V01.13 → V01.14:
- Remodulación completa según Estándar CodeWorkShop v4.0
- Estructura modular clara y ordenada
- Comentarios consolidados en MOD-099
*/
// MOD-099: FIN


// ============================================
// ARCHIVO 4/24: 1student.gs
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/1student.gs
// ============================================

// MOD-001: ENCABEZADO [INICIO]
/*
*****************************************
PROYECTO: PBE Control
ARCHIVO: 1student.gs
VERSIÓN: 01.26
FECHA: 24/01/2026 21:22 (UTC-5)
*****************************************
*/
// MOD-001: FIN

// MOD-002: INICIALIZACIÓN [INICIO]
var Student = (function() {
// MOD-002: FIN
  
// MOD-003: CURSOS [INICIO]
function obtenerCursos(params) {
  try {
    var codeAlum = params.codeAlum;
    return DB.obtenerPorAlumno('Cursos', codeAlum);
  } catch(error) {
    Logger.log('Error en Student.obtenerCursos(): ' + error.toString());
    return { success: false, error: 'Error al obtener cursos' };
  }
}

function agregarCurso(params) {
  try {
    var existentes = DB.obtenerPorAlumno('Cursos', params.codeAlum);
    
    if (existentes.success) {
      for (var i = 0; i < existentes.data.length; i++) {
        if (existentes.data[i].Curso === params.curso) {
          return {
            success: false,
            error: 'El curso ' + params.curso + ' ya existe. Usa otro nombre corto'
          };
        }
      }
    }
    
    var curso = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      Curso: params.curso,
      Completo: params.completo,
      Color: params.color || '#FF5733'
    };
    
    return DB.agregar('Cursos', curso);
  } catch(error) {
    Logger.log('Error en Student.agregarCurso(): ' + error.toString());
    return { success: false, error: 'Error al agregar curso' };
  }
}

function actualizarCurso(params) {
  try {
    // ✅ FIX V01.26: Si viene rowNumber, actualizar directamente
    if (params.rowNumber) {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var sheet = ss.getSheetByName('Cursos');
      
      if (!sheet) {
        return { success: false, error: 'Hoja no encontrada: Cursos' };
      }
      
      var data = sheet.getDataRange().getValues();
      var headers = data[0];
      
      // Leer registro actual de la fila específica
      var rowIndex = params.rowNumber - 1;
      if (rowIndex < 1 || rowIndex >= data.length) {
        return { success: false, error: 'Número de fila inválido' };
      }
      
      var curso = {};
      for (var i = 0; i < headers.length; i++) {
        curso[headers[i]] = data[rowIndex][i];
      }
      curso._rowNumber = params.rowNumber;
      
      // Validar que no exista otro curso con el mismo nombre (solo si se cambió)
      if (params.curso && params.curso !== curso.Curso) {
        var existentes = DB.obtenerPorAlumno('Cursos', params.codeAlum);
        if (existentes.success) {
          for (var j = 0; j < existentes.data.length; j++) {
            // Ignorar el curso que estamos editando
            if (existentes.data[j]._rowNumber !== params.rowNumber && 
                existentes.data[j].Curso === params.curso) {
              return {
                success: false,
                error: 'El curso ' + params.curso + ' ya existe. Usa otro nombre corto'
              };
            }
          }
        }
      }
      
      // Actualizar campos
      curso.Curso = params.curso || curso.Curso;
      curso.Completo = params.completo || curso.Completo;
      curso.Color = params.color || curso.Color;
      
      return DB.actualizar('Cursos', curso);
    }
    
    // ❌ FALLBACK: Código viejo (compatibilidad)
    // NOTA: Este código tiene el bug de actualizar siempre el primer curso
    var result = DB.buscar('Cursos', 'CodeAlum', params.codeAlum);
    if (!result.success) {
      return { success: false, error: 'Curso no encontrado' };
    }
    
    var curso = result.data;
    curso.Curso = params.curso || curso.Curso;
    curso.Completo = params.completo || curso.Completo;
    curso.Color = params.color || curso.Color;
    
    return DB.actualizar('Cursos', curso);
  } catch(error) {
    Logger.log('Error en Student.actualizarCurso(): ' + error.toString());
    return { success: false, error: 'Error al actualizar curso' };
  }
}

function eliminarCurso(params) {
  try {
    return DB.eliminar('Cursos', params.rowNumber);
  } catch(error) {
    Logger.log('Error en Student.eliminarCurso(): ' + error.toString());
    return { success: false, error: 'Error al eliminar curso' };
  }
}
// MOD-003: FIN

// MOD-004: REPASOS [INICIO]
function obtenerRepasos(params) {
  try {
    var codeAlum = params.codeAlum;
    return DB.obtenerPorAlumno('Repasos', codeAlum);
  } catch(error) {
    Logger.log('Error en Student.obtenerRepasos(): ' + error.toString());
    return { success: false, error: 'Error al obtener repasos' };
  }
}

function agregarRepaso(params) {
  try {
    var existentes = DB.obtenerPorAlumno('Repasos', params.codeAlum);
    
    if (existentes.success) {
      for (var i = 0; i < existentes.data.length; i++) {
        if (existentes.data[i].Curso === params.curso && 
            existentes.data[i].Tema === params.tema) {
          return {
            success: false,
            error: 'El tema "' + params.tema + '" ya existe en ' + params.curso
          };
        }
      }
    }
    
    var repaso = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      Curso: params.curso,
      Tema: params.tema,
      FechaClase: params.fechaClase,
      FechaRep: params.fechaRep,
      EstadoRep: params.estadoRep || 'Falta',
      Detalle: params.detalle || '',
      Evaluado: params.evaluado || ''
    };
    
    return DB.agregar('Repasos', repaso);
  } catch(error) {
    Logger.log('Error en Student.agregarRepaso(): ' + error.toString());
    return { success: false, error: 'Error al agregar repaso' };
  }
}

function actualizarRepaso(params) {
  try {
    var result = DB.buscar('Repasos', 'CodeAlum', params.codeAlum);
    if (!result.success) {
      return { success: false, error: 'Repaso no encontrado' };
    }
    
    var repaso = result.data;
    repaso.Tema = params.tema || repaso.Tema;
    repaso.FechaClase = params.fechaClase || repaso.FechaClase;
    repaso.FechaRep = params.fechaRep || repaso.FechaRep;
    repaso.EstadoRep = params.estadoRep || repaso.EstadoRep;
    repaso.Detalle = params.detalle || repaso.Detalle;
    repaso.Evaluado = params.evaluado || repaso.Evaluado;
    
    return DB.actualizar('Repasos', repaso);
  } catch(error) {
    Logger.log('Error en Student.actualizarRepaso(): ' + error.toString());
    return { success: false, error: 'Error al actualizar repaso' };
  }
}

function eliminarRepaso(params) {
  try {
    return DB.eliminar('Repasos', params.rowNumber);
  } catch(error) {
    Logger.log('Error en Student.eliminarRepaso(): ' + error.toString());
    return { success: false, error: 'Error al eliminar repaso' };
  }
}
// MOD-004: FIN

// MOD-005: EVALUACIONES [INICIO]
function obtenerEvaluaciones(params) {
  try {
    var codeAlum = params.codeAlum;
    return DB.obtenerPorAlumno('Eval', codeAlum);
  } catch(error) {
    Logger.log('Error en Student.obtenerEvaluaciones(): ' + error.toString());
    return { success: false, error: 'Error al obtener evaluaciones' };
  }
}

function agregarEvaluacion(params) {
  try {
    var existentes = DB.obtenerPorAlumno('Eval', params.codeAlum);
    
    if (existentes.success) {
      for (var i = 0; i < existentes.data.length; i++) {
        if (existentes.data[i].Curso === params.curso && 
            existentes.data[i].NomEval === params.nomEval) {
          return {
            success: false,
            error: 'La evaluación "' + params.nomEval + '" ya existe en ' + params.curso
          };
        }
      }
    }
    
    var evaluacion = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      Curso: params.curso,
      NomEval: params.nomEval,
      FechaEval: params.fechaEval,
      Nota: params.nota || '',
      Peso: params.peso || '',
      Sem: params.sem || ''
    };
    
    return DB.agregar('Eval', evaluacion);
  } catch(error) {
    Logger.log('Error en Student.agregarEvaluacion(): ' + error.toString());
    return { success: false, error: 'Error al agregar evaluación' };
  }
}

function actualizarEvaluacion(params) {
  try {
    var result = DB.buscar('Eval', 'CodeAlum', params.codeAlum);
    if (!result.success) {
      return { success: false, error: 'Evaluación no encontrada' };
    }
    
    var evaluacion = result.data;
    evaluacion.NomEval = params.nomEval || evaluacion.NomEval;
    evaluacion.FechaEval = params.fechaEval || evaluacion.FechaEval;
    evaluacion.Nota = params.nota || evaluacion.Nota;
    evaluacion.Peso = params.peso || evaluacion.Peso;
    evaluacion.Sem = params.sem || evaluacion.Sem;
    
    return DB.actualizar('Eval', evaluacion);
  } catch(error) {
    Logger.log('Error en Student.actualizarEvaluacion(): ' + error.toString());
    return { success: false, error: 'Error al actualizar evaluación' };
  }
}

function eliminarEvaluacion(params) {
  try {
    return DB.eliminar('Eval', params.rowNumber);
  } catch(error) {
    Logger.log('Error en Student.eliminarEvaluacion(): ' + error.toString());
    return { success: false, error: 'Error al eliminar evaluación' };
  }
}
// MOD-005: FIN

// MOD-006: TAREAS [INICIO]
function obtenerTareas(params) {
  try {
    var codeAlum = params.codeAlum;
    return DB.obtenerPorAlumno('Tareas', codeAlum);
  } catch(error) {
    Logger.log('Error en Student.obtenerTareas(): ' + error.toString());
    return { success: false, error: 'Error al obtener tareas' };
  }
}

function agregarTarea(params) {
  try {
    var existentes = DB.obtenerPorAlumno('Tareas', params.codeAlum);
    
    if (existentes.success) {
      for (var i = 0; i < existentes.data.length; i++) {
        if (existentes.data[i].Curso === params.curso && 
            existentes.data[i].Tarea === params.tarea) {
          return {
            success: false,
            error: 'La tarea "' + params.tarea + '" ya existe en ' + params.curso
          };
        }
      }
    }
    
    var tarea = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      Curso: params.curso,
      Tarea: params.tarea,
      FechaEntrega: params.fechaEntrega,
      FechaAccion: params.fechaAccion || '',
      Nota: params.nota || '',
      Peso: params.peso || '',
      Sem: params.sem || ''
    };
    
    return DB.agregar('Tareas', tarea);
  } catch(error) {
    Logger.log('Error en Student.agregarTarea(): ' + error.toString());
    return { success: false, error: 'Error al agregar tarea' };
  }
}

function actualizarTarea(params) {
  try {
    var result = DB.buscar('Tareas', 'CodeAlum', params.codeAlum);
    if (!result.success) {
      return { success: false, error: 'Tarea no encontrada' };
    }
    
    var tarea = result.data;
    tarea.Tarea = params.tarea || tarea.Tarea;
    tarea.FechaEntrega = params.fechaEntrega || tarea.FechaEntrega;
    tarea.FechaAccion = params.fechaAccion || tarea.FechaAccion;
    tarea.Nota = params.nota || tarea.Nota;
    tarea.Peso = params.peso || tarea.Peso;
    tarea.Sem = params.sem || tarea.Sem;
    
    return DB.actualizar('Tareas', tarea);
  } catch(error) {
    Logger.log('Error en Student.actualizarTarea(): ' + error.toString());
    return { success: false, error: 'Error al actualizar tarea' };
  }
}

function eliminarTarea(params) {
  try {
    return DB.eliminar('Tareas', params.rowNumber);
  } catch(error) {
    Logger.log('Error en Student.eliminarTarea(): ' + error.toString());
    return { success: false, error: 'Error al eliminar tarea' };
  }
}
// MOD-006: FIN

// MOD-007: LECTURAS [INICIO]
function obtenerLecturas(params) {
  try {
    var codeAlum = params.codeAlum;
    return DB.obtenerPorAlumno('Lecturas', codeAlum);
  } catch(error) {
    Logger.log('Error en Student.obtenerLecturas(): ' + error.toString());
    return { success: false, error: 'Error al obtener lecturas' };
  }
}

function agregarLectura(params) {
  try {
    var existentes = DB.obtenerPorAlumno('Lecturas', params.codeAlum);
    
    if (existentes.success) {
      for (var i = 0; i < existentes.data.length; i++) {
        if (existentes.data[i].Curso === params.curso && 
            existentes.data[i].Lectura === params.lectura) {
          return {
            success: false,
            error: 'La lectura "' + params.lectura + '" ya existe en ' + params.curso
          };
        }
      }
    }
    
    var lectura = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      Curso: params.curso,
      Lectura: params.lectura,
      CantPag: params.cantPag,
      PagActual: params.pagActual || 0,
      FechaInicio: params.fechaInicio,
      FechaFin: params.fechaFin,
      FechaEval: params.fechaEval || '',
      Nota: params.nota || '',
      Peso: params.peso || '',
      Sem: params.sem || ''
    };
    
    return DB.agregar('Lecturas', lectura);
  } catch(error) {
    Logger.log('Error en Student.agregarLectura(): ' + error.toString());
    return { success: false, error: 'Error al agregar lectura' };
  }
}

function actualizarLectura(params) {
  try {
    var result = DB.buscar('Lecturas', 'CodeAlum', params.codeAlum);
    if (!result.success) {
      return { success: false, error: 'Lectura no encontrada' };
    }
    
    var lectura = result.data;
    lectura.Lectura = params.lectura || lectura.Lectura;
    lectura.CantPag = params.cantPag || lectura.CantPag;
    lectura.PagActual = params.pagActual || lectura.PagActual;
    lectura.FechaInicio = params.fechaInicio || lectura.FechaInicio;
    lectura.FechaFin = params.fechaFin || lectura.FechaFin;
    lectura.FechaEval = params.fechaEval || lectura.FechaEval;
    lectura.Nota = params.nota || lectura.Nota;
    lectura.Peso = params.peso || lectura.Peso;
    lectura.Sem = params.sem || lectura.Sem;
    
    return DB.actualizar('Lecturas', lectura);
  } catch(error) {
    Logger.log('Error en Student.actualizarLectura(): ' + error.toString());
    return { success: false, error: 'Error al actualizar lectura' };
  }
}

function eliminarLectura(params) {
  try {
    return DB.eliminar('Lecturas', params.rowNumber);
  } catch(error) {
    Logger.log('Error en Student.eliminarLectura(): ' + error.toString());
    return { success: false, error: 'Error al eliminar lectura' };
  }
}
// MOD-007: FIN

// MOD-008: HORARIO CLASES [INICIO]
function obtenerHorarioClases(params) {
  try {
    var codeAlum = params.codeAlum;
    var result = DB.obtenerPorAlumno('HorarioClases', codeAlum);
    
    if (result.success) {
      result.data = result.data.map(function(item) {
        return {
          FechaReg: item.FechaReg,
          CodeAlum: item.CodeAlum,
          Curso: item.Curso,
          HoraIni: item.HoraInicio,
          HoraFin: item.HoraFin,
          Detalle: item.Detalle,
          _rowNumber: item._rowNumber
        };
      });
    }
    
    return result;
  } catch(error) {
    Logger.log('Error en Student.obtenerHorarioClases(): ' + error.toString());
    return { success: false, error: 'Error al obtener horario de clases' };
  }
}

function agregarHorarioClase(params) {
  try {
    var clase = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      Curso: params.curso,
      HoraInicio: params.horaIni || params.horaInicio,
      HoraFin: params.horaFin,
      Detalle: params.detalle || ''
    };
    
    return DB.agregar('HorarioClases', clase);
  } catch(error) {
    Logger.log('Error en Student.agregarHorarioClase(): ' + error.toString());
    return { success: false, error: 'Error al agregar clase al horario' };
  }
}

function actualizarHorarioClase(params) {
  try {
    // ✅ FIX V01.22: Si viene rowNumber, lo usamos directamente
    if (params.rowNumber) {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var sheet = ss.getSheetByName('HorarioClases');
      
      if (!sheet) {
        return { success: false, error: 'Hoja no encontrada: HorarioClases' };
      }
      
      var data = sheet.getDataRange().getValues();
      var headers = data[0];
      
      // Leer registro actual de la fila específica
      var rowIndex = params.rowNumber - 1;
      if (rowIndex < 1 || rowIndex >= data.length) {
        return { success: false, error: 'Número de fila inválido' };
      }
      
      var clase = {};
      for (var i = 0; i < headers.length; i++) {
        clase[headers[i]] = data[rowIndex][i];
      }
      clase._rowNumber = params.rowNumber;
      
      // Actualizar campos
      clase.Curso = params.curso || clase.Curso;
      clase.HoraInicio = params.horaIni || params.horaInicio || clase.HoraInicio;
      clase.HoraFin = params.horaFin || clase.HoraFin;
      clase.Detalle = params.detalle || clase.Detalle;
      
      return DB.actualizar('HorarioClases', clase);
    }
    
    // Fallback: Si NO viene rowNumber (compatibilidad)
    var result = DB.buscar('HorarioClases', 'CodeAlum', params.codeAlum);
    if (!result.success) {
      return { success: false, error: 'Clase no encontrada' };
    }
    
    var clase = result.data;
    clase.Curso = params.curso || clase.Curso;
    clase.HoraInicio = params.horaIni || params.horaInicio || clase.HoraInicio;
    clase.HoraFin = params.horaFin || clase.HoraFin;
    clase.Detalle = params.detalle || clase.Detalle;
    
    return DB.actualizar('HorarioClases', clase);
  } catch(error) {
    Logger.log('Error en Student.actualizarHorarioClase(): ' + error.toString());
    return { success: false, error: 'Error al actualizar clase del horario' };
  }
}

function eliminarHorarioClase(params) {
  try {
    return DB.eliminar('HorarioClases', params.rowNumber);
  } catch(error) {
    Logger.log('Error en Student.eliminarHorarioClase(): ' + error.toString());
    return { success: false, error: 'Error al eliminar clase del horario' };
  }
}
// MOD-008: FIN

// MOD-009: HORARIO SEMANAL [INICIO]
function obtenerHorarioSem(params) {
  try {
    var codeAlum = params.codeAlum;
    var result = DB.obtenerPorAlumno('HorarioSem', codeAlum);
    
    if (result.success && result.data) {
      result.data = result.data.map(function(item) {
        if (item.FechaHS && typeof item.FechaHS === 'string') {
          if (item.FechaHS.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            var partes = item.FechaHS.split('/');
            item.FechaHS = partes[2] + '-' + partes[1] + '-' + partes[0];
          }
        }
        return item;
      });
    }
    
    return result;
  } catch(error) {
    Logger.log('Error en Student.obtenerHorarioSem(): ' + error.toString());
    return { success: false, error: 'Error al obtener horario semanal' };
  }
}

function agregarHorarioSem(params) {
  try {
    var fechaHSFormateada = convertirISOaDDMMAAAA(params.fechaHS);
    
    var actividad = {
      FechaReg: Utils.fechaHoy(),
      CodeAlum: params.codeAlum,
      Actividad: params.actividad,
      HoraInicio: params.horaInicio,
      HoraFin: params.horaFin,
      FechaHS: fechaHSFormateada,
      TipoAct: params.tipoAct || '',
      Color: params.color || '#17a2b8',
      Sem: params.sem || ''
    };
    
    return DB.agregar('HorarioSem', actividad);
  } catch(error) {
    Logger.log('Error en Student.agregarHorarioSem(): ' + error.toString());
    return { success: false, error: 'Error al agregar actividad al horario semanal' };
  }
}

function actualizarHorarioSem(params) {
  try {
    var result = DB.buscar('HorarioSem', 'CodeAlum', params.codeAlum);
    if (!result.success) {
      return { success: false, error: 'Actividad no encontrada' };
    }
    
    var actividad = result.data;
    actividad.Actividad = params.actividad || actividad.Actividad;
    actividad.HoraInicio = params.horaInicio || actividad.HoraInicio;
    actividad.HoraFin = params.horaFin || actividad.HoraFin;
    
    if (params.fechaHS) {
      if (params.fechaHS.match(/^\d{4}-\d{2}-\d{2}$/)) {
        actividad.FechaHS = convertirISOaDDMMAAAA(params.fechaHS);
      } else if (params.fechaHS.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        actividad.FechaHS = params.fechaHS;
      } else {
        Logger.log('⚠️ Formato de fecha no reconocido: ' + params.fechaHS);
      }
    }
    
    actividad.TipoAct = params.tipoAct || actividad.TipoAct;
    actividad.Color = params.color || actividad.Color;
    actividad.Sem = params.sem || actividad.Sem;
    
    return DB.actualizar('HorarioSem', actividad);
  } catch(error) {
    Logger.log('Error en Student.actualizarHorarioSem(): ' + error.toString());
    return { success: false, error: 'Error al actualizar actividad del horario semanal' };
  }
}

function eliminarHorarioSem(params) {
  try {
    return DB.eliminar('HorarioSem', params.rowNumber);
  } catch(error) {
    Logger.log('Error en Student.eliminarHorarioSem(): ' + error.toString());
    return { success: false, error: 'Error al eliminar actividad del horario semanal' };
  }
}
// MOD-009: FIN

// MOD-010: CONFIG SEMANAS V5 [INICIO]

// MOD-010-S01: OBTENER CONFIG SEMANA [INICIO]
function obtenerConfigSemana(params) {
  try {
    var codeAlum = params.codeAlum;
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Fechas');
    
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: Fechas' };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    var codeAlumIdx = headers.indexOf('CodeAlum');
    var fechaInicioIdx = headers.indexOf('FechaInicio');
    var fechaFinIdx = headers.indexOf('FechaFin');
    
    if (codeAlumIdx === -1 || fechaInicioIdx === -1) {
      return { success: false, error: 'Estructura de hoja Fechas incorrecta' };
    }
    
    for (var i = 1; i < data.length; i++) {
      if (data[i][codeAlumIdx] === codeAlum) {
        var config = {
          FechaReg: data[i][0],
          CodeAlum: data[i][codeAlumIdx],
          FechaInicio: data[i][fechaInicioIdx]
        };
        
        // Agregar FechaFin si existe la columna y tiene valor
        if (fechaFinIdx !== -1 && data[i][fechaFinIdx]) {
          config.FechaFin = data[i][fechaFinIdx];
        }
        
        return { success: true, data: config };
      }
    }
    
    return { success: false, error: 'Configuración no encontrada para el alumno' };
  } catch(error) {
    Logger.log('Error en Student.obtenerConfigSemana(): ' + error.toString());
    return { success: false, error: 'Error al obtener configuración de semana' };
  }
}
// MOD-010-S01: FIN

// MOD-010-S02: GUARDAR CONFIG SEMANA [INICIO]
function guardarConfigSemana(params) {
  try {
    var codeAlum = params.codeAlum;
    var fechaInicio = params.fechaInicio; // Viene en formato ISO desde frontend
    var fechaFin = params.fechaFin; // Viene en formato ISO desde frontend
    
    // ✅ CONVERTIR a Date de JavaScript
    var fechaInicioDate = new Date(fechaInicio);
    var fechaFinDate = new Date(fechaFin);
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Fechas');
    
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: Fechas' };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    var codeAlumIdx = headers.indexOf('CodeAlum');
    var fechaInicioIdx = headers.indexOf('FechaInicio');
    var fechaFinIdx = headers.indexOf('FechaFin');
    
    if (codeAlumIdx === -1 || fechaInicioIdx === -1) {
      return { success: false, error: 'Estructura de hoja Fechas incorrecta' };
    }
    
    // Si no existe columna FechaFin, retornar error
    if (fechaFinIdx === -1) {
      return { success: false, error: 'Columna FechaFin no encontrada en hoja Fechas' };
    }
    
    // Buscar si ya existe configuración para este alumno
    for (var i = 1; i < data.length; i++) {
      if (data[i][codeAlumIdx] === codeAlum) {
        // ✅ Actualizar registro existente con Date
        var cellInicio = sheet.getRange(i + 1, fechaInicioIdx + 1);
        cellInicio.setNumberFormat('dd/mm/yyyy').setValue(fechaInicioDate);
        
        var cellFin = sheet.getRange(i + 1, fechaFinIdx + 1);
        cellFin.setNumberFormat('dd/mm/yyyy').setValue(fechaFinDate);
        
        Logger.log('✅ Config actualizada como Date: ' + fechaInicioDate + ' a ' + fechaFinDate);
        
        // Generar todas las semanas automáticamente
        var resultSemanas = generarTodasSemanas({
          codeAlum: codeAlum,
          fechaInicio: fechaInicio,
          fechaFin: fechaFin
        });
        
        if (!resultSemanas.success) {
          Logger.log('⚠️ Error al generar semanas: ' + resultSemanas.error);
        } else {
          Logger.log('✅ ' + resultSemanas.data + ' semanas generadas automáticamente');
        }
        
        return { success: true, semanas: resultSemanas.data };
      }
    }
    
    // ✅ Si no existe, crear nuevo registro con Date
    var nuevaFila = [];
    for (var j = 0; j < headers.length; j++) {
      if (headers[j] === 'FechaReg') {
        nuevaFila.push(Utils.fechaHoy());
      } else if (headers[j] === 'CodeAlum') {
        nuevaFila.push(codeAlum);
      } else if (headers[j] === 'FechaInicio') {
        nuevaFila.push(fechaInicioDate);
      } else if (headers[j] === 'FechaFin') {
        nuevaFila.push(fechaFinDate);
      } else {
        nuevaFila.push('');
      }
    }
    
    sheet.appendRow(nuevaFila);
    
    // Formatear las celdas de fecha
    var lastRow = sheet.getLastRow();
    sheet.getRange(lastRow, fechaInicioIdx + 1).setNumberFormat('dd/mm/yyyy');
    sheet.getRange(lastRow, fechaFinIdx + 1).setNumberFormat('dd/mm/yyyy');
    
    Logger.log('✅ Nueva config creada como Date: ' + fechaInicioDate + ' a ' + fechaFinDate);
    
    // Generar todas las semanas automáticamente
    var resultSemanas = generarTodasSemanas({
      codeAlum: codeAlum,
      fechaInicio: fechaInicio,
      fechaFin: fechaFin
    });
    
    if (!resultSemanas.success) {
      Logger.log('⚠️ Error al generar semanas: ' + resultSemanas.error);
    } else {
      Logger.log('✅ ' + resultSemanas.data + ' semanas generadas automáticamente');
    }
    
    return { success: true, semanas: resultSemanas.data };
  } catch(error) {
    Logger.log('Error en Student.guardarConfigSemana(): ' + error.toString());
    return { success: false, error: 'Error al guardar configuración: ' + error.toString() };
  }
}
// MOD-010-S02: FIN

// MOD-010-S03: GENERAR TODAS SEMANAS [INICIO]
function generarTodasSemanas(params) {
  try {
    var codeAlum = params.codeAlum;
    var fechaInicio = params.fechaInicio; // Formato ISO
    var fechaFin = params.fechaFin; // Formato ISO
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Semanas');
    
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: Semanas' };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    var codeAlumIdx = headers.indexOf('CodeAlum');
    var fechaInicioIdx = headers.indexOf('FechaInicio');
    var fechaFinIdx = headers.indexOf('FechaFin');
    
    if (codeAlumIdx === -1) {
      return { success: false, error: 'Estructura de hoja Semanas incorrecta' };
    }
    
    // PASO 1: Eliminar todas las semanas anteriores del alumno
    Logger.log('🗑️ Eliminando semanas anteriores del alumno ' + codeAlum);
    for (var i = data.length - 1; i >= 1; i--) {
      if (data[i][codeAlumIdx] === codeAlum) {
        sheet.deleteRow(i + 1);
      }
    }
    
    // PASO 2: Calcular semanas desde inicio hasta fin
    var inicio = new Date(fechaInicio + 'T00:00:00');
    var fin = new Date(fechaFin + 'T00:00:00');
    
    // Ajustar inicio al lunes de esa semana
    var diaSemanaInicio = inicio.getDay();
    var diasHastaLunes = diaSemanaInicio === 0 ? 6 : diaSemanaInicio - 1;
    var primerLunes = new Date(inicio);
    primerLunes.setDate(primerLunes.getDate() - diasHastaLunes);
    
    Logger.log('📅 Primer lunes: ' + primerLunes.toISOString().split('T')[0]);
    Logger.log('📅 Fecha fin: ' + fin.toISOString().split('T')[0]);
    
    // PASO 3: Generar semanas consecutivas
    var numSemana = 1;
    var lunesActual = new Date(primerLunes);
    var semanasGeneradas = 0;
    
    while (lunesActual <= fin) {
      var domingo = new Date(lunesActual);
      domingo.setDate(domingo.getDate() + 6);
      
      // ✅ Guardar como Date, no como string
      var fechaInicioSemana = new Date(lunesActual);
      var fechaFinSemana = new Date(domingo);
      
      // Crear fila para esta semana
      var nuevaFila = [];
      for (var j = 0; j < headers.length; j++) {
        if (headers[j] === 'FechaReg') {
          nuevaFila.push(Utils.fechaHoy());
        } else if (headers[j] === 'CodeAlum') {
          nuevaFila.push(codeAlum);
        } else if (headers[j] === 'FechaInicio') {
          nuevaFila.push(fechaInicioSemana);
        } else if (headers[j] === 'FechaFin') {
          nuevaFila.push(fechaFinSemana);
        } else if (headers[j] === 'Semana') {
          nuevaFila.push(numSemana);
        } else {
          nuevaFila.push('');
        }
      }
      
      sheet.appendRow(nuevaFila);
      
      // Formatear celdas de fecha
      var lastRow = sheet.getLastRow();
      if (fechaInicioIdx !== -1) {
        sheet.getRange(lastRow, fechaInicioIdx + 1).setNumberFormat('dd/mm/yyyy');
      }
      if (fechaFinIdx !== -1) {
        sheet.getRange(lastRow, fechaFinIdx + 1).setNumberFormat('dd/mm/yyyy');
      }
      
      semanasGeneradas++;
      
      Logger.log('✅ Semana ' + numSemana + ': ' + 
                 fechaInicioSemana.toISOString().split('T')[0] + ' → ' + 
                 fechaFinSemana.toISOString().split('T')[0]);
      
      // Avanzar al siguiente lunes
      lunesActual.setDate(lunesActual.getDate() + 7);
      numSemana++;
    }
    
    Logger.log('🎉 Total semanas generadas: ' + semanasGeneradas);
    
    return { success: true, data: semanasGeneradas };
  } catch(error) {
    Logger.log('Error en Student.generarTodasSemanas(): ' + error.toString());
    return { success: false, error: 'Error al generar semanas: ' + error.toString() };
  }
}
// MOD-010-S03: FIN

// MOD-010-S04: COPIAR SEMANA [INICIO]
function copiarSemana(params) {
  try {
    var codeAlum = params.codeAlum;
    var fechaInicioOrigen = new Date(params.fechaInicioOrigen + 'T00:00:00');
    var fechaFinOrigen = new Date(params.fechaFinOrigen + 'T00:00:00');
    var fechaInicioDestino = new Date(params.fechaInicioDestino + 'T00:00:00');
    
    // Validar fechas
    if (isNaN(fechaInicioOrigen.getTime()) || isNaN(fechaFinOrigen.getTime()) || isNaN(fechaInicioDestino.getTime())) {
      Logger.log('❌ copiarSemana: Fechas inválidas');
      return { success: false, error: 'Fechas inválidas' };
    }
    
    Logger.log('📋 Copiando actividades de ' + params.fechaInicioOrigen + ' a ' + params.fechaInicioDestino);
    
    var todasActividades = DB.obtenerPorAlumno('HorarioSem', codeAlum);
    
    if (!todasActividades.success) {
      Logger.log('⚠️ No se pudieron obtener actividades');
      return { success: true, data: 0 };
    }
    
    var actividadesACopiar = [];
    
    // Filtrar actividades dentro del rango de origen
    for (var i = 0; i < todasActividades.data.length; i++) {
      var act = todasActividades.data[i];
      var fechaAct = parsearFechaDDMMAAAABackend(act.FechaHS);
      
      if (fechaAct >= fechaInicioOrigen && fechaAct <= fechaFinOrigen) {
        actividadesACopiar.push(act);
      }
    }
    
    Logger.log('📋 Actividades a copiar: ' + actividadesACopiar.length);
    
    var copiadas = 0;
    
    // Copiar cada actividad ajustando la fecha
    for (var j = 0; j < actividadesACopiar.length; j++) {
      var original = actividadesACopiar[j];
      var fechaOriginal = parsearFechaDDMMAAAABackend(original.FechaHS);
      
      // Calcular diferencia en días desde el inicio de la semana origen
      var diffDias = Math.floor((fechaOriginal - fechaInicioOrigen) / (1000 * 60 * 60 * 24));
      
      // Calcular nueva fecha sumando la diferencia al inicio de destino
      var nuevaFecha = new Date(fechaInicioDestino);
      nuevaFecha.setDate(nuevaFecha.getDate() + diffDias);
      
      // Formatear fecha a DD/MM/AAAA
      var dia = String(nuevaFecha.getDate()).padStart(2, '0');
      var mes = String(nuevaFecha.getMonth() + 1).padStart(2, '0');
      var anio = nuevaFecha.getFullYear();
      var fechaFormateada = dia + '/' + mes + '/' + anio;
      
      // Crear nueva actividad
      var nuevaActividad = {
        FechaReg: Utils.fechaHoy(),
        CodeAlum: codeAlum,
        Actividad: original.Actividad,
        HoraInicio: original.HoraInicio,
        HoraFin: original.HoraFin,
        FechaHS: fechaFormateada,
        TipoAct: original.TipoAct,
        Color: original.Color,
        Sem: original.Sem
      };
      
      var resultado = DB.agregar('HorarioSem', nuevaActividad);
      if (resultado.success) {
        copiadas++;
      }
    }
    
    Logger.log('✅ Actividades copiadas: ' + copiadas);
    return { success: true, data: copiadas };
    
  } catch(error) {
    Logger.log('Error en Student.copiarSemana(): ' + error.toString());
    return { success: false, error: 'Error al copiar semana' };
  }
}
// MOD-010-S04: FIN

// MOD-010-S05: LIMPIAR SEMANA [INICIO]
function limpiarSemana(params) {
  try {
    var codeAlum = params.codeAlum;
    var fechaInicio = new Date(params.fechaInicio + 'T00:00:00');
    var fechaFin = new Date(params.fechaFin + 'T00:00:00');
    
    // Validar fechas
    if (isNaN(fechaInicio.getTime()) || isNaN(fechaFin.getTime())) {
      Logger.log('❌ limpiarSemana: Fechas inválidas');
      return { success: false, error: 'Fechas inválidas' };
    }
    
    Logger.log('🗑️ Limpiando semana de ' + params.fechaInicio + ' a ' + params.fechaFin);
    
    var todasActividades = DB.obtenerPorAlumno('HorarioSem', codeAlum);
    
    if (!todasActividades.success) {
      Logger.log('⚠️ No se pudieron obtener actividades');
      return { success: true, data: 0 };
    }
    
    var eliminadas = 0;
    
    for (var i = 0; i < todasActividades.data.length; i++) {
      var act = todasActividades.data[i];
      var fechaAct = parsearFechaDDMMAAAABackend(act.FechaHS);
      
      if (fechaAct >= fechaInicio && fechaAct <= fechaFin) {
        var resultado = DB.eliminar('HorarioSem', act._rowNumber);
        if (resultado.success) {
          eliminadas++;
        }
      }
    }
    
    Logger.log('✅ Actividades eliminadas: ' + eliminadas);
    return { success: true, data: eliminadas };
    
  } catch(error) {
    Logger.log('Error en Student.limpiarSemana(): ' + error.toString());
    return { success: false, error: 'Error al limpiar semana' };
  }
}
// MOD-010-S05: FIN

// MOD-010-S06: HELPER PARSEAR FECHA [INICIO]
function parsearFechaDDMMAAAABackend(fechaStr) {
  if (!fechaStr) return new Date('invalid');
  
  var str = String(fechaStr).trim();
  
  // Formato DD/MM/AAAA
  var match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (match) {
    var dia = parseInt(match[1], 10);
    var mes = parseInt(match[2], 10) - 1;
    var anio = parseInt(match[3], 10);
    return new Date(anio, mes, dia);
  }
  
  return new Date(str);
}
// MOD-010-S06: FIN

// MOD-010: FIN

// MOD-011: GESTIÓN SEMANAS [INICIO]
function obtenerSemanas(codeAlum) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Semanas');
    
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: Semanas' };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    var codeAlumIdx = headers.indexOf('CodeAlum');
    var fechaInicioIdx = headers.indexOf('FechaInicio');
    var fechaFinIdx = headers.indexOf('FechaFin');
    var semanaIdx = headers.indexOf('Semana');
    
    if (codeAlumIdx === -1 || fechaInicioIdx === -1 || fechaFinIdx === -1 || semanaIdx === -1) {
      return { success: false, error: 'Estructura de hoja Semanas incorrecta' };
    }
    
    var semanas = [];
    
    for (var i = 1; i < data.length; i++) {
      if (data[i][codeAlumIdx] === codeAlum) {
        semanas.push({
          FechaReg: data[i][0],
          CodeAlum: data[i][codeAlumIdx],
          FechaInicio: data[i][fechaInicioIdx],
          FechaFin: data[i][fechaFinIdx],
          Semana: data[i][semanaIdx],
          _rowNumber: i + 1
        });
      }
    }
    
    semanas.sort(function(a, b) {
      return parseInt(a.Semana) - parseInt(b.Semana);
    });
    
    return { success: true, data: semanas };
  } catch(error) {
    Logger.log('Error en Student.obtenerSemanas(): ' + error.toString());
    return { success: false, error: 'Error al obtener semanas' };
  }
}

function crearSemana(params) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Semanas');
    
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: Semanas' };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    var codeAlumIdx = headers.indexOf('CodeAlum');
    var semanaIdx = headers.indexOf('Semana');
    
    if (codeAlumIdx === -1 || semanaIdx === -1) {
      return { success: false, error: 'Estructura de hoja Semanas incorrecta' };
    }
    
    for (var i = 1; i < data.length; i++) {
      if (data[i][codeAlumIdx] === params.codeAlum && 
          data[i][semanaIdx] === params.semana) {
        return { 
          success: false, 
          error: 'La Semana ' + params.semana + ' ya existe' 
        };
      }
    }
    
    var fechaInicioDate = parsearFechaISO(params.fechaInicio);
    var fechaFinDate = parsearFechaISO(params.fechaFin);
    
    var nuevaFila = [];
    for (var j = 0; j < headers.length; j++) {
      if (headers[j] === 'FechaReg') {
        nuevaFila.push(Utils.fechaHoy());
      } else if (headers[j] === 'CodeAlum') {
        nuevaFila.push(params.codeAlum);
      } else if (headers[j] === 'FechaInicio') {
        nuevaFila.push(fechaInicioDate);
      } else if (headers[j] === 'FechaFin') {
        nuevaFila.push(fechaFinDate);
      } else if (headers[j] === 'Semana') {
        nuevaFila.push(params.semana);
      } else {
        nuevaFila.push('');
      }
    }
    
    sheet.appendRow(nuevaFila);
    
    Logger.log('✅ Semana ' + params.semana + ' creada con Utils.fechaHoy()');
    
    return { success: true, data: sheet.getLastRow() };
  } catch(error) {
    Logger.log('Error en Student.crearSemana(): ' + error.toString());
    return { success: false, error: 'Error al crear semana' };
  }
}

function eliminarSemana(params) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Semanas');
    
    if (!sheet) {
      return { success: false, error: 'Hoja no encontrada: Semanas' };
    }
    
    sheet.deleteRow(params.rowNumber);
    
    return { success: true };
  } catch(error) {
    Logger.log('Error en Student.eliminarSemana(): ' + error.toString());
    return { success: false, error: 'Error al eliminar semana' };
  }
}
// MOD-011: FIN

// MOD-012: NOTAS [INICIO]
function obtenerNotasPorCurso(params) {
  try {
    var codeAlum = params.codeAlum;
    var curso = params.curso;
    
    var eval = DB.obtenerPorAlumno('Eval', codeAlum);
    var evalCurso = eval.success ? 
      eval.data.filter(function(e) { return e.Curso === curso; }) : [];
    
    var tareas = DB.obtenerPorAlumno('Tareas', codeAlum);
    var tareasCurso = tareas.success ? 
      tareas.data.filter(function(t) { return t.Curso === curso; }) : [];
    
    var lecturas = DB.obtenerPorAlumno('Lecturas', codeAlum);
    var lecturasCurso = lecturas.success ? 
      lecturas.data.filter(function(l) { return l.Curso === curso; }) : [];
    
    var totalNota = 0;
    var totalPeso = 0;
    
    evalCurso.forEach(function(item) {
      if (item.Nota && item.Peso) {
        totalNota += parseFloat(item.Nota) * parseFloat(item.Peso);
        totalPeso += parseFloat(item.Peso);
      }
    });
    
    tareasCurso.forEach(function(item) {
      if (item.Nota && item.Peso) {
        totalNota += parseFloat(item.Nota) * parseFloat(item.Peso);
        totalPeso += parseFloat(item.Peso);
      }
    });
    
    lecturasCurso.forEach(function(item) {
      if (item.Nota && item.Peso) {
        totalNota += parseFloat(item.Nota) * parseFloat(item.Peso);
        totalPeso += parseFloat(item.Peso);
      }
    });
    
    var promedio = totalPeso > 0 ? (totalNota / totalPeso).toFixed(2) : 0;
    
    return {
      success: true,
      data: {
        curso: curso,
        promedio: promedio,
        evaluaciones: evalCurso.length,
        tareas: tareasCurso.length,
        lecturas: lecturasCurso.length
      }
    };
  } catch(error) {
    Logger.log('Error en Student.obtenerNotasPorCurso(): ' + error.toString());
    return { success: false, error: 'Error al obtener notas del curso' };
  }
}

function obtenerResumenNotas(params) {
  try {
    var codeAlum = params.codeAlum;
    
    var cursosResult = DB.obtenerPorAlumno('Cursos', codeAlum);
    if (!cursosResult.success) {
      return { success: false, error: 'No se pudieron obtener los cursos' };
    }
    
    var resumen = [];
    
    cursosResult.data.forEach(function(curso) {
      var notasCurso = obtenerNotasPorCurso({
        codeAlum: codeAlum,
        curso: curso.Curso
      });
      
      if (notasCurso.success) {
        resumen.push({
          curso: curso.Curso,
          completo: curso.Completo,
          color: curso.Color,
          promedio: notasCurso.data.promedio,
          evaluaciones: notasCurso.data.evaluaciones,
          tareas: notasCurso.data.tareas,
          lecturas: notasCurso.data.lecturas
        });
      }
    });
    
    return { success: true, data: resumen };
  } catch(error) {
    Logger.log('Error en Student.obtenerResumenNotas(): ' + error.toString());
    return { success: false, error: 'Error al obtener resumen de notas' };
  }
}
// MOD-012: FIN

// MOD-013: DEBERES [INICIO]
function obtenerTodosDeberes(params) {
  try {
    var codeAlum = params.codeAlum;
    var deberes = [];
    
    var eval = DB.obtenerPorAlumno('Eval', codeAlum);
    if (eval.success) {
      eval.data.forEach(function(item) {
        deberes.push({
          tipo: 'Evaluación',
          curso: item.Curso,
          nombre: item.NomEval,
          fecha: item.FechaEval,
          nota: item.Nota,
          peso: item.Peso,
          _rowNumber: item._rowNumber
        });
      });
    }
    
    var tareas = DB.obtenerPorAlumno('Tareas', codeAlum);
    if (tareas.success) {
      tareas.data.forEach(function(item) {
        deberes.push({
          tipo: 'Tarea',
          curso: item.Curso,
          nombre: item.Tarea,
          fecha: item.FechaEntrega,
          nota: item.Nota,
          peso: item.Peso,
          _rowNumber: item._rowNumber
        });
      });
    }
    
    var lecturas = DB.obtenerPorAlumno('Lecturas', codeAlum);
    if (lecturas.success) {
      lecturas.data.forEach(function(item) {
        deberes.push({
          tipo: 'Lectura',
          curso: item.Curso,
          nombre: item.Lectura,
          fecha: item.FechaEval,
          nota: item.Nota,
          peso: item.Peso,
          progreso: item.PagActual && item.CantPag ? 
            ((item.PagActual / item.CantPag) * 100).toFixed(0) + '%' : '0%',
          _rowNumber: item._rowNumber
        });
      });
    }
    
    deberes.sort(function(a, b) {
      if (!a.fecha) return 1;
      if (!b.fecha) return -1;
      return new Date(a.fecha) - new Date(b.fecha);
    });
    
    return { success: true, data: deberes };
  } catch(error) {
    Logger.log('Error en Student.obtenerTodosDeberes(): ' + error.toString());
    return { success: false, error: 'Error al obtener todos los deberes' };
  }
}

function obtenerDeberesPorTipo(params) {
  try {
    var codeAlum = params.codeAlum;
    var tipo = params.tipo;
    
    var sheetName = tipo === 'Evaluación' ? 'Eval' : 
                    tipo === 'Tarea' ? 'Tareas' : 'Lecturas';
    
    return DB.obtenerPorAlumno(sheetName, codeAlum);
  } catch(error) {
    Logger.log('Error en Student.obtenerDeberesPorTipo(): ' + error.toString());
    return { success: false, error: 'Error al obtener deberes por tipo' };
  }
}
// MOD-013: FIN

// MOD-014: HELPERS [INICIO]
function formatearFechaISO(fecha) {
  if (!fecha || !(fecha instanceof Date)) {
    Logger.log('⚠️ formatearFechaISO: fecha inválida');
    return '';
  }
  
  var year = fecha.getFullYear();
  var month = String(fecha.getMonth() + 1).padStart(2, '0');
  var day = String(fecha.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
}

function parsearFechaISO(fechaISO) {
  if (!fechaISO || typeof fechaISO !== 'string') {
    Logger.log('⚠️ parsearFechaISO: entrada inválida');
    return new Date();
  }
  
  var partes = fechaISO.split('-');
  if (partes.length !== 3) {
    Logger.log('⚠️ parsearFechaISO: formato incorrecto');
    return new Date();
  }
  
  var anio = parseInt(partes[0], 10);
  var mes = parseInt(partes[1], 10) - 1;
  var dia = parseInt(partes[2], 10);
  
  return new Date(anio, mes, dia);
}

function convertirISOaDDMMAAAA(fechaISO) {
  if (!fechaISO || typeof fechaISO !== 'string') {
    return '';
  }
  
  var partes = fechaISO.split('-');
  if (partes.length !== 3) {
    return '';
  }
  
  return partes[2] + '/' + partes[1] + '/' + partes[0];
}
// MOD-014: FIN

// MOD-015: EXPORTACIÓN [INICIO]
return {
  obtenerCursos: obtenerCursos,
  agregarCurso: agregarCurso,
  actualizarCurso: actualizarCurso,
  eliminarCurso: eliminarCurso,
  obtenerRepasos: obtenerRepasos,
  agregarRepaso: agregarRepaso,
  actualizarRepaso: actualizarRepaso,
  eliminarRepaso: eliminarRepaso,
  obtenerEvaluaciones: obtenerEvaluaciones,
  agregarEvaluacion: agregarEvaluacion,
  actualizarEvaluacion: actualizarEvaluacion,
  eliminarEvaluacion: eliminarEvaluacion,
  obtenerTareas: obtenerTareas,
  agregarTarea: agregarTarea,
  actualizarTarea: actualizarTarea,
  eliminarTarea: eliminarTarea,
  obtenerLecturas: obtenerLecturas,
  agregarLectura: agregarLectura,
  actualizarLectura: actualizarLectura,
  eliminarLectura: eliminarLectura,
  obtenerHorarioClases: obtenerHorarioClases,
  agregarHorarioClase: agregarHorarioClase,
  actualizarHorarioClase: actualizarHorarioClase,
  eliminarHorarioClase: eliminarHorarioClase,
  obtenerHorarioSem: obtenerHorarioSem,
  agregarHorarioSem: agregarHorarioSem,
  actualizarHorarioSem: actualizarHorarioSem,
  eliminarHorarioSem: eliminarHorarioSem,
  obtenerConfigSemana: obtenerConfigSemana,
  guardarConfigSemana: guardarConfigSemana,
  copiarSemana: copiarSemana,
  limpiarSemana: limpiarSemana,
  obtenerSemanas: obtenerSemanas,
  crearSemana: crearSemana,
  eliminarSemana: eliminarSemana,
  obtenerNotasPorCurso: obtenerNotasPorCurso,
  obtenerResumenNotas: obtenerResumenNotas,
  obtenerTodosDeberes: obtenerTodosDeberes,
  obtenerDeberesPorTipo: obtenerDeberesPorTipo
};
// MOD-015: FIN

})();

// MOD-016: NOTAS [INICIO]
/*
CAMBIOS V01.23:
- Fix: actualizarCurso() usa rowNumber para actualizar fila correcta
- Fix: Validación de unicidad mejorada al cambiar nombre corto
- Fix: Evita actualizar el primer curso en lugar del curso seleccionado

MÓDULOS:
MOD-001: Encabezado
MOD-002: Inicialización
MOD-003: Cursos (4 funciones) - FIX V01.26 actualizarCurso
MOD-004: Repasos (4 funciones)
MOD-005: Evaluaciones (4 funciones)
MOD-006: Tareas (4 funciones)
MOD-007: Lecturas (4 funciones)
MOD-008: HorarioClases (4 funciones)
MOD-009: HorarioSem (4 funciones)
MOD-010: Config Semanas (4 funciones)
MOD-011: Gestión Semanas (3 funciones)
MOD-012: Notas (2 funciones)
MOD-013: Deberes (2 funciones)
MOD-014: Helpers (2 funciones)
MOD-015: Exportación
MOD-016: Notas

TOTAL FUNCIONES: 38

HOJA SEMANAS:
FechaReg | CodeAlum | FechaInicio | FechaFin | Semana
Formato fechas: DD/MM/AAAA

HOJA HORARIO SEMANAL:
FechaReg | CodeAlum | Actividad | HoraInicio | HoraFin | FechaHS | TipoAct | Color | Sem
Formato FechaHS: DD/MM/AAAA (guardado) → ISO (lectura)
*/
// MOD-016: FIN


// ============================================
// ARCHIVO 5/24: 1utils.gs
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/1utils.gs
// ============================================

// MOD-001: ENCABEZADO [INICIO]
/*
*****************************************
PROYECTO: PBE Control
ARCHIVO: 1utils.gs
VERSIÓN: 01.14
FECHA: 18/01/2026 11:58 (UTC-5)
*****************************************
*/
// MOD-001: FIN

// MOD-002: MÓDULO UTILS - DECLARACIÓN [INICIO]
var Utils = (function() {
// MOD-002: FIN

// MOD-003: FECHA ACTUAL [INICIO]
/**
 * Obtener fecha actual en formato DD/MM/AAAA
 * Zona horaria: GMT-5 (Lima, Perú)
 */
function fechaHoy() {
  var fecha = new Date();
  var dia = ('0' + fecha.getDate()).slice(-2);
  var mes = ('0' + (fecha.getMonth() + 1)).slice(-2);
  var anio = fecha.getFullYear();
  return dia + '/' + mes + '/' + anio;
}
// MOD-003: FIN

// MOD-004: VALIDAR EMAIL [INICIO]
/**
 * Validar formato de email
 * Regex: [texto]@[dominio].[extension]
 */
function validarEmail(email) {
  var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
}
// MOD-004: FIN

// MOD-005: EXPORTAR FUNCIONES PÚBLICAS [INICIO]
return {
  fechaHoy: fechaHoy,
  validarEmail: validarEmail
};
// MOD-005: FIN

// MOD-006: CIERRE MÓDULO UTILS [INICIO]
})();
// MOD-006: FIN

// MOD-007: PALETA DE COLORES [INICIO]
var COLORES = {
  rojo: '#FF5733',
  azul: '#3498DB',
  verde: '#2ECC71',
  amarillo: '#F1C40F',
  morado: '#9B59B6',
  naranja: '#E67E22',
  rosa: '#E91E63',
  turquesa: '#1ABC9C'
};
// MOD-007: FIN

// MOD-008: CÓDIGO DE CIERRE [INICIO]
Logger.log('✅ 1utils.gs v01.14 cargado');
// MOD-008: FIN

// MOD-099: NOTAS [INICIO]
/*
DESCRIPCIÓN:
Funciones de utilidad reutilizables para el sistema
Módulo standalone sin dependencias externas

FUNCIONES PÚBLICAS:
- fechaHoy: Retorna fecha actual en formato DD/MM/AAAA
- validarEmail: Valida formato de email con regex

CONSTANTES GLOBALES:
- COLORES: Paleta de 8 colores predefinidos del sistema

CARACTERÍSTICAS:
- Zona horaria: GMT-5 (Lima, Perú)
- Formato de fechas: DD/MM/AAAA
- Validación de email con expresión regular estándar

EJEMPLOS DE USO:
Utils.fechaHoy() → "18/01/2026"
Utils.validarEmail("usuario@dominio.com") → true
Utils.validarEmail("invalido@") → false
var colorPrimario = COLORES.azul; // '#3498DB'

DEPENDENCIAS:
Ninguna - Módulo completamente standalone

CAMBIOS V01.13 → V01.14:
- Remodulación completa según Estándar CodeWorkShop v4.0
- Estructura modular simplificada
- Comentarios consolidados en MOD-099
*/
// MOD-099: FIN


// ============================================
// ARCHIVO 6/24: 2testback.gs
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/2testback.gs
// ============================================

/*
******************************************
PBE CONTROL - 2testback.gs - V01.18
Sistema de Gestión Académica
04/01/2026 - 23:30
******************************************

CONTENIDO:
- PARTE 1: Limpieza de datos de prueba
- PARTE 2: Batería de 38 casos de prueba
- PARTE 3: Función principal ejecutarTodasLasPruebas()

CAMBIOS EN V01.18:
✅ TEST01: Crear 6 alumnos (agregado TEST06)
✅ NUEVO test08g: Llenar TEST06 con data completa
✅ TEST32 (ahora 33): Eliminar TEST06 en lugar de TEST05
✅ Total: 37 → 38 tests
✅ Conserva evidencias de TEST05 para pruebas robustas

CAMBIOS EN V01.15:
✅ 5 nuevos tests de validación (08b-08f)
✅ Corrección TEST 25: horaInicio → horaIni
✅ Total: 32 → 37 tests

******************************************
*/

// ==========================================
// CONFIGURACIÓN
// ==========================================

// SS y SHEET ya están definidos en 1db.gs
// No redefinir para evitar conflictos

// ==========================================
// PARTE 1: LIMPIEZA DE DATOS DE PRUEBA
// ==========================================

function limpiarDatosPrueba() {
  try {
    var hojas = ['Alumnos', 'Clientes', 'Cursos', 'Repasos', 'Eval', 'Tareas', 'Lecturas', 'HorarioClases', 'HorarioSem'];
    var totalEliminados = 0;
    
    hojas.forEach(function(nombreHoja) {
      var sheet = SHEET[nombreHoja];
      if (!sheet) return;
      
      var data = sheet.getDataRange().getValues();
      for (var i = data.length - 1; i >= 1; i--) {
        var codeAlum = String(data[i][1]);
        if (codeAlum.indexOf('TEST') === 0) {
          sheet.deleteRow(i + 1);
          totalEliminados++;
        }
      }
    });
    
    return { passed: true, nombre: '🧹 Limpieza de datos', mensaje: totalEliminados + ' registros TEST eliminados correctamente' };
  } catch(error) {
    Logger.log('Error en limpiarDatosPrueba(): ' + error.toString());
    return { passed: false, nombre: '🧹 Limpieza de datos', mensaje: 'ERROR: ' + error.toString() };
  }
}

// ========== TESTS 01-03: ADMIN + ALUMNOS ==========

function test01_CrearAlumnos() {
  try {
    var alumnos = [
      { codeAlum: 'TEST01', clave: 'test1', apellidos: 'Test Uno', nombres: 'Alumno', dni: '11111111', email: 'test1@pbe.com', tipoInsti: 'Universidad', nomInsti: 'Test University', ciclo: '1' },
      { codeAlum: 'TEST02', clave: 'test2', apellidos: 'Test Dos', nombres: 'Alumno', dni: '22222222', email: 'test2@pbe.com', tipoInsti: 'Universidad', nomInsti: 'Test University', ciclo: '2' },
      { codeAlum: 'TEST03', clave: 'test3', apellidos: 'Test Tres', nombres: 'Alumno', dni: '33333333', email: 'test3@pbe.com', tipoInsti: 'Colegio', nomInsti: 'Test School', ciclo: '3' },
      { codeAlum: 'TEST04', clave: 'test4', apellidos: 'Test Cuatro', nombres: 'Alumno', dni: '44444444', email: 'test4@pbe.com', tipoInsti: 'Instituto', nomInsti: 'Test Institute', ciclo: '4' },
      { codeAlum: 'TEST05', clave: 'test5', apellidos: 'Test Cinco', nombres: 'Alumno', dni: '55555555', email: 'test5@pbe.com', tipoInsti: 'Academia', nomInsti: 'Test Academy', ciclo: '5' },
      { codeAlum: 'TEST06', clave: 'test6', apellidos: 'Test Seis', nombres: 'Alumno', dni: '66666666', email: 'test6@pbe.com', tipoInsti: 'Universidad', nomInsti: 'Test University', ciclo: '6' }
    ];
    
    var creados = 0;
    for (var i = 0; i < alumnos.length; i++) {
      if (Admin.crearAlumno(alumnos[i]).success) creados++;
    }
    
    return creados === 6
      ? { passed: true, nombre: 'TEST 01: Crear 6 alumnos', mensaje: '✓ 6 alumnos creados (TEST01-TEST06)' }
      : { passed: false, nombre: 'TEST 01: Crear 6 alumnos', mensaje: 'FALLÓ: Solo ' + creados + ' de 6' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 01: Crear 6 alumnos', mensaje: 'ERROR: ' + error };
  }
}

function test02_ValidarUnicidadCodeAlum() {
  try {
    var result = Admin.crearAlumno({ codeAlum: 'TEST01', clave: 'test999', apellidos: 'Duplicado', nombres: 'Test', dni: '99999999', email: 'dup@pbe.com' });
    return !result.success && result.error.indexOf('CodeAlum ya existe') !== -1
      ? { passed: true, nombre: 'TEST 02: Unicidad CodeAlum', mensaje: '✓ Sistema rechazó duplicado' }
      : { passed: false, nombre: 'TEST 02: Unicidad CodeAlum', mensaje: 'FALLÓ: Permitió duplicado' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 02: Unicidad CodeAlum', mensaje: 'ERROR: ' + error };
  }
}

function test03_ValidarUnicidadClave() {
  try {
    var result = Admin.crearAlumno({ codeAlum: 'TEST99', clave: 'test1', apellidos: 'Dup Clave', nombres: 'Test', dni: '88888888', email: 'dupclave@pbe.com' });
    return !result.success && result.error.indexOf('Clave ya existe') !== -1
      ? { passed: true, nombre: 'TEST 03: Unicidad Clave', mensaje: '✓ Sistema rechazó Clave duplicada' }
      : { passed: false, nombre: 'TEST 03: Unicidad Clave', mensaje: 'FALLÓ: Permitió Clave duplicada' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 03: Unicidad Clave', mensaje: 'ERROR: ' + error };
  }
}

// ========== TESTS 04-08: CREATE STUDENT (TEST05) ==========

function test04_AgregarCursos() {
  try {
    var cursos = [
      { curso: 'MATE', completo: 'Matemáticas', color: '#FF5733' },
      { curso: 'FIS', completo: 'Física', color: '#3498DB' },
      { curso: 'QUIM', completo: 'Química', color: '#2ECC71' },
      { curso: 'BIOL', completo: 'Biología', color: '#F1C40F' },
      { curso: 'HIST', completo: 'Historia', color: '#9B59B6' },
      { curso: 'ING', completo: 'Inglés', color: '#E67E22' }
    ];
    
    var agregados = 0;
    for (var i = 0; i < cursos.length; i++) {
      if (Student.agregarCurso({ codeAlum: 'TEST05', curso: cursos[i].curso, completo: cursos[i].completo, color: cursos[i].color }).success) agregados++;
    }
    
    return agregados === 6
      ? { passed: true, nombre: 'TEST 04: Agregar 6 cursos (TEST05)', mensaje: '✓ 6 cursos agregados (MATE, FIS, QUIM, BIOL, HIST, ING)' }
      : { passed: false, nombre: 'TEST 04: Agregar 6 cursos (TEST05)', mensaje: 'FALLÓ: Solo ' + agregados + ' de 6' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 04: Agregar 6 cursos (TEST05)', mensaje: 'ERROR: ' + error };
  }
}

function test05_AgregarRepasos() {
  try {
    var repasos = [
      { curso: 'MATE', tema: 'Derivadas', estadoRep: 'OK', evaluado: 'Si' },
      { curso: 'MATE', tema: 'Integrales', estadoRep: 'OK', evaluado: '' },
      { curso: 'FIS', tema: 'Cinemática', estadoRep: 'OK', evaluado: '' },
      { curso: 'QUIM', tema: 'Estequiometría', estadoRep: 'OK', evaluado: 'Si' },
      { curso: 'BIOL', tema: 'Genética', estadoRep: 'Falta', evaluado: '' },
      { curso: 'HIST', tema: 'Revolución Francesa', estadoRep: 'Falta', evaluado: '' },
      { curso: 'ING', tema: 'Present Perfect', estadoRep: 'Falta', evaluado: '' },
      { curso: 'MATE', tema: 'Límites', estadoRep: 'Falta', evaluado: '' }
    ];
    
    var agregados = 0;
    for (var i = 0; i < repasos.length; i++) {
      if (Student.agregarRepaso({ codeAlum: 'TEST05', curso: repasos[i].curso, tema: repasos[i].tema, fechaClase: '01/01/2026', fechaRep: '02/01/2026', estadoRep: repasos[i].estadoRep, detalle: 'Repaso de prueba', evaluado: repasos[i].evaluado }).success) agregados++;
    }
    
    return agregados === 8
      ? { passed: true, nombre: 'TEST 05: Agregar 8 repasos (TEST05)', mensaje: '✓ 8 repasos (4 OK, 4 Falta, 2 evaluados)' }
      : { passed: false, nombre: 'TEST 05: Agregar 8 repasos (TEST05)', mensaje: 'FALLÓ: Solo ' + agregados + ' de 8' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 05: Agregar 8 repasos (TEST05)', mensaje: 'ERROR: ' + error };
  }
}

function test06_AgregarEvaluaciones() {
  try {
    var evaluaciones = [
      { curso: 'MATE', nomEval: 'Parcial 1', nota: 18, peso: 30 },
      { curso: 'FIS', nomEval: 'Práctica 1', nota: 16, peso: 20 },
      { curso: 'QUIM', nomEval: 'Examen Final', nota: 15, peso: 40 },
      { curso: 'BIOL', nomEval: 'Trabajo Grupal', nota: 17, peso: 25 },
      { curso: 'HIST', nomEval: 'Exposición', nota: 19, peso: 35 }
    ];
    
    var agregados = 0;
    for (var i = 0; i < evaluaciones.length; i++) {
      if (Student.agregarEvaluacion({ codeAlum: 'TEST05', curso: evaluaciones[i].curso, nomEval: evaluaciones[i].nomEval, fechaEval: '15/01/2026', nota: evaluaciones[i].nota, peso: evaluaciones[i].peso, sem: 1 }).success) agregados++;
    }
    
    return agregados === 5
      ? { passed: true, nombre: 'TEST 06: Agregar 5 evaluaciones (TEST05)', mensaje: '✓ 5 evaluaciones (notas 15-19)' }
      : { passed: false, nombre: 'TEST 06: Agregar 5 evaluaciones (TEST05)', mensaje: 'FALLÓ: Solo ' + agregados + ' de 5' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 06: Agregar 5 evaluaciones (TEST05)', mensaje: 'ERROR: ' + error };
  }
}

function test07_AgregarTareas() {
  try {
    var tareas = [
      { curso: 'MATE', tarea: 'Tarea 1: Ejercicios Cap 3', fechaEntrega: '10/01/2026', nota: 17, peso: 10 },
      { curso: 'FIS', tarea: 'Tarea 2: Problemas Cinemática', fechaEntrega: '12/01/2026', nota: 16, peso: 15 },
      { curso: 'QUIM', tarea: 'Tarea 3: Laboratorio Virtual', fechaEntrega: '14/01/2026', nota: 18, peso: 12 }
    ];
    
    var agregados = 0;
    for (var i = 0; i < tareas.length; i++) {
      if (Student.agregarTarea({ codeAlum: 'TEST05', curso: tareas[i].curso, tarea: tareas[i].tarea, fechaEntrega: tareas[i].fechaEntrega, fechaAccion: '03/01/2026', nota: tareas[i].nota, peso: tareas[i].peso, sem: 1 }).success) agregados++;
    }
    
    return agregados === 3
      ? { passed: true, nombre: 'TEST 07: Agregar 3 tareas (TEST05)', mensaje: '✓ 3 tareas (fechas distintas)' }
      : { passed: false, nombre: 'TEST 07: Agregar 3 tareas (TEST05)', mensaje: 'FALLÓ: Solo ' + agregados + ' de 3' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 07: Agregar 3 tareas (TEST05)', mensaje: 'ERROR: ' + error };
  }
}

function test08_AgregarLecturas() {
  try {
    var lecturas = [
      { curso: 'HIST', lectura: 'Historia del Perú - Basadre', cantPag: 500, pagActual: 250, nota: 16, peso: 20 },
      { curso: 'ING', lectura: 'The Great Gatsby', cantPag: 180, pagActual: 90, nota: 18, peso: 15 }
    ];
    
    var agregados = 0;
    for (var i = 0; i < lecturas.length; i++) {
      if (Student.agregarLectura({ codeAlum: 'TEST05', curso: lecturas[i].curso, lectura: lecturas[i].lectura, cantPag: lecturas[i].cantPag, pagActual: lecturas[i].pagActual, fechaInicio: '01/01/2026', fechaFin: '31/01/2026', fechaEval: '05/02/2026', nota: lecturas[i].nota, peso: lecturas[i].peso, sem: 1 }).success) agregados++;
    }
    
    return agregados === 2
      ? { passed: true, nombre: 'TEST 08: Agregar 2 lecturas (TEST05)', mensaje: '✓ 2 lecturas (progreso 50%)' }
      : { passed: false, nombre: 'TEST 08: Agregar 2 lecturas (TEST05)', mensaje: 'FALLÓ: Solo ' + agregados + ' de 2' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 08: Agregar 2 lecturas (TEST05)', mensaje: 'ERROR: ' + error };
  }
}

// ========== TESTS 08b-08f: VALIDACIONES DE UNICIDAD (TEST05) ==========

function test08b_ValidarUnicidadCurso() {
  try {
    var result = Student.agregarCurso({ codeAlum: 'TEST05', curso: 'MATE', completo: 'Lógica Matemática', color: '#FF0000' });
    return !result.success && result.error.indexOf('ya existe') !== -1
      ? { passed: true, nombre: 'TEST 08b: Unicidad Curso', mensaje: '✓ Sistema rechazó curso duplicado' }
      : { passed: false, nombre: 'TEST 08b: Unicidad Curso', mensaje: 'FALLÓ: Permitió curso duplicado' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 08b: Unicidad Curso', mensaje: 'ERROR: ' + error };
  }
}

function test08c_ValidarUnicidadRepaso() {
  try {
    var result = Student.agregarRepaso({ codeAlum: 'TEST05', curso: 'MATE', tema: 'Derivadas', fechaClase: '01/01/2026', fechaRep: '02/01/2026', estadoRep: 'OK' });
    return !result.success && result.error.indexOf('ya existe') !== -1
      ? { passed: true, nombre: 'TEST 08c: Unicidad Repaso', mensaje: '✓ Sistema rechazó repaso duplicado' }
      : { passed: false, nombre: 'TEST 08c: Unicidad Repaso', mensaje: 'FALLÓ: Permitió repaso duplicado' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 08c: Unicidad Repaso', mensaje: 'ERROR: ' + error };
  }
}

function test08d_ValidarUnicidadEvaluacion() {
  try {
    var result = Student.agregarEvaluacion({ codeAlum: 'TEST05', curso: 'MATE', nomEval: 'Parcial 1', fechaEval: '20/01/2026', nota: 20, peso: 40, sem: 1 });
    return !result.success && result.error.indexOf('ya existe') !== -1
      ? { passed: true, nombre: 'TEST 08d: Unicidad Evaluación', mensaje: '✓ Sistema rechazó evaluación duplicada' }
      : { passed: false, nombre: 'TEST 08d: Unicidad Evaluación', mensaje: 'FALLÓ: Permitió evaluación duplicada' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 08d: Unicidad Evaluación', mensaje: 'ERROR: ' + error };
  }
}

function test08e_ValidarUnicidadTarea() {
  try {
    var result = Student.agregarTarea({ codeAlum: 'TEST05', curso: 'MATE', tarea: 'Tarea 1: Ejercicios Cap 3', fechaEntrega: '15/01/2026', fechaAccion: '05/01/2026', nota: 19, peso: 15, sem: 1 });
    return !result.success && result.error.indexOf('ya existe') !== -1
      ? { passed: true, nombre: 'TEST 08e: Unicidad Tarea', mensaje: '✓ Sistema rechazó tarea duplicada' }
      : { passed: false, nombre: 'TEST 08e: Unicidad Tarea', mensaje: 'FALLÓ: Permitió tarea duplicada' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 08e: Unicidad Tarea', mensaje: 'ERROR: ' + error };
  }
}

function test08f_ValidarUnicidadLectura() {
  try {
    var result = Student.agregarLectura({ codeAlum: 'TEST05', curso: 'HIST', lectura: 'Historia del Perú - Basadre', cantPag: 600, pagActual: 300, fechaInicio: '05/01/2026', fechaFin: '05/02/2026', fechaEval: '10/02/2026', nota: 17, peso: 25, sem: 1 });
    return !result.success && result.error.indexOf('ya existe') !== -1
      ? { passed: true, nombre: 'TEST 08f: Unicidad Lectura', mensaje: '✓ Sistema rechazó lectura duplicada' }
      : { passed: false, nombre: 'TEST 08f: Unicidad Lectura', mensaje: 'FALLÓ: Permitió lectura duplicada' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 08f: Unicidad Lectura', mensaje: 'ERROR: ' + error };
  }
}

// ========== TEST 08g: NUEVO - LLENAR TEST06 CON DATA COMPLETA ==========

function test08g_LlenarTest06() {
  try {
    var totalAgregados = 0;
    
    // Agregar 3 cursos a TEST06
    var cursos = [
      { curso: 'ALG', completo: 'Álgebra', color: '#E74C3C' },
      { curso: 'GEO', completo: 'Geometría', color: '#3498DB' },
      { curso: 'TRIG', completo: 'Trigonometría', color: '#2ECC71' }
    ];
    for (var i = 0; i < cursos.length; i++) {
      if (Student.agregarCurso({ codeAlum: 'TEST06', curso: cursos[i].curso, completo: cursos[i].completo, color: cursos[i].color }).success) totalAgregados++;
    }
    
    // Agregar 4 repasos a TEST06
    var repasos = [
      { curso: 'ALG', tema: 'Ecuaciones', estadoRep: 'OK' },
      { curso: 'ALG', tema: 'Matrices', estadoRep: 'Falta' },
      { curso: 'GEO', tema: 'Triángulos', estadoRep: 'OK' },
      { curso: 'TRIG', tema: 'Identidades', estadoRep: 'OK' }
    ];
    for (var i = 0; i < repasos.length; i++) {
      if (Student.agregarRepaso({ codeAlum: 'TEST06', curso: repasos[i].curso, tema: repasos[i].tema, fechaClase: '02/01/2026', fechaRep: '03/01/2026', estadoRep: repasos[i].estadoRep, detalle: 'Repaso TEST06', evaluado: '' }).success) totalAgregados++;
    }
    
    // Agregar 3 evaluaciones a TEST06
    var evaluaciones = [
      { curso: 'ALG', nomEval: 'Examen 1', nota: 16, peso: 40 },
      { curso: 'GEO', nomEval: 'Práctica 1', nota: 18, peso: 30 },
      { curso: 'TRIG', nomEval: 'Final', nota: 17, peso: 50 }
    ];
    for (var i = 0; i < evaluaciones.length; i++) {
      if (Student.agregarEvaluacion({ codeAlum: 'TEST06', curso: evaluaciones[i].curso, nomEval: evaluaciones[i].nomEval, fechaEval: '16/01/2026', nota: evaluaciones[i].nota, peso: evaluaciones[i].peso, sem: 1 }).success) totalAgregados++;
    }
    
    // Agregar 2 tareas a TEST06
    var tareas = [
      { curso: 'ALG', tarea: 'Tarea 1: Polinomios', fechaEntrega: '11/01/2026', nota: 19, peso: 10 },
      { curso: 'GEO', tarea: 'Tarea 2: Áreas', fechaEntrega: '13/01/2026', nota: 18, peso: 15 }
    ];
    for (var i = 0; i < tareas.length; i++) {
      if (Student.agregarTarea({ codeAlum: 'TEST06', curso: tareas[i].curso, tarea: tareas[i].tarea, fechaEntrega: tareas[i].fechaEntrega, fechaAccion: '04/01/2026', nota: tareas[i].nota, peso: tareas[i].peso, sem: 1 }).success) totalAgregados++;
    }
    
    // Agregar 1 lectura a TEST06
    var lecturas = [
      { curso: 'TRIG', lectura: 'Trigonometría - Venero', cantPag: 300, pagActual: 150, nota: 17, peso: 20 }
    ];
    for (var i = 0; i < lecturas.length; i++) {
      if (Student.agregarLectura({ codeAlum: 'TEST06', curso: lecturas[i].curso, lectura: lecturas[i].lectura, cantPag: lecturas[i].cantPag, pagActual: lecturas[i].pagActual, fechaInicio: '02/01/2026', fechaFin: '31/01/2026', fechaEval: '06/02/2026', nota: lecturas[i].nota, peso: lecturas[i].peso, sem: 1 }).success) totalAgregados++;
    }
    
    var esperados = 3 + 4 + 3 + 2 + 1; // 13 registros totales
    
    return totalAgregados === esperados
      ? { passed: true, nombre: 'TEST 08g: Llenar TEST06', mensaje: '✓ TEST06 llenado con 13 registros (3 cursos, 4 repasos, 3 eval, 2 tareas, 1 lectura)' }
      : { passed: false, nombre: 'TEST 08g: Llenar TEST06', mensaje: 'FALLÓ: Solo ' + totalAgregados + ' de ' + esperados + ' registros agregados' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 08g: Llenar TEST06', mensaje: 'ERROR: ' + error };
  }
}

// ========== TESTS 09-14: READ STUDENT (TEST05) ==========

function test09_BuscarAlumno() {
  try {
    var result = DB.buscar('Alumnos', 'Clave', 'test1');
    return result.success && result.data.CodeAlum === 'TEST01'
      ? { passed: true, nombre: 'TEST 09: Buscar alumno', mensaje: '✓ TEST01 encontrado por Clave' }
      : { passed: false, nombre: 'TEST 09: Buscar alumno', mensaje: 'FALLÓ: No encontrado' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 09: Buscar alumno', mensaje: 'ERROR: ' + error };
  }
}

function test10_ObtenerCursos() {
  try {
    var result = Student.obtenerCursos({ codeAlum: 'TEST05' });
    return result.success && result.data.length === 6
      ? { passed: true, nombre: 'TEST 10: Obtener cursos', mensaje: '✓ 6 cursos obtenidos' }
      : { passed: false, nombre: 'TEST 10: Obtener cursos', mensaje: 'FALLÓ: ' + (result.data ? result.data.length : 0) };
  } catch(error) {
    return { passed: false, nombre: 'TEST 10: Obtener cursos', mensaje: 'ERROR: ' + error };
  }
}

function test11_ObtenerRepasos() {
  try {
    var result = Student.obtenerRepasos({ codeAlum: 'TEST05' });
    return result.success && result.data.length === 8
      ? { passed: true, nombre: 'TEST 11: Obtener repasos', mensaje: '✓ 8 repasos obtenidos' }
      : { passed: false, nombre: 'TEST 11: Obtener repasos', mensaje: 'FALLÓ: ' + (result.data ? result.data.length : 0) };
  } catch(error) {
    return { passed: false, nombre: 'TEST 11: Obtener repasos', mensaje: 'ERROR: ' + error };
  }
}

function test12_ObtenerEvaluaciones() {
  try {
    var result = Student.obtenerEvaluaciones({ codeAlum: 'TEST05' });
    return result.success && result.data.length === 5
      ? { passed: true, nombre: 'TEST 12: Obtener evaluaciones', mensaje: '✓ 5 evaluaciones obtenidas' }
      : { passed: false, nombre: 'TEST 12: Obtener evaluaciones', mensaje: 'FALLÓ: ' + (result.data ? result.data.length : 0) };
  } catch(error) {
    return { passed: false, nombre: 'TEST 12: Obtener evaluaciones', mensaje: 'ERROR: ' + error };
  }
}

function test13_ObtenerTareas() {
  try {
    var result = Student.obtenerTareas({ codeAlum: 'TEST05' });
    return result.success && result.data.length === 3
      ? { passed: true, nombre: 'TEST 13: Obtener tareas', mensaje: '✓ 3 tareas obtenidas' }
      : { passed: false, nombre: 'TEST 13: Obtener tareas', mensaje: 'FALLÓ: ' + (result.data ? result.data.length : 0) };
  } catch(error) {
    return { passed: false, nombre: 'TEST 13: Obtener tareas', mensaje: 'ERROR: ' + error };
  }
}

function test14_ObtenerLecturas() {
  try {
    var result = Student.obtenerLecturas({ codeAlum: 'TEST05' });
    return result.success && result.data.length === 2
      ? { passed: true, nombre: 'TEST 14: Obtener lecturas', mensaje: '✓ 2 lecturas obtenidas' }
      : { passed: false, nombre: 'TEST 14: Obtener lecturas', mensaje: 'FALLÓ: ' + (result.data ? result.data.length : 0) };
  } catch(error) {
    return { passed: false, nombre: 'TEST 14: Obtener lecturas', mensaje: 'ERROR: ' + error };
  }
}

// ========== TESTS 15-19: UPDATE STUDENT (TEST05) ==========

function test15_ActualizarCurso() {
  try {
    var cursos = Student.obtenerCursos({ codeAlum: 'TEST05' });
    if (!cursos.success) return { passed: false, nombre: 'TEST 15: Actualizar curso', mensaje: 'FALLÓ: No se pudieron obtener cursos' };
    
    var cursoMate = null;
    for (var i = 0; i < cursos.data.length; i++) {
      if (cursos.data[i].Curso === 'MATE') {
        cursoMate = cursos.data[i];
        break;
      }
    }
    
    if (!cursoMate) return { passed: false, nombre: 'TEST 15: Actualizar curso', mensaje: 'FALLÓ: Curso MATE no encontrado' };
    
    var result = Student.actualizarCurso({ codeAlum: 'TEST05', rowNumber: cursoMate._rowNumber, curso: 'MATE', completo: 'MATEMATICAS', color: cursoMate.Color });
    
    return result.success
      ? { passed: true, nombre: 'TEST 15: Actualizar curso', mensaje: '✓ Curso MATE actualizado a MATEMATICAS' }
      : { passed: false, nombre: 'TEST 15: Actualizar curso', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 15: Actualizar curso', mensaje: 'ERROR: ' + error };
  }
}

function test16_ActualizarRepaso() {
  try {
    var repasos = Student.obtenerRepasos({ codeAlum: 'TEST05' });
    if (!repasos.success) return { passed: false, nombre: 'TEST 16: Actualizar repaso', mensaje: 'FALLÓ: No se pudieron obtener repasos' };
    
    var repasoFalta = null;
    for (var i = 0; i < repasos.data.length; i++) {
      if (repasos.data[i].EstadoRep === 'Falta') {
        repasoFalta = repasos.data[i];
        break;
      }
    }
    
    if (!repasoFalta) return { passed: false, nombre: 'TEST 16: Actualizar repaso', mensaje: 'FALLÓ: Repaso con estado Falta no encontrado' };
    
    var result = Student.actualizarRepaso({ codeAlum: 'TEST05', rowNumber: repasoFalta._rowNumber, curso: repasoFalta.Curso, tema: repasoFalta.Tema, fechaClase: repasoFalta.FechaClase, fechaRep: repasoFalta.FechaRep, estadoRep: 'OK', detalle: repasoFalta.Detalle, evaluado: repasoFalta.Evaluado });
    
    return result.success
      ? { passed: true, nombre: 'TEST 16: Actualizar repaso', mensaje: '✓ Estado Falta → OK actualizado' }
      : { passed: false, nombre: 'TEST 16: Actualizar repaso', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 16: Actualizar repaso', mensaje: 'ERROR: ' + error };
  }
}

function test17_ActualizarEvaluacion() {
  try {
    var evals = Student.obtenerEvaluaciones({ codeAlum: 'TEST05' });
    if (!evals.success) return { passed: false, nombre: 'TEST 17: Actualizar evaluación', mensaje: 'FALLÓ: No se pudieron obtener evaluaciones' };
    
    var evalQuim = null;
    for (var i = 0; i < evals.data.length; i++) {
      if (evals.data[i].Curso === 'QUIM' && evals.data[i].Nota === 15) {
        evalQuim = evals.data[i];
        break;
      }
    }
    
    if (!evalQuim) return { passed: false, nombre: 'TEST 17: Actualizar evaluación', mensaje: 'FALLÓ: Evaluación QUIM nota 15 no encontrada' };
    
    var result = Student.actualizarEvaluacion({ codeAlum: 'TEST05', rowNumber: evalQuim._rowNumber, curso: evalQuim.Curso, nomEval: evalQuim.NomEval, fechaEval: evalQuim.FechaEval, nota: 18, peso: evalQuim.Peso, sem: evalQuim.Sem });
    
    return result.success
      ? { passed: true, nombre: 'TEST 17: Actualizar evaluación', mensaje: '✓ Nota 15 → 18 actualizada' }
      : { passed: false, nombre: 'TEST 17: Actualizar evaluación', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 17: Actualizar evaluación', mensaje: 'ERROR: ' + error };
  }
}

function test18_ActualizarTarea() {
  try {
    var tareas = Student.obtenerTareas({ codeAlum: 'TEST05' });
    if (!tareas.success || tareas.data.length === 0) return { passed: false, nombre: 'TEST 18: Actualizar tarea', mensaje: 'FALLÓ: No se pudieron obtener tareas' };
    
    var tarea = tareas.data[0];
    var result = Student.actualizarTarea({ codeAlum: 'TEST05', rowNumber: tarea._rowNumber, curso: tarea.Curso, tarea: tarea.Tarea, fechaEntrega: '20/01/2026', fechaAccion: tarea.FechaAccion, nota: tarea.Nota, peso: tarea.Peso, sem: tarea.Sem });
    
    return result.success
      ? { passed: true, nombre: 'TEST 18: Actualizar tarea', mensaje: '✓ Fecha entrega actualizada a 20/01/2026' }
      : { passed: false, nombre: 'TEST 18: Actualizar tarea', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 18: Actualizar tarea', mensaje: 'ERROR: ' + error };
  }
}

function test19_ActualizarLectura() {
  try {
    var lecturas = Student.obtenerLecturas({ codeAlum: 'TEST05' });
    if (!lecturas.success || lecturas.data.length === 0) return { passed: false, nombre: 'TEST 19: Actualizar lectura', mensaje: 'FALLÓ: No se pudieron obtener lecturas' };
    
    var lectura = lecturas.data[0];
    var nuevoProgreso = Math.floor(lectura.CantPag * 0.75);
    var result = Student.actualizarLectura({ codeAlum: 'TEST05', rowNumber: lectura._rowNumber, curso: lectura.Curso, lectura: lectura.Lectura, cantPag: lectura.CantPag, pagActual: nuevoProgreso, fechaInicio: lectura.FechaInicio, fechaFin: lectura.FechaFin, fechaEval: lectura.FechaEval, nota: lectura.Nota, peso: lectura.Peso, sem: lectura.Sem });
    
    return result.success
      ? { passed: true, nombre: 'TEST 19: Actualizar lectura', mensaje: '✓ Progreso actualizado a 75%' }
      : { passed: false, nombre: 'TEST 19: Actualizar lectura', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 19: Actualizar lectura', mensaje: 'ERROR: ' + error };
  }
}

// ========== TESTS 20-24: DELETE STUDENT (TEST05) ==========

function test20_EliminarCurso() {
  try {
    var cursos = Student.obtenerCursos({ codeAlum: 'TEST05' });
    if (!cursos.success) return { passed: false, nombre: 'TEST 20: Eliminar curso', mensaje: 'FALLÓ: No se pudieron obtener cursos' };
    
    var cursoIng = null;
    for (var i = 0; i < cursos.data.length; i++) {
      if (cursos.data[i].Curso === 'ING') {
        cursoIng = cursos.data[i];
        break;
      }
    }
    
    if (!cursoIng) return { passed: false, nombre: 'TEST 20: Eliminar curso', mensaje: 'FALLÓ: Curso ING no encontrado' };
    
    var result = Student.eliminarCurso({ codeAlum: 'TEST05', rowNumber: cursoIng._rowNumber });
    
    return result.success
      ? { passed: true, nombre: 'TEST 20: Eliminar curso', mensaje: '✓ Curso ING eliminado correctamente' }
      : { passed: false, nombre: 'TEST 20: Eliminar curso', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 20: Eliminar curso', mensaje: 'ERROR: ' + error };
  }
}

function test21_EliminarRepaso() {
  try {
    var repasos = Student.obtenerRepasos({ codeAlum: 'TEST05' });
    if (!repasos.success || repasos.data.length === 0) return { passed: false, nombre: 'TEST 21: Eliminar repaso', mensaje: 'FALLÓ: No hay repasos' };
    
    var result = Student.eliminarRepaso({ codeAlum: 'TEST05', rowNumber: repasos.data[0]._rowNumber });
    
    return result.success
      ? { passed: true, nombre: 'TEST 21: Eliminar repaso', mensaje: '✓ Repaso eliminado correctamente' }
      : { passed: false, nombre: 'TEST 21: Eliminar repaso', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 21: Eliminar repaso', mensaje: 'ERROR: ' + error };
  }
}

function test22_EliminarEvaluacion() {
  try {
    var evals = Student.obtenerEvaluaciones({ codeAlum: 'TEST05' });
    if (!evals.success || evals.data.length === 0) return { passed: false, nombre: 'TEST 22: Eliminar evaluación', mensaje: 'FALLÓ: No hay evaluaciones' };
    
    var result = Student.eliminarEvaluacion({ codeAlum: 'TEST05', rowNumber: evals.data[0]._rowNumber });
    
    return result.success
      ? { passed: true, nombre: 'TEST 22: Eliminar evaluación', mensaje: '✓ Evaluación eliminada correctamente' }
      : { passed: false, nombre: 'TEST 22: Eliminar evaluación', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 22: Eliminar evaluación', mensaje: 'ERROR: ' + error };
  }
}

function test23_EliminarTarea() {
  try {
    var tareas = Student.obtenerTareas({ codeAlum: 'TEST05' });
    if (!tareas.success || tareas.data.length === 0) return { passed: false, nombre: 'TEST 23: Eliminar tarea', mensaje: 'FALLÓ: No hay tareas' };
    
    var result = Student.eliminarTarea({ codeAlum: 'TEST05', rowNumber: tareas.data[0]._rowNumber });
    
    return result.success
      ? { passed: true, nombre: 'TEST 23: Eliminar tarea', mensaje: '✓ Tarea eliminada correctamente' }
      : { passed: false, nombre: 'TEST 23: Eliminar tarea', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 23: Eliminar tarea', mensaje: 'ERROR: ' + error };
  }
}

function test24_EliminarLectura() {
  try {
    var lecturas = Student.obtenerLecturas({ codeAlum: 'TEST05' });
    if (!lecturas.success || lecturas.data.length === 0) return { passed: false, nombre: 'TEST 24: Eliminar lectura', mensaje: 'FALLÓ: No hay lecturas' };
    
    var result = Student.eliminarLectura({ codeAlum: 'TEST05', rowNumber: lecturas.data[0]._rowNumber });
    
    return result.success
      ? { passed: true, nombre: 'TEST 24: Eliminar lectura', mensaje: '✓ Lectura eliminada correctamente' }
      : { passed: false, nombre: 'TEST 24: Eliminar lectura', mensaje: 'FALLÓ: ' + result.error };
  } catch(error) {
    return { passed: false, nombre: 'TEST 24: Eliminar lectura', mensaje: 'ERROR: ' + error };
  }
}

// ========== TESTS 25-27: HORARIOS (TEST05) ==========

function test25_AgregarHorarios() {
  try {
    var horarios = [
      { curso: 'MATE', horaInicio: '08:00', horaFin: '10:00', detalle: 'Lunes' },
      { curso: 'FIS', horaInicio: '10:00', horaFin: '12:00', detalle: 'Martes' },
      { curso: 'QUIM', horaInicio: '14:00', horaFin: '16:00', detalle: 'Miércoles' }
    ];
    
    var agregados = 0;
    for (var i = 0; i < horarios.length; i++) {
      if (Student.agregarHorarioClase({ codeAlum: 'TEST05', curso: horarios[i].curso, horaIni: horarios[i].horaInicio, horaFin: horarios[i].horaFin, detalle: horarios[i].detalle }).success) agregados++;
    }
    
    return agregados === 3
      ? { passed: true, nombre: 'TEST 25: Agregar horarios', mensaje: '✓ 3 horarios de clase agregados' }
      : { passed: false, nombre: 'TEST 25: Agregar horarios', mensaje: 'FALLÓ: Solo ' + agregados + ' de 3' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 25: Agregar horarios', mensaje: 'ERROR: ' + error };
  }
}

function test26_VerificarMapeoHora() {
  try {
    var result = Student.obtenerHorarioClases({ codeAlum: 'TEST05' });
    
    if (!result.success || result.data.length === 0) return { passed: false, nombre: 'TEST 26: Mapeo HoraInicio→HoraIni', mensaje: 'FALLÓ: No hay horarios' };
    
    var primerHorario = result.data[0];
    var tieneHoraIni = primerHorario.hasOwnProperty('HoraIni');
    var noTieneHoraInicio = !primerHorario.hasOwnProperty('HoraInicio');
    
    return tieneHoraIni && noTieneHoraInicio
      ? { passed: true, nombre: 'TEST 26: Mapeo HoraInicio→HoraIni', mensaje: '✓ Mapeo correcto: HoraInicio→HoraIni' }
      : { passed: false, nombre: 'TEST 26: Mapeo HoraInicio→HoraIni', mensaje: 'FALLÓ: Mapeo incorrecto o ausente' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 26: Mapeo HoraInicio→HoraIni', mensaje: 'ERROR: ' + error };
  }
}

// ========== TEST 27: HORARIO SEMANAL ==========

function test27_HorarioSemanal() {
  try {
    // ==========================================
    // Agregar 2 actividades a HorarioSem
    // ==========================================
    
    var actividad1 = Student.agregarHorarioSem({ 
      codeAlum: 'TEST05', 
      actividad: 'Repaso MATE', 
      horaInicio: '15:00', 
      horaFin: '17:00', 
      fechaHS: '06/01/2026', 
      tipoAct: 'Repaso', 
      color: '#FFC107', 
      sem: 1 
    });
    
    var actividad2 = Student.agregarHorarioSem({ 
      codeAlum: 'TEST05', 
      actividad: 'Estudio FIS', 
      horaInicio: '18:00', 
      horaFin: '20:00', 
      fechaHS: '07/01/2026', 
      tipoAct: 'Estudio', 
      color: '#28A745', 
      sem: 1 
    });
    
    if (!actividad1.success || !actividad2.success) {
      return { 
        passed: false, 
        nombre: 'TEST 27: Horario semanal', 
        mensaje: 'FALLÓ: No se pudieron agregar las 2 actividades' 
      };
    }
    
    // ==========================================
    // Verificar que se agregaron correctamente
    // ==========================================
    
    var horarios = Student.obtenerHorarioSem({ codeAlum: 'TEST05' });
    
    if (!horarios.success || horarios.data.length < 2) {
      return { 
        passed: false, 
        nombre: 'TEST 27: Horario semanal', 
        mensaje: 'FALLÓ: No se encontraron las 2 actividades agregadas' 
      };
    }
    
    // ==========================================
    // Eliminar solo la primera actividad
    // ==========================================
    
    var resultDel = Student.eliminarHorarioSem({ 
      codeAlum: 'TEST05', 
      rowNumber: horarios.data[0]._rowNumber 
    });
    
    if (!resultDel.success) {
      return { 
        passed: false, 
        nombre: 'TEST 27: Horario semanal', 
        mensaje: 'FALLÓ: No se pudo eliminar la primera actividad' 
      };
    }
    
    // ==========================================
    // Verificar que queda 1 registro
    // ==========================================
    
    var horariosFinales = Student.obtenerHorarioSem({ codeAlum: 'TEST05' });
    
    var quedaUno = horariosFinales.success && horariosFinales.data.length === 1;
    
    return quedaUno
      ? { 
          passed: true, 
          nombre: 'TEST 27: Horario semanal', 
          mensaje: '✓ 2 actividades agregadas, 1 eliminada, queda 1 registro en HorarioSem' 
        }
      : { 
          passed: false, 
          nombre: 'TEST 27: Horario semanal', 
          mensaje: 'FALLÓ: Debería quedar 1 registro, hay ' + (horariosFinales.data ? horariosFinales.data.length : 0) 
        };
        
  } catch(error) {
    return { 
      passed: false, 
      nombre: 'TEST 27: Horario semanal', 
      mensaje: 'ERROR: ' + error 
    };
  }
}


// ========== TESTS 28-30: FUNCIONES ESPECIALES (TEST05) ==========

function test28_PromedioPonderado() {
  try {
    var result = Student.obtenerNotasPorCurso({ codeAlum: 'TEST05', curso: 'FIS' });
    
    if (!result.success) return { passed: false, nombre: 'TEST 28: Promedio ponderado', mensaje: 'FALLÓ: ' + result.error };
    
    var tienePromedio = result.data.hasOwnProperty('promedio');
    var promedioValido = tienePromedio && parseFloat(result.data.promedio) > 0;
    
    return promedioValido
      ? { passed: true, nombre: 'TEST 28: Promedio ponderado', mensaje: '✓ Promedio FIS: ' + result.data.promedio }
      : { passed: false, nombre: 'TEST 28: Promedio ponderado', mensaje: 'FALLÓ: Promedio inválido o ausente' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 28: Promedio ponderado', mensaje: 'ERROR: ' + error };
  }
}

function test29_ResumenNotas() {
  try {
    var result = Student.obtenerResumenNotas({ codeAlum: 'TEST05' });
    
    if (!result.success) return { passed: false, nombre: 'TEST 29: Resumen notas', mensaje: 'FALLÓ: ' + result.error };
    
    var tieneCursos = result.data && result.data.length > 0;
    
    return tieneCursos
      ? { passed: true, nombre: 'TEST 29: Resumen notas', mensaje: '✓ Resumen de ' + result.data.length + ' cursos obtenido' }
      : { passed: false, nombre: 'TEST 29: Resumen notas', mensaje: 'FALLÓ: Sin datos de cursos' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 29: Resumen notas', mensaje: 'ERROR: ' + error };
  }
}

function test30_DeberesUnificados() {
  try {
    var result = Student.obtenerTodosDeberes({ codeAlum: 'TEST05' });
    
    if (!result.success) return { passed: false, nombre: 'TEST 30: Deberes unificados', mensaje: 'FALLÓ: ' + result.error };
    
    var tieneDeberes = result.data && result.data.length > 0;
    var tieneTipos = false;
    
    if (tieneDeberes) {
      var tipos = {};
      for (var i = 0; i < result.data.length; i++) {
        if (result.data[i].tipo) tipos[result.data[i].tipo] = true;
      }
      tieneTipos = Object.keys(tipos).length >= 2;
    }
    
    return tieneDeberes && tieneTipos
      ? { passed: true, nombre: 'TEST 30: Deberes unificados', mensaje: '✓ ' + result.data.length + ' deberes unificados correctamente' }
      : { passed: false, nombre: 'TEST 30: Deberes unificados', mensaje: 'FALLÓ: Unificación incompleta' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 30: Deberes unificados', mensaje: 'ERROR: ' + error };
  }
}

// ========== TEST 31: ADMIN BÚSQUEDA ==========

function test31_BusquedaAvanzada() {
  try {
    var result = Admin.buscarAlumno({ filtro: 'test' });
    
    if (!result.success) return { passed: false, nombre: 'TEST 31: Búsqueda avanzada', mensaje: 'FALLÓ: ' + result.error };
    
    var encontrados = result.data ? result.data.length : 0;
    
    return encontrados >= 5
      ? { passed: true, nombre: 'TEST 31: Búsqueda avanzada', mensaje: '✓ ' + encontrados + ' alumnos encontrados con "test"' }
      : { passed: false, nombre: 'TEST 31: Búsqueda avanzada', mensaje: 'FALLÓ: Solo ' + encontrados + ' encontrados (esperados 5+)' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 31: Búsqueda avanzada', mensaje: 'ERROR: ' + error };
  }
}

// ========== TEST 32: VERIFICAR TEST05 Y TEST06 ==========

function test32_VerificarDatosTest05yTest06() {
  try {
    var test05 = Student.obtenerCursos({ codeAlum: 'TEST05' });
    var test06 = Student.obtenerCursos({ codeAlum: 'TEST06' });
    
    var test05Valido = test05.success && test05.data.length >= 5;
    var test06Valido = test06.success && test06.data.length >= 3;
    
    return test05Valido && test06Valido
      ? { passed: true, nombre: 'TEST 32: Verificar TEST05 y TEST06', mensaje: '✓ TEST05 (' + test05.data.length + ' cursos) y TEST06 (' + test06.data.length + ' cursos) tienen datos' }
      : { passed: false, nombre: 'TEST 32: Verificar TEST05 y TEST06', mensaje: 'FALLÓ: TEST05 o TEST06 sin datos suficientes' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 32: Verificar TEST05 y TEST06', mensaje: 'ERROR: ' + error };
  }
}

// ========== TEST 33: ELIMINACIÓN CASCADA (TEST06) ==========

function test33_EliminacionCascada() {
  try {
    var result = Admin.eliminarAlumno({ codeAlum: 'TEST06' });
    
    if (!result.success) return { passed: false, nombre: 'TEST 33: Eliminación cascada', mensaje: 'FALLÓ: ' + result.error };
    
    var verificar = DB.buscar('Alumnos', 'CodeAlum', 'TEST06');
    
    return !verificar.success
      ? { passed: true, nombre: 'TEST 33: Eliminación cascada', mensaje: '✓ TEST06 eliminado de 9 hojas (' + result.message + ')' }
      : { passed: false, nombre: 'TEST 33: Eliminación cascada', mensaje: 'FALLÓ: TEST06 aún existe en Alumnos' };
  } catch(error) {
    return { passed: false, nombre: 'TEST 33: Eliminación cascada', mensaje: 'ERROR: ' + error };
  }
}

// ==========================================
// PARTE 3: FUNCIÓN PRINCIPAL
// ==========================================

function ejecutarTodasLasPruebas() {
  var resultados = [];
  
  Logger.log('====================================');
  Logger.log('INICIANDO SUITE DE PRUEBAS - PBE CONTROL V01.18');
  Logger.log('====================================');
  
  resultados.push(limpiarDatosPrueba());
  
  var tests = [
    test01_CrearAlumnos, test02_ValidarUnicidadCodeAlum, test03_ValidarUnicidadClave,
    test04_AgregarCursos, test05_AgregarRepasos, test06_AgregarEvaluaciones,
    test07_AgregarTareas, test08_AgregarLecturas,
    test08b_ValidarUnicidadCurso, test08c_ValidarUnicidadRepaso, test08d_ValidarUnicidadEvaluacion,
    test08e_ValidarUnicidadTarea, test08f_ValidarUnicidadLectura,
    test08g_LlenarTest06,
    test09_BuscarAlumno, test10_ObtenerCursos, test11_ObtenerRepasos,
    test12_ObtenerEvaluaciones, test13_ObtenerTareas, test14_ObtenerLecturas,
    test15_ActualizarCurso, test16_ActualizarRepaso, test17_ActualizarEvaluacion,
    test18_ActualizarTarea, test19_ActualizarLectura,
    test20_EliminarCurso, test21_EliminarRepaso, test22_EliminarEvaluacion,
    test23_EliminarTarea, test24_EliminarLectura,
    test25_AgregarHorarios, test26_VerificarMapeoHora, test27_HorarioSemanal,
    test28_PromedioPonderado, test29_ResumenNotas, test30_DeberesUnificados,
    test31_BusquedaAvanzada, test32_VerificarDatosTest05yTest06, test33_EliminacionCascada
  ];
  
  for (var i = 0; i < tests.length; i++) {
    Logger.log('Ejecutando TEST ' + (i < 9 ? '0' : '') + (i + 1) + '...');
    resultados.push(tests[i]());
  }
  
  Logger.log('====================================');
  Logger.log('SUITE DE PRUEBAS COMPLETADA');
  Logger.log('====================================');
  
  mostrarResultadosEnUI(resultados);
  
  return resultados;
}

function mostrarResultadosEnUI(resultados) {
  try {
    var template = HtmlService.createTemplateFromFile('2testui');
    template.resultados = JSON.stringify(resultados);
    
    var html = template.evaluate().setWidth(900).setHeight(700);
    
    SpreadsheetApp.getUi().showModalDialog(html, '🧪 Resultados de Pruebas - PBE Control V01.18');
  } catch(error) {
    Logger.log('Error al mostrar UI: ' + error.toString());
    
    Logger.log('====================================');
    Logger.log('RESUMEN DE RESULTADOS:');
    Logger.log('====================================');
    
    var passed = 0;
    var failed = 0;
    
    resultados.forEach(function(r) {
      if (r.passed) {
        passed++;
        Logger.log('✓ ' + r.nombre + ': ' + r.mensaje);
      } else {
        failed++;
        Logger.log('✗ ' + r.nombre + ': ' + r.mensaje);
      }
    });
    
    Logger.log('====================================');
    Logger.log('TOTAL: ' + passed + ' PASSED, ' + failed + ' FAILED');
    Logger.log('====================================');
  }
}

// ==========================================
// FIN DE 2testback.gs - V01.18
// Total: 40 funciones
// - 1 limpieza
// - 38 tests (37 de V01.15 + 1 nuevo test08g)
// - 1 ejecutarTodasLasPruebas()
// - 1 mostrarResultadosEnUI()
//
// CAMBIOS V01.18:
// ✅ TEST01: Crear 6 alumnos (agregado TEST06)
// ✅ TEST 08g: Llenar TEST06 con data completa
// ✅ TEST 32: Verificar que TEST05 y TEST06 tienen datos
// ✅ TEST 33: Eliminar TEST06 (antes era TEST32 que eliminaba TEST05)
// ✅ TEST05 conserva TODAS sus evidencias para pruebas robustas
// ==========================================


// ============================================
// ARCHIVO 7/24: 2testfront.gs
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/2testfront.gs
// ============================================

/*
******************************************
PBE CONTROL - 2testfront.gs - V01.17 CLAUDE
Sistema de Gestión Académica
05/01/2026 - 23:00
******************************************

CAMBIOS V01.17 CLAUDE:
✅ NUEVO: testBackendCursos() - Prueba backend directo Student.obtenerCursos
✅ ACTUALIZADO: generarReporteFrontend() - Incluye test de backend directo

CAMBIOS V01.16 CLAUDE:
✅ NUEVO: testFrontendWrapperTEST05() - Prueba flujo completo frontend→backend
✅ NUEVO: testAutenticacionTEST05() - Prueba flujo de autenticación
✅ ACTUALIZADO: generarReporteFrontend() - Incluye tests de wrappers
✅ Detección exhaustiva de problemas: null, undefined, errores

CONTENIDO COMPLETO:
1. testFrontend(): Validación general de archivos.
2. testArchivoHTML(): Validador individual con try-catch.
3. testArchivoEspecifico(): Debug profundo de un solo archivo.
4. testPorCategoria(): Validación lógica por módulos (Base, Tabs, Subtabs).
5. testAutenticacionTEST05(): Test de autenticación con test5
6. testFrontendWrapperTEST05(): Prueba studentObtenerCursos wrapper
7. testBackendCursos(): NUEVO V01.17 - Prueba backend directo Student.obtenerCursos
8. generarReporteFrontend(): Motor de reporte (ACTUALIZADO V01.17).
9. mostrarResultadosUI(): Renderizado en modal de Google Sheets.
10. testRapido(): Booleano simple para validaciones internas.
11. listarArchivosHTML(): Auditoría de archivos existentes vs esperados.

IMPORTANTE:
- Total archivos validados: 16 (Se eliminaron 8modals y 8navbar).
- Compatible con 2testui.html y Utils.gs.
- Prueba el FLUJO COMPLETO que haría 5atabcursos.html
- Test de backend directo para aislar problemas en wrapper vs backend
******************************************
*/

// ==========================================
// CONFIGURACIÓN GLOBAL DE ARCHIVOS
// ==========================================
const ARCHIVOS_ESPERADOS = [
  '3index', '3paneladmin', '3panelstudent',
  '4atabcursosyrep', '4btabdeberes', '4ctabplanning',
  '5atabcursos', '5atabrepasos',
  '6btabtodos', '6btabeval', '6btabtareas', '6btablecturas',
  '7ctabhorarioclase', '7ctabhorariosem', '7ctabnotas', '7ctabcalendario'
];

// ==========================================
// 1. FUNCIÓN PRINCIPAL: testFrontend()
// ==========================================
function testFrontend() {
  Logger.log('====================================');
  Logger.log('INICIANDO TEST FRONTEND - PBE CONTROL');
  Logger.log('====================================');
  
  var faltantes = [];
  var existentes = 0;
  
  Logger.log('Verificando ' + ARCHIVOS_ESPERADOS.length + ' archivos HTML...');
  Logger.log('');
  
  ARCHIVOS_ESPERADOS.forEach(function(nombre) {
    var resultado = testArchivoHTML(nombre);
    if (resultado.existe) {
      existentes++;
      Logger.log('✓ ' + nombre + '.html - EXISTE');
    } else {
      faltantes.push(nombre + '.html');
      Logger.log('✗ ' + nombre + '.html - FALTA');
    }
  });
  
  Logger.log('');
  Logger.log('====================================');
  Logger.log('RESUMEN:');
  Logger.log('Total esperados: ' + ARCHIVOS_ESPERADOS.length);
  Logger.log('Existentes: ' + existentes);
  Logger.log('Faltantes: ' + faltantes.length);
  Logger.log('====================================');
  
  if (faltantes.length > 0) {
    Logger.log('❌ ARCHIVOS FALTANTES detectados.');
    return { success: false, total: ARCHIVOS_ESPERADOS.length, existentes: existentes, faltantes: faltantes };
  }
  
  Logger.log('✅ Todos los archivos HTML existen.');
  return { success: true, total: ARCHIVOS_ESPERADOS.length, existentes: existentes, faltantes: [] };
}

// ==========================================
// 2. FUNCIÓN AUXILIAR: testArchivoHTML()
// ==========================================
function testArchivoHTML(nombre) {
  try {
    HtmlService.createHtmlOutputFromFile(nombre);
    return { existe: true, nombre: nombre + '.html', error: null };
  } catch(error) {
    return { existe: false, nombre: nombre + '.html', error: error.toString() };
  }
}

// ==========================================
// 3. FUNCIÓN DE DEBUG: testArchivoEspecifico()
// ==========================================
function testArchivoEspecifico(nombre) {
  Logger.log('TEST DETALLADO: ' + nombre);
  var resultado = testArchivoHTML(nombre);
  if (resultado.existe) {
    var content = HtmlService.createHtmlOutputFromFile(nombre).getContent();
    Logger.log('✓ Existe. Tamaño: ' + content.length + ' caracteres.');
  } else {
    Logger.log('✗ No encontrado. Error: ' + resultado.error);
  }
}

// ==========================================
// 4. FUNCIÓN: testPorCategoria()
// ==========================================
function testPorCategoria() {
  var categorias = {
    'Base (3)': ['3index', '3paneladmin', '3panelstudent'],
    'Tabs Principales (3)': ['4atabcursosyrep', '4btabdeberes', '4ctabplanning'],
    'Sub-tabs Cursos (2)': ['5atabcursos', '5atabrepasos'],
    'Sub-tabs Deberes (4)': ['6btabtodos', '6btabeval', '6btabtareas', '6btablecturas'],
    'Sub-tabs Planning (4)': ['7ctabhorarioclase', '7ctabhorariosem', '7ctabnotas', '7ctabcalendario']
  };
  
  var resultados = {};
  var todoOk = true;
  
  for (var cat in categorias) {
    var faltantes = [];
    categorias[cat].forEach(function(n) {
      if (!testArchivoHTML(n).existe) { faltantes.push(n); todoOk = false; }
    });
    resultados[cat] = { total: categorias[cat].length, faltantes: faltantes };
  }
  return { success: todoOk, detalle: resultados };
}

// ==========================================
// 5. testAutenticacionTEST05()
// ==========================================
/**
 * TEST FRONTEND: Autenticación de TEST05
 * Simula el flujo de 3index.html → autenticar()
 */
function testAutenticacionTEST05() {
  Logger.log('='.repeat(60));
  Logger.log('TEST FRONTEND: Autenticación TEST05');
  Logger.log('='.repeat(60));
  
  try {
    // 1. Simular parámetros del frontend
    var params = { clave: 'test5' };
    Logger.log('1. Params enviados: ' + JSON.stringify(params));
    
    // 2. Llamar a autenticar (como lo hace 3index.html)
    var result = autenticar(params);
    
    // 3. Análisis del resultado
    Logger.log('2. Análisis del resultado:');
    Logger.log('   Tipo: ' + typeof result);
    Logger.log('   Es null: ' + (result === null));
    Logger.log('   Es undefined: ' + (result === undefined));
    
    if (!result) {
      Logger.log('❌ FALLO: autenticar() retornó null/undefined');
      return { 
        passed: false, 
        nombre: 'Autenticación TEST05', 
        mensaje: 'autenticar() retornó null/undefined' 
      };
    }
    
    Logger.log('   Contenido: ' + JSON.stringify(result));
    
    // 4. Validar estructura
    if (result.success && result.user) {
      Logger.log('3. Usuario autenticado:');
      Logger.log('   type: ' + result.user.type);
      Logger.log('   codeAlum: ' + result.user.codeAlum);
      Logger.log('   nombre: ' + result.user.nombre);
      Logger.log('   email: ' + result.user.email);
      
      // Validar que sea TEST05
      if (result.user.codeAlum === 'TEST05') {
        Logger.log('✅ SUCCESS: TEST05 autenticado correctamente');
        return { 
          passed: true, 
          nombre: 'Autenticación TEST05', 
          mensaje: '✓ Autenticación exitosa: ' + result.user.nombre 
        };
      } else {
        Logger.log('❌ FALLO: CodeAlum incorrecto: ' + result.user.codeAlum);
        return { 
          passed: false, 
          nombre: 'Autenticación TEST05', 
          mensaje: 'CodeAlum incorrecto: ' + result.user.codeAlum 
        };
      }
    } else {
      Logger.log('❌ FALLO: ' + (result.error || 'Estructura de respuesta inválida'));
      return { 
        passed: false, 
        nombre: 'Autenticación TEST05', 
        mensaje: result.error || 'Estructura inválida' 
      };
    }
    
  } catch(error) {
    Logger.log('💥 EXCEPCIÓN:');
    Logger.log('   Message: ' + error.message);
    Logger.log('   Stack: ' + error.stack);
    return { 
      passed: false, 
      nombre: 'Autenticación TEST05', 
      mensaje: 'EXCEPCIÓN: ' + error.message 
    };
  } finally {
    Logger.log('='.repeat(60));
  }
}

// ==========================================
// 6. testFrontendWrapperTEST05()
// ==========================================
/**
 * TEST FRONTEND: Simular llamada desde 5atabcursos.html
 * Este test replica EXACTAMENTE lo que el navegador haría:
 * 1. Llama a studentObtenerCursos({ codeAlum: 'TEST05' })
 * 2. Valida que NO retorne null
 * 3. Valida la estructura de la respuesta
 * 4. Valida que los cursos existan
 */
function testFrontendWrapperTEST05() {
  Logger.log('='.repeat(60));
  Logger.log('TEST FRONTEND: Wrapper studentObtenerCursos (TEST05)');
  Logger.log('='.repeat(60));
  
  try {
    // 1. Simular parámetros del frontend
    var params = { codeAlum: 'TEST05' };
    Logger.log('1. Params enviados desde frontend: ' + JSON.stringify(params));
    
    // 2. Llamar al wrapper (como lo hace google.script.run)
    Logger.log('2. Llamando a studentObtenerCursos()...');
    var result = studentObtenerCursos(params);
    
    // 3. Análisis exhaustivo del resultado
    Logger.log('3. Análisis del resultado:');
    Logger.log('   Tipo: ' + typeof result);
    Logger.log('   Es null: ' + (result === null));
    Logger.log('   Es undefined: ' + (result === undefined));
    
    // ⚠️ DETECCIÓN DEL PROBLEMA: Si result es null
    if (result === null) {
      Logger.log('❌ PROBLEMA DETECTADO: studentObtenerCursos() retornó NULL');
      Logger.log('   Esto causa el error: Cannot read properties of null');
      return { 
        passed: false, 
        nombre: 'Wrapper studentObtenerCursos', 
        mensaje: 'FALLO CRÍTICO: Retorna NULL en lugar de objeto {success, data/error}' 
      };
    }
    
    if (result === undefined) {
      Logger.log('❌ PROBLEMA DETECTADO: studentObtenerCursos() retornó UNDEFINED');
      return { 
        passed: false, 
        nombre: 'Wrapper studentObtenerCursos', 
        mensaje: 'FALLO: Retorna UNDEFINED' 
      };
    }
    
    // 4. Validar estructura del objeto
    Logger.log('   Contenido: ' + JSON.stringify(result));
    
    if (!result.hasOwnProperty('success')) {
      Logger.log('❌ FALLO: Objeto no tiene propiedad "success"');
      return { 
        passed: false, 
        nombre: 'Wrapper studentObtenerCursos', 
        mensaje: 'Falta propiedad "success"' 
      };
    }
    
    // 5. Validar respuesta exitosa
    if (result.success) {
      if (!result.data || !Array.isArray(result.data)) {
        Logger.log('❌ FALLO: success=true pero data no es array');
        return { 
          passed: false, 
          nombre: 'Wrapper studentObtenerCursos', 
          mensaje: 'data no es array' 
        };
      }
      
      Logger.log('4. Cursos obtenidos:');
      Logger.log('   Total: ' + result.data.length);
      
      result.data.forEach(function(curso, i) {
        Logger.log('   [' + (i+1) + '] ' + curso.Curso + ': ' + curso.Completo + ' (' + curso.Color + ')');
      });
      
      // Validar que tenga al menos 5 cursos (TEST05 debe tener 5)
      if (result.data.length >= 5) {
        Logger.log('✅ SUCCESS: ' + result.data.length + ' cursos obtenidos correctamente');
        return { 
          passed: true, 
          nombre: 'Wrapper studentObtenerCursos', 
          mensaje: '✓ ' + result.data.length + ' cursos (MATE, FIS, QUIM, BIOL, HIST)' 
        };
      } else {
        Logger.log('⚠️ ADVERTENCIA: Solo ' + result.data.length + ' cursos (esperados 5)');
        return { 
          passed: false, 
          nombre: 'Wrapper studentObtenerCursos', 
          mensaje: 'Solo ' + result.data.length + ' cursos, esperados 5' 
        };
      }
      
    } else {
      // Error en la respuesta
      Logger.log('❌ ERROR en result: ' + result.error);
      return { 
        passed: false, 
        nombre: 'Wrapper studentObtenerCursos', 
        mensaje: 'ERROR: ' + result.error 
      };
    }
    
  } catch(error) {
    Logger.log('💥 EXCEPCIÓN CAPTURADA:');
    Logger.log('   Message: ' + error.message);
    Logger.log('   Stack: ' + error.stack);
    return { 
      passed: false, 
      nombre: 'Wrapper studentObtenerCursos', 
      mensaje: 'EXCEPCIÓN: ' + error.message 
    };
  } finally {
    Logger.log('='.repeat(60));
  }
}

// ==========================================
// 7. NUEVO V01.17: testBackendCursos()
// ==========================================
/**
 * TEST BACKEND DIRECTO: Student.obtenerCursos
 * Bypasea el wrapper para probar el backend puro
 * 
 * DIFERENCIA con testFrontendWrapperTEST05():
 * - testFrontendWrapperTEST05() → Llama a studentObtenerCursos() (wrapper en 1code.gs)
 * - testBackendCursos() → Llama a Student.obtenerCursos() (backend directo en 1student.gs)
 * 
 * Esto ayuda a identificar si el problema está en:
 * a) El wrapper (1code.gs)
 * b) El backend (1student.gs)
 * c) La capa de datos (1db.gs)
 */
function testBackendCursos() {
  Logger.log('='.repeat(60));
  Logger.log('TEST BACKEND DIRECTO: Student.obtenerCursos');
  Logger.log('='.repeat(60));
  
  try {
    // 1. Parámetros
    var params = { codeAlum: 'TEST05' };
    Logger.log('1. Llamando Student.obtenerCursos() DIRECTO con: ' + JSON.stringify(params));
    Logger.log('   (Bypaseando el wrapper studentObtenerCursos)');
    
    // 2. Llamar DIRECTAMENTE al backend (sin wrapper)
    var result = Student.obtenerCursos(params);
    
    // 3. Análisis
    Logger.log('2. Análisis del resultado:');
    Logger.log('   Tipo: ' + typeof result);
    Logger.log('   Es null: ' + (result === null));
    Logger.log('   Es undefined: ' + (result === undefined));
    
    if (result === null) {
      Logger.log('❌ PROBLEMA: Student.obtenerCursos() retorna NULL');
      Logger.log('   Posible causa: DB.obtenerPorAlumno() falló');
      Logger.log('   Revisar: 1student.gs y 1db.gs');
      return { 
        passed: false, 
        nombre: 'Backend Student.obtenerCursos', 
        mensaje: 'Backend retorna NULL - revisar 1student.gs y 1db.gs' 
      };
    }
    
    if (result === undefined) {
      Logger.log('❌ PROBLEMA: Student.obtenerCursos() retorna UNDEFINED');
      return { 
        passed: false, 
        nombre: 'Backend Student.obtenerCursos', 
        mensaje: 'Backend retorna UNDEFINED' 
      };
    }
    
    Logger.log('   Contenido: ' + JSON.stringify(result));
    
    // 4. Validar estructura
    if (result.success) {
      Logger.log('3. Backend exitoso:');
      Logger.log('   Cursos encontrados: ' + result.data.length);
      
      result.data.forEach(function(curso, i) {
        Logger.log('   [' + (i+1) + '] ' + curso.Curso + ' - ' + curso.Completo + ' (' + curso.Color + ')');
      });
      
      if (result.data.length >= 5) {
        Logger.log('✅ SUCCESS: Backend funciona correctamente');
        Logger.log('   Si el wrapper falla pero el backend funciona → problema en 1code.gs');
        return { 
          passed: true, 
          nombre: 'Backend Student.obtenerCursos', 
          mensaje: '✓ Backend OK: ' + result.data.length + ' cursos' 
        };
      } else {
        Logger.log('⚠️ WARNING: Solo ' + result.data.length + ' cursos');
        return { 
          passed: false, 
          nombre: 'Backend Student.obtenerCursos', 
          mensaje: 'Solo ' + result.data.length + ' cursos, esperados 5' 
        };
      }
      
    } else {
      Logger.log('❌ ERROR: ' + result.error);
      return { 
        passed: false, 
        nombre: 'Backend Student.obtenerCursos', 
        mensaje: 'ERROR: ' + result.error 
      };
    }
    
  } catch(error) {
    Logger.log('💥 EXCEPCIÓN:');
    Logger.log('   Message: ' + error.message);
    Logger.log('   Stack: ' + error.stack);
    return { 
      passed: false, 
      nombre: 'Backend Student.obtenerCursos', 
      mensaje: 'EXCEPCIÓN: ' + error.message 
    };
  } finally {
    Logger.log('='.repeat(60));
  }
}

// ==========================================
// 8. FUNCIÓN REPORTE: generarReporteFrontend()
// ACTUALIZADA V01.17 CLAUDE
// ==========================================
function generarReporteFrontend() {
  Logger.log('====================================');
  Logger.log('GENERANDO REPORTE INTEGRAL...');
  Logger.log('====================================');
  
  var general = testFrontend();
  var categorias = testPorCategoria();
  
  // Tests de wrappers y backend
  Logger.log('');
  Logger.log('====================================');
  Logger.log('EJECUTANDO TESTS DE WRAPPERS Y BACKEND...');
  Logger.log('====================================');
  
  var testAuth = testAutenticacionTEST05();
  var testWrapper = testFrontendWrapperTEST05();
  var testBackend = testBackendCursos(); // NUEVO V01.17
  
  var fecha;
  try { fecha = Utils.fechaHoy(); } 
  catch(e) { fecha = Utilities.formatDate(new Date(), "GMT-5", "dd/MM/yyyy HH:mm"); }

  var reporte = {
    fecha: fecha,
    general: general,
    categorias: categorias,
    wrappers: {
      autenticacion: testAuth,
      obtenerCursosWrapper: testWrapper,
      obtenerCursosBackend: testBackend // NUEVO V01.17
    },
    listo: general.success && categorias.success && testAuth.passed && testWrapper.passed && testBackend.passed
  };
  
  Logger.log('');
  Logger.log('====================================');
  Logger.log('RESUMEN FINAL:');
  Logger.log('====================================');
  Logger.log('Archivos HTML: ' + (general.success ? '✅ OK' : '❌ FALLO'));
  Logger.log('Categorías: ' + (categorias.success ? '✅ OK' : '❌ FALLO'));
  Logger.log('Autenticación TEST05: ' + (testAuth.passed ? '✅ OK' : '❌ FALLO'));
  Logger.log('Wrapper studentObtenerCursos: ' + (testWrapper.passed ? '✅ OK' : '❌ FALLO'));
  Logger.log('Backend Student.obtenerCursos: ' + (testBackend.passed ? '✅ OK' : '❌ FALLO')); // NUEVO V01.17
  Logger.log('====================================');
  Logger.log('SISTEMA: ' + (reporte.listo ? '✅ OPERATIVO' : '❌ CON PROBLEMAS'));
  Logger.log('====================================');

  mostrarResultadosUI(reporte);
  return reporte;
}

// ==========================================
// 9. FUNCIÓN UI: mostrarResultadosUI()
// ==========================================
function mostrarResultadosUI(resultados) {
  try {
    var template = HtmlService.createTemplateFromFile('2testui');
    template.resultados = JSON.stringify(resultados);
    var html = template.evaluate().setWidth(900).setHeight(700);
    SpreadsheetApp.getUi().showModalDialog(html, '🧪 Test Frontend PBE Control V01.17 CLAUDE');
  } catch(e) {
    Logger.log('⚠️ No se pudo abrir el modal UI. Ver Logger para resultados.');
  }
}

// ==========================================
// 10. FUNCIÓN: testRapido()
// ==========================================
function testRapido() {
  return ARCHIVOS_ESPERADOS.every(function(n) {
    try { HtmlService.createHtmlOutputFromFile(n); return true; } 
    catch(e) { return false; }
  });
}

// ==========================================
// 11. FUNCIÓN: listarArchivosHTML()
// ==========================================
function listarArchivosHTML() {
  Logger.log('AUDITORÍA DE ARCHIVOS:');
  ARCHIVOS_ESPERADOS.forEach(function(n) {
    var e = testArchivoHTML(n).existe ? '✓' : '✗';
    Logger.log(e + ' ' + n);
  });
}

// ==========================================
// FIN DE 2testfront.gs V01.17 CLAUDE
// ==========================================
// RESUMEN:
// - Tests de archivos HTML (existencia e integridad)
// - Test de autenticación completa
// - Test de wrapper studentObtenerCursos
// - NUEVO V01.17: Test de backend directo Student.obtenerCursos
// - Reporte integral con TODAS las validaciones
// 
// DIAGNÓSTICO:
// Si wrapper falla pero backend funciona → problema en 1code.gs
// Si ambos fallan → problema en 1student.gs o 1db.gs
// Si ambos funcionan → problema en el frontend o timing
// ==========================================


// ============================================
// ARCHIVO 8/24: 2testui.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/2testui.html
// ============================================

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados de Pruebas - PBE Control</title>
  
  <style>
    /* ==========================================
       RESET Y BASE
       ========================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
      padding: 0;
      overflow-x: hidden;
    }
    
    /* ==========================================
       HEADER - Gradiente azul/morado
       ========================================== */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 40px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.95;
      font-family: Arial, sans-serif;
    }
    
    /* ==========================================
       CONTENEDOR PRINCIPAL
       ========================================== */
    .container {
      max-width: 850px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* ==========================================
       RESUMEN - Tarjeta superior
       ========================================== */
    .resumen {
      background: white;
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .resumen h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }
    
    .stats {
      display: flex;
      justify-content: space-around;
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-box {
      flex: 1;
      text-align: center;
      padding: 15px;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: Arial, sans-serif;
    }
    
    .stat-box.passed .stat-number {
      color: #28a745;
    }
    
    .stat-box.failed .stat-number {
      color: #dc3545;
    }
    
    .stat-box.total .stat-number {
      color: #667eea;
    }
    
    /* ==========================================
       LISTA DE TESTS
       ========================================== */
    .tests-list {
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .tests-list h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }
    
    /* ==========================================
       TEST ITEM - Cada resultado
       ========================================== */
    .test-item {
      padding: 15px 18px;
      margin-bottom: 12px;
      border-radius: 6px;
      border-left: 4px solid;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .test-item:hover {
      transform: translateX(3px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    /* Test PASSED - Fondo verde */
    .test-item.passed {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    
    /* Test FAILED - Fondo rojo */
    .test-item.failed {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    
    .test-nombre {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .test-icono {
      font-size: 18px;
    }
    
    .test-mensaje {
      margin-left: 26px;
      opacity: 0.9;
      line-height: 1.5;
    }
    
    /* ==========================================
       BOTÓN FLOTANTE - Copiar Log
       ========================================== */
    .btn-copiar {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 12px 20px;
      border-radius: 25px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: all 0.3s;
      z-index: 1000;
    }
    
    .btn-copiar:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    
    .btn-copiar:active {
      transform: translateY(0);
    }
    
    /* ==========================================
       FOOTER
       ========================================== */
    .footer {
      text-align: center;
      padding: 30px 20px;
      color: #999;
      font-size: 12px;
      font-family: Arial, sans-serif;
    }
    
    /* ==========================================
       MENSAJE DE COPIADO
       ========================================== */
    .mensaje-copiado {
      position: fixed;
      top: 80px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s;
      z-index: 1001;
      pointer-events: none;
    }
    
    .mensaje-copiado.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* ==========================================
       RESPONSIVE
       ========================================== */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 22px;
      }
      
      .stats {
        flex-direction: column;
      }
      
      .stat-box {
        margin-bottom: 10px;
      }
      
      .btn-copiar {
        top: auto;
        bottom: 20px;
        right: 20px;
      }
      
      .mensaje-copiado {
        top: auto;
        bottom: 80px;
      }
      
      .container {
        padding: 20px 15px;
      }
    }
    
    /* ==========================================
       ANIMACIONES
       ========================================== */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .test-item {
      animation: slideIn 0.3s ease-out;
    }
    
    /* Delay incremental para cada test */
    .test-item:nth-child(1) { animation-delay: 0.05s; }
    .test-item:nth-child(2) { animation-delay: 0.10s; }
    .test-item:nth-child(3) { animation-delay: 0.15s; }
    .test-item:nth-child(4) { animation-delay: 0.20s; }
    .test-item:nth-child(5) { animation-delay: 0.25s; }
    .test-item:nth-child(6) { animation-delay: 0.30s; }
    .test-item:nth-child(7) { animation-delay: 0.35s; }
    .test-item:nth-child(8) { animation-delay: 0.40s; }
    .test-item:nth-child(9) { animation-delay: 0.45s; }
    .test-item:nth-child(10) { animation-delay: 0.50s; }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="header">
    <h1>🧪 Resultados de Pruebas</h1>
    <p>PBE Control - Sistema de Gestión Académica</p>
  </div>
  
  <!-- BOTÓN COPIAR LOG -->
  <button class="btn-copiar" onclick="copiarLog()">
    📋 Copiar Log Completo
  </button>
  
  <!-- MENSAJE DE COPIADO -->
  <div class="mensaje-copiado" id="mensajeCopiado">
    ✓ Log copiado al portapapeles
  </div>
  
  <!-- CONTENEDOR PRINCIPAL -->
  <div class="container">
    
    <!-- RESUMEN -->
    <div class="resumen">
      <h2>📊 Resumen de Resultados</h2>
      <div class="stats">
        <div class="stat-box total">
          <span class="stat-number" id="statTotal">0</span>
          <span class="stat-label">Total Tests</span>
        </div>
        <div class="stat-box passed">
          <span class="stat-number" id="statPassed">0</span>
          <span class="stat-label">Passed</span>
        </div>
        <div class="stat-box failed">
          <span class="stat-number" id="statFailed">0</span>
          <span class="stat-label">Failed</span>
        </div>
      </div>
    </div>
    
    <!-- LISTA DE TESTS -->
    <div class="tests-list">
      <h2>📝 Detalle de Pruebas</h2>
      <div id="testResults">
        <!-- Los resultados se insertan aquí dinámicamente -->
      </div>
    </div>
    
  </div>
  
  <!-- FOOTER -->
  <div class="footer">
    PBE Control V01.13 - Sistema de Testing<br>
    Desarrollado por Jorge Baudouin - Enero 2026
  </div>
  
  <!-- SCRIPT -->
  <script>
    // ==========================================
    // DATOS DE RESULTADOS
    // ==========================================
    
    // Los resultados vienen desde Apps Script
    var resultadosJSON = <?!= resultados ?>;
    var resultados = [];
    
    try {
      resultados = JSON.parse(resultadosJSON);
    } catch(error) {
      console.error('Error al parsear resultados:', error);
      resultados = [];
    }
    
    // ==========================================
    // RENDERIZAR RESULTADOS
    // ==========================================
    
    function renderizarResultados() {
      var container = document.getElementById('testResults');
      var html = '';
      
      var totalPassed = 0;
      var totalFailed = 0;
      
      // Generar HTML para cada test
      resultados.forEach(function(test) {
        var estado = test.passed ? 'passed' : 'failed';
        var icono = test.passed ? '✓' : '✗';
        
        if (test.passed) {
          totalPassed++;
        } else {
          totalFailed++;
        }
        
        html += '<div class="test-item ' + estado + '">';
        html += '  <div class="test-nombre">';
        html += '    <span class="test-icono">' + icono + '</span>';
        html += '    <span>' + (test.nombre || 'Test sin nombre') + '</span>';
        html += '  </div>';
        html += '  <div class="test-mensaje">' + (test.mensaje || 'Sin mensaje') + '</div>';
        html += '</div>';
      });
      
      // Si no hay resultados
      if (resultados.length === 0) {
        html = '<div class="test-item" style="background: #f8f9fa; border-left-color: #999; color: #666;">';
        html += '  <div class="test-nombre">ℹ️ Sin resultados</div>';
        html += '  <div class="test-mensaje">No se ejecutaron pruebas o no se recibieron resultados.</div>';
        html += '</div>';
      }
      
      container.innerHTML = html;
      
      // Actualizar estadísticas
      document.getElementById('statTotal').textContent = resultados.length;
      document.getElementById('statPassed').textContent = totalPassed;
      document.getElementById('statFailed').textContent = totalFailed;
    }
    
    // ==========================================
    // COPIAR LOG AL PORTAPAPELES
    // ==========================================
    
    function copiarLog() {
      var log = generarLogCompleto();
      
      // Crear elemento temporal para copiar
      var textarea = document.createElement('textarea');
      textarea.value = log;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      
      // Seleccionar y copiar
      textarea.select();
      
      try {
        document.execCommand('copy');
        mostrarMensajeCopiado();
      } catch(error) {
        alert('No se pudo copiar. Intenta manualmente:\n\n' + log);
      }
      
      document.body.removeChild(textarea);
    }
    
    // ==========================================
    // GENERAR LOG COMPLETO
    // ==========================================
    
    function generarLogCompleto() {
      var log = '';
      
      log += '====================================\n';
      log += 'RESULTADOS DE PRUEBAS - PBE CONTROL\n';
      log += '====================================\n';
      log += 'Fecha: ' + new Date().toLocaleString('es-PE') + '\n';
      log += '\n';
      
      // Resumen
      var totalPassed = 0;
      var totalFailed = 0;
      
      resultados.forEach(function(test) {
        if (test.passed) totalPassed++;
        else totalFailed++;
      });
      
      log += 'RESUMEN:\n';
      log += '--------\n';
      log += 'Total Tests: ' + resultados.length + '\n';
      log += 'Passed: ' + totalPassed + '\n';
      log += 'Failed: ' + totalFailed + '\n';
      log += '\n';
      
      // Detalle de cada test
      log += 'DETALLE:\n';
      log += '--------\n';
      
      resultados.forEach(function(test, index) {
        var icono = test.passed ? '✓' : '✗';
        log += '\n' + (index + 1) + '. ' + icono + ' ' + (test.nombre || 'Test sin nombre') + '\n';
        log += '   ' + (test.mensaje || 'Sin mensaje') + '\n';
      });
      
      log += '\n';
      log += '====================================\n';
      log += 'FIN DEL LOG\n';
      log += '====================================\n';
      
      return log;
    }
    
    // ==========================================
    // MOSTRAR MENSAJE DE COPIADO
    // ==========================================
    
    function mostrarMensajeCopiado() {
      var mensaje = document.getElementById('mensajeCopiado');
      mensaje.classList.add('show');
      
      setTimeout(function() {
        mensaje.classList.remove('show');
      }, 2000);
    }
    
    // ==========================================
    // INICIALIZAR AL CARGAR
    // ==========================================
    
    window.onload = function() {
      renderizarResultados();
    };
  </script>
</body>
</html>


// ============================================
// ARCHIVO 9/24: 3index.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/3index.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 3index.html
VERSIÓN: 01.24
FECHA: 18/01/2026 12:05 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: APERTURA HTML [INICIO] -->
<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top"> 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBE Control - Login</title>
<!-- MOD-002: FIN -->

<!-- MOD-003: ESTILOS [INICIO] -->
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  font-size: 14px;
}

.login-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  width: 100%;
  max-width: 380px;
  animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 30px 20px;
  text-align: center;
  color: white;
}

.login-header h1 { font-size: 26px; font-weight: 700; margin-bottom: 5px; }

.login-form { padding: 30px 25px; }

.form-group { margin-bottom: 20px; }
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #444;
  margin-bottom: 6px;
}

.form-group input {
  width: 100%;
  padding: 12px;
  font-size: 14px;
  border: 2px solid #eee;
  border-radius: 6px;
  transition: all 0.2s;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
  background-color: #fcfcff;
}

.btn-login {
  width: 100%;
  padding: 12px;
  font-size: 14px;
  font-weight: 600;
  color: white;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.btn-login:hover { opacity: 0.9; }
.btn-login:disabled { background: #bbb; cursor: not-allowed; }

.alert {
  position: fixed;
  top: 15px;
  right: 15px;
  padding: 12px 20px;
  border-radius: 4px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 10000;
  font-size: 13px;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { transform: translateX(50px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.alert-success { background: #28a745; color: white; }
.alert-error { background: #dc3545; color: white; }

.spinner {
  display: inline-block;
  width: 14px; height: 14px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.login-footer {
  padding: 15px;
  text-align: center;
  font-size: 11px;
  color: #aaa;
  border-top: 1px solid #f9f9f9;
}
</style>
<!-- MOD-003: FIN -->

<!-- MOD-004: CIERRE HEAD Y APERTURA BODY [INICIO] -->
</head>
<body>
<!-- MOD-004: FIN -->

<!-- MOD-005: CONTENEDOR LOGIN [INICIO] -->
<div class="login-container">
  <div class="login-header">
    <h1>PBE Control</h1>
    <p>Gestión Académica Profesional</p>
  </div>

  <div class="login-form">
    <form id="loginForm" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label for="inputClave">Clave de Acceso</label>
        <input type="password" id="inputClave" name="clave" placeholder="••••••••" autocomplete="off" required>
      </div>
      <button type="submit" class="btn-login" id="btnLogin">Ingresar al Sistema</button>
    </form>
  </div>

  <div class="login-footer">
    PBE Control v01.24 &copy; 2026 | Protocolo de Acceso Seguro
  </div>
</div>
<!-- MOD-005: FIN -->

<!-- MOD-006: JAVASCRIPT [INICIO] -->
<script>
// Manejar envío del formulario de login
function handleLogin(event) {
  event.preventDefault();
  const clave = document.getElementById('inputClave').value.trim();
  const btnLogin = document.getElementById('btnLogin');

  if (!clave) {
    showAlert('error', 'Ingrese su clave');
    return;
  }

  btnLogin.disabled = true;
  btnLogin.innerHTML = '<span class="spinner"></span>Validando...';

  sessionStorage.clear();

  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        handleLoginSuccess(response);
      } else {
        handleLoginSuccess(response);
      }
    })
    .withFailureHandler(function(err) {
       showAlert('error', 'Error técnico de conexión');
       btnLogin.disabled = false;
       btnLogin.innerHTML = 'Ingresar al Sistema';
    })
    .autenticar({ clave: clave });
}

// Manejar respuesta exitosa del login
function handleLoginSuccess(response) {
  if (response.success) {
    sessionStorage.setItem('pbe_user', JSON.stringify(response.user));
    
    showAlert('success', 'Bienvenido, ' + response.user.nombre);
    
    setTimeout(function() {
      var finalUrl = '<?!= scriptUrl ?>' + '?page=' + response.user.type;
      window.location.href = finalUrl;
    }, 600);
  } else {
    showAlert('error', response.error);
    const btnLogin = document.getElementById('btnLogin');
    btnLogin.disabled = false;
    btnLogin.innerHTML = 'Ingresar al Sistema';
    document.getElementById('inputClave').focus();
  }
}

// Mostrar alertas de éxito/error
function showAlert(type, message) {
  const old = document.querySelector('.alert');
  if (old) old.remove();

  const alertBox = document.createElement('div');
  alertBox.className = 'alert alert-' + type;
  alertBox.textContent = message;
  document.body.appendChild(alertBox);
  setTimeout(() => alertBox.remove(), 3000);
}

// Inicialización al cargar la página
window.onload = () => {
  document.getElementById('inputClave').focus();
};
</script>
<!-- MOD-006: FIN -->

<!-- MOD-007: CÓDIGO DE CIERRE [INICIO] -->
</body>
</html>
<!-- MOD-007: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Página de login del sistema PBE Control
Autenticación mediante clave única

FUNCIONALIDAD:
- Formulario de login con validación de clave
- Llamada a backend google.script.run.autenticar()
- Almacenamiento de sesión en sessionStorage
- Redirección automática según tipo de usuario

FLUJO DE AUTENTICACIÓN:
1. Usuario ingresa clave
2. Se limpia sessionStorage previo
3. Se llama a autenticar() en backend
4. Si éxito: guardar user completo en sessionStorage
5. Redireccionar a página según user.type

DATOS GUARDADOS EN SESSION:
- pbe_user: Objeto completo con codeAlum, nombre, email, type

INTERFAZ:
- Diseño responsivo con gradiente morado
- Animaciones de entrada suaves
- Spinner durante validación
- Alertas de éxito/error con auto-dismiss

DEPENDENCIAS:
- google.script.run (Google Apps Script Client API)
- Backend: función autenticar(params)
- Variable scriptUrl inyectada desde servidor

FIX CRÍTICO V01.23 → V01.24:
- Cambiado window.top.location.href por window.location.href
- Respeta <base target="_top"> sin SecurityError
- Eliminadas referencias a include('8modals') inexistente
- Login confiable sin necesidad de reintentos

CAMBIOS V01.23 → V01.24:
- Remodulación completa según Estándar CodeWorkShop v4.0
- CSS encapsulado en MOD-003
- JavaScript encapsulado en MOD-006
- Comentarios consolidados en MOD-099
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 10/24: 3paneladmin.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/3paneladmin.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 3paneladmin.html
VERSIÓN: 01.18
FECHA: 18/01/2026 14:56 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: APERTURA HTML [INICIO] -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBE Control - Panel Admin</title>
<!-- MOD-002: FIN -->

<!-- MOD-003: ESTILOS [INICIO] -->
<style>
/* Reset y Base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: #f5f7fa;
  min-height: 100vh;
  padding-bottom: 40px;
}

/* Header / Navbar */
.navbar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 30px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.navbar h1 {
  font-size: 24px;
  font-weight: 700;
}

.navbar .user-info {
  display: flex;
  align-items: center;
  gap: 20px;
}

.navbar .user-name {
  font-size: 15px;
  opacity: 0.95;
}

.btn-logout {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-logout:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Container Principal */
.container {
  max-width: 1400px;
  margin: 30px auto;
  padding: 0 20px;
}

/* Secciones / Cards */
.section-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  margin-bottom: 24px;
  overflow: hidden;
}

.section-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 18px 24px;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.section-body {
  padding: 24px;
}

/* Formularios */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.form-group {
  margin-bottom: 0;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
}

.form-group label .required {
  color: #dc3545;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  transition: all 0.3s;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input::placeholder {
  color: #999;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

/* Botones */
.btn {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

.btn-danger:hover {
  background: #c82333;
}

.btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Búsqueda */
.search-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}

.search-bar input {
  flex: 1;
  padding: 12px 16px;
  font-size: 15px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
}

.search-bar input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-bar button {
  padding: 12px 24px;
  white-space: nowrap;
}

/* Tabla de Resultados */
.results-container {
  margin-top: 20px;
}

.results-info {
  font-size: 14px;
  color: #666;
  margin-bottom: 12px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

thead th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
}

tbody tr {
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.2s;
}

tbody tr:hover {
  background: #f8f9fa;
}

tbody td {
  padding: 12px;
  color: #333;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 15px;
}

/* Badges */
.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.badge-active {
  background: #d4edda;
  color: #155724;
}

.badge-inactive {
  background: #f8d7da;
  color: #721c24;
}

/* Alertas */
.alert {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 24px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 9999;
  animation: slideIn 0.3s ease-out;
  max-width: 400px;
  font-size: 14px;
  font-weight: 500;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border-left: 4px solid #28a745;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border-left: 4px solid #dc3545;
}

.alert-warning {
  background: #fff3cd;
  color: #856404;
  border-left: 4px solid #ffc107;
}

/* Modal de Confirmación */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 500px;
  width: 90%;
  animation: modalIn 0.3s ease-out;
}

@keyframes modalIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid #e0e0e0;
}

.modal-title {
  font-size: 18px;
  font-weight: 600;
  color: #dc3545;
}

.modal-body {
  padding: 24px;
}

.modal-body p {
  color: #333;
  line-height: 1.6;
  margin-bottom: 12px;
}

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* Loading Spinner */
.spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Toggle Formulario */
.form-container {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}

.form-container.active {
  max-height: 1000px;
}

.btn-toggle {
  background: white;
  color: #667eea;
  border: 2px solid #667eea;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-toggle:hover {
  background: #667eea;
  color: white;
}

/* Responsive - Mobile */
@media (max-width: 768px) {
  .navbar {
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }

  .navbar .user-info {
    flex-direction: column;
    gap: 8px;
  }

  .container {
    padding: 0 12px;
    margin: 20px auto;
  }

  .section-body {
    padding: 16px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .form-actions {
    flex-direction: column;
  }

  .form-actions .btn {
    width: 100%;
  }

  .search-bar {
    flex-direction: column;
  }

  .search-bar button {
    width: 100%;
  }

  table {
    font-size: 13px;
  }

  thead th,
  tbody td {
    padding: 8px;
  }

  .alert {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
  }
}
</style>
<!-- MOD-003: FIN -->

<!-- MOD-004: CIERRE HEAD Y APERTURA BODY [INICIO] -->
</head>
<body>
<!-- MOD-004: FIN -->

<!-- MOD-005: NAVBAR [INICIO] -->
<div class="navbar">
  <h1>PBE Control - Panel Administrador</h1>
  <div class="user-info">
    <span class="user-name">👤 <span id="userName">Admin</span></span>
    <button class="btn-logout" onclick="logout()">Salir</button>
  </div>
</div>
<!-- MOD-005: FIN -->

<!-- MOD-006: CONTAINER PRINCIPAL [INICIO] -->
<div class="container">
<!-- MOD-006: FIN -->

<!-- MOD-007: SECCIÓN CREAR ALUMNO [INICIO] -->
<div class="section-card">
  <div class="section-header">
    <span>Crear Nuevo Alumno</span>
    <button class="btn-toggle" onclick="toggleFormCrear()">+ Nuevo Alumno</button>
  </div>
  <div class="form-container" id="formCrearContainer">
    <div class="section-body">
      <form id="formCrearAlumno" onsubmit="handleCrearAlumno(event)">
        <div class="form-grid">
          <div class="form-group">
            <label>Código Alumno <span class="required">*</span></label>
            <input type="text" name="codeAlum" placeholder="Ej: PBE001" required>
          </div>
          
          <div class="form-group">
            <label>Clave de Acceso <span class="required">*</span></label>
            <input type="text" name="clave" placeholder="Ej: alumno123" required>
          </div>
          
          <div class="form-group">
            <label>Nombres <span class="required">*</span></label>
            <input type="text" name="nombres" placeholder="Ej: Juan Carlos" required>
          </div>
          
          <div class="form-group">
            <label>Apellidos <span class="required">*</span></label>
            <input type="text" name="apellidos" placeholder="Ej: Pérez García" required>
          </div>
          
          <div class="form-group">
            <label>DNI</label>
            <input type="text" name="dni" placeholder="Ej: 12345678">
          </div>
          
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" placeholder="Ej: alumno@email.com">
          </div>
          
          <div class="form-group">
            <label>Teléfono</label>
            <input type="tel" name="fono" placeholder="Ej: 987654321">
          </div>
          
          <div class="form-group">
            <label>Fecha Nacimiento</label>
            <input type="text" name="fechaNac" placeholder="DD/MM/AAAA">
          </div>
          
          <div class="form-group">
            <label>Tipo Institución</label>
            <select name="tipoInsti">
              <option value="">Seleccionar...</option>
              <option value="Colegio">Colegio</option>
              <option value="Universidad">Universidad</option>
              <option value="Instituto">Instituto</option>
              <option value="Academia">Academia</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Nombre Institución</label>
            <input type="text" name="nomInsti" placeholder="Ej: Universidad Nacional">
          </div>
          
          <div class="form-group">
            <label>Ciclo/Grado</label>
            <input type="text" name="ciclo" placeholder="Ej: 5to de secundaria">
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" id="btnCrear">
            Crear Alumno
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetFormCrear()">
            Limpiar Formulario
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- MOD-007: FIN -->

<!-- MOD-008: SECCIÓN BUSCAR ALUMNO [INICIO] -->
<div class="section-card">
  <div class="section-header">
    <span>Buscar Alumnos</span>
  </div>
  <div class="section-body">
    <div class="search-bar">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Buscar por código, nombre, apellido o DNI..."
        onkeypress="handleSearchKeypress(event)"
      >
      <button class="btn btn-primary" onclick="handleBuscarAlumno()">
        🔍 Buscar
      </button>
      <button class="btn btn-secondary" onclick="handleMostrarTodos()">
        Ver Todos
      </button>
    </div>

    <div class="results-container" id="resultsContainer">
      <div class="empty-state">
        <div class="empty-state-icon">🔍</div>
        <div class="empty-state-text">
          Usa el buscador para encontrar alumnos<br>
          o haz clic en "Ver Todos" para listar todos los alumnos
        </div>
      </div>
    </div>
  </div>
</div>
<!-- MOD-008: FIN -->

<!-- MOD-009: CIERRE CONTAINER [INICIO] -->
</div>
<!-- MOD-009: FIN -->

<!-- MOD-010: MODAL CONFIRMACIÓN [INICIO] -->
<div class="modal-overlay" id="modalConfirm">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">⚠️ Confirmar Eliminación</h3>
    </div>
    <div class="modal-body">
      <p id="modalMessage">¿Estás seguro de eliminar este alumno?</p>
      <p style="color: #dc3545; font-weight: 600;">
        Esta acción NO se puede deshacer y eliminará todos los datos del alumno 
        (cursos, tareas, evaluaciones, etc.).
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">
        Cancelar
      </button>
      <button class="btn btn-danger" onclick="confirmDelete()" id="btnConfirmDelete">
        Confirmar Eliminación
      </button>
    </div>
  </div>
</div>
<!-- MOD-010: FIN -->

<!-- MOD-011: JAVASCRIPT [INICIO] -->
<script>
// Variables Globales
var currentUser = {
  nombre: 'Admin',
  user: 'admin'
};

var alumnoToDelete = null;

// Inicialización
window.onload = function() {
  document.getElementById('userName').textContent = currentUser.nombre;
};

// Toggle Formulario Crear
function toggleFormCrear() {
  const container = document.getElementById('formCrearContainer');
  container.classList.toggle('active');
}

// Crear Alumno
function handleCrearAlumno(event) {
  event.preventDefault();

  const form = event.target;
  const formData = new FormData(form);
  const btnCrear = document.getElementById('btnCrear');

  const params = {
    codeAlum: formData.get('codeAlum').trim(),
    clave: formData.get('clave').trim(),
    nombres: formData.get('nombres').trim(),
    apellidos: formData.get('apellidos').trim(),
    dni: formData.get('dni').trim(),
    email: formData.get('email').trim(),
    fono: formData.get('fono').trim(),
    fechaNac: formData.get('fechaNac').trim(),
    tipoInsti: formData.get('tipoInsti'),
    nomInsti: formData.get('nomInsti').trim(),
    ciclo: formData.get('ciclo').trim()
  };

  if (!params.codeAlum || !params.clave || !params.nombres || !params.apellidos) {
    showAlert('error', 'Completa todos los campos obligatorios');
    return;
  }

  btnCrear.disabled = true;
  btnCrear.innerHTML = '<span class="spinner"></span>Creando...';

  google.script.run
    .withSuccessHandler(handleCrearSuccess)
    .withFailureHandler(handleCrearFailure)
    .adminCrearAlumno(params);
}

function handleCrearSuccess(response) {
  const btnCrear = document.getElementById('btnCrear');
  btnCrear.disabled = false;
  btnCrear.innerHTML = 'Crear Alumno';

  if (response.success) {
    showAlert('success', '✓ ' + response.message);
    resetFormCrear();
    
    const resultsContainer = document.getElementById('resultsContainer');
    if (resultsContainer.querySelector('table')) {
      handleBuscarAlumno();
    }
  } else {
    showAlert('error', response.error);
  }
}

function handleCrearFailure(error) {
  console.error('Error al crear alumno:', error);
  showAlert('error', 'Error de conexión. Intenta nuevamente');
  
  const btnCrear = document.getElementById('btnCrear');
  btnCrear.disabled = false;
  btnCrear.innerHTML = 'Crear Alumno';
}

function resetFormCrear() {
  document.getElementById('formCrearAlumno').reset();
}

// Buscar Alumno
function handleBuscarAlumno() {
  const searchInput = document.getElementById('searchInput');
  const filtro = searchInput.value.trim();

  google.script.run
    .withSuccessHandler(handleBuscarSuccess)
    .withFailureHandler(handleBuscarFailure)
    .adminBuscarAlumno({ filtro: filtro });
}

function handleMostrarTodos() {
  document.getElementById('searchInput').value = '';
  handleBuscarAlumno();
}

function handleSearchKeypress(event) {
  if (event.key === 'Enter') {
    handleBuscarAlumno();
  }
}

function handleBuscarSuccess(response) {
  const resultsContainer = document.getElementById('resultsContainer');

  if (response.success) {
    const alumnos = response.data;

    if (alumnos.length === 0) {
      resultsContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">😕</div>
          <div class="empty-state-text">
            No se encontraron alumnos con ese criterio
          </div>
        </div>
      `;
      return;
    }

    let html = `
      <div class="results-info">
        Se encontraron ${alumnos.length} alumno(s)
      </div>
      <table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombres</th>
            <th>Apellidos</th>
            <th>DNI</th>
            <th>Email</th>
            <th>Institución</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
    `;

    alumnos.forEach(function(alumno) {
      html += `
        <tr>
          <td><strong>${alumno.CodeAlum}</strong></td>
          <td>${alumno.Nombres}</td>
          <td>${alumno.Apellidos}</td>
          <td>${alumno.DNI || '-'}</td>
          <td>${alumno.Email || '-'}</td>
          <td>${alumno.NomInsti || '-'}</td>
          <td>
            <button 
              class="btn btn-danger" 
              style="padding: 6px 12px; font-size: 12px;"
              onclick='handleEliminarClick(${JSON.stringify({
                codeAlum: alumno.CodeAlum,
                nombre: alumno.Nombres + ' ' + alumno.Apellidos
              })})'>
              🗑️ Eliminar
            </button>
          </td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    `;

    resultsContainer.innerHTML = html;

  } else {
    showAlert('error', response.error);
  }
}

function handleBuscarFailure(error) {
  console.error('Error al buscar:', error);
  showAlert('error', 'Error de conexión al buscar');
}

// Eliminar Alumno
function handleEliminarClick(alumno) {
  alumnoToDelete = alumno;
  
  const modalMessage = document.getElementById('modalMessage');
  modalMessage.innerHTML = `
    ¿Estás seguro de eliminar al alumno <strong>${alumno.nombre}</strong> (${alumno.codeAlum})?
  `;
  
  document.getElementById('modalConfirm').classList.add('active');
}

function closeModal() {
  document.getElementById('modalConfirm').classList.remove('active');
  alumnoToDelete = null;
}

function confirmDelete() {
  if (!alumnoToDelete) return;

  const btnConfirm = document.getElementById('btnConfirmDelete');
  btnConfirm.disabled = true;
  btnConfirm.innerHTML = '<span class="spinner"></span>Eliminando...';

  google.script.run
    .withSuccessHandler(handleEliminarSuccess)
    .withFailureHandler(handleEliminarFailure)
    .adminEliminarAlumno({ codeAlum: alumnoToDelete.codeAlum });
}

function handleEliminarSuccess(response) {
  const btnConfirm = document.getElementById('btnConfirmDelete');
  btnConfirm.disabled = false;
  btnConfirm.innerHTML = 'Confirmar Eliminación';

  closeModal();

  if (response.success) {
    showAlert('success', '✓ ' + response.message);
    handleBuscarAlumno();
  } else {
    showAlert('error', response.error);
  }

  alumnoToDelete = null;
}

function handleEliminarFailure(error) {
  console.error('Error al eliminar:', error);
  showAlert('error', 'Error de conexión al eliminar');

  const btnConfirm = document.getElementById('btnConfirmDelete');
  btnConfirm.disabled = false;
  btnConfirm.innerHTML = 'Confirmar Eliminación';
}

// Sistema de Alertas
function showAlert(type, message) {
  const existingAlerts = document.querySelectorAll('.alert');
  existingAlerts.forEach(alert => alert.remove());

  const alertBox = document.createElement('div');
  alertBox.className = 'alert alert-' + type;
  alertBox.textContent = message;

  document.body.appendChild(alertBox);

  setTimeout(function() {
    alertBox.remove();
  }, 4000);
}

// Logout
function logout() {
  if (confirm('¿Deseas cerrar sesión?')) {
    window.location.href = '/';
  }
}
</script>
<!-- MOD-011: FIN -->

<!-- MOD-012: CÓDIGO DE CIERRE [INICIO] -->
</body>
</html>
<!-- MOD-012: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Panel de administración para gestión completa de alumnos
Interfaz responsiva con gradiente azul-morado

FUNCIONALIDADES:
1. Crear Alumno: Formulario colapsable con 11 campos y validaciones
2. Buscar Alumno: Búsqueda multi-criterio (código, nombre, apellido, DNI)
3. Eliminar Alumno: Modal de confirmación antes de eliminar

SECCIONES:
- Navbar: Logo, nombre usuario, botón salir
- Crear Alumno: Formulario con validaciones de unicidad
- Buscar Alumno: Barra de búsqueda + tabla de resultados
- Modal: Confirmación de eliminación con advertencia

CONEXIÓN CON BACKEND:
- adminCrearAlumno() → Admin.crearAlumno() en 1admin.gs
- adminBuscarAlumno() → Admin.buscarAlumno() en 1admin.gs
- adminEliminarAlumno() → Admin.eliminarAlumno() en 1admin.gs

VALIDACIONES:
- Campos obligatorios: CodeAlum, Clave, Nombres, Apellidos
- CodeAlum debe ser único (validación en backend)
- Clave debe ser única (validación en backend)
- Eliminar requiere confirmación modal

CARACTERÍSTICAS TÉCNICAS:
- Búsqueda case-insensitive
- Eliminar borra de 9 hojas diferentes en backend
- Formulario colapsable con animación
- Sistema de alertas con auto-dismiss
- Responsive design para móviles
- Spinner de carga en operaciones asíncronas

DEPENDENCIAS:
- google.script.run (Google Apps Script Client API)
- Backend: 1admin.gs (módulo Admin)
- Backend: 1code.gs (funciones de interfaz)

IMPORTANTE:
- doGet() debe usar createTemplateFromFile()
- Todas las operaciones son asíncronas
- Los errores se muestran mediante sistema de alertas

CAMBIOS V01.17 → V01.18:
- Remodulación completa según Estándar CodeWorkShop v4.0
- CSS encapsulado en MOD-003
- JavaScript encapsulado en MOD-011
- Estructura HTML modularizada
- Comentarios consolidados en MOD-099
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 11/24: 3panelstudent.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/3panelstudent.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 3panelstudent.html
VERSIÓN: 01.21
FECHA: 18/01/2026 15:00 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: APERTURA HTML [INICIO] -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBE Control - Panel Estudiante</title>
<!-- MOD-002: FIN -->

<!-- MOD-003: ESTILOS [INICIO] -->
<style>
/* Reset y Base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: #f5f7fa;
  min-height: 100vh;
}

/* Navbar */
.navbar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 30px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.navbar-brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.navbar-brand h1 {
  font-size: 24px;
  font-weight: 700;
}

.navbar-user {
  display: flex;
  align-items: center;
  gap: 20px;
}

.user-name {
  font-size: 15px;
  opacity: 0.95;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-logout {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-logout:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Layout Principal con Tabs Verticales */
.main-layout {
  max-width: 1400px;
  margin: 30px auto;
  padding: 0 20px;
  display: flex;
  gap: 20px;
}

/* Tabs Verticales (Izquierda) */
.tabs-sidebar {
  width: 260px;
  flex-shrink: 0;
}

.tabs-nav {
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: sticky;
  top: 100px;
}

.tab-btn {
  padding: 20px 25px;
  font-size: 15px;
  font-weight: 600;
  color: #666;
  background: #f5f5f5;
  border: none;
  border-left: 4px solid transparent;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 10px;
}

.tab-btn:hover {
  background: #e8e8e8;
  color: #333;
}

.tab-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-left-color: #4c5fd5;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

/* Contenedor de Contenido (Derecha) */
.content-container {
  flex: 1;
  min-width: 0;
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s ease-out;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Alertas Globales */
.alert {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 24px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 9999;
  animation: slideIn 0.3s ease-out;
  max-width: 400px;
  font-size: 14px;
  font-weight: 500;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border-left: 4px solid #28a745;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border-left: 4px solid #dc3545;
}

.alert-warning {
  background: #fff3cd;
  color: #856404;
  border-left: 4px solid #ffc107;
}

.alert-info {
  background: #d1ecf1;
  color: #0c5460;
  border-left: 4px solid #17a2b8;
}

/* Loading Screen */
.loading-screen {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 20px;
}

.loading-screen.active {
  display: flex;
}

.spinner-large {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(102, 126, 234, 0.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: 16px;
  color: #667eea;
  font-weight: 600;
}

/* Responsive - Mobile */
@media (max-width: 768px) {
  .navbar {
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    position: relative;
  }

  .navbar-brand h1 {
    font-size: 20px;
  }

  .navbar-user {
    flex-direction: column;
    gap: 8px;
  }

  .main-layout {
    flex-direction: column;
    margin: 20px auto;
    padding: 0 12px;
  }

  .tabs-sidebar {
    width: 100%;
    position: relative;
  }

  .tabs-nav {
    position: relative;
    top: 0;
    flex-direction: row;
    overflow-x: auto;
    gap: 8px;
    padding-bottom: 10px;
  }

  .tab-btn {
    padding: 14px 20px;
    border-left: none;
    border-bottom: 3px solid transparent;
    min-width: max-content;
    justify-content: center;
  }

  .tab-btn.active {
    border-left: none;
    border-bottom-color: #4c5fd5;
  }

  .content-container {
    padding: 0;
  }

  .alert {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
  }
}
</style>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT GLOBAL - INICIALIZACIÓN [INICIO] -->
<script>
// Variable Global - Usuario Actual
var currentUser = {
  codeAlum: '',
  nombre: '',
  email: ''
};

// Inicialización Inmediata (IIFE)
(function initializeUserImmediate() {
  try {
    const userData = sessionStorage.getItem('pbe_user');
    
    if (!userData) {
      console.error('✗ No hay datos de sesión');
      alert('No se pudo identificar al usuario. Redirigiendo al login...');
      setTimeout(function() {
        window.top.location.href = '<?!= scriptUrl ?>';
      }, 2000);
      return;
    }
    
    const user = JSON.parse(userData);
    
    if (!user.codeAlum || !user.nombre) {
      console.error('✗ Datos de usuario incompletos:', user);
      alert('Datos de usuario incompletos. Redirigiendo al login...');
      setTimeout(function() {
        window.top.location.href = '<?!= scriptUrl ?>';
      }, 2000);
      return;
    }
    
    currentUser.codeAlum = user.codeAlum;
    currentUser.nombre = user.nombre;
    currentUser.email = user.email || '';
    
    console.log('✅ Usuario inicializado correctamente:', currentUser);
    
  } catch(error) {
    console.error('✗ Error al inicializar usuario:', error);
    alert('Error al cargar datos del usuario. Redirigiendo al login...');
    setTimeout(function() {
      window.top.location.href = '<?!= scriptUrl ?>';
    }, 2000);
  }
})();

console.log('%c🎓 PBE Control - Panel Estudiante V01.21', 
            'font-size: 16px; font-weight: bold; color: #667eea;');
console.log('%c✓ currentUser inicializado ANTES de cargar tabs', 
            'font-size: 12px; color: #28a745;');
</script>
<!-- MOD-004: FIN -->

<!-- MOD-005: CIERRE HEAD Y APERTURA BODY [INICIO] -->
</head>
<body>
<!-- MOD-005: FIN -->

<!-- MOD-006: LOADING SCREEN [INICIO] -->
<div class="loading-screen" id="loadingScreen">
  <div class="spinner-large"></div>
  <div class="loading-text">Cargando datos...</div>
</div>
<!-- MOD-006: FIN -->

<!-- MOD-007: NAVBAR [INICIO] -->
<div class="navbar">
  <div class="navbar-brand">
    <h1>PBE Control</h1>
  </div>
  <div class="navbar-user">
    <span class="user-name">
      👤 <span id="userName">Estudiante</span>
    </span>
    <button class="btn-logout" onclick="logout()">Salir</button>
  </div>
</div>
<!-- MOD-007: FIN -->

<!-- MOD-008: LAYOUT PRINCIPAL [INICIO] -->
<div class="main-layout">
<!-- MOD-008: FIN -->

<!-- MOD-009: TABS SIDEBAR [INICIO] -->
<aside class="tabs-sidebar">
  <div class="tabs-nav">
    <button class="tab-btn active" id="btn-cursosyrep" onclick="switchTab('cursosyrep')">
      📚 Cursos y Repasos
    </button>
    <button class="tab-btn" id="btn-deberes" onclick="switchTab('deberes')">
      📝 Deberes
    </button>
    <button class="tab-btn" id="btn-planning" onclick="switchTab('planning')">
      📅 Planning
    </button>
  </div>
</aside>
<!-- MOD-009: FIN -->

<!-- MOD-010: CONTENEDOR TABS [INICIO] -->
<main class="content-container">
  
  <div id="tab-cursosyrep" class="tab-content active">
    <?!= include('4atabcursosyrep'); ?>
  </div>

  <div id="tab-deberes" class="tab-content">
    <?!= include('4btabdeberes'); ?>
  </div>

  <div id="tab-planning" class="tab-content">
    <?!= include('4ctabplanning'); ?>
  </div>

</main>
<!-- MOD-010: FIN -->

<!-- MOD-011: CIERRE LAYOUT [INICIO] -->
</div>
<!-- MOD-011: FIN -->

<!-- MOD-012: JAVASCRIPT - FUNCIONES GLOBALES [INICIO] -->
<script>
// Actualizar UI cuando el DOM esté listo
window.onload = function() {
  if (currentUser.nombre) {
    document.getElementById('userName').textContent = currentUser.nombre;
  }
  
  console.log('%cVariable global currentUser:', 
              'font-size: 12px; color: #666;', currentUser);
  console.log('%cFunciones globales: showAlert, showLoading, hideLoading, switchTab', 
              'font-size: 12px; color: #666;');
};

// Navegación entre Tabs
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(function(tab) {
    tab.classList.remove('active');
  });

  document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.classList.remove('active');
  });

  document.getElementById('tab-' + tabName).classList.add('active');
  document.getElementById('btn-' + tabName).classList.add('active');

  console.log('Tab cambiado a:', tabName);
}

// Sistema de Alertas Global
function showAlert(type, message) {
  const existingAlerts = document.querySelectorAll('.alert');
  existingAlerts.forEach(function(alert) {
    alert.remove();
  });

  const alertBox = document.createElement('div');
  alertBox.className = 'alert alert-' + type;
  alertBox.textContent = message;

  document.body.appendChild(alertBox);

  setTimeout(function() {
    alertBox.remove();
  }, 4000);
}

// Loading Screen
function showLoading() {
  document.getElementById('loadingScreen').classList.add('active');
}

function hideLoading() {
  document.getElementById('loadingScreen').classList.remove('active');
}

// Logout
function logout() {
  if (confirm('¿Deseas cerrar sesión?')) {
    sessionStorage.clear();
    window.top.location.href = '<?!= scriptUrl ?>';
  }
}

// Utilidades Globales
function formatFecha(fecha) {
  if (!fecha) return '-';
  
  try {
    const partes = fecha.split('/');
    if (partes.length !== 3) return fecha;
    
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                   'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    const dia = parseInt(partes[0]);
    const mes = parseInt(partes[1]) - 1;
    const anio = partes[2];
    
    return dia + ' ' + meses[mes] + ' ' + anio;
  } catch(error) {
    return fecha;
  }
}

function diasRestantes(fecha) {
  if (!fecha) return null;
  
  try {
    const partes = fecha.split('/');
    const fechaObj = new Date(partes[2], partes[1] - 1, partes[0]);
    const hoy = new Date();
    
    const diff = fechaObj - hoy;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  } catch(error) {
    return null;
  }
}

function validarFecha(fecha) {
  if (!fecha) return false;
  
  const regex = /^\d{2}\/\d{2}\/\d{4}$/;
  if (!regex.test(fecha)) return false;
  
  const partes = fecha.split('/');
  const dia = parseInt(partes[0]);
  const mes = parseInt(partes[1]);
  const anio = parseInt(partes[2]);
  
  if (mes < 1 || mes > 12) return false;
  if (dia < 1 || dia > 31) return false;
  if (anio < 2000 || anio > 2100) return false;
  
  return true;
}
</script>
<!-- MOD-012: FIN -->

<!-- MOD-013: CÓDIGO DE CIERRE [INICIO] -->
</body>
</html>
<!-- MOD-013: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Panel principal del estudiante con sistema de tabs verticales
Contenedor maestro que carga sub-módulos mediante include()

ESTRUCTURA:
1. Navbar: Logo, nombre estudiante, botón salir
2. Tabs verticales (3 botones): Cursos y Repasos, Deberes, Planning
3. Contenedores dinámicos con includes de sub-módulos

TABS INCLUIDOS:
- tab-cursosyrep → include('4atabcursosyrep')
- tab-deberes → include('4btabdeberes')
- tab-planning → include('4ctabplanning')

VARIABLE GLOBAL CRÍTICA:
currentUser = { codeAlum, nombre, email }
- Se inicializa ANTES de los includes (MOD-004)
- Ejecuta IIFE inmediato para cargar datos de sessionStorage
- Disponible para todos los sub-módulos incluidos

FLUJO DE INICIALIZACIÓN:
1. MOD-004 ejecuta IIFE que lee sessionStorage
2. Valida existencia y completitud de datos de usuario
3. Asigna datos a currentUser (scope global)
4. Los includes se inyectan y pueden usar currentUser
5. window.onload actualiza UI con nombre de usuario

FUNCIONES GLOBALES DISPONIBLES:
- switchTab(tabName): Navegación entre tabs
- showAlert(type, message): Sistema de alertas
- showLoading() / hideLoading(): Pantalla de carga
- logout(): Cerrar sesión y limpiar sessionStorage
- formatFecha(fecha): Formatear DD/MM/AAAA a texto
- diasRestantes(fecha): Calcular días hasta fecha
- validarFecha(fecha): Validar formato DD/MM/AAAA

CONEXIÓN CON BACKEND:
- Los sub-módulos llaman a funciones student* en 1code.gs
- Todos usan currentUser.codeAlum para identificar al estudiante
- Backend conecta con Student.* en módulos de lógica

CARACTERÍSTICAS TÉCNICAS:
- Tabs verticales en desktop, horizontales en mobile
- Animaciones de transición entre tabs
- Sistema de alertas con auto-dismiss
- Loading screen global
- Responsive design completo
- Sticky navbar y tabs sidebar

DEPENDENCIAS:
- sessionStorage: Debe contener 'pbe_user' con datos del login
- 3index.html: Establece sessionStorage al autenticar
- Sub-módulos: 4atabcursosyrep.html, 4btabdeberes.html, 4ctabplanning.html
- Backend: 1code.gs con wrappers student*

FIX CRÍTICO V01.20 → V01.21:
- currentUser se inicializa mediante IIFE en MOD-004
- IIFE se ejecuta ANTES de los includes
- Garantiza que currentUser exista cuando los tabs se carguen
- Elimina race condition donde tabs buscaban currentUser inexistente

CAMBIOS V01.20 → V01.21:
- Remodulación completa según Estándar CodeWorkShop v4.0
- MOD-004 contiene inicialización crítica de currentUser
- CSS encapsulado en MOD-003
- JavaScript principal en MOD-012
- Estructura HTML modularizada
- Comentarios consolidados en MOD-099
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 12/24: 4atabcursosyrep.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/4atabcursosyrep.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 4atabcursosyrep.html
VERSIÓN: 01.23
FECHA: 18/01/2026 12:35 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
.subtabs-container { margin-bottom: 20px; }

.subtabs-nav {
  display: flex;
  gap: 8px;
  border-bottom: 2px solid #e0e0e0;
  margin-bottom: 20px;
}

.subtab-btn {
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  transition: all 0.3s;
}

.subtab-btn.active {
  color: #667eea;
  border-bottom-color: #667eea;
}

.subtab-content { display: none; }
.subtab-content.active { display: block; }
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR SUBTABS [INICIO] -->
<div class="subtabs-container">

  <div class="subtabs-nav">
    <button class="subtab-btn" id="btn-subtab-cursos"
      onclick="switchSubTab('cursos')">📚 Cursos</button>

    <button class="subtab-btn" id="btn-subtab-repasos"
      onclick="switchSubTab('repasos')">🔄 Repasos</button>
  </div>

  <div id="subtab-cursos" class="subtab-content" data-loaded="false">
    <?!= include('5atabcursos'); ?>
  </div>

  <div id="subtab-repasos" class="subtab-content" data-loaded="false">
    <?!= include('5atabrepasos'); ?>
  </div>

</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function () {
  'use strict';

  const loaded = {
    cursos: false,
    repasos: false
  };

  // Switch de SubTabs
  function switchSubTab(name) {

    document.querySelectorAll('.subtab-content')
      .forEach(el => el.classList.remove('active'));

    document.querySelectorAll('.subtab-btn')
      .forEach(el => el.classList.remove('active'));

    document.getElementById('subtab-' + name).classList.add('active');
    document.getElementById('btn-subtab-' + name).classList.add('active');

    if (!loaded[name]) {
      loaded[name] = true;

      console.log('🟢 Inicializando subtab:', name);
      
      if (name === 'cursos' && window.CursosModule) {
        window.CursosModule.init();
      } else if (name === 'repasos' && window.RepasosModule) {
        window.RepasosModule.init();
      }

      document.dispatchEvent(
        new CustomEvent('pbe:subtab-activated', {
          detail: name
        })
      );
    }
  }

  // Auto-activar Cursos al cargar
  function initDefaultSubTab() {
    console.log('📦 4atabcursosyrep V01.23: Activando Cursos por defecto');
    
    setTimeout(function() {
      switchSubTab('cursos');
    }, 100);
  }

  window.switchSubTab = switchSubTab;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDefaultSubTab);
  } else {
    initDefaultSubTab();
  }

  console.log('%c📦 4atabcursosyrep V01.23 cargado',
    'font-weight:bold;color:#667eea');
})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Contenedor de subtabs para Cursos y Repasos
Sistema de lazy-load controlado por eventos

SUBTABS INCLUIDOS:
- subtab-cursos → include('5atabcursos')
- subtab-repasos → include('5atabrepasos')

FUNCIONALIDAD:
- Navegación entre Cursos y Repasos mediante botones
- Lazy-load: Los subtabs solo se inicializan al activarse por primera vez
- Auto-activación: Cursos se activa por defecto al cargar

FLUJO DE INICIALIZACIÓN:
1. IIFE se ejecuta inmediatamente al cargar el módulo
2. initDefaultSubTab() se llama con delay de 100ms
3. switchSubTab('cursos') activa el primer subtab
4. Llama a CursosModule.init() si existe
5. Dispara evento 'pbe:subtab-activated'

SISTEMA DE LAZY-LOAD:
- Variable loaded controla qué subtabs ya fueron inicializados
- Primera activación: loaded[name] = false → inicializa módulo
- Activaciones posteriores: loaded[name] = true → solo cambia UI

CONEXIÓN CON MÓDULOS:
- window.CursosModule.init(): Inicializa módulo de cursos
- window.RepasosModule.init(): Inicializa módulo de repasos
- Evento 'pbe:subtab-activated': Notifica activación de subtab

CARACTERÍSTICAS TÉCNICAS:
- IIFE para encapsular lógica
- switchSubTab() expuesto globalmente
- Auto-inicialización inteligente (DOMContentLoaded o inmediato)
- Delay de 100ms para garantizar currentUser disponible

DEPENDENCIAS:
- window.CursosModule: Definido en 5atabcursos.html
- window.RepasosModule: Definido en 5atabrepasos.html
- currentUser: Variable global del panel principal

FIX CRÍTICO V01.22 → V01.23:
- Activa subtab Cursos por defecto automáticamente
- Conecta eventos con módulos hijos correctamente
- Llama directamente a init() de módulos
- Elimina race condition de inicialización

CAMBIOS V01.22 → V01.23:
- Remodulación completa según Estándar CodeWorkShop v4.0
- CSS encapsulado en MOD-002
- HTML en MOD-003
- JavaScript en MOD-004 (IIFE completo)
- Comentarios consolidados en MOD-099
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 13/24: 4btabdeberes.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/4btabdeberes.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 4btabdeberes.html
VERSIÓN: 01.19
FECHA: 18/01/2026 15:04 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* Sub-tabs Horizontales */
.subtabs-container {
  margin-bottom: 20px;
}

.subtabs-nav {
  display: flex;
  gap: 8px;
  border-bottom: 2px solid #e0e0e0;
  margin-bottom: 20px;
}

.subtab-btn {
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
  white-space: nowrap;
}

.subtab-btn:hover {
  color: #667eea;
  background: #f9f9f9;
}

.subtab-btn.active {
  color: #667eea;
  border-bottom-color: #667eea;
}

.subtab-content {
  display: none;
}

.subtab-content.active {
  display: block;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Badge con Contador */
.tab-badge {
  display: inline-block;
  background: #e3f2fd;
  color: #1976d2;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  margin-left: 6px;
  min-width: 20px;
  text-align: center;
}

.tab-badge.empty {
  background: #f5f5f5;
  color: #999;
}

/* Responsive - Mobile */
@media (max-width: 768px) {
  .subtabs-nav {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }

  .subtabs-nav::-webkit-scrollbar {
    height: 4px;
  }

  .subtabs-nav::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  .subtabs-nav::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 2px;
  }

  .subtab-btn {
    padding: 10px 18px;
    font-size: 13px;
  }

  .tab-badge {
    font-size: 10px;
    padding: 2px 6px;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR SUBTABS [INICIO] -->
<div class="subtabs-container">
  
  <div class="subtabs-nav">
    <button class="subtab-btn active" id="btn-subtab-todos" onclick="switchSubTabDeberes('todos')">
      📋 Todos
    </button>
    <button class="subtab-btn" id="btn-subtab-eval" onclick="switchSubTabDeberes('eval')">
      📝 Evaluaciones
    </button>
    <button class="subtab-btn" id="btn-subtab-tareas" onclick="switchSubTabDeberes('tareas')">
      ✏️ Tareas
    </button>
    <button class="subtab-btn" id="btn-subtab-lecturas" onclick="switchSubTabDeberes('lecturas')">
      📖 Lecturas
    </button>
  </div>

  <div id="subtab-todos" class="subtab-content active">
    <?!= include('6btabtodos'); ?>
  </div>

  <div id="subtab-eval" class="subtab-content">
    <?!= include('6btabeval'); ?>
  </div>

  <div id="subtab-tareas" class="subtab-content">
    <?!= include('6btabtareas'); ?>
  </div>

  <div id="subtab-lecturas" class="subtab-content">
    <?!= include('6btablecturas'); ?>
  </div>

</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
// Control de Lazy-Init para Módulos
var deberesSubtabsLoaded = {
  todos: false,
  eval: false,
  tareas: false,
  lecturas: false
};

// Navegación entre Sub-tabs Deberes
function switchSubTabDeberes(subTabName) {
  console.log('[4btabdeberes] 🔄 switchSubTabDeberes llamada con:', subTabName);

  document.querySelectorAll('.subtab-content').forEach(function(content) {
    content.classList.remove('active');
  });

  document.querySelectorAll('.subtab-btn').forEach(function(btn) {
    btn.classList.remove('active');
  });

  const selectedTab = document.getElementById('subtab-' + subTabName);
  if (selectedTab) {
    selectedTab.classList.add('active');
    console.log('[4btabdeberes] ✅ Sub-tab activado:', subTabName);
  } else {
    console.error('[4btabdeberes] ❌ No se encontró elemento: subtab-' + subTabName);
  }

  const selectedBtn = document.getElementById('btn-subtab-' + subTabName);
  if (selectedBtn) {
    selectedBtn.classList.add('active');
  } else {
    console.error('[4btabdeberes] ❌ No se encontró botón: btn-subtab-' + subTabName);
  }

  console.log('Sub-tab Deberes cambiado a:', subTabName);

  if (!deberesSubtabsLoaded[subTabName]) {
    deberesSubtabsLoaded[subTabName] = true;

    if (subTabName === 'lecturas' && window.LecturasModule) {
      console.log('[4btabdeberes] 📖 Inicializando LecturasModule...');
      window.LecturasModule.init();
    } else if (subTabName === 'tareas' && window.TareasModule) {
      console.log('[4btabdeberes] ✏️ Inicializando TareasModule...');
      window.TareasModule.init();
    } else if (subTabName === 'eval' && window.EvalModule) {
      console.log('[4btabdeberes] 📝 Inicializando EvalModule...');
      window.EvalModule.init();
    } else if (subTabName === 'todos' && window.TodosModule) {
      console.log('[4btabdeberes] 📋 Inicializando TodosModule...');
      window.TodosModule.init();
    } else {
      console.warn('[4btabdeberes] ⚠️ Módulo no encontrado para:', subTabName);
    }
  } else {
    console.log('[4btabdeberes] ℹ️ Módulo ya inicializado:', subTabName);
  }
}

// Actualizar Contadores en Badges
function updateDeberesBadge(tipo, count) {
  const btn = document.getElementById('btn-subtab-' + tipo);
  if (!btn) return;

  let badge = btn.querySelector('.tab-badge');
  
  if (count > 0) {
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'tab-badge';
      btn.appendChild(badge);
    }
    badge.textContent = count;
    badge.classList.remove('empty');
  } else {
    if (badge) {
      badge.textContent = '0';
      badge.classList.add('empty');
    }
  }
}

// Filtrar por Fecha
function filtrarPorFecha(deberes, fechaDesde, fechaHasta) {
  if (!fechaDesde && !fechaHasta) {
    return deberes;
  }

  return deberes.filter(function(deber) {
    if (!deber.fecha) return false;

    const fechaDeber = parseFechaDD_MM_AAAA(deber.fecha);
    if (!fechaDeber) return false;

    let cumple = true;

    if (fechaDesde) {
      const desde = parseFechaDD_MM_AAAA(fechaDesde);
      if (desde) {
        cumple = cumple && (fechaDeber >= desde);
      }
    }

    if (fechaHasta) {
      const hasta = parseFechaDD_MM_AAAA(fechaHasta);
      if (hasta) {
        cumple = cumple && (fechaDeber <= hasta);
      }
    }

    return cumple;
  });
}

// Parsear fecha DD/MM/AAAA a objeto Date
function parseFechaDD_MM_AAAA(fecha) {
  if (!fecha) return null;
  
  try {
    const partes = fecha.split('/');
    if (partes.length !== 3) return null;
    
    const dia = parseInt(partes[0]);
    const mes = parseInt(partes[1]) - 1;
    const anio = parseInt(partes[2]);
    
    return new Date(anio, mes, dia);
  } catch(error) {
    return null;
  }
}

// Ordenar por Fecha
function ordenarPorFecha(deberes) {
  return deberes.sort(function(a, b) {
    if (!a.fecha) return 1;
    if (!b.fecha) return -1;

    const fechaA = parseFechaDD_MM_AAAA(a.fecha);
    const fechaB = parseFechaDD_MM_AAAA(b.fecha);

    if (!fechaA) return 1;
    if (!fechaB) return -1;

    return fechaA - fechaB;
  });
}

// Auto-activar Sub-tab por defecto
setTimeout(function() {
  console.log('[4btabdeberes] 🚀 Auto-activando sub-tab por defecto: todos');
  switchSubTabDeberes('todos');
}, 100);

console.log('%c📝 Tab Deberes Cargado [V01.19]', 
            'font-size: 12px; font-weight: bold; color: #667eea;');
console.log('Sub-tabs disponibles: Todos, Evaluaciones, Tareas, Lecturas');
console.log('Funciones auxiliares: updateDeberesBadge, filtrarPorFecha, ordenarPorFecha');
console.log('currentUser disponible:', typeof currentUser !== 'undefined');
console.log('Lazy-init habilitado para todos los sub-tabs');
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Contenedor para los sub-tabs de Deberes
Sistema de lazy-load con 4 sub-tabs

SUB-TABS INCLUIDOS:
- subtab-todos → include('6btabtodos'): Vista unificada de todos los deberes
- subtab-eval → include('6btabeval'): CRUD de evaluaciones con notas/pesos
- subtab-tareas → include('6btabtareas'): CRUD de tareas con fechas de entrega
- subtab-lecturas → include('6btablecturas'): CRUD de lecturas con barra de progreso

ESTRUCTURA:
Contenedor ligero que organiza cuatro sub-tabs:
1. Todos: Vista unificada (Eval + Tareas + Lecturas)
2. Evaluaciones: Gestión de evaluaciones
3. Tareas: Gestión de tareas
4. Lecturas: Gestión de lecturas

FUNCIONALIDAD:
- Navegación horizontal entre sub-tabs mediante botones
- Lazy-load: Los sub-tabs solo se inicializan al activarse por primera vez
- Auto-activación: "Todos" se activa por defecto al cargar
- Badges opcionales con contadores

FLUJO DE INICIALIZACIÓN:
1. setTimeout() se ejecuta con delay de 100ms
2. switchSubTabDeberes('todos') activa el primer sub-tab
3. Llama a TodosModule.init() si existe
4. Cambios posteriores no reinicializan, solo cambian UI

SISTEMA DE LAZY-LOAD:
- Variable deberesSubtabsLoaded controla inicializaciones
- Primera activación: loaded[name] = false → inicializa módulo
- Activaciones posteriores: loaded[name] = true → solo UI

CONEXIÓN CON MÓDULOS:
- window.TodosModule.init(): Inicializa vista unificada
- window.EvalModule.init(): Inicializa evaluaciones
- window.TareasModule.init(): Inicializa tareas
- window.LecturasModule.init(): Inicializa lecturas

FUNCIONES AUXILIARES DISPONIBLES:
- updateDeberesBadge(tipo, count): Actualiza contador en badge
- filtrarPorFecha(deberes, desde, hasta): Filtra por rango de fechas
- ordenarPorFecha(deberes): Ordena por fecha (más próxima primero)
- parseFechaDD_MM_AAAA(fecha): Convierte DD/MM/AAAA a Date

CARACTERÍSTICAS TÉCNICAS:
- Scroll horizontal en mobile si no caben los botones
- Animación fadeIn al cambiar de sub-tab
- Badges opcionales con estilos predefinidos
- Funciones auxiliares compartidas entre sub-tabs

DEPENDENCIAS:
- window.TodosModule: Definido en 6btabtodos.html
- window.EvalModule: Definido en 6btabeval.html
- window.TareasModule: Definido en 6btabtareas.html
- window.LecturasModule: Definido en 6btablecturas.html
- currentUser: Variable global del panel principal

FIX CRÍTICO V01.18 → V01.19:
- Corregidos selectores (eliminado #tab-deberes inexistente)
- Agregada activación directa de módulos
- Patrón consistente con 4atabcursosyrep.html
- Lazy-init solo en primera activación

CAMBIOS V01.18 → V01.19:
- Remodulación completa según Estándar CodeWorkShop v4.0
- CSS encapsulado en MOD-002
- HTML en MOD-003
- JavaScript en MOD-004 (funciones globales)
- Comentarios consolidados en MOD-099
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 14/24: 4ctabplanning.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/4ctabplanning.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 4ctabplanning.html
VERSIÓN: 01.19
FECHA: 18/01/2026 15:07 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
.subtabs-container { margin-bottom: 20px; }
.subtabs-nav {
  display: flex;
  gap: 8px;
  border-bottom: 2px solid #e0e0e0;
  margin-bottom: 20px;
}
.subtab-btn {
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  transition: all 0.3s;
  white-space: nowrap;
}
.subtab-btn:hover { color: #667eea; background: #f9f9f9; }
.subtab-btn.active { color: #667eea; border-bottom-color: #667eea; }
.subtab-content { display: none; }
.subtab-content.active { display: block; animation: fadeIn 0.3s ease-out; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
  .subtabs-nav { overflow-x: auto; }
  .subtab-btn { padding: 10px 18px; font-size: 13px; }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR SUBTABS [INICIO] -->
<div class="subtabs-container" id="planning-container">

  <div class="subtabs-nav">
    <button class="subtab-btn active" onclick="PlanningModule.switchTab('horarioclase')">🕐 Horario Clases</button>
    <button class="subtab-btn" onclick="PlanningModule.switchTab('horariosem')">📅 Horario Semanal</button>
    <button class="subtab-btn" onclick="PlanningModule.switchTab('notas')">📊 Notas</button>
    <button class="subtab-btn" onclick="PlanningModule.switchTab('calendario')">🗓️ Calendario</button>
  </div>

  <div id="subtab-horarioclase" class="subtab-content active">
    <?!= include('7ctabhorarioclase'); ?>
  </div>

  <div id="subtab-horariosem" class="subtab-content">
    <?!= include('7ctabhorariosem'); ?>
  </div>

  <div id="subtab-notas" class="subtab-content">
    <?!= include('7ctabnotas'); ?>
  </div>

  <div id="subtab-calendario" class="subtab-content">
    <?!= include('7ctabcalendario'); ?>
  </div>

</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
// Planning Module (Encapsulado)
window.PlanningModule = (function () {

  const state = {
    currentWeekOffset: 0,
    currentMonth: new Date().getMonth(),
    currentYear: new Date().getFullYear()
  };

  function getContainer() {
    return document.getElementById('planning-container');
  }

  function switchTab(name) {
    const container = getContainer();
    if (!container) return;

    container.querySelectorAll('.subtab-content').forEach(el => el.classList.remove('active'));
    container.querySelectorAll('.subtab-btn').forEach(el => el.classList.remove('active'));

    const tab = document.getElementById('subtab-' + name);
    if (tab) tab.classList.add('active');

    const btn = [...container.querySelectorAll('.subtab-btn')]
      .find(b => b.textContent.toLowerCase().includes(name.replace('horario', 'horario')));
    if (btn) btn.classList.add('active');

    console.log('[Planning] Sub-tab activo:', name);
  }

  // Helpers reutilizados por sub-tabs
  function obtenerDiasSemanaActual() {
    const hoy = new Date();
    const lunes = new Date(hoy);
    lunes.setDate(hoy.getDate() - ((hoy.getDay() + 6) % 7));
    return Array.from({ length: 7 }, (_, i) => new Date(lunes.getFullYear(), lunes.getMonth(), lunes.getDate() + i));
  }

  function horaAMinutos(h) {
    if (!h || !h.includes(':')) return 0;
    const [hh, mm] = h.split(':').map(Number);
    return (hh * 60) + mm;
  }

  function minutosAHora(m) {
    const h = Math.floor(m / 60);
    const mm = m % 60;
    return String(h).padStart(2, '0') + ':' + String(mm).padStart(2, '0');
  }

  function calcularPromedioPonderado(items = []) {
    let total = 0, peso = 0;
    items.forEach(i => {
      const n = parseFloat(i.nota), p = parseFloat(i.peso);
      if (!isNaN(n) && !isNaN(p)) {
        total += n * p;
        peso += p;
      }
    });
    return peso ? (total / peso).toFixed(2) : 0;
  }

  console.log('%c📅 Planning V01.19 cargado', 'color:#667eea;font-weight:bold;');

  return {
    switchTab,
    state,
    obtenerDiasSemanaActual,
    horaAMinutos,
    minutosAHora,
    calcularPromedioPonderado
  };

})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Contenedor de sub-tabs de Planning
Módulo totalmente encapsulado en PlanningModule

SUB-TABS INCLUIDOS:
- subtab-horarioclase → include('7ctabhorarioclase'): Horario de clases
- subtab-horariosem → include('7ctabhorariosem'): Horario semanal
- subtab-notas → include('7ctabnotas'): Sistema de notas y promedios
- subtab-calendario → include('7ctabcalendario'): Vista de calendario

ESTRUCTURA:
Contenedor ligero que organiza cuatro sub-tabs de planning:
1. Horario Clases: Gestión de horarios de clases
2. Horario Semanal: Vista semanal del horario
3. Notas: Cálculo de promedios ponderados
4. Calendario: Vista de calendario mensual

MÓDULO ENCAPSULADO:
window.PlanningModule: IIFE que expone funciones públicas
- Previene colisiones globales
- Encapsula estado interno
- Provee helpers compartidos

FUNCIONALIDAD:
- Navegación entre sub-tabs mediante PlanningModule.switchTab()
- Estado compartido: currentWeekOffset, currentMonth, currentYear
- Helpers disponibles para todos los sub-tabs

ESTADO COMPARTIDO:
- state.currentWeekOffset: Offset de semana actual (para navegación)
- state.currentMonth: Mes actual en vista de calendario
- state.currentYear: Año actual en vista de calendario

HELPERS COMPARTIDOS:
- obtenerDiasSemanaActual(): Retorna array de 7 días (L-D) de la semana actual
- horaAMinutos(hora): Convierte "HH:MM" a minutos totales
- minutosAHora(minutos): Convierte minutos totales a "HH:MM"
- calcularPromedioPonderado(items): Calcula promedio con pesos

FLUJO DE NAVEGACIÓN:
1. Usuario hace clic en botón de sub-tab
2. onclick llama a PlanningModule.switchTab(name)
3. switchTab() actualiza clases active en DOM
4. Sub-tab correspondiente se muestra con animación fadeIn

CARACTERÍSTICAS TÉCNICAS:
- IIFE completo para encapsulación total
- Getters seguros (getContainer verifica existencia)
- Helpers matemáticos para horarios y notas
- Estado interno protegido
- API pública clara y limitada

DEPENDENCIAS:
- Sub-módulos: 7ctabhorarioclase.html, 7ctabhorariosem.html, 7ctabnotas.html, 7ctabcalendario.html
- currentUser: Variable global del panel principal
- Funciones globales: showAlert, showLoading, hideLoading (del parent)

USO DE HELPERS DESDE SUB-TABS:
// En cualquier sub-tab de planning:
const dias = PlanningModule.obtenerDiasSemanaActual();
const minutos = PlanningModule.horaAMinutos('14:30');
const promedio = PlanningModule.calcularPromedioPonderado(evaluaciones);

VENTAJAS DEL ENCAPSULADO:
- Sin colisiones de nombres en scope global
- Estado centralizado y protegido
- Helpers compartidos sin duplicación
- Fácil debugging (todo bajo PlanningModule)

CAMBIOS V01.18 → V01.19:
- Remodulación completa según Estándar CodeWorkShop v4.0
- CSS encapsulado en MOD-002
- HTML en MOD-003
- JavaScript (IIFE) en MOD-004
- Comentarios consolidados en MOD-099
- Estructura consistente con otros contenedores de sub-tabs
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 15/24: 5atabcursos.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/5atabcursos.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 5atabcursos.html
VERSIÓN: 01.27
FECHA: 18/01/2026 15:35 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* Header */
.cursos-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.cursos-header h2 {
  color: #333;
  font-size: 20px;
  margin: 0;
}

.header-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* Botón Agregar */
.btn-agregar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
}

.btn-agregar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Tabla */
.cursos-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}

.cursos-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.cursos-table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
}

.cursos-table td {
  padding: 12px;
  border-bottom: 1px solid #dee2e6;
  font-size: 14px;
}

.cursos-table tbody tr:hover {
  background: #f8f9fa;
}

.cursos-table tbody tr:last-child td {
  border-bottom: none;
}

.curso-color-box {
  width: 30px;
  height: 30px;
  border-radius: 6px;
  border: 2px solid #ddd;
}

.acciones-cell {
  text-align: center;
}

.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  padding: 4px 8px;
  margin: 0 4px;
  transition: transform 0.2s;
}

.btn-icon:hover {
  transform: scale(1.2);
}

/* Estados */
.loading-state,
.empty-state,
.error-state {
  text-align: center;
  padding: 60px 20px;
}

.loading-icon,
.empty-state-icon,
.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.loading-text,
.empty-state-text,
.error-text {
  font-size: 16px;
  font-weight: 500;
  color: #666;
  margin-bottom: 20px;
}

.error-state {
  color: #dc3545;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.modal-overlay.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 10px 40px rgba(0,0,0,.2);
}

.modal-content h3 {
  margin: 0 0 20px;
  color: #667eea;
  font-size: 20px;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #333;
  font-size: 13px;
}

.form-group input {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  transition: border 0.3s;
  box-sizing: border-box;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
}

.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  justify-content: flex-end;
}

/* Botones */
.btn-primary,
.btn-secondary,
.btn-danger {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5568d3;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

.btn-danger:hover {
  background: #c82333;
}

.btn-primary:disabled,
.btn-secondary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Responsive */
@media (max-width: 768px) {
  .cursos-header {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }
  
  .btn-agregar {
    width: 100%;
  }
  
  .cursos-table {
    font-size: 12px;
  }
  
  .cursos-table th,
  .cursos-table td {
    padding: 8px;
  }
  
  .modal-content {
    width: 95%;
    padding: 20px;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: HTML CONTAINER [INICIO] -->
<div class="cursos-header">
  <h2>📚 Mis Cursos</h2>
  <div class="header-actions">
    <button class="btn-agregar" onclick="window.abrirModalNuevoCurso()">
      + Agregar Curso
    </button>
  </div>
</div>

<div id="cursosTableContainer">
  <div class="loading-state">
    <div class="loading-icon">⏳</div>
    <div class="loading-text">Cargando cursos...</div>
  </div>
</div>

<div id="modalCurso" class="modal-overlay">
  <div class="modal-content">
    <h3 id="modalCursoTitle">Agregar Curso</h3>
    
    <form id="formCurso" onsubmit="return handleSubmitCurso(event)">
      <input type="hidden" id="cursoRowNumber">
      <input type="hidden" id="cursoModoEdicion" value="false">
      
      <div class="form-group">
        <label>Código del Curso (corto):</label>
        <input type="text" id="cursoCodigo" required maxlength="10" 
          placeholder="Ej: MATE, FIS, QUIM">
      </div>
      
      <div class="form-group">
        <label>Nombre Completo:</label>
        <input type="text" id="cursoNombre" required 
          placeholder="Ej: Matemática Avanzada">
      </div>
      
      <div class="form-group">
        <label>Color:</label>
        <input type="color" id="cursoColor" value="#667eea">
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="window.cerrarModalCurso()">
          Cancelar
        </button>
        <button type="button" class="btn-danger" id="btnEliminarCurso" 
          style="display:none;" onclick="window.eliminarCurso(parseInt(document.getElementById('cursoRowNumber').value))">
          Eliminar
        </button>
        <button type="submit" class="btn-primary" id="btnSubmitCurso">
          Guardar
        </button>
      </div>
    </form>
  </div>
</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function() {
'use strict';

// VARIABLES GLOBALES
let cursosData = [];
let _initDone = false;
let _retryCount = 0;
const MAX_RETRIES = 5;

// INIT CONTROLADO (CON RETRY LOGIC)
function init() {
  console.log('📚 CursosModule.init() llamado (intento ' + (_retryCount + 1) + ')');

  if (_initDone) {
    console.log('📚 CursosModule ya inicializado, ignorando');
    return;
  }

  if (typeof currentUser === 'undefined' || !currentUser) {
    console.warn('📚 currentUser no disponible aún, reintentando...');
    
    if (_retryCount < MAX_RETRIES) {
      _retryCount++;
      setTimeout(init, 200);
    } else {
      console.error('📚 currentUser no disponible después de ' + MAX_RETRIES + ' intentos');
      renderError('Usuario no disponible. Recarga la página.');
    }
    return;
  }

  if (!currentUser.codeAlum) {
    console.error('📚 currentUser.codeAlum está vacío:', currentUser);
    renderError('Código de alumno no disponible');
    return;
  }

  _initDone = true;
  console.log('📚 CursosModule inicializado correctamente para:', currentUser.codeAlum);
  cargarCursos();
}

// CARGA DE DATOS
function cargarCursos() {
  console.log('📚 Cargando cursos para:', currentUser.codeAlum);

  google.script.run
    .withSuccessHandler(handleCursosLoaded)
    .withFailureHandler(handleCursosError)
    .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
}

function handleCursosLoaded(response) {
  console.log('📚 Respuesta recibida:', response);

  if (!response) {
    console.error('📚 Response es NULL');
    renderError('Error: El servidor retornó NULL');
    return;
  }

  if (response.success !== true) {
    console.error('📚 Response no exitoso:', response.error);
    renderError(response.error || 'Error al cargar cursos');
    return;
  }

  cursosData = response.data || [];
  console.log('📚 Cursos cargados:', cursosData.length);

  if (cursosData.length > 0) {
    renderTable();
  } else {
    renderEmptyState();
  }
}

function handleCursosError(error) {
  console.error('📚 Error al cargar cursos:', error);
  renderError('Error de conexión con el servidor');
}

// RENDER - TABLA DE CURSOS
function renderTable() {
  const container = document.getElementById('cursosTableContainer');
  if (!container) return;

  let html = '<table class="cursos-table">';
  html += '<thead>';
  html += '<tr>';
  html += '<th style="width:60px;">Color</th>';
  html += '<th>Curso</th>';
  html += '<th>Nombre Completo</th>';
  html += '<th style="width:100px;">Acciones</th>';
  html += '</tr>';
  html += '</thead>';
  html += '<tbody>';

  cursosData.forEach(function(curso) {
    html += '<tr>';
    html += '<td>';
    html += '<div class="curso-color-box" style="background-color:' + curso.Color + ';"></div>';
    html += '</td>';
    html += '<td><strong>' + curso.Curso + '</strong></td>';
    html += '<td>' + curso.Completo + '</td>';
    html += '<td>';
    html += '<button onclick="window.editarCurso(' + curso._rowNumber + ')" style="background:none;border:none;cursor:pointer;font-size:16px;" title="Editar">✏️</button>';
    html += '<button onclick="window.eliminarCurso(' + curso._rowNumber + ')" style="background:none;border:none;cursor:pointer;font-size:16px;margin-left:8px;" title="Eliminar">🗑️</button>';
    html += '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
  console.log('📚 Tabla renderizada con', cursosData.length, 'cursos');
}

// RENDER - ESTADO VACÍO
function renderEmptyState() {
  const container = document.getElementById('cursosTableContainer');
  if (!container) return;

  container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📚</div><div class="empty-state-text">No tienes cursos registrados aún.</div><button class="btn-primary" onclick="window.abrirModalNuevoCurso()">➕ Agregar Primer Curso</button></div>';
  console.log('📚 Empty state renderizado');
}

// RENDER - ESTADO DE ERROR
function renderError(message) {
  const container = document.getElementById('cursosTableContainer');
  if (!container) return;

  container.innerHTML = '<div class="error-state"><div class="error-icon">⚠️</div><div class="error-text">' + message + '</div><button class="btn-danger" onclick="location.reload()">🔄 Recargar Página</button></div>';
  console.error('📚 Error state renderizado:', message);
}

// MODAL - ABRIR NUEVO CURSO
function abrirModalNuevoCurso() {
  console.log('➕ Abrir modal nuevo curso');
  
  document.getElementById('modalCursoTitle').textContent = 'Agregar Curso';
  document.getElementById('cursoRowNumber').value = '';
  document.getElementById('cursoModoEdicion').value = 'false';
  document.getElementById('cursoCodigo').value = '';
  document.getElementById('cursoNombre').value = '';
  document.getElementById('cursoColor').value = '#667eea';
  
  document.getElementById('btnEliminarCurso').style.display = 'none';
  document.getElementById('btnSubmitCurso').textContent = 'Guardar';
  
  document.getElementById('modalCurso').classList.add('active');
  
  setTimeout(function() {
    document.getElementById('cursoCodigo').focus();
  }, 100);
}

// MODAL - EDITAR CURSO
function editarCurso(rowNumber) {
  console.log('✏️ Editar curso:', rowNumber);
  
  const curso = cursosData.find(function(c) {
    return c._rowNumber === rowNumber;
  });
  
  if (!curso) {
    alert('Error: Curso no encontrado');
    return;
  }
  
  document.getElementById('modalCursoTitle').textContent = 'Editar Curso';
  document.getElementById('cursoRowNumber').value = rowNumber;
  document.getElementById('cursoModoEdicion').value = 'true';
  document.getElementById('cursoCodigo').value = curso.Curso;
  document.getElementById('cursoNombre').value = curso.Completo;
  document.getElementById('cursoColor').value = curso.Color || '#667eea';
  
  document.getElementById('btnEliminarCurso').style.display = 'inline-block';
  document.getElementById('btnSubmitCurso').textContent = 'Actualizar';
  
  document.getElementById('modalCurso').classList.add('active');
}

// MODAL - CERRAR
function cerrarModalCurso() {
  document.getElementById('modalCurso').classList.remove('active');
  document.getElementById('formCurso').reset();
}

// SUBMIT - GUARDAR CURSO
function handleSubmitCurso(event) {
  event.preventDefault();
  
  const codigo = document.getElementById('cursoCodigo').value.trim();
  const nombre = document.getElementById('cursoNombre').value.trim();
  const color = document.getElementById('cursoColor').value;
  const esEdicion = document.getElementById('cursoModoEdicion').value === 'true';
  const rowNumber = document.getElementById('cursoRowNumber').value;
  
  if (!codigo || !nombre) {
    alert('Por favor completa todos los campos');
    return false;
  }
  
  const btnSubmit = document.getElementById('btnSubmitCurso');
  btnSubmit.disabled = true;
  btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';
  
  const params = {
    codeAlum: currentUser.codeAlum,
    curso: codigo,
    completo: nombre,
    color: color
  };
  
  if (esEdicion) {
    if (rowNumber) {
      params.rowNumber = parseInt(rowNumber);
    }
    
    google.script.run
      .withSuccessHandler(function(r) {
        handleCursoGuardado(r, true);
      })
      .withFailureHandler(function(e) {
        handleCursoError(e, true);
      })
      .studentActualizarCurso(params);
  } else {
    google.script.run
      .withSuccessHandler(function(r) {
        handleCursoGuardado(r, false);
      })
      .withFailureHandler(function(e) {
        handleCursoError(e, false);
      })
      .studentAgregarCurso(params);
  }
  
  return false;
}

function handleCursoGuardado(response, esEdicion) {
  const btnSubmit = document.getElementById('btnSubmitCurso');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  if (response && response.success) {
    const msg = esEdicion ? '✔ Curso actualizado' : '✔ Curso agregado';
    
    if (window.showAlert) {
      showAlert('success', msg);
    } else {
      alert(msg);
    }
    
    cerrarModalCurso();
    cargarCursos();
  } else {
    const error = response ? response.error : 'Error desconocido';
    
    if (window.showAlert) {
      showAlert('error', error);
    } else {
      alert('Error: ' + error);
    }
  }
}

function handleCursoError(error, esEdicion) {
  console.error('📚 Error:', error);
  
  const btnSubmit = document.getElementById('btnSubmitCurso');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  if (window.showAlert) {
    showAlert('error', 'Error de conexión. Intenta nuevamente');
  } else {
    alert('Error de conexión. Intenta nuevamente');
  }
}

// ELIMINAR CURSO
function eliminarCurso(rowNumber) {
  console.log('🗑️ Eliminar curso:', rowNumber);
  
  const curso = cursosData.find(function(c) {
    return c._rowNumber === rowNumber;
  });
  
  if (!curso) {
    alert('Error: Curso no encontrado');
    return;
  }
  
  if (!confirm('¿Eliminar el curso "' + curso.Curso + '"?\n\nEsta acción no se puede deshacer.')) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(handleCursoEliminado)
    .withFailureHandler(function(e) {
      console.error('📚 Error al eliminar:', e);
      
      if (window.showAlert) {
        showAlert('error', 'Error al eliminar');
      } else {
        alert('Error al eliminar');
      }
    })
    .studentEliminarCurso({ rowNumber: rowNumber });
}

function handleCursoEliminado(response) {
  if (response && response.success) {
    if (window.showAlert) {
      showAlert('success', '✔ Curso eliminado');
    } else {
      alert('Curso eliminado');
    }
    
    cerrarModalCurso();
    cargarCursos();
  } else {
    const error = response ? response.error : 'Error desconocido';
    
    if (window.showAlert) {
      showAlert('error', error);
    } else {
      alert('Error: ' + error);
    }
  }
}

// EXPOSICIÓN GLOBAL
window.abrirModalNuevoCurso = abrirModalNuevoCurso;
window.editarCurso = editarCurso;
window.eliminarCurso = eliminarCurso;
window.cerrarModalCurso = cerrarModalCurso;
window.handleSubmitCurso = handleSubmitCurso;

window.CursosModule = {
  init: init,
  reload: function() {
    _initDone = false;
    _retryCount = 0;
    init();
  }
};

// AUTO-INIT SI CURRENTUSER EXISTE
setTimeout(function() {
  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    console.log('📚 currentUser detectado, auto-inicializando...');
    init();
  } else {
    console.log('📚 currentUser no disponible, esperando llamada externa');
  }
}, 150);

console.log('%c📚 CursosModule V01.27 cargado', 'font-size:11px;color:#667eea;font-weight:bold');

})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Sub-tab de gestión de cursos con CRUD completo
Tabla con colores personalizados y modal responsive

FUNCIONALIDAD:
Crear, editar y eliminar cursos del estudiante
Asignar color personalizado a cada curso
Visualización en tabla con color, código y nombre
Modal con validación de campos obligatorios

ESTRUCTURA DE DATOS:
Curso: { FechaReg, CodeAlum, Curso, Completo, Color, _rowNumber }
- Curso: Código corto (máx 10 caracteres)
- Completo: Nombre completo del curso
- Color: Hex color para identificación visual (#667eea por defecto)
- _rowNumber: ID interno para operaciones de edición/eliminación

CARACTERÍSTICAS TÉCNICAS:
Retry logic robusto: 5 intentos con 200ms de delay
Init tracking: _initDone previene dobles inicializaciones
Auto-init: setTimeout(150ms) para inicialización automática
Fallbacks: alert() si showAlert no está disponible
Validación: HTML5 + validación manual de campos

FLUJO DE TRABAJO:
1. Init verifica currentUser y carga cursos
2. Render de tabla con colores y acciones
3. Modal se abre vacío (agregar) o prellenado (editar)
4. Validación de campos en submit
5. Llamada al backend correspondiente
6. Refresh automático de tabla tras éxito

CONEXIÓN BACKEND:
studentObtenerCursos({ codeAlum }): Lista de cursos
studentAgregarCurso({ codeAlum, curso, completo, color }): Crear
studentActualizarCurso({ codeAlum, curso, completo, color, rowNumber }): Actualizar
studentEliminarCurso({ rowNumber }): Eliminar

DEPENDENCIAS:
currentUser.codeAlum: Identificador del estudiante (obligatorio)
showAlert(type, message): Función global de alertas (fallback a alert())

ESTADOS UI:
Loading: Spinner con mensaje "Cargando cursos..."
Vacío: Icono + botón "Agregar Primer Curso"
Tabla: Grid con cursos y botones de acción (✏️ editar, 🗑️ eliminar)
Error: Mensaje de error con botón "Recargar Página"

TABLA:
Columna Color: Box visual de 30x30px con el color del curso
Columna Curso: Código corto en negrita
Columna Nombre Completo: Nombre descriptivo
Columna Acciones: Botones inline para editar y eliminar

MODAL:
Título dinámico: "Agregar Curso" o "Editar Curso"
3 campos: Código (max 10 chars), Nombre completo, Color picker
Botones: Cancelar, Eliminar (solo en edición), Guardar/Actualizar
Focus automático en primer campo al abrir

CAMBIOS V01.26 → V01.27:
Remodulación completa según Estándar CodeWorkShop v4.0
Reordenamiento: CSS (MOD-002) → HTML (MOD-003) → JS (MOD-004) → Notas (MOD-099)
Comentarios internos aligerados: sin barras decorativas
Notas consolidadas y expandidas en MOD-099
Mantiene lógica funcional sin cambios
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 16/24: 5atabrepasos.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/5atabrepasos.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 5atabrepasos.html
VERSIÓN: 01.20
FECHA: 18/01/2026 13:05 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* Contenedor Principal */
.repasos-container {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.repasos-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.repasos-header h2 {
  color: #333;
  font-size: 20px;
  margin: 0;
}

.header-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* Filtros */
.filtro-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filtro-container label {
  font-size: 13px;
  font-weight: 600;
  color: #666;
}

.filtro-container select {
  padding: 8px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 13px;
  min-width: 150px;
  cursor: pointer;
  transition: border-color 0.3s;
}

.filtro-container select:focus {
  outline: none;
  border-color: #667eea;
}

/* Botones */
.btn-agregar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
}

.btn-agregar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5568d3;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-icon {
  background: transparent;
  border: none;
  color: #667eea;
  cursor: pointer;
  font-size: 18px;
  padding: 4px 8px;
  transition: all 0.2s;
}

.btn-icon:hover {
  transform: scale(1.2);
}

.btn-icon.delete {
  color: #dc3545;
}

.btn-icon.evaluated {
  color: #E91E63;
}

/* Formulario */
.form-repaso {
  background: #f9f9f9;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 24px;
  display: none;
}

.form-repaso.active {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}

.form-group {
  margin-bottom: 0;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
}

.form-group label .required {
  color: #dc3545;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  border: 2px solid #ddd;
  border-radius: 6px;
  transition: all 0.3s;
  font-family: inherit;
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group-checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}

.form-group-checkbox input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.form-group-checkbox label {
  font-size: 13px;
  font-weight: 600;
  color: #E91E63;
  margin: 0;
  cursor: pointer;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

/* Tabla de Repasos */
.repasos-table-container {
  overflow-x: auto;
}

.repasos-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.repasos-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.repasos-table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
}

.repasos-table tbody tr {
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.2s;
}

.repasos-table tbody tr:hover {
  background: #f8f9fa;
}

.repasos-table tbody tr.evaluado {
  background-color: #FFE6E6 !important;
}

.repasos-table tbody tr.evaluado:hover {
  background-color: #FFD4D4 !important;
}

.repasos-table td {
  padding: 12px;
  color: #333;
}

/* Badges de Estado */
.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
}

.badge-ok {
  background: #d4edda;
  color: #155724;
}

.badge-falta {
  background: #f8d7da;
  color: #721c24;
}

.badge-evaluado {
  background: #FFE6E6;
  color: #E91E63;
  margin-left: 6px;
}

/* Estado Vacío */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 15px;
}

/* Loading */
.loading-container {
  text-align: center;
  padding: 40px;
  color: #667eea;
}

.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(102, 126, 234, 0.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
  .repasos-container { padding: 16px; }

  .repasos-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .header-actions { width: 100%; }

  .btn-agregar,
  .filtro-container { width: 100%; }

  .filtro-container {
    flex-direction: column;
    align-items: flex-start;
  }

  .filtro-container select { width: 100%; }

  .form-row { grid-template-columns: 1fr; }

  .form-actions { flex-direction: column; }

  .form-actions .btn { width: 100%; }

  .repasos-table { font-size: 13px; }

  .repasos-table th,
  .repasos-table td { padding: 8px; }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR REPASOS [INICIO] -->
<div class="repasos-container">

  <div class="repasos-header">
    <h2>🔄 Mis Repasos</h2>
    <div class="header-actions">
      <div class="filtro-container">
        <label>Filtrar:</label>
        <select id="filtroCurso" onchange="RepasosModule.aplicarFiltro()">
          <option value="">Todos los cursos</option>
        </select>
      </div>
      <button class="btn-agregar" onclick="RepasosModule.toggleFormAgregar()">
        + Agregar Repaso
      </button>
    </div>
  </div>

  <div id="formRepaso" class="form-repaso">
    <h3 id="formTitle" style="margin-bottom: 16px; color: #667eea;">Agregar Nuevo Repaso</h3>

    <form id="repasoForm" onsubmit="RepasosModule.handleSubmitRepaso(event)">
      <input type="hidden" id="repasoRowNumber" value="">
      <input type="hidden" id="repasoModoEdicion" value="false">

      <div class="form-row">
        <div class="form-group">
          <label>Curso <span class="required">*</span></label>
          <select id="repasoCurso" required>
            <option value="">Seleccionar curso...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Tema <span class="required">*</span></label>
          <input
            type="text"
            id="repasoTema"
            placeholder="Ej: Funciones cuadráticas"
            required
          >
        </div>

        <div class="form-group">
          <label>Estado <span class="required">*</span></label>
          <select id="repasoEstadoRep" required>
            <option value="">Seleccionar estado...</option>
            <option value="OK">OK</option>
            <option value="Falta">Falta</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Fecha de Clase <span class="required">*</span></label>
          <input
            type="text"
            id="repasoFechaClase"
            placeholder="DD/MM/AAAA"
            required
          >
          <small style="color: #666; font-size: 12px;">Fecha de la clase original</small>
        </div>

        <div class="form-group">
          <label>Fecha de Repaso <span class="required">*</span></label>
          <input
            type="text"
            id="repasoFechaRep"
            placeholder="DD/MM/AAAA"
            required
          >
          <small style="color: #666; font-size: 12px;">Fecha en que se repasó</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Detalle (Opcional)</label>
          <textarea
            id="repasoDetalle"
            placeholder="Observaciones adicionales sobre el repaso..."
          ></textarea>
        </div>
      </div>

      <div class="form-group-checkbox">
        <input
          type="checkbox"
          id="repasoEvaluado"
          value="Si"
        >
        <label for="repasoEvaluado">
          ⭐ Marcar como Evaluado (fondo rosado en tabla)
        </label>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" id="btnSubmit">
          Guardar Repaso
        </button>
        <button type="button" class="btn btn-secondary" onclick="RepasosModule.cancelarFormRepaso()">
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <div id="repasosTableContainer" class="repasos-table-container">
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando repasos...</p>
    </div>
  </div>

</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function PBE_REPASOS_MODULE() {
  'use strict';

  let repasosData = [];
  let cursosListaData = [];
  let repasosFiltrados = [];
  let _initDone = false;

  function escHtml(value) {
    const s = String(value == null ? '' : value);
    return s
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function escOnclickSingleQuote(value) {
    const s = String(value == null ? '' : value);
    return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
  }

  function sanitizeEstado(value) {
    const s = String(value == null ? '' : value).trim().toUpperCase();
    if (s === 'OK') return 'OK';
    if (s === 'FALTA') return 'Falta';
    return 'Falta';
  }

  function toSafeRowNumber(value) {
    const n = parseInt(String(value), 10);
    return Number.isFinite(n) && n > 0 ? n : null;
  }

  function init() {
    if (_initDone) return;

    if (typeof currentUser === 'undefined' || !currentUser || !currentUser.codeAlum) {
      mostrarError('Error: No se pudo identificar al usuario');
      return;
    }

    _initDone = true;
    cargarCursos();
    cargarRepasos();
  }

  window.addEventListener('load', init);

  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    init();
  }

  function cargarCursos() {
    google.script.run
      .withSuccessHandler(handleCursosLoaded)
      .withFailureHandler(handleError)
      .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
  }

  function handleCursosLoaded(response) {
    if (!response || response.success !== true) {
      console.error('Error cargarCursos:', response);
      return;
    }

    cursosListaData = response.data || [];
    poblarDropdownCursos();
  }

  function poblarDropdownCursos() {
    const selectCurso = document.getElementById('repasoCurso');
    const selectFiltro = document.getElementById('filtroCurso');

    if (!selectCurso || !selectFiltro) return;

    selectCurso.innerHTML = '<option value="">Seleccionar curso...</option>';
    selectFiltro.innerHTML = '<option value="">Todos los cursos</option>';

    cursosListaData.forEach(function(curso) {
      const cursoVal = String((curso && curso.Curso) || '');
      const completoVal = String((curso && curso.Completo) || '');

      const option1 = document.createElement('option');
      option1.value = cursoVal;
      option1.textContent = cursoVal + (completoVal ? ' - ' + completoVal : '');
      selectCurso.appendChild(option1);

      const option2 = document.createElement('option');
      option2.value = cursoVal;
      option2.textContent = cursoVal + (completoVal ? ' - ' + completoVal : '');
      selectFiltro.appendChild(option2);
    });
  }

  function cargarRepasos() {
    google.script.run
      .withSuccessHandler(handleRepasosLoaded)
      .withFailureHandler(handleRepasosError)
      .studentObtenerRepasos({ codeAlum: currentUser.codeAlum });
  }

  function handleRepasosLoaded(response) {
    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudieron cargar los repasos.';
      mostrarError('Error al cargar repasos: ' + msg);
      renderEmptyState();
      return;
    }

    repasosData = response.data || [];
    repasosFiltrados = repasosData;

    if (typeof updateDeberesBadge === 'function') {
      updateDeberesBadge('repasos', repasosData.length);
    }

    renderRepasosTable();
  }

  function handleRepasosError(error) {
    console.error('Error al cargar repasos:', error);
    mostrarError('Error de conexión al cargar repasos');
    renderEmptyState();
  }

  function aplicarFiltro() {
    const el = document.getElementById('filtroCurso');
    const cursoSeleccionado = el ? el.value : '';

    if (!cursoSeleccionado) {
      repasosFiltrados = repasosData;
    } else {
      repasosFiltrados = (repasosData || []).filter(function(repaso) {
        return String((repaso && repaso.Curso) || '') === String(cursoSeleccionado);
      });
    }

    renderRepasosTable();
  }

  function renderRepasosTable() {
    const container = document.getElementById('repasosTableContainer');
    if (!container) return;

    if (!repasosFiltrados || repasosFiltrados.length === 0) {
      renderEmptyState();
      return;
    }

    let html = '<table class="repasos-table"><thead><tr><th>Curso</th><th>Tema</th><th>Fecha Clase</th><th>Fecha Repaso</th><th>Estado</th><th>Detalle</th><th>Acciones</th></tr></thead><tbody>';

    repasosFiltrados.forEach(function(repaso) {
      const curso = escHtml((repaso && repaso.Curso) || '');
      const tema = escHtml((repaso && repaso.Tema) || '');
      const fechaClase = escHtml((repaso && repaso.FechaClase) || '');
      const fechaRep = escHtml((repaso && repaso.FechaRep) || '');
      const detalle = escHtml((repaso && repaso.Detalle) || '-') || '-';

      const evaluado = String((repaso && repaso.Evaluado) || '') === 'Si';
      const claseEvaluado = evaluado ? 'evaluado' : '';
      const badgeEvaluado = evaluado ? '<span class="badge badge-evaluado">EVALUADO</span>' : '';

      const estado = sanitizeEstado((repaso && repaso.EstadoRep) || '');
      const estadoBadge = estado === 'OK' ? 'badge-ok' : 'badge-falta';

      const rowNumber = toSafeRowNumber(repaso && repaso._rowNumber);
      const rowNumberSafe = rowNumber != null ? rowNumber : -1;

      const temaOnclickSafe = escOnclickSingleQuote((repaso && repaso.Tema) || '');

      html += '<tr class="' + claseEvaluado + '"><td><strong>' + curso + '</strong></td><td>' + tema + badgeEvaluado + '</td><td>' + fechaClase + '</td><td>' + fechaRep + '</td><td><span class="badge ' + estadoBadge + '">' + escHtml(estado) + '</span></td><td>' + detalle + '</td><td><button class="btn-icon" onclick="RepasosModule.editarRepaso(' + rowNumberSafe + ')" title="Editar">✏️</button><button class="btn-icon delete" onclick="RepasosModule.confirmarEliminarRepaso(' + rowNumberSafe + ', \'' + temaOnclickSafe + '\')" title="Eliminar">🗑️</button></td></tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function renderEmptyState() {
    const container = document.getElementById('repasosTableContainer');
    if (!container) return;

    const filtroEl = document.getElementById('filtroCurso');
    const filtroActivo = filtroEl ? (filtroEl.value !== '') : false;

    if (filtroActivo) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><div class="empty-state-text">No hay repasos para el curso seleccionado.</div></div>';
    } else {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔄</div><div class="empty-state-text">No tienes repasos registrados aún.<br>Haz clic en "+ Agregar Repaso" para comenzar.</div></div>';
    }
  }

  function toggleFormAgregar() {
    const form = document.getElementById('formRepaso');
    if (!form) return;

    const isActive = form.classList.contains('active');

    if (isActive) {
      form.classList.remove('active');
    } else {
      resetFormRepaso();
      const titleEl = document.getElementById('formTitle');
      if (titleEl) titleEl.textContent = 'Agregar Nuevo Repaso';
      const modoEl = document.getElementById('repasoModoEdicion');
      if (modoEl) modoEl.value = 'false';
      form.classList.add('active');
    }
  }

  function handleSubmitRepaso(event) {
    event.preventDefault();

    const curso = document.getElementById('repasoCurso') ? document.getElementById('repasoCurso').value : '';
    const temaRaw = document.getElementById('repasoTema') ? document.getElementById('repasoTema').value : '';
    const fechaClaseRaw = document.getElementById('repasoFechaClase') ? document.getElementById('repasoFechaClase').value : '';
    const fechaRepRaw = document.getElementById('repasoFechaRep') ? document.getElementById('repasoFechaRep').value : '';
    const estadoRep = document.getElementById('repasoEstadoRep') ? document.getElementById('repasoEstadoRep').value : '';
    const detalleRaw = document.getElementById('repasoDetalle') ? document.getElementById('repasoDetalle').value : '';
    const evaluado = document.getElementById('repasoEvaluado') ? (document.getElementById('repasoEvaluado').checked ? 'Si' : '') : '';
    const rowNumberStr = document.getElementById('repasoRowNumber') ? document.getElementById('repasoRowNumber').value : '';
    const esEdicion = document.getElementById('repasoModoEdicion') ? (document.getElementById('repasoModoEdicion').value === 'true') : false;

    const tema = String(temaRaw || '').trim();
    const fechaClase = String(fechaClaseRaw || '').trim();
    const fechaRep = String(fechaRepRaw || '').trim();
    const detalle = String(detalleRaw || '').trim();

    if (!curso || !tema || !fechaClase || !fechaRep || !estadoRep) {
      mostrarError('Completa todos los campos obligatorios');
      return;
    }

    if (!validarFecha(fechaClase) || !validarFecha(fechaRep)) {
      mostrarError('Formato de fecha inválido. Use DD/MM/AAAA');
      return;
    }

    const btnSubmit = document.getElementById('btnSubmit');
    if (btnSubmit) {
      btnSubmit.disabled = true;
      btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';
    }

    const params = {
      codeAlum: currentUser.codeAlum,
      curso: curso,
      tema: tema,
      fechaClase: fechaClase,
      fechaRep: fechaRep,
      estadoRep: estadoRep,
      detalle: detalle,
      evaluado: evaluado
    };

    if (esEdicion) {
      const rn = toSafeRowNumber(rowNumberStr);
      if (rn == null) {
        mostrarError('Error: No se pudo identificar la fila a actualizar (rowNumber inválido).');
        if (btnSubmit) {
          btnSubmit.disabled = false;
          btnSubmit.textContent = 'Guardar Repaso';
        }
        return;
      }

      params.rowNumber = rn;

      google.script.run
        .withSuccessHandler(handleRepasoUpdated)
        .withFailureHandler(handleRepasoError)
        .studentActualizarRepaso(params);
    } else {
      google.script.run
        .withSuccessHandler(handleRepasoAdded)
        .withFailureHandler(handleRepasoError)
        .studentAgregarRepaso(params);
    }
  }

  function handleRepasoAdded(response) {
    const btnSubmit = document.getElementById('btnSubmit');
    if (btnSubmit) {
      btnSubmit.disabled = false;
      btnSubmit.textContent = 'Guardar Repaso';
    }

    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo agregar el repaso.';
      mostrarError(msg);
      return;
    }

    mostrarExito('✓ Repaso agregado exitosamente');
    cancelarFormRepaso();
    cargarRepasos();
  }

  function handleRepasoUpdated(response) {
    const btnSubmit = document.getElementById('btnSubmit');
    if (btnSubmit) {
      btnSubmit.disabled = false;
      btnSubmit.textContent = 'Guardar Repaso';
    }

    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo actualizar el repaso.';
      mostrarError(msg);
      return;
    }

    mostrarExito('✓ Repaso actualizado exitosamente');
    cancelarFormRepaso();
    cargarRepasos();
  }

  function handleRepasoError(error) {
    console.error('Error:', error);
    mostrarError('Error de conexión. Intenta nuevamente');

    const btnSubmit = document.getElementById('btnSubmit');
    if (btnSubmit) {
      btnSubmit.disabled = false;
      btnSubmit.textContent = 'Guardar Repaso';
    }
  }

  function editarRepaso(rowNumber) {
    const rn = toSafeRowNumber(rowNumber);
    if (rn == null) {
      mostrarError('Error: rowNumber inválido para editar.');
      return;
    }

    const repaso = (repasosData || []).find(r => toSafeRowNumber(r && r._rowNumber) === rn);
    if (!repaso) return;

    const titleEl = document.getElementById('formTitle');
    if (titleEl) titleEl.textContent = 'Editar Repaso';

    document.getElementById('repasoRowNumber').value = rn;
    document.getElementById('repasoModoEdicion').value = 'true';
    document.getElementById('repasoCurso').value = repaso.Curso || '';
    document.getElementById('repasoTema').value = repaso.Tema || '';
    document.getElementById('repasoFechaClase').value = repaso.FechaClase || '';
    document.getElementById('repasoFechaRep').value = repaso.FechaRep || '';
    document.getElementById('repasoEstadoRep').value = repaso.EstadoRep || '';
    document.getElementById('repasoDetalle').value = repaso.Detalle || '';
    document.getElementById('repasoEvaluado').checked = String(repaso.Evaluado || '') === 'Si';

    const form = document.getElementById('formRepaso');
    if (form) form.classList.add('active');

    const temaEl = document.getElementById('repasoTema');
    if (temaEl) temaEl.focus();
  }

  function confirmarEliminarRepaso(rowNumber, tema) {
    const rn = toSafeRowNumber(rowNumber);
    if (rn == null) {
      mostrarError('Error: rowNumber inválido para eliminar.');
      return;
    }

    const temaMsg = String(tema == null ? '' : tema);
    if (confirm('¿Eliminar el repaso "' + temaMsg + '"?\n\nEsta acción no se puede deshacer.')) {
      eliminarRepaso(rn);
    }
  }

  function eliminarRepaso(rowNumber) {
    const rn = toSafeRowNumber(rowNumber);
    if (rn == null) {
      mostrarError('Error: rowNumber inválido para eliminar.');
      return;
    }

    google.script.run
      .withSuccessHandler(handleRepasoDeleted)
      .withFailureHandler(handleRepasoError)
      .studentEliminarRepaso({ rowNumber: rn });
  }

  function handleRepasoDeleted(response) {
    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo eliminar el repaso.';
      mostrarError(msg);
      return;
    }

    mostrarExito('✓ Repaso eliminado exitosamente');
    cargarRepasos();
  }

  function resetFormRepaso() {
    const form = document.getElementById('repasoForm');
    if (form) form.reset();

    const rn = document.getElementById('repasoRowNumber');
    if (rn) rn.value = '';

    const modo = document.getElementById('repasoModoEdicion');
    if (modo) modo.value = 'false';

    const evalEl = document.getElementById('repasoEvaluado');
    if (evalEl) evalEl.checked = false;
  }

  function cancelarFormRepaso() {
    const form = document.getElementById('formRepaso');
    if (form) form.classList.remove('active');
    resetFormRepaso();
  }

  function handleError(error) {
    console.error('Error:', error);
    mostrarError('Error de conexión');
  }

  function validarFecha(fecha) {
    const regex = /^\d{2}\/\d{2}\/\d{4}$/;
    return regex.test(String(fecha || '').trim());
  }

  function mostrarExito(mensaje) {
    if (typeof showAlert === 'function') {
      showAlert('success', mensaje);
    } else {
      console.log('✓ ' + mensaje);
    }
  }

  function mostrarError(mensaje) {
    if (typeof showAlert === 'function') {
      showAlert('error', mensaje);
    } else {
      console.error('✗ ' + mensaje);
    }
  }

  window.RepasosModule = {
    aplicarFiltro: aplicarFiltro,
    toggleFormAgregar: toggleFormAgregar,
    handleSubmitRepaso: handleSubmitRepaso,
    editarRepaso: editarRepaso,
    confirmarEliminarRepaso: confirmarEliminarRepaso,
    cancelarFormRepaso: cancelarFormRepaso,
    init: init
  };

  console.log('%c🔄 Sub-tab Repasos V01.20 Cargado', 'font-size: 11px; color: #667eea;');
})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Sub-tab de Repasos con CRUD completo
Hardening de seguridad y validaciones robustas

FUNCIONALIDAD:
Crear, editar, eliminar repasos
Filtro por curso
Marcar repasos como "Evaluados" (fondo rosado)
Estados: OK / Falta

HARDENING DE SEGURIDAD:
escHtml: Escape de HTML para prevenir XSS
escOnclickSingleQuote: Escape seguro para onclick
sanitizeEstado: Normalización de estados
toSafeRowNumber: Validación de rowNumber
NULL-GUARD: Validación response.success

FORMULARIO:
Curso (dropdown) - obligatorio
Tema (texto) - obligatorio
Fecha Clase (DD/MM/AAAA) - obligatorio
Fecha Repaso (DD/MM/AAAA) - obligatorio
Estado (OK/Falta) - obligatorio
Detalle (textarea) - opcional
Checkbox Evaluado - opcional

CONEXIÓN BACKEND:
studentObtenerCursos: Carga cursos activos
studentObtenerRepasos: Carga repasos del alumno
studentAgregarRepaso: Crea nuevo repaso
studentActualizarRepaso: Actualiza repaso existente
studentEliminarRepaso: Elimina repaso por rowNumber

DEPENDENCIAS:
currentUser.codeAlum: ID del estudiante
showAlert: Función global de alertas
updateDeberesBadge: Actualiza contador en parent

PATCH V01.19 → V01.20:
Remodulación Estándar CodeWorkShop v4.0
CSS en MOD-002
HTML en MOD-003
JavaScript (IIFE) en MOD-004
Comentarios consolidados en MOD-099
Mantiene hardening completo
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 17/24: 6btabeval.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/6btabeval.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 6btabeval.html
VERSIÓN: 01.20
FECHA: 18/01/2026 15:39 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* CONTENEDOR PRINCIPAL */
.eval-container {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.eval-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.eval-header h2 {
  color: #333;
  font-size: 20px;
  margin: 0;
}

.header-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* FILTROS */
.filtro-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filtro-container label {
  font-size: 13px;
  font-weight: 600;
  color: #666;
}

.filtro-container select {
  padding: 8px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 13px;
  min-width: 150px;
  cursor: pointer;
  transition: border-color 0.3s;
}

.filtro-container select:focus {
  outline: none;
  border-color: #667eea;
}

/* BOTONES */
.btn-agregar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
}

.btn-agregar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5568d3;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-icon {
  background: transparent;
  border: none;
  color: #667eea;
  cursor: pointer;
  font-size: 18px;
  padding: 4px 8px;
  transition: all 0.2s;
}

.btn-icon:hover {
  transform: scale(1.2);
}

.btn-icon.delete {
  color: #dc3545;
}

/* FORMULARIO */
.form-eval {
  background: #f9f9f9;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 24px;
  display: none;
}

.form-eval.active {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}

.form-group {
  margin-bottom: 0;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
}

.form-group label .required {
  color: #dc3545;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  border: 2px solid #ddd;
  border-radius: 6px;
  transition: all 0.3s;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group small {
  display: block;
  margin-top: 4px;
  font-size: 12px;
  color: #666;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

/* TABLA DE EVALUACIONES */
.eval-table-container {
  overflow-x: auto;
}

.eval-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.eval-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.eval-table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
}

.eval-table tbody tr {
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.2s;
}

.eval-table tbody tr:hover {
  background: #f8f9fa;
}

.eval-table td {
  padding: 12px;
  color: #333;
}

/* CURSO TAG */
.curso-tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  background: #e9ecef;
  color: #495057;
}

/* COLORES DINÁMICOS EN NOTA */
.nota-cell {
  text-align: center;
  font-weight: 600;
  font-size: 15px;
}

.nota-alta {
  color: #28a745;
}

.nota-media {
  color: #ffc107;
}

.nota-baja {
  color: #dc3545;
}

.nota-pendiente {
  color: #999;
  font-style: italic;
}

/* PESO Y SEMANA */
.peso-cell {
  text-align: center;
  color: #666;
}

.sem-cell {
  text-align: center;
  color: #666;
  font-size: 13px;
}

/* ESTADO VACÍO */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 15px;
}

/* LOADING */
.loading-container {
  text-align: center;
  padding: 40px;
  color: #667eea;
}

.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(102, 126, 234, 0.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .eval-container {
    padding: 16px;
  }

  .eval-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .header-actions {
    width: 100%;
  }

  .btn-agregar,
  .filtro-container {
    width: 100%;
  }

  .filtro-container {
    flex-direction: column;
    align-items: flex-start;
  }

  .filtro-container select {
    width: 100%;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .form-actions {
    flex-direction: column;
  }

  .form-actions .btn {
    width: 100%;
  }

  .eval-table {
    font-size: 13px;
  }

  .eval-table th,
  .eval-table td {
    padding: 8px;
  }

  .eval-table .col-sem {
    display: none;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR PRINCIPAL [INICIO] -->
<div class="eval-container">

  <div class="eval-header">
    <h2>📝 Mis Evaluaciones</h2>
    <div class="header-actions">
      <div class="filtro-container">
        <label>Filtrar:</label>
        <select id="filtroCurso" onchange="aplicarFiltro()">
          <option value="">Todos los cursos</option>
        </select>
      </div>
      <button class="btn-agregar" onclick="toggleFormAgregar()">
        + Agregar Evaluación
      </button>
    </div>
  </div>

  <div id="formEval" class="form-eval">
    <h3 id="formTitle" style="margin-bottom: 16px; color: #667eea;">Agregar Nueva Evaluación</h3>

    <form id="evalForm" onsubmit="handleSubmitEval(event)">
      <input type="hidden" id="evalRowNumber" value="">
      <input type="hidden" id="evalModoEdicion" value="false">

      <div class="form-row">
        <div class="form-group">
          <label>Curso <span class="required">*</span></label>
          <select id="evalCurso" required>
            <option value="">Seleccionar curso...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Nombre de la Evaluación <span class="required">*</span></label>
          <input
            type="text"
            id="evalNomEval"
            placeholder="Ej: Parcial 1, Examen Final"
            required
          >
          <small>Nombre único por curso</small>
        </div>

        <div class="form-group">
          <label>Fecha de Evaluación <span class="required">*</span></label>
          <input
            type="text"
            id="evalFechaEval"
            placeholder="DD/MM/AAAA"
            required
          >
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Nota (Opcional)</label>
          <input
            type="number"
            id="evalNota"
            placeholder="0 - 20"
            min="0"
            max="20"
            step="0.1"
          >
          <small>Calificación obtenida (0-20)</small>
        </div>

        <div class="form-group">
          <label>Peso (Opcional)</label>
          <input
            type="number"
            id="evalPeso"
            placeholder="%"
            min="0"
            max="100"
            step="1"
          >
          <small>Peso en porcentaje (ej: 30)</small>
        </div>

        <div class="form-group">
          <label>Semana (Opcional)</label>
          <input
            type="number"
            id="evalSem"
            placeholder="Número de semana"
            min="1"
            step="1"
          >
          <small>Número de semana académica</small>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" id="btnSubmit">
          Guardar Evaluación
        </button>
        <button type="button" class="btn btn-secondary" onclick="cancelarFormEval()">
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <div id="evalTableContainer" class="eval-table-container">
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando evaluaciones...</p>
    </div>
  </div>

</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function PBE_EVAL_MODULE() {
  'use strict';

  // VARIABLES LOCALES (ENCAPSULADAS)
  let evaluacionesData = [];
  let cursosData = [];
  let evaluacionesFiltradas = [];

  // INICIALIZACIÓN (SAFE PARA LAZY-LOAD)
  let _initDone = false;

  function init() {
    if (_initDone) return;

    if (typeof currentUser === 'undefined' || !currentUser.codeAlum) {
      showAlert('error', 'Error: No se pudo identificar al usuario');
      return;
    }

    _initDone = true;
    cargarCursos();
    cargarEvaluaciones();
  }

  window.addEventListener('load', init);

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  }

  // CARGAR CURSOS (para dropdown)
  function cargarCursos() {
    google.script.run
      .withSuccessHandler(handleCursosLoaded)
      .withFailureHandler(handleError)
      .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
  }

  function handleCursosLoaded(response) {
    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudieron cargar los cursos.';
      showAlert('error', 'Error al cargar cursos: ' + msg);
      return;
    }

    cursosData = response.data || [];
    poblarDropdownCursos();
  }

  function poblarDropdownCursos() {
    const selectCurso = document.getElementById('evalCurso');
    const selectFiltro = document.getElementById('filtroCurso');

    selectCurso.innerHTML = '<option value="">Seleccionar curso...</option>';
    selectFiltro.innerHTML = '<option value="">Todos los cursos</option>';

    cursosData.forEach(function(curso) {
      const option1 = document.createElement('option');
      option1.value = curso.Curso;
      option1.textContent = curso.Curso + ' - ' + curso.Completo;
      selectCurso.appendChild(option1);

      const option2 = document.createElement('option');
      option2.value = curso.Curso;
      option2.textContent = curso.Curso + ' - ' + curso.Completo;
      selectFiltro.appendChild(option2);
    });
  }

  // CARGAR EVALUACIONES
  function cargarEvaluaciones() {
    google.script.run
      .withSuccessHandler(handleEvaluacionesLoaded)
      .withFailureHandler(handleEvaluacionesError)
      .studentObtenerEvaluaciones({ codeAlum: currentUser.codeAlum });
  }

  function handleEvaluacionesLoaded(response) {
    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudieron cargar las evaluaciones.';
      showAlert('error', 'Error al cargar evaluaciones: ' + msg);
      renderEmptyState();
      return;
    }

    evaluacionesData = response.data || [];
    evaluacionesFiltradas = evaluacionesData;

    if (typeof updateDeberesBadge === 'function') {
      updateDeberesBadge('eval', evaluacionesData.length);
    }

    renderEvalTable();
  }

  function handleEvaluacionesError(error) {
    console.error('Error al cargar evaluaciones:', error);
    showAlert('error', 'Error de conexión al cargar evaluaciones');
    renderEmptyState();
  }

  // APLICAR FILTRO
  function aplicarFiltro() {
    const cursoSeleccionado = document.getElementById('filtroCurso').value;

    if (cursoSeleccionado === '') {
      evaluacionesFiltradas = evaluacionesData;
    } else {
      evaluacionesFiltradas = evaluacionesData.filter(function(ev) {
        return ev.Curso === cursoSeleccionado;
      });
    }

    renderEvalTable();
  }

  // RENDERIZAR TABLA
  function renderEvalTable() {
    const container = document.getElementById('evalTableContainer');

    if (evaluacionesFiltradas.length === 0) {
      renderEmptyState();
      return;
    }

    let html = '<table class="eval-table"><thead><tr><th>Curso</th><th>Evaluación</th><th>Fecha</th><th>Nota</th><th>Peso</th><th class="col-sem">Semana</th><th>Acciones</th></tr></thead><tbody>';

    evaluacionesFiltradas.forEach(function(ev) {
      const claseNota = obtenerClaseNota(ev.Nota);

      html += '<tr>';
      html += '<td><span class="curso-tag">' + ev.Curso + '</span></td>';
      html += '<td><strong>' + ev.NomEval + '</strong></td>';
      html += '<td>' + ev.FechaEval + '</td>';
      html += '<td class="nota-cell ' + claseNota + '">';
      html += ev.Nota ? ev.Nota : '<span class="nota-pendiente">Pendiente</span>';
      html += '</td>';
      html += '<td class="peso-cell">' + (ev.Peso ? ev.Peso + '%' : '-') + '</td>';
      html += '<td class="sem-cell col-sem">' + (ev.Sem || '-') + '</td>';
      html += '<td>';
      html += '<button class="btn-icon" onclick="editarEval(' + ev._rowNumber + ')" title="Editar">✏️</button>';
      html += '<button class="btn-icon delete" onclick="confirmarEliminarEval(' + ev._rowNumber + ', \'' + ev.NomEval + '\')" title="Eliminar">🗑️</button>';
      html += '</td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function renderEmptyState() {
    const container = document.getElementById('evalTableContainer');
    const filtroActivo = document.getElementById('filtroCurso').value !== '';

    if (filtroActivo) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><div class="empty-state-text">No hay evaluaciones para el curso seleccionado.</div></div>';
    } else {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><div class="empty-state-text">No tienes evaluaciones registradas aún.<br>Haz clic en "+ Agregar Evaluación" para comenzar.</div></div>';
    }
  }

  // TOGGLE FORMULARIO
  function toggleFormAgregar() {
    const form = document.getElementById('formEval');
    const isActive = form.classList.contains('active');

    if (isActive) {
      form.classList.remove('active');
    } else {
      resetFormEval();
      document.getElementById('formTitle').textContent = 'Agregar Nueva Evaluación';
      document.getElementById('evalModoEdicion').value = 'false';
      form.classList.add('active');
    }
  }

  // SUBMIT FORMULARIO
  function handleSubmitEval(event) {
    event.preventDefault();

    const curso = document.getElementById('evalCurso').value;
    const nomEval = document.getElementById('evalNomEval').value.trim();
    const fechaEval = document.getElementById('evalFechaEval').value.trim();
    const nota = document.getElementById('evalNota').value.trim();
    const peso = document.getElementById('evalPeso').value.trim();
    const sem = document.getElementById('evalSem').value.trim();
    const rowNumber = document.getElementById('evalRowNumber').value;
    const esEdicion = document.getElementById('evalModoEdicion').value === 'true';

    if (!curso || !nomEval || !fechaEval) {
      showAlert('error', 'Completa todos los campos obligatorios');
      return;
    }

    if (!validarFecha(fechaEval)) {
      showAlert('error', 'Formato de fecha inválido. Use DD/MM/AAAA');
      return;
    }

    if (nota && (parseFloat(nota) < 0 || parseFloat(nota) > 20)) {
      showAlert('error', 'La nota debe estar entre 0 y 20');
      return;
    }

    if (peso && (parseFloat(peso) < 0 || parseFloat(peso) > 100)) {
      showAlert('error', 'El peso debe estar entre 0 y 100%');
      return;
    }

    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = true;
    btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';

    const params = {
      codeAlum: currentUser.codeAlum,
      curso: curso,
      nomEval: nomEval,
      fechaEval: fechaEval,
      nota: nota,
      peso: peso,
      sem: sem
    };

    if (esEdicion) {
      params.rowNumber = parseInt(rowNumber, 10);

      google.script.run
        .withSuccessHandler(handleEvalUpdated)
        .withFailureHandler(handleEvalError)
        .studentActualizarEvaluacion(params);
    } else {
      google.script.run
        .withSuccessHandler(handleEvalAdded)
        .withFailureHandler(handleEvalError)
        .studentAgregarEvaluacion(params);
    }
  }

  function handleEvalAdded(response) {
    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Guardar Evaluación';

    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo agregar la evaluación.';
      showAlert('error', msg);
      return;
    }

    showAlert('success', '✓ Evaluación agregada exitosamente');
    cancelarFormEval();
    cargarEvaluaciones();
  }

  function handleEvalUpdated(response) {
    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Guardar Evaluación';

    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo actualizar la evaluación.';
      showAlert('error', msg);
      return;
    }

    showAlert('success', '✓ Evaluación actualizada exitosamente');
    cancelarFormEval();
    cargarEvaluaciones();
  }

  function handleEvalError(error) {
    console.error('Error:', error);
    showAlert('error', 'Error de conexión. Intenta nuevamente');

    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Guardar Evaluación';
  }

  // EDITAR EVALUACIÓN
  function editarEval(rowNumber) {
    const ev = evaluacionesData.find(e => e._rowNumber === rowNumber);
    if (!ev) return;

    document.getElementById('formTitle').textContent = 'Editar Evaluación';
    document.getElementById('evalRowNumber').value = rowNumber;
    document.getElementById('evalModoEdicion').value = 'true';
    document.getElementById('evalCurso').value = ev.Curso;
    document.getElementById('evalNomEval').value = ev.NomEval;
    document.getElementById('evalFechaEval').value = ev.FechaEval;
    document.getElementById('evalNota').value = ev.Nota || '';
    document.getElementById('evalPeso').value = ev.Peso || '';
    document.getElementById('evalSem').value = ev.Sem || '';

    document.getElementById('formEval').classList.add('active');
    document.getElementById('evalNomEval').focus();
  }

  // ELIMINAR EVALUACIÓN
  function confirmarEliminarEval(rowNumber, nomEval) {
    if (confirm('¿Eliminar la evaluación "' + nomEval + '"?\n\nEsta acción no se puede deshacer.')) {
      eliminarEval(rowNumber);
    }
  }

  function eliminarEval(rowNumber) {
    google.script.run
      .withSuccessHandler(handleEvalDeleted)
      .withFailureHandler(handleEvalError)
      .studentEliminarEvaluacion({ rowNumber: rowNumber });
  }

  function handleEvalDeleted(response) {
    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo eliminar la evaluación.';
      showAlert('error', msg);
      return;
    }

    showAlert('success', '✓ Evaluación eliminada exitosamente');
    cargarEvaluaciones();
  }

  // RESET Y CANCELAR FORMULARIO
  function resetFormEval() {
    document.getElementById('evalForm').reset();
    document.getElementById('evalRowNumber').value = '';
    document.getElementById('evalModoEdicion').value = 'false';
  }

  function cancelarFormEval() {
    document.getElementById('formEval').classList.remove('active');
    resetFormEval();
  }

  // FUNCIÓN AUXILIAR: CLASE DE NOTA
  function obtenerClaseNota(nota) {
    if (!nota) return 'nota-pendiente';

    const notaNum = parseFloat(nota);

    if (notaNum >= 14) return 'nota-alta';
    if (notaNum >= 11) return 'nota-media';
    return 'nota-baja';
  }

  // UTILIDADES
  function handleError(error) {
    console.error('Error:', error);
    showAlert('error', 'Error de conexión');
  }

  console.log('%c📝 Sub-tab Evaluaciones V01.20 cargado', 'font-size: 11px; color: #667eea;');

  // EXPORTS A WINDOW (solo lo necesario)
  window.aplicarFiltro = aplicarFiltro;
  window.toggleFormAgregar = toggleFormAgregar;
  window.handleSubmitEval = handleSubmitEval;
  window.editarEval = editarEval;
  window.confirmarEliminarEval = confirmarEliminarEval;
  window.cancelarFormEval = cancelarFormEval;

  window.EvalModule = {
    init: init
  };
})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Sub-tab de Evaluaciones con CRUD completo
Lista de evaluaciones con opciones para agregar, editar y eliminar

FUNCIONALIDAD:
Cargar evaluaciones del estudiante al iniciar
Agregar nueva evaluación con validación
Editar evaluación existente
Eliminar evaluación con confirmación
Filtrar por curso mediante dropdown
Validación de campos obligatorios y rangos

CAMPOS DEL FORMULARIO:
Curso (select) - obligatorio
Nombre de Evaluación - obligatorio
Fecha (DD/MM/AAAA) - obligatorio
Nota (0-20) - opcional
Peso (0-100%) - opcional
Semana (número) - opcional

CARACTERÍSTICAS TÉCNICAS:
IIFE encapsulado para evitar colisión de variables globales
NULL-GUARD en todos los handlers de respuesta
Init safe para lazy-load (si window.load ya ocurrió)
Validación de formato de fecha DD/MM/AAAA
Validación de rangos numéricos

COLORES DINÁMICOS:
Verde: Nota ≥ 14
Amarillo: Nota 11-13
Rojo: Nota < 11
Gris: Pendiente (sin nota)

CONEXIÓN BACKEND:
studentObtenerEvaluaciones({ codeAlum }): Lista de evaluaciones
studentObtenerCursos({ codeAlum }): Para poblar dropdowns
studentAgregarEvaluacion({ codeAlum, curso, nomEval, fechaEval, nota, peso, sem }): Crear
studentActualizarEvaluacion({ ...params, rowNumber }): Actualizar
studentEliminarEvaluacion({ rowNumber }): Eliminar

DEPENDENCIAS:
currentUser.codeAlum: Identificador del estudiante
showAlert(type, message): Función global de alertas
validarFecha(fechaStr): Función global de validación de fechas
updateDeberesBadge(tab, count): Función del contenedor padre (opcional)

TABLA:
Columnas: Curso, Evaluación, Fecha, Nota, Peso, Semana, Acciones
Botones: Editar (✏️), Eliminar (🗑️)
Responsive: Oculta columna Semana en móvil

FORMULARIO:
Desplegable con animación slideDown
Modo Agregar: Campos vacíos
Modo Editar: Campos prellenados
Validación: HTML5 + JavaScript custom

ESTADOS UI:
Loading: Spinner mientras carga
Vacío: Mensaje con instrucciones
Filtrado Vacío: Mensaje específico
Tabla: Grid con evaluaciones y acciones

INTEGRACIÓN:
Parent: 4btabdeberes.html (contenedor con lazy-load)
Backend: Wrappers student* en code.gs
Módulo: Student.gs (lógica de negocio)

CAMBIOS V01.19 → V01.20:
Remodulación Estándar CodeWorkShop v4.0
CSS en MOD-002
HTML en MOD-003
JavaScript (IIFE) en MOD-004
Comentarios aligerados
Notas consolidadas en MOD-099
Mantiene lógica funcional sin cambios
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 18/24: 6btablecturas.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/6btablecturas.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 6btablecturas.html
VERSIÓN: 01.21
FECHA: 18/01/2026 15:00 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* RESET Y BASE */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* CONTENEDOR PRINCIPAL */
.lecturas-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.lecturas-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 16px;
}

.lecturas-header h2 {
  font-size: 24px;
  font-weight: 600;
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

/* FILTRO */
.filtro-container {
  display: flex;
  gap: 8px;
  align-items: center;
}

.filtro-container label {
  font-size: 14px;
  color: #666;
  font-weight: 500;
}

.filtro-container select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  background: white;
  cursor: pointer;
  min-width: 180px;
}

.filtro-container select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn-agregar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-agregar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-agregar:active {
  transform: translateY(0);
}

/* FORMULARIO */
.form-lectura {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: none;
}

.form-lectura.active {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #e0e0e0;
}

.form-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: #333;
}

.btn-cerrar-form {
  background: transparent;
  border: none;
  font-size: 24px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.btn-cerrar-form:hover {
  background: #f0f0f0;
  color: #333;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin-bottom: 16px;
}

.form-row.full-width {
  grid-template-columns: 1fr;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group label {
  font-size: 14px;
  font-weight: 600;
  color: #333;
}

.form-group label .required {
  color: #dc3545;
  margin-left: 4px;
}

.form-group input,
.form-group select {
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input::placeholder {
  color: #999;
}

.form-group small {
  font-size: 12px;
  color: #666;
  font-style: italic;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #e0e0e0;
}

.btn-submit {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-cancelar {
  background: #f5f5f5;
  color: #666;
  border: 1px solid #ddd;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-cancelar:hover {
  background: #e8e8e8;
}

/* TABLA */
.lecturas-table-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.lecturas-table {
  width: 100%;
  border-collapse: collapse;
}

.lecturas-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.lecturas-table th {
  padding: 14px 16px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.lecturas-table tbody tr {
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.2s;
}

.lecturas-table tbody tr:nth-child(even) {
  background: #f8f9fa;
}

.lecturas-table tbody tr:hover {
  background: #e9ecef;
}

.lecturas-table td {
  padding: 14px 16px;
  font-size: 14px;
  color: #333;
}

.curso-tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  background: #e9ecef;
  color: #495057;
}

.lectura-titulo {
  font-weight: 600;
  color: #333;
}

/* BARRA DE PROGRESO */
.progreso-cell {
  min-width: 180px;
}

.progreso-container {
  display: flex;
  align-items: center;
  gap: 10px;
}

.barra-progreso {
  flex: 1;
  height: 20px;
  background: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.barra-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s ease;
  border-radius: 10px;
}

.progreso-text {
  font-size: 13px;
  font-weight: 600;
  color: #667eea;
  min-width: 45px;
  text-align: right;
}

.paginas-cell {
  font-size: 13px;
  color: #666;
  white-space: nowrap;
}

.fecha-cell {
  whitespace: nowrap;
  font-size: 13px;
  color: #666;
}

/* NOTAS */
.nota-cell {
  text-align: center;
  font-weight: 600;
  font-size: 15px;
}

.nota-alta {
  color: #28a745;
}

.nota-media {
  color: #ffc107;
}

.nota-baja {
  color: #dc3545;
}

.nota-pendiente {
  color: #999;
  font-weight: 400;
}

.peso-cell {
  text-align: center;
  color: #666;
  font-size: 13px;
}

.sem-cell {
  text-align: center;
  color: #666;
  font-size: 13px;
}

/* ACCIONES */
.acciones-cell {
  text-align: center;
  white-space: nowrap;
}

.btn-icon {
  background: transparent;
  border: none;
  font-size: 18px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s;
}

.btn-icon:hover {
  background: #f0f0f0;
  transform: scale(1.1);
}

.btn-icon:active {
  transform: scale(0.95);
}

/* LOADING */
.loading-container {
  text-align: center;
  padding: 60px 20px;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.loading-text {
  color: #666;
  font-size: 14px;
}

/* ESTADO VACÍO */
.estado-vacio {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.estado-vacio-icon {
  font-size: 64px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.estado-vacio-text {
  font-size: 16px;
  margin-bottom: 8px;
  color: #666;
}

.estado-vacio-subtext {
  font-size: 14px;
  color: #999;
}

/* RESPONSIVE */
@media (max-width: 1024px) {
  .lecturas-container {
    padding: 16px;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .lecturas-table .col-sem {
    display: none;
  }
}

@media (max-width: 768px) {
  .lecturas-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .lecturas-header h2 {
    font-size: 20px;
  }

  .header-actions {
    width: 100%;
    flex-direction: column;
  }

  .filtro-container {
    width: 100%;
  }

  .filtro-container select {
    width: 100%;
  }

  .btn-agregar {
    width: 100%;
    justify-content: center;
  }

  .form-lectura {
    padding: 16px;
  }

  .lecturas-table {
    font-size: 13px;
  }

  .lecturas-table th,
  .lecturas-table td {
    padding: 10px 12px;
  }

  .barra-progreso {
    height: 16px;
  }

  .progreso-text {
    font-size: 12px;
    min-width: 40px;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR PRINCIPAL [INICIO] -->
<div class="lecturas-container">

  <div class="lecturas-header">
    <h2>📖 Lecturas</h2>

    <div class="header-actions">
      <div class="filtro-container">
        <label for="filtroCurso">Filtrar por curso:</label>
        <select id="filtroCurso" onchange="LecturasModule.aplicarFiltro()">
          <option value="todos">Todos los cursos</option>
        </select>
      </div>

      <button class="btn-agregar" onclick="LecturasModule.toggleFormAgregar()">
        <span>➕</span>
        <span>Agregar Lectura</span>
      </button>
    </div>
  </div>

  <div id="formLectura" class="form-lectura">
    <div class="form-header">
      <h3 id="formTitulo">Agregar Lectura</h3>
      <button class="btn-cerrar-form" onclick="LecturasModule.cancelarFormulario()" title="Cerrar">×</button>
    </div>

    <form id="lecturaForm" onsubmit="LecturasModule.handleSubmitLectura(event)">
      <input type="hidden" id="lecturaRowNumber" value="">
      <input type="hidden" id="lecturaModoEdicion" value="false">

      <div class="form-row">
        <div class="form-group">
          <label for="inputCurso">
            Curso
            <span class="required">*</span>
          </label>
          <select id="inputCurso" required>
            <option value="">Seleccionar curso...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="inputLectura">
            Título de la Lectura
            <span class="required">*</span>
          </label>
          <input
            type="text"
            id="inputLectura"
            placeholder="Ej: El Principito"
            maxlength="100"
            required
          >
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="inputCantPag">
            Total de Páginas
            <span class="required">*</span>
          </label>
          <input
            type="number"
            id="inputCantPag"
            placeholder="Ej: 200"
            min="1"
            max="10000"
            required
          >
          <small>Número total de páginas del libro</small>
        </div>

        <div class="form-group">
          <label for="inputPagActual">
            Páginas Leídas
            <span class="required">*</span>
          </label>
          <input
            type="number"
            id="inputPagActual"
            placeholder="Ej: 50"
            min="0"
            value="0"
            required
          >
          <small>Páginas que ya has leído</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="inputFechaInicio">
            Fecha de Inicio
            <span class="required">*</span>
          </label>
          <input
            type="text"
            id="inputFechaInicio"
            placeholder="DD/MM/AAAA"
            pattern="\d{2}/\d{2}/\d{4}"
            required
          >
          <small>Formato: DD/MM/AAAA</small>
        </div>

        <div class="form-group">
          <label for="inputFechaFin">
            Fecha de Finalización
            <span class="required">*</span>
          </label>
          <input
            type="text"
            id="inputFechaFin"
            placeholder="DD/MM/AAAA"
            pattern="\d{2}/\d{2}/\d{4}"
            required
          >
          <small>Fecha programada de finalización</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="inputFechaEval">
            Fecha de Evaluación
          </label>
          <input
            type="text"
            id="inputFechaEval"
            placeholder="DD/MM/AAAA"
            pattern="\d{2}/\d{2}/\d{4}"
          >
          <small>Opcional - Formato: DD/MM/AAAA</small>
        </div>

        <div class="form-group">
          <label for="inputNota">
            Nota
          </label>
          <input
            type="number"
            id="inputNota"
            placeholder="Ej: 15.5"
            min="0"
            max="20"
            step="0.01"
          >
          <small>Opcional - Calificación de 0 a 20</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="inputPeso">
            Peso (%)
          </label>
          <input
            type="number"
            id="inputPeso"
            placeholder="Ej: 20"
            min="0"
            max="100"
            step="1"
          >
          <small>Opcional - Porcentaje de peso en la nota final</small>
        </div>

        <div class="form-group">
          <label for="inputSem">
            Semana
          </label>
          <input
            type="number"
            id="inputSem"
            placeholder="Ej: 5"
            min="1"
            max="52"
            step="1"
          >
          <small>Opcional - Número de semana (1-52)</small>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancelar" onclick="LecturasModule.cancelarFormulario()">
          Cancelar
        </button>
        <button type="submit" class="btn-submit" id="btnSubmit">
          Guardar Lectura
        </button>
      </div>
    </form>
  </div>

  <div class="lecturas-table-container">

    <div id="loadingLecturas" class="loading-container" style="display: none;">
      <div class="spinner"></div>
      <div class="loading-text">Cargando lecturas...</div>
    </div>

    <div id="estadoVacio" class="estado-vacio" style="display: none;">
      <div class="estado-vacio-icon">📚</div>
      <div class="estado-vacio-text">No hay lecturas registradas</div>
      <div class="estado-vacio-subtext">Haz clic en "Agregar Lectura" para comenzar</div>
    </div>

    <table class="lecturas-table" id="tablaLecturas" style="display: none;">
      <thead>
        <tr>
          <th>Curso</th>
          <th>Lectura</th>
          <th>Progreso</th>
          <th>Páginas</th>
          <th>Fecha Eval</th>
          <th>Nota</th>
          <th class="col-peso">Peso</th>
          <th class="col-sem">Semana</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="lecturasTableBody"></tbody>
    </table>

  </div>

</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function PBE_LECTURAS_MODULE() {
  'use strict';

  // VARIABLES PRIVADAS DEL MÓDULO
  let lecturasData = [];
  let cursosListaData = [];
  let lecturasFiltradas = [];
  let _initDone = false;
  let _retryCount = 0;
  const MAX_RETRIES = 5;

  // INIT CON RETRY LOGIC
  function inicializar() {
    console.log('📖 LecturasModule.inicializar() llamado (intento ' + (_retryCount + 1) + ')');

    if (_initDone) {
      console.log('📖 LecturasModule ya inicializado, ignorando');
      return;
    }

    if (typeof currentUser === 'undefined' || !currentUser) {
      console.warn('📖 currentUser no disponible aún, reintentando...');
      
      if (_retryCount < MAX_RETRIES) {
        _retryCount++;
        setTimeout(inicializar, 200);
      } else {
        console.error('📖 currentUser no disponible después de ' + MAX_RETRIES + ' intentos');
        mostrarError('Usuario no disponible. Recarga la página.');
      }
      return;
    }

    if (!currentUser.codeAlum) {
      console.error('📖 currentUser.codeAlum vacío:', currentUser);
      mostrarError('Código de alumno no disponible');
      return;
    }

    _initDone = true;
    console.log('📖 LecturasModule inicializado para:', currentUser.codeAlum);

    cargarCursos();
    cargarLecturas();
  }

  // CARGAR CURSOS
  function cargarCursos() {
    console.log('📖 Cargando cursos...');
    
    google.script.run
      .withSuccessHandler(handleCursosLoaded)
      .withFailureHandler(function(err) {
        console.error('📖 Error al cargar cursos:', err);
      })
      .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
  }

  function handleCursosLoaded(response) {
    console.log('📖 Respuesta cursos:', response);

    if (!response) {
      console.error('📖 Response cursos es NULL');
      return;
    }

    if (response.success !== true || !Array.isArray(response.data)) {
      console.error('📖 Respuesta cursos inválida');
      return;
    }

    cursosListaData = response.data;
    console.log('📖 Cursos cargados:', cursosListaData.length);
    poblarDropdownCursos();
  }

  function poblarDropdownCursos() {
    const selectCurso = document.getElementById('inputCurso');
    const selectFiltro = document.getElementById('filtroCurso');
    if (!selectCurso || !selectFiltro) return;

    const primerOption = selectCurso.options[0] ? selectCurso.options[0].outerHTML : '<option value="">Seleccionar curso...</option>';
    const primerOptionFiltro = selectFiltro.options[0] ? selectFiltro.options[0].outerHTML : '<option value="todos">Todos los cursos</option>';

    selectCurso.innerHTML = primerOption;
    selectFiltro.innerHTML = primerOptionFiltro;

    cursosListaData.forEach(function(curso) {
      const codigo = curso && curso.Curso ? String(curso.Curso) : '';
      const completo = curso && curso.Completo ? String(curso.Completo) : '';
      if (!codigo) return;

      const option = document.createElement('option');
      option.value = codigo;
      option.textContent = codigo + (completo ? (' - ' + completo) : '');
      selectCurso.appendChild(option);

      const optionFiltro = document.createElement('option');
      optionFiltro.value = codigo;
      optionFiltro.textContent = codigo;
      selectFiltro.appendChild(optionFiltro);
    });

    console.log('📖 Dropdowns poblados con', cursosListaData.length, 'cursos');
  }

  // CARGAR LECTURAS
  function setLoading(isLoading) {
    const loading = document.getElementById('loadingLecturas');
    const vacio = document.getElementById('estadoVacio');
    const tabla = document.getElementById('tablaLecturas');

    if (loading) loading.style.display = isLoading ? 'block' : 'none';
    if (vacio) vacio.style.display = 'none';
    if (tabla) tabla.style.display = 'none';
  }

  function cargarLecturas() {
    console.log('📖 Cargando lecturas para:', currentUser.codeAlum);
    setLoading(true);

    google.script.run
      .withSuccessHandler(handleLecturasLoaded)
      .withFailureHandler(function(error) {
        setLoading(false);
        console.error('📖 Error al cargar lecturas:', error);
        mostrarError('Error de conexión al cargar lecturas');
      })
      .studentObtenerLecturas({ codeAlum: currentUser.codeAlum });
  }

  function handleLecturasLoaded(response) {
    console.log('📖 Respuesta lecturas:', response);
    setLoading(false);

    if (!response) {
      console.error('📖 Response lecturas es NULL');
      mostrarError('Error: El servidor retornó NULL');
      return;
    }

    if (response.success !== true) {
      console.error('📖 Response no exitoso:', response.error);
      mostrarError(response.error || 'Error al cargar lecturas');
      return;
    }

    if (!Array.isArray(response.data)) {
      console.error('📖 response.data no es array');
      mostrarError('Formato de respuesta inválido');
      return;
    }

    lecturasData = response.data;
    console.log('📖 Lecturas cargadas:', lecturasData.length);
    aplicarFiltro();
  }

  // FILTRO
  function aplicarFiltro() {
    const filtroSelect = document.getElementById('filtroCurso');
    const filtroCurso = filtroSelect ? filtroSelect.value : '';

    console.log('📖 Aplicando filtro. Valor actual:', filtroCurso);

    if (!filtroCurso || filtroCurso === 'todos' || filtroCurso === '') {
      lecturasFiltradas = lecturasData;
      console.log('📖 Mostrando TODAS las lecturas:', lecturasData.length);
    } else {
      lecturasFiltradas = lecturasData.filter(function(lectura) {
        return String(lectura && lectura.Curso ? lectura.Curso : '') === String(filtroCurso);
      });
      console.log('📖 Filtradas por curso "' + filtroCurso + '":', lecturasFiltradas.length);
    }

    console.log('📖 Filtradas:', lecturasFiltradas.length, 'de', lecturasData.length);
    renderLecturasTable();
  }

  // RENDER
  function renderLecturasTable() {
    const tbody = document.getElementById('lecturasTableBody');
    const tabla = document.getElementById('tablaLecturas');
    const estadoVacio = document.getElementById('estadoVacio');
    const filtroSelect = document.getElementById('filtroCurso');
    const filtroCurso = filtroSelect ? filtroSelect.value : 'todos';

    if (!tbody || !tabla || !estadoVacio) return;

    if (!Array.isArray(lecturasFiltradas) || lecturasFiltradas.length === 0) {
      tabla.style.display = 'none';
      estadoVacio.style.display = 'block';

      const icon = estadoVacio.querySelector('.estado-vacio-icon');
      const text = estadoVacio.querySelector('.estado-vacio-text');
      const sub = estadoVacio.querySelector('.estado-vacio-subtext');

      if (filtroCurso && filtroCurso !== 'todos' && filtroCurso !== '') {
        if (icon) icon.textContent = '🔍';
        if (text) text.textContent = 'No hay lecturas para el curso seleccionado';
        if (sub) sub.textContent = 'Prueba otro curso o vuelve a "Todos los cursos".';
      } else {
        if (icon) icon.textContent = '📚';
        if (text) text.textContent = 'No hay lecturas registradas';
        if (sub) sub.textContent = 'Haz clic en "Agregar Lectura" para comenzar';
      }

      tbody.innerHTML = '';
      console.log('📖 Empty state mostrado');
      return;
    }

    estadoVacio.style.display = 'none';
    tabla.style.display = 'table';

    let html = '';

    lecturasFiltradas.forEach(function(lectura) {
      const curso = escHtml(lectura && lectura.Curso ? String(lectura.Curso) : '-');
      const titulo = escHtml(lectura && lectura.Lectura ? String(lectura.Lectura) : '-');

      const pagActualNum = safeInt(lectura && lectura.PagActual != null ? lectura.PagActual : 0, 0);
      const cantPagNum = safeInt(lectura && lectura.CantPag != null ? lectura.CantPag : 0, 0);

      const progreso = calcularProgreso(pagActualNum, cantPagNum);
      const progresoTxt = Number.isFinite(progreso) ? progreso.toFixed(0) : '0';

      const fechaEval = escHtml(lectura && lectura.FechaEval ? String(lectura.FechaEval) : '-');

      const notaVal = (lectura && lectura.Nota != null && String(lectura.Nota).trim() !== '') ? String(lectura.Nota) : '';
      const notaEsc = escHtml(notaVal || '-');
      const claseNota = obtenerClaseNota(notaVal);

      const pesoVal = (lectura && lectura.Peso != null && String(lectura.Peso).trim() !== '') ? String(lectura.Peso) : '';
      const pesoEsc = pesoVal ? (escHtml(pesoVal) + '%') : '-';

      const semVal = (lectura && lectura.Sem != null && String(lectura.Sem).trim() !== '') ? String(lectura.Sem) : '';
      const semEsc = semVal ? escHtml(semVal) : '-';

      const rowNumber = safeInt(lectura && lectura._rowNumber != null ? lectura._rowNumber : 0, 0);

      html += '<tr>';

      html += '<td><span class="curso-tag">' + curso + '</span></td>';
      html += '<td><span class="lectura-titulo">' + titulo + '</span></td>';

      html += '<td class="progreso-cell">';
      html +=   '<div class="progreso-container">';
      html +=     '<div class="barra-progreso">';
      html +=       '<div class="barra-fill" style="width: ' + progreso + '%"></div>';
      html +=     '</div>';
      html +=     '<span class="progreso-text">' + progresoTxt + '%</span>';
      html +=   '</div>';
      html += '</td>';

      html += '<td class="paginas-cell">' + escHtml(String(pagActualNum)) + ' / ' + escHtml(String(cantPagNum)) + '</td>';
      html += '<td class="fecha-cell">' + fechaEval + '</td>';
      html += '<td class="nota-cell ' + claseNota + '">' + notaEsc + '</td>';
      html += '<td class="peso-cell col-peso">' + pesoEsc + '</td>';
      html += '<td class="sem-cell col-sem">' + semEsc + '</td>';

      html += '<td class="acciones-cell">';
      html +=   '<button class="btn-icon" onclick="LecturasModule.editarLectura(' + rowNumber + ')" title="Editar">✏️</button>';
      html +=   '<button class="btn-icon" onclick="LecturasModule.eliminarLectura(' + rowNumber + ')" title="Eliminar">🗑️</button>';
      html += '</td>';

      html += '</tr>';
    });

    tbody.innerHTML = html;
    console.log('📖 Tabla renderizada con', lecturasFiltradas.length, 'lecturas');
  }

  // FORM UI
  function toggleFormAgregar() {
    const form = document.getElementById('formLectura');
    if (!form) return;

    if (form.classList.contains('active')) {
      form.classList.remove('active');
      return;
    }

    resetFormulario();

    const titulo = document.getElementById('formTitulo');
    const modo = document.getElementById('lecturaModoEdicion');
    const btn = document.getElementById('btnSubmit');

    if (titulo) titulo.textContent = 'Agregar Lectura';
    if (modo) modo.value = 'false';
    if (btn) btn.textContent = 'Guardar Lectura';

    form.classList.add('active');

    setTimeout(function() {
      const first = document.getElementById('inputCurso');
      if (first) first.focus();
    }, 200);
  }

  function resetFormulario() {
    const form = document.getElementById('lecturaForm');
    if (form) form.reset();

    const row = document.getElementById('lecturaRowNumber');
    const modo = document.getElementById('lecturaModoEdicion');
    const pag = document.getElementById('inputPagActual');

    if (row) row.value = '';
    if (modo) modo.value = 'false';
    if (pag) pag.value = '0';
  }

  function cancelarFormulario() {
    const formWrap = document.getElementById('formLectura');
    if (formWrap) formWrap.classList.remove('active');
    resetFormulario();
  }

  // SUBMIT
  function handleSubmitLectura(event) {
    event.preventDefault();

    if (typeof currentUser === 'undefined' || !currentUser.codeAlum) {
      showAlertSafe('error', 'No se pudo identificar al usuario. Recarga la página.');
      return;
    }

    const curso = getValueTrim('inputCurso');
    const lectura = getValueTrim('inputLectura');
    const cantPag = safeInt(getValueTrim('inputCantPag'), NaN);
    const pagActual = safeInt(getValueTrim('inputPagActual'), NaN);
    const fechaInicio = getValueTrim('inputFechaInicio');
    const fechaFin = getValueTrim('inputFechaFin');
    const fechaEval = getValueTrim('inputFechaEval');
    const nota = getValueTrim('inputNota');
    const peso = getValueTrim('inputPeso');
    const sem = getValueTrim('inputSem');

    if (!curso) { showAlertSafe('error', 'Selecciona un curso'); return; }
    if (!lectura) { showAlertSafe('error', 'Ingresa el título de la lectura'); return; }

    if (!Number.isFinite(cantPag) || cantPag <= 0) {
      showAlertSafe('error', 'Ingresa el total de páginas (mayor a 0)');
      return;
    }

    if (!Number.isFinite(pagActual) || pagActual < 0 || pagActual > cantPag) {
      showAlertSafe('error', 'Las páginas leídas deben estar entre 0 y ' + cantPag);
      return;
    }

    if (!validarFecha(fechaInicio)) { showAlertSafe('error', 'Fecha de inicio inválida. Formato: DD/MM/AAAA'); return; }
    if (!validarFecha(fechaFin)) { showAlertSafe('error', 'Fecha de finalización inválida. Formato: DD/MM/AAAA'); return; }
    if (fechaEval && !validarFecha(fechaEval)) { showAlertSafe('error', 'Fecha de evaluación inválida. Formato: DD/MM/AAAA'); return; }

    const notaNum = nota ? safeFloat(nota, NaN) : NaN;
    if (nota && (!Number.isFinite(notaNum) || notaNum < 0 || notaNum > 20)) {
      showAlertSafe('error', 'La nota debe estar entre 0 y 20');
      return;
    }

    const pesoNum = peso ? safeInt(peso, NaN) : NaN;
    if (peso && (!Number.isFinite(pesoNum) || pesoNum < 0 || pesoNum > 100)) {
      showAlertSafe('error', 'El peso debe estar entre 0 y 100');
      return;
    }

    const semNum = sem ? safeInt(sem, NaN) : NaN;
    if (sem && (!Number.isFinite(semNum) || semNum <= 0)) {
      showAlertSafe('error', 'La semana debe ser un número entero mayor a 0');
      return;
    }

    const params = {
      codeAlum: currentUser.codeAlum,
      curso: curso,
      lectura: lectura,
      cantPag: cantPag,
      pagActual: pagActual,
      fechaInicio: fechaInicio,
      fechaFin: fechaFin,
      fechaEval: fechaEval || '',
      nota: nota || '',
      peso: peso || '',
      sem: sem || ''
    };

    const modoEdicion = (document.getElementById('lecturaModoEdicion') && document.getElementById('lecturaModoEdicion').value === 'true');

    setSubmitState(true, modoEdicion ? 'Actualizando...' : 'Guardando...');

    if (modoEdicion) {
      const rowStr = document.getElementById('lecturaRowNumber') ? document.getElementById('lecturaRowNumber').value : '';
      const rowNumber = safeInt(rowStr, 0);

      if (!Number.isFinite(rowNumber) || rowNumber <= 0) {
        setSubmitState(false, 'Guardar Lectura');
        showAlertSafe('error', 'Error interno: fila inválida para actualización. Cierra y vuelve a editar.');
        return;
      }

      params.rowNumber = rowNumber;

      google.script.run
        .withSuccessHandler(handleLecturaGuardada)
        .withFailureHandler(function(error) {
          setSubmitState(false, 'Guardar Lectura');
          console.error('📖 Error al actualizar:', error);
          showAlertSafe('error', 'Error de conexión al actualizar lectura');
        })
        .studentActualizarLectura(params);
    } else {
      google.script.run
        .withSuccessHandler(handleLecturaGuardada)
        .withFailureHandler(function(error) {
          setSubmitState(false, 'Guardar Lectura');
          console.error('📖 Error al guardar:', error);
          showAlertSafe('error', 'Error de conexión al guardar lectura');
        })
        .studentAgregarLectura(params);
    }
  }

  function setSubmitState(disabled, text) {
    const btn = document.getElementById('btnSubmit');
    if (!btn) return;
    btn.disabled = !!disabled;
    if (text) btn.textContent = text;
  }

  function handleLecturaGuardada(response) {
    setSubmitState(false, 'Guardar Lectura');

    if (!response || response.success !== true) {
      const err = (response && response.error) ? String(response.error) : '';
      if (err && err.toLowerCase().indexOf('ya existe') !== -1) {
        showAlertSafe('error', err);
      } else {
        showAlertSafe('error', 'No se pudo guardar la lectura. Verifica los datos e intenta nuevamente.');
      }
      return;
    }

    showAlertSafe('success', '✓ Lectura guardada correctamente');
    cancelarFormulario();
    cargarLecturas();
  }

  // EDITAR
  function editarLectura(rowNumber) {
    const rn = safeInt(rowNumber, 0);
    if (!Number.isFinite(rn) || rn <= 0) {
      showAlertSafe('error', 'No se encontró la lectura');
      return;
    }

    const lectura = lecturasData.find(function(l) {
      return safeInt(l && l._rowNumber != null ? l._rowNumber : 0, 0) === rn;
    });

    if (!lectura) {
      showAlertSafe('error', 'No se encontró la lectura');
      return;
    }

    setValue('inputCurso', lectura.Curso || '');
    setValue('inputLectura', lectura.Lectura || '');
    setValue('inputCantPag', lectura.CantPag || '');
    setValue('inputPagActual', (lectura.PagActual != null ? lectura.PagActual : 0));
    setValue('inputFechaInicio', lectura.FechaInicio || '');
    setValue('inputFechaFin', lectura.FechaFin || '');
    setValue('inputFechaEval', lectura.FechaEval || '');
    setValue('inputNota', lectura.Nota || '');
    setValue('inputPeso', lectura.Peso || '');
    setValue('inputSem', lectura.Sem || '');

    setValue('lecturaRowNumber', rn);
    setValue('lecturaModoEdicion', 'true');

    const titulo = document.getElementById('formTitulo');
    const btn = document.getElementById('btnSubmit');
    if (titulo) titulo.textContent = 'Editar Lectura';
    if (btn) btn.textContent = 'Actualizar Lectura';

    const formWrap = document.getElementById('formLectura');
    if (formWrap) formWrap.classList.add('active');

    if (formWrap && typeof formWrap.scrollIntoView === 'function') {
      formWrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // ELIMINAR
  function eliminarLectura(rowNumber) {
    const rn = safeInt(rowNumber, 0);
    if (!Number.isFinite(rn) || rn <= 0) {
      showAlertSafe('error', 'No se pudo eliminar la lectura');
      return;
    }

    const lectura = lecturasData.find(function(l) {
      return safeInt(l && l._rowNumber != null ? l._rowNumber : 0, 0) === rn;
    });

    const nombreLectura = lectura && lectura.Lectura ? String(lectura.Lectura) : 'esta lectura';

    if (!confirm('¿Eliminar "' + nombreLectura + '"?\nEsta acción no se puede deshacer.')) return;

    google.script.run
      .withSuccessHandler(function(response) {
        if (!response || response.success !== true) {
          console.error('📖 Error eliminar:', response);
          showAlertSafe('error', 'No se pudo eliminar la lectura');
          return;
        }
        showAlertSafe('success', '✓ Lectura eliminada correctamente');
        cargarLecturas();
      })
      .withFailureHandler(function(error) {
        console.error('📖 Error al eliminar:', error);
        showAlertSafe('error', 'Error de conexión al eliminar lectura');
      })
      .studentEliminarLectura({ rowNumber: rn });
  }

  // HELPERS
  function calcularProgreso(pagActual, cantPag) {
    const a = safeFloat(pagActual, 0);
    const t = safeFloat(cantPag, 0);
    if (!t || t === 0) return 0;
    const p = (a / t) * 100;
    return Math.min(100, Math.max(0, p));
  }

  function obtenerClaseNota(nota) {
    if (nota == null || String(nota).trim() === '') return 'nota-pendiente';
    const n = safeFloat(nota, NaN);
    if (!Number.isFinite(n)) return 'nota-pendiente';
    if (n >= 14) return 'nota-alta';
    if (n >= 11) return 'nota-media';
    return 'nota-baja';
  }

  function validarFecha(fecha) {
    if (!fecha) return false;

    const str = String(fecha).trim();
    const regex = /^\d{2}\/\d{2}\/\d{4}$/;
    if (!regex.test(str)) return false;

    const partes = str.split('/');
    const dia = safeInt(partes[0], 0);
    const mes = safeInt(partes[1], 0);
    const anio = safeInt(partes[2], 0);

    if (mes < 1 || mes > 12) return false;
    if (dia < 1 || dia > 31) return false;
    if (anio < 2000 || anio > 2100) return false;

    return true;
  }

  function getValueTrim(id) {
    const el = document.getElementById(id);
    return el && el.value != null ? String(el.value).trim() : '';
  }

  function setValue(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = value != null ? String(value) : '';
  }

  function safeInt(value, fallback) {
    const n = parseInt(value, 10);
    return Number.isFinite(n) ? n : fallback;
  }

  function safeFloat(value, fallback) {
    const n = parseFloat(value);
    return Number.isFinite(n) ? n : fallback;
  }

  function escHtml(str) {
    const s = str == null ? '' : String(str);
    return s
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // ALERTAS
  function showAlertSafe(type, message) {
    if (typeof showAlert === 'function') {
      showAlert(type, message);
      return;
    }
    if (type === 'error') console.error(message);
    else console.log(message);
  }

  if (typeof showAlert === 'undefined') {
    window.showAlert = function(type, message) {
      const alertBox = document.createElement('div');
      alertBox.className = 'alert alert-' + type;
      alertBox.textContent = message;
      alertBox.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        font-size: 14px;
        font-weight: 500;
        animation: slideIn 0.3s;
        ${type === 'success' ? 'background: #d4edda; color: #155724; border-left: 4px solid #28a745;' : ''}
        ${type === 'error' ? 'background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545;' : ''}
        ${type === 'warning' ? 'background: #fff3cd; color: #856404; border-left: 4px solid #ffc107;' : ''}
        ${type === 'info' ? 'background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8;' : ''}
      `;

      document.body.appendChild(alertBox);

      setTimeout(function() { alertBox.remove(); }, 4000);
    };

    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }

  function mostrarError(mensaje) {
    const estadoVacio = document.getElementById('estadoVacio');
    const tabla = document.getElementById('tablaLecturas');
    const loading = document.getElementById('loadingLecturas');

    if (loading) loading.style.display = 'none';
    if (tabla) tabla.style.display = 'none';

    if (!estadoVacio) return;

    const icon = estadoVacio.querySelector('.estado-vacio-icon');
    const text = estadoVacio.querySelector('.estado-vacio-text');
    const sub = estadoVacio.querySelector('.estado-vacio-subtext');

    estadoVacio.style.display = 'block';
    if (icon) icon.textContent = '⚠️';
    if (text) text.textContent = 'Error';
    if (sub) sub.textContent = mensaje;
  }

  console.log('%c📖 LecturasModule V01.21 cargado', 'font-size:11px;color:#667eea;font-weight:bold');

  // API PÚBLICA
  window.LecturasModule = {
    inicializar: inicializar,
    aplicarFiltro: aplicarFiltro,
    toggleFormAgregar: toggleFormAgregar,
    handleSubmitLectura: handleSubmitLectura,
    editarLectura: editarLectura,
    eliminarLectura: eliminarLectura,
    cancelarFormulario: cancelarFormulario,
    recargar: cargarLecturas
  };

  // AUTO-INIT CON RETRY
  setTimeout(function() {
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
      console.log('📖 currentUser detectado, auto-inicializando...');
      inicializar();
    } else {
      console.log('📖 currentUser no disponible, iniciando retry logic...');
      inicializar();
    }
  }, 150);

})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Gestión completa de lecturas académicas con sistema de progreso
CRUD completo con barra visual de avance de lectura

FUNCIONALIDAD:
Crear lectura con validación completa
Editar lectura existente
Eliminar con confirmación
Filtrar por curso (dropdown dinámico)
Seguimiento de progreso de lectura (páginas leídas vs total)
Barra de progreso visual

CAMPOS DEL FORMULARIO:
Curso (select) - obligatorio
Título de la Lectura - obligatorio
Total de Páginas - obligatorio
Páginas Leídas - obligatorio (default: 0)
Fecha de Inicio (DD/MM/AAAA) - obligatorio
Fecha de Finalización (DD/MM/AAAA) - obligatorio
Fecha de Evaluación (DD/MM/AAAA) - opcional
Nota (0-20) - opcional
Peso (0-100%) - opcional
Semana (número) - opcional

CARACTERÍSTICAS TÉCNICAS:
IIFE encapsulado (PBE_LECTURAS_MODULE)
Retry logic robusto (5 intentos, 200ms)
NULL-GUARD en todos los handlers
Init idempotente con _initDone
Validación exhaustiva de fechas y rangos
Cálculo dinámico de progreso de lectura

SISTEMA DE COLORES DINÁMICOS:
Verde (nota-alta): Nota ≥ 14
Amarillo (nota-media): Nota 11-13
Rojo (nota-baja): Nota < 11
Gris (nota-pendiente): Sin nota

BARRA DE PROGRESO:
Cálculo: (páginas leídas / total páginas) × 100
Rango: 0% - 100%
Visual: Barra gradiente azul-morado
Actualización en tiempo real al editar

TABLA DE LECTURAS:
Columnas: Curso, Lectura, Progreso, Páginas, Fecha Eval, Nota, Peso, Semana, Acciones
Progreso: Barra visual + porcentaje
Páginas: "X / Y" formato
Botones: Editar (✏️), Eliminar (🗑️)
Responsive: Oculta columna Semana en móvil

FORMULARIO DESPLEGABLE:
Animación slideDown
Modo Agregar: Campos vacíos, páginas leídas = 0
Modo Editar: Campos prellenados con datos existentes
Focus automático en campo curso
Validación HTML5 + JavaScript

BACKEND:
studentObtenerLecturas({ codeAlum }): Lista de lecturas
studentObtenerCursos({ codeAlum }): Lista de cursos
studentAgregarLectura({ codeAlum, curso, lectura, cantPag, pagActual, fechaInicio, fechaFin, fechaEval, nota, peso, sem })
studentActualizarLectura({ ...params, rowNumber })
studentEliminarLectura({ rowNumber })

ESTADOS UI:
Loading: Spinner mientras carga datos
Vacío: Mensaje con instrucciones
Filtrado Vacío: Mensaje específico por curso
Tabla: Grid con lecturas y barras de progreso

FILTRO:
V01.20 FIX: Acepta '', 'todos', o null como "mostrar todo"
Dropdown dinámico con lista de cursos
Estado vacío contextual por filtro
Preserva filtro al recargar

VALIDACIONES:
Fechas: DD/MM/AAAA formato estricto
Total páginas: > 0
Páginas leídas: 0 ≤ valor ≤ total páginas
Nota: 0-20 (opcional)
Peso: 0-100% (opcional)
Semana: 1-52 (opcional)

EXPORTS A WINDOW:
inicializar()
aplicarFiltro()
toggleFormAgregar()
handleSubmitLectura()
editarLectura()
eliminarLectura()
cancelarFormulario()
recargar()

INTEGRACIÓN:
Parent: Sistema de tabs con lazy-load
Backend: Wrappers en 1code.gs
Módulo: Student.gs (lógica CRUD)
Dependencias: currentUser.codeAlum, showAlert()

CAMBIOS V01.20 → V01.21:
Remodulación Estándar CodeWorkShop v4.0
CSS en MOD-002 (aligerado)
HTML en MOD-003
JavaScript (IIFE módulo) en MOD-004
Comentarios optimizados
Notas consolidadas en MOD-099
Mantiene retry logic y filtro fix V01.20
Mantiene sistema de barra de progreso único
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 19/24: 6btabtareas.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/6btabtareas.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 6btabtareas.html
VERSIÓN: 01.19
FECHA: 18/01/2026 15:53 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* CONTENEDOR PRINCIPAL */
.tareas-container {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.tareas-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.tareas-header h2 {
  color: #333;
  font-size: 20px;
  margin: 0;
}

.header-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* FILTROS */
.filtro-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filtro-container label {
  font-size: 13px;
  font-weight: 600;
  color: #666;
}

.filtro-container select {
  padding: 8px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 13px;
  min-width: 150px;
  cursor: pointer;
  transition: border-color 0.3s;
}

.filtro-container select:focus {
  outline: none;
  border-color: #667eea;
}

/* BOTONES */
.btn-agregar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
}

.btn-agregar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5568d3;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-icon {
  background: transparent;
  border: none;
  color: #667eea;
  cursor: pointer;
  font-size: 18px;
  padding: 4px 8px;
  transition: all 0.2s;
}

.btn-icon:hover {
  transform: scale(1.2);
}

.btn-icon.delete {
  color: #dc3545;
}

/* FORMULARIO */
.form-tarea {
  background: #f9f9f9;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 24px;
  display: none;
}

.form-tarea.active {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}

.form-group {
  margin-bottom: 0;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
}

.form-group label .required {
  color: #dc3545;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  border: 2px solid #ddd;
  border-radius: 6px;
  transition: all 0.3s;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group small {
  display: block;
  margin-top: 4px;
  font-size: 12px;
  color: #666;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

/* TABLA DE TAREAS */
.tareas-table-container {
  overflow-x: auto;
}

.tareas-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.tareas-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.tareas-table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
}

.tareas-table tbody tr {
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.2s;
}

.tareas-table tbody tr:hover {
  background: #f8f9fa;
}

.tareas-table td {
  padding: 12px;
  color: #333;
}

/* CURSO TAG */
.curso-tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  background: #e9ecef;
  color: #495057;
}

/* COLORES DINÁMICOS EN NOTA */
.nota-cell {
  text-align: center;
  font-weight: 600;
  font-size: 15px;
}

.nota-alta {
  color: #28a745;
}

.nota-media {
  color: #ffc107;
}

.nota-baja {
  color: #dc3545;
}

.nota-pendiente {
  color: #999;
  font-style: italic;
}

/* FECHA, PESO Y SEMANA */
.fecha-cell {
  white-space: nowrap;
}

.peso-cell {
  text-align: center;
  color: #666;
}

.sem-cell {
  text-align: center;
  color: #666;
  font-size: 13px;
}

/* ESTADO VACÍO */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 15px;
}

/* LOADING */
.loading-container {
  text-align: center;
  padding: 40px;
  color: #667eea;
}

.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(102, 126, 234, 0.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .tareas-container {
    padding: 16px;
  }

  .tareas-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .header-actions {
    width: 100%;
  }

  .btn-agregar,
  .filtro-container {
    width: 100%;
  }

  .filtro-container {
    flex-direction: column;
    align-items: flex-start;
  }

  .filtro-container select {
    width: 100%;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .form-actions {
    flex-direction: column;
  }

  .form-actions .btn {
    width: 100%;
  }

  .tareas-table {
    font-size: 13px;
  }

  .tareas-table th,
  .tareas-table td {
    padding: 8px;
  }

  .tareas-table .col-sem {
    display: none;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR PRINCIPAL [INICIO] -->
<div class="tareas-container">

  <div class="tareas-header">
    <h2>✏️ Mis Tareas</h2>
    <div class="header-actions">
      <div class="filtro-container">
        <label>Filtrar:</label>
        <select id="filtroCurso" onchange="aplicarFiltro()">
          <option value="">Todos los cursos</option>
        </select>
      </div>
      <button class="btn-agregar" onclick="toggleFormAgregar()">
        + Agregar Tarea
      </button>
    </div>
  </div>

  <div id="formTarea" class="form-tarea">
    <h3 id="formTitle" style="margin-bottom: 16px; color: #667eea;">Agregar Nueva Tarea</h3>

    <form id="tareaForm" onsubmit="handleSubmitTarea(event)">
      <input type="hidden" id="tareaRowNumber" value="">
      <input type="hidden" id="tareaModoEdicion" value="false">

      <div class="form-row">
        <div class="form-group">
          <label>Curso <span class="required">*</span></label>
          <select id="tareaCurso" required>
            <option value="">Seleccionar curso...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Nombre de la Tarea <span class="required">*</span></label>
          <input
            type="text"
            id="tareaTarea"
            placeholder="Ej: Trabajo de Investigación"
            required
          >
          <small>Nombre único por curso</small>
        </div>

        <div class="form-group">
          <label>Fecha de Entrega <span class="required">*</span></label>
          <input
            type="text"
            id="tareaFechaEntrega"
            placeholder="DD/MM/AAAA"
            required
          >
          <small>Fecha límite de entrega</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Fecha de Realización (Opcional)</label>
          <input
            type="text"
            id="tareaFechaAccion"
            placeholder="DD/MM/AAAA"
          >
          <small>Fecha en que se completó</small>
        </div>

        <div class="form-group">
          <label>Nota (Opcional)</label>
          <input
            type="number"
            id="tareaNota"
            placeholder="0 - 20"
            min="0"
            max="20"
            step="0.1"
          >
          <small>Calificación (0-20)</small>
        </div>

        <div class="form-group">
          <label>Peso (Opcional)</label>
          <input
            type="number"
            id="tareaPeso"
            placeholder="%"
            min="0"
            max="100"
            step="1"
          >
          <small>Peso % (ej: 25)</small>
        </div>

        <div class="form-group">
          <label>Semana (Opcional)</label>
          <input
            type="number"
            id="tareaSem"
            placeholder="Nº semana"
            min="1"
            step="1"
          >
          <small>Semana académica</small>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" id="btnSubmit">
          Guardar Tarea
        </button>
        <button type="button" class="btn btn-secondary" onclick="cancelarFormTarea()">
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <div id="tareasTableContainer" class="tareas-table-container">
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando tareas...</p>
    </div>
  </div>

</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function PBE_TAREAS_MODULE() {
  'use strict';

  // VARIABLES LOCALES (ENCAPSULADAS)
  let tareasData = [];
  let cursosData = [];
  let tareasFiltradas = [];
  let _initDone = false;

  // INICIALIZACIÓN (IDEMPOTENTE)
  function init() {
    if (_initDone) return;

    if (typeof currentUser === 'undefined' || !currentUser.codeAlum) {
      showAlert('error', 'Error: No se pudo identificar al usuario');
      return;
    }

    _initDone = true;
    cargarCursos();
    cargarTareas();
  }

  window.addEventListener('load', init);

  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    init();
  }

  // CARGAR CURSOS (para dropdown)
  function cargarCursos() {
    google.script.run
      .withSuccessHandler(handleCursosLoaded)
      .withFailureHandler(handleError)
      .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
  }

  function handleCursosLoaded(response) {
    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudieron cargar los cursos.';
      showAlert('error', 'Error al cargar cursos: ' + msg);
      return;
    }

    cursosData = response.data || [];
    poblarDropdownCursos();
  }

  function poblarDropdownCursos() {
    const selectCurso = document.getElementById('tareaCurso');
    const selectFiltro = document.getElementById('filtroCurso');

    selectCurso.innerHTML = '<option value="">Seleccionar curso...</option>';
    selectFiltro.innerHTML = '<option value="">Todos los cursos</option>';

    cursosData.forEach(function(curso) {
      const label = (curso.Curso || '') + ' - ' + (curso.Completo || '');

      const option1 = document.createElement('option');
      option1.value = curso.Curso;
      option1.textContent = label;
      selectCurso.appendChild(option1);

      const option2 = document.createElement('option');
      option2.value = curso.Curso;
      option2.textContent = label;
      selectFiltro.appendChild(option2);
    });
  }

  // CARGAR TAREAS
  function cargarTareas() {
    google.script.run
      .withSuccessHandler(handleTareasLoaded)
      .withFailureHandler(handleTareasError)
      .studentObtenerTareas({ codeAlum: currentUser.codeAlum });
  }

  function handleTareasLoaded(response) {
    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudieron cargar las tareas.';
      showAlert('error', 'Error al cargar tareas: ' + msg);
      renderEmptyState();
      return;
    }

    tareasData = response.data || [];
    tareasFiltradas = tareasData;

    if (typeof updateDeberesBadge === 'function') {
      updateDeberesBadge('tareas', tareasData.length);
    }

    renderTareasTable();
  }

  function handleTareasError(error) {
    console.error('Error al cargar tareas:', error);
    showAlert('error', 'Error de conexión al cargar tareas');
    renderEmptyState();
  }

  // APLICAR FILTRO
  function aplicarFiltro() {
    const cursoSeleccionado = document.getElementById('filtroCurso').value;

    if (cursoSeleccionado === '') {
      tareasFiltradas = tareasData;
    } else {
      tareasFiltradas = tareasData.filter(function(t) {
        return t.Curso === cursoSeleccionado;
      });
    }

    renderTareasTable();
  }

  // RENDERIZAR TABLA
  function renderTareasTable() {
    const container = document.getElementById('tareasTableContainer');

    if (!tareasFiltradas || tareasFiltradas.length === 0) {
      renderEmptyState();
      return;
    }

    let html = '<table class="tareas-table"><thead><tr><th>Curso</th><th>Tarea</th><th>Entrega</th><th>Acción</th><th>Nota</th><th>Peso</th><th class="col-sem">Semana</th><th>Acciones</th></tr></thead><tbody>';

    tareasFiltradas.forEach(function(t) {
      const claseNota = obtenerClaseNota(t.Nota);
      const tareaSafe = String(t.Tarea || '').replace(/'/g, "\\'");

      html += '<tr>';
      html += '<td><span class="curso-tag">' + t.Curso + '</span></td>';
      html += '<td><strong>' + t.Tarea + '</strong></td>';
      html += '<td class="fecha-cell">' + t.FechaEntrega + '</td>';
      html += '<td class="fecha-cell">' + (t.FechaAccion || '-') + '</td>';
      html += '<td class="nota-cell ' + claseNota + '">';
      html += t.Nota ? t.Nota : '<span class="nota-pendiente">Pendiente</span>';
      html += '</td>';
      html += '<td class="peso-cell">' + (t.Peso ? t.Peso + '%' : '-') + '</td>';
      html += '<td class="sem-cell col-sem">' + (t.Sem || '-') + '</td>';
      html += '<td>';
      html += '<button class="btn-icon" onclick="editarTarea(' + t._rowNumber + ')" title="Editar">✏️</button>';
      html += '<button class="btn-icon delete" onclick="confirmarEliminarTarea(' + t._rowNumber + ', \'' + tareaSafe + '\')" title="Eliminar">🗑️</button>';
      html += '</td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function renderEmptyState() {
    const container = document.getElementById('tareasTableContainer');
    const filtroActivo = document.getElementById('filtroCurso').value !== '';

    if (filtroActivo) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><div class="empty-state-text">No hay tareas para el curso seleccionado.</div></div>';
    } else {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">✏️</div><div class="empty-state-text">No tienes tareas registradas aún.<br>Haz clic en "+ Agregar Tarea" para comenzar.</div></div>';
    }
  }

  // TOGGLE FORMULARIO
  function toggleFormAgregar() {
    const form = document.getElementById('formTarea');
    const isActive = form.classList.contains('active');

    if (isActive) {
      form.classList.remove('active');
    } else {
      resetFormTarea();
      document.getElementById('formTitle').textContent = 'Agregar Nueva Tarea';
      document.getElementById('tareaModoEdicion').value = 'false';
      form.classList.add('active');
    }
  }

  // SUBMIT FORMULARIO
  function handleSubmitTarea(event) {
    event.preventDefault();

    const curso = document.getElementById('tareaCurso').value;
    const tarea = document.getElementById('tareaTarea').value.trim();
    const fechaEntrega = document.getElementById('tareaFechaEntrega').value.trim();
    const fechaAccion = document.getElementById('tareaFechaAccion').value.trim();
    const nota = document.getElementById('tareaNota').value.trim();
    const peso = document.getElementById('tareaPeso').value.trim();
    const sem = document.getElementById('tareaSem').value.trim();
    const rowNumber = document.getElementById('tareaRowNumber').value;
    const esEdicion = document.getElementById('tareaModoEdicion').value === 'true';

    if (!curso || !tarea || !fechaEntrega) {
      showAlert('error', 'Completa todos los campos obligatorios');
      return;
    }

    if (!validarFecha(fechaEntrega)) {
      showAlert('error', 'Formato de fecha de entrega inválido. Use DD/MM/AAAA');
      return;
    }

    if (fechaAccion && !validarFecha(fechaAccion)) {
      showAlert('error', 'Formato de fecha de realización inválido. Use DD/MM/AAAA');
      return;
    }

    if (nota && (parseFloat(nota) < 0 || parseFloat(nota) > 20)) {
      showAlert('error', 'La nota debe estar entre 0 y 20');
      return;
    }

    if (peso && (parseFloat(peso) < 0 || parseFloat(peso) > 100)) {
      showAlert('error', 'El peso debe estar entre 0 y 100%');
      return;
    }

    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = true;
    btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';

    const params = {
      codeAlum: currentUser.codeAlum,
      curso: curso,
      tarea: tarea,
      fechaEntrega: fechaEntrega,
      fechaAccion: fechaAccion,
      nota: nota,
      peso: peso,
      sem: sem
    };

    if (esEdicion) {
      params.rowNumber = parseInt(rowNumber, 10);

      google.script.run
        .withSuccessHandler(handleTareaUpdated)
        .withFailureHandler(handleTareaError)
        .studentActualizarTarea(params);
    } else {
      google.script.run
        .withSuccessHandler(handleTareaAdded)
        .withFailureHandler(handleTareaError)
        .studentAgregarTarea(params);
    }
  }

  function handleTareaAdded(response) {
    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Guardar Tarea';

    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo agregar la tarea.';
      showAlert('error', msg);
      return;
    }

    showAlert('success', '✓ Tarea agregada exitosamente');
    cancelarFormTarea();
    cargarTareas();
  }

  function handleTareaUpdated(response) {
    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Guardar Tarea';

    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo actualizar la tarea.';
      showAlert('error', msg);
      return;
    }

    showAlert('success', '✓ Tarea actualizada exitosamente');
    cancelarFormTarea();
    cargarTareas();
  }

  function handleTareaError(error) {
    console.error('Error:', error);
    showAlert('error', 'Error de conexión. Intenta nuevamente');

    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Guardar Tarea';
  }

  // EDITAR TAREA
  function editarTarea(rowNumber) {
    const t = tareasData.find(x => x._rowNumber === rowNumber);
    if (!t) return;

    document.getElementById('formTitle').textContent = 'Editar Tarea';
    document.getElementById('tareaRowNumber').value = rowNumber;
    document.getElementById('tareaModoEdicion').value = 'true';
    document.getElementById('tareaCurso').value = t.Curso;
    document.getElementById('tareaTarea').value = t.Tarea;
    document.getElementById('tareaFechaEntrega').value = t.FechaEntrega;
    document.getElementById('tareaFechaAccion').value = t.FechaAccion || '';
    document.getElementById('tareaNota').value = t.Nota || '';
    document.getElementById('tareaPeso').value = t.Peso || '';
    document.getElementById('tareaSem').value = t.Sem || '';

    document.getElementById('formTarea').classList.add('active');
    document.getElementById('tareaTarea').focus();
  }

  // ELIMINAR TAREA
  function confirmarEliminarTarea(rowNumber, nombreTarea) {
    if (confirm('¿Eliminar la tarea "' + nombreTarea + '"?\n\nEsta acción no se puede deshacer.')) {
      eliminarTarea(rowNumber);
    }
  }

  function eliminarTarea(rowNumber) {
    google.script.run
      .withSuccessHandler(handleTareaDeleted)
      .withFailureHandler(handleTareaError)
      .studentEliminarTarea({ rowNumber: rowNumber });
  }

  function handleTareaDeleted(response) {
    if (!response || response.success !== true) {
      const msg = response && response.error ? response.error : 'No se pudo eliminar la tarea.';
      showAlert('error', msg);
      return;
    }

    showAlert('success', '✓ Tarea eliminada exitosamente');
    cargarTareas();
  }

  // RESET Y CANCELAR FORMULARIO
  function resetFormTarea() {
    document.getElementById('tareaForm').reset();
    document.getElementById('tareaRowNumber').value = '';
    document.getElementById('tareaModoEdicion').value = 'false';
  }

  function cancelarFormTarea() {
    document.getElementById('formTarea').classList.remove('active');
    resetFormTarea();
  }

  // FUNCIÓN AUXILIAR: CLASE DE NOTA
  function obtenerClaseNota(nota) {
    if (!nota) return 'nota-pendiente';

    const notaNum = parseFloat(nota);

    if (notaNum >= 14) return 'nota-alta';
    if (notaNum >= 11) return 'nota-media';
    return 'nota-baja';
  }

  // UTILIDADES
  function handleError(error) {
    console.error('Error:', error);
    showAlert('error', 'Error de conexión');
  }

  console.log('%c✏️ Sub-tab Tareas V01.19 cargado', 'font-size: 11px; color: #667eea;');

  // EXPORTS A WINDOW (solo lo necesario)
  window.aplicarFiltro = aplicarFiltro;
  window.toggleFormAgregar = toggleFormAgregar;
  window.handleSubmitTarea = handleSubmitTarea;
  window.editarTarea = editarTarea;
  window.confirmarEliminarTarea = confirmarEliminarTarea;
  window.cancelarFormTarea = cancelarFormTarea;

  window.TareasModule = {
    init: init
  };
})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Sub-tab de Tareas con CRUD completo
Lista de tareas con opciones para agregar, editar y eliminar

FUNCIONALIDAD:
Cargar tareas del estudiante al iniciar
Agregar nueva tarea con validación
Editar tarea existente
Eliminar tarea con confirmación
Filtrar por curso mediante dropdown
Validación de campos obligatorios y rangos

CAMPOS DEL FORMULARIO:
Curso (select) - obligatorio
Nombre de Tarea - obligatorio
Fecha de Entrega (DD/MM/AAAA) - obligatorio
Fecha de Realización (DD/MM/AAAA) - opcional
Nota (0-20) - opcional
Peso (0-100%) - opcional
Semana (número) - opcional

CARACTERÍSTICAS TÉCNICAS:
IIFE encapsulado para evitar colisión de variables globales
NULL-GUARD en todos los handlers de respuesta
Init idempotente compatible con lazy-load
Validación de formato de fechas DD/MM/AAAA
Validación de rangos numéricos
Escape de caracteres especiales en onclick

COLORES DINÁMICOS:
Verde: Nota ≥ 14
Amarillo: Nota 11-13
Rojo: Nota < 11
Gris: Pendiente (sin nota)

CONEXIÓN BACKEND:
studentObtenerTareas({ codeAlum }): Lista de tareas
studentObtenerCursos({ codeAlum }): Para poblar dropdowns
studentAgregarTarea({ codeAlum, curso, tarea, fechaEntrega, fechaAccion, nota, peso, sem }): Crear
studentActualizarTarea({ ...params, rowNumber }): Actualizar
studentEliminarTarea({ rowNumber }): Eliminar

DEPENDENCIAS:
currentUser.codeAlum: Identificador del estudiante
showAlert(type, message): Función global de alertas
validarFecha(fechaStr): Función global de validación de fechas
updateDeberesBadge(tab, count): Función del contenedor padre (opcional)

TABLA:
Columnas: Curso, Tarea, Entrega, Acción, Nota, Peso, Semana, Acciones
Fecha Entrega: Fecha límite para completar
Fecha Acción: Fecha en que se realizó/completó
Botones: Editar (✏️), Eliminar (🗑️)
Responsive: Oculta columna Semana en móvil

FORMULARIO:
Desplegable con animación slideDown
Modo Agregar: Campos vacíos
Modo Editar: Campos prellenados
Validación: HTML5 + JavaScript custom
Focus automático en campo Tarea al editar

ESTADOS UI:
Loading: Spinner mientras carga
Vacío: Mensaje con instrucciones
Filtrado Vacío: Mensaje específico
Tabla: Grid con tareas y acciones

INTEGRACIÓN:
Parent: 4btabdeberes.html (contenedor con lazy-load)
Backend: Wrappers student* en code.gs
Módulo: Student.gs (lógica de negocio)

PATCH V01.18.1:
Escape robusto para nombres de tarea en onclick
Maneja \, ', saltos de línea para evitar romper atributos HTML

CAMBIOS V01.18.1 → V01.19:
Remodulación Estándar CodeWorkShop v4.0
CSS en MOD-002
HTML en MOD-003
JavaScript (IIFE) en MOD-004
Comentarios aligerados
Notas consolidadas en MOD-099
Mantiene lógica funcional sin cambios
Mantiene escape de caracteres especiales
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 20/24: 6btabtodos.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/6btabtodos.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 6btabtodos.html
VERSIÓN: 01.22
FECHA: 18/01/2026 13:20 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* SCOPE: evitar colisiones globales */
.todos-container, .todos-container * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

.todos-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
.todos-container .todos-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px 12px 0 0;
  margin-bottom: 0;
}

.todos-container .todos-header h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 8px;
}

.todos-container .todos-header p {
  font-size: 14px;
  opacity: 0.9;
}

/* Filtros */
.todos-container .filtros-bar {
  background: white;
  padding: 16px 20px;
  border-bottom: 2px solid #e0e0e0;
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.todos-container .filtros-bar label {
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.todos-container .filtros-bar select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  background: white;
  cursor: pointer;
  min-width: 150px;
}

.todos-container .filtros-bar select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.todos-container .btn-refresh {
  padding: 8px 16px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background 0.2s;
  margin-left: auto;
}

.todos-container .btn-refresh:hover {
  background: #5568d3;
}

.todos-container .btn-refresh:active {
  transform: scale(0.98);
}

/* Tabla */
.todos-container .tabla-deberes-container {
  background: white;
  border-radius: 0 0 12px 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.todos-container .tabla-deberes {
  width: 100%;
  border-collapse: collapse;
}

.todos-container .tabla-deberes thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.todos-container .tabla-deberes th {
  padding: 14px 16px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.todos-container .tabla-deberes tbody tr {
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.2s;
}

.todos-container .tabla-deberes tbody tr:nth-child(even) {
  background: #f8f9fa;
}

.todos-container .tabla-deberes tbody tr:hover {
  background: #e9ecef;
}

.todos-container .tabla-deberes td {
  padding: 12px 16px;
  font-size: 14px;
  color: #333;
}

/* Badges de Tipo */
.todos-container .badge-tipo {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.todos-container .badge-evaluacion {
  background: #fee;
  color: #dc3545;
}

.todos-container .badge-evaluación {
  background: #fee;
  color: #dc3545;
}

.todos-container .badge-tarea {
  background: #fff3cd;
  color: #856404;
}

.todos-container .badge-lectura {
  background: #d1ecf1;
  color: #0c5460;
}

/* Curso Tag */
.todos-container .curso-tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  background: #e9ecef;
  color: #495057;
}

/* Fecha */
.todos-container .fecha-cell {
  white-space: nowrap;
}

.todos-container .fecha-proxima {
  color: #dc3545;
  font-weight: 600;
}

.todos-container .fecha-pronto {
  color: #ffc107;
  font-weight: 600;
}

.todos-container .fecha-normal {
  color: #28a745;
}

/* Nota y Peso */
.todos-container .nota-cell {
  text-align: center;
  font-weight: 600;
}

.todos-container .nota-alta { color: #28a745; }
.todos-container .nota-media { color: #ffc107; }
.todos-container .nota-baja { color: #dc3545; }

.todos-container .peso-cell {
  text-align: center;
  color: #666;
}

/* Progreso (solo Lecturas) */
.todos-container .progreso-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

.todos-container .barra-progreso {
  flex: 1;
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  overflow: hidden;
}

.todos-container .barra-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  border-radius: 4px;
  transition: width 0.3s;
}

.todos-container .progreso-text {
  font-size: 12px;
  font-weight: 600;
  color: #667eea;
  min-width: 40px;
  text-align: right;
}

/* Loading y Estado Vacío */
.todos-container .loading-container {
  text-align: center;
  padding: 60px 20px;
}

.todos-container .spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.todos-container .loading-text {
  color: #666;
  font-size: 14px;
}

.todos-container .estado-vacio {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.todos-container .estado-vacio-icon {
  font-size: 64px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.todos-container .estado-vacio-text {
  font-size: 16px;
  margin-bottom: 8px;
}

.todos-container .estado-vacio-subtext {
  font-size: 14px;
  color: #bbb;
}

/* Responsive */
@media (max-width: 1024px) {
  .todos-container {
    padding: 12px;
  }

  .todos-container .filtros-bar {
    flex-direction: column;
    align-items: stretch;
  }

  .todos-container .filtros-bar select,
  .todos-container .btn-refresh {
    width: 100%;
    margin-left: 0;
  }

  .todos-container .tabla-deberes {
    font-size: 13px;
  }

  .todos-container .tabla-deberes th,
  .todos-container .tabla-deberes td {
    padding: 10px 12px;
  }

  .todos-container .tabla-deberes .col-peso {
    display: none;
  }
}

@media (max-width: 768px) {
  .todos-container .todos-header h2 {
    font-size: 20px;
  }

  .todos-container .todos-header p {
    font-size: 13px;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR PRINCIPAL [INICIO] -->
<div class="todos-container">

  <div class="todos-header">
    <h2>📋 Todos los Deberes</h2>
    <p>Vista unificada de evaluaciones, tareas y lecturas ordenadas por fecha</p>
  </div>

  <div class="filtros-bar">
    <label for="filtroTipo">Tipo:</label>
    <select id="filtroTipo" onchange="TodosModule.aplicarFiltros()">
      <option value="todos">Todos los tipos</option>
      <option value="Evaluación">Evaluaciones</option>
      <option value="Tarea">Tareas</option>
      <option value="Lectura">Lecturas</option>
    </select>

    <label for="filtroCurso">Curso:</label>
    <select id="filtroCurso" onchange="TodosModule.aplicarFiltros()">
      <option value="todos">Todos los cursos</option>
    </select>

    <label for="filtroFecha">Período:</label>
    <select id="filtroFecha" onchange="TodosModule.aplicarFiltros()">
      <option value="todos">Todas las fechas</option>
      <option value="proximos7">Próximos 7 días</option>
      <option value="proximos30">Próximos 30 días</option>
      <option value="pasados">Pasados</option>
    </select>

    <button class="btn-refresh" onclick="TodosModule.cargarDeberes()">
      🔄 Actualizar
    </button>
  </div>

  <div class="tabla-deberes-container">

    <div id="loadingDeberes" class="loading-container" style="display: none;">
      <div class="spinner"></div>
      <div class="loading-text">Cargando deberes...</div>
    </div>

    <div id="estadoVacio" class="estado-vacio" style="display: none;">
      <div class="estado-vacio-icon">📚</div>
      <div class="estado-vacio-text">No hay deberes registrados</div>
      <div class="estado-vacio-subtext">Agrega evaluaciones, tareas o lecturas desde sus pestañas correspondientes</div>
    </div>

    <table class="tabla-deberes" id="tablaDeberes" style="display: none;">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Curso</th>
          <th>Nombre</th>
          <th>Fecha</th>
          <th class="col-peso">Peso</th>
          <th>Nota</th>
          <th>Progreso/Detalle</th>
        </tr>
      </thead>
      <tbody id="deberesBody">
      </tbody>
    </table>

  </div>

</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function() {
  'use strict';

  if (typeof window.showAlert === 'undefined') {
    window.showAlert = function(type, message) {
      const alertBox = document.createElement('div');
      alertBox.className = 'alert alert-' + type;
      alertBox.textContent = message;
      alertBox.style.cssText = 'position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;font-size:14px;font-weight:500;animation:slideIn 0.3s;' +
        (type === 'success' ? 'background:#d4edda;color:#155724;' : '') +
        (type === 'error' ? 'background:#f8d7da;color:#721c24;' : '') +
        (type === 'warning' ? 'background:#fff3cd;color:#856404;' : '') +
        (type === 'info' ? 'background:#d1ecf1;color:#0c5460;' : '');

      document.body.appendChild(alertBox);
      setTimeout(function() { alertBox.remove(); }, 3000);
    };

    const style = document.createElement('style');
    style.textContent = '@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}';
    document.head.appendChild(style);
  }

  const state = {
    todosLosDeberes: [],
    deberesFiltrados: [],
    _initDone: false,
    _retryCount: 0
  };

  const MAX_RETRIES = 5;

  function inicializar() {
    console.log('📋 TodosModule.inicializar() llamado (intento ' + (state._retryCount + 1) + ')');

    if (state._initDone) {
      console.log('📋 TodosModule ya inicializado, ignorando');
      return;
    }

    if (typeof currentUser === 'undefined' || !currentUser) {
      console.warn('📋 currentUser no disponible aún, reintentando...');
      
      if (state._retryCount < MAX_RETRIES) {
        state._retryCount++;
        setTimeout(inicializar, 200);
      } else {
        console.error('📋 currentUser no disponible después de ' + MAX_RETRIES + ' intentos');
        setEstadoError('Usuario no disponible', 'Recarga la página');
      }
      return;
    }

    if (!currentUser.codeAlum) {
      console.error('📋 currentUser.codeAlum vacío:', currentUser);
      setEstadoError('Código de alumno no disponible', 'Recarga la página');
      return;
    }

    state._initDone = true;
    console.log('📋 TodosModule inicializado para:', currentUser.codeAlum);

    cargarDeberes();
  }

  function setEstadoError(titulo, subtitulo) {
    const loading = document.getElementById('loadingDeberes');
    const estadoVacio = document.getElementById('estadoVacio');
    const tabla = document.getElementById('tablaDeberes');

    if (loading) loading.style.display = 'none';
    if (tabla) tabla.style.display = 'none';

    if (estadoVacio) {
      estadoVacio.style.display = 'block';
      const t = estadoVacio.querySelector('.estado-vacio-text');
      const s = estadoVacio.querySelector('.estado-vacio-subtext');
      if (t) t.textContent = titulo || 'Error';
      if (s) s.textContent = subtitulo || 'Por favor, recarga la página';
      const icon = estadoVacio.querySelector('.estado-vacio-icon');
      if (icon) icon.textContent = '⚠️';
    }
  }

  function parsearFecha(fechaStr) {
    if (typeof window.parseFechaDD_MM_AAAA === 'function') {
      return window.parseFechaDD_MM_AAAA(fechaStr);
    }

    if (!fechaStr) return null;
    const partes = String(fechaStr).split('/');
    if (partes.length !== 3) return null;

    const dia = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10) - 1;
    const anio = parseInt(partes[2], 10);

    if (Number.isNaN(dia) || Number.isNaN(mes) || Number.isNaN(anio)) return null;
    return new Date(anio, mes, dia);
  }

  function formatearFechaCorta(fechaStr) {
    if (!fechaStr) return '-';
    
    const fecha = parsearFecha(fechaStr);
    if (!fecha || isNaN(fecha.getTime())) return fechaStr;

    const dias = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
    const dia = dias[fecha.getDay()];
    
    const dd = String(fecha.getDate()).padStart(2, '0');
    const mm = String(fecha.getMonth() + 1).padStart(2, '0');
    
    return dia + ' ' + dd + '/' + mm;
  }

  function obtenerClaseFecha(fechaStr) {
    if (!fechaStr) return '';

    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    const fecha = parsearFecha(fechaStr);
    if (!fecha || isNaN(fecha.getTime())) return '';

    const diffDias = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));

    if (diffDias < 0) return '';
    if (diffDias <= 3) return 'fecha-proxima';
    if (diffDias <= 7) return 'fecha-pronto';
    return 'fecha-normal';
  }

  function obtenerClaseNota(nota) {
    if (nota === null || nota === undefined || nota === '') return '';
    const notaNum = parseFloat(nota);
    if (Number.isNaN(notaNum)) return '';

    if (notaNum >= 14) return 'nota-alta';
    if (notaNum >= 11) return 'nota-media';
    return 'nota-baja';
  }

  function cargarCursosEnFiltro() {
    const selectCurso = document.getElementById('filtroCurso');
    if (!selectCurso) return;

    const primerOption = selectCurso.options[0] ? selectCurso.options[0].outerHTML : '<option value="todos">Todos los cursos</option>';

    const cursosUnicos = [...new Set(state.todosLosDeberes.map(d => d.curso).filter(Boolean))].sort();

    selectCurso.innerHTML = primerOption;

    cursosUnicos.forEach(curso => {
      const option = document.createElement('option');
      option.value = curso;
      option.textContent = curso;
      selectCurso.appendChild(option);
    });

    console.log('📋 Dropdown de cursos poblado con', cursosUnicos.length, 'cursos:', cursosUnicos);
  }

  function renderizarTabla() {
    const tbody = document.getElementById('deberesBody');
    const tabla = document.getElementById('tablaDeberes');
    const estadoVacio = document.getElementById('estadoVacio');

    if (!tbody || !tabla || !estadoVacio) return;

    if (state.deberesFiltrados.length === 0) {
      tabla.style.display = 'none';
      estadoVacio.style.display = 'block';
      console.log('📋 No hay deberes para mostrar (filtrados: 0)');
      return;
    }

    estadoVacio.style.display = 'none';
    tabla.style.display = 'table';

    let html = '';

    state.deberesFiltrados.forEach(deber => {
      const claseFecha = obtenerClaseFecha(deber.fecha);
      const claseNota = obtenerClaseNota(deber.nota);
      const fechaFormateada = formatearFechaCorta(deber.fecha);

      html += '<tr>';

      html += '<td>';
      const tipoLower = String(deber.tipo || '').toLowerCase().replace(/ó/g, 'o').replace(/í/g, 'i');
      html += '<span class="badge-tipo badge-' + tipoLower + '">';
      html += (deber.tipo || '-');
      html += '</span>';
      html += '</td>';

      html += '<td><span class="curso-tag">' + (deber.curso || '-') + '</span></td>';

      html += '<td>' + (deber.nombre || '-') + '</td>';

      html += '<td class="fecha-cell ' + claseFecha + '">';
      html += fechaFormateada;
      html += '</td>';

      html += '<td class="peso-cell col-peso">';
      html += (deber.peso ? deber.peso + '%' : '-');
      html += '</td>';

      html += '<td class="nota-cell ' + claseNota + '">';
      html += (deber.nota ? deber.nota : '-');
      html += '</td>';

      html += '<td>';
      if (deber.tipo === 'Lectura' && deber.progreso) {
        const progresoStr = String(deber.progreso);
        const progresoNum = parseFloat(progresoStr);
        const width = Number.isNaN(progresoNum) ? 0 : Math.max(0, Math.min(100, progresoNum));

        html += '<div class="progreso-container">';
        html += '<div class="barra-progreso">';
        html += '<div class="barra-fill" style="width: ' + width + '%"></div>';
        html += '</div>';
        html += '<span class="progreso-text">' + (Number.isNaN(progresoNum) ? progresoStr : (width.toFixed(0) + '%')) + '</span>';
        html += '</div>';
      } else {
        html += '-';
      }
      html += '</td>';

      html += '</tr>';
    });

    tbody.innerHTML = html;
    console.log('📋 Tabla renderizada con', state.deberesFiltrados.length, 'deberes');
  }

  function aplicarFiltros() {
    const filtroTipoEl = document.getElementById('filtroTipo');
    const filtroCursoEl = document.getElementById('filtroCurso');
    const filtroFechaEl = document.getElementById('filtroFecha');

    const filtroTipo = filtroTipoEl ? filtroTipoEl.value : 'todos';
    const filtroCurso = filtroCursoEl ? filtroCursoEl.value : 'todos';
    const filtroFecha = filtroFechaEl ? filtroFechaEl.value : 'todos';

    console.log('📋 Aplicando filtros - Tipo:', filtroTipo, 'Curso:', filtroCurso, 'Fecha:', filtroFecha);

    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    state.deberesFiltrados = state.todosLosDeberes.filter(deber => {
      if (filtroTipo && filtroTipo !== 'todos' && deber.tipo !== filtroTipo) return false;
      if (filtroCurso && filtroCurso !== 'todos' && deber.curso !== filtroCurso) return false;

      if (filtroFecha && filtroFecha !== 'todos') {
        const fechaDeber = parsearFecha(deber.fecha);
        
        if (!fechaDeber) {
          console.log('📋 Fecha no parseable:', deber.fecha);
          return false;
        }

        fechaDeber.setHours(0, 0, 0, 0);

        if (filtroFecha === 'proximos7') {
          const limite = new Date(hoy);
          limite.setDate(limite.getDate() + 7);
          limite.setHours(23, 59, 59, 999);
          
          console.log('📋 Próximos 7 días - Comparando:', deber.fecha, 'fechaDeber:', fechaDeber.toISOString(), 'hoy:', hoy.toISOString(), 'limite:', limite.toISOString());
          
          if (fechaDeber < hoy || fechaDeber > limite) return false;
          
        } else if (filtroFecha === 'proximos30') {
          const limite = new Date(hoy);
          limite.setDate(limite.getDate() + 30);
          limite.setHours(23, 59, 59, 999);
          
          if (fechaDeber < hoy || fechaDeber > limite) return false;
          
        } else if (filtroFecha === 'pasados') {
          if (fechaDeber >= hoy) return false;
        }
      }

      return true;
    });

    console.log('📋 Filtrados:', state.deberesFiltrados.length, 'de', state.todosLosDeberes.length);
    renderizarTabla();
  }

  function cargarDeberes() {
    console.log('📋 Cargando deberes para:', currentUser.codeAlum);

    if (typeof currentUser === 'undefined' || !currentUser.codeAlum) {
      window.showAlert('error', 'No se pudo identificar al usuario');
      setEstadoError('Error al cargar usuario', 'Por favor, recarga la página');
      return;
    }

    const loading = document.getElementById('loadingDeberes');
    const estadoVacio = document.getElementById('estadoVacio');
    const tabla = document.getElementById('tablaDeberes');

    if (loading) loading.style.display = 'block';
    if (estadoVacio) estadoVacio.style.display = 'none';
    if (tabla) tabla.style.display = 'none';

    google.script.run
      .withSuccessHandler(function(response) {
        console.log('📋 Respuesta del backend:', response);
        if (loading) loading.style.display = 'none';

        if (!response) {
          console.error('📋 Response es NULL');
          setEstadoError('Error', 'El servidor retornó NULL');
          return;
        }

        if (response.success !== true) {
          console.error('📋 Response no exitoso:', response.error);
          window.showAlert('error', response.error || 'Error al cargar deberes');
          setEstadoError('Error', response.error || 'No se pudieron cargar los deberes');
          return;
        }

        if (!Array.isArray(response.data)) {
          console.error('📋 response.data no es array:', response.data);
          setEstadoError('Error', 'Formato de respuesta inválido');
          return;
        }

        state.todosLosDeberes = response.data;
        console.log('📋 Deberes cargados:', state.todosLosDeberes.length);
        console.log('📋 Ejemplo de fecha del backend:', state.todosLosDeberes[0] ? state.todosLosDeberes[0].fecha : 'N/A');

        state.todosLosDeberes.sort(function(a, b) {
          if (!a.fecha) return 1;
          if (!b.fecha) return -1;
          const fechaA = parsearFecha(a.fecha);
          const fechaB = parsearFecha(b.fecha);
          if (!fechaA) return 1;
          if (!fechaB) return -1;
          return fechaA - fechaB;
        });

        console.log('📋 Deberes ordenados por fecha');

        if (state.todosLosDeberes.length === 0) {
          if (estadoVacio) estadoVacio.style.display = 'block';
          console.log('📋 No hay deberes en el sistema');
        } else {
          cargarCursosEnFiltro();
          aplicarFiltros();
        }
      })
      .withFailureHandler(function(error) {
        if (loading) loading.style.display = 'none';
        window.showAlert('error', 'Error de conexión al cargar deberes');
        console.error('📋 Error de conexión:', error);
        setEstadoError('Error de conexión', 'No se pudo cargar la información. Reintenta.');
      })
      .studentObtenerTodosDeberes({ codeAlum: currentUser.codeAlum });
  }

  window.TodosModule = {
    inicializar: inicializar,
    cargarDeberes: cargarDeberes,
    aplicarFiltros: aplicarFiltros,
    init: inicializar
  };

  setTimeout(function() {
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
      console.log('📋 currentUser detectado, auto-inicializando...');
      inicializar();
    } else {
      console.log('📋 currentUser no disponible, iniciando retry logic...');
      inicializar();
    }
  }, 150);

  console.log('%c📋 TodosModule V01.22 cargado', 'font-size:11px;color:#667eea;font-weight:bold');

})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Vista unificada "Todos" que consolida Evaluaciones + Tareas + Lecturas
Ordenado por fecha con filtros avanzados

FUNCIONALIDAD:
Carga deberes unificados desde backend
Filtros: Tipo, Curso, Período (próximos 7/30, pasados)
Ordenamiento automático por fecha (más próxima primero)
Badges de tipo con colores
Colores por proximidad de fecha (rojo/amarillo/verde)
Colores dinámicos por nota (verde/amarillo/rojo)
Barra de progreso para lecturas
Formato de fecha mejorado: "Mié 07/01"

CARACTERÍSTICAS TÉCNICAS:
Retry logic robusto (5 intentos, 200ms)
Init tracking con _initDone
Auto-init con setTimeout(150ms)
Fallbacks para showAlert y parseFechaDD_MM_AAAA
Logs exhaustivos con prefijo 📋

FILTROS:
Tipo: Todos/Evaluación/Tarea/Lectura
Curso: Dinámico desde datos cargados
Período: Todos/Próximos 7/Próximos 30/Pasados

FORMATO DE FECHA:
Backend: DD/MM/AAAA
Display: "Mié 07/01" (día de semana + fecha corta)
Comparaciones: Normalizadas a medianoche

COLORES DE FECHA:
Rojo: ≤ 3 días
Amarillo: 4-7 días
Verde: > 7 días

COLORES DE NOTA:
Verde: ≥ 14
Amarillo: 11-13
Rojo: < 11

PROGRESO DE LECTURAS:
Solo para tipo "Lectura"
Barra visual + porcentaje
Validación de rango 0-100%

CONEXIÓN BACKEND:
studentObtenerTodosDeberes({ codeAlum })
Retorna array de objetos: { tipo, curso, nombre, fecha, peso, nota, progreso }

DEPENDENCIAS:
currentUser.codeAlum: ID del estudiante (obligatorio)
showAlert: Función global de alertas (fallback incluido)
parseFechaDD_MM_AAAA: Función de parseo (fallback incluido)

ESTADOS UI:
Loading: Spinner mientras carga
Vacío: Mensaje amigable si no hay deberes
Tabla: Display con todos los deberes filtrados
Error: Mensaje de error con instrucciones

FIX CRÍTICO V01.21:
Normalización de horas en comparación de fechas
Filtros de fecha ahora funcionan correctamente
Logs adicionales para debugging

FIX CRÍTICO V01.20:
Filtro acepta '', 'todos', o null como "mostrar todo"
Resuelve "0 de 9 filtrados"

PATCH V01.21 → V01.22:
Remodulación Estándar CodeWorkShop v4.0
CSS en MOD-002
HTML en MOD-003
JavaScript (IIFE) en MOD-004
Comentarios consolidados en MOD-099
Mantiene lógica de filtros y retry
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 21/24: 7ctabcalendario.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/7ctabcalendario.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 7ctabcalendario.html
VERSIÓN: 01.20
FECHA: 18/01/2026 17:20 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* CONTENEDOR PRINCIPAL */
.calendario-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.calendario-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 15px 20px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 8px;
  color: #fff;
}

.calendario-header h2 {
  margin: 0;
  font-size: 24px;
}

.calendario-nav button {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: #fff;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 8px;
}

.calendario-nav button:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* GRID DEL CALENDARIO */
.calendario-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: #ddd;
  border-radius: 8px;
  overflow: hidden;
}

.calendario-dia-header {
  background: #f5f5f5;
  padding: 12px;
  text-align: center;
  font-weight: 600;
  font-size: 14px;
}

.calendario-celda {
  background: #fff;
  min-height: 100px;
  padding: 8px;
  cursor: pointer;
  position: relative;
  transition: background 0.2s;
}

.calendario-celda:hover {
  background: #f0f0f0;
}

.calendario-celda.fuera-mes {
  background: #e0e0e0;
  color: #999;
  cursor: default;
}

.calendario-celda.fuera-mes:hover {
  background: #e0e0e0;
}

.calendario-celda.hoy {
  border: 3px solid #667eea;
  box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
}

.calendario-dia-numero {
  font-weight: 700;
  margin-bottom: 6px;
  font-size: 16px;
}

.calendario-indicadores {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.calendario-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.calendario-dot.evaluacion {
  background: #dc3545;
}

.calendario-dot.tarea {
  background: #ffc107;
}

.calendario-dot.lectura {
  background: #28a745;
}

.calendario-dot.actividad {
  background: #17a2b8;
}

/* MODAL */
.calendario-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.calendario-modal.active {
  display: flex;
}

.calendario-modal-content {
  background: #fff;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.calendario-modal-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.calendario-modal-header h3 {
  margin: 0;
  font-size: 20px;
}

.calendario-modal-header button {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: #fff;
  font-size: 24px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  line-height: 1;
}

.calendario-modal-header button:hover {
  background: rgba(255, 255, 255, 0.3);
}

.calendario-modal-body {
  padding: 20px;
  overflow-y: auto;
  max-height: 60vh;
}

.calendario-actividad-item {
  padding: 12px;
  margin-bottom: 10px;
  border-left: 4px solid #ccc;
  background: #f8f9fa;
  border-radius: 4px;
}

.calendario-actividad-item.evaluacion {
  border-color: #dc3545;
  background: #fee;
}

.calendario-actividad-item.tarea {
  border-color: #ffc107;
  background: #fff3cd;
}

.calendario-actividad-item.lectura {
  border-color: #28a745;
  background: #d4edda;
}

.calendario-actividad-item.actividad {
  border-color: #17a2b8;
  background: #d1ecf1;
}

.calendario-actividad-item strong {
  display: block;
  margin-bottom: 4px;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.calendario-actividad-item div {
  font-size: 14px;
  margin-bottom: 2px;
}

/* LOADING */
.calendario-loading {
  text-align: center;
  padding: 40px;
  display: none;
}

.calendario-loading.active {
  display: block;
}

.calendario-loading .spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ERROR */
.calendario-error {
  text-align: center;
  padding: 40px;
  color: #dc3545;
  display: none;
}

.calendario-error.active {
  display: block;
}

.calendario-error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.calendario-error-text {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}

.calendario-error-subtext {
  font-size: 14px;
  color: #999;
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .calendario-header {
    flex-direction: column;
    gap: 12px;
  }

  .calendario-nav {
    display: flex;
    gap: 8px;
  }

  .calendario-celda {
    min-height: 80px;
    padding: 6px;
  }

  .calendario-dia-numero {
    font-size: 14px;
  }

  .calendario-modal-content {
    width: 95%;
    max-width: none;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR PRINCIPAL [INICIO] -->
<div class="calendario-container">
  <div class="calendario-header">
    <h2 id="calTitulo">Calendario</h2>
    <div class="calendario-nav">
      <button onclick="CalendarioModule.nav(-1)">← Anterior</button>
      <button onclick="CalendarioModule.hoy()">Hoy</button>
      <button onclick="CalendarioModule.nav(1)">Siguiente →</button>
    </div>
  </div>

  <div id="calLoading" class="calendario-loading">
    <div class="spinner"></div>
    <div>Cargando calendario...</div>
  </div>

  <div id="calError" class="calendario-error">
    <div class="calendario-error-icon">⚠️</div>
    <div class="calendario-error-text">Error al cargar el calendario</div>
    <div class="calendario-error-subtext">Por favor, recarga la página</div>
  </div>

  <div id="calGrid" class="calendario-grid">
    <div class="calendario-dia-header">Lun</div>
    <div class="calendario-dia-header">Mar</div>
    <div class="calendario-dia-header">Mié</div>
    <div class="calendario-dia-header">Jue</div>
    <div class="calendario-dia-header">Vie</div>
    <div class="calendario-dia-header">Sáb</div>
    <div class="calendario-dia-header">Dom</div>
  </div>
</div>

<div id="calModal" class="calendario-modal" onclick="CalendarioModule.cerrarSiFondo(event)">
  <div class="calendario-modal-content" onclick="event.stopPropagation()">
    <div class="calendario-modal-header">
      <h3 id="modalTitulo"></h3>
      <button onclick="CalendarioModule.cerrar()">×</button>
    </div>
    <div id="modalBody" class="calendario-modal-body"></div>
  </div>
</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function PBE_CALENDARIO_MODULE() {
  'use strict';

  // PREVENIR DOBLE CARGA
  if (window.CalendarioModule && window.CalendarioModule._loaded) {
    console.log('🗓️ CalendarioModule ya cargado, ignorando');
    return;
  }

  console.log('🗓️ CalendarioModule V01.20 iniciando...');

  const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

  const CalendarioModule = {
    _loaded: true,
    _initDone: false,
    _retryCount: 0,
    m: new Date().getMonth(),
    y: new Date().getFullYear(),
    acts: [],

    // INIT CON RETRY LOGIC
    init() {
      console.log('🗓️ CalendarioModule.init() llamado (intento ' + (this._retryCount + 1) + ')');

      if (this._initDone) {
        console.log('🗓️ CalendarioModule ya inicializado, ignorando');
        return;
      }

      if (typeof currentUser === 'undefined' || !currentUser) {
        console.warn('🗓️ currentUser no disponible aún, reintentando...');
        
        if (this._retryCount < 5) {
          this._retryCount++;
          setTimeout(() => this.init(), 200);
        } else {
          console.error('🗓️ currentUser no disponible después de 5 intentos');
          this.mostrarError('Usuario no disponible', 'Recarga la página');
        }
        return;
      }

      if (!currentUser.codeAlum) {
        console.error('🗓️ currentUser.codeAlum vacío:', currentUser);
        this.mostrarError('Código de alumno no disponible', 'Recarga la página');
        return;
      }

      this._initDone = true;
      console.log('🗓️ CalendarioModule inicializado para:', currentUser.codeAlum);

      this.load();
    },

    nav(d) { 
      this.m += d; 
      if (this.m > 11) { this.m = 0; this.y++; } 
      if (this.m < 0) { this.m = 11; this.y--; }
      console.log('🗓️ Navegando a:', MESES[this.m], this.y);
      this.render(); 
    },

    hoy() { 
      const n = new Date(); 
      this.m = n.getMonth(); 
      this.y = n.getFullYear();
      console.log('🗓️ Volviendo a hoy:', MESES[this.m], this.y);
      this.render(); 
    },

    mostrarError(titulo, subtitulo) {
      const loading = document.getElementById('calLoading');
      const error = document.getElementById('calError');
      const grid = document.getElementById('calGrid');

      if (loading) loading.classList.remove('active');
      if (grid) grid.style.display = 'none';

      if (error) {
        error.classList.add('active');
        const t = error.querySelector('.calendario-error-text');
        const s = error.querySelector('.calendario-error-subtext');
        if (t) t.textContent = titulo || 'Error';
        if (s) s.textContent = subtitulo || 'Por favor, recarga la página';
      }
    },

    // CARGA DE DATOS
    load() {
      console.log('🗓️ Cargando datos del calendario...');
      
      const loading = document.getElementById('calLoading');
      const error = document.getElementById('calError');
      const grid = document.getElementById('calGrid');

      if (loading) loading.classList.add('active');
      if (error) error.classList.remove('active');
      if (grid) grid.style.display = 'none';

      Promise.all([
        this.call('studentObtenerEvaluaciones', 'FechaEval', 'Evaluacion', 'evaluacion', 'Evaluación'),
        this.call('studentObtenerTareas', 'FechaEntrega', 'TipoTarea', 'tarea', 'Tarea'),
        this.call('studentObtenerLecturas', 'FechaEval', 'Título', 'lectura', 'Lectura'),
        this.call('studentObtenerHorarioSem', 'FechaHS', 'Actividad', 'actividad', 'Actividad')
      ]).then(results => {
        this.acts = results.flat();
        console.log('🗓️ Total de actividades cargadas:', this.acts.length);
        console.log('🗓️ Desglose:', {
          evaluaciones: results[0].length,
          tareas: results[1].length,
          lecturas: results[2].length,
          actividades: results[3].length
        });

        if (loading) loading.classList.remove('active');
        if (grid) grid.style.display = 'grid';
        
        this.render();
      }).catch(err => {
        console.error('🗓️ Error en Promise.all:', err);
        this.mostrarError('Error al cargar datos', 'No se pudieron obtener las actividades');
      });
    },

    // LLAMADAS AL BACKEND
    call(fn, campoFecha, campoNombre, tipo, tipoNombre) {
      console.log('🗓️ Llamando a:', fn);
      
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(response => {
            console.log('🗓️', fn, 'response:', response);
            
            if (!response) {
              console.error('🗓️', fn, 'retornó NULL');
              resolve([]);
              return;
            }

            if (!response.success) {
              console.error('🗓️', fn, 'error:', response.error);
              resolve([]);
              return;
            }

            if (!Array.isArray(response.data)) {
              console.error('🗓️', fn, 'data no es array:', response.data);
              resolve([]);
              return;
            }

            const mapped = response.data.map(item => {
              const actividad = {
                tipo: tipo,
                tipoNombre: tipoNombre,
                fecha: item[campoFecha] || '',
                nombre: item[campoNombre] || 'Sin nombre',
                curso: item.Curso || ''
              };

              if (response.data.indexOf(item) === 0) {
                console.log('🗓️', fn, 'ejemplo:', actividad);
              }

              return actividad;
            });

            console.log('🗓️', fn, 'mapeados:', mapped.length);
            resolve(mapped);
          })
          .withFailureHandler(error => {
            console.error('🗓️', fn, 'falló:', error);
            resolve([]);
          })
          [fn]({ codeAlum: currentUser.codeAlum });
      });
    },

    // RENDERIZADO
    render() {
      console.log('🗓️ Renderizando calendario:', MESES[this.m], this.y);
      
      document.getElementById('calTitulo').textContent = `${MESES[this.m]} ${this.y}`;
      
      const grid = document.getElementById('calGrid');
      
      while (grid.children.length > 7) {
        grid.removeChild(grid.lastChild);
      }

      const primerDia = new Date(this.y, this.m, 1);
      const start = (primerDia.getDay() || 7) - 1;
      let d = 1 - start;

      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);

      for (let i = 0; i < 42; i++, d++) {
        const date = new Date(this.y, this.m, d);
        const fueraMes = date.getMonth() !== this.m;
        
        const cell = document.createElement('div');
        cell.className = 'calendario-celda' + (fueraMes ? ' fuera-mes' : '');
        
        const cellDate = new Date(date);
        cellDate.setHours(0, 0, 0, 0);
        if (cellDate.getTime() === hoy.getTime()) {
          cell.classList.add('hoy');
        }

        cell.innerHTML = `<div class="calendario-dia-numero">${date.getDate()}</div>`;

        if (!fueraMes) {
          const fechaStr = this.formatearFecha(date);
          const actsDia = this.acts.filter(a => a.fecha === fechaStr);

          if (actsDia.length > 0) {
            const ind = document.createElement('div');
            ind.className = 'calendario-indicadores';
            
            const tiposUnicos = [...new Set(actsDia.map(a => a.tipo))];
            tiposUnicos.forEach(t => {
              const dot = document.createElement('span');
              dot.className = 'calendario-dot ' + t;
              ind.appendChild(dot);
            });
            
            cell.appendChild(ind);
            cell.onclick = () => this.abrirModal(date, actsDia);
          }
        }
        
        grid.appendChild(cell);
      }

      console.log('🗓️ Calendario renderizado con 42 celdas');
    },

    // MODAL
    abrirModal(fecha, actividades) {
      console.log('🗓️ Abriendo modal para:', this.formatearFecha(fecha), 'con', actividades.length, 'actividades');
      
      document.getElementById('modalTitulo').textContent = 
        `${fecha.getDate()} de ${MESES[fecha.getMonth()]} ${this.y}`;
      
      const body = document.getElementById('modalBody');
      body.innerHTML = actividades.map(a => `
        <div class="calendario-actividad-item ${a.tipo}">
          <strong>${a.tipoNombre}</strong>
          <div>${a.nombre}</div>
          ${a.curso ? `<div>Curso: ${a.curso}</div>` : ''}
        </div>
      `).join('');
      
      document.getElementById('calModal').classList.add('active');
    },

    cerrar() {
      console.log('🗓️ Cerrando modal');
      document.getElementById('calModal').classList.remove('active');
    },

    cerrarSiFondo(event) {
      if (event.target.id === 'calModal') {
        this.cerrar();
      }
    },

    // HELPERS
    formatearFecha(date) {
      const dia = String(date.getDate()).padStart(2, '0');
      const mes = String(date.getMonth() + 1).padStart(2, '0');
      const anio = date.getFullYear();
      return `${dia}/${mes}/${anio}`;
    }
  };

  // EXPONER GLOBALMENTE
  window.CalendarioModule = CalendarioModule;

  // AUTO-INIT CON RETRY
  setTimeout(() => {
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
      console.log('🗓️ currentUser detectado, auto-inicializando...');
      CalendarioModule.init();
    } else {
      console.log('🗓️ currentUser no disponible, iniciando retry logic...');
      CalendarioModule.init();
    }
  }, 150);

  console.log('%c🗓️ CalendarioModule V01.20 cargado', 'font-size:11px;color:#667eea;font-weight:bold');

})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Calendario mensual interactivo con vista de actividades académicas
Muestra evaluaciones, tareas, lecturas y actividades del horario semanal

FUNCIONALIDAD:
Renderizar calendario mensual con grid de 6x7
Navegar entre meses (anterior/siguiente/hoy)
Cargar actividades desde múltiples fuentes
Mostrar indicadores visuales por tipo de actividad
Modal con detalle de actividades al hacer click en día

TIPOS DE ACTIVIDADES:
Evaluaciones (rojo): Exámenes y pruebas
Tareas (amarillo): Trabajos y asignaciones
Lecturas (verde): Material de lectura
Actividades (azul): Horario semanal

ESTRUCTURA DE DATOS:
Cada actividad contiene:
- tipo: evaluacion, tarea, lectura, actividad
- tipoNombre: Nombre legible del tipo
- fecha: DD/MM/AAAA
- nombre: Nombre de la actividad
- curso: Código del curso

CARACTERÍSTICAS TÉCNICAS:
Módulo objeto CalendarioModule
Retry logic para currentUser (5 intentos, 200ms)
Promise.all para carga paralela de datos
Validación robusta de respuestas backend
Logs exhaustivos con prefijo 🗓️

MAPEO DE CAMPOS BACKEND:
Evaluaciones: FechaEval → Evaluacion
Tareas: FechaEntrega → TipoTarea
Lecturas: FechaEval → Título
Horario: FechaHS → Actividad

CONEXIÓN BACKEND:
studentObtenerEvaluaciones({ codeAlum }): Lista de evaluaciones
studentObtenerTareas({ codeAlum }): Lista de tareas
studentObtenerLecturas({ codeAlum }): Lista de lecturas
studentObtenerHorarioSem({ codeAlum }): Horario semanal

DEPENDENCIAS:
currentUser.codeAlum: Identificador del estudiante
Requiere backend V01.25+ (fechas DD/MM/AAAA)

CALENDARIO:
Grid de 7 columnas (Lun-Dom)
42 celdas (6 semanas)
Semana comienza en Lunes
Marca el día actual con borde azul
Días fuera del mes en gris

INDICADORES:
Puntos de colores en días con actividades
Un punto por tipo único de actividad
Click en día abre modal con lista completa

MODAL:
Header con fecha seleccionada
Lista de actividades con colores por tipo
Cierre con botón X o click fuera del modal

NAVEGACIÓN:
← Anterior: Mes anterior
Hoy: Volver al mes actual
Siguiente →: Mes siguiente

ESTADOS UI:
Loading: Spinner mientras carga datos
Error: Mensaje de error con opción de recarga
Calendario: Grid con días y actividades

PROTECCIONES:
Previene doble carga (_loaded flag)
Init idempotente (_initDone flag)
Retry logic robusto para currentUser
Validación de respuestas NULL/success/data

RESPONSIVE:
Mobile: Header en columna, celdas más pequeñas
Desktop: Header en fila, celdas amplias
Modal: Ancho adaptativo (95% mobile, 90% desktop)

CAMBIOS V01.19 → V01.20:
Remodulación Estándar CodeWorkShop v4.0
CSS en MOD-002
HTML en MOD-003
JavaScript (módulo objeto) en MOD-004
Comentarios aligerados
Notas consolidadas en MOD-099
Mantiene lógica funcional sin cambios
Mantiene retry logic y mapeo de campos corregidos
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 22/24: 7ctabhorarioclase.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/7ctabhorarioclase.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
/******************************************
PROYECTO: PBE Control
ARCHIVO: 7ctabhorarioclase.html
VERSIÓN: 01.27
FECHA: 24/01/2026 14:13 (UTC-5)
******************************************/
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: APERTURA [INICIO] -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horario de Clases</title>
<!-- MOD-002: FIN -->

<!-- MOD-003: ESTILOS CSS [INICIO] -->
<style>

/* MOD-003-S01: CONTENEDOR PRINCIPAL [INICIO] */
.hc-grid-container {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  position: relative;
  min-height: 400px;
}
/* MOD-003-S01: FIN */

/* MOD-003-S02: GRID Y TABLA [INICIO] */
.hc-grid {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.hc-grid thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.hc-grid th {
  padding: 12px 8px;
  text-align: center;
  font-weight: 600;
  border: 1px solid rgba(255,255,255,.2);
}

.hc-grid .hc-col-hora {
  width: 80px;
  background: #f8f9fa;
  font-weight: 600;
  color: #495057;
}

.hc-grid .hc-col-dia {
  width: calc((100% - 80px) / 7);
  min-width: 100px;
}

.hc-grid td {
  padding: 4px;
  border: 1px solid #dee2e6;
  height: 45px;
  vertical-align: middle;
}
/* MOD-003-S02: FIN */

/* MOD-003-S03: CELDAS DE CLASE [INICIO] */
.hc-celda-clase {
  min-height: 35px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
  font-size: 12px;
}

.hc-celda-clase:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
}

.hc-celda-clase.ocupada {
  color: white;
  padding: 6px 8px;
}

.hc-celda-clase.conflicto {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%) !important;
  font-size: 11px;
  font-weight: 700;
}
/* MOD-003-S03: FIN */

/* MOD-003-S04: FORMULARIO OVERLAY [INICIO] */
.hc-form-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.hc-form-overlay.active {
  display: flex;
}

.hc-form-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 10px 40px rgba(0,0,0,.2);
}

.hc-form-content h3 {
  margin: 0 0 20px;
  color: #667eea;
  font-size: 20px;
}
/* MOD-003-S04: FIN */

/* MOD-003-S05: FORMULARIO CAMPOS [INICIO] */
.hc-form-group {
  margin-bottom: 16px;
}

.hc-form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #333;
  font-size: 13px;
}

.hc-form-group input,
.hc-form-group select {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  transition: border 0.3s;
  box-sizing: border-box;
}

.hc-form-group input:focus,
.hc-form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
}
/* MOD-003-S05: FIN */

/* MOD-003-S06: BOTONES [INICIO] */
.hc-form-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  justify-content: flex-end;
}

.hc-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.hc-btn-primary {
  background: #667eea;
  color: white;
}

.hc-btn-primary:hover {
  background: #5568d3;
}

.hc-btn-secondary {
  background: #6c757d;
  color: white;
}

.hc-btn-secondary:hover {
  background: #5a6268;
}

.hc-btn-danger {
  background: #dc3545;
  color: white;
}

.hc-btn-danger:hover {
  background: #c82333;
}
/* MOD-003-S06: FIN */

/* MOD-003-S07: MODAL SELECCIÓN [INICIO] */
.hc-modal-seleccion {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.hc-modal-seleccion.active {
  display: flex;
}

.hc-modal-seleccion-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 40px rgba(0,0,0,.2);
}

.hc-modal-seleccion-content h3 {
  margin: 0 0 16px;
  color: #667eea;
  font-size: 18px;
}

.hc-modal-seleccion-content p {
  margin: 0 0 16px;
  color: #666;
  font-size: 14px;
}

.hc-clase-option {
  padding: 16px;
  margin-bottom: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.hc-clase-option:hover {
  border-color: #667eea;
  background: #f8f9ff;
  transform: translateX(4px);
}

.hc-clase-option-curso {
  font-weight: 700;
  font-size: 16px;
  color: #333;
  margin-bottom: 4px;
}

.hc-clase-option-horario {
  font-size: 13px;
  color: #666;
}

.hc-modal-seleccion-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 16px;
}
/* MOD-003-S07: FIN */

/* MOD-003-S08: LOADING [INICIO] */
.hc-loading {
  text-align: center;
  padding: 40px;
  color: #667eea;
}

.hc-spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(102,126,234,.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: hc-spin .8s linear infinite;
}

@keyframes hc-spin {
  to { transform: rotate(360deg); }
}
/* MOD-003-S08: FIN */

/* MOD-003-S09: RESPONSIVE [INICIO] */
@media (max-width: 768px) {
  .hc-grid {
    font-size: 11px;
  }
  
  .hc-grid .hc-col-hora {
    width: 60px;
  }
  
  .hc-celda-clase {
    font-size: 10px;
    padding: 4px;
  }
  
  .hc-form-content {
    width: 95%;
    padding: 20px;
  }
}
/* MOD-003-S09: FIN */

</style>
<!-- MOD-003: FIN -->

<!-- MOD-004: ESTRUCTURA HTML [INICIO] -->
<div class="hc-grid-container">
  <div class="hc-loading" id="loadingHC">
    <div class="hc-spinner"></div>
    <p>Cargando horario...</p>
  </div>
  <div id="hcGridContainer"></div>
</div>

<div id="formClase" class="hc-form-overlay">
  <div class="hc-form-content">
    <h3 id="formTitle">Agregar Clase</h3>
    
    <form id="claseForm" onsubmit="return window.hcHandleSubmitClase(event)">
      <input type="hidden" id="claseRowNumber">
      <input type="hidden" id="claseModoEdicion" value="false">
      <input type="hidden" id="claseDia">
      <input type="hidden" id="claseHoraSlot">
      
      <div class="hc-form-group">
        <label>Curso:</label>
        <select id="claseCurso" required>
          <option value="">Seleccionar...</option>
        </select>
      </div>
      
      <div class="hc-form-group">
        <label>Hora Inicio:</label>
        <input type="time" id="claseHoraIni" required>
      </div>
      
      <div class="hc-form-group">
        <label>Hora Fin:</label>
        <input type="time" id="claseHoraFin" required>
      </div>
      
      <div class="hc-form-actions">
        <button type="button" class="hc-btn hc-btn-secondary" onclick="window.hcCancelarFormClase()">Cancelar</button>
        <button type="button" class="hc-btn hc-btn-danger" id="btnEliminar" style="display:none" onclick="window.hcConfirmarEliminarClase()">Eliminar</button>
        <button type="submit" class="hc-btn hc-btn-primary" id="btnSubmit">Guardar</button>
      </div>
    </form>
  </div>
</div>

<div id="modalSeleccion" class="hc-modal-seleccion">
  <div class="hc-modal-seleccion-content">
    <h3>Seleccionar Clase</h3>
    <p>Hay múltiples clases en este horario. Selecciona una:</p>
    <div id="modalSeleccionOpciones"></div>
    <div class="hc-modal-seleccion-actions">
      <button class="hc-btn hc-btn-secondary" onclick="window.hcCerrarModalSeleccion()">Cancelar</button>
    </div>
  </div>
</div>
<!-- MOD-004: FIN -->

<!-- MOD-005: JAVASCRIPT [INICIO] -->
<script>

// MOD-005-S01: ENCAPSULAMIENTO IIFE [INICIO]
(function () {
'use strict';

if (window.HorarioClaseModule) {
  console.log('🕐 HorarioClaseModule ya existe, ignorando carga');
  return;
}

console.log('🕐 HorarioClaseModule V01.26 CODEWORKSHOP iniciando...');
// MOD-005-S01: FIN

// MOD-005-S02: VARIABLES Y CONSTANTES [INICIO]
let clasesData = [];
let cursosData = [];
let horarioMatrix = {};
const HORA_INICIO = 7;
const HORA_FIN = 22;
const DIAS = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
const DIAS_CORTOS = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
let _initDone = false;
let _retryCount = 0;
const MAX_RETRIES = 5;
// MOD-005-S02: FIN

// MOD-005-S03: INICIALIZACIÓN [INICIO]
function init() {
  console.log('🕐 HorarioClaseModule.init() llamado (intento ' + (_retryCount + 1) + ')');
  
  if (_initDone) {
    console.log('🕐 Ya inicializado, ignorando');
    return;
  }
  
  if (!window.currentUser || !currentUser.codeAlum) {
    console.warn('🕐 currentUser no disponible, reintentando...');
    
    if (_retryCount < MAX_RETRIES) {
      _retryCount++;
      setTimeout(init, 200);
    } else {
      console.error('🕐 currentUser no disponible después de ' + MAX_RETRIES + ' intentos');
      ocultarLoading();
    }
    return;
  }
  
  _initDone = true;
  console.log('🕐 Inicializado para:', currentUser.codeAlum);
  
  cargarCursos();
}
// MOD-005-S03: FIN

// MOD-005-S04: CARGA DE CURSOS V2 [INICIO]
function cargarCursos() {
  console.log('🕐 Cargando cursos...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('🕐 Cursos response:', r);
      
      if (r && r.success) {
        cursosData = r.data || [];
        console.log('🕐 Cursos cargados:', cursosData.length);
        poblarDropdownCursos();
        cargarHorarioClases();
      } else {
        console.error('🕐 Error en cursos:', r);
        cargarHorarioClases();
      }
    })
    .withFailureHandler(e => {
      console.error('🕐 Error al cargar cursos:', e);
      cargarHorarioClases();
    })
    .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
}

function poblarDropdownCursos() {
  const select = document.getElementById('claseCurso');
  if (!select) return;
  
  // Limpiar select manteniendo la opción por defecto
  select.innerHTML = '<option value="">Seleccionar...</option>';

  cursosData.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.Curso;
    opt.textContent = c.Curso + ' - ' + c.Completo;
    opt.dataset.color = c.Color || '#667eea';
    select.appendChild(opt);
  });
  
  console.log('🕐 Dropdown poblado con', cursosData.length, 'cursos');
}
// MOD-005-S04: FIN

// MOD-005-S05: CARGA DE HORARIO [INICIO]
function cargarHorarioClases() {
  console.log('🕐 Cargando horario clases...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('🕐 HorarioClases response:', r);
      
      if (r && r.success) {
        clasesData = r.data || [];
        console.log('🕐 Clases cargadas:', clasesData.length);
        
        if (clasesData.length > 0) {
          console.log('🕐 Ejemplo de clase:', clasesData[0]);
        }
        
        construirMatriz();
        renderGrid();
        ocultarLoading();
      } else {
        console.error('🕐 Error en response:', r);
        renderGrid();
        ocultarLoading();
      }
    })
    .withFailureHandler(e => {
      console.error('🕐 Error de conexión:', e);
      renderGrid();
      ocultarLoading();
    })
    .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
}
// MOD-005-S05: FIN

// MOD-005-S06: CONSTRUCCIÓN DE MATRIZ [INICIO]
function construirMatriz() {
  console.log('🕐 Construyendo matriz con', clasesData.length, 'clases');
  
  horarioMatrix = {};
  DIAS.forEach(d => horarioMatrix[d] = {});
  
  clasesData.forEach((c, idx) => {
    console.log('🕐 Procesando clase ' + (idx + 1) + ':', {
      Curso: c.Curso,
      Detalle: c.Detalle,
      HoraIni: c.HoraIni,
      HoraFin: c.HoraFin
    });
    
    const dia = extraerDia(c.Detalle);
    console.log('🕐 Día extraído:', dia, 'de Detalle:', c.Detalle);
    
    if (!dia) {
      console.warn('🕐 No se pudo extraer día de:', c.Detalle);
      return;
    }
    
    const horas = calcularHoras(c.HoraIni, c.HoraFin);
    console.log('🕐 Horas calculadas:', horas.length, 'slots');
    
    horas.forEach(h => {
      horarioMatrix[dia][h.hora] = horarioMatrix[dia][h.hora] || [];
      horarioMatrix[dia][h.hora].push({ clase: c, ...h });
    });
  });
  
  let conflictos = 0;
  DIAS.forEach(d => {
    Object.keys(horarioMatrix[d]).forEach(h => {
      if (horarioMatrix[d][h].length > 1) {
        conflictos++;
        const cursos = horarioMatrix[d][h].map(x => x.clase.Curso).join(', ');
        console.log('🕐 ⚠️ Conflicto en', d, h + ':', cursos);
      }
    });
  });
  
  if (conflictos > 0) {
    console.log('🕐 Total de conflictos detectados:', conflictos);
  }
  
  console.log('🕐 Matriz construida:', horarioMatrix);
}
// MOD-005-S06: FIN

// MOD-005-S07: HELPERS DE PROCESAMIENTO [INICIO]
function extraerDia(t) {
  if (!t) return null;
  const s = String(t).toLowerCase().trim();
  const diaEncontrado = DIAS.find(d => {
    const dLower = d.toLowerCase();
    return s.includes(dLower) || dLower.includes(s);
  });
  return diaEncontrado || null;
}

function calcularHoras(i, f) {
  const horaIniStr = normalizarHora(i);
  const horaFinStr = normalizarHora(f);
  
  if (!horaIniStr || !horaFinStr) {
    console.error('🕐 Horas inválidas después de normalizar');
    return [];
  }
  
  const [hi, mi] = horaIniStr.split(':').map(Number);
  const [hf, mf] = horaFinStr.split(':').map(Number);
  
  const res = [];
  
  for (let h = hi; h <= hf; h++) {
    if (h > HORA_FIN) break;
    if (h === hf && mf === 0) continue;
    
    res.push({
      hora: String(h).padStart(2, '0') + ':00',
      prefijo: (h === hi && mi >= 30) ? '/' : '',
      sufijo: (h === hf && mf > 0 && mf < 60) ? '/' : ''
    });
  }
  
  return res;
}

function normalizarHora(valor) {
  if (!valor) return null;
  
  if (typeof valor === 'string') {
    const match = valor.match(/(\d{1,2}):(\d{2})/);
    if (match) {
      const h = match[1].padStart(2, '0');
      const m = match[2];
      return h + ':' + m;
    }
  }
  
  if (typeof valor === 'object' && valor !== null) {
    if ('hour' in valor && 'minute' in valor) {
      const h = String(valor.hour).padStart(2, '0');
      const m = String(valor.minute).padStart(2, '0');
      return h + ':' + m;
    }
  }
  
  return null;
}

function colorCurso(curso) {
  const c = cursosData.find(x => x.Curso === curso);
  return c ? c.Color : '#667eea';
}
// MOD-005-S07: FIN

// MOD-005-S08: RENDERIZADO DE GRID [INICIO]
function renderGrid() {
  console.log('🕐 Renderizando grid...');
  
  const c = document.getElementById('hcGridContainer');
  if (!c) {
    console.error('🕐 No se encontró hcGridContainer');
    return;
  }

  let html = '<table class="hc-grid"><thead><tr><th class="hc-col-hora">Hora</th>';
  DIAS_CORTOS.forEach(d => html += `<th class="hc-col-dia">${d}</th>`);
  html += '</tr></thead><tbody>';

  let celdasOcupadas = 0;
  let celdasVacias = 0;
  let celdasConflicto = 0;

  for (let h = HORA_INICIO; h <= HORA_FIN; h++) {
    const k = String(h).padStart(2, '0') + ':00';
    const horaFormato = formatearHora12(h);
    
    html += `<tr><td class="hc-col-hora">${horaFormato}</td>`;
    
    DIAS.forEach(d => {
      const s = horarioMatrix[d][k];
      
      if (s && s.length > 0) {
        if (s.length > 1) {
          celdasConflicto++;
          
          const nombres = s.map(x => {
            const curso = x.clase.Curso;
            return curso.length > 4 ? curso.substring(0, 4) : curso;
          }).join('/');
          
          html += `<td><div class="hc-celda-clase ocupada conflicto" 
            onclick="window.hcMostrarSeleccionClase('${d}','${k}')">
            ${nombres}
          </div></td>`;
        } else {
          celdasOcupadas++;
          const x = s[0];
          const color = colorCurso(x.clase.Curso);
          const texto = x.prefijo + x.clase.Curso + x.sufijo;
          
          html += `<td><div class="hc-celda-clase ocupada" 
            style="background:${color}" 
            onclick="window.hcEditarClase('${d}','${k}')">
            ${texto}
          </div></td>`;
        }
      } else {
        celdasVacias++;
        html += `<td><div class="hc-celda-clase" 
          onclick="window.hcClickCelda('${d}','${k}')">
        </div></td>`;
      }
    });
    
    html += '</tr>';
  }

  html += '</tbody></table>';
  c.innerHTML = html;
  
  console.log('🕐 Grid renderizado:', { celdasOcupadas, celdasVacias, celdasConflicto });
}

function ocultarLoading() {
  const l = document.getElementById('loadingHC');
  if (l) l.style.display = 'none';
}
// MOD-005-S08: FIN

// MOD-005-S09: MODAL SELECCIÓN [INICIO]
function mostrarSeleccionClase(dia, hora) {
  console.log('🕐 Mostrando selección de clase:', { dia, hora });
  
  const clases = horarioMatrix[dia][hora];
  
  if (!clases || clases.length === 0) {
    alert('No hay clases en esta celda');
    return;
  }
  
  const modal = document.getElementById('modalSeleccion');
  const opciones = document.getElementById('modalSeleccionOpciones');
  
  opciones.innerHTML = '';
  
  clases.forEach((c, idx) => {
    const clase = c.clase;
    const div = document.createElement('div');
    div.className = 'hc-clase-option';
    div.onclick = function() {
      cerrarModalSeleccion();
      editarClaseDirecta(clase);
    };
    
    div.innerHTML = `
      <div class="hc-clase-option-curso">${clase.Curso}</div>
      <div class="hc-clase-option-horario">${clase.HoraIni} - ${clase.HoraFin}</div>
    `;
    
    opciones.appendChild(div);
  });
  
  modal.classList.add('active');
}

function cerrarModalSeleccion() {
  const modal = document.getElementById('modalSeleccion');
  modal.classList.remove('active');
}

function editarClaseDirecta(clase) {
  console.log('🕐 Editando clase directa:', clase);
  
  const dia = extraerDia(clase.Detalle);
  const diaCorto = DIAS_CORTOS[DIAS.indexOf(dia)];
  
  document.getElementById('formTitle').textContent = 'Editar Clase - ' + diaCorto;
  document.getElementById('claseRowNumber').value = clase._rowNumber || '';
  document.getElementById('claseModoEdicion').value = 'true';
  document.getElementById('claseDia').value = dia;
  document.getElementById('claseHoraSlot').value = '';
  document.getElementById('claseCurso').value = clase.Curso;
  
  document.getElementById('claseHoraIni').value = normalizarHora(clase.HoraIni) || '';
  document.getElementById('claseHoraFin').value = normalizarHora(clase.HoraFin) || '';
  
  document.getElementById('btnSubmit').textContent = 'Actualizar';
  document.getElementById('btnEliminar').style.display = 'block';

  document.getElementById('formClase').classList.add('active');
}
// MOD-005-S09: FIN

// MOD-005-S10: VALIDACIÓN SOLAPAMIENTO [INICIO]
function verificarSolapamiento(dia, horaIni, horaFin, rowNumberActual) {
  console.log('🕐 Verificando solapamiento:', { dia, horaIni, horaFin });
  
  const [hi, mi] = horaIni.split(':').map(Number);
  const [hf, mf] = horaFin.split(':').map(Number);
  
  const horasOcupadas = calcularHoras(horaIni, horaFin);
  const solapamientos = [];
  
  horasOcupadas.forEach(h => {
    const clasesEnHora = horarioMatrix[dia][h.hora] || [];
    
    clasesEnHora.forEach(c => {
      if (rowNumberActual && c.clase._rowNumber === rowNumberActual) {
        return;
      }
      
      solapamientos.push(c.clase.Curso);
    });
  });
  
  const solapamientosUnicos = [...new Set(solapamientos)];
  
  return solapamientosUnicos;
}
// MOD-005-S10: FIN

// MOD-005-S11: FORMULARIO AGREGAR [INICIO]
function clickCelda(dia, hora) {
  console.log('🕐 Click en celda:', { dia, hora });
  abrirFormularioAgregar(dia, hora);
}

function abrirFormularioAgregar(dia, hora) {
  resetFormClase();

  const diaCorto = DIAS_CORTOS[DIAS.indexOf(dia)];
  const horaFormato = formatearHora12Desde24(hora);

  document.getElementById('formTitle').textContent = 'Agregar Clase - ' + diaCorto + ' ' + horaFormato;
  document.getElementById('claseModoEdicion').value = 'false';
  document.getElementById('claseDia').value = dia;
  document.getElementById('claseHoraSlot').value = hora;
  document.getElementById('btnSubmit').textContent = 'Guardar';
  document.getElementById('btnEliminar').style.display = 'none';

  document.getElementById('claseHoraIni').value = hora;
  
  const [h] = hora.split(':').map(Number);
  const horaFinSugerida = String(Math.min(h + 1, HORA_FIN + 1)).padStart(2, '0') + ':00';
  document.getElementById('claseHoraFin').value = horaFinSugerida;

  document.getElementById('formClase').classList.add('active');
  
  const select = document.getElementById('claseCurso');
  if (select) select.focus();
}
// MOD-005-S11: FIN

// MOD-005-S12: FORMULARIO EDITAR [INICIO]
function editarClase(dia, hora) {
  console.log('🕐 Editar clase:', { dia, hora });
  
  const clases = horarioMatrix[dia][hora];

  if (!clases || clases.length === 0) {
    if (window.showAlert) {
      showAlert('error', 'No hay clase en esta celda');
    } else {
      alert('No hay clase en esta celda');
    }
    return;
  }

  const clase = clases[0].clase;
  editarClaseDirecta(clase);
}
// MOD-005-S12: FIN

// MOD-005-S13: FORMULARIO SUBMIT [INICIO]
function handleSubmitClase(event) {
  event.preventDefault();

  const curso = document.getElementById('claseCurso').value.trim();
  const horaIni = document.getElementById('claseHoraIni').value.trim();
  const horaFin = document.getElementById('claseHoraFin').value.trim();
  const dia = document.getElementById('claseDia').value;
  const esEdicion = document.getElementById('claseModoEdicion').value === 'true';
  const rowNumber = document.getElementById('claseRowNumber').value;

  if (!curso || !horaIni || !horaFin) {
    if (window.showAlert) {
      showAlert('error', 'Completa todos los campos');
    } else {
      alert('Completa todos los campos');
    }
    return false;
  }

  if (horaIni >= horaFin) {
    if (window.showAlert) {
      showAlert('error', 'La hora de fin debe ser mayor a la de inicio');
    } else {
      alert('La hora de fin debe ser mayor a la de inicio');
    }
    return false;
  }

  const solapamientos = verificarSolapamiento(dia, horaIni, horaFin, rowNumber ? parseInt(rowNumber) : null);
  
  if (solapamientos.length > 0) {
    const mensaje = `⚠️ Ya existe ${solapamientos.join(', ')} en este horario.\n\n¿Crear solapamiento de todos modos?`;
    
    if (!confirm(mensaje)) {
      return false;
    }
  }

  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = true;
  btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';

  const params = {
    codeAlum: currentUser.codeAlum,
    curso: curso,
    horaIni: horaIni,
    horaFin: horaFin,
    detalle: dia
  };

  if (esEdicion) {
    if (rowNumber) {
      params.rowNumber = parseInt(rowNumber);
    }

    google.script.run
      .withSuccessHandler(r => handleClaseGuardada(r, true))
      .withFailureHandler(e => handleClaseError(e, true))
      .studentActualizarHorarioClase(params);
  } else {
    google.script.run
      .withSuccessHandler(r => handleClaseGuardada(r, false))
      .withFailureHandler(e => handleClaseError(e, false))
      .studentAgregarHorarioClase(params);
  }

  return false;
}

function handleClaseGuardada(response, esEdicion) {
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';

  if (response && response.success) {
    const msg = esEdicion ? '✔ Clase actualizada' : '✔ Clase agregada';
    if (window.showAlert) {
      showAlert('success', msg);
    } else {
      alert(msg);
    }
    cancelarFormClase();
    cargarHorarioClases();
  } else {
    const error = response ? response.error : 'Error desconocido';
    if (window.showAlert) {
      showAlert('error', error);
    } else {
      alert('Error: ' + error);
    }
  }
}

function handleClaseError(error, esEdicion) {
  console.error('🕐 Error:', error);
  
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  if (window.showAlert) {
    showAlert('error', 'Error de conexión. Intenta nuevamente');
  } else {
    alert('Error de conexión. Intenta nuevamente');
  }
}
// MOD-005-S13: FIN

// MOD-005-S14: FORMULARIO ELIMINAR [INICIO]
function confirmarEliminarClase() {
  const rowNumber = document.getElementById('claseRowNumber').value;

  if (!rowNumber) {
    if (window.showAlert) {
      showAlert('error', 'No se puede eliminar esta clase');
    } else {
      alert('No se puede eliminar esta clase');
    }
    return;
  }

  if (confirm('¿Eliminar esta clase del horario?\n\nEsta acción no se puede deshacer.')) {
    eliminarClase(parseInt(rowNumber));
  }
}

function eliminarClase(rowNumber) {
  google.script.run
    .withSuccessHandler(handleClaseEliminada)
    .withFailureHandler(e => {
      console.error('🕐 Error al eliminar:', e);
      if (window.showAlert) {
        showAlert('error', 'Error al eliminar');
      } else {
        alert('Error al eliminar');
      }
    })
    .studentEliminarHorarioClase({ rowNumber: rowNumber });
}

function handleClaseEliminada(response) {
  if (response && response.success) {
    if (window.showAlert) {
      showAlert('success', '✔ Clase eliminada');
    } else {
      alert('Clase eliminada');
    }
    cancelarFormClase();
    cargarHorarioClases();
  } else {
    const error = response ? response.error : 'Error desconocido';
    if (window.showAlert) {
      showAlert('error', error);
    } else {
      alert('Error: ' + error);
    }
  }
}
// MOD-005-S14: FIN

// MOD-005-S15: FORMULARIO HELPERS [INICIO]
function resetFormClase() {
  const form = document.getElementById('claseForm');
  if (form) form.reset();
  
  document.getElementById('claseRowNumber').value = '';
  document.getElementById('claseModoEdicion').value = 'false';
  document.getElementById('claseDia').value = '';
  document.getElementById('claseHoraSlot').value = '';
}

function cancelarFormClase() {
  const formDiv = document.getElementById('formClase');
  if (formDiv) formDiv.classList.remove('active');
  resetFormClase();
}
// MOD-005-S15: FIN

// MOD-005-S16: FORMATEO [INICIO]
function formatearHora12(h) {
  if (h === 12) return '12 PM';
  if (h > 12) return (h - 12) + ' PM';
  if (h === 0) return '12 AM';
  return h + ' AM';
}

function formatearHora12Desde24(hora24Str) {
  const [h] = hora24Str.split(':').map(Number);
  return formatearHora12(h);
}
// MOD-005-S16: FIN

// MOD-005-S17: EXPOSICIÓN GLOBAL Y ARRANQUE [INICIO]
window.hcClickCelda = clickCelda;
window.hcAbrirFormularioAgregar = abrirFormularioAgregar;
window.hcEditarClase = editarClase;
window.hcMostrarSeleccionClase = mostrarSeleccionClase;
window.hcCerrarModalSeleccion = cerrarModalSeleccion;
window.hcHandleSubmitClase = handleSubmitClase;
window.hcConfirmarEliminarClase = confirmarEliminarClase;
window.hcCancelarFormClase = cancelarFormClase;

setTimeout(function() {
  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    console.log('🕐 currentUser detectado, inicializando...');
    init();
  } else {
    console.log('🕐 currentUser no disponible, iniciando retry...');
    init();
  }
}, 150);

window.HorarioClaseModule = {
  init: init,
  clickCelda: clickCelda,
  abrirFormularioAgregar: abrirFormularioAgregar,
  editarClase: editarClase,
  mostrarSeleccionClase: mostrarSeleccionClase,
  guardarClase: handleSubmitClase,
  eliminarClase: confirmarEliminarClase,
  cancelar: cancelarFormClase
};

console.log('%c🕐 HorarioClaseModule V01.26 CODEWORKSHOP cargado',
  'font-size:11px;color:#667eea;font-weight:bold');
// MOD-005-S17: FIN

})();

</script>
<!-- MOD-005: FIN -->

<!-- MOD-006: CIERRE [INICIO] -->
  </body>
</html>
<!-- MOD-006: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Grid visual semanal 7×16 (7 AM-10 PM) para gestión de horario de clases fijas.
Validación de conflictos con colores personalizados por curso.

FUNCIONALIDAD:
- Click celda vacía → Agregar clase
- Click celda ocupada → Editar/Eliminar
- Modal de selección para múltiples clases solapadas
- Prefijos "/" para medias horas (ej: /HIST inicio 11:30)
- Validación y confirmación de solapamientos

DEPENDENCIAS BACKEND:
- studentObtenerCursos()
- studentObtenerHorarioClases()
- studentAgregarHorarioClase()
- studentActualizarHorarioClase()
- studentEliminarHorarioClase()

ESTRUCTURA:
MOD-001: Encabezado
MOD-002: Apertura HTML
MOD-003: Estilos CSS
MOD-004: Estructura HTML
MOD-005: JavaScript (17 submódulos S01-S17)
MOD-006: Cierre HTML
MOD-007: Notas

CAMBIOS V01.25 → V01.26:
- Remodulación según estándar CodeWorkShop v4.0
- MOD-005 con 17 submódulos JavaScript
- Delimitadores correctos (//) dentro de <script>
- Fix: Carga de cursos antes que horario (race condition)
- Prefijo 'hc' en funciones globales
- Aislamiento CSS (.hc-) y JS (window.hc*)

AISLAMIENTO:
- Prefijo CSS: .hc-*
- Prefijo JS: window.hc*
- IIFE con 'use strict'
- Sin conflicto con otros módulos
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 23/24: 7ctabhorariosem.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/7ctabhorariosem.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 7ctabhorariosem.html
VERSIÓN: 01.47
FECHA: 25/01/2026 09:52 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: CSS 1 ESTRUCTURA Y NAVEGACIÓN [INICIO] -->
<style>

/* MOD-002-S01: VARIABLES CSS [INICIO] */
:root {
  --hs-primary: #667eea;
  --hs-secondary: #764ba2;
  --hs-success: #28a745;
  --hs-danger: #dc3545;
  --hs-warning: #ffc107;
  --hs-info: #17a2b8;
  --hs-light: #f8f9fa;
  --hs-dark: #343a40;
  --hs-border: #e0e0e0;
  --hs-hover: #f5f7fa;
  --hs-shadow: rgba(0, 0, 0, 0.1);
  --hs-radius: 8px;
  --hs-transition: 0.2s ease;
}
/* MOD-002-S01: FIN */

/* MOD-002-S02: RESET Y BASE [INICIO] */
.hs-container {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  color: #333;
  background: #ffffff;
  min-height: 500px;
  position: relative;
}

.hs-container * {
  box-sizing: border-box;
}

.hs-container button {
  cursor: pointer;
  font-family: inherit;
  border: none;
  outline: none;
}

.hs-container input,
.hs-container select,
.hs-container textarea {
  font-family: inherit;
  font-size: 14px;
}
/* MOD-002-S02: FIN */

/* MOD-002-S03: CONTENEDOR PRINCIPAL [INICIO] */
.hs-container {
  display: flex;
  flex-direction: column;
  gap: 0;
  padding: 20px;
  max-width: 100%;
  margin: 0 auto;
}
/* MOD-002-S03: FIN */

/* MOD-002-S04: HEADER V2 [INICIO] */
.hs-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 0;
  border-bottom: 2px solid var(--hs-border);
  margin-bottom: 20px;
}

.hs-header-left {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.hs-header-left h2 {
  margin: 0;
  font-size: 24px;
  font-weight: 600;
  color: #333;
}

.hs-header-right {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
/* MOD-002-S04: FIN */

/* MOD-002-S05: INFO SEMANA [INICIO] */
.hs-semana-info {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: #666;
}

.hs-semana-info span {
  display: inline-block;
}

.hs-separador {
  color: #ccc;
  font-weight: 300;
}

#hs-semana-texto {
  font-weight: 600;
  color: var(--hs-primary);
}

#hs-fecha-rango {
  color: #666;
}
/* MOD-002-S05: FIN */

/* MOD-002-S06: BOTÓN CONFIG [INICIO] */
.hs-btn-config {
  background: linear-gradient(135deg, var(--hs-primary) 0%, var(--hs-secondary) 100%);
  color: white;
  padding: 10px 20px;
  border-radius: var(--hs-radius);
  font-size: 14px;
  font-weight: 500;
  transition: all var(--hs-transition);
  box-shadow: 0 2px 4px var(--hs-shadow);
}

.hs-btn-config:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

.hs-btn-config:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px var(--hs-shadow);
}
/* MOD-002-S06: FIN */

/* MOD-002-S07: CONTENT LAYOUT [INICIO] */
.hs-content {
  display: flex;
  gap: 20px;
  min-height: 600px;
}
/* MOD-002-S07: FIN */

/* MOD-002-S08: SIDEBAR [INICIO] */
.hs-sidebar {
  width: 200px;
  flex-shrink: 0;
  background: var(--hs-light);
  border-radius: var(--hs-radius);
  padding: 15px;
  height: fit-content;
}

.hs-semanas-lista {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.hs-semanas-lista p {
  margin: 0;
  padding: 10px;
  text-align: center;
  color: #999;
  font-size: 13px;
}
/* MOD-002-S08: FIN */

/* MOD-002-S09: BOTONES SEMANA [INICIO] */
.hs-semana-btn {
  background: white;
  border: 2px solid var(--hs-border);
  padding: 10px 15px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  color: #555;
  transition: all var(--hs-transition);
  text-align: center;
}

.hs-semana-btn:hover {
  background: var(--hs-hover);
  border-color: var(--hs-primary);
  color: var(--hs-primary);
}

.hs-semana-btn.active {
  background: var(--hs-primary);
  border-color: var(--hs-primary);
  color: white;
  font-weight: 600;
}

.hs-semana-btn.active:hover {
  background: var(--hs-secondary);
  border-color: var(--hs-secondary);
}
/* MOD-002-S09: FIN */

/* MOD-002-S10: MAIN AREA [INICIO] */
.hs-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 15px;
}
/* MOD-002-S10: FIN */

/* MOD-002-S11: ACTIONS TOOLBAR [INICIO] */
.hs-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-start;
  align-items: center;
  flex-wrap: wrap;
}
/* MOD-002-S11: FIN */

/* MOD-002-S12: BOTONES ACCIÓN [INICIO] */
.hs-btn-action {
  background: white;
  border: 2px solid var(--hs-border);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  color: #555;
  transition: all var(--hs-transition);
  white-space: nowrap;
}

.hs-btn-action:hover {
  background: var(--hs-hover);
  border-color: var(--hs-primary);
  color: var(--hs-primary);
  transform: translateY(-1px);
  box-shadow: 0 2px 4px var(--hs-shadow);
}

.hs-btn-action:active {
  transform: translateY(0);
  box-shadow: none;
}
/* MOD-002-S12: FIN */

</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CSS 2 GRID Y MODALES [INICIO] -->
<style>

/* MOD-003-S01: GRID CONTAINER [INICIO] */
.hs-grid-container {
  background: white;
  border-radius: var(--hs-radius);
  padding: 20px;
  overflow-x: auto;
  position: relative;
}
/* MOD-003-S01: FIN */

/* MOD-003-S02: GRID TABLE [INICIO] */
.hs-grid {
  width: 100%;
  border-collapse: collapse;
  background: white;
  box-shadow: 0 2px 8px var(--hs-shadow);
  border-radius: var(--hs-radius);
  overflow: hidden;
}

.hs-grid thead {
  background: linear-gradient(135deg, var(--hs-primary) 0%, var(--hs-secondary) 100%);
  color: white;
}

.hs-grid th {
  padding: 12px 8px;
  text-align: center;
  font-weight: 600;
  font-size: 13px;
  border-right: 1px solid rgba(255, 255, 255, 0.2);
}

.hs-grid th:last-child {
  border-right: none;
}

.hs-grid tbody tr {
  border-bottom: 1px solid var(--hs-border);
}

.hs-grid tbody tr:last-child {
  border-bottom: none;
}

.hs-grid tbody tr:hover {
  background: var(--hs-hover);
}

.hs-grid td {
  padding: 0;
  border-right: 1px solid var(--hs-border);
  vertical-align: top;
}

.hs-grid td:last-child {
  border-right: none;
}

.hs-col-hora {
  width: 80px;
  font-size: 12px;
  font-weight: 600;
  color: #666;
  text-align: center;
  background: #fafafa;
  padding: 8px 5px !important;
}

.hs-col-dia {
  min-width: 100px;
  font-size: 12px;
  line-height: 1.4;
}
/* MOD-003-S02: FIN */

/* MOD-003-S03: CELDAS GRID [INICIO] */
.hs-celda {
  min-height: 50px;
  padding: 8px;
  font-size: 12px;
  font-weight: 500;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: all var(--hs-transition);
  cursor: pointer;
  color: white;
}

.hs-celda:not(.ocupada) {
  background: transparent;
  color: #999;
  border: 1px dashed transparent;
}

.hs-celda:not(.ocupada):hover {
  background: var(--hs-hover);
  border-color: var(--hs-primary);
  color: var(--hs-primary);
}

.hs-celda.ocupada {
  background: var(--hs-info);
  color: white;
  font-weight: 600;
  box-shadow: 0 2px 4px var(--hs-shadow);
}

.hs-celda.ocupada:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  z-index: 10;
}
/* MOD-003-S03: FIN */

/* MOD-003-S04: CLASES FIJAS [INICIO] */
.hs-celda.clase-fija {
  background: #95a5a6;
  cursor: default;
  opacity: 0.85;
}

.hs-celda.clase-fija:hover {
  transform: none;
  box-shadow: 0 2px 4px var(--hs-shadow);
  opacity: 1;
}
/* MOD-003-S04: FIN */

/* MOD-003-S05: MODALES BASE [INICIO] */
.hs-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(2px);
}

.hs-modal.active {
  display: flex;
}

.hs-modal-content {
  background: white;
  border-radius: 12px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
/* MOD-003-S05: FIN */

/* MOD-003-S06: MODAL CONTENT [INICIO] */
.hs-modal-content h3 {
  margin: 0 0 20px 0;
  font-size: 20px;
  font-weight: 600;
  color: #333;
}

.hs-modal-content p {
  margin: 0 0 15px 0;
  line-height: 1.6;
  color: #555;
}

.hs-modal-content small {
  display: block;
  margin-top: 5px;
  color: #666;
  font-size: 12px;
}
/* MOD-003-S06: FIN */

/* MOD-003-S07: FORMULARIOS [INICIO] */
.hs-form-group {
  margin-bottom: 20px;
}

.hs-form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  font-size: 14px;
  color: #333;
}

.hs-form-group input[type="text"],
.hs-form-group input[type="date"],
.hs-form-group input[type="time"],
.hs-form-group input[type="number"],
.hs-form-group select,
.hs-form-group textarea {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid var(--hs-border);
  border-radius: 6px;
  font-size: 14px;
  transition: all var(--hs-transition);
  background: white;
}

.hs-form-group input:focus,
.hs-form-group select:focus,
.hs-form-group textarea:focus {
  outline: none;
  border-color: var(--hs-primary);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.hs-form-group input::placeholder {
  color: #999;
}

.hs-form-group select {
  cursor: pointer;
}

.hs-form-group textarea {
  resize: vertical;
  min-height: 80px;
}
/* MOD-003-S07: FIN */

/* MOD-003-S08: MODAL ACTIONS [INICIO] */
.hs-modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 25px;
  padding-top: 20px;
  border-top: 1px solid var(--hs-border);
}

.hs-btn {
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--hs-transition);
  border: none;
}

.hs-btn-primary {
  background: linear-gradient(135deg, var(--hs-primary) 0%, var(--hs-secondary) 100%);
  color: white;
}

.hs-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.hs-btn-secondary {
  background: #f5f5f5;
  color: #666;
  border: 2px solid var(--hs-border);
}

.hs-btn-secondary:hover {
  background: white;
  border-color: #999;
  color: #333;
}

.hs-btn-danger {
  background: var(--hs-danger);
  color: white;
}

.hs-btn-danger:hover {
  background: #c82333;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
}

.hs-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
}
/* MOD-003-S08: FIN */

/* MOD-003-S09: LOADING [INICIO] */
.hs-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  border-radius: var(--hs-radius);
}

.hs-loading p {
  margin-top: 15px;
  color: #666;
  font-size: 14px;
  font-weight: 500;
}

.hs-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid var(--hs-border);
  border-top-color: var(--hs-primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
/* MOD-003-S09: FIN */

/* MOD-003-S10: DEBERES GRID [INICIO] */
.hs-deberes-container {
  margin-top: 30px;
  padding-top: 20px;
  border-top: 2px solid var(--hs-border);
}

.hs-deberes-titulo {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.hs-deberes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.hs-deber-card {
  background: var(--hs-light);
  border-left: 4px solid var(--hs-primary);
  padding: 12px 15px;
  border-radius: 6px;
  cursor: pointer;
  transition: all var(--hs-transition);
  box-shadow: 0 1px 3px var(--hs-shadow);
}

.hs-deber-card:hover {
  background: white;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  transform: translateY(-2px);
}

.hs-deber-card.evaluacion {
  border-left-color: #e74c3c;
}

.hs-deber-card.tarea {
  border-left-color: #3498db;
}

.hs-deber-card.lectura {
  border-left-color: #2ecc71;
}

.hs-deber-curso {
  font-weight: 600;
  font-size: 14px;
  color: #333;
  margin-bottom: 4px;
}

.hs-deber-tipo {
  font-size: 12px;
  color: #666;
  text-transform: capitalize;
}

.hs-deberes-empty {
  text-align: center;
  padding: 30px;
  color: #999;
  font-size: 14px;
}
/* MOD-003-S10: FIN */

/* MOD-003-S11: MODAL DEBER [INICIO] */
.hs-modal-deber {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.hs-modal-deber.active {
  display: flex;
}

.hs-modal-deber-content {
  background: white;
  border-radius: 12px;
  padding: 25px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: modalFadeIn 0.3s ease;
}

.hs-modal-deber-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
}

.hs-modal-deber-header h3 {
  margin: 0;
  font-size: 18px;
  color: #333;
}

.hs-modal-deber-close {
  background: none;
  border: none;
  font-size: 28px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color var(--hs-transition);
  line-height: 1;
}

.hs-modal-deber-close:hover {
  color: #333;
}

.hs-modal-deber-body {
  font-size: 14px;
  color: #555;
}

.hs-deber-detalle-row {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #f0f0f0;
}

.hs-deber-detalle-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.hs-deber-detalle-label {
  font-weight: 600;
  color: var(--hs-primary);
  margin-bottom: 5px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.hs-deber-detalle-valor {
  color: #333;
  font-size: 15px;
}
/* MOD-003-S11: FIN */

/* MOD-003-S12: RESPONSIVE [INICIO] */
@media (max-width: 1024px) {
  .hs-content {
    flex-direction: column;
  }
  
  .hs-sidebar {
    width: 100%;
    margin-bottom: 20px;
  }
  
  .hs-semanas-lista {
    flex-direction: row;
    overflow-x: auto;
    padding-bottom: 10px;
  }
  
  .hs-semana-btn {
    min-width: 120px;
  }
}

@media (max-width: 768px) {
  .hs-container {
    padding: 15px;
  }
  
  .hs-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .hs-header-right {
    width: 100%;
    justify-content: flex-start;
  }
  
  .hs-btn-config {
    width: 100%;
  }
  
  .hs-actions {
    flex-direction: column;
    width: 100%;
  }
  
  .hs-btn-action {
    width: 100%;
    justify-content: center;
  }
  
  .hs-grid-container {
    padding: 10px;
    overflow-x: scroll;
  }
  
  .hs-grid {
    font-size: 11px;
  }
  
  .hs-col-hora {
    font-size: 10px;
    padding: 5px 3px !important;
  }
  
  .hs-celda {
    font-size: 10px;
    padding: 5px;
    min-height: 40px;
  }
  
  .hs-deberes-grid {
    grid-template-columns: 1fr;
  }
  
  .hs-modal-content {
    width: 95%;
    padding: 20px;
  }
  
  .hs-modal-deber-content {
    width: 95%;
    padding: 20px;
  }
  
  .hs-modal-actions {
    flex-direction: column;
  }
  
  .hs-btn {
    width: 100%;
  }
}

@media (max-width: 480px) {
  .hs-header-left h2 {
    font-size: 20px;
  }
  
  .hs-semana-info {
    font-size: 12px;
  }
  
  .hs-grid {
    font-size: 10px;
  }
  
  .hs-modal-content h3 {
    font-size: 18px;
  }
}
/* MOD-003-S12: FIN */

</style>
<!-- MOD-003: FIN -->

<!-- MOD-004: CONTENEDOR PRINCIPAL V3 [INICIO] -->
<div class="hs-container">
  <div class="hs-header">
    <div class="hs-header-left">
      <h2>📅 Horario Semanal</h2>
      <div class="hs-semana-info">
        <span id="hs-semana-texto">Semana 1</span>
        <span class="hs-separador">|</span>
        <span id="hs-fecha-rango">Cargando...</span>
      </div>
    </div>
    
    <div class="hs-header-right">
      <button class="hs-btn-action" onclick="window.hsNavegar(-1)">← Ant.</button>
      <button class="hs-btn-action" onclick="window.hsNavegar(1)">Sig. →</button>
      <button class="hs-btn-action" onclick="window.hsCopiarSemanaAnterior()">Copiar</button>
      <button class="hs-btn-action" onclick="window.hsLimpiarSemana()">Limpiar</button>
      <button class="hs-btn-config" onclick="window.hsAbrirConfigSemana()" title="Configurar fechas de inicio y fin de clases">📅 Fechas</button>
    </div>
  </div>
  
  <div class="hs-content">
    <div class="hs-sidebar">
      <div class="hs-semanas-lista" id="hs-semanas-lista">
        <!-- Botones de semanas se generan dinámicamente -->
      </div>
    </div>
    
    <div class="hs-main">
      <div class="hs-grid-container">
        <div class="hs-loading" id="loadingHS">
          <div class="hs-spinner"></div>
          <p>Cargando horario...</p>
        </div>
        <div id="hsGridContainer"></div>
        
        <!-- Grid de Deberes -->
        <div id="hsDeberesContainer"></div>
      </div>
    </div>
  </div>
</div>
<!-- MOD-004: FIN -->

<!-- MOD-005: MODALES Y FORMULARIOS V2 [INICIO] -->

<!-- MODAL: Configurar Fechas de Inicio y Fin -->
<div id="modalConfigSemana" class="hs-modal">
  <div class="hs-modal-content">
    <h3>Fechas de Inicio y Fin de clases</h3>
    
    <form id="formConfigSemana" onsubmit="return window.hsHandleConfigSemana(event)">
      <div class="hs-form-group">
        <label>Fecha de inicio de clases:</label>
        <input type="date" id="configFechaInicio" required>
        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
          Puede ser cualquier día de la semana. El sistema ajustará al lunes correspondiente.
        </small>
      </div>
      
      <div class="hs-form-group">
        <label>Fecha de fin de clases:</label>
        <input type="date" id="configFechaFin" required>
        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
          Todas las semanas se generarán automáticamente entre estas fechas.
        </small>
      </div>
      
      <div class="hs-modal-actions">
        <button type="button" class="hs-btn hs-btn-secondary" onclick="window.hsCerrarConfigSemana()">Cancelar</button>
        <button type="submit" class="hs-btn hs-btn-primary">Guardar y Generar Semanas</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Actividad -->
<div id="modalActividad" class="hs-modal">
  <div class="hs-modal-content">
    <h3 id="actividadFormTitle">Agregar Actividad</h3>

    <form id="formActividad" onsubmit="return window.hsHandleSubmitActividad(event)">
      <input type="hidden" id="actividadRowNumber">
      <input type="hidden" id="actividadModoEdicion" value="false">
      <input type="hidden" id="actividadFecha">
      <input type="hidden" id="actividadSem">

      <div class="hs-form-group">
        <label>Tipo de Actividad:</label>
        <select id="actividadTipo" required>
          <option value="">Seleccionar...</option>
          <option value="Estudio">Estudio</option>
          <option value="Repaso">Repaso</option>
          <option value="Tarea">Tarea</option>
          <option value="Proyecto">Proyecto</option>
          <option value="Lectura">Lectura</option>
          <option value="Personal">Personal</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="hs-form-group">
        <label>Nombre:</label>
        <input type="text" id="actividadNombre" required placeholder="Ej: Estudio FIS">
      </div>

      <div class="hs-form-group">
        <label>Hora Inicio:</label>
        <input type="time" id="actividadHoraIni" required>
      </div>

      <div class="hs-form-group">
        <label>Hora Fin:</label>
        <input type="time" id="actividadHoraFin" required>
      </div>

      <div class="hs-form-group">
        <label>Color:</label>
        <select id="actividadColor">
          <option value="#17a2b8">Azul claro</option>
          <option value="#007bff">Azul</option>
          <option value="#28a745">Verde</option>
          <option value="#ffc107">Amarillo</option>
          <option value="#fd7e14">Naranja</option>
          <option value="#dc3545">Rojo</option>
          <option value="#6f42c1">Púrpura</option>
          <option value="#6c757d">Gris</option>
        </select>
      </div>

      <div class="hs-modal-actions">
        <button type="button" class="hs-btn hs-btn-secondary" onclick="window.hsCerrarModalActividad()">Cancelar</button>
        <button type="button" class="hs-btn hs-btn-danger" id="btnEliminarActividad" style="display:none" onclick="window.hsConfirmarEliminarActividad()">Eliminar</button>
        <button type="submit" class="hs-btn hs-btn-primary" id="btnSubmitActividad">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Confirmación -->
<div id="modalConfirmacion" class="hs-modal">
  <div class="hs-modal-content" style="max-width: 420px;">
    <h3 id="confirmacionTitulo" style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <span style="font-size: 32px;">⚠️</span>
      <span>Confirmación</span>
    </h3>

    <p id="confirmacionMensaje" style="font-size: 15px; line-height: 1.6; color: #555; margin-bottom: 24px;">
      ¿Estás seguro?
    </p>

    <div class="hs-modal-actions">
      <button type="button" class="hs-btn hs-btn-secondary" onclick="window.hsCerrarModalConfirmacion()">Cancelar</button>
      <button type="button" class="hs-btn hs-btn-primary" id="btnConfirmarAccion">Confirmar</button>
    </div>
  </div>
</div>

<!-- MODAL: Detalle Deber -->
<div id="modalDetalleDeber" class="hs-modal-deber">
  <div class="hs-modal-deber-content">
    <div class="hs-modal-deber-header">
      <h3>Detalle del Deber</h3>
      <button class="hs-modal-deber-close" onclick="window.hsCerrarModalDeber()">×</button>
    </div>
    <div id="modalDeberBody" class="hs-modal-deber-body">
      <!-- Contenido dinámico -->
    </div>
  </div>
</div>

<!-- MOD-005: FIN -->

<!-- MOD-006: JAVA SCRIPT [INICIO] -->
<script>

// MOD-006-S01: ENCAPSULAMIENTO IIFE [INICIO]
(function () {
'use strict';

if (window.HorarioSemanalModule) {
  console.log('📅 HorarioSemanalModule ya existe, ignorando carga');
  return;
}

console.log('📅 HorarioSemanalModule V01.39 CODEWORKSHOP iniciando...');
// MOD-006-S01: FIN

// MOD-006-S02: VARIABLES GLOBALES V2 [INICIO]
let semanaActual = 1;
let configSemana = null;
let todasSemanas = [];
let cursos = [];
let horarioClases = [];
let actividadesSem = [];
let fechaFinClases = null;
let cursosData = [];
let clasesData = [];
let actividadesData = [];
let horarioMatrix = {};
// MOD-006-S02: FIN

// MOD-006-S03: CONSTANTES V2 [INICIO]
const HORA_INICIO = 7;
const HORA_FIN = 22;
const DIAS = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
const DIAS_CORTOS = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
let _initDone = false;
let _retryCount = 0;
const MAX_RETRIES = 5;
// MOD-006-S03: FIN

// MOD-006-S04: INICIALIZACIÓN [INICIO]
function init() {
  console.log('📅 HorarioSemanalModule.init() llamado (intento ' + (_retryCount + 1) + ')');
  
  if (_initDone) {
    console.log('📅 Ya inicializado, ignorando');
    return;
  }
  
  if (!window.currentUser || !currentUser.codeAlum) {
    console.warn('📅 currentUser no disponible, reintentando...');
    
    if (_retryCount < MAX_RETRIES) {
      _retryCount++;
      setTimeout(init, 200);
    } else {
      console.error('📅 currentUser no disponible después de ' + MAX_RETRIES + ' intentos');
      ocultarLoading();
    }
    return;
  }
  
  _initDone = true;
  console.log('📅 Inicializado para:', currentUser.codeAlum);
  
  cargarConfigSemana();
  cargarSemanas();
}
// MOD-006-S04: FIN

// MOD-006-S05: CARGA CONFIG SEMANA V2 [INICIO]
function cargarConfigSemana() {
  console.log('📅 Cargando configuración de semana...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('📅 Config response:', r);
      
      if (r && r.success && r.data && r.data.FechaInicio) {
        configSemana = r.data;
        console.log('📅 FechaInicio:', configSemana.FechaInicio);
        
        if (configSemana.FechaFin) {
          fechaFinClases = configSemana.FechaFin;
          console.log('📅 FechaFin:', fechaFinClases);
        }
        
        cargarCursos();
        cargarHorarioClases();
        cargarHorarioSem();
      } else {
        console.log('📅 Sin configuración, mostrar modal');
        ocultarLoading();
        abrirConfigSemana();
      }
    })
    .withFailureHandler(e => {
      console.error('📅 Error al cargar config:', e);
      ocultarLoading();
      mostrarNotificacion('error', 'Error al cargar configuración');
    })
    .studentObtenerConfigSemana({ codeAlum: currentUser.codeAlum });
}
// MOD-006-S05: FIN

// MOD-006-S06: CARGA SEMANAS V2 [INICIO]
function cargarSemanas() {
  console.log('📅 Cargando semanas...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('📅 Semanas response:', r);
      
      if (r && r.success && r.data && r.data.length > 0) {
        todasSemanas = r.data;
        console.log('📅 Total semanas cargadas:', todasSemanas.length);
        renderizarBotonesSemanas();
        actualizarInfoSemana();
      } else {
        console.log('📅 Sin semanas registradas');
        todasSemanas = [];
        renderizarBotonesSemanas();
      }
    })
    .withFailureHandler(e => {
      console.error('📅 Error al cargar semanas:', e);
      mostrarNotificacion('error', 'Error al cargar semanas');
    })
    .studentObtenerSemanas(currentUser.codeAlum);
}

function renderizarBotonesSemanas() {
  const container = document.getElementById('hs-semanas-lista');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (todasSemanas.length === 0) {
    container.innerHTML = '<p style="padding:10px;color:#999;font-size:13px;text-align:center;">No hay semanas configuradas</p>';
    return;
  }
  
  todasSemanas.forEach(sem => {
    const btn = document.createElement('button');
    btn.className = 'hs-semana-btn';
    btn.textContent = `Semana ${sem.Semana}`;
    btn.onclick = () => irASemana(sem.Semana);
    
    if (sem.Semana === semanaActual) {
      btn.classList.add('active');
    }
    
    container.appendChild(btn);
  });
  
  console.log('✅ Botones de semanas renderizados:', todasSemanas.length);
}
// MOD-006-S06: FIN

// MOD-006-S07: NAVEGACIÓN SEMANAS [INICIO]
function navegar(direccion) {
  const nuevaSemana = semanaActual + direccion;
  
  console.log('🔄 Navegando:', {
    actual: semanaActual,
    direccion: direccion,
    nueva: nuevaSemana,
    totalSemanas: todasSemanas.length
  });
  
  const semanaExiste = todasSemanas.find(s => s.Semana === nuevaSemana);
  
  if (!semanaExiste) {
    const mensaje = direccion > 0 ? 'No hay siguiente semana' : 'No hay semana anterior';
    mostrarNotificacion('info', mensaje);
    return;
  }
  
  irASemana(nuevaSemana);
}

function irASemana(numSemana) {
  console.log('📍 Ir a semana:', numSemana);
  
  const semana = todasSemanas.find(s => s.Semana === numSemana);
  
  if (!semana) {
    mostrarNotificacion('error', 'Semana no encontrada');
    return;
  }
  
  semanaActual = numSemana;
  
  actualizarInfoSemana();
  actualizarBotonesSemanas();
  cargarHorarioSem();
}

function actualizarBotonesSemanas() {
  const botones = document.querySelectorAll('.hs-semana-btn');
  botones.forEach(btn => {
    const numSemana = parseInt(btn.textContent.replace('Semana ', ''));
    if (numSemana === semanaActual) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
}
// MOD-006-S07: FIN

// MOD-006-S08: RENDER LISTA SEMANAS [INICIO]
function renderListaSemanas() {
  const lista = document.getElementById('hsSemanasList');
  if (!lista) return;
  
  let html = '';
  
  if (semanasData.length > 0) {
    semanasData.forEach(sem => {
      const numSem = parseInt(sem.Semana);
      const activeClass = numSem === semanaActual ? 'active' : '';
      html += `
        <div class="hs-semana-item ${activeClass}" onclick="window.hsCambiarSemana(${numSem})">
          Semana ${numSem}
        </div>
      `;
    });
  } else {
    for (let i = 1; i <= semanaActual; i++) {
      const activeClass = i === semanaActual ? 'active' : '';
      html += `
        <div class="hs-semana-item ${activeClass}" onclick="window.hsCambiarSemana(${i})">
          Semana ${i}
        </div>
      `;
    }
  }
  
  lista.innerHTML = html;
}
// MOD-006-S08: FIN

// MOD-006-S09: ACTUALIZAR INFO SEMANA V2 [INICIO]
function actualizarInfoSemana() {
  // Actualizar número de semana
  const semanaTexto = document.getElementById('hs-semana-texto');
  if (semanaTexto) {
    semanaTexto.textContent = `Semana ${semanaActual}`;
  }
  
  // Actualizar rango de fechas
  const fechaRango = document.getElementById('hs-fecha-rango');
  if (!fechaRango) {
    console.warn('⚠️ Elemento #hs-fecha-rango no encontrado');
    return;
  }
  
  const fechas = calcularFechasSemana(semanaActual);
  const fechaIni = formatearFechaCorta(fechas.lunes);
  const fechaFin = formatearFechaCorta(fechas.domingo);
  
  fechaRango.textContent = `${fechaIni} - ${fechaFin}`;
  
  console.log('📅 Info semana actualizada:', {
    semana: semanaActual,
    rango: `${fechaIni} - ${fechaFin}`
  });
}
// MOD-006-S09: FIN

// MOD-006-S10: CALCULAR FECHAS SEMANA V2 [INICIO]
function calcularFechasSemana(numSemana) {
  // Buscar la semana específica en todasSemanas
  const semana = todasSemanas.find(s => s.Semana === numSemana);
  
  if (semana && semana.FechaInicio && semana.FechaFin) {
    // Si existe la semana con sus fechas, usarlas directamente
    const lunes = parsearFechaDDMMAAAA(semana.FechaInicio);
    const domingo = parsearFechaDDMMAAAA(semana.FechaFin);
    
    const dias = [];
    for (let i = 0; i < 7; i++) {
      const dia = new Date(lunes);
      dia.setDate(dia.getDate() + i);
      dias.push(dia);
    }
    
    console.log('📅 Semana ' + numSemana + ' calculada desde BD:', {
      lunes: formatearFechaISO(lunes),
      domingo: formatearFechaISO(domingo)
    });
    
    return { lunes, domingo, dias };
  }
  
  // FALLBACK: Si no existe la semana, calcular desde configSemana
  if (!configSemana || !configSemana.FechaInicio) {
    console.error('📅 No hay configuración de semana disponible');
    const hoy = new Date();
    return { lunes: hoy, domingo: hoy, dias: [hoy] };
  }
  
  const fechaInicio = parsearFechaDDMMAAAA(configSemana.FechaInicio);
  fechaInicio.setHours(0, 0, 0, 0);
  
  const diaSemana = fechaInicio.getDay();
  const diasHastaLunes = diaSemana === 0 ? 6 : diaSemana - 1;
  
  const lunes = new Date(fechaInicio);
  lunes.setDate(lunes.getDate() - diasHastaLunes);
  lunes.setDate(lunes.getDate() + ((numSemana - 1) * 7));
  
  const domingo = new Date(lunes);
  domingo.setDate(domingo.getDate() + 6);
  
  const dias = [];
  for (let i = 0; i < 7; i++) {
    const dia = new Date(lunes);
    dia.setDate(dia.getDate() + i);
    dias.push(dia);
  }
  
  console.log('📅 Semana ' + numSemana + ' calculada (fallback):', {
    lunes: formatearFechaISO(lunes),
    domingo: formatearFechaISO(domingo)
  });
  
  return { lunes, domingo, dias };
}
// MOD-006-S10: FIN

// MOD-006-S11: CARGA DE CURSOS [INICIO]
function cargarCursos() {
  console.log('📅 Cargando cursos...');
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        cursosData = r.data || [];
        console.log('📅 Cursos cargados:', cursosData.length);
      }
    })
    .withFailureHandler(e => {
      console.error('📅 Error al cargar cursos:', e);
    })
    .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
}
// MOD-006-S11: FIN

// MOD-006-S12: CARGA HORARIO CLASES [INICIO]
function cargarHorarioClases() {
  console.log('📅 Cargando horario clases...');
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        clasesData = r.data || [];
        console.log('📅 Clases cargadas:', clasesData.length);
      }
    })
    .withFailureHandler(e => {
      console.error('📅 Error al cargar clases:', e);
    })
    .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
}
// MOD-006-S12: FIN

// MOD-006-S13: CARGA HORARIO SEMANAL [INICIO]
function cargarHorarioSem() {
  console.log('📅 Cargando horario semanal...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('📅 HorarioSem response:', r);
      
      if (r && r.success) {
        actividadesData = r.data || [];
        console.log('📅 Actividades cargadas:', actividadesData.length);
        
        construirMatriz();
        renderGrid();
        ocultarLoading();
      } else {
        console.error('📅 Error en response:', r);
        construirMatriz();
        renderGrid();
        ocultarLoading();
      }
    })
    .withFailureHandler(e => {
      console.error('📅 Error de conexión:', e);
      construirMatriz();
      renderGrid();
      ocultarLoading();
    })
    .studentObtenerHorarioSem({ codeAlum: currentUser.codeAlum });
}
// MOD-006-S13: FIN

// MOD-006-S14: CONSTRUCCIÓN DE MATRIZ [INICIO]
function construirMatriz() {
  console.log('📅 Construyendo matriz...');
  
  const fechas = calcularFechasSemana(semanaActual);
  
  horarioMatrix = {};
  fechas.dias.forEach(fecha => {
    const key = formatearFechaISO(fecha);
    horarioMatrix[key] = {};
  });
  
  clasesData.forEach(c => {
    const dia = extraerDia(c.Detalle);
    if (!dia) return;
    
    const diaIndex = DIAS.indexOf(dia);
    if (diaIndex === -1) return;
    
    const fechaDia = fechas.dias[diaIndex];
    const key = formatearFechaISO(fechaDia);
    
    const horas = calcularHoras(c.HoraIni, c.HoraFin);
    horas.forEach(h => {
      horarioMatrix[key][h.hora] = horarioMatrix[key][h.hora] || [];
      horarioMatrix[key][h.hora].push({
        tipo: 'clase',
        clase: c,
        ...h
      });
    });
  });
  
  actividadesData.forEach(act => {
    const fechaAct = act.FechaHS;
    if (!fechaAct) return;

    const fechaParsed = parsearFechaDDMMAAAA(fechaAct);
    if (isNaN(fechaParsed.getTime())) {
      console.warn('📅 Fecha inválida:', fechaAct);
      return;
    }

    const key = formatearFechaISO(fechaParsed);

    if (!horarioMatrix[key]) return;

    const horas = calcularHoras(act.HoraInicio, act.HoraFin);
    horas.forEach(h => {
      horarioMatrix[key][h.hora] = horarioMatrix[key][h.hora] || [];
      horarioMatrix[key][h.hora].push({
        tipo: 'actividad',
        actividad: act,
        ...h
      });
    });
  });
  
  console.log('📅 Matriz construida:', horarioMatrix);
}
// MOD-006-S14: FIN

// MOD-006-S15: HELPERS DE PROCESAMIENTO [INICIO]
function extraerDia(t) {
  if (!t) return null;
  const s = String(t).toLowerCase().trim();
  const diaEncontrado = DIAS.find(d => {
    const dLower = d.toLowerCase();
    return s.includes(dLower) || dLower.includes(s);
  });
  return diaEncontrado || null;
}

function calcularHoras(i, f) {
  const horaIniStr = normalizarHora(i);
  const horaFinStr = normalizarHora(f);
  
  if (!horaIniStr || !horaFinStr) {
    return [];
  }
  
  const [hi, mi] = horaIniStr.split(':').map(Number);
  const [hf, mf] = horaFinStr.split(':').map(Number);
  
  const res = [];
  
  for (let h = hi; h <= hf; h++) {
    if (h > HORA_FIN) break;
    if (h === hf && mf === 0) continue;
    
    res.push({
      hora: String(h).padStart(2, '0') + ':00',
      prefijo: (h === hi && mi >= 30) ? '/' : '',
      sufijo: (h === hf && mf > 0 && mf < 60) ? '/' : ''
    });
  }
  
  return res;
}

function normalizarHora(valor) {
  if (!valor) return null;
  
  if (typeof valor === 'string') {
    const match = valor.match(/(\d{1,2}):(\d{2})/);
    if (match) {
      const h = match[1].padStart(2, '0');
      const m = match[2];
      return h + ':' + m;
    }
  }
  
  if (typeof valor === 'object' && valor !== null) {
    if ('hour' in valor && 'minute' in valor) {
      const h = String(valor.hour).padStart(2, '0');
      const m = String(valor.minute).padStart(2, '0');
      return h + ':' + m;
    }
  }
  
  return null;
}

function colorCurso(curso) {
  const c = cursosData.find(x => x.Curso === curso);
  return c ? c.Color : '#667eea';
}
// MOD-006-S15: FIN

// MOD-006-S16: RENDERIZADO DE GRID [INICIO]
function renderGrid() {
  console.log('📅 Renderizando grid...');
  
  const container = document.querySelector('.hs-grid-container');
  if (!container) {
    console.error('📅 No se encontró hs-grid-container');
    return;
  }
  
  const loading = document.getElementById('loadingHS');
  if (loading) loading.remove();
  
  const c = document.getElementById('hsGridContainer');
  if (!c) return;
  
  const fechas = calcularFechasSemana(semanaActual);
  
  let html = '<table class="hs-grid"><thead><tr><th class="hs-col-hora">Hora</th>';
  
  fechas.dias.forEach((fecha, idx) => {
    const diaCorto = DIAS_CORTOS[idx];
    const fechaCorta = formatearFechaCorta(fecha);
    html += `<th class="hs-col-dia">${diaCorto}<br>${fechaCorta}</th>`;
  });
  
  html += '</tr></thead><tbody>';
  
  for (let h = HORA_INICIO; h <= HORA_FIN; h++) {
    const k = String(h).padStart(2, '0') + ':00';
    const horaFormato = formatearHora12(h);
    
    html += `<tr><td class="hs-col-hora">${horaFormato}</td>`;
    
    fechas.dias.forEach(fecha => {
      const key = formatearFechaISO(fecha);
      const items = horarioMatrix[key][k];
      
      if (items && items.length > 0) {
        const item = items[0];
        
        if (item.tipo === 'clase') {
          const color = colorCurso(item.clase.Curso);
          const texto = item.prefijo + item.clase.Curso + item.sufijo;
          
          html += `<td><div class="hs-celda ocupada clase-fija" style="background:${color}">
            ${texto}
          </div></td>`;
        } else {
          const act = item.actividad;
          const texto = item.prefijo + act.Actividad + item.sufijo;
          
          html += `<td><div class="hs-celda ocupada" 
            style="background:${act.Color}" 
            onclick="window.hsEditarActividad('${key}','${k}')">
            ${texto}
          </div></td>`;
        }
      } else {
        html += `<td><div class="hs-celda" 
          onclick="window.hsClickCelda('${key}','${k}')">
        </div></td>`;
      }
    });
    
    html += '</tr>';
  }
  
  html += '</tbody></table>';
  c.innerHTML = html;
  
  renderizarDeberes();
  
  console.log('📅 Grid renderizado');
}

function ocultarLoading() {
  const l = document.getElementById('loadingHS');
  if (l) l.style.display = 'none';
}
// MOD-006-S16: FIN

// MOD-006-S17: FORMATEO [INICIO]
function formatearHora12(h) {
  if (h === 12) return '12 PM';
  if (h > 12) return (h - 12) + ' PM';
  if (h === 0) return '12 AM';
  return h + ' AM';
}

function formatearFechaISO(fecha) {
  if (!fecha || !(fecha instanceof Date) || isNaN(fecha.getTime())) {
    console.error('📅 formatearFechaISO: fecha inválida', fecha);
    return '';
  }
  
  const year = fecha.getFullYear();
  const month = String(fecha.getMonth() + 1).padStart(2, '0');
  const day = String(fecha.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatearFechaCorta(fecha) {
  if (!fecha || !(fecha instanceof Date) || isNaN(fecha.getTime())) {
    console.error('📅 formatearFechaCorta: fecha inválida', fecha);
    return '';
  }
  
  const dia = String(fecha.getDate()).padStart(2, '0');
  const mes = String(fecha.getMonth() + 1).padStart(2, '0');
  return `${dia}/${mes}`;
}

function parsearFechaDDMMAAAA(fechaStr) {
  if (!fechaStr) {
    return new Date('invalid');
  }

  if (fechaStr instanceof Date) {
    return fechaStr;
  }

  const str = String(fechaStr).trim();

  const match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (match) {
    const dia = parseInt(match[1], 10);
    const mes = parseInt(match[2], 10) - 1;
    const anio = parseInt(match[3], 10);
    return new Date(anio, mes, dia);
  }

  if (str.match(/^\d{4}-\d{1,2}-\d{1,2}/)) {
    return new Date(str);
  }

  return new Date(str);
}
// MOD-006-S17: FIN

// MOD-006-S18: NAVEGACIÓN EXTRA [INICIO]
function cambiarSemana(numSemana) {
  semanaActual = numSemana;
  actualizarInfoSemana();
  renderListaSemanas();
  construirMatriz();
  renderGrid();
}

function navegarSemana(direccion) {
  const nuevaSemana = semanaActual + direccion;
  
  if (nuevaSemana < 1) return;
  
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  const fechaInicio = new Date(configSemana.FechaInicio);
  fechaInicio.setHours(0, 0, 0, 0);
  
  const diffMs = hoy - fechaInicio;
  const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  const semanaMaxima = Math.floor(diffDias / 7) + 1;
  
  if (nuevaSemana > semanaMaxima) return;
  
  cambiarSemana(nuevaSemana);
}

function agregarNuevaSemana() {
  const nuevaSemana = semanaActual + 1;
  const fechas = calcularFechasSemana(nuevaSemana);
  
  const params = {
    codeAlum: currentUser.codeAlum,
    semana: nuevaSemana,
    fechaInicio: formatearFechaISO(fechas.lunes),
    fechaFin: formatearFechaISO(fechas.domingo)
  };
  
  console.log('📅 Creando semana:', params);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        mostrarNotificacion('success', `Semana ${nuevaSemana} creada`);
        cargarSemanas();
        cambiarSemana(nuevaSemana);
      } else {
        mostrarNotificacion('error', r.error || 'Error al crear semana');
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexión');
    })
    .studentCrearSemana(params);
}
// MOD-006-S18: FIN

// MOD-006-S19: CONFIG SEMANA [INICIO]
function abrirConfigSemana() {
  const modal = document.getElementById('modalConfigSemana');
  if (!modal) return;
  
  const inputInicio = document.getElementById('configFechaInicio');
  const inputFin = document.getElementById('configFechaFin');
  
  if (configSemana && configSemana.FechaInicio) {
    inputInicio.value = convertirDDMMAAAAaISO(configSemana.FechaInicio);
  }
  
  if (fechaFinClases) {
    inputFin.value = convertirDDMMAAAAaISO(fechaFinClases);
  }
  
  modal.classList.add('active');
}

function cerrarConfigSemana() {
  const modal = document.getElementById('modalConfigSemana');
  if (modal) modal.classList.remove('active');
}

function handleConfigSemana(event) {
  event.preventDefault();
  
  const fechaInicioInput = document.getElementById('configFechaInicio').value;
  const fechaFinInput = document.getElementById('configFechaFin').value;
  
  if (!fechaInicioInput || !fechaFinInput) {
    mostrarNotificacion('info', 'Debes ingresar ambas fechas');
    return false;
  }
  
  const inicio = new Date(fechaInicioInput);
  const fin = new Date(fechaFinInput);
  
  if (fin <= inicio) {
    mostrarNotificacion('error', 'La fecha de fin debe ser posterior a la fecha de inicio');
    return false;
  }
  
  console.log('📅 Guardando configuración:', {
    fechaInicio: fechaInicioInput,
    fechaFin: fechaFinInput
  });
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        const numSemanas = r.semanas || 0;
        mostrarNotificacion('success', `✓ Configuración guardada. ${numSemanas} semanas generadas.`);
        cerrarConfigSemana();
        
        setTimeout(() => {
          cargarConfigSemana();
          cargarSemanas();
        }, 1500);
      } else {
        mostrarNotificacion('error', 'Error al guardar: ' + (r ? r.error : 'Desconocido'));
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexión');
    })
    .studentGuardarConfigSemana({
      codeAlum: currentUser.codeAlum,
      fechaInicio: fechaInicioInput,
      fechaFin: fechaFinInput
    });
  
  return false;
}

function convertirDDMMAAAAaISO(fechaDDMMAAAA) {
  if (!fechaDDMMAAAA || !fechaDDMMAAAA.includes('/')) return '';
  
  const partes = fechaDDMMAAAA.split('/');
  if (partes.length !== 3) return '';
  
  const dia = partes[0].padStart(2, '0');
  const mes = partes[1].padStart(2, '0');
  const anio = partes[2];
  
  return `${anio}-${mes}-${dia}`;
}
// MOD-006-S19: FIN

// MOD-006-S20: COPIAR Y LIMPIAR V2 [INICIO]
function copiarSemanaAnterior() {
  if (semanaActual <= 1) {
    mostrarNotificacion('info', 'No hay semana anterior para copiar');
    return;
  }

  mostrarConfirmacion(
    `¿Copiar todas las actividades de Semana ${semanaActual - 1} a Semana ${semanaActual}?\n\nLas actividades existentes en la semana actual no se modificarán.`,
    function() {
      ejecutarCopiaSemana();
    }
  );
}

function ejecutarCopiaSemana() {
  // Obtener fechas desde todasSemanas
  const semanaOrigen = todasSemanas.find(s => s.Semana === (semanaActual - 1));
  const semanaDestino = todasSemanas.find(s => s.Semana === semanaActual);
  
  if (!semanaOrigen || !semanaDestino) {
    mostrarNotificacion('error', 'No se encontraron las fechas de las semanas');
    console.error('❌ Semanas no encontradas:', { semanaOrigen, semanaDestino });
    return;
  }
  
  // Parsear fechas desde formato DD/MM/AAAA
  const fechaInicioOrigen = parsearFechaDDMMAAAA(semanaOrigen.FechaInicio);
  const fechaFinOrigen = parsearFechaDDMMAAAA(semanaOrigen.FechaFin);
  const fechaInicioDestino = parsearFechaDDMMAAAA(semanaDestino.FechaInicio);
  
  // Validar fechas
  if (isNaN(fechaInicioOrigen.getTime()) || isNaN(fechaFinOrigen.getTime()) || isNaN(fechaInicioDestino.getTime())) {
    mostrarNotificacion('error', 'Error al procesar las fechas');
    console.error('❌ Fechas inválidas:', {
      origen: semanaOrigen,
      destino: semanaDestino
    });
    return;
  }
  
  // Convertir a formato ISO
  const params = {
    codeAlum: currentUser.codeAlum,
    fechaInicioOrigen: formatearFechaISO(fechaInicioOrigen),
    fechaFinOrigen: formatearFechaISO(fechaFinOrigen),
    fechaInicioDestino: formatearFechaISO(fechaInicioDestino)
  };
  
  console.log('📋 Copiando semana:', params);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        const cantidad = typeof r.data === 'number' ? r.data : parseInt(r.data) || 0;
        mostrarNotificacion('success', `✓ ${cantidad} actividades copiadas`);
        cargarHorarioSem();
      } else {
        const error = r ? r.error : 'Error desconocido';
        mostrarNotificacion('error', 'Error al copiar: ' + error);
        console.error('❌ Error del backend:', r);
      }
    })
    .withFailureHandler(e => {
      console.error('❌ Error de conexión:', e);
      mostrarNotificacion('error', 'Error de conexión al copiar semana');
    })
    .studentCopiarSemana(params);
}

function limpiarSemana() {
  mostrarConfirmacion(
    `¿Eliminar TODAS las actividades de Semana ${semanaActual}?\n\nLas clases fijas NO se eliminarán.\n\nEsta acción no se puede deshacer.`,
    function() {
      ejecutarLimpiezaSemana();
    }
  );
}

function ejecutarLimpiezaSemana() {
  // Obtener fechas desde todasSemanas
  const semana = todasSemanas.find(s => s.Semana === semanaActual);
  
  if (!semana) {
    mostrarNotificacion('error', 'No se encontraron las fechas de la semana');
    console.error('❌ Semana no encontrada:', semanaActual);
    return;
  }
  
  // Parsear fechas desde formato DD/MM/AAAA
  const fechaInicio = parsearFechaDDMMAAAA(semana.FechaInicio);
  const fechaFin = parsearFechaDDMMAAAA(semana.FechaFin);
  
  // Validar fechas
  if (isNaN(fechaInicio.getTime()) || isNaN(fechaFin.getTime())) {
    mostrarNotificacion('error', 'Error al procesar las fechas');
    console.error('❌ Fechas inválidas:', semana);
    return;
  }
  
  const params = {
    codeAlum: currentUser.codeAlum,
    fechaInicio: formatearFechaISO(fechaInicio),
    fechaFin: formatearFechaISO(fechaFin)
  };
  
  console.log('🗑️ Limpiando semana:', params);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        const cantidad = typeof r.data === 'number' ? r.data : parseInt(r.data) || 0;
        mostrarNotificacion('success', `✓ ${cantidad} actividades eliminadas`);
        cargarHorarioSem();
      } else {
        const error = r ? r.error : 'Error desconocido';
        mostrarNotificacion('error', 'Error al limpiar: ' + error);
        console.error('❌ Error del backend:', r);
      }
    })
    .withFailureHandler(e => {
      console.error('❌ Error de conexión:', e);
      mostrarNotificacion('error', 'Error de conexión al limpiar semana');
    })
    .studentLimpiarSemana(params);
}
// MOD-006-S20: FIN

// MOD-006-S21: FORMULARIO ACTIVIDAD [INICIO]
function clickCelda(fecha, hora) {
  console.log('📅 Click en celda:', { fecha, hora });
  abrirFormularioActividad(fecha, hora);
}

function abrirFormularioActividad(fecha, hora) {
  resetFormActividad();
  
  const fechaObj = new Date(fecha);
  const diaIndex = fechaObj.getDay() === 0 ? 6 : fechaObj.getDay() - 1;
  const diaCorto = DIAS_CORTOS[diaIndex];
  const fechaCorta = formatearFechaCorta(fechaObj);
  
  document.getElementById('actividadFormTitle').textContent = `Agregar Actividad - ${diaCorto} ${fechaCorta}`;
  document.getElementById('actividadModoEdicion').value = 'false';
  document.getElementById('actividadFecha').value = fecha;
  document.getElementById('actividadSem').value = semanaActual;
  document.getElementById('btnSubmitActividad').textContent = 'Guardar';
  document.getElementById('btnEliminarActividad').style.display = 'none';
  
  document.getElementById('actividadHoraIni').value = hora;
  
  const [h] = hora.split(':').map(Number);
  const horaFinSugerida = String(Math.min(h + 1, HORA_FIN + 1)).padStart(2, '0') + ':00';
  document.getElementById('actividadHoraFin').value = horaFinSugerida;
  
  document.getElementById('modalActividad').classList.add('active');
}

function editarActividad(fecha, hora) {
  const key = fecha;
  const items = horarioMatrix[key][hora];
  
  if (!items || items.length === 0) return;
  
  const item = items.find(i => i.tipo === 'actividad');
  if (!item) return;
  
  const act = item.actividad;
  
  const fechaObj = new Date(fecha);
  const diaIndex = fechaObj.getDay() === 0 ? 6 : fechaObj.getDay() - 1;
  const diaCorto = DIAS_CORTOS[diaIndex];
  const fechaCorta = formatearFechaCorta(fechaObj);
  
  document.getElementById('actividadFormTitle').textContent = `Editar Actividad - ${diaCorto} ${fechaCorta}`;
  document.getElementById('actividadRowNumber').value = act._rowNumber || '';
  document.getElementById('actividadModoEdicion').value = 'true';
  document.getElementById('actividadFecha').value = fecha;
  document.getElementById('actividadSem').value = act.Sem || semanaActual;
  document.getElementById('actividadTipo').value = act.TipoAct || '';
  document.getElementById('actividadNombre').value = act.Actividad || '';
  document.getElementById('actividadHoraIni').value = normalizarHora(act.HoraInicio) || '';
  document.getElementById('actividadHoraFin').value = normalizarHora(act.HoraFin) || '';
  document.getElementById('actividadColor').value = act.Color || '#17a2b8';
  
  document.getElementById('btnSubmitActividad').textContent = 'Actualizar';
  document.getElementById('btnEliminarActividad').style.display = 'block';
  
  document.getElementById('modalActividad').classList.add('active');
}

function resetFormActividad() {
  const form = document.getElementById('formActividad');
  if (form) form.reset();
  
  document.getElementById('actividadRowNumber').value = '';
  document.getElementById('actividadModoEdicion').value = '';
  document.getElementById('actividadFecha').value = '';
  document.getElementById('actividadSem').value = '';
}

function cerrarModalActividad() {
  const modal = document.getElementById('modalActividad');
  if (modal) modal.classList.remove('active');
  resetFormActividad();
}

function handleSubmitActividad(event) {
  event.preventDefault();
  
  const tipo = document.getElementById('actividadTipo').value.trim();
  const nombre = document.getElementById('actividadNombre').value.trim();
  const horaIni = document.getElementById('actividadHoraIni').value.trim();
  const horaFin = document.getElementById('actividadHoraFin').value.trim();
  const fechaISO = document.getElementById('actividadFecha').value;
  const sem = document.getElementById('actividadSem').value;
  const color = document.getElementById('actividadColor').value;
  const esEdicion = document.getElementById('actividadModoEdicion').value === 'true';
  const rowNumber = document.getElementById('actividadRowNumber').value;
  
  if (!tipo || !nombre || !horaIni || !horaFin) {
    mostrarNotificacion('info', 'Completa todos los campos');
    return false;
  }
  
  if (horaIni >= horaFin) {
    mostrarNotificacion('info', 'La hora de fin debe ser mayor a la de inicio');
    return false;
  }
  
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = true;
  btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';
  
  const params = {
    codeAlum: currentUser.codeAlum,
    actividad: nombre,
    horaInicio: horaIni,
    horaFin: horaFin,
    fechaHS: fechaISO,
    tipoAct: tipo,
    color: color,
    sem: sem
  };
  
  if (esEdicion) {
    if (rowNumber) {
      params.rowNumber = parseInt(rowNumber);
    }
    
    google.script.run
      .withSuccessHandler(r => handleActividadGuardada(r, true))
      .withFailureHandler(e => handleActividadError(e, true))
      .studentActualizarHorarioSem(params);
  } else {
    google.script.run
      .withSuccessHandler(r => handleActividadGuardada(r, false))
      .withFailureHandler(e => handleActividadError(e, false))
      .studentAgregarHorarioSem(params);
  }
  
  return false;
}

function handleActividadGuardada(response, esEdicion) {
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  if (response && response.success) {
    const msg = esEdicion ? '✓ Actividad actualizada' : '✓ Actividad agregada';
    mostrarNotificacion('success', msg);
    cerrarModalActividad();
    cargarHorarioSem();
  } else {
    const error = response ? response.error : 'Error desconocido';
    mostrarNotificacion('error', 'Error: ' + error);
  }
}

function handleActividadError(error, esEdicion) {
  console.error('📅 Error:', error);
  
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  mostrarNotificacion('error', 'Error de conexión. Intenta nuevamente');
}

function confirmarEliminarActividad() {
  const rowNumber = document.getElementById('actividadRowNumber').value;

  if (!rowNumber) {
    mostrarNotificacion('info', 'No se puede eliminar esta actividad');
    return;
  }

  mostrarConfirmacion(
    '¿Eliminar esta actividad?\n\nEsta acción no se puede deshacer.',
    function() {
      eliminarActividad(parseInt(rowNumber));
    }
  );
}

function eliminarActividad(rowNumber) {
  google.script.run
    .withSuccessHandler(handleActividadEliminada)
    .withFailureHandler(e => {
      console.error('📅 Error al eliminar:', e);
      mostrarNotificacion('error', 'Error al eliminar');
    })
    .studentEliminarHorarioSem({ rowNumber: rowNumber });
}

function handleActividadEliminada(response) {
  if (response && response.success) {
    mostrarNotificacion('success', 'Actividad eliminada');
    cerrarModalActividad();
    cargarHorarioSem();
  } else {
    const error = response ? response.error : 'Error desconocido';
    mostrarNotificacion('error', 'Error: ' + error);
  }
}
// MOD-006-S21: FIN

// MOD-006-S22: MODAL CONFIRMACIÓN [INICIO]
function mostrarConfirmacion(mensaje, onConfirm) {
  const modal = document.getElementById('modalConfirmacion');
  const mensajeEl = document.getElementById('confirmacionMensaje');
  const btnConfirmar = document.getElementById('btnConfirmarAccion');
  
  if (!modal || !mensajeEl || !btnConfirmar) {
    console.error('❌ No se encontró el modal de confirmación');
    return;
  }

  mensajeEl.innerHTML = mensaje.replace(/\n/g, '<br>');
  
  btnConfirmar.onclick = function() {
    cerrarModalConfirmacion();
    if (typeof onConfirm === 'function') {
      onConfirm();
    }
  };
  
  modal.style.display = 'flex';
}

function cerrarModalConfirmacion() {
  const modal = document.getElementById('modalConfirmacion');
  if (modal) {
    modal.style.display = 'none';
  }
}
// MOD-006-S22: FIN

// MOD-006-S23: NOTIFICACIONES [INICIO]
function mostrarNotificacion(tipo, mensaje) {
  // Si existe la función global showAlert, usarla
  if (typeof window.showAlert === 'function') {
    window.showAlert(tipo, mensaje);
    return;
  }
  
  // Fallback: crear notificación simple
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    font-size: 14px;
    z-index: 99999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease;
    max-width: 400px;
  `;
  
  // Colores según tipo
  const colores = {
    success: '#28a745',
    error: '#dc3545',
    info: '#17a2b8',
    warning: '#ffc107'
  };
  
  notif.style.backgroundColor = colores[tipo] || colores.info;
  notif.textContent = mensaje;
  
  document.body.appendChild(notif);
  
  // Auto-cerrar después de 3 segundos
  setTimeout(() => {
    notif.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notif.remove(), 300);
  }, 3000);
}
// MOD-006-S23: FIN

// MOD-006-S24: RENDERIZAR DEBERES V2 [INICIO]
function renderizarDeberes() {
  const container = document.getElementById('hsDeberesContainer');
  if (!container) {
    console.warn('⚠️ Contenedor de deberes no encontrado');
    return;
  }
  
  console.log('📝 Renderizando deberes de la semana', semanaActual);
  
  const semana = todasSemanas.find(s => s.Semana === semanaActual);
  if (!semana) {
    container.innerHTML = '';
    return;
  }
  
  const fechaInicio = semana.FechaInicio;
  const fechaFin = semana.FechaFin;
  
  console.log('📅 Rango de fechas:', fechaInicio, '-', fechaFin);
  
  google.script.run
    .withSuccessHandler(response => {
      // Validar que response sea un objeto con data
      if (!response || !response.success) {
        console.warn('⚠️ Response inválido:', response);
        container.innerHTML = '';
        return;
      }
      
      // Validar que data sea un array
      const deberes = response.data;
      if (!Array.isArray(deberes)) {
        console.warn('⚠️ deberes.data no es un array:', typeof deberes, deberes);
        container.innerHTML = '';
        return;
      }
      
      if (deberes.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      const deberesSemana = filtrarDeberesPorFechas(deberes, fechaInicio, fechaFin);
      
      if (deberesSemana.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      let html = '<div class="hs-deberes-container">';
      html += '<div class="hs-deberes-titulo">📚 Deberes de la Semana</div>';
      html += '<div class="hs-deberes-grid">';
      
      deberesSemana.forEach(deber => {
        const tipo = deber.tipo.toLowerCase();
        html += `
          <div class="hs-deber-card ${tipo}" onclick="window.hsAbrirDetalleDeber(${JSON.stringify(deber).replace(/"/g, '&quot;')})">
            <div class="hs-deber-curso">${deber.curso}</div>
            <div class="hs-deber-tipo">${deber.tipo}</div>
          </div>
        `;
      });
      
      html += '</div></div>';
      
      container.innerHTML = html;
      console.log('✅ Deberes renderizados:', deberesSemana.length);
    })
    .withFailureHandler(e => {
      console.error('❌ Error al cargar deberes:', e);
      container.innerHTML = '';
    })
    .studentObtenerTodosDeberes({ codeAlum: currentUser.codeAlum });
}

function filtrarDeberesPorFechas(deberes, fechaInicio, fechaFin) {
  // Validar que deberes sea un array
  if (!Array.isArray(deberes)) {
    console.error('❌ filtrarDeberesPorFechas: deberes no es un array', typeof deberes);
    return [];
  }
  
  const inicio = parsearFechaDDMMAAAA(fechaInicio);
  const fin = parsearFechaDDMMAAAA(fechaFin);
  
  return deberes.filter(deber => {
    if (!deber.fecha) return false;
    
    const fechaDeber = parsearFechaDDMMAAAA(deber.fecha);
    return fechaDeber >= inicio && fechaDeber <= fin;
  });
}

function abrirDetalleDeber(deber) {
  const modal = document.getElementById('modalDetalleDeber');
  const body = document.getElementById('modalDeberBody');
  
  if (!modal || !body) return;
  
  let html = '';
  
  html += `<div class="hs-deber-detalle-row">
    <div class="hs-deber-detalle-label">Curso</div>
    <div class="hs-deber-detalle-valor">${deber.curso}</div>
  </div>`;
  
  html += `<div class="hs-deber-detalle-row">
    <div class="hs-deber-detalle-label">Tipo</div>
    <div class="hs-deber-detalle-valor">${deber.tipo}</div>
  </div>`;
  
  if (deber.nombre) {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Nombre</div>
      <div class="hs-deber-detalle-valor">${deber.nombre}</div>
    </div>`;
  }
  
  if (deber.fecha) {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Fecha</div>
      <div class="hs-deber-detalle-valor">${deber.fecha}</div>
    </div>`;
  }
  
  if (deber.nota !== undefined && deber.nota !== null && deber.nota !== '') {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Nota</div>
      <div class="hs-deber-detalle-valor">${deber.nota}</div>
    </div>`;
  }
  
  if (deber.peso) {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Peso</div>
      <div class="hs-deber-detalle-valor">${deber.peso}%</div>
    </div>`;
  }
  
  if (deber.progreso !== undefined && deber.progreso !== null) {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Progreso</div>
      <div class="hs-deber-detalle-valor">${deber.progreso}%</div>
    </div>`;
  }
  
  body.innerHTML = html;
  modal.classList.add('active');
}

function cerrarModalDeber() {
  const modal = document.getElementById('modalDetalleDeber');
  if (modal) modal.classList.remove('active');
}
// MOD-006-S24: FIN

// MOD-006-S25: EXPOSICIÓN GLOBAL Y ARRANQUE V2 [INICIO]
window.hsInit = init;
window.hsCargarHorarioSem = cargarHorarioSem;
window.hsCambiarSemana = cambiarSemana;
window.hsNavegar = navegar;
window.hsNavegarSemana = navegarSemana;
window.hsAgregarNuevaSemana = agregarNuevaSemana;
window.hsAbrirConfigSemana = abrirConfigSemana;
window.hsCerrarConfigSemana = cerrarConfigSemana;
window.hsHandleConfigSemana = handleConfigSemana;
window.hsClickCelda = clickCelda;
window.hsEditarActividad = editarActividad;
window.hsCerrarModalActividad = cerrarModalActividad;
window.hsHandleSubmitActividad = handleSubmitActividad;
window.hsConfirmarEliminarActividad = confirmarEliminarActividad;
window.hsCopiarSemanaAnterior = copiarSemanaAnterior;
window.hsLimpiarSemana = limpiarSemana;
window.hsCerrarModalConfirmacion = cerrarModalConfirmacion;
window.hsCerrarModalDeber = cerrarModalDeber;
window.hsAbrirDetalleDeber = abrirDetalleDeber;

setTimeout(function() {
  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    console.log('📅 currentUser detectado, inicializando...');
    init();
  } else {
    console.log('📅 currentUser no disponible, iniciando retry...');
    init();
  }
}, 500);

window.HorarioSemanalModule = {
  init: init,
  cambiarSemana: cambiarSemana,
  navegarSemana: navegarSemana,
  abrirConfigSemana: abrirConfigSemana,
  copiarSemanaAnterior: copiarSemanaAnterior,
  limpiarSemana: limpiarSemana
};

console.log('%c📅 HorarioSemanalModule V01.39 CODEWORKSHOP cargado',
  'font-size:11px;color:#667eea;font-weight:bold');
// MOD-006-S25: FIN
})();
</script>

<!-- MOD-006: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Grid semanal 7×16 (7 AM-10 PM) para actividades dinámicas por semana.
Gestión con navegación, copia y limpieza. Clases fijas + actividades coloreadas.

FUNCIONALIDAD:
- Configuración fecha inicio ciclo ("1ra clase")
- Navegación por semanas calculadas automáticamente
- Clases fijas (grises, desde HorarioClase)
- Actividades dinámicas (coloreadas por tipo)
- Copiar/Limpiar semanas
- Modal confirmación estilizado

DEPENDENCIAS BACKEND:
- studentObtenerConfigSemana()
- studentGuardarConfigSemana()
- studentObtenerSemanas()
- studentCrearSemana()
- studentObtenerCursos()
- studentObtenerHorarioClases()
- studentObtenerHorarioSem()
- studentAgregarHorarioSem()
- studentActualizarHorarioSem()
- studentEliminarHorarioSem()
- studentCopiarSemana()
- studentLimpiarSemana()

ESTRUCTURA:
MOD-001: Encabezado
MOD-002: Texto libre
MOD-003: Estilos CSS
MOD-004: Estructura HTML
MOD-005: JavaScript (23 submódulos S01-S23)
MOD-006: Notas

CAMBIOS V01.32 → V01.33:
- Remodulación según estándar CodeWorkShop v4.0
- MOD-005 con 23 submódulos JavaScript
- Delimitadores correctos (//) dentro de <script>
- Fix: Parseo DD/MM/AAAA desde backend
- Modal confirmación estilizado (no confirm() nativo)
- Prefijo 'hs' en funciones globales

AISLAMIENTO:
- Prefijo CSS: .hs-*
- Prefijo JS: window.hs*
- Sin conflicto con HorarioClase (.hc-*)
-->
<!-- MOD-099: FIN -->


// ============================================
// ARCHIVO 24/24: 7ctabnotas.html
// URL: https://raw.githubusercontent.com/koki81pe/PBEcontrol/refs/heads/main/7ctabnotas.html
// ============================================

<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 7ctabnotas.html
VERSIÓN: 01.20
FECHA: 19/01/2026 00:06 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>

// MOD-002-S01: CONTENEDOR PRINCIPAL [INICIO]
/* CONTENEDOR PRINCIPAL */
.notas-container {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.notas-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.notas-header h2 {
  margin: 0;
  font-size: 20px;
  color: #333;
}

.notas-stats {
  display: flex;
  gap: 16px;
  font-size: 14px;
  color: #666;
}

.stat-item strong {
  color: #333;
}
// MOD-002-S01: FIN

// MOD-002-S02: GRID DE CURSOS [INICIO]
/* GRID DE CURSOS */
.notas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 20px;
}
// MOD-002-S02: FIN

// MOD-002-S03: TARJETA DE CURSO [INICIO]
/* TARJETA DE CURSO */
.curso-card {
  background: #fff;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  transition: all 0.3s;
}

.curso-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.curso-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 6px;
  background: var(--curso-color);
}

.curso-card-content {
  padding: 20px 20px 20px 26px;
}

.curso-card-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 16px;
}

.curso-info h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
}

.curso-codigo {
  font-size: 13px;
  font-weight: 600;
  color: #667eea;
  background: rgba(102, 126, 234, 0.1);
  padding: 3px 10px;
  border-radius: 6px;
}
// MOD-002-S03: FIN

// MOD-002-S04: PROMEDIO BADGE [INICIO]
/* PROMEDIO BADGE */
.promedio-badge {
  font-size: 28px;
  font-weight: 700;
}

.promedio-badge.aprobado-excelente {
  color: #28a745;
}

.promedio-badge.aprobado-justo {
  color: #ffc107;
}

.promedio-badge.desaprobado {
  color: #dc3545;
}

.promedio-badge.sin-notas {
  color: #999;
  font-size: 16px;
}

.promedio-label {
  font-size: 11px;
  color: #999;
  text-transform: uppercase;
}
// MOD-002-S04: FIN

// MOD-002-S05: ESTADO DEL CURSO [INICIO]
/* ESTADO DEL CURSO */
.curso-estado {
  margin-top: 12px;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 6px;
}

.estado-excelente {
  background: #d4edda;
  color: #155724;
}

.estado-aprobado {
  background: #fff3cd;
  color: #856404;
}

.estado-desaprobado {
  background: #f8d7da;
  color: #721c24;
}

.estado-sin-notas {
  background: #e9ecef;
  color: #6c757d;
}
// MOD-002-S05: FIN

// MOD-002-S06: DETALLE DEL CURSO [INICIO]
/* DETALLE DEL CURSO */
.curso-detalle {
  display: flex;
  gap: 16px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #e0e0e0;
}

.detalle-item {
  text-align: center;
  flex: 1;
}

.detalle-item-valor {
  font-size: 20px;
  font-weight: 700;
  color: #667eea;
}

.detalle-item-label {
  font-size: 11px;
  color: #999;
}
// MOD-002-S06: FIN

// MOD-002-S07: LOADING [INICIO]
/* LOADING */
.loading-container {
  text-align: center;
  padding: 40px;
  color: #667eea;
}

.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(102, 126, 234, 0.2);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
// MOD-002-S07: FIN

// MOD-002-S08: ESTADO VACÍO [INICIO]
/* ESTADO VACÍO */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}
// MOD-002-S08: FIN

</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR PRINCIPAL [INICIO] -->
<div class="notas-container">
  <div class="notas-header">
    <h2>📊 Resumen de Notas</h2>
    <div class="notas-stats">
      <div class="stat-item">📚 <strong id="statCursos">0</strong> cursos</div>
      <div class="stat-item">📝 <strong id="statNotas">0</strong> notas</div>
      <div class="stat-item">📈 Promedio general: <strong id="statProm">--</strong></div>
    </div>
  </div>

  <div id="notasGrid" class="notas-grid">
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando notas...</p>
    </div>
  </div>
</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>

// MOD-004-S01: ENCAPSULAMIENTO Y PROTECCIÓN [INICIO]
(function PBE_NOTAS_MODULE() {
  'use strict';

  if (window.NotasModule) return;

  const NotasModule = {
    data: []
  };
// MOD-004-S01: FIN

// MOD-004-S02: INICIALIZACIÓN [INICIO]
  NotasModule.init = function() {
    if (!window.currentUser?.codeAlum) {
      showAlert('error', 'No se pudo identificar al usuario');
      return;
    }
    this.cargar();
  };
// MOD-004-S02: FIN

// MOD-004-S03: CARGA DE DATOS [INICIO]
  NotasModule.cargar = function() {
    google.script.run
      .withSuccessHandler(r => {
        if (r.success) {
          this.data = r.data || [];
          this.render();
          this.stats();
        } else {
          this.empty();
        }
      })
      .withFailureHandler(() => this.empty())
      .studentObtenerResumenNotas({ codeAlum: currentUser.codeAlum });
  };
// MOD-004-S03: FIN

// MOD-004-S04: RENDERIZADO DE CURSOS [INICIO]
  NotasModule.render = function() {
    const cont = document.getElementById('notasGrid');
    if (!this.data.length) return this.empty();

    cont.innerHTML = this.data.map(c => {
      const p = parseFloat(c.promedio) || 0;
      return `
        <div class="curso-card" style="--curso-color:${c.color || '#667eea'}">
          <div class="curso-card-content">
            <div class="curso-card-header">
              <div class="curso-info">
                <h3>${c.completo}</h3>
                <span class="curso-codigo">${c.curso}</span>
              </div>
              <div>
                <div class="promedio-badge ${this.cls(p)}">${p || 'S/N'}</div>
                <div class="promedio-label">Promedio</div>
              </div>
            </div>

            <div class="curso-estado ${this.estadoCls(p)}">${this.estadoTxt(p)}</div>

            <div class="curso-detalle">
              <div class="detalle-item">
                <div class="detalle-item-valor">${c.evaluaciones || 0}</div>
                <div class="detalle-item-label">Evaluaciones</div>
              </div>
              <div class="detalle-item">
                <div class="detalle-item-valor">${c.tareas || 0}</div>
                <div class="detalle-item-label">Tareas</div>
              </div>
              <div class="detalle-item">
                <div class="detalle-item-valor">${c.lecturas || 0}</div>
                <div class="detalle-item-label">Lecturas</div>
              </div>
            </div>
          </div>
        </div>`;
    }).join('');
  };
// MOD-004-S04: FIN

// MOD-004-S05: ESTADÍSTICAS GLOBALES [INICIO]
  NotasModule.stats = function() {
    let notas = 0;
    let sum = 0;
    let con = 0;

    this.data.forEach(c => {
      const p = parseFloat(c.promedio) || 0;
      notas += (c.evaluaciones || 0) + (c.tareas || 0) + (c.lecturas || 0);
      if (p > 0) {
        sum += p;
        con++;
      }
    });

    document.getElementById('statCursos').textContent = this.data.length;
    document.getElementById('statNotas').textContent = notas;
    document.getElementById('statProm').textContent = con ? (sum / con).toFixed(2) : '--';
  };
// MOD-004-S05: FIN

// MOD-004-S06: ESTADO VACÍO [INICIO]
  NotasModule.empty = function() {
    document.getElementById('notasGrid').innerHTML = `
      <div class="empty-state">
        <div style="font-size:48px">📊</div>
        Sin calificaciones aún
      </div>`;
  };
// MOD-004-S06: FIN

// MOD-004-S07: HELPERS DE CLASIFICACIÓN [INICIO]
  NotasModule.cls = p =>
    p === 0 ? 'sin-notas' :
    p >= 14 ? 'aprobado-excelente' :
    p >= 11 ? 'aprobado-justo' :
    'desaprobado';

  NotasModule.estadoCls = p =>
    p === 0 ? 'estado-sin-notas' :
    p >= 14 ? 'estado-excelente' :
    p >= 11 ? 'estado-aprobado' :
    'estado-desaprobado';

  NotasModule.estadoTxt = p =>
    p === 0 ? '📋 Sin calificaciones' :
    p >= 14 ? '🎉 Excelente' :
    p >= 11 ? '✅ Aprobado' :
    '⚠️ Necesita mejorar';
// MOD-004-S07: FIN

// MOD-004-S08: EXPORT E INICIALIZACIÓN [INICIO]
  console.log('%c📊 Sub-tab Notas V01.19 cargado', 'font-size: 11px; color: #667eea;');

  window.NotasModule = NotasModule;
  NotasModule.init();
// MOD-004-S08: FIN

})();

</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
Dashboard de resumen de notas por curso con visualización en tarjetas.
Muestra rendimiento académico individual y estadísticas globales.

FUNCIONALIDAD:
- Carga resumen de notas desde backend (studentObtenerResumenNotas)
- Calcula promedio por curso automáticamente
- Genera estadísticas globales (total cursos, notas, promedio general)
- Clasifica cursos por rendimiento (Excelente/Aprobado/Desaprobado/Sin notas)
- Renderizado responsive en grid adaptable

ESTRUCTURA DE DATOS (cada curso):
- curso: Código del curso
- completo: Nombre completo
- color: Color personalizado (hex)
- promedio: Promedio calculado (0-20)
- evaluaciones, tareas, lecturas: Contadores numéricos

CLASIFICACIÓN DE NOTAS:
- Excelente: ≥14 (verde, 🎉)
- Aprobado: 11-13 (amarillo, ✅)
- Desaprobado: <11 (rojo, ⚠️)
- Sin Notas: 0 (gris, 📋)

ARQUITECTURA TÉCNICA:
- Módulo encapsulado en IIFE (NotasModule)
- Protección anti-redeclaración al cambiar tabs
- Inicialización automática con validación de usuario (currentUser.codeAlum)
- Renderizado dinámico con template literals
- Cálculo de estadísticas en tiempo real

SUBMÓDULOS:
MOD-004-S01: Encapsulamiento IIFE y protección
MOD-004-S02: Inicialización y validación de usuario
MOD-004-S03: Carga de datos desde backend
MOD-004-S04: Renderizado de tarjetas de cursos
MOD-004-S05: Cálculo de estadísticas globales
MOD-004-S06: Estado vacío (sin calificaciones)
MOD-004-S07: Helpers de clasificación (cls, estadoCls, estadoTxt)
MOD-004-S08: Export global e init automático

DEPENDENCIAS:
- currentUser.codeAlum: Identificador del estudiante (requerido)
- showAlert(type, message): Función global de alertas (opcional)
- Backend: studentObtenerResumenNotas({ codeAlum })

INTEGRACIÓN:
- Parent: Sistema de tabs con lazy-loading
- Backend: Wrapper en code.gs → Student.gs (agregación de datos)

CAMBIOS V01.19 → V01.20:
- Remodulación según estándar CodeWorkShop v4.0
- MOD-002 con 8 submódulos CSS (S01-S08)
- MOD-004 con 8 submódulos JavaScript (S01-S08)
- Notas consolidadas y optimizadas (15 líneas)
- Delimitadores correctos (//) en <style> y <script>
- Lógica funcional sin cambios
-->
<!-- MOD-099: FIN -->


// ============================================
// FIN DEL SOLID CODE
// Tamaño total: 516,502 caracteres
// Archivos exitosos: 24/24
// ============================================
