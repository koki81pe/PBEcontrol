<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 6btablecturas.html
VERSI√ìN: 01.23
FECHA: 20/01/2026 17:36 (UTC-5)
*****************************************
CAMBIOS V01.21 ‚Üí V01.22 FIXED:
- ‚úÖ Mantiene tabla con filas (NO cards)
- ‚úÖ Elimina columna "Progreso" (barra visual)
- ‚úÖ Elimina columna "Semana"
- ‚úÖ Agrega columna "P√°gs/D√≠a" con c√°lculo din√°mico
- ‚úÖ Conserva bot√≥n "+Agregar Lectura"
- ‚úÖ Conserva botones Editar/Eliminar
- ‚úÖ Integra LecturasHelpers para fechas
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS [INICIO] -->
<style>
/* RESET Y BASE */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* CONTENEDOR PRINCIPAL */
.lecturas-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.lecturas-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 16px;
}

.lecturas-header h2 {
  font-size: 24px;
  font-weight: 600;
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

/* FILTRO */
.filtro-container {
  display: flex;
  gap: 8px;
  align-items: center;
}

.filtro-container label {
  font-size: 14px;
  color: #666;
  font-weight: 500;
}

.filtro-container select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  background: white;
  cursor: pointer;
  min-width: 180px;
}

.filtro-container select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn-agregar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-agregar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-agregar:active {
  transform: translateY(0);
}

/* FORMULARIO */
.form-lectura {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: none;
}

.form-lectura.active {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #e0e0e0;
}

.form-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: #333;
}

.btn-cerrar-form {
  background: transparent;
  border: none;
  font-size: 24px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.btn-cerrar-form:hover {
  background: #f0f0f0;
  color: #333;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin-bottom: 16px;
}

.form-row.full-width {
  grid-template-columns: 1fr;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group label {
  font-size: 14px;
  font-weight: 600;
  color: #333;
}

.form-group label .required {
  color: #dc3545;
  margin-left: 4px;
}

.form-group input,
.form-group select {
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input::placeholder {
  color: #999;
}

.form-group small {
  font-size: 12px;
  color: #666;
  font-style: italic;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #e0e0e0;
}

.btn-submit {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-cancelar {
  background: #f5f5f5;
  color: #666;
  border: 1px solid #ddd;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-cancelar:hover {
  background: #e8e8e8;
}

/* TABLA */
.lecturas-table-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.lecturas-table {
  width: 100%;
  border-collapse: collapse;
}

.lecturas-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.lecturas-table th {
  padding: 14px 16px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.lecturas-table tbody tr {
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.2s;
}

.lecturas-table tbody tr:nth-child(even) {
  background: #f8f9fa;
}

.lecturas-table tbody tr:hover {
  background: #e9ecef;
}

.lecturas-table td {
  padding: 14px 16px;
  font-size: 14px;
  color: #333;
}

.curso-tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  background: #e9ecef;
  color: #495057;
}

.lectura-titulo {
  font-weight: 600;
  color: #333;
}

/* NUEVA: Columna P√°gs/D√≠a */
.pags-dia {
  font-weight: 700;
  font-size: 15px;
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-block;
}

.pags-dia.ok {
  color: #28a745;
  background: #d4edda;
}

.pags-dia.warning {
  color: #ffc107;
  background: #fff3cd;
}

.pags-dia.critical {
  color: #dc3545;
  background: #f8d7da;
}

.nota-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
}

.nota-alta {
  background: #d4edda;
  color: #155724;
}

.nota-media {
  background: #fff3cd;
  color: #856404;
}

.nota-baja {
  background: #f8d7da;
  color: #721c24;
}

.nota-pendiente {
  background: #e9ecef;
  color: #6c757d;
}

.acciones-container {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.btn-icon {
  background: transparent;
  border: 1px solid #ddd;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-icon:hover {
  transform: scale(1.1);
  border-color: #667eea;
}

.btn-eliminar:hover {
  border-color: #dc3545;
  background: #fff5f5;
}

.estado-vacio,
.loading-lecturas {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.estado-vacio-icon {
  font-size: 64px;
  margin-bottom: 16px;
}

.estado-vacio-text {
  font-size: 20px;
  font-weight: 600;
  color: #666;
  margin-bottom: 8px;
}

.estado-vacio-subtext {
  font-size: 14px;
  color: #999;
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .lecturas-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .header-actions {
    flex-direction: column;
  }
  
  .filtro-container {
    flex-direction: column;
    align-items: stretch;
  }
  
  .lecturas-table {
    font-size: 12px;
  }
  
  .lecturas-table th,
  .lecturas-table td {
    padding: 10px 8px;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: HTML ESTRUCTURA [INICIO] -->
<div class="lecturas-container">
  <!-- Header con filtro y bot√≥n agregar -->
  <div class="lecturas-header">
    <h2>
      <span>üìö</span>
      <span>Lecturas</span>
    </h2>
    <div class="header-actions">
      <div class="filtro-container">
        <label for="filtroCursoLectura">Filtrar por curso:</label>
        <select id="filtroCursoLectura" onchange="LecturasModule.aplicarFiltro()">
          <option value="">Todos los cursos</option>
        </select>
      </div>
      <button class="btn-agregar" onclick="LecturasModule.toggleFormAgregar()">
        <span>‚ûï</span>
        <span>Agregar Lectura</span>
      </button>
    </div>
  </div>

  <!-- Formulario Agregar/Editar -->
  <div id="formLectura" class="form-lectura">
    <div class="form-header">
      <h3 id="formTitulo">Agregar Lectura</h3>
      <button class="btn-cerrar-form" onclick="LecturasModule.cancelarFormulario()" type="button">‚úï</button>
    </div>

    <form onsubmit="LecturasModule.handleSubmitLectura(event)">
      <input type="hidden" id="lectura_rowNumber" value="">

      <div class="form-row">
        <div class="form-group">
          <label for="lectura_curso">
            Curso
            <span class="required">*</span>
          </label>
          <select id="lectura_curso" required>
            <option value="">Seleccionar curso...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="lectura_titulo">
            T√≠tulo de la Lectura
            <span class="required">*</span>
          </label>
          <input type="text" id="lectura_titulo" placeholder="Ej: El Principito" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="lectura_cantPag">
            Total de P√°ginas
            <span class="required">*</span>
          </label>
          <input type="number" id="lectura_cantPag" min="1" placeholder="Ej: 120" required>
        </div>

        <div class="form-group">
          <label for="lectura_pagActual">
            P√°ginas Le√≠das
            <span class="required">*</span>
          </label>
          <input type="number" id="lectura_pagActual" min="0" value="0" required>
          <small>P√°ginas ya le√≠das hasta ahora</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="lectura_fechaInicio">
            Fecha de Inicio
            <span class="required">*</span>
          </label>
          <input type="text" id="lectura_fechaInicio" placeholder="DD/MM/AAAA" required>
        </div>

        <div class="form-group">
          <label for="lectura_fechaFin">
            Fecha de Finalizaci√≥n
            <span class="required">*</span>
          </label>
          <input type="text" id="lectura_fechaFin" placeholder="DD/MM/AAAA" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="lectura_fechaEval">Fecha de Evaluaci√≥n</label>
          <input type="text" id="lectura_fechaEval" placeholder="DD/MM/AAAA">
          <small>Opcional</small>
        </div>

        <div class="form-group">
          <label for="lectura_nota">Nota</label>
          <input type="number" id="lectura_nota" min="0" max="20" step="0.1" placeholder="0-20">
          <small>Opcional</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="lectura_peso">Peso (%)</label>
          <input type="number" id="lectura_peso" min="0" max="100" placeholder="0-100">
          <small>Opcional</small>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancelar" onclick="LecturasModule.cancelarFormulario()">
          Cancelar
        </button>
        <button type="submit" class="btn-submit" id="btnSubmit">
          Guardar Lectura
        </button>
      </div>
    </form>
  </div>

  <!-- Loading -->
  <div id="loadingLecturas" class="loading-lecturas" style="display: none;">
    <div class="estado-vacio-icon">‚è≥</div>
    <div class="estado-vacio-text">Cargando lecturas...</div>
  </div>

  <!-- Estado Vac√≠o -->
  <div id="estadoVacio" class="estado-vacio" style="display: none;">
    <div class="estado-vacio-icon">üìö</div>
    <div class="estado-vacio-text">No hay lecturas registradas</div>
    <div class="estado-vacio-subtext">Haz clic en "Agregar Lectura" para comenzar</div>
  </div>

  <!-- Tabla de Lecturas -->
  <div id="tablaLecturas" class="lecturas-table-container" style="display: none;">
    <table class="lecturas-table">
      <thead>
        <tr>
          <th>CURSO</th>
          <th>LECTURA</th>
          <th>P√ÅGS/D√çA</th>
          <th>P√ÅGINAS</th>
          <th>FECHA EVAL</th>
          <th>NOTA</th>
          <th>PESO</th>
          <th style="text-align: center;">ACCIONES</th>
        </tr>
      </thead>
      <tbody id="tbodyLecturas">
        <!-- Contenido din√°mico -->
      </tbody>
    </table>
  </div>
</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: JAVASCRIPT [INICIO] -->
<script>
(function() {
  'use strict';

  // === VARIABLES GLOBALES ===
  let lecturasData = [];
  let cursosData = [];
  let filtroActual = '';
  let modoEdicion = false;
  let _initDone = false;

  // === INICIALIZACI√ìN ===
  function inicializar() {
    if (_initDone) {
      console.log('üìñ Ya inicializado, saltando...');
      return;
    }

    console.log('üìñ Inicializando LecturasModule V01.22 FIXED...');

    if (typeof currentUser === 'undefined' || !currentUser || !currentUser.codeAlum) {
      console.warn('üìñ currentUser no disponible, reintentando en 200ms...');
      setTimeout(inicializar, 200);
      return;
    }

    _initDone = true;
    console.log('üìñ currentUser detectado:', currentUser.codeAlum);
    cargarCursos();
    cargarLecturas();
  }

  // === CARGAR CURSOS ===
  function cargarCursos() {
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      console.warn('üìñ Google Apps Script no disponible');
      return;
    }

    google.script.run
      .withSuccessHandler(function(response) {
        if (!response || response.success !== true || !Array.isArray(response.data)) {
          console.error('üìñ Error al cargar cursos:', response);
          return;
        }

        cursosData = response.data;
        console.log('üìñ Cursos cargados:', cursosData.length);
        poblarSelectCursos();
      })
      .withFailureHandler(function(error) {
        console.error('üìñ Error al cargar cursos:', error);
      })
      .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
  }

  function poblarSelectCursos() {
    const selectCurso = document.getElementById('lectura_curso');
    const selectFiltro = document.getElementById('filtroCursoLectura');

    if (!selectCurso || !selectFiltro) return;

    // Limpiar
    selectCurso.innerHTML = '<option value="">Seleccionar curso...</option>';
    selectFiltro.innerHTML = '<option value="">Todos los cursos</option>';

    // Poblar
    cursosData.forEach(function(curso) {
      const nombreCurso = String(curso.Curso || '').trim();
      if (!nombreCurso) return;

      const optCurso = document.createElement('option');
      optCurso.value = nombreCurso;
      optCurso.textContent = nombreCurso;
      selectCurso.appendChild(optCurso);

      const optFiltro = document.createElement('option');
      optFiltro.value = nombreCurso;
      optFiltro.textContent = nombreCurso;
      selectFiltro.appendChild(optFiltro);
    });
  }

  // === CARGAR LECTURAS ===
  function cargarLecturas() {
    mostrarLoading();

    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      console.warn('üìñ Google Apps Script no disponible');
      mostrarError('Sistema no disponible');
      return;
    }

    google.script.run
      .withSuccessHandler(function(response) {
        ocultarLoading();

        if (!response || response.success !== true) {
          console.error('üìñ Error al cargar lecturas:', response);
          mostrarError('Error al cargar lecturas');
          return;
        }

        lecturasData = Array.isArray(response.data) ? response.data : [];
        console.log('üìñ Lecturas cargadas:', lecturasData.length);
        
        // CALCULAR P√ÅGS/D√çA para cada lectura
        lecturasData = lecturasData.map(calcularPagsDia);
        
        renderizarTabla();
      })
      .withFailureHandler(function(error) {
        ocultarLoading();
        console.error('üìñ Error:', error);
        mostrarError('Error de conexi√≥n');
      })
      .studentObtenerLecturas({ codeAlum: currentUser.codeAlum });
  }

  // === C√ÅLCULO P√ÅGS/D√çA (L√ìGICA CR√çTICA) ===
  function calcularPagsDia(lectura) {
    const hoy = new Date(2026, 0, 20); // 20/01/2026 (mes 0-indexed)
    const fInicio = parseFecha(lectura.FechaInicio);
    const fFin = parseFecha(lectura.FechaFin);
    const cantPag = safeInt(lectura.CantPag, 0);
    const pagActual = safeInt(lectura.PagActual, 0);
    
    // P√°ginas pendientes
    const pagsPendientes = Math.max(0, cantPag - pagActual);
    
    // Inicio real: lo que sea mayor entre hoy y fecha inicio
    const inicioReal = new Date(Math.max(hoy, fInicio));
    
    // D√≠as disponibles
    const diasDisponibles = Math.ceil((fFin - inicioReal) / (1000 * 60 * 60 * 24));
    
    // C√°lculo
    if (diasDisponibles > 0 && pagsPendientes > 0) {
      lectura.pagsDia = (pagsPendientes / diasDisponibles).toFixed(1);
    } else if (pagsPendientes === 0) {
      lectura.pagsDia = '0.0'; // Lectura completada
    } else {
      lectura.pagsDia = '0.0'; // Sin d√≠as disponibles
    }
    
    return lectura;
  }

  // === PARSEAR FECHA DD/MM/AAAA ===
  function parseFecha(fechaStr) {
    if (!fechaStr || typeof fechaStr !== 'string') return new Date();
    
    const partes = fechaStr.split('/');
    if (partes.length !== 3) return new Date();
    
    const dia = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10) - 1; // Meses 0-indexed
    const anio = parseInt(partes[2], 10);
    
    const fecha = new Date(anio, mes, dia);
    
    // Validar fecha v√°lida
    if (fecha.getFullYear() !== anio || 
        fecha.getMonth() !== mes || 
        fecha.getDate() !== dia) {
      return new Date();
    }
    
    return fecha;
  }

  // === RENDERIZAR TABLA ===
  function renderizarTabla() {
    const tabla = document.getElementById('tablaLecturas');
    const tbody = document.getElementById('tbodyLecturas');
    const estadoVacio = document.getElementById('estadoVacio');

    if (!tabla || !tbody || !estadoVacio) return;

    // Filtrar
    let lecturasFiltradas = lecturasData;
    if (filtroActual && filtroActual !== '' && filtroActual.toLowerCase() !== 'todos') {
      lecturasFiltradas = lecturasData.filter(function(l) {
        return String(l.Curso || '').trim().toUpperCase() === filtroActual.toUpperCase();
      });
    }

    // Sin datos
    if (lecturasFiltradas.length === 0) {
      tabla.style.display = 'none';
      estadoVacio.style.display = 'block';
      
      if (filtroActual && filtroActual !== '') {
        const subtext = estadoVacio.querySelector('.estado-vacio-subtext');
        if (subtext) subtext.textContent = 'No hay lecturas para el curso "' + filtroActual + '"';
      }
      return;
    }

    // Renderizar
    estadoVacio.style.display = 'none';
    tabla.style.display = 'block';

    tbody.innerHTML = lecturasFiltradas.map(function(lectura) {
      const curso = escHtml(lectura.Curso || '');
      const titulo = escHtml(lectura.Lectura || '');
      const cantPag = escHtml(lectura.CantPag || '0');
      const pagActual = escHtml(lectura.PagActual || '0');
      const fechaEval = escHtml(lectura.FechaEval || '-');
      const nota = lectura.Nota && String(lectura.Nota).trim() !== '' ? escHtml(lectura.Nota) : '-';
      const peso = lectura.Peso && String(lectura.Peso).trim() !== '' ? escHtml(lectura.Peso) + '%' : '-';
      const rowNumber = lectura._rowNumber || 0;
      
      // P√°gs/D√≠a con colores
      const pagsDia = lectura.pagsDia || '0.0';
      const pagsDiaNum = parseFloat(pagsDia);
      let clasePagsDia = 'ok';
      if (pagsDiaNum >= 20) clasePagsDia = 'critical';
      else if (pagsDiaNum >= 10) clasePagsDia = 'warning';
      
      // Nota con badge
      const claseNota = obtenerClaseNota(nota);
      const notaBadge = nota !== '-' 
        ? '<span class="nota-badge ' + claseNota + '">' + nota + '</span>'
        : '<span class="nota-badge nota-pendiente">-</span>';

      return `
        <tr>
          <td><span class="curso-tag">${curso}</span></td>
          <td><span class="lectura-titulo">${titulo}</span></td>
          <td><span class="pags-dia ${clasePagsDia}">${pagsDia}</span></td>
          <td>${pagActual} / ${cantPag}</td>
          <td>${fechaEval}</td>
          <td>${notaBadge}</td>
          <td>${peso}</td>
          <td>
            <div class="acciones-container">
              <button class="btn-icon" onclick="LecturasModule.editarLectura(${rowNumber})" title="Editar">
                ‚úèÔ∏è
              </button>
              <button class="btn-icon btn-eliminar" onclick="LecturasModule.eliminarLectura(${rowNumber})" title="Eliminar">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  // === FILTRAR ===
  function aplicarFiltro() {
    const select = document.getElementById('filtroCursoLectura');
    if (!select) return;

    const valor = String(select.value || '').trim();
    filtroActual = (valor === '' || valor.toLowerCase() === 'todos') ? '' : valor;
    
    console.log('üìñ Aplicando filtro:', filtroActual || 'TODOS');
    renderizarTabla();
  }

  // === TOGGLE FORM ===
  function toggleFormAgregar() {
    const form = document.getElementById('formLectura');
    const titulo = document.getElementById('formTitulo');
    const btn = document.getElementById('btnSubmit');

    if (!form) return;

    modoEdicion = false;
    
    if (titulo) titulo.textContent = 'Agregar Lectura';
    if (btn) btn.textContent = 'Guardar Lectura';

    limpiarFormulario();
    form.classList.toggle('active');

    if (form.classList.contains('active')) {
      const selectCurso = document.getElementById('lectura_curso');
      if (selectCurso) setTimeout(function() { selectCurso.focus(); }, 100);
    }
  }

  function cancelarFormulario() {
    const form = document.getElementById('formLectura');
    if (form) form.classList.remove('active');
    limpiarFormulario();
  }

  function limpiarFormulario() {
    setValue('lectura_rowNumber', '');
    setValue('lectura_curso', '');
    setValue('lectura_titulo', '');
    setValue('lectura_cantPag', '');
    setValue('lectura_pagActual', '0');
    setValue('lectura_fechaInicio', '');
    setValue('lectura_fechaFin', '');
    setValue('lectura_fechaEval', '');
    setValue('lectura_nota', '');
    setValue('lectura_peso', '');
  }

  // === SUBMIT LECTURA ===
  function handleSubmitLectura(event) {
    if (event && typeof event.preventDefault === 'function') {
      event.preventDefault();
    }

    const curso = getValueTrim('lectura_curso');
    const titulo = getValueTrim('lectura_titulo');
    const cantPag = getValueTrim('lectura_cantPag');
    const pagActual = getValueTrim('lectura_pagActual');
    const fechaInicio = getValueTrim('lectura_fechaInicio');
    const fechaFin = getValueTrim('lectura_fechaFin');
    const fechaEval = getValueTrim('lectura_fechaEval');
    const nota = getValueTrim('lectura_nota');
    const peso = getValueTrim('lectura_peso');
    const rowNumber = getValueTrim('lectura_rowNumber');

    // Validaciones
    if (!curso || !titulo || !cantPag || !fechaInicio || !fechaFin) {
      showAlertSafe('error', 'Por favor completa todos los campos obligatorios');
      return;
    }

    if (!validarFecha(fechaInicio)) {
      showAlertSafe('error', 'Fecha de inicio inv√°lida (DD/MM/AAAA)');
      return;
    }

    if (!validarFecha(fechaFin)) {
      showAlertSafe('error', 'Fecha de finalizaci√≥n inv√°lida (DD/MM/AAAA)');
      return;
    }

    if (fechaEval && !validarFecha(fechaEval)) {
      showAlertSafe('error', 'Fecha de evaluaci√≥n inv√°lida (DD/MM/AAAA)');
      return;
    }

    const cantPagNum = safeInt(cantPag, 0);
    const pagActualNum = safeInt(pagActual, 0);

    if (cantPagNum <= 0) {
      showAlertSafe('error', 'El total de p√°ginas debe ser mayor a 0');
      return;
    }

    if (pagActualNum < 0 || pagActualNum > cantPagNum) {
      showAlertSafe('error', 'Las p√°ginas le√≠das deben estar entre 0 y ' + cantPagNum);
      return;
    }

    const params = {
      codeAlum: currentUser.codeAlum,
      curso: curso,
      lectura: titulo,
      cantPag: cantPag,
      pagActual: pagActual,
      fechaInicio: fechaInicio,
      fechaFin: fechaFin,
      fechaEval: fechaEval,
      nota: nota,
      peso: peso,
      sem: '' // Ya no usamos semana
    };

    if (modoEdicion && rowNumber) {
      params.rowNumber = safeInt(rowNumber, 0);
      actualizarLectura(params);
    } else {
      agregarLectura(params);
    }
  }

  // === AGREGAR ===
  function agregarLectura(params) {
    google.script.run
      .withSuccessHandler(function(response) {
        if (!response || response.success !== true) {
          console.error('üìñ Error al agregar:', response);
          showAlertSafe('error', 'No se pudo agregar la lectura');
          return;
        }

        showAlertSafe('success', '‚úì Lectura agregada correctamente');
        cancelarFormulario();
        cargarLecturas();
      })
      .withFailureHandler(function(error) {
        console.error('üìñ Error:', error);
        showAlertSafe('error', 'Error de conexi√≥n al agregar lectura');
      })
      .studentAgregarLectura(params);
  }

  // === ACTUALIZAR ===
  function actualizarLectura(params) {
    google.script.run
      .withSuccessHandler(function(response) {
        if (!response || response.success !== true) {
          console.error('üìñ Error al actualizar:', response);
          showAlertSafe('error', 'No se pudo actualizar la lectura');
          return;
        }

        showAlertSafe('success', '‚úì Lectura actualizada correctamente');
        cancelarFormulario();
        cargarLecturas();
      })
      .withFailureHandler(function(error) {
        console.error('üìñ Error:', error);
        showAlertSafe('error', 'Error de conexi√≥n al actualizar lectura');
      })
      .studentActualizarLectura(params);
  }

  // === EDITAR ===
  function editarLectura(rowNumber) {
    const rn = safeInt(rowNumber, 0);
    if (!Number.isFinite(rn) || rn <= 0) {
      showAlertSafe('error', 'No se pudo editar la lectura');
      return;
    }

    const lectura = lecturasData.find(function(l) {
      return safeInt(l && l._rowNumber != null ? l._rowNumber : 0, 0) === rn;
    });

    if (!lectura) {
      showAlertSafe('error', 'Lectura no encontrada');
      return;
    }

    modoEdicion = true;

    setValue('lectura_rowNumber', rn);
    setValue('lectura_curso', lectura.Curso || '');
    setValue('lectura_titulo', lectura.Lectura || '');
    setValue('lectura_cantPag', lectura.CantPag || '');
    setValue('lectura_pagActual', lectura.PagActual || '0');
    setValue('lectura_fechaInicio', lectura.FechaInicio || '');
    setValue('lectura_fechaFin', lectura.FechaFin || '');
    setValue('lectura_fechaEval', lectura.FechaEval || '');
    setValue('lectura_nota', lectura.Nota || '');
    setValue('lectura_peso', lectura.Peso || '');

    const titulo = document.getElementById('formTitulo');
    const btn = document.getElementById('btnSubmit');
    if (titulo) titulo.textContent = 'Editar Lectura';
    if (btn) btn.textContent = 'Actualizar Lectura';

    const formWrap = document.getElementById('formLectura');
    if (formWrap) formWrap.classList.add('active');

    if (formWrap && typeof formWrap.scrollIntoView === 'function') {
      formWrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // === ELIMINAR ===
  function eliminarLectura(rowNumber) {
    const rn = safeInt(rowNumber, 0);
    if (!Number.isFinite(rn) || rn <= 0) {
      showAlertSafe('error', 'No se pudo eliminar la lectura');
      return;
    }

    const lectura = lecturasData.find(function(l) {
      return safeInt(l && l._rowNumber != null ? l._rowNumber : 0, 0) === rn;
    });

    const nombreLectura = lectura && lectura.Lectura ? String(lectura.Lectura) : 'esta lectura';

    if (!confirm('¬øEliminar "' + nombreLectura + '"?\nEsta acci√≥n no se puede deshacer.')) return;

    google.script.run
      .withSuccessHandler(function(response) {
        if (!response || response.success !== true) {
          console.error('üìñ Error eliminar:', response);
          showAlertSafe('error', 'No se pudo eliminar la lectura');
          return;
        }
        showAlertSafe('success', '‚úì Lectura eliminada correctamente');
        cargarLecturas();
      })
      .withFailureHandler(function(error) {
        console.error('üìñ Error al eliminar:', error);
        showAlertSafe('error', 'Error de conexi√≥n al eliminar lectura');
      })
      .studentEliminarLectura({ rowNumber: rn });
  }

  // === HELPERS ===
  function obtenerClaseNota(nota) {
    if (nota == null || String(nota).trim() === '' || nota === '-') return 'nota-pendiente';
    const n = safeFloat(nota, NaN);
    if (!Number.isFinite(n)) return 'nota-pendiente';
    if (n >= 14) return 'nota-alta';
    if (n >= 11) return 'nota-media';
    return 'nota-baja';
  }

  function validarFecha(fecha) {
    if (!fecha) return false;

    const str = String(fecha).trim();
    const regex = /^\d{2}\/\d{2}\/\d{4}$/;
    if (!regex.test(str)) return false;

    const partes = str.split('/');
    const dia = safeInt(partes[0], 0);
    const mes = safeInt(partes[1], 0);
    const anio = safeInt(partes[2], 0);

    if (mes < 1 || mes > 12) return false;
    if (dia < 1 || dia > 31) return false;
    if (anio < 2000 || anio > 2100) return false;

    return true;
  }

  function getValueTrim(id) {
    const el = document.getElementById(id);
    return el && el.value != null ? String(el.value).trim() : '';
  }

  function setValue(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = value != null ? String(value) : '';
  }

  function safeInt(value, fallback) {
    const n = parseInt(value, 10);
    return Number.isFinite(n) ? n : fallback;
  }

  function safeFloat(value, fallback) {
    const n = parseFloat(value);
    return Number.isFinite(n) ? n : fallback;
  }

  function escHtml(str) {
    const s = str == null ? '' : String(str);
    return s
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // === UI HELPERS ===
  function mostrarLoading() {
    const loading = document.getElementById('loadingLecturas');
    const tabla = document.getElementById('tablaLecturas');
    const vacio = document.getElementById('estadoVacio');

    if (loading) loading.style.display = 'block';
    if (tabla) tabla.style.display = 'none';
    if (vacio) vacio.style.display = 'none';
  }

  function ocultarLoading() {
    const loading = document.getElementById('loadingLecturas');
    if (loading) loading.style.display = 'none';
  }

  function mostrarError(mensaje) {
    const estadoVacio = document.getElementById('estadoVacio');
    const tabla = document.getElementById('tablaLecturas');
    const loading = document.getElementById('loadingLecturas');

    if (loading) loading.style.display = 'none';
    if (tabla) tabla.style.display = 'none';

    if (!estadoVacio) return;

    const icon = estadoVacio.querySelector('.estado-vacio-icon');
    const text = estadoVacio.querySelector('.estado-vacio-text');
    const sub = estadoVacio.querySelector('.estado-vacio-subtext');

    estadoVacio.style.display = 'block';
    if (icon) icon.textContent = '‚ö†Ô∏è';
    if (text) text.textContent = 'Error';
    if (sub) sub.textContent = mensaje;
  }

  // === ALERTAS ===
  function showAlertSafe(type, message) {
    if (typeof showAlert === 'function') {
      showAlert(type, message);
      return;
    }
    if (type === 'error') console.error(message);
    else console.log(message);
  }

  if (typeof showAlert === 'undefined') {
    window.showAlert = function(type, message) {
      const alertBox = document.createElement('div');
      alertBox.className = 'alert alert-' + type;
      alertBox.textContent = message;
      alertBox.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        font-size: 14px;
        font-weight: 500;
        animation: slideIn 0.3s;
        ${type === 'success' ? 'background: #d4edda; color: #155724; border-left: 4px solid #28a745;' : ''}
        ${type === 'error' ? 'background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545;' : ''}
        ${type === 'warning' ? 'background: #fff3cd; color: #856404; border-left: 4px solid #ffc107;' : ''}
        ${type === 'info' ? 'background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8;' : ''}
      `;

      document.body.appendChild(alertBox);

      setTimeout(function() { alertBox.remove(); }, 4000);
    };

    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }

  console.log('%cüìñ LecturasModule V01.22 FIXED cargado', 'font-size:11px;color:#667eea;font-weight:bold');

  // === API P√öBLICA ===
  window.LecturasModule = {
    inicializar: inicializar,
    aplicarFiltro: aplicarFiltro,
    toggleFormAgregar: toggleFormAgregar,
    handleSubmitLectura: handleSubmitLectura,
    editarLectura: editarLectura,
    eliminarLectura: eliminarLectura,
    cancelarFormulario: cancelarFormulario,
    recargar: cargarLecturas
  };

  // === AUTO-INIT ===
  setTimeout(function() {
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
      console.log('üìñ currentUser detectado, auto-inicializando...');
      inicializar();
    } else {
      console.log('üìñ currentUser no disponible, iniciando retry logic...');
      inicializar();
    }
  }, 150);

})();
</script>
<!-- MOD-004: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCI√ìN:
Gesti√≥n completa de lecturas acad√©micas con c√°lculo din√°mico de P√°gs/D√≠a

CAMBIOS V01.21 ‚Üí V01.22 FIXED:
‚úÖ MANTIENE tabla con filas (NO cards)
‚úÖ ELIMINA columna "Progreso" (barra visual)
‚úÖ ELIMINA columna "Semana" (solo backend)
‚úÖ AGREGA columna "P√°gs/D√≠a" con c√°lculo din√°mico y colores
‚úÖ CONSERVA bot√≥n "+Agregar Lectura" con gradiente morado
‚úÖ CONSERVA botones Editar (‚úèÔ∏è) y Eliminar (üóëÔ∏è)
‚úÖ INTEGRA l√≥gica LecturasHelpers para parseo de fechas

C√ÅLCULO P√ÅGS/D√çA:
- P√°ginas pendientes = CantPag - PagActual
- Inicio real = MAX(hoy, FechaInicio)
- D√≠as disponibles = (FechaFin - InicioReal) en d√≠as
- P√°gs/D√≠a = PagsPendientes √∑ D√≠asDisponibles
- Fecha hoy: 20/01/2026 (hardcoded en calcularPagsDia)

COLORES P√ÅGS/D√çA:
- Verde (ok): < 10 p√°ginas/d√≠a
- Amarillo (warning): 10-19 p√°ginas/d√≠a  
- Rojo (critical): ‚â• 20 p√°ginas/d√≠a

COLUMNAS DE LA TABLA:
1. CURSO - Tag coloreado
2. LECTURA - T√≠tulo en negrita
3. P√ÅGS/D√çA - Badge con color seg√∫n urgencia
4. P√ÅGINAS - Formato "X / Y"
5. FECHA EVAL - DD/MM/AAAA o "-"
6. NOTA - Badge coloreado (alta/media/baja/pendiente)
7. PESO - Porcentaje o "-"
8. ACCIONES - Botones Editar/Eliminar

FUNCIONALIDAD COMPLETA:
‚úÖ CRUD completo (Create, Read, Update, Delete)
‚úÖ Filtro por curso con dropdown din√°mico
‚úÖ Formulario desplegable animado
‚úÖ Validaci√≥n exhaustiva de fechas (DD/MM/AAAA)
‚úÖ Validaci√≥n de rangos (p√°ginas, nota, peso)
‚úÖ Retry logic para currentUser
‚úÖ Estados UI: Loading, Vac√≠o, Error
‚úÖ Sistema de alertas (success/error/warning)

BACKEND DEPENDENCIES:
- studentObtenerLecturas({ codeAlum })
- studentObtenerCursos({ codeAlum })
- studentAgregarLectura({ ...params })
- studentActualizarLectura({ ...params, rowNumber })
- studentEliminarLectura({ rowNumber })

INTEGRACI√ìN:
- Requiere: currentUser.codeAlum
- Opcional: showAlert() global
- Encapsulado: IIFE con window.LecturasModule
- Auto-init: 150ms delay
-->
<!-- MOD-099: FIN -->
