<!--
******************************************
PBE CONTROL - 6btablecturas.html - V01.17
Sistema de Gesti√≥n Acad√©mica
05/01/2026

DESCRIPCI√ìN:
Sub-tab de Lecturas con gesti√≥n completa (CRUD) de lecturas
asignadas al estudiante. Incluye barra de progreso visual para
seguimiento de p√°ginas le√≠das.

FUNCIONALIDAD:
- Listar todas las lecturas del estudiante
- Filtrar lecturas por curso
- Agregar nueva lectura con validaci√≥n
- Editar lectura existente
- Eliminar lectura con confirmaci√≥n
- Visualizaci√≥n de progreso mediante barra (PagActual/CantPag)
- Colores din√°micos en notas (verde/amarillo/rojo)
- Estados: loading, vac√≠o, error

CAMPOS DE LECTURA:
- Curso: Curso al que pertenece la lectura (FK) *required
- Lectura: T√≠tulo del libro/texto *required
- CantPag: Total de p√°ginas del libro *required
- PagActual: P√°ginas le√≠das hasta ahora *required (default: 0)
- FechaInicio: Fecha de inicio de lectura (DD/MM/AAAA) *required
- FechaFin: Fecha programada de finalizaci√≥n (DD/MM/AAAA) *required
- FechaEval: Fecha de evaluaci√≥n sobre la lectura (DD/MM/AAAA) optional
- Nota: Calificaci√≥n obtenida (0-20) optional
- Peso: Porcentaje de peso en la nota final (0-100) optional
- Sem: N√∫mero de semana (1-52) optional

BACKEND:
- studentObtenerLecturas({ codeAlum })
- studentAgregarLectura({ codeAlum, curso, lectura, cantPag, pagActual, ... })
- studentActualizarLectura({ codeAlum, rowNumber, curso, lectura, ... })
- studentEliminarLectura({ rowNumber })

VALIDACIONES BACKEND:
- Curso + Lectura DEBE ser √∫nico por estudiante
- Error: "La lectura '[t√≠tulo]' ya existe en [curso]"

VALIDACIONES FRONTEND:
- Campos obligatorios: Curso, Lectura, CantPag, PagActual, FechaInicio, FechaFin
- Formato de fecha: DD/MM/AAAA (regex)
- CantPag: N√∫mero entero > 0
- PagActual: 0 ‚â§ PagActual ‚â§ CantPag
- Nota: 0-20 (decimal, 2 decimales max)
- Peso: 0-100 (entero)
- Sem: Entero > 0

COLORES DIN√ÅMICOS:
- Nota >= 14: Verde (#28a745)
- Nota 11-13: Amarillo (#ffc107)
- Nota < 11: Rojo (#dc3545)

DIFERENCIA vs EVALUACIONES/TAREAS:
‚ö†Ô∏è BARRA DE PROGRESO VISUAL
- C√°lculo: (PagActual / CantPag) √ó 100
- Gradiente: linear-gradient(90deg, #667eea 0%, #764ba2 100%)
- Altura: 20px en tabla, 8px en vista Todos
- Muestra porcentaje en texto junto a la barra

CONECTA CON:
- Parent: 4btabdeberes.html (contenedor con sub-tabs)
- Backend: studentObtenerLecturas, studentAgregarLectura, etc. (1code.gs)
- Module: Student.obtenerLecturas, Student.agregarLectura (1student.gs)

üîë IMPORTANTE:
- Validar currentUser antes de cualquier operaci√≥n
- Mostrar errores de forma amigable (NUNCA error.toString())
- La barra de progreso es el elemento diferenciador clave
- PagActual es actualizable (permite marcar progreso)
- Responsive: Ocultar columna Semana en mobile
******************************************
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ==========================================
       6BTABLECTURAS.HTML - ESTILOS
       Gesti√≥n de Lecturas con Barra de Progreso
       ========================================== */
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* ==========================================
       CONTENEDOR PRINCIPAL
       ========================================== */
    
    .lecturas-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* ==========================================
       HEADER
       ========================================== */
    
    .lecturas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .lecturas-header h2 {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    /* ==========================================
       FILTROS
       ========================================== */
    
    .filtro-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .filtro-container label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }
    
    .filtro-container select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      min-width: 180px;
    }
    
    .filtro-container select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* ==========================================
       BOTONES
       ========================================== */
    
    .btn-agregar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-agregar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-agregar:active {
      transform: translateY(0);
    }
    
    /* ==========================================
       FORMULARIO
       ========================================== */
    
    .form-lectura {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    
    .form-lectura.active {
      display: block;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .form-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .btn-cerrar-form {
      background: transparent;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .btn-cerrar-form:hover {
      background: #f0f0f0;
      color: #333;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .form-row.full-width {
      grid-template-columns: 1fr;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .form-group label .required {
      color: #dc3545;
      margin-left: 4px;
    }
    
    .form-group input,
    .form-group select {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group input::placeholder {
      color: #999;
    }
    
    .form-group small {
      font-size: 12px;
      color: #666;
      font-style: italic;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-cancelar {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-cancelar:hover {
      background: #e8e8e8;
    }
    
    /* ==========================================
       TABLA
       ========================================== */
    
    .lecturas-table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .lecturas-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .lecturas-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .lecturas-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .lecturas-table tbody tr {
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s;
    }
    
    .lecturas-table tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    .lecturas-table tbody tr:hover {
      background: #e9ecef;
    }
    
    .lecturas-table td {
      padding: 14px 16px;
      font-size: 14px;
      color: #333;
    }
    
    /* ==========================================
       CURSO TAG
       ========================================== */
    
    .curso-tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      background: #e9ecef;
      color: #495057;
    }
    
    /* ==========================================
       T√çTULO LECTURA
       ========================================== */
    
    .lectura-titulo {
      font-weight: 600;
      color: #333;
    }
    
    /* ==========================================
       BARRA DE PROGRESO (DIFERENCIADOR)
       ========================================== */
    
    .progreso-cell {
      min-width: 180px;
    }
    
    .progreso-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .barra-progreso {
      flex: 1;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    
    .barra-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      border-radius: 10px;
    }
    
    .progreso-text {
      font-size: 13px;
      font-weight: 600;
      color: #667eea;
      min-width: 45px;
      text-align: right;
    }
    
    /* ==========================================
       P√ÅGINAS
       ========================================== */
    
    .paginas-cell {
      font-size: 13px;
      color: #666;
      white-space: nowrap;
    }
    
    /* ==========================================
       FECHA
       ========================================== */
    
    .fecha-cell {
      white-space: nowrap;
      font-size: 13px;
      color: #666;
    }
    
    /* ==========================================
       NOTA CON COLORES DIN√ÅMICOS
       ========================================== */
    
    .nota-cell {
      text-align: center;
      font-weight: 600;
      font-size: 15px;
    }
    
    .nota-alta {
      color: #28a745;
    }
    
    .nota-media {
      color: #ffc107;
    }
    
    .nota-baja {
      color: #dc3545;
    }
    
    .nota-pendiente {
      color: #999;
      font-weight: 400;
    }
    
    /* ==========================================
       PESO
       ========================================== */
    
    .peso-cell {
      text-align: center;
      color: #666;
      font-size: 13px;
    }
    
    /* ==========================================
       SEMANA
       ========================================== */
    
    .sem-cell {
      text-align: center;
      color: #666;
      font-size: 13px;
    }
    
    /* ==========================================
       ACCIONES
       ========================================== */
    
    .acciones-cell {
      text-align: center;
      white-space: nowrap;
    }
    
    .btn-icon {
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .btn-icon:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }
    
    .btn-icon:active {
      transform: scale(0.95);
    }
    
    /* ==========================================
       LOADING
       ========================================== */
    
    .loading-container {
      text-align: center;
      padding: 60px 20px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 14px;
    }
    
    /* ==========================================
       ESTADO VAC√çO
       ========================================== */
    
    .estado-vacio {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .estado-vacio-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .estado-vacio-text {
      font-size: 16px;
      margin-bottom: 8px;
      color: #666;
    }
    
    .estado-vacio-subtext {
      font-size: 14px;
      color: #999;
    }
    
    /* ==========================================
       RESPONSIVE
       ========================================== */
    
    @media (max-width: 1024px) {
      .lecturas-container {
        padding: 16px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      /* Ocultar columna Semana en tablets */
      .lecturas-table .col-sem {
        display: none;
      }
    }
    
    @media (max-width: 768px) {
      .lecturas-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .lecturas-header h2 {
        font-size: 20px;
      }
      
      .header-actions {
        width: 100%;
        flex-direction: column;
      }
      
      .filtro-container {
        width: 100%;
      }
      
      .filtro-container select {
        width: 100%;
      }
      
      .btn-agregar {
        width: 100%;
        justify-content: center;
      }
      
      .form-lectura {
        padding: 16px;
      }
      
      .lecturas-table {
        font-size: 13px;
      }
      
      .lecturas-table th,
      .lecturas-table td {
        padding: 10px 12px;
      }
      
      /* Progreso m√°s compacto en mobile */
      .barra-progreso {
        height: 16px;
      }
      
      .progreso-text {
        font-size: 12px;
        min-width: 40px;
      }
    }
  </style>
</head>
<body>
  
  <!-- ==========================================
       CONTENEDOR PRINCIPAL
       ========================================== -->
  
  <div class="lecturas-container">
    
    <!-- Header con Filtros y Bot√≥n Agregar -->
    <div class="lecturas-header">
      <h2>üìñ Lecturas</h2>
      
      <div class="header-actions">
        <!-- Filtro por Curso -->
        <div class="filtro-container">
          <label for="filtroCurso">Filtrar por curso:</label>
          <select id="filtroCurso" onchange="aplicarFiltro()">
            <option value="todos">Todos los cursos</option>
          </select>
        </div>
        
        <!-- Bot√≥n Agregar -->
        <button class="btn-agregar" onclick="toggleFormAgregar()">
          <span>‚ûï</span>
          <span>Agregar Lectura</span>
        </button>
      </div>
    </div>
    
    <!-- Formulario de Agregar/Editar -->
    <div id="formLectura" class="form-lectura">
      <div class="form-header">
        <h3 id="formTitulo">Agregar Lectura</h3>
        <button class="btn-cerrar-form" onclick="cancelarFormulario()" title="Cerrar">√ó</button>
      </div>
      
      <form id="lecturaForm" onsubmit="handleSubmitLectura(event)">
        <!-- Hidden fields para edici√≥n -->
        <input type="hidden" id="lecturaRowNumber" value="">
        <input type="hidden" id="lecturaModoEdicion" value="false">
        
        <!-- Fila 1: Curso y Lectura -->
        <div class="form-row">
          <div class="form-group">
            <label for="inputCurso">
              Curso
              <span class="required">*</span>
            </label>
            <select id="inputCurso" required>
              <option value="">Seleccionar curso...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="inputLectura">
              T√≠tulo de la Lectura
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="inputLectura" 
              placeholder="Ej: El Principito"
              maxlength="100"
              required
            >
          </div>
        </div>
        
        <!-- Fila 2: CantPag y PagActual -->
        <div class="form-row">
          <div class="form-group">
            <label for="inputCantPag">
              Total de P√°ginas
              <span class="required">*</span>
            </label>
            <input 
              type="number" 
              id="inputCantPag" 
              placeholder="Ej: 200"
              min="1"
              max="10000"
              required
            >
            <small>N√∫mero total de p√°ginas del libro</small>
          </div>
          
          <div class="form-group">
            <label for="inputPagActual">
              P√°ginas Le√≠das
              <span class="required">*</span>
            </label>
            <input 
              type="number" 
              id="inputPagActual" 
              placeholder="Ej: 50"
              min="0"
              value="0"
              required
            >
            <small>P√°ginas que ya has le√≠do</small>
          </div>
        </div>
        
        <!-- Fila 3: FechaInicio y FechaFin -->
        <div class="form-row">
          <div class="form-group">
            <label for="inputFechaInicio">
              Fecha de Inicio
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="inputFechaInicio" 
              placeholder="DD/MM/AAAA"
              pattern="\d{2}/\d{2}/\d{4}"
              required
            >
            <small>Formato: DD/MM/AAAA</small>
          </div>
          
          <div class="form-group">
            <label for="inputFechaFin">
              Fecha de Finalizaci√≥n
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="inputFechaFin" 
              placeholder="DD/MM/AAAA"
              pattern="\d{2}/\d{2}/\d{4}"
              required
            >
            <small>Fecha programada de finalizaci√≥n</small>
          </div>
        </div>
        
        <!-- Fila 4: FechaEval y Nota -->
        <div class="form-row">
          <div class="form-group">
            <label for="inputFechaEval">
              Fecha de Evaluaci√≥n
            </label>
            <input 
              type="text" 
              id="inputFechaEval" 
              placeholder="DD/MM/AAAA"
              pattern="\d{2}/\d{2}/\d{4}"
            >
            <small>Opcional - Formato: DD/MM/AAAA</small>
          </div>
          
          <div class="form-group">
            <label for="inputNota">
              Nota
            </label>
            <input 
              type="number" 
              id="inputNota" 
              placeholder="Ej: 15.5"
              min="0"
              max="20"
              step="0.01"
            >
            <small>Opcional - Calificaci√≥n de 0 a 20</small>
          </div>
        </div>
        
        <!-- Fila 5: Peso y Semana -->
        <div class="form-row">
          <div class="form-group">
            <label for="inputPeso">
              Peso (%)
            </label>
            <input 
              type="number" 
              id="inputPeso" 
              placeholder="Ej: 20"
              min="0"
              max="100"
              step="1"
            >
            <small>Opcional - Porcentaje de peso en la nota final</small>
          </div>
          
          <div class="form-group">
            <label for="inputSem">
              Semana
            </label>
            <input 
              type="number" 
              id="inputSem" 
              placeholder="Ej: 5"
              min="1"
              max="52"
              step="1"
            >
            <small>Opcional - N√∫mero de semana (1-52)</small>
          </div>
        </div>
        
        <!-- Botones del Formulario -->
        <div class="form-actions">
          <button type="button" class="btn-cancelar" onclick="cancelarFormulario()">
            Cancelar
          </button>
          <button type="submit" class="btn-submit" id="btnSubmit">
            Guardar Lectura
          </button>
        </div>
      </form>
    </div>
    
    <!-- Tabla de Lecturas -->
    <div class="lecturas-table-container">
      
      <!-- Loading -->
      <div id="loadingLecturas" class="loading-container" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Cargando lecturas...</div>
      </div>
      
      <!-- Estado Vac√≠o -->
      <div id="estadoVacio" class="estado-vacio" style="display: none;">
        <div class="estado-vacio-icon">üìö</div>
        <div class="estado-vacio-text">No hay lecturas registradas</div>
        <div class="estado-vacio-subtext">Haz clic en "Agregar Lectura" para comenzar</div>
      </div>
      
      <!-- Tabla -->
      <table class="lecturas-table" id="tablaLecturas" style="display: none;">
        <thead>
          <tr>
            <th>Curso</th>
            <th>Lectura</th>
            <th>Progreso</th>
            <th>P√°ginas</th>
            <th>Fecha Eval</th>
            <th>Nota</th>
            <th class="col-peso">Peso</th>
            <th class="col-sem">Semana</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="lecturasTableBody">
          <!-- Filas din√°micas -->
        </tbody>
      </table>
      
    </div>
    
  </div>
  
  <!-- ==========================================
       JAVASCRIPT
       ========================================== -->
  
  <script>
    // ==========================================
    // VARIABLES LOCALES
    // ==========================================
    
    let lecturasData = [];
    let cursosData = [];
    let lecturasFiltradas = [];
    
    // ==========================================
    // INICIALIZACI√ìN
    // ==========================================
    
    window.addEventListener('DOMContentLoaded', function() {
      // Validaci√≥n robusta de currentUser con retry
      if (typeof currentUser !== 'undefined' && currentUser.codeAlum) {
        inicializarLecturas();
      } else {
        // Reintentar despu√©s de 100ms (el padre puede estar cargando)
        setTimeout(function() {
          if (typeof currentUser !== 'undefined' && currentUser.codeAlum) {
            inicializarLecturas();
          } else {
            console.error('[6btablecturas] currentUser no disponible');
            mostrarError('No se pudo identificar al usuario. Por favor, recarga la p√°gina.');
          }
        }, 100);
      }
    });
    
    /**
     * Inicializar m√≥dulo de lecturas
     */
    function inicializarLecturas() {
      cargarCursos();
      cargarLecturas();
      
      console.log('%cüìñ Sub-tab Lecturas Cargado', 'font-size: 11px; color: #667eea;');
    }
    
    // ==========================================
    // CARGAR CURSOS
    // ==========================================
    
    /**
     * Cargar cursos del estudiante
     */
    function cargarCursos() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            cursosData = response.data;
            poblarDropdownCursos();
          } else {
            console.error('Error al cargar cursos:', response.error);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error de conexi√≥n al cargar cursos:', error);
        })
        .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
    }
    
    /**
     * Poblar dropdown de cursos
     */
    function poblarDropdownCursos() {
      const selectCurso = document.getElementById('inputCurso');
      const selectFiltro = document.getElementById('filtroCurso');
      
      // Guardar primera opci√≥n
      const primerOption = selectCurso.options[0].outerHTML;
      const primerOptionFiltro = selectFiltro.options[0].outerHTML;
      
      // Limpiar y agregar cursos
      selectCurso.innerHTML = primerOption;
      selectFiltro.innerHTML = primerOptionFiltro;
      
      cursosData.forEach(function(curso) {
        // Select del formulario
        const option = document.createElement('option');
        option.value = curso.Curso;
        option.textContent = curso.Curso + ' - ' + curso.Completo;
        selectCurso.appendChild(option);
        
        // Select del filtro
        const optionFiltro = document.createElement('option');
        optionFiltro.value = curso.Curso;
        optionFiltro.textContent = curso.Curso;
        selectFiltro.appendChild(optionFiltro);
      });
    }
    
    // ==========================================
    // CARGAR LECTURAS
    // ==========================================
    
    /**
     * Cargar lecturas del estudiante
     */
    function cargarLecturas() {
      // Mostrar loading
      document.getElementById('loadingLecturas').style.display = 'block';
      document.getElementById('estadoVacio').style.display = 'none';
      document.getElementById('tablaLecturas').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(handleLecturasLoaded)
        .withFailureHandler(function(error) {
          document.getElementById('loadingLecturas').style.display = 'none';
          mostrarError('Error de conexi√≥n al cargar lecturas');
          console.error('Error:', error);
        })
        .studentObtenerLecturas({ codeAlum: currentUser.codeAlum });
    }
    
    /**
     * Manejar respuesta de lecturas cargadas
     */
    function handleLecturasLoaded(response) {
      document.getElementById('loadingLecturas').style.display = 'none';
      
      if (response.success) {
        lecturasData = response.data;
        aplicarFiltro();
      } else {
        mostrarError(response.error || 'Error al cargar lecturas');
        document.getElementById('estadoVacio').style.display = 'block';
      }
    }
    
    // ==========================================
    // FILTRAR LECTURAS
    // ==========================================
    
    /**
     * Aplicar filtro por curso
     */
    function aplicarFiltro() {
      const filtroCurso = document.getElementById('filtroCurso').value;
      
      if (filtroCurso === 'todos') {
        lecturasFiltradas = lecturasData;
      } else {
        lecturasFiltradas = lecturasData.filter(function(lectura) {
          return lectura.Curso === filtroCurso;
        });
      }
      
      renderLecturasTable();
    }
    
    // ==========================================
    // RENDERIZAR TABLA
    // ==========================================
    
    /**
     * Renderizar tabla de lecturas
     */
    function renderLecturasTable() {
      const tbody = document.getElementById('lecturasTableBody');
      const tabla = document.getElementById('tablaLecturas');
      const estadoVacio = document.getElementById('estadoVacio');
      
      // Si no hay lecturas, mostrar estado vac√≠o
      if (lecturasFiltradas.length === 0) {
        tabla.style.display = 'none';
        estadoVacio.style.display = 'block';
        return;
      }
      
      // Mostrar tabla
      estadoVacio.style.display = 'none';
      tabla.style.display = 'table';
      
      // Construir filas HTML
      let html = '';
      
      lecturasFiltradas.forEach(function(lectura) {
        // Calcular progreso
        const progreso = calcularProgreso(lectura.PagActual, lectura.CantPag);
        const claseNota = obtenerClaseNota(lectura.Nota);
        
        html += '<tr>';
        
        // Curso
        html += '<td>';
        html += '<span class="curso-tag">' + lectura.Curso + '</span>';
        html += '</td>';
        
        // Lectura (t√≠tulo en negrita)
        html += '<td>';
        html += '<span class="lectura-titulo">' + lectura.Lectura + '</span>';
        html += '</td>';
        
        // Progreso (BARRA VISUAL - DIFERENCIADOR)
        html += '<td class="progreso-cell">';
        html += '<div class="progreso-container">';
        html += '<div class="barra-progreso">';
        html += '<div class="barra-fill" style="width: ' + progreso + '%"></div>';
        html += '</div>';
        html += '<span class="progreso-text">' + progreso.toFixed(0) + '%</span>';
        html += '</div>';
        html += '</td>';
        
        // P√°ginas (Actual/Total)
        html += '<td class="paginas-cell">';
        html += lectura.PagActual + ' / ' + lectura.CantPag;
        html += '</td>';
        
        // Fecha Evaluaci√≥n
        html += '<td class="fecha-cell">';
        html += lectura.FechaEval || '-';
        html += '</td>';
        
        // Nota (con colores din√°micos)
        html += '<td class="nota-cell ' + claseNota + '">';
        html += lectura.Nota || '-';
        html += '</td>';
        
        // Peso
        html += '<td class="peso-cell col-peso">';
        html += lectura.Peso ? lectura.Peso + '%' : '-';
        html += '</td>';
        
        // Semana
        html += '<td class="sem-cell col-sem">';
        html += lectura.Sem || '-';
        html += '</td>';
        
        // Acciones
        html += '<td class="acciones-cell">';
        html += '<button class="btn-icon" onclick="editarLectura(' + lectura._rowNumber + ')" title="Editar">';
        html += '‚úèÔ∏è';
        html += '</button>';
        html += '<button class="btn-icon" onclick="eliminarLectura(' + lectura._rowNumber + ')" title="Eliminar">';
        html += 'üóëÔ∏è';
        html += '</button>';
        html += '</td>';
        
        html += '</tr>';
      });
      
      tbody.innerHTML = html;
    }
    
    // ==========================================
    // TOGGLE FORMULARIO
    // ==========================================
    
    /**
     * Mostrar/Ocultar formulario de agregar
     */
    function toggleFormAgregar() {
      const form = document.getElementById('formLectura');
      
      if (form.classList.contains('active')) {
        form.classList.remove('active');
      } else {
        // Resetear formulario para modo agregar
        resetFormulario();
        document.getElementById('formTitulo').textContent = 'Agregar Lectura';
        document.getElementById('lecturaModoEdicion').value = 'false';
        document.getElementById('btnSubmit').textContent = 'Guardar Lectura';
        
        form.classList.add('active');
        
        // Focus en primer campo
        setTimeout(function() {
          document.getElementById('inputCurso').focus();
        }, 300);
      }
    }
    
    // ==========================================
    // SUBMIT FORMULARIO
    // ==========================================
    
    /**
     * Manejar submit del formulario
     */
    function handleSubmitLectura(event) {
      event.preventDefault();
      
      // Obtener valores del formulario
      const curso = document.getElementById('inputCurso').value.trim();
      const lectura = document.getElementById('inputLectura').value.trim();
      const cantPag = parseInt(document.getElementById('inputCantPag').value);
      const pagActual = parseInt(document.getElementById('inputPagActual').value);
      const fechaInicio = document.getElementById('inputFechaInicio').value.trim();
      const fechaFin = document.getElementById('inputFechaFin').value.trim();
      const fechaEval = document.getElementById('inputFechaEval').value.trim();
      const nota = document.getElementById('inputNota').value.trim();
      const peso = document.getElementById('inputPeso').value.trim();
      const sem = document.getElementById('inputSem').value.trim();
      
      // Validaciones frontend
      if (!curso) {
        showAlert('error', 'Selecciona un curso');
        return;
      }
      
      if (!lectura) {
        showAlert('error', 'Ingresa el t√≠tulo de la lectura');
        return;
      }
      
      if (!cantPag || cantPag <= 0) {
        showAlert('error', 'Ingresa el total de p√°ginas (mayor a 0)');
        return;
      }
      
      if (pagActual < 0 || pagActual > cantPag) {
        showAlert('error', 'Las p√°ginas le√≠das deben estar entre 0 y ' + cantPag);
        return;
      }
      
      if (!validarFecha(fechaInicio)) {
        showAlert('error', 'Fecha de inicio inv√°lida. Formato: DD/MM/AAAA');
        return;
      }
      
      if (!validarFecha(fechaFin)) {
        showAlert('error', 'Fecha de finalizaci√≥n inv√°lida. Formato: DD/MM/AAAA');
        return;
      }
      
      if (fechaEval && !validarFecha(fechaEval)) {
        showAlert('error', 'Fecha de evaluaci√≥n inv√°lida. Formato: DD/MM/AAAA');
        return;
      }
      
      if (nota && (parseFloat(nota) < 0 || parseFloat(nota) > 20)) {
        showAlert('error', 'La nota debe estar entre 0 y 20');
        return;
      }
      
      if (peso && (parseInt(peso) < 0 || parseInt(peso) > 100)) {
        showAlert('error', 'El peso debe estar entre 0 y 100');
        return;
      }
      
      // Preparar datos
      const params = {
        codeAlum: currentUser.codeAlum,
        curso: curso,
        lectura: lectura,
        cantPag: cantPag,
        pagActual: pagActual,
        fechaInicio: fechaInicio,
        fechaFin: fechaFin,
        fechaEval: fechaEval || '',
        nota: nota || '',
        peso: peso || '',
        sem: sem || ''
      };
      
      // Verificar si es edici√≥n
      const modoEdicion = document.getElementById('lecturaModoEdicion').value === 'true';
      
      if (modoEdicion) {
        // ACTUALIZAR
        params.rowNumber = parseInt(document.getElementById('lecturaRowNumber').value);
        
        google.script.run
          .withSuccessHandler(handleLecturaGuardada)
          .withFailureHandler(function(error) {
            showAlert('error', 'Error de conexi√≥n al actualizar lectura');
            console.error('Error:', error);
          })
          .studentActualizarLectura(params);
      } else {
        // AGREGAR
        google.script.run
          .withSuccessHandler(handleLecturaGuardada)
          .withFailureHandler(function(error) {
            showAlert('error', 'Error de conexi√≥n al guardar lectura');
            console.error('Error:', error);
          })
          .studentAgregarLectura(params);
      }
    }
    
    /**
     * Manejar respuesta de lectura guardada
     */
    function handleLecturaGuardada(response) {
      if (response.success) {
        showAlert('success', '‚úì Lectura guardada correctamente');
        cancelarFormulario();
        cargarLecturas();
      } else {
        // Mostrar error de forma amigable
        if (response.error.indexOf('ya existe') !== -1) {
          showAlert('error', response.error);
        } else {
          showAlert('error', 'No se pudo guardar la lectura. Verifica los datos e intenta nuevamente.');
        }
      }
    }
    
    // ==========================================
    // EDITAR LECTURA
    // ==========================================
    
    /**
     * Editar lectura existente
     */
    function editarLectura(rowNumber) {
      // Buscar lectura en el array
      const lectura = lecturasData.find(function(l) {
        return l._rowNumber === rowNumber;
      });
      
      if (!lectura) {
        showAlert('error', 'No se encontr√≥ la lectura');
        return;
      }
      
      // Poblar formulario
      document.getElementById('inputCurso').value = lectura.Curso || '';
      document.getElementById('inputLectura').value = lectura.Lectura || '';
      document.getElementById('inputCantPag').value = lectura.CantPag || '';
      document.getElementById('inputPagActual').value = lectura.PagActual || 0;
      document.getElementById('inputFechaInicio').value = lectura.FechaInicio || '';
      document.getElementById('inputFechaFin').value = lectura.FechaFin || '';
      document.getElementById('inputFechaEval').value = lectura.FechaEval || '';
      document.getElementById('inputNota').value = lectura.Nota || '';
      document.getElementById('inputPeso').value = lectura.Peso || '';
      document.getElementById('inputSem').value = lectura.Sem || '';
      
      // Configurar modo edici√≥n
      document.getElementById('lecturaRowNumber').value = rowNumber;
      document.getElementById('lecturaModoEdicion').value = 'true';
      document.getElementById('formTitulo').textContent = 'Editar Lectura';
      document.getElementById('btnSubmit').textContent = 'Actualizar Lectura';
      
      // Mostrar formulario
      document.getElementById('formLectura').classList.add('active');
      
      // Scroll al formulario
      document.getElementById('formLectura').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }
    
    // ==========================================
    // ELIMINAR LECTURA
    // ==========================================
    
    /**
     * Eliminar lectura con confirmaci√≥n
     */
    function eliminarLectura(rowNumber) {
      // Buscar lectura para mostrar nombre en confirmaci√≥n
      const lectura = lecturasData.find(function(l) {
        return l._rowNumber === rowNumber;
      });
      
      const nombreLectura = lectura ? lectura.Lectura : 'esta lectura';
      
      if (!confirm('¬øEliminar "' + nombreLectura + '"?\nEsta acci√≥n no se puede deshacer.')) {
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            showAlert('success', '‚úì Lectura eliminada correctamente');
            cargarLecturas();
          } else {
            showAlert('error', 'No se pudo eliminar la lectura');
          }
        })
        .withFailureHandler(function(error) {
          showAlert('error', 'Error de conexi√≥n al eliminar lectura');
          console.error('Error:', error);
        })
        .studentEliminarLectura({ rowNumber: rowNumber });
    }
    
    // ==========================================
    // RESET Y CANCELAR FORMULARIO
    // ==========================================
    
    /**
     * Resetear formulario
     */
    function resetFormulario() {
      document.getElementById('lecturaForm').reset();
      document.getElementById('lecturaRowNumber').value = '';
      document.getElementById('lecturaModoEdicion').value = 'false';
      document.getElementById('inputPagActual').value = '0';
    }
    
    /**
     * Cancelar y ocultar formulario
     */
    function cancelarFormulario() {
      document.getElementById('formLectura').classList.remove('active');
      resetFormulario();
    }
    
    // ==========================================
    // FUNCIONES AUXILIARES
    // ==========================================
    
    /**
     * Calcular progreso de lectura
     */
    function calcularProgreso(pagActual, cantPag) {
      if (!cantPag || cantPag === 0) return 0;
      const progreso = (pagActual / cantPag) * 100;
      return Math.min(100, Math.max(0, progreso)); // Clamp entre 0-100
    }
    
    /**
     * Obtener clase CSS seg√∫n nota
     */
    function obtenerClaseNota(nota) {
      if (!nota) return 'nota-pendiente';
      
      const notaNum = parseFloat(nota);
      
      if (notaNum >= 14) {
        return 'nota-alta'; // Verde
      } else if (notaNum >= 11) {
        return 'nota-media'; // Amarillo
      } else {
        return 'nota-baja'; // Rojo
      }
    }
    
    /**
     * Validar formato de fecha DD/MM/AAAA
     */
    function validarFecha(fecha) {
      if (!fecha) return false;
      
      const regex = /^\d{2}\/\d{2}\/\d{4}$/;
      if (!regex.test(fecha)) return false;
      
      const partes = fecha.split('/');
      const dia = parseInt(partes[0]);
      const mes = parseInt(partes[1]);
      const anio = parseInt(partes[2]);
      
      if (mes < 1 || mes > 12) return false;
      if (dia < 1 || dia > 31) return false;
      if (anio < 2000 || anio > 2100) return false;
      
      return true;
    }
    
    // ==========================================
    // UTILIDADES
    // ==========================================
    
    /**
     * Mostrar alerta temporal
     * Solo definir si no existe globalmente
     */
    if (typeof showAlert === 'undefined') {
      window.showAlert = function(type, message) {
        const alertBox = document.createElement('div');
        alertBox.className = 'alert alert-' + type;
        alertBox.textContent = message;
        alertBox.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 16px 24px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          font-size: 14px;
          font-weight: 500;
          animation: slideIn 0.3s;
          ${type === 'success' ? 'background: #d4edda; color: #155724; border-left: 4px solid #28a745;' : ''}
          ${type === 'error' ? 'background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545;' : ''}
          ${type === 'warning' ? 'background: #fff3cd; color: #856404; border-left: 4px solid #ffc107;' : ''}
          ${type === 'info' ? 'background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8;' : ''}
        `;
        
        document.body.appendChild(alertBox);
        
        setTimeout(function() {
          alertBox.remove();
        }, 4000);
      };
      
      // Animaci√≥n slideIn
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
      `;
      document.head.appendChild(style);
    }
    
    /**
     * Mostrar error en lugar de estado vac√≠o
     */
    function mostrarError(mensaje) {
      const estadoVacio = document.getElementById('estadoVacio');
      estadoVacio.style.display = 'block';
      estadoVacio.querySelector('.estado-vacio-icon').textContent = '‚ö†Ô∏è';
      estadoVacio.querySelector('.estado-vacio-text').textContent = 'Error';
      estadoVacio.querySelector('.estado-vacio-subtext').textContent = mensaje;
    }
  </script>
  
</body>
</html>
