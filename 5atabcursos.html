<!--
******************************************
PBE CONTROL - 5atabcursos.html - V01.23 CLAUDE
Sistema de GestiÃ³n AcadÃ©mica
07/01/2026

CAMBIOS V01.23 CLAUDE:
âœ… FIX CRÃTICO: Eliminadas validaciones ultra-restrictivas
âœ… FIX CRÃTICO: Auto-init si currentUser ya existe
âœ… FIX CRÃTICO: Retry logic si currentUser no estÃ¡ disponible
âœ… Logging exhaustivo para debug
âœ… Maneja caso de 0 cursos correctamente

FIX V01.22 GPT:
- [LAZY-INIT] El subtab NO se auto-inicializa
- [PARENT-CONTROL] init() expuesto para ser llamado por el contenedor
- [SINGLE-RUN] Init real idempotente
- Evita cargas mÃºltiples y errores fantasma
******************************************
-->
<script>
(function PBE_CURSOS_MODULE() {
  'use strict';

  let cursosData = [];
  let _initDone = false;
  let _retryCount = 0;
  const MAX_RETRIES = 5;

  /* ==========================================
     INIT CONTROLADO (CON RETRY LOGIC)
     V01.23 CLAUDE
     ========================================== */
  function init() {
    console.log('ğŸ“š CursosModule.init() llamado (intento ' + (_retryCount + 1) + ')');

    if (_initDone) {
      console.log('ğŸ“š CursosModule ya inicializado, ignorando');
      return;
    }

    // V01.23 CLAUDE: ValidaciÃ³n menos restrictiva
    if (typeof currentUser === 'undefined' || !currentUser) {
      console.warn('ğŸ“š currentUser no disponible aÃºn, reintentando...');
      
      if (_retryCount < MAX_RETRIES) {
        _retryCount++;
        setTimeout(init, 200); // Reintentar en 200ms
      } else {
        console.error('ğŸ“š CursosModule: currentUser no disponible despuÃ©s de ' + MAX_RETRIES + ' intentos');
        renderError('Usuario no disponible. Recarga la pÃ¡gina.');
      }
      return;
    }

    if (!currentUser.codeAlum) {
      console.error('ğŸ“š currentUser.codeAlum estÃ¡ vacÃ­o:', currentUser);
      renderError('CÃ³digo de alumno no disponible');
      return;
    }

    _initDone = true;
    console.log('ğŸ“š CursosModule inicializado correctamente para:', currentUser.codeAlum);
    cargarCursos();
  }

  /* ==========================================
     CARGA DE DATOS
     ========================================== */
  function cargarCursos() {
    console.log('ğŸ“š Cargando cursos para:', currentUser.codeAlum);

    google.script.run
      .withSuccessHandler(handleCursosLoaded)
      .withFailureHandler(handleCursosError)
      .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
  }

  function handleCursosLoaded(response) {
    console.log('ğŸ“š Respuesta recibida:', response);

    if (!response) {
      console.error('ğŸ“š Response es NULL');
      renderError('Error: El servidor retornÃ³ NULL');
      return;
    }

    if (response.success !== true) {
      console.error('ğŸ“š Response no exitoso:', response.error);
      renderError(response.error || 'Error al cargar cursos');
      return;
    }

    cursosData = response.data || [];
    console.log('ğŸ“š Cursos cargados:', cursosData.length);

    if (cursosData.length === 0) {
      renderEmptyState();
    } else {
      renderCursosTable();
    }
  }

  function handleCursosError(error) {
    console.error('ğŸ“š Error al cargar cursos:', error);
    renderError('Error de conexiÃ³n: ' + error.message);
  }

  /* ==========================================
     RENDER - TABLA DE CURSOS
     ========================================== */
  function renderCursosTable() {
    const container = document.getElementById('cursosTableContainer');
    if (!container) {
      console.error('ğŸ“š Container cursosTableContainer no encontrado');
      return;
    }

    let html = `
      <table class="cursos-table">
        <thead>
          <tr>
            <th>Color</th>
            <th>CÃ³digo</th>
            <th>Nombre Completo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
    `;

    cursosData.forEach(curso => {
      const color = curso.Color || '#FF5733';
      html += `
        <tr>
          <td><div class="curso-color-box" style="background:${color}; width:30px; height:30px; border-radius:4px;"></div></td>
          <td><strong>${curso.Curso}</strong></td>
          <td>${curso.Completo}</td>
          <td>
            <button onclick="editarCurso('${curso._rowNumber}')" style="background:none;border:none;cursor:pointer;font-size:16px;">âœï¸</button>
            <button onclick="eliminarCurso('${curso._rowNumber}')" style="background:none;border:none;cursor:pointer;font-size:16px;">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
    console.log('ğŸ“š Tabla renderizada con', cursosData.length, 'cursos');
  }

  /* ==========================================
     RENDER - ESTADO VACÃO
     ========================================== */
  function renderEmptyState() {
    const container = document.getElementById('cursosTableContainer');
    if (!container) return;

    container.innerHTML = `
      <div class="empty-state" style="text-align:center; padding:40px 20px; color:#999;">
        <div class="empty-state-icon" style="font-size:48px; margin-bottom:15px;">ğŸ“š</div>
        <div class="empty-state-text" style="font-size:16px; font-weight:500;">
          No tienes cursos registrados aÃºn.
        </div>
        <button onclick="abrirModalNuevoCurso()" style="margin-top:20px; padding:10px 20px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer;">
          â• Agregar Primer Curso
        </button>
      </div>
    `;
    console.log('ğŸ“š Empty state renderizado');
  }

  /* ==========================================
     RENDER - ESTADO DE ERROR
     V01.23 CLAUDE
     ========================================== */
  function renderError(message) {
    const container = document.getElementById('cursosTableContainer');
    if (!container) return;

    container.innerHTML = `
      <div class="error-state" style="text-align:center; padding:40px 20px; color:#dc3545;">
        <div class="error-icon" style="font-size:48px; margin-bottom:15px;">âš ï¸</div>
        <div class="error-text" style="font-size:16px; font-weight:500;">
          ${message}
        </div>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer;">
          ğŸ”„ Recargar PÃ¡gina
        </button>
      </div>
    `;
    console.error('ğŸ“š Error state renderizado:', message);
  }

  /* ==========================================
     FUNCIONES AUXILIARES (STUBS)
     ========================================== */
  window.editarCurso = function(rowNumber) {
    console.log('âœï¸ Editar curso:', rowNumber);
    alert('FunciÃ³n de ediciÃ³n en desarrollo');
  };

  window.eliminarCurso = function(rowNumber) {
    console.log('ğŸ—‘ï¸ Eliminar curso:', rowNumber);
    if (confirm('Â¿Eliminar este curso?')) {
      alert('FunciÃ³n de eliminaciÃ³n en desarrollo');
    }
  };

  window.abrirModalNuevoCurso = function() {
    console.log('â• Abrir modal nuevo curso');
    alert('Modal de nuevo curso en desarrollo');
  };

  /* ==========================================
     API PÃšBLICA
     ========================================== */
  window.CursosModule = {
    init: init,
    reload: function() {
      _initDone = false;
      _retryCount = 0;
      init();
    }
  };

  /* ==========================================
     V01.23 CLAUDE: AUTO-INIT SI CURRENTUSER EXISTE
     ========================================== */
  setTimeout(function() {
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
      console.log('ğŸ“š currentUser detectado, auto-inicializando...');
      init();
    } else {
      console.log('ğŸ“š currentUser no disponible, esperando llamada externa');
    }
  }, 150);

  console.log('%cğŸ“š CursosModule V01.23 CLAUDE cargado',
    'font-size:11px;color:#667eea;font-weight:bold');
})();
</script>

<!-- HTML CONTAINER -->
<div id="cursosTableContainer" style="min-height:200px;">
  <div style="text-align:center; padding:40px; color:#999;">
    <div style="font-size:32px; margin-bottom:10px;">â³</div>
    <div>Cargando cursos...</div>
  </div>
</div>

<style>
  .cursos-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .cursos-table thead {
    background: #f8f9fa;
  }

  .cursos-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
  }

  .cursos-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
  }

  .cursos-table tbody tr:hover {
    background: #f8f9fa;
  }

  .curso-color-box {
    width: 30px;
    height: 30px;
    border-radius: 4px;
    border: 1px solid #ddd;
  }
</style>
