<!--
******************************************
PBE CONTROL - 5atabcursos.html - V01.22 GPT
Sistema de Gesti√≥n Acad√©mica
07/01/2026

FIX V01.22:
- [LAZY-INIT] El subtab NO se auto-inicializa
- [PARENT-CONTROL] init() expuesto para ser llamado por el contenedor
- [SINGLE-RUN] Init real idempotente
- Evita cargas m√∫ltiples y errores fantasma
******************************************
-->
<script>
(function PBE_CURSOS_MODULE() {
  'use strict';

  let cursosData = [];
  let _initDone = false;

  /* ==========================================
     INIT CONTROLADO (SOLO DESDE EL PADRE)
     ========================================== */
  function init() {
    if (_initDone) {
      console.log('üìö CursosModule.init() ignorado (ya inicializado)');
      return;
    }

    if (
      typeof currentUser === 'undefined' ||
      !currentUser ||
      !currentUser.codeAlum
    ) {
      console.warn('üìö CursosModule: currentUser no disponible a√∫n');
      return;
    }

    _initDone = true;
    console.log('üìö CursosModule.init() ejecutado');
    cargarCursos();
  }

  /* ==========================================
     CARGA DE DATOS
     ========================================== */
  function cargarCursos() {
    google.script.run
      .withSuccessHandler(handleCursosLoaded)
      .withFailureHandler(handleCursosError)
      .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
  }

  function handleCursosLoaded(response) {
    if (!response || response.success !== true) {
      renderEmptyState();
      return;
    }

    cursosData = response.data || [];
    renderCursosTable();
  }

  function handleCursosError(error) {
    console.error('Error al cargar cursos:', error);
    renderEmptyState();
  }

  /* ==========================================
     RENDER
     ========================================== */
  function renderCursosTable() {
    const container = document.getElementById('cursosTableContainer');
    if (!container) return;

    if (!cursosData.length) {
      renderEmptyState();
      return;
    }

    let html = `
      <table class="cursos-table">
        <thead>
          <tr>
            <th>Color</th>
            <th>C√≥digo</th>
            <th>Nombre Completo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
    `;

    cursosData.forEach(curso => {
      const color = curso.Color || '#FF5733';
      html += `
        <tr>
          <td><div class="curso-color-box" style="background:${color}"></div></td>
          <td><strong>${curso.Curso}</strong></td>
          <td>${curso.Completo}</td>
          <td>
            ‚úèÔ∏è üóëÔ∏è
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function renderEmptyState() {
    const container = document.getElementById('cursosTableContainer');
    if (!container) return;

    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìö</div>
        <div class="empty-state-text">
          No tienes cursos registrados a√∫n.
        </div>
      </div>
    `;
  }

  /* ==========================================
     API P√öBLICA
     ========================================== */
  window.CursosModule = {
    init: init
  };

  console.log('%cüìö CursosModule V01.22 cargado (lazy)',
    'font-size:11px;color:#667eea');
})();
</script>
