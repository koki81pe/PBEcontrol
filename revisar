<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: PBE Control
ARCHIVO: 7ctabhorariosem.html
VERSI√ìN: 01.36
FECHA: 21/01/2026 23:32 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: ESTILOS CSS [INICIO] -->
<style>
/* GRID DE DEBERES */
.hs-deberes-container {
  margin-top: 30px;
  padding-top: 20px;
  border-top: 2px solid #e0e0e0;
}

.hs-deberes-titulo {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.hs-deberes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.hs-deber-card {
  background: #f8f9fa;
  border-left: 4px solid #667eea;
  padding: 12px 15px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.hs-deber-card:hover {
  background: #fff;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

.hs-deber-card.evaluacion {
  border-left-color: #e74c3c;
}

.hs-deber-card.tarea {
  border-left-color: #3498db;
}

.hs-deber-card.lectura {
  border-left-color: #2ecc71;
}

.hs-deber-curso {
  font-weight: 600;
  font-size: 14px;
  color: #333;
  margin-bottom: 4px;
}

.hs-deber-tipo {
  font-size: 12px;
  color: #666;
  text-transform: capitalize;
}

.hs-deberes-empty {
  text-align: center;
  padding: 30px;
  color: #999;
  font-size: 14px;
}

/* MODAL DETALLE DEBER */
.hs-modal-deber {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.hs-modal-deber.active {
  display: flex;
}

.hs-modal-deber-content {
  background: white;
  border-radius: 12px;
  padding: 25px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.hs-modal-deber-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
}

.hs-modal-deber-header h3 {
  margin: 0;
  font-size: 18px;
  color: #333;
}

.hs-modal-deber-close {
  background: none;
  border: none;
  font-size: 28px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s;
}

.hs-modal-deber-close:hover {
  color: #333;
}

.hs-modal-deber-body {
  font-size: 14px;
  color: #555;
}

.hs-deber-detalle-row {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #f0f0f0;
}

.hs-deber-detalle-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.hs-deber-detalle-label {
  font-weight: 600;
  color: #667eea;
  margin-bottom: 5px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.hs-deber-detalle-valor {
  color: #333;
  font-size: 15px;
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .hs-deberes-grid {
    grid-template-columns: 1fr;
  }
  
  .hs-modal-deber-content {
    width: 95%;
    padding: 20px;
  }
}
</style>
<!-- MOD-002: FIN -->

<!-- MOD-003: CONTENEDOR PRINCIPAL [INICIO] -->
<div class="hs-container">
  <div class="hs-header">
    <div class="hs-header-left">
      <h2>üìÖ Horario Semanal</h2>
      <div class="hs-semana-info">
        <span id="hs-semana-texto">Semana 1</span>
        <span class="hs-separador">|</span>
        <span id="hs-fecha-rango">Cargando...</span>
      </div>
    </div>
    
    <div class="hs-header-right">
      <button class="hs-btn-config" onclick="window.hsAbrirConfigSemana()" title="Configurar fechas de inicio y fin de clases">
        üìÖ Fechas
      </button>
    </div>
  </div>
  
  <div class="hs-content">
    <div class="hs-sidebar">
      <div class="hs-semanas-lista" id="hs-semanas-lista">
        <!-- Botones de semanas se generan din√°micamente -->
      </div>
    </div>
    
    <div class="hs-main">
      <div class="hs-actions">
        <button class="hs-btn-action" onclick="window.hsNavegar(-1)">
          ‚Üê Ant.
        </button>
        <button class="hs-btn-action" onclick="window.hsNavegar(1)">
          Sig. ‚Üí
        </button>
      </div>
      
      <div class="hs-actions">
        <button class="hs-btn-action" onclick="window.hsCopiarSemanaAnterior()">
          üìã Copiar sem. ant.
        </button>
        <button class="hs-btn-action" onclick="window.hsLimpiarSemana()">
          üóëÔ∏è Limpiar
        </button>
      </div>
    </div>
    
    <div class="hs-grid-container">
      <div class="hs-loading" id="loadingHS">
        <div class="hs-spinner"></div>
        <p>Cargando horario...</p>
      </div>
      <div id="hsGridContainer"></div>
      
      <!-- Grid de Deberes -->
      <div id="hsDeberesContainer"></div>
    </div>
  </div>
</div>

<!-- MODAL: Configurar Fechas de Inicio y Fin -->
<div id="modalConfigSemana" class="hs-modal">
  <div class="hs-modal-content">
    <h3>Fechas de Inicio y Fin de clases</h3>
    
    <form id="formConfigSemana" onsubmit="return window.hsHandleConfigSemana(event)">
      <div class="hs-form-group">
        <label>Fecha de inicio de clases:</label>
        <input type="date" id="configFechaInicio" required>
        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
          Puede ser cualquier d√≠a de la semana. El sistema ajustar√° al lunes correspondiente.
        </small>
      </div>
      
      <div class="hs-form-group">
        <label>Fecha de fin de clases:</label>
        <input type="date" id="configFechaFin" required>
        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
          Todas las semanas se generar√°n autom√°ticamente entre estas fechas.
        </small>
      </div>
      
      <div class="hs-modal-actions">
        <button type="button" class="hs-btn hs-btn-secondary" onclick="window.hsCerrarConfigSemana()">Cancelar</button>
        <button type="submit" class="hs-btn hs-btn-primary">Guardar y Generar Semanas</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Actividad -->
<div id="modalActividad" class="hs-modal">
  <div class="hs-modal-content">
    <h3 id="actividadFormTitle">Agregar Actividad</h3>

    <form id="formActividad" onsubmit="return window.hsHandleSubmitActividad(event)">
      <input type="hidden" id="actividadRowNumber">
      <input type="hidden" id="actividadModoEdicion" value="false">
      <input type="hidden" id="actividadFecha">
      <input type="hidden" id="actividadSem">

      <div class="hs-form-group">
        <label>Tipo de Actividad:</label>
        <select id="actividadTipo" required>
          <option value="">Seleccionar...</option>
          <option value="Estudio">Estudio</option>
          <option value="Repaso">Repaso</option>
          <option value="Tarea">Tarea</option>
          <option value="Proyecto">Proyecto</option>
          <option value="Lectura">Lectura</option>
          <option value="Personal">Personal</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="hs-form-group">
        <label>Nombre:</label>
        <input type="text" id="actividadNombre" required placeholder="Ej: Estudio FIS">
      </div>

      <div class="hs-form-group">
        <label>Hora Inicio:</label>
        <input type="time" id="actividadHoraIni" required>
      </div>

      <div class="hs-form-group">
        <label>Hora Fin:</label>
        <input type="time" id="actividadHoraFin" required>
      </div>

      <div class="hs-form-group">
        <label>Color:</label>
        <select id="actividadColor">
          <option value="#17a2b8">Azul claro</option>
          <option value="#007bff">Azul</option>
          <option value="#28a745">Verde</option>
          <option value="#ffc107">Amarillo</option>
          <option value="#fd7e14">Naranja</option>
          <option value="#dc3545">Rojo</option>
          <option value="#6f42c1">P√∫rpura</option>
          <option value="#6c757d">Gris</option>
        </select>
      </div>

      <div class="hs-modal-actions">
        <button type="button" class="hs-btn hs-btn-secondary" onclick="window.hsCerrarModalActividad()">Cancelar</button>
        <button type="submit" class="hs-btn hs-btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Confirmaci√≥n -->
<div id="modalConfirmacion" class="hs-modal">
  <div class="hs-modal-content">
    <h3>‚ö†Ô∏è Confirmaci√≥n</h3>
    <p id="confirmacionMensaje" style="margin: 20px 0; line-height: 1.6;"></p>
    <div class="hs-modal-actions">
      <button class="hs-btn hs-btn-secondary" onclick="window.hsCerrarModalConfirmacion()">Cancelar</button>
      <button id="btnConfirmarAccion" class="hs-btn hs-btn-primary">Confirmar</button>
    </div>
  </div>
</div>

<!-- MODAL: Detalle Deber -->
<div id="modalDetalleDeber" class="hs-modal-deber">
  <div class="hs-modal-deber-content">
    <div class="hs-modal-deber-header">
      <h3>Detalle del Deber</h3>
      <button class="hs-modal-deber-close" onclick="window.hsCerrarModalDeber()">√ó</button>
    </div>
    <div id="modalDeberBody" class="hs-modal-deber-body">
      <!-- Contenido din√°mico -->
    </div>
  </div>
</div>
<!-- MOD-003: FIN -->

<!-- MOD-004: ESTRUCTURA HTML [INICIO] -->
<div class="hs-container">
  <div class="hs-sidebar">
    <h3>üìÖ Semanas</h3>
    <button class="hs-btn-primera-clase" onclick="window.hsAbrirConfigSemana()">
      1ra clase
    </button>
    <div id="hsSemanasList"></div>
    <button class="hs-btn-agregar-semana" onclick="window.hsAgregarNuevaSemana()">
      ‚ûï Agregar Semana
    </button>
  </div>
  
  <div class="hs-main">
    <div class="hs-toolbar">
      <div class="hs-nav-semana">
        <button class="hs-nav-btn" onclick="window.hsNavegarSemana(-1)">‚óÄ Ant</button>
        <div class="hs-semana-info" id="hsSemanaInfo">Semana 1</div>
        <button class="hs-nav-btn" onclick="window.hsNavegarSemana(1)">Sig ‚ñ∂</button>
      </div>
      
      <div class="hs-actions">
        <button class="hs-btn-action" onclick="window.hsCopiarSemanaAnterior()">
          üìã Copiar Sem. ant.
        </button>
        <button class="hs-btn-action" onclick="window.hsLimpiarSemana()">
          üóëÔ∏è Limpiar
        </button>
      </div>
    </div>
    
    <div class="hs-grid-container">
      <div class="hs-loading" id="loadingHS">
        <div class="hs-spinner"></div>
        <p>Cargando horario...</p>
      </div>
      <div id="hsGridContainer"></div>
    </div>
  </div>
</div>

<div id="modalConfigSemana" class="hs-modal">
  <div class="hs-modal-content">
    <h3>Configurar Semana 1</h3>
    
    <form id="formConfigSemana" onsubmit="return window.hsHandleConfigSemana(event)">
      <div class="hs-form-group">
        <label>Primer d√≠a de clases (cualquier d√≠a de la semana):</label>
        <input type="date" id="configFechaInicio" required>
      </div>
      
      <div class="hs-modal-actions">
        <button type="button" class="hs-btn hs-btn-secondary" onclick="window.hsCerrarConfigSemana()">Cancelar</button>
        <button type="submit" class="hs-btn hs-btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<div id="modalActividad" class="hs-modal">
  <div class="hs-modal-content">
    <h3 id="actividadFormTitle">Agregar Actividad</h3>

    <form id="formActividad" onsubmit="return window.hsHandleSubmitActividad(event)">
      <input type="hidden" id="actividadRowNumber">
      <input type="hidden" id="actividadModoEdicion" value="false">
      <input type="hidden" id="actividadFecha">
      <input type="hidden" id="actividadSem">

      <div class="hs-form-group">
        <label>Tipo de Actividad:</label>
        <select id="actividadTipo" required>
          <option value="">Seleccionar...</option>
          <option value="Estudio">Estudio</option>
          <option value="Repaso">Repaso</option>
          <option value="Tarea">Tarea</option>
          <option value="Proyecto">Proyecto</option>
          <option value="Lectura">Lectura</option>
          <option value="Personal">Personal</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="hs-form-group">
        <label>Nombre:</label>
        <input type="text" id="actividadNombre" required placeholder="Ej: Estudio FIS">
      </div>

      <div class="hs-form-group">
        <label>Hora Inicio:</label>
        <input type="time" id="actividadHoraIni" required>
      </div>

      <div class="hs-form-group">
        <label>Hora Fin:</label>
        <input type="time" id="actividadHoraFin" required>
      </div>

      <div class="hs-form-group">
        <label>Color:</label>
        <input type="color" id="actividadColor" value="#17a2b8">
      </div>

      <div class="hs-modal-actions">
        <button type="button" class="hs-btn hs-btn-secondary" onclick="window.hsCerrarModalActividad()">Cancelar</button>
        <button type="button" class="hs-btn hs-btn-danger" id="btnEliminarActividad" style="display:none" onclick="window.hsConfirmarEliminarActividad()">Eliminar</button>
        <button type="submit" class="hs-btn hs-btn-primary" id="btnSubmitActividad">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- V01.31 CLAUDE: Modal de confirmaci√≥n estilizado -->
<div id="modalConfirmacion" class="hs-modal">
  <div class="hs-modal-content" style="max-width: 420px;">
    <h3 id="confirmacionTitulo" style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <span style="font-size: 32px;">‚ùì</span>
      <span>Confirmaci√≥n</span>
    </h3>

    <p id="confirmacionMensaje" style="font-size: 15px; line-height: 1.6; color: #555; margin-bottom: 24px;">
      ¬øEst√°s seguro?
    </p>

    <div class="hs-modal-actions">
      <button type="button" class="hs-btn hs-btn-secondary" onclick="window.hsCerrarModalConfirmacion()">Cancelar</button>
      <button type="button" class="hs-btn hs-btn-primary" id="btnConfirmarAccion">Confirmar</button>
    </div>
  </div>
</div>
<!-- MOD-004: FIN  -->

<!-- MOD-005: JAVASCRIPT [INICIO] -->
<script>

// MOD-005-S01: ENCAPSULAMIENTO IIFE [INICIO]
(function () {
'use strict';

if (window.HorarioSemanalModule) {
  console.log('üìÖ HorarioSemanalModule ya existe, ignorando carga');
  return;
}

console.log('üìÖ HorarioSemanalModule V01.33 CODEWORKSHOP iniciando...');
// MOD-005-S01: FIN

// MOD-005-S02: VARIABLES GLOBALES [INICIO]
let semanaActual = 1;
let configSemana = null;
let todasSemanas = [];
let cursos = [];
let horarioClases = [];
let actividadesSem = [];
let fechaFinClases = null;
// MOD-005-S02: FIN

// MOD-005-S03: CONSTANTES V2 [INICIO]
const HORA_INICIO = 7;
const HORA_FIN = 22;
const DIAS = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
const DIAS_CORTOS = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
let _initDone = false;
let _retryCount = 0;
const MAX_RETRIES = 5;
// MOD-005-S03: FIN

// MOD-005-S04: INICIALIZACI√ìN [INICIO]
function init() {
  console.log('üìÖ HorarioSemanalModule.init() llamado (intento ' + (_retryCount + 1) + ')');
  
  if (_initDone) {
    console.log('üìÖ Ya inicializado, ignorando');
    return;
  }
  
  if (!window.currentUser || !currentUser.codeAlum) {
    console.warn('üìÖ currentUser no disponible, reintentando...');
    
    if (_retryCount < MAX_RETRIES) {
      _retryCount++;
      setTimeout(init, 200);
    } else {
      console.error('üìÖ currentUser no disponible despu√©s de ' + MAX_RETRIES + ' intentos');
      ocultarLoading();
    }
    return;
  }
  
  _initDone = true;
  console.log('üìÖ Inicializado para:', currentUser.codeAlum);
  
  cargarConfigSemana();
  cargarSemanas();
}
// MOD-005-S04: FIN

// MOD-005-S05: CARGA CONFIG SEMANA V2 [INICIO]
function cargarConfigSemana() {
  console.log('üìÖ Cargando configuraci√≥n de semana...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üìÖ Config response:', r);
      
      if (r && r.success && r.data && r.data.FechaInicio) {
        configSemana = r.data;
        console.log('üìÖ FechaInicio:', configSemana.FechaInicio);
        
        // Capturar FechaFin si existe
        if (configSemana.FechaFin) {
          fechaFinClases = configSemana.FechaFin;
          console.log('üìÖ FechaFin:', fechaFinClases);
        }
        
        // ELIMINADA: calcularSemanaActual(); ‚Üê Esta funci√≥n no existe
        cargarCursos();
        cargarHorarioClases();
        cargarHorarioSem();
      } else {
        console.log('üìÖ Sin configuraci√≥n, mostrar modal');
        ocultarLoading();
        abrirConfigSemana();
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error al cargar config:', e);
      ocultarLoading();
      mostrarNotificacion('error', 'Error al cargar configuraci√≥n');
    })
    .studentObtenerConfigSemana({ codeAlum: currentUser.codeAlum });
}
// MOD-005-S05: FIN

// MOD-005-S06: CARGA SEMANAS [INICIO]
function cargarSemanas() {
  console.log('üìÖ Cargando semanas...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üìÖ Semanas response:', r);
      
      if (r && r.success && r.data && r.data.length > 0) {
        todasSemanas = r.data;
        console.log('üìÖ Total semanas cargadas:', todasSemanas.length);
        renderizarBotonesSemanas();
      } else {
        console.log('üìÖ Sin semanas registradas');
        todasSemanas = [];
        renderizarBotonesSemanas();
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error al cargar semanas:', e);
      mostrarNotificacion('error', 'Error al cargar semanas');
    })
    .studentObtenerSemanas(currentUser.codeAlum);
}

function renderizarBotonesSemanas() {
  const container = document.getElementById('hs-semanas-lista');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (todasSemanas.length === 0) {
    container.innerHTML = '<p style="padding:10px;color:#999;font-size:13px;text-align:center;">No hay semanas configuradas</p>';
    return;
  }
  
  todasSemanas.forEach(sem => {
    const btn = document.createElement('button');
    btn.className = 'hs-semana-btn';
    btn.textContent = `Semana ${sem.Semana}`;
    btn.onclick = () => irASemana(sem.Semana);
    
    if (sem.Semana === semanaActual) {
      btn.classList.add('active');
    }
    
    container.appendChild(btn);
  });
  
  console.log('‚úÖ Botones de semanas renderizados:', todasSemanas.length);
}
// MOD-005-S06: FIN

// MOD-005-S07: NAVEGACI√ìN SEMANAS [INICIO]
function navegar(direccion) {
  const nuevaSemana = semanaActual + direccion;
  
  console.log('üîÑ Navegando:', {
    actual: semanaActual,
    direccion: direccion,
    nueva: nuevaSemana,
    totalSemanas: todasSemanas.length
  });
  
  // Validar que la nueva semana existe
  const semanaExiste = todasSemanas.find(s => s.Semana === nuevaSemana);
  
  if (!semanaExiste) {
    const mensaje = direccion > 0 ? 'No hay siguiente semana' : 'No hay semana anterior';
    mostrarNotificacion('info', mensaje);
    return;
  }
  
  irASemana(nuevaSemana);
}

function irASemana(numSemana) {
  console.log('üìç Ir a semana:', numSemana);
  
  // Buscar la semana en el array
  const semana = todasSemanas.find(s => s.Semana === numSemana);
  
  if (!semana) {
    mostrarNotificacion('error', 'Semana no encontrada');
    return;
  }
  
  semanaActual = numSemana;
  
  // Actualizar UI
  actualizarInfoSemana();
  actualizarBotonesSemanas();
  cargarHorarioSem();
}

function actualizarBotonesSemanas() {
  const botones = document.querySelectorAll('.hs-semana-btn');
  botones.forEach(btn => {
    const numSemana = parseInt(btn.textContent.replace('Semana ', ''));
    if (numSemana === semanaActual) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
}
// MOD-005-S07: FIN

// MOD-005-S08: RENDER LISTA SEMANAS [INICIO]
function renderListaSemanas() {
  const lista = document.getElementById('hsSemanasList');
  if (!lista) return;
  
  let html = '';
  
  if (semanasData.length > 0) {
    semanasData.forEach(sem => {
      const numSem = parseInt(sem.Semana);
      const activeClass = numSem === semanaActual ? 'active' : '';
      html += `
        <div class="hs-semana-item ${activeClass}" onclick="window.hsCambiarSemana(${numSem})">
          Semana ${numSem}
        </div>
      `;
    });
  } else {
    for (let i = 1; i <= semanaActual; i++) {
      const activeClass = i === semanaActual ? 'active' : '';
      html += `
        <div class="hs-semana-item ${activeClass}" onclick="window.hsCambiarSemana(${i})">
          Semana ${i}
        </div>
      `;
    }
  }
  
  lista.innerHTML = html;
}
// MOD-005-S08: FIN

// MOD-005-S09: ACTUALIZAR INFO SEMANA [INICIO]
function actualizarInfoSemana() {
  const info = document.getElementById('hsSemanaInfo');
  if (!info) return;
  
  const fechas = calcularFechasSemana(semanaActual);
  const fechaIni = formatearFechaCorta(fechas.lunes);
  const fechaFin = formatearFechaCorta(fechas.domingo);
  
  info.textContent = `S${semanaActual}: ${fechaIni} - ${fechaFin}`;
}
// MOD-005-S09: FIN

// MOD-005-S10: CALCULAR FECHAS SEMANA [INICIO]
function calcularFechasSemana(numSemana) {
  const fechaInicio = new Date(configSemana.FechaInicio);
  fechaInicio.setHours(0, 0, 0, 0);
  
  const diaSemana = fechaInicio.getDay();
  const diasHastaLunes = diaSemana === 0 ? 6 : diaSemana - 1;
  
  const lunes = new Date(fechaInicio);
  lunes.setDate(lunes.getDate() - diasHastaLunes);
  lunes.setDate(lunes.getDate() + ((numSemana - 1) * 7));
  
  const domingo = new Date(lunes);
  domingo.setDate(domingo.getDate() + 6);
  
  const dias = [];
  for (let i = 0; i < 7; i++) {
    const dia = new Date(lunes);
    dia.setDate(dia.getDate() + i);
    dias.push(dia);
  }
  
  return { lunes, domingo, dias };
}
// MOD-005-S10: FIN

// MOD-005-S11: CARGA DE CURSOS [INICIO]
function cargarCursos() {
  console.log('üìÖ Cargando cursos...');
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        cursosData = r.data || [];
        console.log('üìÖ Cursos cargados:', cursosData.length);
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error al cargar cursos:', e);
    })
    .studentObtenerCursos({ codeAlum: currentUser.codeAlum });
}
// MOD-005-S11: FIN

// MOD-005-S12: CARGA HORARIO CLASES [INICIO]
function cargarHorarioClases() {
  console.log('üìÖ Cargando horario clases...');
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        clasesData = r.data || [];
        console.log('üìÖ Clases cargadas:', clasesData.length);
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error al cargar clases:', e);
    })
    .studentObtenerHorarioClases({ codeAlum: currentUser.codeAlum });
}
// MOD-005-S12: FIN

// MOD-005-S13: CARGA HORARIO SEMANAL [INICIO]
function cargarHorarioSem() {
  console.log('üìÖ Cargando horario semanal...');
  
  google.script.run
    .withSuccessHandler(r => {
      console.log('üìÖ HorarioSem response:', r);
      
      if (r && r.success) {
        actividadesData = r.data || [];
        console.log('üìÖ Actividades cargadas:', actividadesData.length);
        
        construirMatriz();
        renderGrid();
        ocultarLoading();
      } else {
        console.error('üìÖ Error en response:', r);
        construirMatriz();
        renderGrid();
        ocultarLoading();
      }
    })
    .withFailureHandler(e => {
      console.error('üìÖ Error de conexi√≥n:', e);
      construirMatriz();
      renderGrid();
      ocultarLoading();
    })
    .studentObtenerHorarioSem({ codeAlum: currentUser.codeAlum });
}
// MOD-005-S13: FIN

// MOD-005-S14: CONSTRUCCI√ìN DE MATRIZ [INICIO]
function construirMatriz() {
  console.log('üìÖ Construyendo matriz...');
  
  const fechas = calcularFechasSemana(semanaActual);
  
  horarioMatrix = {};
  fechas.dias.forEach(fecha => {
    const key = formatearFechaISO(fecha);
    horarioMatrix[key] = {};
  });
  
  clasesData.forEach(c => {
    const dia = extraerDia(c.Detalle);
    if (!dia) return;
    
    const diaIndex = DIAS.indexOf(dia);
    if (diaIndex === -1) return;
    
    const fechaDia = fechas.dias[diaIndex];
    const key = formatearFechaISO(fechaDia);
    
    const horas = calcularHoras(c.HoraIni, c.HoraFin);
    horas.forEach(h => {
      horarioMatrix[key][h.hora] = horarioMatrix[key][h.hora] || [];
      horarioMatrix[key][h.hora].push({
        tipo: 'clase',
        clase: c,
        ...h
      });
    });
  });
  
  actividadesData.forEach(act => {
    const fechaAct = act.FechaHS;
    if (!fechaAct) return;

    const fechaParsed = parsearFechaDDMMAAAA(fechaAct);
    if (isNaN(fechaParsed.getTime())) {
      console.warn('üìÖ Fecha inv√°lida:', fechaAct);
      return;
    }

    const key = formatearFechaISO(fechaParsed);

    if (!horarioMatrix[key]) return;

    const horas = calcularHoras(act.HoraInicio, act.HoraFin);
    horas.forEach(h => {
      horarioMatrix[key][h.hora] = horarioMatrix[key][h.hora] || [];
      horarioMatrix[key][h.hora].push({
        tipo: 'actividad',
        actividad: act,
        ...h
      });
    });
  });
  
  console.log('üìÖ Matriz construida:', horarioMatrix);
}
// MOD-005-S14: FIN

// MOD-005-S15: HELPERS DE PROCESAMIENTO [INICIO]
function extraerDia(t) {
  if (!t) return null;
  const s = String(t).toLowerCase().trim();
  const diaEncontrado = DIAS.find(d => {
    const dLower = d.toLowerCase();
    return s.includes(dLower) || dLower.includes(s);
  });
  return diaEncontrado || null;
}

function calcularHoras(i, f) {
  const horaIniStr = normalizarHora(i);
  const horaFinStr = normalizarHora(f);
  
  if (!horaIniStr || !horaFinStr) {
    return [];
  }
  
  const [hi, mi] = horaIniStr.split(':').map(Number);
  const [hf, mf] = horaFinStr.split(':').map(Number);
  
  const res = [];
  
  for (let h = hi; h <= hf; h++) {
    if (h > HORA_FIN) break;
    if (h === hf && mf === 0) continue;
    
    res.push({
      hora: String(h).padStart(2, '0') + ':00',
      prefijo: (h === hi && mi >= 30) ? '/' : '',
      sufijo: (h === hf && mf > 0 && mf < 60) ? '/' : ''
    });
  }
  
  return res;
}

function normalizarHora(valor) {
  if (!valor) return null;
  
  if (typeof valor === 'string') {
    const match = valor.match(/(\d{1,2}):(\d{2})/);
    if (match) {
      const h = match[1].padStart(2, '0');
      const m = match[2];
      return h + ':' + m;
    }
  }
  
  if (typeof valor === 'object' && valor !== null) {
    if ('hour' in valor && 'minute' in valor) {
      const h = String(valor.hour).padStart(2, '0');
      const m = String(valor.minute).padStart(2, '0');
      return h + ':' + m;
    }
  }
  
  return null;
}

function colorCurso(curso) {
  const c = cursosData.find(x => x.Curso === curso);
  return c ? c.Color : '#667eea';
}
// MOD-005-S15: FIN

// MOD-005-S16: RENDERIZADO DE GRID [INICIO]
function renderGrid() {
  console.log('üìÖ Renderizando grid...');
  
  const container = document.querySelector('.hs-grid-container');
  if (!container) {
    console.error('üìÖ No se encontr√≥ hs-grid-container');
    return;
  }
  
  const loading = document.getElementById('loadingHS');
  if (loading) loading.remove();
  
  const c = document.getElementById('hsGridContainer');
  if (!c) return;
  
  const fechas = calcularFechasSemana(semanaActual);
  
  let html = '<table class="hs-grid"><thead><tr><th class="hs-col-hora">Hora</th>';
  
  fechas.dias.forEach((fecha, idx) => {
    const diaCorto = DIAS_CORTOS[idx];
    const fechaCorta = formatearFechaCorta(fecha);
    html += `<th class="hs-col-dia">${diaCorto}<br>${fechaCorta}</th>`;
  });
  
  html += '</tr></thead><tbody>';
  
  for (let h = HORA_INICIO; h <= HORA_FIN; h++) {
    const k = String(h).padStart(2, '0') + ':00';
    const horaFormato = formatearHora12(h);
    
    html += `<tr><td class="hs-col-hora">${horaFormato}</td>`;
    
    fechas.dias.forEach(fecha => {
      const key = formatearFechaISO(fecha);
      const items = horarioMatrix[key][k];
      
      if (items && items.length > 0) {
        const item = items[0];
        
        if (item.tipo === 'clase') {
          const color = colorCurso(item.clase.Curso);
          const texto = item.prefijo + item.clase.Curso + item.sufijo;
          
          html += `<td><div class="hs-celda ocupada clase-fija" style="background:${color}">
            ${texto}
          </div></td>`;
        } else {
          const act = item.actividad;
          const texto = item.prefijo + act.Actividad + item.sufijo;
          
          html += `<td><div class="hs-celda ocupada" 
            style="background:${act.Color}" 
            onclick="window.hsEditarActividad('${key}','${k}')">
            ${texto}
          </div></td>`;
        }
      } else {
        html += `<td><div class="hs-celda" 
          onclick="window.hsClickCelda('${key}','${k}')">
        </div></td>`;
      }
    });
    
    html += '</tr>';
  }
  
  html += '</tbody></table>';
  c.innerHTML = html;
  
  console.log('üìÖ Grid renderizado');
}

function ocultarLoading() {
  const l = document.getElementById('loadingHS');
  if (l) l.style.display = 'none';
}
// MOD-005-S16: FIN

// MOD-005-S17: FORMATEO [INICIO]
function formatearHora12(h) {
  if (h === 12) return '12 PM';
  if (h > 12) return (h - 12) + ' PM';
  if (h === 0) return '12 AM';
  return h + ' AM';
}

function formatearFechaISO(fecha) {
  if (!fecha || !(fecha instanceof Date) || isNaN(fecha.getTime())) {
    console.error('üìÖ formatearFechaISO: fecha inv√°lida', fecha);
    return '';
  }
  
  const year = fecha.getFullYear();
  const month = String(fecha.getMonth() + 1).padStart(2, '0');
  const day = String(fecha.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatearFechaCorta(fecha) {
  if (!fecha || !(fecha instanceof Date) || isNaN(fecha.getTime())) {
    console.error('üìÖ formatearFechaCorta: fecha inv√°lida', fecha);
    return '';
  }
  
  const dia = String(fecha.getDate()).padStart(2, '0');
  const mes = String(fecha.getMonth() + 1).padStart(2, '0');
  return `${dia}/${mes}`;
}

function parsearFechaDDMMAAAA(fechaStr) {
  if (!fechaStr) {
    return new Date('invalid');
  }

  if (fechaStr instanceof Date) {
    return fechaStr;
  }

  const str = String(fechaStr).trim();

  const match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (match) {
    const dia = parseInt(match[1], 10);
    const mes = parseInt(match[2], 10) - 1;
    const anio = parseInt(match[3], 10);
    return new Date(anio, mes, dia);
  }

  if (str.match(/^\d{4}-\d{1,2}-\d{1,2}/)) {
    return new Date(str);
  }

  return new Date(str);
}
// MOD-005-S17: FIN

// MOD-005-S18: NAVEGACI√ìN [INICIO]
function cambiarSemana(numSemana) {
  semanaActual = numSemana;
  actualizarInfoSemana();
  renderListaSemanas();
  construirMatriz();
  renderGrid();
}

function navegarSemana(direccion) {
  const nuevaSemana = semanaActual + direccion;
  
  if (nuevaSemana < 1) return;
  
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  const fechaInicio = new Date(configSemana.FechaInicio);
  fechaInicio.setHours(0, 0, 0, 0);
  
  const diffMs = hoy - fechaInicio;
  const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  const semanaMaxima = Math.floor(diffDias / 7) + 1;
  
  if (nuevaSemana > semanaMaxima) return;
  
  cambiarSemana(nuevaSemana);
}

function agregarNuevaSemana() {
  const nuevaSemana = semanaActual + 1;
  const fechas = calcularFechasSemana(nuevaSemana);
  
  const params = {
    codeAlum: currentUser.codeAlum,
    semana: nuevaSemana,
    fechaInicio: formatearFechaISO(fechas.lunes),
    fechaFin: formatearFechaISO(fechas.domingo)
  };
  
  console.log('üìÖ Creando semana:', params);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        mostrarNotificacion('success', `Semana ${nuevaSemana} creada`);
        cargarSemanas();
        cambiarSemana(nuevaSemana);
      } else {
        mostrarNotificacion('error', r.error || 'Error al crear semana');
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexi√≥n');
    })
    .studentCrearSemana(params);
}
// MOD-005-S18: FIN

// MOD-005-S19: CONFIG SEMANA [INICIO]
function abrirConfigSemana() {
  const modal = document.getElementById('modalConfigSemana');
  if (!modal) return;
  
  const inputInicio = document.getElementById('configFechaInicio');
  const inputFin = document.getElementById('configFechaFin');
  
  // Pre-rellenar si ya hay configuraci√≥n
  if (configSemana && configSemana.FechaInicio) {
    inputInicio.value = convertirDDMMAAAAaISO(configSemana.FechaInicio);
  }
  
  if (fechaFinClases) {
    inputFin.value = convertirDDMMAAAAaISO(fechaFinClases);
  }
  
  modal.classList.add('active');
}

function cerrarConfigSemana() {
  const modal = document.getElementById('modalConfigSemana');
  if (modal) modal.classList.remove('active');
}

function handleConfigSemana(event) {
  event.preventDefault();
  
  const fechaInicioInput = document.getElementById('configFechaInicio').value;
  const fechaFinInput = document.getElementById('configFechaFin').value;
  
  if (!fechaInicioInput || !fechaFinInput) {
    mostrarNotificacion('info', 'Debes ingresar ambas fechas');
    return false;
  }
  
  // Validar que fecha fin sea posterior a fecha inicio
  const inicio = new Date(fechaInicioInput);
  const fin = new Date(fechaFinInput);
  
  if (fin <= inicio) {
    mostrarNotificacion('error', 'La fecha de fin debe ser posterior a la fecha de inicio');
    return false;
  }
  
  console.log('üìÖ Guardando configuraci√≥n:', {
    fechaInicio: fechaInicioInput,
    fechaFin: fechaFinInput
  });
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        const numSemanas = r.semanas || 0;
        mostrarNotificacion('success', `‚úì Configuraci√≥n guardada. ${numSemanas} semanas generadas.`);
        cerrarConfigSemana();
        
        // Recargar p√°gina para reflejar cambios
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        mostrarNotificacion('error', 'Error al guardar: ' + (r ? r.error : 'Desconocido'));
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexi√≥n');
    })
    .studentGuardarConfigSemana({
      codeAlum: currentUser.codeAlum,
      fechaInicio: fechaInicioInput,
      fechaFin: fechaFinInput
    });
  
  return false;
}

function convertirDDMMAAAAaISO(fechaDDMMAAAA) {
  if (!fechaDDMMAAAA || !fechaDDMMAAAA.includes('/')) return '';
  
  const partes = fechaDDMMAAAA.split('/');
  if (partes.length !== 3) return '';
  
  const dia = partes[0].padStart(2, '0');
  const mes = partes[1].padStart(2, '0');
  const anio = partes[2];
  
  return `${anio}-${mes}-${dia}`;
}
// MOD-005-S19: FIN

// MOD-005-S20: FORMULARIO ACTIVIDAD [INICIO]
function clickCelda(fecha, hora) {
  console.log('üìÖ Click en celda:', { fecha, hora });
  abrirFormularioActividad(fecha, hora);
}

function abrirFormularioActividad(fecha, hora) {
  resetFormActividad();
  
  const fechaObj = new Date(fecha);
  const diaIndex = fechaObj.getDay() === 0 ? 6 : fechaObj.getDay() - 1;
  const diaCorto = DIAS_CORTOS[diaIndex];
  const fechaCorta = formatearFechaCorta(fechaObj);
  
  document.getElementById('actividadFormTitle').textContent = `Agregar Actividad - ${diaCorto} ${fechaCorta}`;
  document.getElementById('actividadModoEdicion').value = 'false';
  document.getElementById('actividadFecha').value = fecha;
  document.getElementById('actividadSem').value = semanaActual;
  document.getElementById('btnSubmitActividad').textContent = 'Guardar';
  document.getElementById('btnEliminarActividad').style.display = 'none';
  
  document.getElementById('actividadHoraIni').value = hora;
  
  const [h] = hora.split(':').map(Number);
  const horaFinSugerida = String(Math.min(h + 1, HORA_FIN + 1)).padStart(2, '0') + ':00';
  document.getElementById('actividadHoraFin').value = horaFinSugerida;
  
  document.getElementById('modalActividad').classList.add('active');
}

function editarActividad(fecha, hora) {
  const key = fecha;
  const items = horarioMatrix[key][hora];
  
  if (!items || items.length === 0) return;
  
  const item = items.find(i => i.tipo === 'actividad');
  if (!item) return;
  
  const act = item.actividad;
  
  const fechaObj = new Date(fecha);
  const diaIndex = fechaObj.getDay() === 0 ? 6 : fechaObj.getDay() - 1;
  const diaCorto = DIAS_CORTOS[diaIndex];
  const fechaCorta = formatearFechaCorta(fechaObj);
  
  document.getElementById('actividadFormTitle').textContent = `Editar Actividad - ${diaCorto} ${fechaCorta}`;
  document.getElementById('actividadRowNumber').value = act._rowNumber || '';
  document.getElementById('actividadModoEdicion').value = 'true';
  document.getElementById('actividadFecha').value = fecha;
  document.getElementById('actividadSem').value = act.Sem || semanaActual;
  document.getElementById('actividadTipo').value = act.TipoAct || '';
  document.getElementById('actividadNombre').value = act.Actividad || '';
  document.getElementById('actividadHoraIni').value = normalizarHora(act.HoraInicio) || '';
  document.getElementById('actividadHoraFin').value = normalizarHora(act.HoraFin) || '';
  document.getElementById('actividadColor').value = act.Color || '#17a2b8';
  
  document.getElementById('btnSubmitActividad').textContent = 'Actualizar';
  document.getElementById('btnEliminarActividad').style.display = 'block';
  
  document.getElementById('modalActividad').classList.add('active');
}

function resetFormActividad() {
  const form = document.getElementById('formActividad');
  if (form) form.reset();
  
  document.getElementById('actividadRowNumber').value = '';
  document.getElementById('actividadModoEdicion').value = '';
  document.getElementById('actividadFecha').value = '';
  document.getElementById('actividadSem').value = '';
}

function cerrarModalActividad() {
  const modal = document.getElementById('modalActividad');
  if (modal) modal.classList.remove('active');
  resetFormActividad();
}

function handleSubmitActividad(event) {
  event.preventDefault();
  
  const tipo = document.getElementById('actividadTipo').value.trim();
  const nombre = document.getElementById('actividadNombre').value.trim();
  const horaIni = document.getElementById('actividadHoraIni').value.trim();
  const horaFin = document.getElementById('actividadHoraFin').value.trim();
  const fechaISO = document.getElementById('actividadFecha').value;
  const sem = document.getElementById('actividadSem').value;
  const color = document.getElementById('actividadColor').value;
  const esEdicion = document.getElementById('actividadModoEdicion').value === 'true';
  const rowNumber = document.getElementById('actividadRowNumber').value;
  
  if (!tipo || !nombre || !horaIni || !horaFin) {
    mostrarNotificacion('info', 'Completa todos los campos');
    return false;
  }
  
  if (horaIni >= horaFin) {
    mostrarNotificacion('info', 'La hora de fin debe ser mayor a la de inicio');
    return false;
  }
  
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = true;
  btnSubmit.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';
  
  const params = {
    codeAlum: currentUser.codeAlum,
    actividad: nombre,
    horaInicio: horaIni,
    horaFin: horaFin,
    fechaHS: fechaISO,
    tipoAct: tipo,
    color: color,
    sem: sem
  };
  
  if (esEdicion) {
    if (rowNumber) {
      params.rowNumber = parseInt(rowNumber);
    }
    
    google.script.run
      .withSuccessHandler(r => handleActividadGuardada(r, true))
      .withFailureHandler(e => handleActividadError(e, true))
      .studentActualizarHorarioSem(params);
  } else {
    google.script.run
      .withSuccessHandler(r => handleActividadGuardada(r, false))
      .withFailureHandler(e => handleActividadError(e, false))
      .studentAgregarHorarioSem(params);
  }
  
  return false;
}

function handleActividadGuardada(response, esEdicion) {
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  if (response && response.success) {
    const msg = esEdicion ? '‚úì Actividad actualizada' : '‚úì Actividad agregada';
    mostrarNotificacion('success', msg);
    cerrarModalActividad();
    cargarHorarioSem();
  } else {
    const error = response ? response.error : 'Error desconocido';
    mostrarNotificacion('error', 'Error: ' + error);
  }
}

function handleActividadError(error, esEdicion) {
  console.error('üìÖ Error:', error);
  
  const btnSubmit = document.getElementById('btnSubmitActividad');
  btnSubmit.disabled = false;
  btnSubmit.textContent = esEdicion ? 'Actualizar' : 'Guardar';
  
  mostrarNotificacion('error', 'Error de conexi√≥n. Intenta nuevamente');
}

function confirmarEliminarActividad() {
  const rowNumber = document.getElementById('actividadRowNumber').value;

  if (!rowNumber) {
    mostrarNotificacion('info', 'No se puede eliminar esta actividad');
    return;
  }

  mostrarConfirmacion(
    '¬øEliminar esta actividad?\n\nEsta acci√≥n no se puede deshacer.',
    function() {
      eliminarActividad(parseInt(rowNumber));
    }
  );
}

function eliminarActividad(rowNumber) {
  google.script.run
    .withSuccessHandler(handleActividadEliminada)
    .withFailureHandler(e => {
      console.error('üìÖ Error al eliminar:', e);
      mostrarNotificacion('error', 'Error al eliminar');
    })
    .studentEliminarHorarioSem({ rowNumber: rowNumber });
}

function handleActividadEliminada(response) {
  if (response && response.success) {
    mostrarNotificacion('success', 'Actividad eliminada');
    cerrarModalActividad();
    cargarHorarioSem();
  } else {
    const error = response ? response.error : 'Error desconocido';
    mostrarNotificacion('error', 'Error: ' + error);
  }
}
// MOD-005-S20: FIN

// MOD-005-S21: MODAL CONFIRMACI√ìN [INICIO]
function mostrarConfirmacion(mensaje, onConfirm) {
  const modal = document.getElementById('modalConfirmacion');
  const mensajeEl = document.getElementById('confirmacionMensaje');
  const btnConfirmar = document.getElementById('btnConfirmarAccion');
  
  if (!modal || !mensajeEl || !btnConfirmar) {
    console.error('‚ùå No se encontr√≥ el modal de confirmaci√≥n');
    return;
  }

  mensajeEl.innerHTML = mensaje.replace(/\n/g, '<br>');
  
  btnConfirmar.onclick = function() {
    cerrarModalConfirmacion();
    if (typeof onConfirm === 'function') {
      onConfirm();
    }
  };
  
  modal.style.display = 'flex';
}

function cerrarModalConfirmacion() {
  const modal = document.getElementById('modalConfirmacion');
  if (modal) {
    modal.style.display = 'none';
  }
}
// MOD-005-S21: FIN

// MOD-005-S22: COPIAR Y LIMPIAR [INICIO]
function copiarSemanaAnterior() {
  if (semanaActual <= 1) {
    mostrarNotificacion('info', 'No hay semana anterior para copiar');
    return;
  }

  mostrarConfirmacion(
    `¬øCopiar todas las actividades de Semana ${semanaActual - 1} a Semana ${semanaActual}?\n\nLas actividades existentes en la semana actual no se modificar√°n.`,
    function() {
      ejecutarCopiaSemana();
    }
  );
}

function ejecutarCopiaSemana() {
  const fechasOrigen = calcularFechasSemana(semanaActual - 1);
  const fechasDestino = calcularFechasSemana(semanaActual);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        const cantidad = typeof r.data === 'number' ? r.data : parseInt(r.data) || 0;
        mostrarNotificacion('success', `‚úì ${cantidad} actividades copiadas`);
        cargarHorarioSem();
      } else {
        mostrarNotificacion('error', 'Error al copiar: ' + (r ? r.error : 'Desconocido'));
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexi√≥n');
    })
    .studentCopiarSemana({
      codeAlum: currentUser.codeAlum,
      fechaInicioOrigen: formatearFechaISO(fechasOrigen.lunes),
      fechaFinOrigen: formatearFechaISO(fechasOrigen.domingo),
      fechaInicioDestino: formatearFechaISO(fechasDestino.lunes)
    });
}

function limpiarSemana() {
  mostrarConfirmacion(
    `¬øEliminar TODAS las actividades de Semana ${semanaActual}?\n\nLas clases fijas NO se eliminar√°n.\n\nEsta acci√≥n no se puede deshacer.`,
    function() {
      ejecutarLimpiezaSemana();
    }
  );
}

function ejecutarLimpiezaSemana() {
  const fechas = calcularFechasSemana(semanaActual);
  
  google.script.run
    .withSuccessHandler(r => {
      if (r && r.success) {
        mostrarNotificacion('success', `${r.data} actividades eliminadas`);
        cargarHorarioSem();
      } else {
        mostrarNotificacion('error', 'Error: ' + (r ? r.error : 'Desconocido'));
      }
    })
    .withFailureHandler(e => {
      console.error('Error:', e);
      mostrarNotificacion('error', 'Error de conexi√≥n');
    })
    .studentLimpiarSemana({
      codeAlum: currentUser.codeAlum,
      fechaInicio: formatearFechaISO(fechas.lunes),
      fechaFin: formatearFechaISO(fechas.domingo)
    });
}
// MOD-005-S22: FIN

// MOD-005-S23: RENDERIZAR DEBERES [INICIO]
function renderizarDeberes() {
  const container = document.getElementById('hsDeberesContainer');
  if (!container) {
    console.warn('‚ö†Ô∏è Contenedor de deberes no encontrado');
    return;
  }
  
  console.log('üìù Renderizando deberes de la semana', semanaActual);
  
  // Obtener fechas de la semana actual
  const semana = todasSemanas.find(s => s.Semana === semanaActual);
  if (!semana) {
    container.innerHTML = '';
    return;
  }
  
  const fechaInicio = semana.FechaInicio;
  const fechaFin = semana.FechaFin;
  
  console.log('üìÖ Rango de fechas:', fechaInicio, '-', fechaFin);
  
  // Cargar deberes de la semana
  google.script.run
    .withSuccessHandler(deberes => {
      if (!deberes || deberes.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      // Filtrar deberes dentro del rango de fechas de esta semana
      const deberesSemana = filtrarDeberesPorFechas(deberes, fechaInicio, fechaFin);
      
      if (deberesSemana.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      // Construir HTML
      let html = '<div class="hs-deberes-container">';
      html += '<div class="hs-deberes-titulo">üìö Deberes de la Semana</div>';
      html += '<div class="hs-deberes-grid">';
      
      deberesSemana.forEach(deber => {
        const tipo = deber.tipo.toLowerCase();
        html += `
          <div class="hs-deber-card ${tipo}" onclick="window.hsAbrirDetalleDeber(${JSON.stringify(deber).replace(/"/g, '&quot;')})">
            <div class="hs-deber-curso">${deber.curso}</div>
            <div class="hs-deber-tipo">${deber.tipo}</div>
          </div>
        `;
      });
      
      html += '</div></div>';
      
      container.innerHTML = html;
      console.log('‚úÖ Deberes renderizados:', deberesSemana.length);
    })
    .withFailureHandler(e => {
      console.error('Error al cargar deberes:', e);
      container.innerHTML = '';
    })
    .studentObtenerTodosDeberes({ codeAlum: currentUser.codeAlum });
}

function filtrarDeberesPorFechas(deberes, fechaInicio, fechaFin) {
  const inicio = parsearFechaDDMMAAAA(fechaInicio);
  const fin = parsearFechaDDMMAAAA(fechaFin);
  
  return deberes.filter(deber => {
    if (!deber.fecha) return false;
    
    const fechaDeber = parsearFechaDDMMAAAA(deber.fecha);
    return fechaDeber >= inicio && fechaDeber <= fin;
  });
}

function parsearFechaDDMMAAAA(fechaStr) {
  if (!fechaStr || !fechaStr.includes('/')) return null;
  
  const partes = fechaStr.split('/');
  if (partes.length !== 3) return null;
  
  const dia = parseInt(partes[0]);
  const mes = parseInt(partes[1]) - 1;
  const anio = parseInt(partes[2]);
  
  return new Date(anio, mes, dia);
}

function abrirDetalleDeber(deber) {
  const modal = document.getElementById('modalDetalleDeber');
  const body = document.getElementById('modalDeberBody');
  
  if (!modal || !body) return;
  
  let html = '';
  
  html += `<div class="hs-deber-detalle-row">
    <div class="hs-deber-detalle-label">Curso</div>
    <div class="hs-deber-detalle-valor">${deber.curso}</div>
  </div>`;
  
  html += `<div class="hs-deber-detalle-row">
    <div class="hs-deber-detalle-label">Tipo</div>
    <div class="hs-deber-detalle-valor">${deber.tipo}</div>
  </div>`;
  
  if (deber.nombre) {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Nombre</div>
      <div class="hs-deber-detalle-valor">${deber.nombre}</div>
    </div>`;
  }
  
  if (deber.fecha) {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Fecha</div>
      <div class="hs-deber-detalle-valor">${deber.fecha}</div>
    </div>`;
  }
  
  if (deber.nota !== undefined && deber.nota !== null && deber.nota !== '') {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Nota</div>
      <div class="hs-deber-detalle-valor">${deber.nota}</div>
    </div>`;
  }
  
  if (deber.peso) {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Peso</div>
      <div class="hs-deber-detalle-valor">${deber.peso}%</div>
    </div>`;
  }
  
  if (deber.progreso !== undefined && deber.progreso !== null) {
    html += `<div class="hs-deber-detalle-row">
      <div class="hs-deber-detalle-label">Progreso</div>
      <div class="hs-deber-detalle-valor">${deber.progreso}%</div>
    </div>`;
  }
  
  body.innerHTML = html;
  modal.classList.add('active');
}

function cerrarModalDeber() {
  const modal = document.getElementById('modalDetalleDeber');
  if (modal) modal.classList.remove('active');
}
// MOD-005-S23: FIN

// MOD-005-S24: EXPOSICI√ìN GLOBAL Y ARRANQUE [INICIO]
window.hsInit = init;
window.hsCargarHorarioSem = cargarHorarioSem;
window.hsCambiarSemana = cambiarSemana;
window.hsNavegarSemana = navegarSemana;
window.hsAgregarNuevaSemana = agregarNuevaSemana;
window.hsAbrirConfigSemana = abrirConfigSemana;
window.hsCerrarConfigSemana = cerrarConfigSemana;
window.hsHandleConfigSemana = handleConfigSemana;
window.hsClickCelda = clickCelda;
window.hsEditarActividad = editarActividad;
window.hsCerrarModalActividad = cerrarModalActividad;
window.hsHandleSubmitActividad = handleSubmitActividad;
window.hsConfirmarEliminarActividad = confirmarEliminarActividad;
window.hsCopiarSemanaAnterior = copiarSemanaAnterior;
window.hsLimpiarSemana = limpiarSemana;
window.hsCerrarModalConfirmacion = cerrarModalConfirmacion;

setTimeout(function() {
  if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
    console.log('üìÖ currentUser detectado, inicializando...');
    init();
  } else {
    console.log('üìÖ currentUser no disponible, iniciando retry...');
    init();
  }
}, 500);

window.HorarioSemanalModule = {
  init: init,
  cambiarSemana: cambiarSemana,
  navegarSemana: navegarSemana,
  abrirConfigSemana: abrirConfigSemana,
  copiarSemanaAnterior: copiarSemanaAnterior,
  limpiarSemana: limpiarSemana
};

console.log('%cüìÖ HorarioSemanalModule V01.33 CODEWORKSHOP cargado',
  'font-size:11px;color:#667eea;font-weight:bold');
// MOD-005-S24: FIN

})();

</script>
<!-- MOD-005: FIN -->

<!-- MOD-006: NOTAS [INICIO] -->
<!--
DESCRIPCI√ìN:
Grid semanal 7√ó16 (7 AM-10 PM) para actividades din√°micas por semana.
Gesti√≥n con navegaci√≥n, copia y limpieza. Clases fijas + actividades coloreadas.

FUNCIONALIDAD:
- Configuraci√≥n fecha inicio ciclo ("1ra clase")
- Navegaci√≥n por semanas calculadas autom√°ticamente
- Clases fijas (grises, desde HorarioClase)
- Actividades din√°micas (coloreadas por tipo)
- Copiar/Limpiar semanas
- Modal confirmaci√≥n estilizado

DEPENDENCIAS BACKEND:
- studentObtenerConfigSemana()
- studentGuardarConfigSemana()
- studentObtenerSemanas()
- studentCrearSemana()
- studentObtenerCursos()
- studentObtenerHorarioClases()
- studentObtenerHorarioSem()
- studentAgregarHorarioSem()
- studentActualizarHorarioSem()
- studentEliminarHorarioSem()
- studentCopiarSemana()
- studentLimpiarSemana()

ESTRUCTURA:
MOD-001: Encabezado
MOD-002: Texto libre
MOD-003: Estilos CSS
MOD-004: Estructura HTML
MOD-005: JavaScript (23 subm√≥dulos S01-S23)
MOD-006: Notas

CAMBIOS V01.32 ‚Üí V01.33:
- Remodulaci√≥n seg√∫n est√°ndar CodeWorkShop v4.0
- MOD-005 con 23 subm√≥dulos JavaScript
- Delimitadores correctos (//) dentro de <script>
- Fix: Parseo DD/MM/AAAA desde backend
- Modal confirmaci√≥n estilizado (no confirm() nativo)
- Prefijo 'hs' en funciones globales

AISLAMIENTO:
- Prefijo CSS: .hs-*
- Prefijo JS: window.hs*
- Sin conflicto con HorarioClase (.hc-*)
-->
<!-- MOD-006: FIN -->
