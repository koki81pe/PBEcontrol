<!--
******************************************
PBE CONTROL - 6btabtodos.html - V01.20 CLAUDE
Sistema de Gesti√≥n Acad√©mica
07/01/2026

CAMBIOS V01.20 CLAUDE:
‚úÖ FIX CR√çTICO: Filtro ahora acepta '', 'todos', o null como "mostrar todo"
‚úÖ FIX: Mismo patr√≥n que Lecturas - resuelve "0 de 9 filtrados"
‚úÖ Aplica a filtroTipo, filtroCurso y filtroFecha

CAMBIOS V01.19 CLAUDE:
‚úÖ FIX CR√çTICO: Retry logic robusto (5 intentos, 200ms)
‚úÖ FIX CR√çTICO: Auto-init con setTimeout(150ms) en lugar de DOMContentLoaded
‚úÖ FIX CR√çTICO: Init tracking con _initDone para evitar reinicializaci√≥n
‚úÖ FIX: API p√∫blica expone inicializar() para llamada desde padre
‚úÖ MEJORA: Logs exhaustivos con prefijo üìã para debugging
‚úÖ Compatible con patr√≥n de Lecturas y Cursos

CAMBIOS V01.18:
- Encapsulado en IIFE
- API p√∫blica √∫nica: window.TodosModule
- CSS scopeado para evitar colisiones
- Fallbacks definidos solo si no existen globalmente

DESCRIPCI√ìN:
Sub-tab "Todos" (vista unificada) que consolida Evaluaciones, Tareas y Lecturas
en una sola tabla, ordenada por fecha, con filtros por tipo/curso/per√≠odo.

FUNCIONALIDAD:
- Cargar deberes unificados desde backend
- Filtros: Tipo, Curso, Per√≠odo (pr√≥ximos 7, pr√≥ximos 30, pasados)
- Ordenamiento por fecha (m√°s pr√≥xima primero)
- Badges de tipo (Evaluaci√≥n/Tarea/Lectura)
- Colores por proximidad de fecha (rojo/amarillo/verde)
- Colores din√°micos por nota (verde/amarillo/rojo)
- Progreso para lecturas (barra + %)
- Estados: loading, vac√≠o, error

BACKEND:
- studentObtenerTodosDeberes({ codeAlum })

DEPENDENCIAS:
- Requiere global: currentUser.codeAlum
- Opcional: showAlert(type, message) (fallback local)
- Opcional: parseFechaDD_MM_AAAA(fechaStr) (fallback local)

üîë IMPORTANTE:
- Validar currentUser antes de operar
- Mostrar errores de forma amigable
- Usar retry logic para timing de inicializaci√≥n
******************************************
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ==========================================
       6BTABTODOS.HTML - ESTILOS (SCOPEADO)
       Vista unificada de Evaluaciones + Tareas + Lecturas
       ========================================== */

    /* SCOPE: evitar colisiones globales */
    .todos-container, .todos-container * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .todos-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ==========================================
       HEADER
       ========================================== */

    .todos-container .todos-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      margin-bottom: 0;
    }

    .todos-container .todos-header h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .todos-container .todos-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    /* ==========================================
       FILTROS
       ========================================== */

    .todos-container .filtros-bar {
      background: white;
      padding: 16px 20px;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .todos-container .filtros-bar label {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .todos-container .filtros-bar select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      min-width: 150px;
    }

    .todos-container .filtros-bar select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .todos-container .btn-refresh {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
      margin-left: auto;
    }

    .todos-container .btn-refresh:hover {
      background: #5568d3;
    }

    .todos-container .btn-refresh:active {
      transform: scale(0.98);
    }

    /* ==========================================
       TABLA
       ========================================== */

    .todos-container .tabla-deberes-container {
      background: white;
      border-radius: 0 0 12px 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .todos-container .tabla-deberes {
      width: 100%;
      border-collapse: collapse;
    }

    .todos-container .tabla-deberes thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .todos-container .tabla-deberes th {
      padding: 14px 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .todos-container .tabla-deberes tbody tr {
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s;
    }

    .todos-container .tabla-deberes tbody tr:nth-child(even) {
      background: #f8f9fa;
    }

    .todos-container .tabla-deberes tbody tr:hover {
      background: #e9ecef;
    }

    .todos-container .tabla-deberes td {
      padding: 12px 16px;
      font-size: 14px;
      color: #333;
    }

    /* ==========================================
       BADGES DE TIPO
       ========================================== */

    .todos-container .badge-tipo {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .todos-container .badge-evaluacion {
      background: #fee;
      color: #dc3545;
    }

    .todos-container .badge-evaluaci√≥n {
      background: #fee;
      color: #dc3545;
    }

    .todos-container .badge-tarea {
      background: #fff3cd;
      color: #856404;
    }

    .todos-container .badge-lectura {
      background: #d1ecf1;
      color: #0c5460;
    }

    /* ==========================================
       CURSO TAG
       ========================================== */

    .todos-container .curso-tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      background: #e9ecef;
      color: #495057;
    }

    /* ==========================================
       FECHA
       ========================================== */

    .todos-container .fecha-cell {
      white-space: nowrap;
    }

    .todos-container .fecha-proxima {
      color: #dc3545;
      font-weight: 600;
    }

    .todos-container .fecha-pronto {
      color: #ffc107;
      font-weight: 600;
    }

    .todos-container .fecha-normal {
      color: #28a745;
    }

    /* ==========================================
       NOTA Y PESO
       ========================================== */

    .todos-container .nota-cell {
      text-align: center;
      font-weight: 600;
    }

    .todos-container .nota-alta { color: #28a745; }
    .todos-container .nota-media { color: #ffc107; }
    .todos-container .nota-baja { color: #dc3545; }

    .todos-container .peso-cell {
      text-align: center;
      color: #666;
    }

    /* ==========================================
       PROGRESO (SOLO LECTURAS)
       ========================================== */

    .todos-container .progreso-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .todos-container .barra-progreso {
      flex: 1;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .todos-container .barra-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .todos-container .progreso-text {
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
      min-width: 40px;
      text-align: right;
    }

    /* ==========================================
       LOADING Y ESTADO VAC√çO
       ========================================== */

    .todos-container .loading-container {
      text-align: center;
      padding: 60px 20px;
    }

    .todos-container .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .todos-container .loading-text {
      color: #666;
      font-size: 14px;
    }

    .todos-container .estado-vacio {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .todos-container .estado-vacio-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .todos-container .estado-vacio-text {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .todos-container .estado-vacio-subtext {
      font-size: 14px;
      color: #bbb;
    }

    /* ==========================================
       RESPONSIVE
       ========================================== */

    @media (max-width: 1024px) {
      .todos-container {
        padding: 12px;
      }

      .todos-container .filtros-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .todos-container .filtros-bar select,
      .todos-container .btn-refresh {
        width: 100%;
        margin-left: 0;
      }

      .todos-container .tabla-deberes {
        font-size: 13px;
      }

      .todos-container .tabla-deberes th,
      .todos-container .tabla-deberes td {
        padding: 10px 12px;
      }

      /* Ocultar columnas menos importantes en m√≥vil */
      .todos-container .tabla-deberes .col-peso {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .todos-container .todos-header h2 {
        font-size: 20px;
      }

      .todos-container .todos-header p {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

  <!-- ==========================================
       CONTENEDOR PRINCIPAL
       ========================================== -->

  <div class="todos-container">

    <!-- Header -->
    <div class="todos-header">
      <h2>üìã Todos los Deberes</h2>
      <p>Vista unificada de evaluaciones, tareas y lecturas ordenadas por fecha</p>
    </div>

    <!-- Filtros -->
    <div class="filtros-bar">
      <label for="filtroTipo">Tipo:</label>
      <select id="filtroTipo" onchange="TodosModule.aplicarFiltros()">
        <option value="todos">Todos los tipos</option>
        <option value="Evaluaci√≥n">Evaluaciones</option>
        <option value="Tarea">Tareas</option>
        <option value="Lectura">Lecturas</option>
      </select>

      <label for="filtroCurso">Curso:</label>
      <select id="filtroCurso" onchange="TodosModule.aplicarFiltros()">
        <option value="todos">Todos los cursos</option>
      </select>

      <label for="filtroFecha">Per√≠odo:</label>
      <select id="filtroFecha" onchange="TodosModule.aplicarFiltros()">
        <option value="todos">Todas las fechas</option>
        <option value="proximos7">Pr√≥ximos 7 d√≠as</option>
        <option value="proximos30">Pr√≥ximos 30 d√≠as</option>
        <option value="pasados">Pasados</option>
      </select>

      <button class="btn-refresh" onclick="TodosModule.cargarDeberes()">
        üîÑ Actualizar
      </button>
    </div>

    <!-- Tabla de Deberes -->
    <div class="tabla-deberes-container">

      <!-- Loading -->
      <div id="loadingDeberes" class="loading-container" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Cargando deberes...</div>
      </div>

      <!-- Estado vac√≠o -->
      <div id="estadoVacio" class="estado-vacio" style="display: none;">
        <div class="estado-vacio-icon">üìö</div>
        <div class="estado-vacio-text">No hay deberes registrados</div>
        <div class="estado-vacio-subtext">Agrega evaluaciones, tareas o lecturas desde sus pesta√±as correspondientes</div>
      </div>

      <!-- Tabla -->
      <table class="tabla-deberes" id="tablaDeberes" style="display: none;">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Curso</th>
            <th>Nombre</th>
            <th>Fecha</th>
            <th class="col-peso">Peso</th>
            <th>Nota</th>
            <th>Progreso/Detalle</th>
          </tr>
        </thead>
        <tbody id="deberesBody">
          <!-- Filas din√°micas -->
        </tbody>
      </table>

    </div>

  </div>

  <!-- ==========================================
       JAVASCRIPT (ENCAPSULADO)
       ========================================== -->

  <script>
    (function() {
      'use strict';

      // ==========================================
      // FALLBACKS (solo si no existen globalmente)
      // ==========================================

      if (typeof window.showAlert === 'undefined') {
        window.showAlert = function(type, message) {
          const alertBox = document.createElement('div');
          alertBox.className = 'alert alert-' + type;
          alertBox.textContent = message;
          alertBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s;
            ${type === 'success' ? 'background: #d4edda; color: #155724;' : ''}
            ${type === 'error' ? 'background: #f8d7da; color: #721c24;' : ''}
            ${type === 'warning' ? 'background: #fff3cd; color: #856404;' : ''}
            ${type === 'info' ? 'background: #d1ecf1; color: #0c5460;' : ''}
          `;

          document.body.appendChild(alertBox);

          setTimeout(function() {
            alertBox.remove();
          }, 3000);
        };

        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }

      // ==========================================
      // M√ìDULO: TodosModule
      // ==========================================

      const state = {
        todosLosDeberes: [],
        deberesFiltrados: [],
        _initDone: false,
        _retryCount: 0
      };

      const MAX_RETRIES = 5;

      // ==========================================
      // V01.19 CLAUDE: INIT CON RETRY LOGIC
      // ==========================================
      function inicializar() {
        console.log('üìã TodosModule.inicializar() llamado (intento ' + (state._retryCount + 1) + ')');

        if (state._initDone) {
          console.log('üìã TodosModule ya inicializado, ignorando');
          return;
        }

        // Validaci√≥n con retry
        if (typeof currentUser === 'undefined' || !currentUser) {
          console.warn('üìã currentUser no disponible a√∫n, reintentando...');
          
          if (state._retryCount < MAX_RETRIES) {
            state._retryCount++;
            setTimeout(inicializar, 200);
          } else {
            console.error('üìã currentUser no disponible despu√©s de ' + MAX_RETRIES + ' intentos');
            setEstadoError('Usuario no disponible', 'Recarga la p√°gina');
          }
          return;
        }

        if (!currentUser.codeAlum) {
          console.error('üìã currentUser.codeAlum vac√≠o:', currentUser);
          setEstadoError('C√≥digo de alumno no disponible', 'Recarga la p√°gina');
          return;
        }

        state._initDone = true;
        console.log('üìã TodosModule inicializado para:', currentUser.codeAlum);

        cargarDeberes();
      }

      function setEstadoError(titulo, subtitulo) {
        const loading = document.getElementById('loadingDeberes');
        const estadoVacio = document.getElementById('estadoVacio');
        const tabla = document.getElementById('tablaDeberes');

        if (loading) loading.style.display = 'none';
        if (tabla) tabla.style.display = 'none';

        if (estadoVacio) {
          estadoVacio.style.display = 'block';
          const t = estadoVacio.querySelector('.estado-vacio-text');
          const s = estadoVacio.querySelector('.estado-vacio-subtext');
          if (t) t.textContent = titulo || 'Error';
          if (s) s.textContent = subtitulo || 'Por favor, recarga la p√°gina';
          const icon = estadoVacio.querySelector('.estado-vacio-icon');
          if (icon) icon.textContent = '‚ö†Ô∏è';
        }
      }

      function parsearFecha(fechaStr) {
        // Usar funci√≥n del contenedor si existe
        if (typeof window.parseFechaDD_MM_AAAA === 'function') {
          return window.parseFechaDD_MM_AAAA(fechaStr);
        }

        // Fallback local
        if (!fechaStr) return null;
        const partes = String(fechaStr).split('/');
        if (partes.length !== 3) return null;

        const dia = parseInt(partes[0], 10);
        const mes = parseInt(partes[1], 10) - 1;
        const anio = parseInt(partes[2], 10);

        if (Number.isNaN(dia) || Number.isNaN(mes) || Number.isNaN(anio)) return null;
        return new Date(anio, mes, dia);
      }

      function obtenerClaseFecha(fechaStr) {
        if (!fechaStr) return '';

        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        const fecha = parsearFecha(fechaStr);
        if (!fecha || isNaN(fecha.getTime())) return '';

        const diffDias = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));

        if (diffDias < 0) return '';
        if (diffDias <= 3) return 'fecha-proxima';
        if (diffDias <= 7) return 'fecha-pronto';
        return 'fecha-normal';
      }

      function obtenerClaseNota(nota) {
        if (nota === null || nota === undefined || nota === '') return '';
        const notaNum = parseFloat(nota);
        if (Number.isNaN(notaNum)) return '';

        if (notaNum >= 14) return 'nota-alta';
        if (notaNum >= 11) return 'nota-media';
        return 'nota-baja';
      }

      function cargarCursosEnFiltro() {
        const selectCurso = document.getElementById('filtroCurso');
        if (!selectCurso) return;

        const primerOption = selectCurso.options[0] ? selectCurso.options[0].outerHTML : '<option value="todos">Todos los cursos</option>';

        const cursosUnicos = [...new Set(state.todosLosDeberes.map(d => d.curso).filter(Boolean))].sort();

        selectCurso.innerHTML = primerOption;

        cursosUnicos.forEach(curso => {
          const option = document.createElement('option');
          option.value = curso;
          option.textContent = curso;
          selectCurso.appendChild(option);
        });

        console.log('üìã Dropdown de cursos poblado con', cursosUnicos.length, 'cursos');
      }

      function renderizarTabla() {
        const tbody = document.getElementById('deberesBody');
        const tabla = document.getElementById('tablaDeberes');
        const estadoVacio = document.getElementById('estadoVacio');

        if (!tbody || !tabla || !estadoVacio) return;

        if (state.deberesFiltrados.length === 0) {
          tabla.style.display = 'none';
          estadoVacio.style.display = 'block';
          console.log('üìã No hay deberes para mostrar (filtrados: 0)');
          return;
        }

        estadoVacio.style.display = 'none';
        tabla.style.display = 'table';

        let html = '';

        state.deberesFiltrados.forEach(deber => {
          const claseFecha = obtenerClaseFecha(deber.fecha);
          const claseNota = obtenerClaseNota(deber.nota);

          html += '<tr>';

          // Tipo
          html += '<td>';
          const tipoLower = String(deber.tipo || '').toLowerCase().replace(/√≥/g, 'o').replace(/√≠/g, 'i');
          html += '<span class="badge-tipo badge-' + tipoLower + '">';
          html += (deber.tipo || '-');
          html += '</span>';
          html += '</td>';

          // Curso
          html += '<td><span class="curso-tag">' + (deber.curso || '-') + '</span></td>';

          // Nombre
          html += '<td>' + (deber.nombre || '-') + '</td>';

          // Fecha
          html += '<td class="fecha-cell ' + claseFecha + '">';
          html += (deber.fecha ? deber.fecha : '-');
          html += '</td>';

          // Peso
          html += '<td class="peso-cell col-peso">';
          html += (deber.peso ? deber.peso + '%' : '-');
          html += '</td>';

          // Nota
          html += '<td class="nota-cell ' + claseNota + '">';
          html += (deber.nota ? deber.nota : '-');
          html += '</td>';

          // Detalle
          html += '<td>';
          if (deber.tipo === 'Lectura' && deber.progreso) {
            const progresoStr = String(deber.progreso);
            const progresoNum = parseFloat(progresoStr);
            const width = Number.isNaN(progresoNum) ? 0 : Math.max(0, Math.min(100, progresoNum));

            html += '<div class="progreso-container">';
            html += '<div class="barra-progreso">';
            html += '<div class="barra-fill" style="width: ' + width + '%"></div>';
            html += '</div>';
            html += '<span class="progreso-text">' + (Number.isNaN(progresoNum) ? progresoStr : (width.toFixed(0) + '%')) + '</span>';
            html += '</div>';
          } else {
            html += '-';
          }
          html += '</td>';

          html += '</tr>';
        });

        tbody.innerHTML = html;
        console.log('üìã Tabla renderizada con', state.deberesFiltrados.length, 'deberes');
      }

      // ==========================================
      // V01.20 CLAUDE: FILTROS CON FIX CR√çTICO
      // ==========================================
      function aplicarFiltros() {
        const filtroTipoEl = document.getElementById('filtroTipo');
        const filtroCursoEl = document.getElementById('filtroCurso');
        const filtroFechaEl = document.getElementById('filtroFecha');

        const filtroTipo = filtroTipoEl ? filtroTipoEl.value : 'todos';
        const filtroCurso = filtroCursoEl ? filtroCursoEl.value : 'todos';
        const filtroFecha = filtroFechaEl ? filtroFechaEl.value : 'todos';

        console.log('üìã Aplicando filtros - Tipo:', filtroTipo, 'Curso:', filtroCurso, 'Fecha:', filtroFecha);

        state.deberesFiltrados = state.todosLosDeberes.filter(deber => {
          // ‚úÖ FIX V01.20: Acepta '', 'todos', o null como "mostrar todo"
          if (filtroTipo && filtroTipo !== 'todos' && deber.tipo !== filtroTipo) return false;
          if (filtroCurso && filtroCurso !== 'todos' && deber.curso !== filtroCurso) return false;

          if (filtroFecha && filtroFecha !== 'todos') {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            const fechaDeber = parsearFecha(deber.fecha);

            if (filtroFecha === 'proximos7') {
              const limite = new Date(hoy);
              limite.setDate(limite.getDate() + 7);
              if (!fechaDeber || fechaDeber < hoy || fechaDeber > limite) return false;
            } else if (filtroFecha === 'proximos30') {
              const limite = new Date(hoy);
              limite.setDate(limite.getDate() + 30);
              if (!fechaDeber || fechaDeber < hoy || fechaDeber > limite) return false;
            } else if (filtroFecha === 'pasados') {
              if (!fechaDeber || fechaDeber >= hoy) return false;
            }
          }

          return true;
        });

        console.log('üìã Filtrados:', state.deberesFiltrados.length, 'de', state.todosLosDeberes.length);
        renderizarTabla();
      }

      function cargarDeberes() {
        console.log('üìã Cargando deberes para:', currentUser.codeAlum);

        if (typeof currentUser === 'undefined' || !currentUser.codeAlum) {
          window.showAlert('error', 'No se pudo identificar al usuario');
          setEstadoError('Error al cargar usuario', 'Por favor, recarga la p√°gina');
          return;
        }

        const loading = document.getElementById('loadingDeberes');
        const estadoVacio = document.getElementById('estadoVacio');
        const tabla = document.getElementById('tablaDeberes');

        if (loading) loading.style.display = 'block';
        if (estadoVacio) estadoVacio.style.display = 'none';
        if (tabla) tabla.style.display = 'none';

        google.script.run
          .withSuccessHandler(function(response) {
            console.log('üìã Respuesta del backend:', response);
            if (loading) loading.style.display = 'none';

            if (!response) {
              console.error('üìã Response es NULL');
              setEstadoError('Error', 'El servidor retorn√≥ NULL');
              return;
            }

            if (response.success !== true) {
              console.error('üìã Response no exitoso:', response.error);
              window.showAlert('error', response.error || 'Error al cargar deberes');
              setEstadoError('Error', response.error || 'No se pudieron cargar los deberes');
              return;
            }

            if (!Array.isArray(response.data)) {
              console.error('üìã response.data no es array:', response.data);
              setEstadoError('Error', 'Formato de respuesta inv√°lido');
              return;
            }

            state.todosLosDeberes = response.data;
            console.log('üìã Deberes cargados:', state.todosLosDeberes.length);

            // Ordenamiento por fecha (m√°s pr√≥xima primero)
            state.todosLosDeberes.sort(function(a, b) {
              if (!a.fecha) return 1;
              if (!b.fecha) return -1;
              const fechaA = parsearFecha(a.fecha);
              const fechaB = parsearFecha(b.fecha);
              if (!fechaA) return 1;
              if (!fechaB) return -1;
              return fechaA - fechaB;
            });

            console.log('üìã Deberes ordenados por fecha');

            if (state.todosLosDeberes.length === 0) {
              if (estadoVacio) estadoVacio.style.display = 'block';
              console.log('üìã No hay deberes en el sistema');
            } else {
              cargarCursosEnFiltro();
              aplicarFiltros();
            }
          })
          .withFailureHandler(function(error) {
            if (loading) loading.style.display = 'none';
            window.showAlert('error', 'Error de conexi√≥n al cargar deberes');
            console.error('üìã Error de conexi√≥n:', error);
            setEstadoError('Error de conexi√≥n', 'No se pudo cargar la informaci√≥n. Reintenta.');
          })
          .studentObtenerTodosDeberes({ codeAlum: currentUser.codeAlum });
      }

      // Exponer API p√∫blica
      window.TodosModule = {
        inicializar: inicializar,
        cargarDeberes: cargarDeberes,
        aplicarFiltros: aplicarFiltros
      };

      // ==========================================
      // V01.19 CLAUDE: AUTO-INIT CON RETRY
      // ==========================================
      setTimeout(function() {
        if (typeof currentUser !== 'undefined' && currentUser && currentUser.codeAlum) {
          console.log('üìã currentUser detectado, auto-inicializando...');
          inicializar();
        } else {
          console.log('üìã currentUser no disponible, iniciando retry logic...');
          inicializar();
        }
      }, 150);

      console.log('%cüìã TodosModule V01.20 CLAUDE cargado',
        'font-size:11px;color:#667eea;font-weight:bold');

    })();
  </script>

</body>
</html>
