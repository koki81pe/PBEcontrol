<!--
******************************************
PBE CONTROL - 7ctabnotas.html - V01.17
Sistema de Gesti√≥n Acad√©mica
06/01/2026

DESCRIPCI√ìN:
Sub-tab de Notas con resumen por curso.
Muestra el promedio ponderado de cada curso combinando
evaluaciones, tareas y lecturas con sus respectivos pesos.

FUNCIONALIDAD:
- Cargar resumen de notas de todos los cursos (al iniciar)
- Mostrar promedio ponderado por curso (Eval + Tareas + Lecturas)
- Indicadores visuales seg√∫n rango de nota:
  * Verde (‚â•14): Aprobado con buena nota
  * Amarillo (11-13): Aprobado justo
  * Rojo (<11): Desaprobado
  * Gris: Sin notas a√∫n
- Contador de evaluaciones, tareas y lecturas por curso
- Expandir/colapsar detalles por curso (opcional)

C√ÅLCULO DEL PROMEDIO:
PromedioCurso = (Œ£ Nota √ó Peso) / Œ£ Peso

Combina:
- Evaluaciones con nota y peso
- Tareas con nota y peso
- Lecturas con nota y peso

CAMPOS MOSTRADOS POR CURSO:
- C√≥digo del curso (ej: MATE)
- Nombre completo (ej: Matem√°ticas)
- Color del curso (visual)
- Promedio ponderado (0-20, 2 decimales)
- Cantidad de evaluaciones
- Cantidad de tareas
- Cantidad de lecturas
- Estado visual (color seg√∫n promedio)

BACKEND:
- studentObtenerResumenNotas({ codeAlum })
  Retorna array de cursos con:
  {
    curso: 'MATE',
    completo: 'Matem√°ticas',
    color: '#FF5733',
    promedio: '15.67',
    evaluaciones: 3,
    tareas: 5,
    lecturas: 2
  }

COLORES SEG√öN PROMEDIO:
- >= 14: Verde (#28a745) - "Excelente"
- 11-13: Amarillo (#ffc107) - "Aprobado"
- < 11: Rojo (#dc3545) - "Desaprobado"
- 0 (sin notas): Gris (#999) - "Sin calificaciones"

VALIDACIONES:
- Si un curso no tiene ninguna nota con peso, promedio = 0
- Si totalPeso = 0, no se puede calcular promedio
- Muestra "Sin notas a√∫n" para cursos sin calificaciones

CONECTA CON:
- Parent: 4ctabplanning.html (contenedor)
- Backend: studentObtenerResumenNotas en 1code.gs
- M√≥dulo: Student.obtenerResumenNotas() en 1student.gs
- Funci√≥n auxiliar: Student.obtenerNotasPorCurso()

VARIABLE GLOBAL DISPONIBLE:
currentUser (heredada de 3panelstudent.html)
- currentUser.codeAlum
- currentUser.nombre
- currentUser.email

FUNCIONES GLOBALES DISPONIBLES:
- showAlert(type, message)
- calcularPromedioPonderado(items) - desde 4ctabplanning.html
- obtenerColorPromedio(promedio) - desde 4ctabplanning.html

üîë IMPORTANTE:
- Backend calcula el promedio (no frontend)
- Backend retorna promedio ya calculado como string
- Frontend solo visualiza y da formato
- Color del curso se usa para la barra lateral
- Sin notas = promedio 0, mostrar "Sin calificaciones"
******************************************
-->
<style>
  /* ==========================================
     CONTENEDOR PRINCIPAL
     ========================================== */
  .notas-container {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .notas-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .notas-header h2 {
    color: #333;
    font-size: 20px;
    margin: 0;
  }

  .notas-stats {
    display: flex;
    gap: 16px;
    font-size: 14px;
    color: #666;
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .stat-item strong {
    color: #333;
  }

  /* ==========================================
     GRID DE CURSOS CON NOTAS
     ========================================== */
  .notas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  /* ==========================================
     CARD DE CURSO
     ========================================== */
  .curso-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s;
    position: relative;
  }

  .curso-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  /* Barra lateral con color del curso */
  .curso-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 6px;
    background: var(--curso-color);
  }

  .curso-card-content {
    padding: 20px 20px 20px 26px;
  }

  /* Header del curso */
  .curso-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .curso-info h3 {
    font-size: 16px;
    font-weight: 700;
    color: #333;
    margin: 0 0 4px 0;
  }

  .curso-codigo {
    display: inline-block;
    font-size: 13px;
    font-weight: 600;
    color: #667eea;
    background: rgba(102, 126, 234, 0.1);
    padding: 3px 10px;
    border-radius: 6px;
  }

  /* Promedio destacado */
  .promedio-badge {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
    text-align: right;
  }

  .promedio-badge.aprobado-excelente {
    color: #28a745;
  }

  .promedio-badge.aprobado-justo {
    color: #ffc107;
  }

  .promedio-badge.desaprobado {
    color: #dc3545;
  }

  .promedio-badge.sin-notas {
    color: #999;
    font-size: 16px;
    font-weight: 600;
  }

  .promedio-label {
    font-size: 11px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
  }

  /* Estado descriptivo */
  .curso-estado {
    display: inline-block;
    font-size: 12px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 6px;
    margin-top: 12px;
  }

  .estado-excelente {
    background: #d4edda;
    color: #155724;
  }

  .estado-aprobado {
    background: #fff3cd;
    color: #856404;
  }

  .estado-desaprobado {
    background: #f8d7da;
    color: #721c24;
  }

  .estado-sin-notas {
    background: #e9ecef;
    color: #6c757d;
  }

  /* Detalle de componentes */
  .curso-detalle {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e0e0e0;
  }

  .detalle-item {
    flex: 1;
    text-align: center;
  }

  .detalle-item-valor {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
    line-height: 1;
  }

  .detalle-item-label {
    font-size: 11px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
  }

  /* ==========================================
     ESTADO VAC√çO
     ========================================== */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  .empty-state-text {
    font-size: 15px;
  }

  /* ==========================================
     LOADING
     ========================================== */
  .loading-container {
    text-align: center;
    padding: 40px;
    color: #667eea;
  }

  .spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(102, 126, 234, 0.2);
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ==========================================
     LEYENDA DE COLORES
     ========================================== */
  .notas-leyenda {
    display: flex;
    gap: 20px;
    justify-content: center;
    padding: 16px;
    background: #f9f9f9;
    border-radius: 8px;
    margin-top: 24px;
    flex-wrap: wrap;
  }

  .leyenda-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #666;
  }

  .leyenda-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
  }

  .leyenda-color.verde {
    background: #28a745;
  }

  .leyenda-color.amarillo {
    background: #ffc107;
  }

  .leyenda-color.rojo {
    background: #dc3545;
  }

  .leyenda-color.gris {
    background: #999;
  }

  /* ==========================================
     RESPONSIVE
     ========================================== */
  @media (max-width: 768px) {
    .notas-container {
      padding: 16px;
    }

    .notas-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .notas-stats {
      width: 100%;
      flex-direction: column;
      gap: 8px;
    }

    .notas-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .curso-card-content {
      padding: 16px 16px 16px 22px;
    }

    .curso-detalle {
      gap: 12px;
    }

    .detalle-item-valor {
      font-size: 18px;
    }

    .notas-leyenda {
      flex-direction: column;
      gap: 12px;
    }
  }
</style>

<!-- ========================================== -->
<!-- CONTENEDOR DE NOTAS -->
<!-- ========================================== -->
<div class="notas-container">
  
  <!-- Header con t√≠tulo y estad√≠sticas generales -->
  <div class="notas-header">
    <h2>üìä Resumen de Notas</h2>
    <div class="notas-stats" id="notasStats">
      <div class="stat-item">
        üìö <strong id="statTotalCursos">0</strong> cursos
      </div>
      <div class="stat-item">
        üìù <strong id="statTotalNotas">0</strong> notas registradas
      </div>
      <div class="stat-item">
        üìà Promedio general: <strong id="statPromedioGeneral">--</strong>
      </div>
    </div>
  </div>

  <!-- Grid de cards de cursos -->
  <div id="notasGridContainer" class="notas-grid">
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando notas...</p>
    </div>
  </div>

  <!-- Leyenda de colores -->
  <div class="notas-leyenda">
    <div class="leyenda-item">
      <div class="leyenda-color verde"></div>
      <span>‚â• 14 - Excelente</span>
    </div>
    <div class="leyenda-item">
      <div class="leyenda-color amarillo"></div>
      <span>11-13 - Aprobado</span>
    </div>
    <div class="leyenda-item">
      <div class="leyenda-color rojo"></div>
      <span>< 11 - Desaprobado</span>
    </div>
    <div class="leyenda-item">
      <div class="leyenda-color gris"></div>
      <span>Sin calificaciones</span>
    </div>
  </div>

</div>

<!-- ========================================== -->
<!-- JAVASCRIPT -->
<!-- ========================================== -->
<script>
  /**
   * ==========================================
   * VARIABLES LOCALES
   * ==========================================
   */
  let resumenNotasData = [];

  /**
   * ==========================================
   * INICIALIZACI√ìN
   * ==========================================
   */
  window.addEventListener('load', function() {
    // Verificar que currentUser est√© disponible
    if (typeof currentUser === 'undefined' || !currentUser.codeAlum) {
      showAlert('error', 'Error: No se pudo identificar al usuario');
      return;
    }

    cargarResumenNotas();
  });

  /**
   * ==========================================
   * CARGAR RESUMEN DE NOTAS
   * ==========================================
   */
  function cargarResumenNotas() {
    google.script.run
      .withSuccessHandler(handleResumenNotasLoaded)
      .withFailureHandler(handleResumenNotasError)
      .studentObtenerResumenNotas({ codeAlum: currentUser.codeAlum });
  }

  function handleResumenNotasLoaded(response) {
    if (response.success) {
      resumenNotasData = response.data;
      renderNotasGrid();
      actualizarEstadisticas();
    } else {
      showAlert('error', 'Error al cargar resumen de notas: ' + response.error);
      renderEmptyState();
    }
  }

  function handleResumenNotasError(error) {
    console.error('Error al cargar resumen de notas:', error);
    showAlert('error', 'Error de conexi√≥n al cargar notas');
    renderEmptyState();
  }

  /**
   * ==========================================
   * RENDERIZAR GRID DE CURSOS
   * ==========================================
   */
  function renderNotasGrid() {
    const container = document.getElementById('notasGridContainer');

    if (resumenNotasData.length === 0) {
      renderEmptyState();
      return;
    }

    let html = '';

    resumenNotasData.forEach(function(curso) {
      const promedio = parseFloat(curso.promedio) || 0;
      const clasePromedio = obtenerClasePromedio(promedio);
      const estadoTexto = obtenerEstadoTexto(promedio);
      const claseEstado = obtenerClaseEstado(promedio);

      html += `
        <div class="curso-card" style="--curso-color: ${curso.color || '#667eea'}">
          <div class="curso-card-content">
            
            <!-- Header del curso -->
            <div class="curso-card-header">
              <div class="curso-info">
                <h3>${curso.completo}</h3>
                <span class="curso-codigo">${curso.curso}</span>
              </div>
              <div style="text-align: right;">
                <div class="promedio-badge ${clasePromedio}">
                  ${promedio > 0 ? promedio : 'S/N'}
                </div>
                <div class="promedio-label">Promedio</div>
              </div>
            </div>

            <!-- Estado descriptivo -->
            <div class="curso-estado ${claseEstado}">
              ${estadoTexto}
            </div>

            <!-- Detalle de componentes -->
            <div class="curso-detalle">
              <div class="detalle-item">
                <div class="detalle-item-valor">${curso.evaluaciones || 0}</div>
                <div class="detalle-item-label">Evaluaciones</div>
              </div>
              <div class="detalle-item">
                <div class="detalle-item-valor">${curso.tareas || 0}</div>
                <div class="detalle-item-label">Tareas</div>
              </div>
              <div class="detalle-item">
                <div class="detalle-item-valor">${curso.lecturas || 0}</div>
                <div class="detalle-item-label">Lecturas</div>
              </div>
            </div>

          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function renderEmptyState() {
    const container = document.getElementById('notasGridContainer');
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <div class="empty-state-text">
          No tienes cursos registrados a√∫n.<br>
          Agrega cursos desde la secci√≥n "Cursos y Repasos".
        </div>
      </div>
    `;
  }

  /**
   * ==========================================
   * ACTUALIZAR ESTAD√çSTICAS GENERALES
   * ==========================================
   */
  function actualizarEstadisticas() {
    const totalCursos = resumenNotasData.length;
    let totalNotas = 0;
    let sumaPromedios = 0;
    let cursosConNotas = 0;

    resumenNotasData.forEach(function(curso) {
      const promedio = parseFloat(curso.promedio) || 0;
      const componentes = (curso.evaluaciones || 0) + (curso.tareas || 0) + (curso.lecturas || 0);
      
      totalNotas += componentes;
      
      if (promedio > 0) {
        sumaPromedios += promedio;
        cursosConNotas++;
      }
    });

    const promedioGeneral = cursosConNotas > 0 ? 
      (sumaPromedios / cursosConNotas).toFixed(2) : '--';

    document.getElementById('statTotalCursos').textContent = totalCursos;
    document.getElementById('statTotalNotas').textContent = totalNotas;
    document.getElementById('statPromedioGeneral').textContent = promedioGeneral;
  }

  /**
   * ==========================================
   * FUNCIONES AUXILIARES
   * ==========================================
   */

  /**
   * Obtener clase CSS seg√∫n promedio
   */
  function obtenerClasePromedio(promedio) {
    if (promedio === 0) return 'sin-notas';
    if (promedio >= 14) return 'aprobado-excelente';
    if (promedio >= 11) return 'aprobado-justo';
    return 'desaprobado';
  }

  /**
   * Obtener texto descriptivo seg√∫n promedio
   */
  function obtenerEstadoTexto(promedio) {
    if (promedio === 0) return 'üìã Sin calificaciones';
    if (promedio >= 14) return 'üéâ Excelente desempe√±o';
    if (promedio >= 11) return '‚úÖ Aprobado';
    return '‚ö†Ô∏è Necesita mejorar';
  }

  /**
   * Obtener clase de estado seg√∫n promedio
   */
  function obtenerClaseEstado(promedio) {
    if (promedio === 0) return 'estado-sin-notas';
    if (promedio >= 14) return 'estado-excelente';
    if (promedio >= 11) return 'estado-aprobado';
    return 'estado-desaprobado';
  }

  /**
   * ==========================================
   * LOG
   * ==========================================
   */
  console.log('%cüìä Sub-tab Notas Cargado', 
              'font-size: 11px; color: #667eea;');
  console.log('Mostrando resumen de notas por curso');
  console.log('Colores: Verde (‚â•14), Amarillo (11-13), Rojo (<11)');
</script>
