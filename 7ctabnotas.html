<!--
******************************************
PBE CONTROL - 7ctabnotas.html - V01.18 GPT
Sistema de Gesti√≥n Acad√©mica
07/01/2026

OBJETIVO V01.18:
- Mantener 100% la funcionalidad de V01.17
- Eliminar variables y funciones globales
- Encapsular l√≥gica para evitar colisiones
- Inicializaci√≥n segura en entorno SPA
******************************************
-->

<style>
/* ==== ESTILOS (id√©nticos a V01.17) ==== */
.notas-container{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.notas-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.notas-header h2{margin:0;font-size:20px;color:#333}
.notas-stats{display:flex;gap:16px;font-size:14px;color:#666}
.stat-item strong{color:#333}
.notas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.curso-card{background:#fff;border:2px solid #e0e0e0;border-radius:12px;overflow:hidden;position:relative;transition:.3s}
.curso-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
.curso-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:6px;background:var(--curso-color)}
.curso-card-content{padding:20px 20px 20px 26px}
.curso-card-header{display:flex;justify-content:space-between;margin-bottom:16px}
.curso-info h3{margin:0;font-size:16px;font-weight:700}
.curso-codigo{font-size:13px;font-weight:600;color:#667eea;background:rgba(102,126,234,.1);padding:3px 10px;border-radius:6px}
.promedio-badge{font-size:28px;font-weight:700}
.promedio-badge.aprobado-excelente{color:#28a745}
.promedio-badge.aprobado-justo{color:#ffc107}
.promedio-badge.desaprobado{color:#dc3545}
.promedio-badge.sin-notas{color:#999;font-size:16px}
.promedio-label{font-size:11px;color:#999;text-transform:uppercase}
.curso-estado{margin-top:12px;font-size:12px;font-weight:600;padding:4px 10px;border-radius:6px}
.estado-excelente{background:#d4edda;color:#155724}
.estado-aprobado{background:#fff3cd;color:#856404}
.estado-desaprobado{background:#f8d7da;color:#721c24}
.estado-sin-notas{background:#e9ecef;color:#6c757d}
.curso-detalle{display:flex;gap:16px;margin-top:16px;padding-top:16px;border-top:1px solid #e0e0e0}
.detalle-item{text-align:center;flex:1}
.detalle-item-valor{font-size:20px;font-weight:700;color:#667eea}
.detalle-item-label{font-size:11px;color:#999}
.loading-container{text-align:center;padding:40px;color:#667eea}
.spinner{width:40px;height:40px;border:4px solid rgba(102,126,234,.2);border-top-color:#667eea;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:60px 20px;color:#999}
</style>

<div class="notas-container">
  <div class="notas-header">
    <h2>üìä Resumen de Notas</h2>
    <div class="notas-stats">
      <div class="stat-item">üìö <strong id="statCursos">0</strong> cursos</div>
      <div class="stat-item">üìù <strong id="statNotas">0</strong> notas</div>
      <div class="stat-item">üìà Promedio general: <strong id="statProm">--</strong></div>
    </div>
  </div>

  <div id="notasGrid" class="notas-grid">
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando notas...</p>
    </div>
  </div>
</div>

<script>
(function () {
  'use strict';

  /* Evita redeclaraci√≥n al cambiar de tab */
  if (window.NotasModule) return;

  const NotasModule = {
    data: []
  };

  /* ===============================
     INICIALIZACI√ìN
     =============================== */
  NotasModule.init = function () {
    if (!window.currentUser?.codeAlum) {
      showAlert('error', 'No se pudo identificar al usuario');
      return;
    }
    this.cargar();
  };

  /* ===============================
     CARGA DE DATOS
     =============================== */
  NotasModule.cargar = function () {
    google.script.run
      .withSuccessHandler(r => {
        if (r.success) {
          this.data = r.data || [];
          this.render();
          this.stats();
        } else {
          this.empty();
        }
      })
      .withFailureHandler(() => this.empty())
      .studentObtenerResumenNotas({ codeAlum: currentUser.codeAlum });
  };

  /* ===============================
     RENDER
     =============================== */
  NotasModule.render = function () {
    const cont = document.getElementById('notasGrid');
    if (!this.data.length) return this.empty();

    cont.innerHTML = this.data.map(c => {
      const p = parseFloat(c.promedio) || 0;
      return `
        <div class="curso-card" style="--curso-color:${c.color || '#667eea'}">
          <div class="curso-card-content">
            <div class="curso-card-header">
              <div class="curso-info">
                <h3>${c.completo}</h3>
                <span class="curso-codigo">${c.curso}</span>
              </div>
              <div>
                <div class="promedio-badge ${this.cls(p)}">${p || 'S/N'}</div>
                <div class="promedio-label">Promedio</div>
              </div>
            </div>

            <div class="curso-estado ${this.estadoCls(p)}">${this.estadoTxt(p)}</div>

            <div class="curso-detalle">
              <div class="detalle-item">
                <div class="detalle-item-valor">${c.evaluaciones || 0}</div>
                <div class="detalle-item-label">Evaluaciones</div>
              </div>
              <div class="detalle-item">
                <div class="detalle-item-valor">${c.tareas || 0}</div>
                <div class="detalle-item-label">Tareas</div>
              </div>
              <div class="detalle-item">
                <div class="detalle-item-valor">${c.lecturas || 0}</div>
                <div class="detalle-item-label">Lecturas</div>
              </div>
            </div>
          </div>
        </div>`;
    }).join('');
  };

  /* ===============================
     ESTAD√çSTICAS
     =============================== */
  NotasModule.stats = function () {
    let notas = 0, sum = 0, con = 0;

    this.data.forEach(c => {
      const p = parseFloat(c.promedio) || 0;
      notas += (c.evaluaciones || 0) + (c.tareas || 0) + (c.lecturas || 0);
      if (p > 0) { sum += p; con++; }
    });

    document.getElementById('statCursos').textContent = this.data.length;
    document.getElementById('statNotas').textContent = notas;
    document.getElementById('statProm').textContent = con ? (sum / con).toFixed(2) : '--';
  };

  /* ===============================
     ESTADO VAC√çO
     =============================== */
  NotasModule.empty = function () {
    document.getElementById('notasGrid').innerHTML = `
      <div class="empty-state">
        <div style="font-size:48px">üìä</div>
        Sin calificaciones a√∫n
      </div>`;
  };

  /* ===============================
     HELPERS
     =============================== */
  NotasModule.cls = p =>
    p === 0 ? 'sin-notas' :
    p >= 14 ? 'aprobado-excelente' :
    p >= 11 ? 'aprobado-justo' :
    'desaprobado';

  NotasModule.estadoCls = p =>
    p === 0 ? 'estado-sin-notas' :
    p >= 14 ? 'estado-excelente' :
    p >= 11 ? 'estado-aprobado' :
    'estado-desaprobado';

  NotasModule.estadoTxt = p =>
    p === 0 ? 'üìã Sin calificaciones' :
    p >= 14 ? 'üéâ Excelente' :
    p >= 11 ? '‚úÖ Aprobado' :
    '‚ö†Ô∏è Necesita mejorar';

  /* ===============================
     EXPORT + INIT SEGURO (SPA)
     =============================== */
  window.NotasModule = NotasModule;
  NotasModule.init();   // ‚úÖ SOLUCI√ìN CORRECTA

})();
</script>
